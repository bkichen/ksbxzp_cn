"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(){function authLoginBeforeController($scope,CommonRequest,$rootScope,CONFIG,$timeout,$state,$window,TipService){var url1=window.location.href,prams=url1.split("?")[1];prams=prams.split("&")[0],prams=prams.split("=")[1];var url;url="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2FauthorizationLogin%2F"+prams+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect",window.location.href=url}angular.module("app").controller("authLoginBeforeController",authLoginBeforeController),authLoginBeforeController.$inject=["$scope","CommonRequest","$rootScope","CONFIG","$timeout","$state","$window","TipService"]}(),function(){function authorizationLoginController($scope,CommonRequest,$rootScope,CONFIG,$timeout,$state,$window,TipService,$ionicLoading,$ionicPopup,$http,TIPS){function errorCatch(error){console.info("失败了");var httpStatus=error.status,httpData=error.data;console.info(httpData.error.code);var msg,allMsg={TIPS:TIPS.getTips()};if(0===httpStatus)msg=allMsg.TIPS.SYSTEM.NETWORK_ERROR;else if(httpData){if(httpData.error){if(msg=httpData.error.message||"",httpData.error.code&&-1!=msg.indexOf("服务异常，小的正在拼命拯救中，请客官稍后再试试~")&&(msg="系统繁忙，请您稍后重试，谢谢"),console.info("sdsfdfds"),"00"===httpData.error.code)return void(vm.showSatus=2);if(httpData.error.code&&-1==httpData.error.code.indexOf("44014"))return void(msg&&vm.showMessage(msg));if(""==httpData.error.code)return void(msg&&vm.showMessage(msg))}}else msg=allMsg.TIPS.SYSTEM.REQUEST_ERROR;vm.showMessage(msg)}var vm=this,qrcode=$state.params.qrcode;qrcode||console.info("随机数没有拿到"),vm.isGo=!0,vm.getIdTime=1,vm.getId=function(){if(1===vm.getIdTime&&vm.showLoading(),vm.getIdTime>10)return vm.hideLoading(),void vm.showMessage("暂未获取到微信号，请重新扫描");if($rootScope.openid)vm.getIdTime=1,vm.id=$rootScope.openid,vm.isHasAdmin();else var timer=$timeout(function(){vm.getId(),vm.getIdTime++,$timeout.cancel(timer)},500)},window.addEventListener("popstate",function(){wx?wx.closeWindow():history.go(-2)},!1),vm.showSatus=1,vm.showLoading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.hideLoading=function(){$ionicLoading.hide()},vm.updateQrcodeStatus=function(code,status){var flag=!1;1===status&&(flag=!0);var config={url:CONFIG.SERVICE_ADDRESS+"updateQrCodeStatus",method:"POST"},params={qrCode:code};flag&&1===status&&vm.showLoading(),CommonRequest.request(params,config,function(res){1==res.status?1===status?vm.getId():2===status||3===status&&(vm.showSatus=3,sessionStorage.setItem("authLogin",vm.showSatus)):vm.hideLoading()},flag)},vm.submit=function(){var authLogin=sessionStorage.getItem("authLogin");authLogin||(vm.id?vm.updateQrcodeStatus(qrcode,3):vm.showMessage("暂未获取到微信号，请重新扫描"))},vm.showMessage=function(msg,flag){var ionicMsg=$ionicPopup.alert({cssClass:"popup-icon",template:msg,okText:"我知道了"});ionicMsg.then(function(){flag||vm.back()})},vm.isHasAdmin=function(){var params={qrCode:qrcode,openId:vm.id},config={url:CONFIG.SERVICE_ADDRESS+"isExistCusInfo",method:"POST",data:params,headers:{"x-channelCode":CONFIG.NEW_SALE_CHANNEL,"x-timestamp":(new Date).getTime()}};$http(config).then(function(result){console.info("进入了"),console.info(result),1==result.data.status?vm.isGo=!1:errorCatch(result),vm.hideLoading()})["catch"](function(res){throw errorCatch(res),vm.hideLoading(),error})},vm.loadingPage=function(){$timeout(function(){$rootScope.loadingPage?vm.updateQrcodeStatus(qrcode,1):vm.loadingPage()},100)},vm.loadingPage(),vm.back=function(){wx?wx.closeWindow():history.go(-2)},vm.jump=function(){var url;url="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Ftab%2Fmall&response_type=code&scope=snsapi_base&state=test#wechat_redirect",window.location.href=url}}angular.module("app").controller("authorizationLoginController",authorizationLoginController),authorizationLoginController.$inject=["$scope","CommonRequest","$rootScope","CONFIG","$timeout","$state","$window","TipService","$ionicLoading","$ionicPopup","$http","TIPS"]}(),function(){function CstmizeProductDetailController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,$timeout,$filter,PolicyService){var vm=this;vm.id=$state.params.id||JSON.stringify($location.search().id);var signData;vm.shareBg=!1,vm.iWidth=window.screen.width,vm.iHeight=window.screen.height,vm.createIframe=function(){var params={id:vm.id};CommonRequest.request(params,CONFIG.GET_CUSTOMIZE_PROD_DETAIL,function(result){if(1==result.status){var prod=result.data;if("1"==prod.pageType){if(vm.textDiv=!0,vm.name=prod.name,vm.imgFileName="/"+prod.imgFileName,vm.operFlag=prod.operFlag,prod.prodCont)var time1=$timeout(function(){document.getElementById("textDiv").innerHTML=prod.prodCont,$timeout.cancel(time1)},100)}else if("2"==prod.pageType){vm.urlDiv=!0,vm.name=prod.name,vm.imgFileName="/"+prod.imgFileName,vm.outUrl=prod.outUrl,vm.operFlag=prod.operFlag;var ifm=document.createElement("iframe");ifm.src=vm.outUrl,ifm.setAttribute("height",vm.iHeight),ifm.setAttribute("width",vm.iWidth);var time2=$timeout(function(){var d1=document.getElementById("outurl");void 0==d1&&""==d1||(d1.appendChild(ifm),$timeout.cancel(time2))},100)}}})},vm.createIframe(),vm.share=function(){vm.shareBg=!0;var pageURL=window.location.href.split("#")[0],webAppPath=window.location.protocol+"//"+window.location.host+"/"+document.location.pathname.split("/")[1],pageInfo={currentUrl:pageURL};vm.shareDesc="产品详情",CommonRequest.request(pageInfo,CONFIG.SIGNATURE,function(result){result&&1==result.status&&(signData=result.data,console.info(signData),wx.config({debug:!1,appId:signData.appId,timestamp:signData.timeStamp,nonceStr:signData.nonceStr,signature:signData.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){wx.onMenuShareTimeline({title:vm.name,desc:vm.shareDesc,link:CONFIG.DOMAIN+"/elife-wechat/#/product/detail-img/"+vm.id+"/",imgUrl:webAppPath+vm.imgFileName,type:"link",dataUrl:"",success:function(){vm.shareBg=!1},cancel:function(){}}),wx.onMenuShareAppMessage({title:vm.name,desc:vm.shareDesc,link:CONFIG.DOMAIN+"/elife-wechat/#/product/detail-img/"+vm.id+"/",imgUrl:webAppPath+vm.imgFileName,type:"link",dataUrl:"",success:function(){vm.shareBg=!1},cancel:function(){}})}),wx.error(function(){alert("wx-error")}))})},vm.clickShareBg=function(){vm.shareBg=!1},vm.order=function(){$state.go("product-detail",{id:vm.id})},vm.preOrder=function(){$state.go("pre-experts")}}angular.module("app").controller("CstmizeProductDetailController",CstmizeProductDetailController),CstmizeProductDetailController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$timeout","$filter","PolicyService"]}(),function(){function cstmMainController($state,$rootScope,CommonRequest,CONFIG,$filter,$timeout,PolicyService){var vm=this;vm.getProdTypeList=function(tag){vm.prodTypeList=[];var params={};CommonRequest.request(params,CONFIG.CUSTOMIZE_PRODUCT_TYPE,function(result){if(1==result.status)for(var list=result.data,i=0;i<list.length;i++)list[i].focus=!1,vm.prodTypeList.push(list[i])})},vm.queryCustomizeProdList=function(){vm.prodTtlList=[];var params={issuePlat:"2"};CommonRequest.request(params,CONFIG.QUERY_CUSTOMIZE_PROD_LIST,function(result){if(1==result.status)for(var list=result.data,i=0;i<vm.prodTypeList.length;i++){for(var tmpList=[],j=0;j<list.length;j++)-1!=list[j].prodType.indexOf(vm.prodTypeList[i].typeId)&&tmpList.push(list[j]);if(tmpList.length>0){var prodTtl=new Object;prodTtl.typeId=vm.prodTypeList[i].typeId,prodTtl.typeName=vm.prodTypeList[i].typeName,prodTtl.prodList=tmpList,prodTtl.show=!0,vm.prodTtlList.push(prodTtl)}}})},vm.filterProd=function(typeId){for(var isFilter,i=0;i<vm.prodTypeList.length;i++)vm.prodTypeList[i].typeId!=typeId?vm.prodTypeList[i].focus=!1:(vm.prodTypeList[i].focus=!vm.prodTypeList[i].focus,isFilter=vm.prodTypeList[i].focus);for(var i=0;i<vm.prodTtlList.length;i++)isFilter&&vm.prodTtlList[i].typeId!=typeId?vm.prodTtlList[i].show=!1:vm.prodTtlList[i].show=!0},vm.jumpPrdDetail=function(id){$state.go("product-detail-img",{id:id})},vm.loadingPage=function(){var timer=$timeout(function(){$rootScope.loadingPage?(vm.getProdTypeList(),vm.queryCustomizeProdList(),$timeout.cancel(timer)):vm.loadingPage()},100)},vm.loadingPage(),vm.refresh=function(){vm.loadingPage(),$rootScope.$broadcast("scroll.refreshComplete")}}angular.module("app").controller("cstmMainController",cstmMainController),cstmMainController.$inject=["$state","$rootScope","CommonRequest","CONFIG","$filter","$timeout","PolicyService"]}(),function(){function ClaimsDetailsController($scope,$state,$stateParams,CommonRequest,CONFIG,PolicyService){var vm=this,sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.userData&&(vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.claimsId=$stateParams.claimsId,vm.claimsTab=$stateParams.claimsTab,vm.claimStatus=$stateParams.claimStatus,vm.isGroupTipsShow=!1,vm.receivePath="",vm.goBack=function(){history.back()},vm.claimsId?(vm.showDetailInfo=function(){var params={clmNo:vm.claimsId};CommonRequest.request(params,CONFIG.CLAIMS_DETAIL_SERVCIE,function(result){1==result.status&&(vm.claim=result.data.claimsInfo[0],vm.fcdesc=vm.claim.descs,vm.payDe=result.data.payDetail,vm.accDate=result.data.claimsInfo[0].Accdate,vm.accDate=vm.accDate.replace(/\//g,"-"),vm.timeline=result.data.payDetailList,0==vm.claim.MainState?vm.line=3:1==vm.claim.MainState?vm.line=2:2==vm.claim.MainState&&(vm.line=1),vm.initAccidentreason(vm.claim.accidentreason))})},vm.initAccidentreason=function(accidentreason){"1"==accidentreason?vm.claimsReason="意外":"0"==accidentreason&&(vm.claimsReason="疾病")},vm.initIsClaimAlredy=function(fcresult){"0"==fcresult?vm.isClaimAlredy="已出险":"1"==fcresult&&(vm.isClaimAlredy="未出险")},vm.initDescs=function(fcdesc){return fcdesc.length<2&&(vm.fcdesc[2]="无"),fcdesc.length<1?void(vm.fcdesc[1]="无"):void 0},vm.riskNames=[],vm.showGroupDetail=function(){var params={caseNo:vm.claimsId};CommonRequest.request(params,CONFIG.GROUP_CLAIMS_DETAIL,function(result){if(1==result.status){var data=result.data;vm.caseNo=result.data.caseNo,vm.fcdesc=data.descs,vm.accidentDate=result.data.accidentDate,vm.makeDate=result.data.makeDate,vm.policyNo=data.policyNo,vm.effectiveTime=data.effectiveTime,vm.claimsMoney=data.rsrvFld5,vm.endCaseDate=data.rsrvFld6,vm.giveType=data.giveType,vm.explainDesc=data.explainDesc||"（无）";for(var j=0;j<result.data.risks.length;j++)vm.riskNames.push(result.data.risks[j]);vm.rcgnNm=result.data.rcgnNm,vm.accCause=result.data.accCause,vm.caseState=result.data.caseState,vm.applyOrigin=result.data.applyOrigin,vm.sumMoney=result.data.sumMoney,vm.isGroupTipsShow="2"==vm.claimsTab&&"03"==vm.caseState&&vm.sumMoney>3e3&&"01"==vm.applyOrigin,vm.receivePath=result.data.receivePath,"01"==vm.caseState?vm.caseGroupState="03":vm.caseGroupState="02",vm.rsrvFld4=result.data.rsrvFld4,vm.caseType=result.data.caseType,vm.caseDesc=data.caseDesc||"（无）",0==vm.caseState?vm.line=3:1==vm.caseState?vm.line=2:2==vm.caseState&&(vm.line=1)}})},void("1"==vm.claimsTab?vm.showDetailInfo():vm.showGroupDetail())):void vm.goBack()}angular.module("app").controller("ClaimsDetailsController",ClaimsDetailsController),ClaimsDetailsController.$inject=["$scope","$state","$stateParams","CommonRequest","CONFIG","PolicyService"]}(),function(){function CompensateQueryDetailsController($scope,$stateParams){var data=$stateParams.data,vm=this;vm.check=!0,vm.queryStatus=function(){"报案"==data?(vm.checkFirst=!0,vm.checkSecond=!1,vm.checkThirdly=!1):"审核"==data?(vm.checkFirst=!1,vm.checkSecond=!0,vm.checkThirdly=!1):(vm.checkFirst=!1,vm.checkSecond=!1,vm.checkThirdly=!0)},vm.queryStatus()}angular.module("app").controller("CompensateQueryDetailsController",CompensateQueryDetailsController),CompensateQueryDetailsController.$inject=["$scope","$stateParams"]}(),function(){function CompensateSelectController($ionicPopup,$scope,$state,$stateParams,CommonRequest,CONFIG,TipService,PolicyService,$rootScope,COMMON){var vm=this;vm.goGuide=function(){$state.go("claims-guide")},vm.goQuery=function(){$state.go("claims-query")}}angular.module("app").controller("CompensateSelectController",CompensateSelectController),CompensateSelectController.$inject=["$ionicPopup","$scope","$state","$stateParams","CommonRequest","CONFIG","TipService","PolicyService","$rootScope","COMMON"]}(),function(){function ClaimsImgDetailController($state,$rootScope,CommonRequest,CONFIG,PolicyService,$timeout,$scope){var vm=this;vm.ifmCode=$state.params.ifmCode,vm.imgName=$state.params.imgName,vm.loadStatus=0;var sessionData=PolicyService.getSessionData();if(vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",!vm.serialNo||!vm.ifmCode||!vm.imgName)return void history.go(-1);var headHeight=0;$rootScope.TITLEBAR&&(headHeight=44),vm.getImgDetail=function(){vm.loadStatus=0,$timeout(function(){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgName:vm.imgName};CommonRequest.request(params,CONFIG.NEW_QUERY_IMG,function(result){if(result.status&&1==result.status)if(result.data){if(vm.imgBase64Bytes=result.data.imgBase64Bytes,vm.imgList=result.data.imgList,!vm.containerRate){var containerH=$(".claims-img-detail").eq(0).height()-$(".list-banner").eq(0).height()-headHeight,containerW=$(".claims-img-detail").eq(0).width();vm.containerRate=containerW/containerH}vm.imgRate=result.data.width/result.data.height,console.info("图片---"+vm.imgRate),console.info("内容---"+vm.containerRate),vm.loadStatus=1;for(var i=0;i<=vm.imgList.length;i++)vm.imgName==vm.imgList[i]&&(vm.index=i)}else vm.loadStatus=2;else vm.loadStatus=2},!0)},1e3)},vm.getImgDetail(),vm.pageUp=function(){vm.index--,vm.index<0&&(vm.index=vm.imgList.length-1),vm.imgName=vm.imgList[vm.index],vm.getImgDetail()},vm.pageDown=function(del){return 0==vm.imgList.length?void(vm.loadStatus=3):(del||vm.index++,vm.index>vm.imgList.length-1&&(vm.index=0),vm.imgName=vm.imgList[vm.index],void vm.getImgDetail())},vm.delImg=function(){if(1==vm.loadStatus){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[vm.imgName]};CommonRequest.request(params,CONFIG.NEW_DELETE_CLAIM_THUMB,function(result){if(result.status&&1==result.status){vm.imgList.splice(vm.index,1);var params;"F000"==vm.ifmCode&&(vm.claimsPolicyInfo.idCount--,params={idCount:vm.claimsPolicyInfo.idCount}),"F016"==vm.ifmCode&&(vm.claimsPolicyInfo.historyCount--,params={historyCount:vm.claimsPolicyInfo.historyCount}),"F017"==vm.ifmCode&&(vm.claimsPolicyInfo.chargeCount--,params={chargeCount:vm.claimsPolicyInfo.chargeCount}),PolicyService.setSessionData({claimsPolicyInfo:params}),vm.pageDown(!0)}})}},$scope.$on("$stateChangeStart",function(event,toState){"claims-img-list"==toState.name&&3==vm.loadStatus&&(event.preventDefault(),$state.go("claims-img-upload"))})}angular.module("app").controller("ClaimsImgDetailController",ClaimsImgDetailController),ClaimsImgDetailController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","$timeout","$scope"]}(),function(){function BonusAccountCardNoController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,PolicyService,$timeout,$ionicLoading,TipService){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel,vm.serialTransNo=$state.params.serialTransNo,vm.accType=$state.params.accType,vm.accName=$state.params.accName,vm.bankCode=$state.params.bankCode,vm.bankAccNo=$state.params.bankAccNo,vm.policyDetialBankCode=$state.params.policyDetialBankCode,vm.policyDetialBankAcc=$state.params.policyDetialBankAcc,vm.btk=$state.params.btk,vm.bankName=$state.params.bankName;var sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,vm.payMentMethon="1",vm.channelCode=vm.saleChannel,vm.goBack=function(){history.back()},vm.policyNo?(vm.goset=function(){return vm.bankCode&&vm.bankAccNo&&vm.policyDetialBankCode&&vm.policyDetialBankAcc&&vm.bankCode==vm.policyDetialBankCode&&vm.bankAccNo.replace(/\s/g,"")==vm.policyDetialBankAcc.replace(/\s/g,"")?void TipService.showMsg("变更前后的银行卡号和开户行不能一致"):void(vm.renewNotice=!0)},vm.agree=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,policyNo:vm.policyNo,pbHoldName:vm.userData.customerName,cretType:vm.userData.cretType,cretNo:vm.userData.cretNo,sex:vm.userData.sex,accType:vm.payMentMethon,accName:vm.accName,bankCode:vm.bankCode,bankAccNo:vm.bankAccNo.replace(/\s/g,""),rnBankAccNo:vm.bankAccNo.replace(/\s/g,""),serialTransNo:vm.serialTransNo,config:"PC",CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})},void(vm.iKnow=function(){vm.renewNotice=!1})):void vm.goBack()}angular.module("app").controller("BonusAccountCardNoController",BonusAccountCardNoController),BonusAccountCardNoController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","PolicyService","$timeout","$ionicLoading","TipService"]}(),function(){function PolicyChangePledgeConfirmController($state,$stateParams,$scope,CommonRequest,PolicyChangeService,COMMON,CONFIG,$rootScope,TipService,PolicyService,$timeout,$ionicLoading,Upload,$ionicPopup){function imgTest(val){var reg=new RegExp("(.jpg|.png|.jpeg|.JPG|.PNG|.JPEG|.gif|.GIF)$","g");return reg.test(val)}var vm=this,userData=PolicyService.getSessionData().userData,pledgeData=PolicyService.getSessionData().pledgeData;vm.policyNo=$stateParams.policyNo,vm.seriaTransNo=$stateParams.seriaTransNo,vm.saleChannel=$stateParams.saleChannel,vm.custId=userData.cusId,vm.editType="003",vm.checkContract=!1,vm.applyMoney=pledgeData.borrowsAmount,vm.bankcode=pledgeData.bankCode,vm.bankAccount=pledgeData.accNO;var imagePath="/app/gmc2image/";if(vm.imageList=[],vm.uploaded=0,vm.goBack=function(){history.back()},!vm.seriaTransNo||!vm.policyNo)return TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),void vm.goBack();vm.premMoney=$stateParams.premMoney;var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.btk=vm.policyDetail.saleBranchCode.substring(0,4))}),PolicyChangeService.policyCustomerDetail($state.params,function(data){vm.customerDetail=data,vm.idType=vm.changeId(vm.customerDetail.holderIdType)}),vm.goset=function(){if(!navigator.onLine)return void TipService.showMsg("当前网络不可用，请检查网络状态");if(("A"!=vm.idtype||vm.applyMoney<1e4)&&(vm.token=""),vm.filePath1&&vm.filePath2||(vm.filePath1="",vm.filePath2=""),vm.file1&&vm.file2){vm.imageList.push({F001:vm.file1},{F002:vm.file2});vm.changeId(vm.customerDetail.holderIdType);"A"==vm.cretTypeNew&&vm.imageList.push({F003:vm.mosaicFile1}),PolicyService.isAllowUpload(vm.imageList.length,function(){vm.checkUpload(vm.uploaded)})}else{if(vm.applyMoney>=1e4)return void $ionicLoading.show({template:"图片不能为空",duration:2e3});vm.showModal()}},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.imageList[uploaded],data),function(){vm.uploaded++})},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?(vm.imageFrontPath=path[i].imageTempPath,vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName):"F002"==path[i].imageFlag&&(vm.imageBackPath=path[i].imageTempPath,vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(result.data.error.message+result.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},$scope.$watch("policyChangePledgeConfirm.uploaded",function(newValue,oldValue){if(newValue)if(newValue!=oldValue&&newValue<vm.imageList.length)vm.checkUpload(newValue);else if(newValue==vm.imageList.length)if(console.log(vm.filePath1.split(".")[1]),console.log(vm.filePath2.split(".")[1]),vm.filePath1.split(".")[1]!=vm.filePath2.split(".")[1])TipService.showMsg("身份证正反面文件类型须一致");else if(vm.customerDetail){var cretTypeNew=vm.changeId(vm.customerDetail.holderIdType);"A"==cretTypeNew&&vm.applyMoney>=1e4?vm.ocrSwitch():vm.showModal()}else vm.showModal()}),$scope.$watch("policyChangePledgeConfirmForm.file1.$error.maxSize",function(newValue,oldValue){1==newValue&&TipService.showMsg($rootScope.TIPS.COMMON.UPLOAD_FILE_MAX_SIZE_ERROR)}),$scope.$watch("policyChangePledgeConfirmForm.file2.$error.maxSize",function(newValue,oldValue){1==newValue&&TipService.showMsg($rootScope.TIPS.COMMON.UPLOAD_FILE_MAX_SIZE_ERROR)}),$scope.$watch("policyChangePledgeConfirmForm.file1.$error.pattern",function(newValue,oldValue){1==newValue&&TipService.showMsg($rootScope.TIPS.COMMON.UPLOAD_FILE_TYPE_ERROR)}),$scope.$watch("policyChangePledgeConfirmForm.file2.$error.pattern",function(newValue,oldValue){1==newValue&&TipService.showMsg($rootScope.TIPS.COMMON.UPLOAD_FILE_TYPE_ERROR)}),vm.changeId=function(id){return id="身份证"==id?"A":"护照"==id?"I":"外国人永久居留身份证"==id?"N":"G"},vm.changeSex=function(sex){return"男"==sex?sex="1":"女"==sex&&(sex="2"),sex},vm.showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,config:"LN",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:vm.changeSex(vm.customerDetail.holderGender),cretType:vm.changeId(vm.customerDetail.holderIdType),cretNo:vm.customerDetail.holderIdNum,cretArriveDate:vm.policyDetail.appIdArriveDate,birthday:vm.customerDetail.holderBirthday,bankCode:vm.bankcode,accNO:vm.bankAccount,accName:vm.customerDetail.holderName,borrowsAmount:vm.applyMoney,idImgFront:vm.filePath1,idImgBack:vm.filePath2,oldTransNo:vm.seriaTransNo,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel,token:vm.token}})},vm.showIdMask=function(){vm.idMask=!0},vm.hideIdMask=function(){vm.idMask=!1},vm.fileChange=function(file){if(file){var cretTypeNew=vm.changeId(vm.customerDetail.holderIdType);if("A"==cretTypeNew){if(file.$ngfOrigSize>5242880){vm.tipsDivShow=!0,vm.tipsDiv="上传的图片不能大于5M";var timer=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer)},3e3)}if(!imgTest(file.type)){vm.tipsDiv="您上传的图片类型错误",vm[key]=null;var timer2=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer2)},3e3)}COMMON.identityImg(file,function(img,bolbVal){var timer=$timeout(function(){vm.mosaicImg1=img,$timeout.cancel(timer)},100);bolbVal.name="a.png",vm.mosaicFile1=bolbVal})}}},vm.ShowOcrMsg=function(type,templateMsg){var alertPopup;1==type?alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新识别"}):2==type&&(alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新上传"})),alertPopup.then(function(res){1==type?vm.idCardRecognize():2==type&&(vm.file1=null,vm.file2=null)})},vm.ocrError=function(){vm.ocrStatus=2,vm.showModal()},vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){console.info("OCR开关:",result),result&&1==result.status&&("Y"==result.data?(vm.ocrOpenState=!0,vm.idCardRecognize()):"N"==result.data&&(vm.ocrOpenState=!1,vm.ocrError()))})},vm.errorTimes=function(){if(3==vm.getPolicyResultTimes){vm.messageErr=!0;var timer=$timeout(function(){vm.ocrError(),$timeout.cancel(timer)},1e3),timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3);return!0}return!1},vm.idCardRecognize=function(){if(vm.recognizeFlg=!1,vm.ocrOpenState){var sessionData=PolicyService.getSessionData(),u_data=sessionData.userData;vm.openId=sessionStorage.getItem("elife-openid");var params={idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,checkflg:!0,referenName:u_data.customerName,referenSex:u_data.sex,referenBirthday:u_data.birthday,referenCerid:u_data.cretNo,referenCertype:u_data.cretType,custId:u_data.cusId,openId:vm.openId,sceneCode:"SC003",channelCode:"811"};if(vm.errorTimes())return;vm.getPolicyResultTimes||(vm.getPolicyResultTimes=0),vm.timeoutdata="",vm.ocrStatus=null,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner><div class="ocr-load-text">努力识别中...</div>'}),CommonRequest.request(params,CONFIG.BD_IDCARD_RECOGNIZE,function(result){if($ionicLoading.hide(),vm.timeoutdata=result,"1"==result.status){var recognizeData=result.data;if(vm.token=recognizeData.tocken,"000000"==recognizeData.responseStatus){var userdata=vm.customerDetail||{},bith_date=userdata.holderBirthday.replace(/-/g,"");userdata.holderIdNum==recognizeData.idCardNo&&userdata.holderName==recognizeData.name&&userdata.holderGender==recognizeData.gender&&bith_date==recognizeData.birthday?(vm.ocrStatus=1,vm.showModal()):vm.ShowOcrMsg(2,"请上传投保人的有效证件")}else"222222"==recognizeData.responseStatus&&vm.ShowOcrMsg(2,"您上传的身份证件已过有效期，请检查"),"333333"==recognizeData.responseStatus&&(vm.getPolicyResultTimes++,vm.getPolicyResultTimes<3&&vm.ShowOcrMsg(1,"识别失败，请重新识别")),"555555"!=recognizeData.responseStatus&&"666666"!=recognizeData.responseStatus||vm.ShowOcrMsg(2,"请上传正确且清晰的身份证正反面照片")}else vm.getPolicyResultTimes++;if(3==vm.getPolicyResultTimes){vm.messageErr=!0;var timer=$timeout(function(){vm.ocrError(),$timeout.cancel(timer)},1e3),timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3)}},!0)}}}angular.module("app").controller("PolicyChangePledgeConfirmController",PolicyChangePledgeConfirmController),PolicyChangePledgeConfirmController.$inject=["$state","$stateParams","$scope","CommonRequest","PolicyChangeService","COMMON","CONFIG","$rootScope","TipService","PolicyService","$timeout","$ionicLoading","Upload","$ionicPopup"]}(),function(){function PolicyChangePledgeInfoController($state,$stateParams,$scope,CommonRequest,PolicyChangeService,COMMON,CONFIG,$rootScope,TipService,PolicyService,$timeout){var vm=this,userData=PolicyService.getSessionData().userData;PolicyService.getSessionData().pledgeData;if(vm.policyNo=$stateParams.policyNo,vm.seriaTransNo=$stateParams.seriaTransNo,vm.saleChannel=$stateParams.saleChannel,vm.custId=userData.cusId,vm.editType="003",vm.checkContract=!1,vm.goBack=function(){history.back()},!vm.seriaTransNo||!vm.policyNo)return TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),void vm.goBack();vm.premMoney=$stateParams.premMoney;var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.btk=vm.policyDetail.saleBranchCode.substring(0,4),vm.getBankList())}),PolicyChangeService.policyCustomerDetail($state.params,function(data){vm.customerDetail=data}),vm.goset=function(){return vm.bankcode?(PolicyService.control({state:"policy-change-pledge",control:"data",data:{bankCode:vm.bankcode,accNO:vm.bankAccount,saleChannel:vm.saleChannel}}),void $state.go("policy-change-pledge-confirm",{policyNo:vm.policyNo,seriaTransNo:vm.seriaTransNo,premMoney:vm.premMoney,saleChannel:vm.saleChannel})):void TipService.showMsg("请选择开户银行")},vm.getBankList=function(){vm.btk?(vm.bankList,COMMON.getCommonBank(vm.btk,"2",function(bankList){vm.bankList=bankList,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode=vm.bankList[0].bankCode,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode=vm.bankList[0].bankCode))})):$timeout(function(){vm.getBankList()},100)}}angular.module("app").controller("PolicyChangePledgeInfoController",PolicyChangePledgeInfoController),PolicyChangePledgeInfoController.$inject=["$state","$stateParams","$scope","CommonRequest","PolicyChangeService","COMMON","CONFIG","$rootScope","TipService","PolicyService","$timeout"]}(),function(){function CardChangeWithdrawController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout){var vm=this,sessionData=PolicyService.getSessionData(),policyServeData=sessionData.policyServeData,userData=sessionData.userData,imagePath="/app/gmc2image/";policyServeData||(TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),history.back()),vm.cardNo=policyServeData.cardNo,vm.payMon=policyServeData.cardPrem,vm.cancelInsAmt=policyServeData.cancelInsAmt,vm.amount=policyServeData.cardAmnt,vm.holderDetail=policyServeData.plchdModel,vm.mainClassName=policyServeData.mainClassName,vm.infBeginTime=policyServeData.infBeginTime,vm.infEndTime=policyServeData.infEndTime,"2099-12-31"!=vm.holderDetail.crdtExpDt?(vm.certExpireDate=vm.holderDetail.crdtExpDt,vm.idexpire="2"):vm.idexpire="1",vm.insuredDetail=policyServeData.rcgnModel,vm.backMoneyMode=policyServeData.backMoneyMode,"3"!=vm.backMoneyMode?vm.withdrawWay="0":vm.withdrawWay="1";for(var policyNoList=policyServeData.policyNos.policyNo,i=0;i<policyNoList.length;i++)0==i?vm.policyNoStr=policyNoList[i]:vm.policyNoStr+="，"+policyNoList[i];vm.backMoneyModel=policyServeData.resultBusiInfo,"RV"==policyServeData.cancelBusiType?vm.showlose=!1:(vm.cancelInsAmt<vm.payMon?vm.showlose=!0:vm.showlose=!1,vm.repeal=!0),vm.backMoneyModel.bankAccountNo?vm.payType=2:vm.payType=1,vm.getBankList=function(){policyServeData.saleBranchCode?COMMON.getCommonBank(policyServeData.saleBranchCode.substring(0,4),"2",function(bankList){vm.bankList=bankList,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode=vm.bankList[0].bankCode)}):$timeout(function(){vm.getBankList()},100)},vm.getBankList(),vm.imageList=[],vm.uploaded=0,vm.backWays=function(){"1"==vm.backMoneyMode?vm.payTypeWay=[{label:"原卡原退",value:"0"}]:vm.payTypeWay=[{label:"授权转账",value:"1"}]},vm.backWays(),vm.minStartDate=new Date,vm.goSet=function(){if("1"==vm.withdrawWay&&!vm.backMoneyModel.payChannel&&!vm.bankcode)return void TipService.showMsg("请选择开户银行");if(vm.imageInfo||(vm.filePath1=vm.filePath2=null),"1"==vm.idexpire?vm.certExpireDate=new Date("2099/12/31"):vm.certExpireDate||(vm.certExpireDate=policyServeData.plchdModel.crdtExpDt),vm.imageList=[],vm.uploaded=0,vm.repeal)if(vm.imageInfo)vm.showModal();else{if(!vm.file1||!vm.file2)return void $ionicLoading.show({template:"图片不能为空",duration:2e3});vm.imageList.push({F001:vm.file1},{F002:vm.file2}),PolicyService.isAllowUpload(vm.imageList.length,function(){vm.checkUpload(vm.uploaded)})}else vm.showModal()},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.imageList[uploaded],data),function(){vm.uploaded++})},vm.showModal=function(){var params={config:policyServeData.cancelBusiType,channelCode:policyServeData.saleChannel,cardNo:policyServeData.cardNo,oldTransNo:policyServeData.flowNo,plchdName:policyServeData.plchdModel.name,plchdGenCd:policyServeData.plchdModel.sex,plchdCretNo:policyServeData.plchdModel.crdtNo,plchdCrdtTpCd:policyServeData.plchdModel.crdtTpCd,pbCretIdArriveDate:vm.certExpireDate?$filter("date")(vm.certExpireDate,"yyyy-MM-dd"):policyServeData.plchdModel.crdtExpDt,birthday:policyServeData.plchdModel.birthday,
phoneNo:policyServeData.plchdModel.mobileNo,CCBSBCODE:"CCBSB000",cancelBusiType:policyServeData.cancelBusiType,changeReason:vm.reason,pbBankCode:vm.bankcode?vm.bankcode:"",pbBankAccount:vm.bankAccount?vm.bankAccount:"",CTPDFlag:"0"==vm.withdrawWay?"1":"2",imagePath1:vm.filePath1,imagePath2:vm.filePath2};PolicyService.control({state:"policy-change",control:"data",data:params}),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html")},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName:"F002"==path[i].imageFlag&&(vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(resp.data.error.message+resp.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},$scope.$watch("cardChangeWithdraw.uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&2>newValue?vm.checkUpload(newValue):2==newValue&&vm.showModal())})}angular.module("app").controller("CardChangeWithdrawController",CardChangeWithdrawController),CardChangeWithdrawController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout"]}(),function(){function PolicyExpireGetBankController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout,$ionicPopup){function dataURItoBlob(dataURI){for(var mimeString=dataURI.split(",")[0].split(":")[1].split(";")[0],byteString=atob(dataURI.split(",")[1]),arrayBuffer=new ArrayBuffer(byteString.length),intArray=new Uint8Array(arrayBuffer),i=0;i<byteString.length;i++)intArray[i]=byteString.charCodeAt(i);return new Blob([intArray],{type:mimeString})}function getCityName(id,arr){for(var name="",i=0;i<arr.length;i++)arr[i].areaCode==id&&(name=arr[i].areaName);return name}function isHasBank(){for(var flag=!1,i=0;i<vm.bankList.length;i++)vm.bankOpen==vm.bankList[i].bankCode&&(flag=!0);flag||(vm.bankOpen="")}var vm=this,sessionData=PolicyService.getSessionData(),userData=sessionData.userData,pageData=sessionData.serviceExpireGetData?sessionData.serviceExpireGetData:{};if(vm.idtype=pageData.beneCretType,vm.showInfo=function(data){vm.accName=data.accName,vm.bankOpen=data.bankOpen,vm.bankAccNo=data.bankAccNo,vm.bankCityCode=data.bankCityCode,vm.provinceName=data.bankCityName?data.bankCityName:""},vm.showInfo(pageData),vm.policyNo=pageData.policyNo,!vm.policyNo)return void history.back();vm.banknoIsFocus=!1;var imagePath="/app/gmc2image/";vm.imageList=pageData.fileList,vm.uploaded=0,vm.submit=function(){if(PolicyService.setSessionData({serviceExpireGetData:{bankOpen:vm.bankOpen,bankAccNo:vm.bankAccNo,bankCityCode:vm.bankCityCode,bankCityName:vm.provinceName}}),"0"==vm.idtype&&pageData.isSelf||(vm.token=""),!vm.bankOpen)return void TipService.showMsg("请选择开户银行");if(!navigator.onLine)return void TipService.showMsg("当前网络不可用，请检查网络状态");if(!vm.imageList){var alertImg=$ionicPopup.alert({cssClass:"popup-icon",template:"请先上传证件照片",okText:"我知道了"});return void alertImg.then(function(res){res&&history.back()})}vm.blobList=[];for(var i=0;i<vm.imageList.length;i++){var num=i+1,blob_li=dataURItoBlob(pageData.BlobFiles[i]);blob_li.name=vm.imageList[i]["F00"+num].$ngfName;var blob_obj={};blob_obj["F00"+num]=blob_li,vm.blobList.push(blob_obj)}if("0"==vm.idtype&&pageData.isSelf){var fileData=dataURItoBlob(pageData.mosaicImg1);fileData.name="a.png",vm.blobList.push({F003:fileData})}vm.uploaded=0,PolicyService.isAllowUpload(vm.imageList.length,function(){vm.checkUpload(vm.uploaded)})},$scope.$on("area-common-back",function(event,res){vm.bankCityCode=res[0].areaCode}),$scope.$watch("policyExpireGetBank.bankAccNo",function(newVal,oldVal){if(newVal){var val=newVal.replace(/\s/g,"");if(val.length>4){for(var arr=val.split(""),str="",i=0;i<arr.length;i++)i%4===0&&0!==i&&(str+=" "),str+=arr[i];vm.bankAccNo=str}}}),vm.showArea=function(prams){CommonRequest.request(prams,CONFIG.GET_AREA_SERVCIE,function(result){"1"==result.status&&(prams.areaLevel||vm.provinceName||(vm.provinceName=getCityName(vm.bankCityCode,result.data)))})},vm.showModal=function(){var fullFilePath="";fullFilePath=pageData.isSelf?vm.filePath1+";"+vm.filePath2+";":vm.filePath1+";"+vm.filePath2+";"+vm.filePath3+";"+vm.filePath4+";";var params={fullPayment:{policyNo:vm.policyNo,beneName:pageData.beneName,beneSex:pageData.beneSex,beneCretType:pageData.beneCretType,beneCretNo:pageData.beneCretNo,beneArriveDate:pageData.beneArriveDate,benePhone:pageData.benePhone,beneBirthData:pageData.beneBirthData,beneProvinceCode:pageData.beneProvinceCode,beneCityCode:pageData.beneCityCode,beneCountyCode:pageData.beneCountyCode,beneAddress:pageData.beneAddress,beneNation:pageData.beneNation,beneRela:pageData.beneRela,appnName:pageData.appnName,appnSex:pageData.appnSex,appnCretType:pageData.appnCretType,appnCretNo:pageData.appnCretNo,appnArriveDate:pageData.appnArriveDate,appnPhone:pageData.appnPhone,appnBirthData:pageData.appnBirthData,appnProvinceCode:pageData.appnProvinceCode,appnCityCode:pageData.appnCityCode,appnCountyCode:pageData.appnCountyCode,appnAddress:pageData.appnAddress,appnNation:pageData.appnNation,appnRelation:pageData.appnRelation,bankOpen:vm.bankOpen,bankCityCode:vm.bankCityCode,accName:pageData.accName,bankAccNo:vm.bankAccNo.replace(/\s/g,""),prdName:pageData.prdName,expPrstAmt:pageData.expPrstAmt,expPrstData:pageData.expPrstDt,appnOccupationCode:pageData.appnOccupationCode,beneOccupationCode:pageData.beneOccupationCode,beneOccupationName:pageData.beneOccupationName,appnOccupationName:pageData.appnOccupationName,ocrFlag:vm.token,seriaTransNo:pageData.serialTransNo,fullImagePath:fullFilePath},config:"LA",CCBSBCODE:"CCBSB000",policyNo:vm.policyNo};PolicyService.control({state:"policy-change",control:"data",data:params}),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html")},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.blobList[uploaded],data),function(){vm.uploaded++})},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?(vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName,vm.imageFrontPath=path[i].imageTempPath):"F002"==path[i].imageFlag?(vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName,vm.imageBackPath=path[i].imageTempPath):"F003"==path[i].imageFlag?"0"==vm.idtype&&pageData.isSelf||(vm.filePath3=vm.changePath(path[i].imagePath)+"/"+path[i].imageName):"F004"==path[i].imageFlag&&(vm.filePath4=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(resp.data.error.message+resp.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},$scope.$watch("policyExpireGetBank.uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&newValue<vm.blobList.length?vm.checkUpload(newValue):newValue==vm.blobList.length&&(vm.uploaded=0,pageData.isSelf&&"0"==pageData.beneCretType?"2"!=vm.ocrStatus?vm.ocrSwitch():vm.ocrError(!0):vm.ocrError()))}),vm.getBankList=function(){vm.btk?(vm.bankList,COMMON.getCommonBank(vm.btk,"2",function(bankList){vm.bankList=bankList,isHasBank()})):$timeout(function(){vm.getBankList()},100)},vm.getPolicyInfo=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status?(vm.btk=result.data.saleBranchCode.substring(0,4),vm.getBankList()):vm.bankOpen=""})},vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){if(console.info("OCR开关:",result),result&&1==result.status){if("Y"==result.data)return vm.ocrOpenState=!0,void vm.idCardRecognize();vm.ocrError()}})},vm.ocrError=function(flag){flag||(vm.token=new Date),vm.showModal()},vm.errorTimes=function(){if(3==vm.getPolicyResultTimes){vm.messageErr=!0;var timer=$timeout(function(){vm.ocrError(!0),$timeout.cancel(timer)},1e3),timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3);return!0}return!1},vm.idCardRecognize=function(){if(vm.recognizeFlg=!1,vm.ocrOpenState){var u_data=sessionData.userData;vm.openId=sessionStorage.getItem("elife-openid");var params={idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,referenName:u_data.customerName,referenSex:u_data.sex,referenBirthday:u_data.birthday,referenCerid:u_data.cretNo,referenCertype:u_data.cretType,custId:u_data.cusId,ocrStatus:vm.ocrStatus,openId:vm.openId,sceneCode:"SC005",channelCode:"811"};if(vm.errorTimes())return;vm.getPolicyResultTimes||(vm.getPolicyResultTimes=0),vm.timeoutdata="",vm.ocrStatus=null,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner><div class="ocr-load-text">努力识别中...</div>'}),CommonRequest.request(params,CONFIG.BD_IDCARD_RECOGNIZE,function(result){if($ionicLoading.hide(),vm.timeoutdata=result,"1"==result.status){var recognizeData=result.data;if(vm.token=recognizeData.tocken,"000000"==recognizeData.responseStatus){var bith_date=pageData.beneBirthData.replace(/-/g,""),b_sex=$filter("expireSexFilter")(pageData.beneSex);if(pageData.beneCretNo==recognizeData.idCardNo&&pageData.beneName==recognizeData.name&&b_sex==recognizeData.gender&&bith_date==recognizeData.birthday){if(vm.ocrStatus=1,recognizeData.expiryDate&&8==recognizeData.expiryDate.replace("/(^s*)|(s*$)/g","").length){var t=recognizeData.expiryDate.substring(0,4)+"-"+recognizeData.expiryDate.substring(4,6)+"-"+recognizeData.expiryDate.substring(6,8);pageData.certExpireType="2",pageData.beneArriveDate=t,PolicyService.setSessionData({serviceExpireGetData:{beneArriveDate:pageData.beneArriveDate,certExpireType:pageData.certExpireType}})}vm.showModal()}else vm.ShowOcrMsg(2,"请上传受益人的身份证件信息")}else"111111"==recognizeData.responseStatus&&vm.ShowOcrMsg(2,"姓名和证件号码不匹配"),"222222"==recognizeData.responseStatus&&vm.ShowOcrMsg(2,"您上传的身份证件已过有效期，请检查"),"333333"==recognizeData.responseStatus&&(vm.getPolicyResultTimes++,vm.getPolicyResultTimes<3&&vm.ShowOcrMsg(1,"识别失败，请重新识别")),"555555"!=recognizeData.responseStatus&&"666666"!=recognizeData.responseStatus||vm.ShowOcrMsg(2,"请上传正确且清晰的身份证正反面照片")}else vm.getPolicyResultTimes++;if(3==vm.getPolicyResultTimes){vm.messageErr=!0;var timer=$timeout(function(){vm.ocrError(!0),$timeout.cancel(timer)},1e3),timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3)}},!0)}},vm.ShowOcrMsg=function(type,templateMsg){var alertPopup;1==type?alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新识别"}):2==type&&(alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新上传"})),alertPopup.then(function(res){1==type?vm.idCardRecognize():2==type&&(vm.imageFrontPath="",vm.imageBackPath="",vm.filePath1="",vm.filePath2="",vm.imageList="",PolicyService.setSessionData({serviceExpireGetData:{fileList:"",BlobFiles:""}}),history.back())})},vm.inputFocus=function(key){vm[key]=!0},vm.inputBlur=function(key){vm[key]=!1},vm.inputClear=function(key){vm[key]=""},vm.getPolicyInfo(),vm.bankCityCode&&!vm.provinceName&&vm.showArea({})}angular.module("app").controller("PolicyExpireGetBankController",PolicyExpireGetBankController),PolicyExpireGetBankController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout","$ionicPopup"]}(),function(){function PolicyExpireGetBeneController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.pageData=sessionData.serviceExpireGetData?sessionData.serviceExpireGetData:{},vm.policyNo=vm.pageData.policyNo,vm.addressFlag=!1,vm.addressFlagFn2=function(){vm.addressFlag=!vm.addressFlag},!vm.policyNo)return void history.back();if(vm.addressIsFocus=!1,vm.phoneIsFocus=!1,vm.minDate=new Date,vm.pageData.beneArriveDate){var nowDate=$filter("date")(new Date,"yyyy-MM-dd");new Date(vm.pageData.beneArriveDate)<new Date(nowDate)?vm.pageData.beneArriveDate="":vm.pageData.beneArriveDate=new Date(vm.pageData.beneArriveDate)}"1"==vm.pageData.certExpireType?vm.isCertTypeLong=!0:vm.isCertTypeLong=!1,"0"==vm.pageData.beneCretType?"中国"==vm.pageData.beneNationName?vm.cretTypeSatua="1":vm.cretTypeSatua="3":"6"==vm.pageData.beneCretType?vm.cretTypeSatua="2":vm.cretTypeSatua="3",vm.watch=function(){$scope.$watch("policyExpireGetBene.isCertTypeLong",function(newValue,oldValue){newValue?vm.certExpireType="1":vm.certExpireType="2"})},vm.nationClick=function(val,name){vm.pageData.beneNation=val,vm.pageData.beneNationName=name},$scope.$on("select-area-back",function(event,res){vm.pageData.beneProvinceCode=res[0].areaCode,vm.pageData.beneCityCode=res[1].areaCode,vm.pageData.beneCountyCode=res[2].areaCode}),$scope.$on("nation-search-back",function(event,res){vm.pageData.beneNation=res.countryCode}),vm.errorAlert=function(id,key,val){vm[id]=!1,val&&("benePhone"==key?(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"beneAddress"==key&&(vm.addressErr=!0,$timeout(function(){vm.addressErr=!1},1500)))},vm.inputFocus=function(key){vm[key]=!0},vm.addressClear=function(key){vm.pageData[key]=""},vm.submit=function(){var beneDate=1==vm.certExpireType?"2099-12-31":$filter("date")(vm.pageData.beneArriveDate,"yyyy-MM-dd");PolicyService.setSessionData({serviceExpireGetData:{beneNation:vm.pageData.beneNation,beneCretType:vm.pageData.beneCretType,benePhone:vm.pageData.benePhone,beneProvinceCode:vm.pageData.beneProvinceCode,beneCityCode:vm.pageData.beneCityCode,beneCountyCode:vm.pageData.beneCountyCode,beneAddress:vm.pageData.beneAddress,beneArriveDate:beneDate,certExpireType:vm.certExpireType,provinceName:vm.pageData.provinceName,searchCustomer:!0}}),history.back()},vm.watch()}angular.module("app").controller("PolicyExpireGetBeneController",PolicyExpireGetBeneController),PolicyExpireGetBeneController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout"]}(),function(){function PolicyExpireGetInsuredController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.pageData=sessionData.serviceExpireGetData?sessionData.serviceExpireGetData:{},vm.policyNo=vm.pageData.policyNo,vm.addressFlag=!1,vm.addressFlagFn2=function(){vm.addressFlag=!vm.addressFlag},!vm.policyNo)return void history.back();if(vm.addressIsFocus=!1,vm.phoneIsFocus=!1,vm.minDate=new Date,vm.pageData.appnArriveDate){var nowDate=$filter("date")(new Date,"yyyy-MM-dd");new Date(vm.pageData.appnArriveDate)<new Date(nowDate)?vm.pageData.appnArriveDate="":vm.pageData.appnArriveDate=new Date(vm.pageData.appnArriveDate)}"1"==vm.pageData.appCertExpireType?vm.appIsCertTypeLong=!0:vm.appIsCertTypeLong=!1,"0"==vm.pageData.appnCretType?"中国"==vm.pageData.appnNationName?vm.cretTypeSatua="1":vm.cretTypeSatua="3":"6"==vm.pageData.appnCretType?vm.cretTypeSatua="2":vm.cretTypeSatua="3",vm.watch=function(){$scope.$watch("policyExpireGetInsured.appIsCertTypeLong",function(newValue,oldValue){newValue?vm.appCertExpireType="1":vm.appCertExpireType="2"})},vm.nationClick=function(val,name){vm.pageData.appnNation=val,vm.pageData.appnNationName=name},$scope.$on("nation-search-back",function(event,res){vm.pageData.appnNation=res.countryCode}),$scope.$on("select-area-back",function(event,res){vm.pageData.appnProvinceCode=res[0].areaCode,vm.pageData.appnCityCode=res[1].areaCode,vm.pageData.appnCountyCode=res[2].areaCode}),vm.errorAlert=function(id,key,val){vm[id]=!1,val&&("appnPhone"==key?(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"appnAddress"==key&&(vm.addressErr=!0,$timeout(function(){vm.addressErr=!1},1500)))},vm.inputFocus=function(key){vm[key]=!0},vm.addressClear=function(key){vm.pageData[key]=""},vm.submit=function(){var appnDate=1==vm.appCertExpireType?"2099-12-31":$filter("date")(vm.pageData.appnArriveDate,"yyyy-MM-dd");PolicyService.setSessionData({serviceExpireGetData:{appnNation:vm.pageData.appnNation,appnPhone:vm.pageData.appnPhone,appnProvinceCode:vm.pageData.appnProvinceCode,appnCityCode:vm.pageData.appnCityCode,appnCountyCode:vm.pageData.appnCountyCode,appnAddress:vm.pageData.appnAddress,appnArriveDate:appnDate,appCertExpireType:vm.appCertExpireType,appProvinceName:vm.pageData.appProvinceName}}),history.back()},vm.watch()}angular.module("app").controller("PolicyExpireGetInsuredController",PolicyExpireGetInsuredController),PolicyExpireGetInsuredController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout"]}(),function(){function PolicyExpireGetUploadController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout,VALIDATION){function blobToDataURI(blob,callback){var reader=new FileReader;reader.onload=function(e){callback(e.target.result)},reader.onabort=function(e){vm.blobNum=0,TipService.showMsg("图片读取失败，稍后重试！"),$ionicLoading.hide()},reader.onerror=function(e){vm.blobNum=0,TipService.showMsg("图片读取失败，稍后重试！"),$ionicLoading.hide()},reader.readAsDataURL(blob)}function imgTest(val){var reg=new RegExp("(.jpg|.png|.jpeg|.JPG|.PNG|.JPEG|.gif|.GIF)$","g");return reg.test(val)}var vm=this;vm.flag=!0;var sessionData=PolicyService.getSessionData();sessionData.userData;if(vm.pageData=sessionData.serviceExpireGetData?sessionData.serviceExpireGetData:{},vm.idtype=vm.pageData.beneCretType,vm.policyNo=vm.pageData.policyNo,!vm.policyNo)return void history.back();vm.files=[],vm.uploaded=0,"00"==vm.pageData.beneRela?(vm.isSelf=!0,vm.imageNum=2):(vm.isSelf=!1,vm.imageNum=4),vm.showImg=function(){if(vm.pageData.fileList&&vm.pageData.BlobFiles){vm.baseIimg=!0;for(var i=0;i<vm.pageData.BlobFiles.length;i++){var num=i+1;"0"==vm.idtype&&vm.isSelf&&1==num?(vm.fileImg1=vm.pageData.mosaicImg1,vm.mosaicImg1=vm.pageData.mosaicImg1):vm["fileImg"+num]=vm.pageData.BlobFiles[i]}}},vm.showImg(),vm.submit=function(val){function addChangeFile(id){var index=id+1;vm.files[id]["F00"+index]=vm["file"+index],vm.changeFiles.push({name:"F00"+index,id:id,val:vm["file"+index]})}vm.files=[],vm.blobNum=0,vm.baseIimg?(vm.files=vm.pageData.fileList,vm.BlobFiles=vm.pageData.BlobFiles,vm.changeFiles=[],vm.file1&&addChangeFile(0),vm.file2&&addChangeFile(1),vm.file3&&addChangeFile(2),vm.file4&&addChangeFile(3),vm.changeFiles.length>0?($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.checkBlobChnage()):vm.jump()):(vm.files.push({F001:vm.file1},{F002:vm.file2}),vm.isSelf||vm.files.push({F003:vm.file3},{F004:vm.file4}),vm.BlobFiles=[],$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.checkBlob())},vm.jump=function(){PolicyService.setSessionData({serviceExpireGetData:{fileList:vm.files,BlobFiles:vm.BlobFiles,imageNum:vm.imageNum,isSelf:vm.isSelf,mosaicImg1:vm.mosaicImg1}}),$state.go("policy-expire-get-bank")},vm.checkBlobChnage=function(){vm.blobNum+1;blobToDataURI(vm.changeFiles[vm.blobNum].val,function(val){var index=vm.changeFiles[vm.blobNum].id;vm.BlobFiles[index]=val,vm.blobNum++,vm.blobNum<vm.changeFiles.length?vm.checkBlobChnage():(vm.blobNum=0,$ionicLoading.hide(),vm.jump())})},vm.checkBlob=function(){var num=vm.blobNum+1;blobToDataURI(vm.files[vm.blobNum]["F00"+num],function(val){vm.BlobFiles.push(val),vm.blobNum++,vm.blobNum<vm.files.length?vm.checkBlob():(vm.blobNum=0,$ionicLoading.hide(),vm.jump())})},vm.fullImage=!1,vm.currentFullImage="",vm.changePic=function($event,file){vm.currentFullImage=file;var img=$event.srcElement||$event.target;$scope.bigimage=img.src,vm.fullImage=!0},vm.delUpload=function(){$scope.bigimage="",vm[vm.currentFullImage]=null,vm.fullImage=!1},vm.closePic=function(){vm.fullImage=!1},vm.fileChange=function(file,key){if(file){if(file.$ngfOrigSize>5242880){vm.tipsDivShow=!0,vm.tipsDiv="上传的图片不能大于5M";var timer=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer)},3e3)}if(!imgTest(file.type)){vm.tipsDiv="您上传的图片类型错误",vm[key]=null;var timer2=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer2)},3e3)}"0"==vm.idtype&&"file1"==key&&vm.isSelf&&COMMON.identityImg(file,function(img,bolbVal){var timer=$timeout(function(){vm.mosaicImg1=img,$timeout.cancel(timer)},100);bolbVal.name="a.png",vm.mosaicFile1=bolbVal})}},vm.showIdMask=function(){vm.idMask=!0},vm.hideIdMask=function(){vm.idMask=!1}}angular.module("app").controller("PolicyExpireGetUploadController",PolicyExpireGetUploadController),PolicyExpireGetUploadController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout","VALIDATION"]}(),function(){function ClaimsAmendsMessageController($state,$rootScope,COMMON,$scope,TipService,PolicyService,$filter,$timeout,$ionicScrollDelegate,VALIDATION,CONFIG,$ionicLoading,Upload,CommonRequest,$ionicPopup){var vm=this;document.body.scrollTop;vm.getSession=function(){var sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData||null,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo.serialNo,vm.chargeCount=vm.claimsPolicyInfo.chargeCount||0,vm.userData&&vm.claimsPolicyInfo&&vm.claimsPolicyInfo.serialNo?void(vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F017&&(vm.minImgList=vm.claimsPolicyInfo.F017||[],vm.chargeCount=vm.claimsPolicyInfo.chargeCount||0)):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))},vm.getSession(),vm.init=function(){vm.certType="A",vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data}),vm.isAmount=!1,vm.maxDate=new Date,vm.plchdAppFlag="",vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",vm.chargeCountImg=[],vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.policyTypes=$rootScope.COMMON_DATA.CLAIMSPOLICYTYPES,vm.certTypeName=$filter("cerFilter")(vm.certType)):vm.getCommonData()},200)},vm.getCommonData()},vm.goAccountInfo=function(invalid){if(invalid||vm.phoneVirCheck||vm.addrLenError)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);({preClaimMoney:vm.amount,rsrvFld3:"",rsrvFld4:$filter("date")(vm.certExpireDate,"yyyyMMdd"),rsrvFld8:vm.plchdAppFlag?"APP":""});$state.go("claims-bank-message")},vm.init(),vm.intputFocus=function(id){var screenHeight=$(window).height();vm.isFocus=!0;var elementHeight=$("#"+id).offset().top-.5*screenHeight;elementHeight=0>elementHeight?0:elementHeight,$("#divSpace").css("height",elementHeight+"px"),screenHeight=0>elementHeight?screenHeight+elementHeight:screenHeight,$ionicScrollDelegate.scrollTo(0,screenHeight,[!0])},vm.inputBlur=function(id){var screenHeight=$(window).height();vm.isFocus=!1,$("#divSpace").css("height","0px"),$ionicScrollDelegate.scrollTo(0,screenHeight,[!0])},vm.queryLastImg=function(){var param={serialNo:vm.serialNo,ifmCodeList:["F017"],rsrvFld8:"elife",countNum:"3",sorted:0,cusId:vm.userData.cusId,cusName:vm.userData.customerName};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result.status&&"1"==result.status&&result.data){var params,arrList=result.data.imgDetail.F017;vm.chargeCount=result.data.imgCount.F017,vm.minImgList=[];for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minImgList=arrList,params={chargeCount:vm.chargeCount,F017:vm.minImgList},PolicyService.setSessionData({claimsPolicyInfo:params})}})},vm.queryLastImg(),vm.checkPhoto=function(files,type){vm.savePage("1",files,type)},vm.upload=function(files,type){if(files){var param={file:files,serialNo:vm.serialNo,cusId:vm.userData.cusId,cusName:vm.userData.customerName,channelCode:CONFIG.SALE_CHANNEL,thumbWidth:"80",thumbHeight:"80",ifmCode:type,rsrvFld8:""};$(".wx-upload-div").css("visibility","visible"),$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.NEW_UPLOAD_CLAIM_IMAGE.url,data:param}).then(function(resp){$ionicLoading.hide(),"1"==resp.data.status?(vm.uploadMsg="上传成功！",$(".wx-upload-div").css("visibility","hidden"),vm.file="",vm.queryLastImg()):($(".wx-upload-div").css("visibility","hidden"),TipService.showMsg("上传失败，请稍后再试"))},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%",vm.percentage=progressPercentage+"%",$(".wx-upload-active").css("width",vm.percentage)})}},vm.getImgDetail=function(type,imgName){$state.go("wxclaims-img-detail",{ifmCode:type,imgName:imgName,serialNo:vm.serialNo})},vm.savePage=function(page,files,type){vm.page=page;var data={preClaimMoney:"0",pageNo:vm.page,F017:vm.minImgList,chargeCount:vm.chargeCount};angular.extend(vm.claimsPolicyInfo,data),CommonRequest.request(vm.claimsPolicyInfo,CONFIG.NEW_POST_SAVE_PROGREE,function(result){result.status&&"1"==result.status?(PolicyService.setSessionData({claimsPolicyInfo:vm.claimsPolicyInfo}),"2"==vm.page?$state.go("claims-bank-message"):$timeout(function(){vm.upload(files,type)},100)):TipService.showMsg("保存失败,请稍后再试")})},vm.goAccountInfo=function(invalid){return invalid||vm.phoneVirCheck||vm.addrLenError?void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED):vm.plchdAppFlag&&vm.amount>3e3?void TipService.showMsg("索赔金额超过3000元，请至建信人寿分支机构柜面申请理赔"):void vm.savePage("2")},vm.imgRefesh=function(imgName,ifmCode,index){var params={serialNo:vm.serialNo,ifmCode:ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){if(result.status&&1==result.status&&result.data){var param=result.data[0];param.imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+param.ifmCode+"&fileName="+param.imgName+"&type=THUMB",vm.minImgList[index]=param}})},vm.claimsDetail=function(da){"1"==da?COMMON.showModal("app/module/service/wechat-claims/insurance-agreement/declaration-accredit.html"):"2"==da?COMMON.showModal("app/module/service/wechat-claims/insurance-agreement/fleece-agree.html"):"3"==da?COMMON.showModal("app/module/service/wechat-claims/insurance-agreement/prompt-statement.html"):COMMON.showModal("app/module/service/wechat-claims/insurance-agreement/routing-code.html")}}angular.module("app").controller("ClaimsAmendsMessageController",ClaimsAmendsMessageController),ClaimsAmendsMessageController.$inject=["$state","$rootScope","COMMON","$scope","TipService","PolicyService","$filter","$timeout","$ionicScrollDelegate","VALIDATION","CONFIG","$ionicLoading","Upload","CommonRequest","$ionicPopup"]}(),function(){function ClaimsMessageController($state,$rootScope,COMMON,$scope,TipService,PolicyService,$filter,$timeout,$ionicScrollDelegate,VALIDATION,CONFIG,CommonRequest,$ionicLoading,Upload,$ionicPopup,$window){function transOrigin(data){if(BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var data=result.addressComponents;vm.gudgeIsLocation=data.province,vm.gudgeCity=data.city,vm.gudgeDistrict=data.district,vm.locationNews=data.street+data.streetNumber,PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data,vm.districtLevel1()})}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"获取位置信息失败",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var sessionData,description,vm=this;document.body.scrollTop;if($rootScope.infoparam={rcgnCrdtNo:"",bankAccNo:"",rcgnNm:"",rcgnBrthDt:"",rcgnCrdtTpCd:"",idArriveDate:"",rcgnCareer:"",zipCode:"",rcgnGndCd:"",nation:"",bankOpen:"",rsrvFld1:"",rsrvFld2:"",rsrvFld3:"",rsrvFld4:"",rcgnMoveTelNo:"",rsrvFld6:"wechat",custId:"",rsrvFld9:"",rsrvFld10:""},vm.getSession=function(){sessionData=PolicyService.getSessionData(),vm.userData=sessionData.userData||null,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.claimsPolicyInfo&&vm.claimsPolicyInfo.serialNo?vm.serialNo=vm.claimsPolicyInfo.serialNo:vm.serialNo="",vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F000&&(vm.minList=vm.claimsPolicyInfo.F000||"",vm.minListOne=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.minListTwo=vm.minList&&vm.minList[1]?vm.minList[1]:"")},vm.getSession(),vm.caseNo="",!vm.userData)return TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall");var headHeight=0;if($rootScope.TITLEBAR&&(headHeight=44),!vm.containerRate){var containerH=$(".claims-apply-message").eq(0).height()-headHeight,containerW=$(".claims-apply-message").eq(0).width();vm.containerRate=containerW/containerH}vm.init=function(){vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data}),vm.certType=vm.userData.cretType,vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certNo=vm.userData.cretNo,vm.name=vm.userData.customerName;var len=vm.certNo.length;len>8?vm.certNoDrop=vm.certNo.substr(0,3)+"*****"+vm.certNo.substr(len-3,len):9>len&&len>4&&(vm.certNoDrop=vm.certNo.substr(0,2)+"***"+vm.certNo.substr(len-2,len)),vm.sex=vm.userData.sex,vm.sexShow="A"!=vm.certType,vm.phone=vm.userData.phoneNo,vm.birthday=new Date(VALIDATION.dateFormat(vm.userData.birthday)),vm.birthdayShow="A"!=vm.certType,vm.certExpireType=!1,vm.plchdAppFlag=vm.userData.plchdAppFlag,vm.serialNo=vm.serialNo?vm.serialNo:"",vm.idCountImg=[],vm.maxDate=new Date,vm.claimsPolicyInfo&&(vm.location=vm.claimsPolicyInfo.accDetailAdr||"",vm.occupation=vm.claimsPolicyInfo.rcgnCareer||"",vm.area=vm.claimsPolicyInfo.touchAddress||"",vm.province=vm.claimsPolicyInfo.province||{},vm.city=vm.claimsPolicyInfo.city||{},vm.district=vm.claimsPolicyInfo.district||{},vm.policyDate=vm.claimsPolicyInfo.accidentDate||"",vm.policyDate=new Date(vm.policyDate),"N"==vm.certType||"I"==vm.certType?vm.certTypeFlag=!0:vm.certTypeFlag=!1,
vm.nationality=vm.claimsPolicyInfo.nation||"",vm.nationName=vm.claimsPolicyInfo.nationName||"",vm.certExpireDate=vm.claimsPolicyInfo.idArriveDate||"","20991231"==vm.certExpireDate?vm.certExpireType=!0:vm.certExpireType=!1,vm.certExpireDate=new Date(VALIDATION.dateFormat(vm.certExpireDate)),vm.province&&(vm.province.areaCode=vm.claimsPolicyInfo.accAreaProvinceCode||"",vm.province.areaName=vm.claimsPolicyInfo.accAreaProvinceName||""),vm.city&&(vm.city.areaCode=vm.claimsPolicyInfo.accAreaDistrictCode||"",vm.city.areaName=vm.claimsPolicyInfo.accAreaDistrictName||""),vm.district&&(vm.district.areaCode=vm.claimsPolicyInfo.accAreaDstcCode||"",vm.district.areaName=vm.claimsPolicyInfo.accAreaDstcName||""),vm.zipCode=vm.claimsPolicyInfo.zipCode||""),vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.policyTypes=$rootScope.COMMON_DATA.CLAIMSPOLICYTYPES,vm.certTypeName=$filter("cerFilter")(vm.certType)):vm.getCommonData()},200)},vm.getCommonData()},vm.init(),$scope.$on("select-country-nut-close",function(event,result){vm.nationality=result[0].countryCode,vm.nationName=result[0].countryName,vm.page()}),$scope.$watch("claimsMessage.policyDate",function(newValue){newValue&&vm.page()}),vm.getSerialNo=function(){if(!vm.serialNo&&vm.userData&&vm.userData.cusId){var serialNoParam={custId:vm.userData.cusId};PolicyService.createClaimsAppNo(serialNoParam,function(result){if(result&&1==result.status&&result.data&&""!=result.data){vm.serialNo=result.data;var ocrConfig={url:"../statics/json/ocrSwitchBusinessOptimizer.json",method:"GET"};CommonRequest.request({},ocrConfig,function(result){vm.base64imgSwitch=result["static"],"Y"==vm.base64imgSwitch&&vm.loadCusBase64Img()}),PolicyService.setSessionData({claimsPolicyInfo:{serialNo:vm.serialNo}})}})}},vm.getSerialNo(),CommonRequest.request({},CONFIG.GET_COUNTRY_CORECOUNTRY,function(result){result&&"1"==result.status}),"N"==vm.certType||"I"==vm.certType?vm.certTypeFlag=!0:vm.certTypeFlag=!1,vm.certType&&(vm.nationalities=COMMON.getNutNationalByCertType(vm.certType),"A"==vm.certType&&(vm.nationalityDate=vm.nationalities[0],vm.nationality=vm.nationalityDate.value,vm.nationName=vm.nationalityDate.label,vm.nationalityDisabled=!0)),$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.zipCode=result[2].zipCode}),vm.watch=function(){$scope.$watch("claimsMessage.certType",function(newValue){newValue&&(vm.userData&&vm.userData.cretNo||(vm.certNo=""),"N"==newValue||"I"==newValue?vm.certTypeFlag=!0:vm.certTypeFlag=!1)}),$scope.$watch("claimsMessage.certNo",function(newValue){if(newValue&&vm.certType&&"A"==vm.certType){if(!VALIDATION.idCheck(newValue))return;vm.sex=VALIDATION.getSex(newValue)+"",vm.birthday=new Date(VALIDATION.getBirthday(newValue))}}),$scope.$watch("claimsMessage.certExpireType",function(newValue){1==vm.certExpireType&&(vm.certExpireDate="2099-12-31"),vm.page()}),$scope.$watch("claimsMessage.area",function(newValue){newValue&&((vm.area+vm.location).length-2>60?vm.addrLenError=!0:vm.addrLenError=!1,vm.page())}),$scope.$watch("claimsMessage.location",function(newValue){newValue&&((vm.area+vm.location).length-2>60?vm.addrLenError=!0:vm.addrLenError=!1,vm.page())}),$scope.$watch("claimsMessage.nationality",function(newValue){if(newValue){vm.nationality=vm.nationality;for(var i=0;i<vm.nationalities.length;i++)vm.nationalities[i].value==vm.nationality&&(vm.nationName=vm.nationalities[i].label);vm.page()}}),$scope.$watch("claimsMessage.certExpireDate",function(newValue){newValue&&vm.page()})},vm.watch(),vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){}})}),wx.error(function(res){positionError()})}})},vm.districtLevel1=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.provinces=result,vm.provinceList=[],vm.gudgeIsLocation){for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaName.indexOf(vm.gudgeIsLocation)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return void positionError()}vm.districtLevel2(vm.provinceList)})},vm.districtLevel2=function(area){var level=parseInt(area[0].areaLevel)+1,config={url:"../statics/product/areas/"+vm.prdId+"/"+area[0].areaCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:area[0].areaCode,areaLevel:level};CommonRequest.request(paramsl,config,function(result){return vm.cities=result,vm.cityList=[],vm.gudgeCity&&(vm.cityList=vm.cities,""==vm.cityList)?void positionError():void vm.districtLevel3(vm.provinceList,vm.cityList)})},vm.districtLevel3=function(area1,area2){var params={prdId:vm.prdId,parentAreaCode:area2[0].areaCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+area1[0].areaCode+"/"+area2[0].areaCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.areass=result,vm.districtList=[],!vm.gudgeDistrict)return void positionError();for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaName.indexOf(vm.gudgeDistrict)&&vm.districtList.push(vm.areass[i]);if(""==vm.districtList)return void positionError();if(!vm.districtList[0].parentAreaCode)return void positionError();vm.cityListLast=[];for(var i=0;i<vm.cityList.length;i++)-1!=vm.cityList[i].areaCode.indexOf(vm.districtList[0].parentAreaCode)&&vm.cityListLast.push(vm.cityList[i]);return vm.cityList=vm.cityListLast[0],""==vm.cityList?void positionError():(vm.zipCode=vm.districtList[0].zipCode,vm.provinceList=vm.provinceList[0],vm.districtList=vm.districtList[0],vm.area=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.areaNew=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.location=vm.locationNews,vm.locationNew=vm.locationNews,vm.provinceName=vm.provinceList.areaName||"",vm.cityName=vm.cityList.areaName||"",vm.districtName=vm.districtList.areaName||"",vm.provinceCode=vm.provinceList.areaCode,vm.cityCode=vm.cityList.areaCode,vm.districtCode=vm.districtList.areaCode,void vm.page())})},vm.loadCusBase64Img=function(){var param={serialNo:vm.serialNo,thumbWidth:"80",thumbHeight:"80",ifmCode:"F000",cusId:vm.userData.cusId,cusName:vm.userData.customerName,channelCode:CONFIG.SALE_CHANNEL};CommonRequest.request(param,CONFIG.LOAD_CLAIM_ADDRESS,function(result){if(result&&"1"==result.status&&result.data.length>1){vm.recPngName1=vm.file1=result.data[0].imgName,vm.recPngName2=vm.file2=result.data[1].imgName;var navfront=document.getElementById("recImg1");vm.recBase1=navfront.src=result.data[0].imgBase64Bytes;var navbehind=document.getElementById("recImg2");vm.recBase2=navbehind.src=result.data[1].imgBase64Bytes,vm.minList=result.data,"+"==description?(vm.minListOne=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.minListTwo=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):(vm.minListOne=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.minListTwo=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height);var idCountImg={F000:vm.minList};PolicyService.setSessionData({claimsPolicyInfo:idCountImg}),vm.queryLastImg()}})},vm.queryLastImg=function(){if($rootScope.lastImgFlag)return $rootScope.lastImgFlag="",void(1==vm.minList.length?"+"==vm.minList[0].description?(vm.minListOne=vm.minList[0],vm.minListTwo="",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height):(vm.minListTwo=vm.minList[0],vm.minListOne="",vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):2==vm.minList.length?(vm.minListOne=vm.minList[0],vm.minListTwo=vm.minList[1],vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):(vm.minListOne="",vm.minListTwo=""));var param={serialNo:vm.serialNo,ifmCodeList:["F000"],rsrvFld8:"elife",countNum:"2",sorted:1,cusId:vm.userData.cusId,cusName:vm.userData.customerName};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result&&"1"==result.status&&result.data){vm.historyCountImg=result.data.imgDetail.F000||[];var arrList=result.data.imgDetail.F000;if(arrList&&arrList.length)for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minList=arrList,2==vm.minList.length?"+"==description?(vm.minListOne=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.minListTwo=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):(vm.minListOne=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.minListTwo=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):"+"==description?(vm.minListOne=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.minListTwo=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height):(vm.minListOne=vm.minList&&vm.minList[1]?vm.minList[1]:"",vm.minListTwo=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.imgRateOne=vm.minListOne.width/vm.minListOne.height,vm.imgRateTwo=vm.minListTwo.width/vm.minListTwo.height);var idCountImg={F000:vm.minList};PolicyService.setSessionData({claimsPolicyInfo:idCountImg})}})},vm.checkPhoto=function(file){vm.page()&&vm.upload(file)},vm.upload=function(file){if(file.file1&&(vm.flagSwitch=!0,description="+"),file.file2&&(vm.flagSwitchTwo=!0,description="-"),file.file1||file.file2){var param={file:file.file1?file.file1:file.file2,serialNo:vm.serialNo,cusId:vm.userData.cusId,cusName:vm.userData.customerName,channelCode:CONFIG.SALE_CHANNEL,thumbWidth:"80",thumbHeight:"80",ifmCode:"F000",rsrvFld8:vm.plchdAppFlag?"APP":"",description:description};$(".wx-upload-div").css("visibility","visible"),$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.NEW_UPLOAD_CLAIM_IMAGE.url,data:param}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！",file.file1&&(vm.flagSwitch=!1),file.file2&&(vm.flagSwitchTwo=!1),vm.idCount++;var path=resp.data.data;vm.fileName=path.imgName,vm.queryLastImg(),vm.getUploadType("F000",resp.data)}else file.file1&&(vm.flagSwitch=!1),file.file2&&(vm.flagSwitchTwo=!1),vm.showError=!0,$timeout(function(){vm.showError=!1},1500),vm.errorMsg="网络繁忙,请稍后再试"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%",vm.percentage=progressPercentage+"%",$(".wx-upload-active").css("width",vm.percentage)})}},vm.getUploadType=function(type,data){var param;"F000"==type&&(vm.idCount++,vm.idCountImg.unshift(data),param={idCount:vm.idCount,idCountImg:vm.idCountImg})},vm.getImgDetail=function(type,imgName){$state.go("wxclaims-img-detail",{ifmCode:type,imgName:imgName})},vm.page=function(){var data={serialNo:vm.serialNo,rcgnNm:vm.name,rcgnCrdtTpCd:vm.certType,rcgnCrdtNo:vm.certNo,rcgnGndCd:vm.sex,rcgnMoveTelNo:vm.phone,rcgnBrthDt:$filter("date")(vm.birthday,"yyyy-MM-dd"),rcgnAddress:vm.province?vm.province.areaName+vm.city.areaName+vm.district.areaName+vm.location:vm.areaNew+vm.locationNew,idArriveDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),rsrvFld8:"",accDetailAdr:vm.location||vm.locationNew,accAreaProvinceCode:vm.province?vm.province.areaCode:vm.provinceCode,accAreaProvinceName:vm.province?vm.province.areaName:vm.provinceName,accAreaDistrictCode:vm.city?vm.city.areaCode:vm.cityCode,accAreaDistrictName:vm.city?vm.city.areaName:vm.cityName,accAreaDstcCode:vm.district?vm.district.areaCode:vm.districtCode,accAreaDstcName:vm.district?vm.district.areaName:vm.districtName,pageNo:"0",rcgnCareer:vm.occupation,nation:vm.nationality,nationName:vm.nationName,zipCode:vm.zipCode,rsrvFld1:vm.caseNo||"",touchAddress:vm.province?vm.province.areaName+vm.city.areaName+vm.district.areaName:vm.areaNew,province:vm.province||vm.provinceList,city:vm.city||vm.cityList,district:vm.district||vm.districtList,accidentDate:$filter("date")(vm.policyDate,"yyyy-MM-dd"),flowNo:""};return PolicyService.setSessionData({claimsPolicyInfo:data}),data},vm.errorAlert=function(model,invalid,length,val,number,add){model&&(invalid||length||number||add)&&(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),"location"==val&&(1==length||add?vm.errorMsg="您输入的地址长度不符":1==invalid?vm.errorMsg="您输入的地址格式不正确":1==number&&(vm.errorMsg="您输入的地址不能全为数字")),"occupation"==val&&(1==length?vm.errorMsg="您输入的职业长度不符":invalid&&(vm.errorMsg="您输入职业不正确"))),vm.page()},vm.hide=function(){vm.showError=!1},vm.savaClaimsInfo=function(){var dataClaims=vm.page();CommonRequest.request(dataClaims,CONFIG.NEW_POST_SAVE_PROGREE,function(result){result.status&&"1"==result.status||TipService.showMsg("保存失败,请稍后再试")})},vm.claimsQueryclainfo=function(){var params={rcgnCrdtNo:vm.certNo,rcgnNm:vm.name,rcgnCrdtTpCd:vm.certType,accidentDate:$filter("date")(vm.policyDate,"yyyy-MM-dd")};CommonRequest.request(params,CONFIG.CLAIMS_QUERYCLAIMCASEINFO,function(result){if(result&&"1"==result.status){if(0==result.data.errorCode){vm.record=result.data,vm.caseNo=vm.record.caseNo||"";var parms={rsrvFld1:vm.caseNo||""};return PolicyService.setSessionData({claimsPolicyInfo:parms}),void vm.savaClaimsInfo()}vm.savaClaimsInfo(),$state.go("claims-risk-message",{arg:{certType:vm.certType,certNoDrop:vm.certNo,type:3}})}})},vm.checkCount=function(callback){var params={rcgnCrdtNo:vm.certNo,rcgnNm:vm.name,rcgnCrdtTpCd:vm.certType,accidentDate:$filter("date")(vm.policyDate,"yyyy-MM-dd")};CommonRequest.request(params,CONFIG.CLAIMS_CLAIM_APPLY_CHECK,function(result){if(1==result.status&&result.data)if(0==result.data.claimApplyCheck){$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"同一出险人，一天内，同一出险日期最多可以进行"+result.data.claimApplyNum+"次理赔申请，请明天再来，谢谢！",okText:"确定"})}else 1==result.data.claimApplyCheck&&vm.claimsQueryclainfo()})},vm.goAccountInfo=function(invalid){return vm.policyDate?vm.nationality?vm.occupation?vm.certExpireDate?vm.area?!vm.location||vm.addrLenError?(vm.errorMsg="请填写详细地址",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):vm.minList&&vm.minList[0]&&vm.minList&&vm.minList[1]?void(invalid||(vm.checkCount(),$rootScope.infoparam.rcgnCrdtNo=vm.certNo?vm.certNo:"",$rootScope.infoparam.rcgnNm=vm.name?vm.name:"",$rootScope.infoparam.rcgnBrthDt=$filter("date")(vm.birthday,"yyyy-MM-dd"),$rootScope.infoparam.rcgnCrdtTpCd=vm.certType?vm.certType:"",$rootScope.infoparam.idArriveDate=$filter("date")(vm.certExpireDate,"yyyyMMdd"),$rootScope.infoparam.rcgnCareer=vm.occupation?vm.occupation:"",$rootScope.infoparam.zipCode=vm.zipCode?vm.zipCode:"",$rootScope.infoparam.rcgnGndCd=vm.sex?vm.sex:"",$rootScope.infoparam.nation=vm.nationality?vm.nationality:"",$rootScope.infoparam.rsrvFld1=vm.province?vm.province.areaCode:vm.provinceCode,$rootScope.infoparam.rsrvFld2=vm.city?vm.city.areaCode:vm.cityCode,$rootScope.infoparam.rsrvFld3=vm.district?vm.district.areaCode:vm.districtCode,$rootScope.infoparam.rsrvFld4=vm.location||vm.locationNew,$rootScope.infoparam.rcgnMoveTelNo=vm.phone?vm.phone:"",$rootScope.infoparam.custId=vm.userData.cusId?vm.userData.cusId:"")):(vm.errorMsg="请上传身份证正反面",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):(vm.errorMsg="请选择联系地址",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):(vm.errorMsg="请选择证件有效期",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):(vm.errorMsg="请填写职业",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):(vm.errorMsg="请填写所在国籍",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500)):(vm.errorMsg="请填写出险日期",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500))},vm.imgRefesh=function(imgName,ifmCode,index){var params={serialNo:vm.serialNo,ifmCode:ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){if(result.status&&1==result.status&&result.data){var param=result.data[0],ifmCode=param.ifmCode,fileName=param.imgName,imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+ifmCode+"&fileName="+fileName+"&type=THUMB",height=param.thumbHeight,width=param.thumbWidth,imgUrlDetail={imgURL:imgURL,height:height,width:width,fileName:fileName,ifmCode:ifmCode};vm.minImgList[index]=imgUrlDetail}})},vm.serialNo&&vm.queryLastImg(),vm.needYes=function(){"意外"==vm.record.accCause?vm.healthTag="1":vm.healthTag="2";var parms={accCause:vm.healthTag,rsrvFld1:vm.caseNo||"",accDetail:vm.record.accDetail};vm.page();PolicyService.setSessionData({claimsPolicyInfo:parms}),$state.go("claims-risk-message",{arg:{certType:vm.certType,certNoDrop:vm.certNo,type:1}})},vm.noUser=function(){var parms={rsrvFld1:""};PolicyService.setSessionData({claimsPolicyInfo:parms}),$state.go("claims-risk-message",{arg:{certType:vm.certType,certNoDrop:vm.certNo,type:2}})}}angular.module("app").controller("ClaimsMessageController",ClaimsMessageController),ClaimsMessageController.$inject=["$state","$rootScope","COMMON","$scope","TipService","PolicyService","$filter","$timeout","$ionicScrollDelegate","VALIDATION","CONFIG","CommonRequest","$ionicLoading","Upload","$ionicPopup","$window"]}(),function(){function ClaimsBankMessageController($state,$rootScope,CommonRequest,CONFIG,COMMON,$scope,PolicyService,TipService,$ionicScrollDelegate,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData||null,vm.serialNo=vm.claimsPolicyInfo.serialNo,!vm.claimsPolicyInfo||!vm.userData)return TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall");var sessionData;vm.getSession=function(){sessionData=PolicyService.getSessionData(),vm.userData=sessionData.userData||null,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.claimsPolicyInfo&&vm.claimsPolicyInfo.serialNo?vm.serialNo=vm.claimsPolicyInfo.serialNo:vm.serialNo="",vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F000&&(vm.minList=vm.claimsPolicyInfo.F000||"",vm.minListOne=vm.minList&&vm.minList[0]?vm.minList[0]:"",vm.minListTwo=vm.minList&&vm.minList[1]?vm.minList[1]:"")},vm.getSession(),vm.init=function(){CommonRequest.request({},CONFIG.GET_DICT_BANKLST,function(result){if(result&&result.status&&"1"==result.status&&result.data){if(vm.accountBanks=result.data,vm.claimsPolicyInfo.bankOpen)for(var i=0;i<vm.accountBanks.length;i++)if(vm.claimsPolicyInfo.bankOpen==vm.accountBanks[i].dictCode){vm.accountBank=vm.accountBanks[i];break}}else TipService.showMsg("获取开户银行失败")}),vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?vm.policyTypes=$rootScope.COMMON_DATA.CLAIMSPOLICYTYPES:vm.getCommonData()},200)},vm.getCommonData(),vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data}),vm.accountName&&(vm.nameDisabled=!0),vm.province=vm.claimsPolicyInfo.bankOpenProvince||"",vm.accountLocation=vm.claimsPolicyInfo.accountLocation||"",vm.claimsPolicyInfo&&(vm.province&&(vm.province.areaCode=vm.claimsPolicyInfo.bankProvince||"",vm.province.areaName=vm.claimsPolicyInfo.bankProvinceName||""),vm.city=vm.claimsPolicyInfo.bankOpenCity||"",vm.city&&(vm.city.areaCode=vm.claimsPolicyInfo.bankCity||"",vm.city.areaName=vm.claimsPolicyInfo.bankDistrictName||""),vm.accountBank=vm.claimsPolicyInfo.bankOpen||"",vm.dictName=vm.claimsPolicyInfo.bankName||"",vm.bankAccount=vm.claimsPolicyInfo.bankAccNo||"")},vm.init(),vm.page=function(){var datas={accName:vm.claimsPolicyInfo.rcgnNm,bankAccNo:vm.bankAccount,channelCode:CONFIG.SALE_CHANNEL,accountLocation:vm.accountLocation};vm.city&&(datas.bankProvince=vm.province.areaCode,datas.bankProvinceName=vm.province.areaName,datas.bankCity=vm.city.areaCode,datas.bankDistrictName=vm.city.areaName,datas.bankOpenProvince=vm.province,datas.bankOpenCity=vm.city),vm.dictCode&&(datas.bankOpen=vm.dictCode,datas.bankName=vm.dictName),angular.extend(vm.claimsPolicyInfo,datas),PolicyService.setSessionData({claimsPolicyInfo:vm.claimsPolicyInfo}),CommonRequest.request(vm.claimsPolicyInfo,CONFIG.NEW_POST_SAVE_PROGREE,function(result){result.status&&"1"==result.status?PolicyService.setSessionData({claimsPolicyInfo:vm.claimsPolicyInfo}):TipService.showMsg("保存失败,请稍后再试")})},$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.page()}),$scope.$watch("claimsBankMessage.accountBank",function(newValue){newValue&&(vm.dictName=vm.accountBank.dictName,vm.dictCode=vm.accountBank.dictCode,vm.page())}),vm.goImgUpload=function(invalid){if(!vm.accountBank)return vm.errorMsg="请选择开户行",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!vm.bankAccount)return vm.errorMsg="请填写卡号信息",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!vm.accountLocation)return vm.errorMsg="请选择开户城市",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!invalid){$rootScope.infoparam.bankAccNo=vm.bankAccount?vm.bankAccount:"",$rootScope.infoparam.bankOpen=vm.accountBank.dictCode?vm.accountBank.dictCode:vm.dictCode,$rootScope.infoparam.rsrvFld9=vm.province.areaCode?vm.province.areaCode:"",$rootScope.infoparam.rsrvFld10=vm.city.areaCode?vm.city.areaCode:"";var data={chargeCount:vm.claimsPolicyInfo.chargeCount,bankOpenProvince:vm.province,bankOpenCity:vm.city,bankProvince:vm.province.areaCode,bankProvinceName:vm.province.areaName,bankCity:vm.city.areaCode,bankDistrictName:vm.city.areaName,accName:vm.claimsPolicyInfo.rcgnNm,bankOpen:vm.dictCode,bankName:vm.dictName,bankAccNo:vm.bankAccount,channelCode:CONFIG.SALE_CHANNEL,pageNo:"3",accountLocation:vm.accountLocation,flowNo:""};angular.extend(vm.claimsPolicyInfo,data),CommonRequest.request(vm.claimsPolicyInfo,CONFIG.NEW_POST_SAVE_PROGREE,function(result){result.status&&"1"==result.status?(PolicyService.setSessionData({claimsPolicyInfo:vm.claimsPolicyInfo}),$state.go("claims-ink-confirm")):TipService.showMsg("保存失败,请稍后再试")})}},vm.errorAlert=function(model,invalid,length,val){vm.page(),model&&(invalid||length)&&(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),"bankAccount"==val&&(1==length?vm.errorMsg="您输入的银行账号长度不符":1==invalid&&(vm.errorMsg="您输入的银行账号格式不正确")))},vm.hide=function(){vm.showError=!1}}angular.module("app").controller("ClaimsBankMessageController",ClaimsBankMessageController),ClaimsBankMessageController.$inject=["$state","$rootScope","CommonRequest","CONFIG","COMMON","$scope","PolicyService","TipService","$ionicScrollDelegate","$timeout"]}(),function(){function ClaimsInkConfirmController($state,$rootScope,CommonRequest,CONFIG,PolicyService,TipService,$timeout,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo.serialNo,vm.userData=sessionData.userData||null,vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=44);var windowsHeight=parseInt(.96*$(window).height());parseInt(.96*$(window).width());return vm.claimsPolicyInfo&&(vm.claimsPolicyInfo.zipCode&&""!=vm.claimsPolicyInfo.zipCode||(vm.claimsPolicyInfo.zipCode="200210")),vm.claimsPolicyInfo&&vm.userData?(document.getElementById("claims-ink").addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.getElementById("claims-ink").addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),vm.signStart=!1,vm.signMarkDetail=function(){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=windowsHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=9,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/service/water_mark_claims.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY)}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0)}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(console.info($rootScope.infoparam),vm.claimMessageAuthentication(),!vm.signStart)return vm.errorMsg="请完成签名",vm.showError=!0,void $timeout(function(){vm.showError=!1},3e3);vm.signBase64=this.canvas.toDataURL();var param={ifmCode:"F019",imgBase64Bytes:vm.signBase64||"",serialNo:vm.claimsPolicyInfo.serialNo,suffix:"png"};CommonRequest.request(param,CONFIG.UPLOAD_BY_BASE64,function(result){"1"==result.status&&vm.submitToCore()})}.bind(this),!1)}new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:2,color:"black",background:"#ffffff"})},vm.signMarkDetail(),vm.goNextPage=function(data){PolicyService.control({state:"claims-account-info",control:"data",data:data}),$state.go("wx-claims-success")},vm.submitToCore=function(){CommonRequest.request(vm.claimsPolicyInfo,CONFIG.WX_CLAIMS_APPLY,function(result){if(result.status&&1==result.status){var flowNoParam={flowNo:result.data||""};flowNoParam=angular.extend(vm.claimsPolicyInfo,flowNoParam),vm.claimsApplyResult(vm.claimsPolicyInfo)}})},vm.claimsApplyCount=0,vm.claimsApplyResult=function(params){return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.claimsApplyCount>=CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_TIMES?(vm.claimsApplyCount=0,$ionicLoading.hide(),void TipService.showMsg("核心服务忙，请稍后再试")):(params.appNo=params.serialNo,void CommonRequest.request(params,CONFIG.WX_CLAIMS_APPLY_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return vm.claimsApplyCount++,void $timeout(function(){vm.claimsApplyResult(params)},CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_DURATION);$ionicLoading.hide(),vm.claimsApplyCount=0,PolicyService.control({state:"claims-account-info",control:"data",data:result.data}),$state.go("wx-claims-success")}else $ionicLoading.hide(),vm.claimsApplyCount=0},!0))},window.addEventListener("orientationchange",function(e){window.location.reload()}),void(vm.claimMessageAuthentication=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'});var infoparam=$rootScope.infoparam;CommonRequest.request(infoparam,CONFIG.NEW_POST_SAVE_CLAIMMESSAGE,function(result){return"1"==result.status?void $ionicLoading.hide():void vm.claimMessageAuthentication()})})):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))}angular.module("app").controller("ClaimsInkConfirmController",ClaimsInkConfirmController),ClaimsInkConfirmController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","TipService","$timeout","$ionicLoading"]}(),function(){function ClaimsRiskMessageController($state,$rootScope,COMMON,$scope,TipService,PolicyService,$filter,$timeout,$ionicScrollDelegate,VALIDATION,CONFIG,$ionicLoading,Upload,CommonRequest,$window,$ionicPopup,$stateParams){var vm=this;document.body.scrollTop;vm.getSession=function(){var sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData||null,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",vm.historyCount=vm.claimsPolicyInfo.historyCount?vm.claimsPolicyInfo.historyCount:0,vm.userData&&vm.serialNo&&sessionData.claimsPolicyInfo?(vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F016&&(vm.minImgList=vm.claimsPolicyInfo.F016||[],vm.historyCount=vm.claimsPolicyInfo.historyCount||0),void(vm.pageNo0=vm.claimsPolicyInfo.pageNo0)):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))},vm.getSession(),vm.maxDate=new Date,vm.plchdAppFlag="",vm.idCountImg=[],vm.historyCountImg=[],vm.chargeCountImg=[],vm.maxImgList=[],vm.claimsPolicyInfo&&(vm.healthTag=vm.claimsPolicyInfo.accCause||"",vm.policyType=vm.claimsPolicyInfo.rsrvFld9||"",vm.accDetail=vm.claimsPolicyInfo.accDetail||"",vm.policyDate=vm.claimsPolicyInfo.accidentDate||"",vm.policyDate=new Date(vm.policyDate)),$filter("date")(vm.policyDate,"yyyy-MM-dd"),$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),$scope.$watch("claimsRiskMessage.location",function(newValue){newValue&&((vm.area+vm.location).length-2>60?vm.addrLenError=!0:vm.addrLenError=!1)}),$scope.$watch("claimsRiskMessage.policyDate",function(newValue){}),vm.queryLastImg=function(){var param={serialNo:vm.serialNo,ifmCodeList:["F016"],rsrvFld8:"elife",countNum:"3",sorted:0,cusId:vm.userData.cusId,cusName:vm.userData.customerName};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result.status&&"1"==result.status&&result.data){var arrList=result.data.imgDetail.F016;if(vm.historyCount=result.data.imgCount.F016,arrList&&arrList.length)for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minImgList=arrList,PolicyService.setSessionData({claimsPolicyInfo:{historyCount:vm.historyCount,F016:vm.minImgList}})}})},vm.checkPhoto=function(files,type){vm.upload(files,type)},vm.upload=function(files,type){if(vm.historyCount>=20)return vm.showError=!0,$timeout(function(){vm.showError=!1},1500),void(vm.errorMsg="最多支持上传20张照片");if(files){vm.flagSwitch=!0;var param={file:files,serialNo:vm.serialNo,cusId:vm.userData.cusId,cusName:vm.userData.customerName,channelCode:CONFIG.SALE_CHANNEL,thumbWidth:"80",thumbHeight:"80",ifmCode:type,rsrvFld8:""};$("#wx-upload-div").css("visibility","visible"),$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.NEW_UPLOAD_CLAIM_IMAGE.url,data:param}).then(function(resp){$ionicLoading.hide(),"1"==resp.data.status?(vm.uploadMsg="上传成功！",$("#wx-upload-div").css("visibility","hidden"),vm.file="",vm.flagSwitch=!1,vm.queryLastImg()):($(".wx-upload-div").css("visibility","hidden"),vm.showError=!0,$timeout(function(){vm.showError=!1},1500),vm.errorMsg="网络繁忙,请稍后再试",vm.flagSwitch=!1)},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%",vm.percentage=progressPercentage+"%",$(".wx-upload-active").eq(0).css("width",vm.percentage)})}},vm.imgRefesh=function(imgName,ifmCode,index){var params={serialNo:vm.serialNo,ifmCode:ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){if(result.status&&1==result.status&&result.data){var param=result.data[0];param.imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+param.ifmCode+"&fileName="+param.imgName+"&type=THUMB",
vm.minImgList[index]=param}})},vm.getImgDetail=function(type,imgName){$state.go("wxclaims-img-detail",{ifmCode:type,imgName:imgName})},vm.errorAlert=function(model,invalid,length,val,number){model&&(invalid||length||number)?(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),1==length?vm.errorMsg="事故经过不能大于200个字符":1==invalid?vm.errorMsg="事故经过不能输入*或#":1==number&&(vm.errorMsg="事故经过不能小于2个字符")):vm.savePage("0")},vm.savePage=function(page){vm.page=page;var data={historyCount:vm.historyCount,accCause:vm.healthTag,caseType:"100",rsrvFld9:vm.policyType,pageNo:vm.page,accDetail:vm.accDetail,F016:vm.minImgList,F017:vm.claimsPolicyInfo.F017||"",flowNo:""};angular.extend(vm.claimsPolicyInfo,data),PolicyService.setSessionData({claimsPolicyInfo:vm.claimsPolicyInfo}),CommonRequest.request(vm.claimsPolicyInfo,CONFIG.NEW_POST_SAVE_PROGREE,function(result){result&&"1"==result.status?"1"==vm.page&&$state.go("claims-amends-message"):TipService.showMsg("保存失败,请稍后再试")})},vm.healthTagFlag=function(data){vm.healthTag=data,vm.savePage("0"),vm.claimsApplyMessage=!0},vm.policyTypeFlag=function(data){vm.policyType=data,vm.savePage("0"),vm.claimsApplyMessage=!0},vm.goAccountInfo=function(invalid){if(!vm.healthTag)return vm.errorMsg="请填写出险原因",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!vm.policyType)return vm.errorMsg="请填写理赔类型",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!vm.accDetail||vm.error)return vm.errorMsg="请填写事故经过",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);if(!vm.minImgList)return vm.errorMsg="请上传病例资料照片",vm.showError=!0,void $timeout(function(){vm.showError=!1},1500);console.table($stateParams);var certType=$stateParams.arg.certType,certNoDrop=$stateParams.arg.certNoDrop;$scope.Alert=function(val){vm.Alertshow=!0,1==val?vm.AlertshowChild1=!0:vm.AlertshowChild2=!0,$timeout(function(){vm.Alertshow=vm.AlertshowChild1=vm.AlertshowChild2=!1},1500)},$scope.hide2=function(){vm.Alertshow=vm.AlertshowChild1=vm.AlertshowChild2=!1};var data={rcgnCrdtTpCd:certType,rcgnCrdtNo:certNoDrop,accCause:vm.healthTag,rsrvFld9:vm.policyType};CommonRequest.request(data,CONFIG.ValidateClmAccCause,function(result){console.info(data),result&&"1"==result.status&&(0==result.data.rsrvFld1?$scope.Alert(1):vm.savePage("1"))})},vm.serialNo&&vm.queryLastImg(),console.info($stateParams.arg.type),vm.claimsApplyMessage=2!=$stateParams.arg.type,vm.claimsApplyMessage?vm.accDetail:vm.accDetail="";var beginFirst1=1,beginFirst2=1;$scope.$watch("claimsRiskMessage.healthTag",function(newValue){localStorage.getItem(healthTag)&&beginFirst1&&2!=$stateParams.arg.type&&(vm.healthTag=localStorage.getItem(healthTag),beginFirst1=0),2!=$stateParams.args.type?localStorage.setItem(healthTag,vm.healthTag):""}),$scope.$watch("claimsRiskMessage.accDetail",function(newValue){localStorage.getItem(accDetail)&&beginFirst2&&2!=$stateParams.arg.type&&(vm.healthTag=localStorage.getItem(accDetail),beginFirst2=0),2!=$stateParams.args.type?localStorage.setItem(accDetail,vm.accDetail):""})}angular.module("app").controller("ClaimsRiskMessageController",ClaimsRiskMessageController),ClaimsRiskMessageController.$inject=["$state","$rootScope","COMMON","$scope","TipService","PolicyService","$filter","$timeout","$ionicScrollDelegate","VALIDATION","CONFIG","$ionicLoading","Upload","CommonRequest","$window","$ionicPopup","$stateParams"]}(),function(){function WxClaimsSuccessController($scope,$state,$rootScope,CommonRequest,CONFIG,PolicyService,TipService){var vm=this;vm.stateStatus=!1;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.receiveFlag=vm.claimsPolicyInfo.respCode,vm.receiveFlag&&"1"==vm.receiveFlag&&(vm.caseNo=vm.claimsPolicyInfo.caseNo,vm.receivePath=vm.claimsPolicyInfo.receivePath),vm.goMainPage=function(){$state.go("claims-inquiry")},$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){vm.stateStatus||"claims-page-success"==fromState.name&&(event.preventDefault(),vm.stateStatus=!0,vm.goMainPage())})}angular.module("app").controller("WxClaimsSuccessController",WxClaimsSuccessController),WxClaimsSuccessController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","PolicyService","TipService"]}(),function(){function WxclaimsImgDetailController($state,$rootScope,CommonRequest,CONFIG,PolicyService,$timeout,$scope){var vm=this;vm.ifmCode=$state.params.ifmCode,vm.imgName=$state.params.imgName,$rootScope.lastImgFlag=!0,vm.frompage=$state.params.frompage?$state.params.frompage:"message",vm.loadStatus=0;var sessionData=PolicyService.getSessionData();if(vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData,vm.serialNo=vm.claimsPolicyInfo.serialNo,!vm.serialNo||!vm.ifmCode||!vm.imgName)return void history.go(-1);var headHeight=0;$rootScope.TITLEBAR&&(headHeight=44),vm.getImgDetail=function(){vm.loadStatus=0,$timeout(function(){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgName:vm.imgName};CommonRequest.request(params,CONFIG.NEW_QUERY_IMG,function(result){if(result.status&&1==result.status)if(result.data){var imgURL=(result.data.ifmCode,result.data.imgName,CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+vm.ifmCode+"&fileName="+vm.imgName+"&type=ORIGIN");if(vm.height=result.data.height,vm.width=result.data.width,vm.imgURL=imgURL,vm.imgList=result.data.imgList,!vm.containerRate){var containerH=$(".claims-img-detail").eq(0).height()-$(".list-banner").eq(0).height()-headHeight,containerW=$(".claims-img-detail").eq(0).width();vm.containerRate=containerW/containerH}vm.imgRate=result.data.width/result.data.height,vm.loadStatus=1;for(var i=0;i<=vm.imgList.length;i++)vm.imgName==vm.imgList[i]&&(vm.index=i)}else vm.loadStatus=2;else vm.loadStatus=2},!0)},1e3)},vm.getImgDetail(),vm.pageUp=function(){vm.index--,vm.index<0&&(vm.index=vm.imgList.length-1),vm.imgName=vm.imgList[vm.index],vm.getImgDetail()},vm.pageDown=function(del){return 0==vm.imgList.length?void(vm.loadStatus=3):(del||vm.index++,vm.index>vm.imgList.length-1&&(vm.index=0),vm.imgName=vm.imgList[vm.index],void vm.getImgDetail())},vm.queryLastImg=function(){"F000"==vm.ifmCode?vm.countNum="2":vm.countNum="3";var param={serialNo:vm.serialNo,ifmCodeList:[vm.ifmCode],rsrvFld8:"elife",countNum:vm.countNum,cusId:vm.userData.cusId,cusName:vm.userData.customerName};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result.status&&"1"==result.status){var params;if(result.data){if("F016"==vm.ifmCode){var arrList=result.data.imgDetail.F016||{};vm.historyCount=result.data.imgCount.F016}else if("F017"==vm.ifmCode){var arrList=result.data.imgDetail.F017||{};vm.chargeCount=result.data.imgCount.F017}else{for(var arrList=result.data.imgDetail.F000||{},i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minList=arrList,params={F000:vm.minList}}if(arrList.length&&"F000"!=vm.ifmCode){for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minImgList=arrList}"F016"==vm.ifmCode?params={F016:vm.minImgList}:"F017"==vm.ifmCode&&(params={F017:vm.minImgList})}PolicyService.setSessionData({claimsPolicyInfo:params})}})},vm.delImg=function(){if(1==vm.loadStatus){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[vm.imgName]};CommonRequest.request(params,CONFIG.NEW_DELETE_CLAIM_THUMB,function(result){if(result.status&&1==result.status){vm.imgList.splice(vm.index,1);var params;"F016"==vm.ifmCode&&(vm.historyCount--,params={historyCount:vm.historyCount},PolicyService.setSessionData({claimsPolicyInfo:params})),"F017"==vm.ifmCode&&(vm.chargeCount--,params={chargeCount:vm.chargeCount},PolicyService.setSessionData({claimsPolicyInfo:params})),vm.pageDown(!0),vm.queryLastImg()}})}},vm.upload=function(){if("F000"==vm.ifmCode){var data={F000:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-apply-message")}else if("F016"==vm.ifmCode){var data={F016:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-risk-message")}else if("F017"==vm.ifmCode){var data={F017:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-amends-message")}}}angular.module("app").controller("WxclaimsImgDetailController",WxclaimsImgDetailController),WxclaimsImgDetailController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","$timeout","$scope"]}(),function(){function WxclaimsImgListController($state,$rootScope,CommonRequest,CONFIG,PolicyService,$timeout,$scope){var vm=this,imgListChoose=[],sessionData=PolicyService.getSessionData();vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData,vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",vm.ifmCode=$state.params.ifmCode,$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"claims-img-list"==toState.name&&vm.getThumbList()}),vm.getThumbList=function(){if($rootScope.isLogin){var param={ifmCode:vm.ifmCode,serialNo:vm.serialNo};CommonRequest.request(param,CONFIG.NEW_THUMB_LIST,function(result){if(result.status&&"1"==result.status){for(var arrList=result.data,i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+vm.ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.thumbList=arrList,0==vm.thumbList.length&&(vm.loadStatus=3)}})}else $timeout(function(){vm.getThumbList()},1e3)},vm.getThumbList(),vm.cancel=function(){vm.chooseFlag=!1,vm.checkedFlag=!1,vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!1},vm.chooseAll=function(){vm.checkedFlag=!0,vm.isAllChoose=!0;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!0},vm.cancelAll=function(){vm.checkedFlag=!1,vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!1},vm.checkFlag=function(checked){if(checked){vm.checkedFlag=!0,vm.isAllChoose=!0;for(var i=0;i<vm.thumbList.length;i++)if(!vm.thumbList[i].checked)return void(vm.isAllChoose=!1)}else{vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)if(1==vm.thumbList[i].checked)return void(vm.checkedFlag=!0);vm.checkedFlag=!1}},vm.queryLastImg=function(){var param={serialNo:vm.serialNo,ifmCodeList:[vm.ifmCode],rsrvFld8:"elife",countNum:"3",cusId:vm.userData.cusId,cusName:vm.userData.customerName};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result.status&&"1"==result.status&&result.data){var params;if("F016"==vm.ifmCode)var arrList=result.data.imgDetail.F016;else if("F017"==vm.ifmCode)var arrList=result.data.imgDetail.F017;for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";vm.minImgList=arrList,"F016"==vm.ifmCode?params={F016:vm.minImgList}:"F017"==vm.ifmCode&&(params={F017:vm.minImgList}),PolicyService.setSessionData({claimsPolicyInfo:params})}})},vm.delChoose=function(){vm.chooseFlag=!1;for(var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[]},i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked?params.imgList.push(vm.thumbList[i].imgName):imgListChoose.push(vm.thumbList[i]);CommonRequest.request(params,CONFIG.NEW_DELETE_CLAIM_THUMB,function(result){result.status&&1==result.status&&(vm.thumbList=imgListChoose,0==vm.thumbList.length&&(vm.loadStatus=3),imgListChoose=[],"F016"==vm.ifmCode&&PolicyService.setSessionData({claimsPolicyInfo:{historyCount:vm.thumbList.length}}),"F017"==vm.ifmCode&&PolicyService.setSessionData({claimsPolicyInfo:{chargeCount:vm.thumbList.length}}),vm.queryLastImg())})},vm.imgDetail=function(imgName){$state.go("wxclaims-img-detail",{ifmCode:vm.ifmCode,imgName:imgName})},vm.imgRefesh=function(imgName,index){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){result.status&&1==result.status&&result.data&&(vm.thumbList[index]=result.data[0])})},vm.claimsImgUpload=function(){if("F000"==vm.ifmCode){var data={F000:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-apply-message")}else if("F016"==vm.ifmCode){var data={historyCount:0,F016:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-risk-message")}else if("F017"==vm.ifmCode){var data={chargeCount:0,F017:{}};PolicyService.setSessionData({claimsPolicyInfo:data}),$state.go("claims-amends-message")}}}angular.module("app").controller("WxclaimsImgListController",WxclaimsImgListController),WxclaimsImgListController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","$timeout","$scope"]}(),function(){function CompensateExamplesController($scope){}angular.module("app").controller("CompensateExamplesController",CompensateExamplesController),CompensateExamplesController.$inject=[]}(),function(){function CompensateFlowpathController($scope,$ionicScrollDelegate,$state,CONFIG,TipService,COMMON,PolicyService,CommonRequest){var vm=this;vm.goHtight,vm.selectGet=!1,vm.headerShow=!1;var sessionData;vm.getSession=function(){sessionData=PolicyService.getSessionData(),vm.userData=sessionData.userData||null,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.claimsPolicyInfo&&vm.claimsPolicyInfo.serialNo?vm.serialNo=vm.claimsPolicyInfo.serialNo:vm.serialNo=""},vm.getSession(),vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data,console.info(vm.prdId),vm.getUsermessage()}),vm.getUsermessage=function(){var params={cretNo:vm.userData.cretNo,customerName:vm.userData.customerName,cretType:vm.userData.cretType,bronTo:vm.userData.birthday,sex:vm.userData.sex};CommonRequest.request(params,CONFIG.QUERY_CLAIM_OTHER_MESSAGE,function(data){if(data.data&&0!==data.status){var val={};val.accAreaProvinceCode=data.data.province||"",val.accAreaDistrictCode=data.data.city||"",val.accAreaDstcCode=data.data.district,val.nation=data.data.nationality||"",val.accDetailAdr=data.data.contactAddress||"",val.rcgnCareer=data.data.occupationCode||"",val.idArriveDate=data.data.cretPeriod.replace(/-/g,"")||"",val.bankAccNo=data.data.transferBankAccount||"",val.bankOpen=data.data.transferBankCode||"",val.bankProvince=data.data.openBankProvCode||"",val.bankCity=data.data.openBankCityCode||"",vm.getbankProvince=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){vm.bankPro=result,vm.bankProName="";for(var i=0;i<vm.bankPro.length;i++)vm.bankPro[i].areaCode==val.bankProvince&&(vm.bankProName=vm.bankPro[i].areaName);vm.getbankCity(vm.bankPro)})},vm.getbankProvince(),vm.getbankCity=function(area){var level=parseInt(area[0].areaLevel)+1,config={url:"../statics/product/areas/"+vm.prdId+"/"+val.bankProvince+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:val.bankProvince,areaLevel:level};CommonRequest.request(paramsl,config,function(result){vm.bankCi=result,vm.bankCiName="";for(var i=0;i<vm.bankCi.length;i++)vm.bankCi[i].areaCode==val.bankCity&&(vm.bankCiName=vm.bankCi[i].areaName);val.accountLocation=vm.bankProName+"-"+vm.bankCiName,val.bankOpenProvince={},val.bankOpenCity={},val.bankOpenProvince.areaCode=val.bankProvince,val.bankOpenProvince.areaName=vm.bankProName,val.bankOpenCity.areaCode=val.bankCity,val.bankOpenCity.areaName=vm.bankCiName,val.bankProvinceName=vm.bankProName||"",val.bankDistrictName=vm.bankCiName||"",val.accountLocation=vm.bankProName?vm.bankProName+"-"+vm.bankCiName:"",PolicyService.setSessionData({claimsPolicyInfo:val})})},vm.getCountry=function(){CommonRequest.request({},CONFIG.GET_COUNTRY_CORECOUNTRY,function(result){if(result&&"1"==result.status)for(var typeList=result.data,i=0;i<typeList.length;i++)if(typeList[i].dictCode==val.nation)val.nationName=typeList[i].dictName;else if("0999"==typeList[i].dictCode)for(var y=0;y<typeList[i].others.length;y++)typeList[i].others[y].countryCode==val.nation&&(val.nationName=typeList[i].others[y].countryName)})},vm.getCountry(),vm.getProvince=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){vm.provinces=result,vm.provinceName="";for(var i=0;i<vm.provinces.length;i++)vm.provinces[i].areaCode==val.accAreaProvinceCode&&(vm.provinceName=vm.provinces[i].areaName);vm.getCityy(vm.provinces)})},vm.getProvince(),vm.getCityy=function(area){var level=parseInt(area[0].areaLevel)+1,config={url:"../statics/product/areas/"+vm.prdId+"/"+val.accAreaProvinceCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:val.accAreaProvinceCode,areaLevel:level};CommonRequest.request(paramsl,config,function(result){vm.cities=result,vm.citiesName="";for(var i=0;i<vm.cities.length;i++)vm.cities[i].areaCode==val.accAreaDistrictCode&&(vm.citiesName=vm.cities[i].areaName);vm.getDistrict(vm.provinces,vm.cities)})},vm.getDistrict=function(){var params={prdId:vm.prdId,parentAreaCode:val.accAreaDistrictCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+val.accAreaProvinceCode+"/"+val.accAreaDistrictCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){vm.district=result,vm.districtName="";for(var i=0;i<vm.district.length;i++)vm.district[i].areaCode==val.accAreaDstcCode&&(vm.districtName=vm.district[i].areaName,vm.zipCode=vm.district[i].zipCode);val.province={},val.city={},val.district={},val.zipCode=vm.zipCode,val.zipCode&&(val.province.areaCode=val.accAreaProvinceCode,val.province.areaName=vm.provinceName,val.accAreaProvinceName=vm.provinceName,val.city.areaCode=val.accAreaDistrictCode,val.city.areaName=vm.citiesName,val.accAreaDistrictName=vm.citiesName,val.district.areaCode=val.accAreaDstcCode,val.district.areaName=vm.districtName,val.accAreaDstcName=vm.districtName,val.touchAddress=vm.provinceName+vm.citiesName+vm.districtName,val.rcgnAddress=val.touchAddress+val.accDetailAdr),PolicyService.setSessionData({claimsPolicyInfo:val})})}}})},vm.scrollSmall=function(){vm.selectGet=!1,$ionicScrollDelegate.$getByHandle("small").scrollTop([!0])},vm.range=function(){vm.selectGet=!0,$scope.conheight=window.innerHeight,window.innerHeight<600?vm.goHtight=400:window.innerHeight>600&&window.innerHeight<700?vm.goHtight=480:vm.goHtight=760,$ionicScrollDelegate.$getByHandle("small").scrollTo(0,vm.goHtight,!0)},vm.showBack=function(){vm.positionTop=$ionicScrollDelegate.$getByHandle("small").getScrollPosition().top,vm.topImg=!0,vm.positionTop<80?(vm.selectGet=!1,$scope.$apply()):(vm.selectGet=!0,$scope.$apply())},vm.goClaimsApply=function(){$state.go("claims-apply-message")},vm.policyHave=function(){CommonRequest.request({},CONFIG.WX_EXISTS_CLAIMS,function(result){"0"==result.data.exists?TipService.showMsg("尊敬的客户：您的保单信息获取失败，个险业务请联系业务员、通过建信e保或我司分支机构柜面申请，团险业务请至我司分支机构进行理赔申请"):"1"==result.data.exists&&$state.go("claims-apply-message")})},$scope.$on("$stateChangeSuccess",function(event,toState,toStateParams,fromState,fromStateParams){"claims-service"==fromState.name&&(vm.headerShow=!0)})}angular.module("app").controller("CompensateFlowpathController",CompensateFlowpathController),CompensateFlowpathController.$inject=["$scope","$ionicScrollDelegate","$state","CONFIG","TipService","COMMON","PolicyService","CommonRequest"]}(),function(){function ClaimsInquiryDetailController($scope,$location,$ionicLoading,$state,$timeout,$stateParams,CommonRequest,CONFIG,PolicyService,$rootScope,$window,$filter){var vm=this;vm.directOpen=!1;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,null==vm.userData&&(vm.directOpen=!0),vm.status=$state.params.status,vm.coreType=$state.params.coreType,vm.caseNo=$state.params.claimsId,vm.interfaceCode=$state.params.interfaceCode,vm.isGroupTipsShow=!1,vm.showDetailInfo=function(){var params={clmNo:vm.caseNo};CommonRequest.request(params,CONFIG.CLAIMS_DETAIL_SERVCIE,function(result){1==result.status&&(vm.rsrvFld5=result.data.claimsInfo[0].RealPay,vm.rsrvFld6=result.data.claimsInfo[0].EndCaseDate,vm.rcgnNm=result.data.claimsInfo[0].CustomerName,vm.accCause=result.data.claimsInfo[0].accidentreason,vm.caseType=result.data.claimsInfo[0].ClmType,vm.startTime=result.data.claimsInfo[0].Accdate,vm.endTime=result.data.claimsInfo[0].RptDate,vm.startTime=vm.startTime.replace(/\//g,"-"),vm.GWfilename=result.data.claimsInfo[0].GWfilename,vm.norgtreason=result.data.claimsInfo[0].norgtreason,vm.rgtconclusion=result.data.claimsInfo[0].rgtconclusion,vm.LPstates=result.data.claimsInfo[0].LPstates,vm.GWstates=result.data.claimsInfo[0].GWstates,vm.riskName=result.data.payDetail.policyName,vm.policyNo=result.data.payDetail.policyNo,vm.makeDate=result.data.payDetail.policyEffectDate,vm.initAccidentreason(vm.accCause),"1"==vm.accCause?vm.accCause="意外":"2"==vm.accCause&&(vm.accCause="疾病"),"1"==vm.LPstates&&""!=vm.rgtconclusion?vm.rgStates=!1:"0"==vm.LPstates&&""!=vm.rgtconclusion&&(vm.rgStates=!0))})},vm.initAccidentreason=function(accidentreason){"1"==accidentreason?vm.claimsReason="意外":"0"==accidentreason&&(vm.claimsReason="疾病")},vm.downLoadClaimNotify=function(val){var url;url="GW"==val?"&fileType=GW":"&fileType=LP",$window.location.href=CONFIG.FILE_SERVICE_ADDRESS+"new/downloadClaimNotify?caseNo="+vm.caseNo+url},vm.showGroupDetail=function(){var params={caseNo:vm.caseNo};CommonRequest.request(params,CONFIG.GROUP_CLAIMS_DETAIL,function(result){1==result.status&&(vm.sumMoney=result.data.sumMoney,vm.rsrvFld5=result.data.rsrvFld5,vm.rsrvFld6=result.data.rsrvFld6,vm.rsrvFld4=result.data.rsrvFld4,vm.fcdesc=result.data.descs,vm.giveType=result.data.giveType,vm.rcgnNm=result.data.rcgnNm,vm.accCause=result.data.accCause,vm.caseType=result.data.caseType,vm.startTime=result.data.accidentDate,vm.endTime=result.data.makeDate,vm.riskName=result.data.risks[0].riskName,vm.policyNo=result.data.policyNo,vm.makeDate=result.data.effectiveTime,vm.receivePath=result.data.receivePath,vm.applyOrigin=result.data.applyOrigin,vm.isGroupTipsShow="1"==vm.status&&"G"==vm.coreType&&vm.sumMoney>3e3&&"01"==vm.applyOrigin)})},vm.showfail=function(){var params={caseNo:vm.caseNo,interfaceCode:vm.interfaceCode};CommonRequest.request(params,CONFIG.CLAIMS_CLAIMAPPLYINFO,function(result){1==result.status&&(vm.rcgnNm=result.data.accName,vm.accCause=result.data.accCause,vm.caseType=result.data.rsrvFld9,vm.startTime=$filter("date")(new Date(result.data.accidentDate),"yyyy-MM-dd"),vm.serialNo=result.data.appNO,vm.isGroupTipsShow="1"==vm.status&&"G"==vm.coreType&&vm.sumMoney>3e3&&"01"==vm.applyOrigin,vm.endTime=result.data.caseApplyDate,vm.errorDesc=result.data.errorDesc,"1"==vm.accCause?vm.accCause="意外":"2"==vm.accCause&&(vm.accCause="疾病"),"A"==vm.caseType?vm.caseType="门诊费用":"B"==vm.caseType&&(vm.caseType="住院费用"))})},vm.url=$location.url(),vm.islogin=function(){$rootScope.isLogin?CommonRequest.request({},{url:"../statics/json/clmconfig.json",method:"GET"},function(result){if(result.clmconfig&&"Y"===result.clmconfig&&"/wechat-claims/claims-inquiry"!==vm.url&&vm.directOpen){vm.userData=$rootScope.userData;var params={rcgnNm:vm.userData.customerName,rcgnGndCd:vm.userData.sex,rcgnCrdtNo:vm.userData.cretNo,rcgnBrthDt:vm.userData.birthday,rcgnCrdtTpCd:vm.userData.cretType};CommonRequest.request(params,CONFIG.QUERY_CLAIM_LIST,function(result){1==result.status&&vm.claimListsResult()})}else vm.getInfo()}):$timeout(function(){vm.islogin()},1e3)},$scope.$on("$stateChangeSuccess",function(event,toState,toStateParams,fromState,fromStateParams){"claims-inquiry-detail"==toState.name&&vm.islogin()}),vm.submitApplyNum=0,vm.claimListsResult=function(){var params={};return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.submitApplyNum>=CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_TIMES?(vm.submitApplyNum=0,$ionicLoading.hide(),void TipService.showMsg("查询结果超时，请重新查询！")):void CommonRequest.request(params,CONFIG.QUERY_CLAIM_LIST_RESULT,function(result){if(result.status&&1==result.status){if(0==result.data.errorCode)return vm.submitApplyNum++,void $timeout(function(){vm.claimListsResult()},CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_DURATION);$ionicLoading.hide(),vm.submitApplyNum=0,vm.getInfo()}else vm.claimListsResult()},!0)},vm.getInfo=function(){"G"==vm.coreType?vm.showGroupDetail():"Z"==vm.coreType?vm.showfail():vm.showDetailInfo(),vm.channelCodeCheck(),vm.infographic=function(){$state.go("claims-record",{caseNo:vm.caseNo,serialNo:vm.serialNoData,coreType:vm.coreType})}},vm.channelCodeCheck=function(){var params={caseNo:vm.caseNo};CommonRequest.request(params,CONFIG.CLAIMS_CHANNELCHECK,function(result){1==result.status&&result.data&&(vm.serialNoData=result.data.serialNo,1==result.data.claimApplyChanneLCheck?vm.claimsChanneL=!0:vm.claimsChanneL=!1)})},vm.goImgUpload=function(){var params={caseNo:vm.caseNo,serialNo:vm.caseNo};CommonRequest.request(params,CONFIG.CLAIMS_REAPPLY,function(result){1==result.status&&(vm.upload=result.data,PolicyService.setSessionData({claimsPolicyInfo:vm.upload}),$state.go("claims-apply-message"))})}}angular.module("app").controller("ClaimsInquiryDetailController",ClaimsInquiryDetailController),ClaimsInquiryDetailController.$inject=["$scope","$location","$ionicLoading","$state","$timeout","$stateParams","CommonRequest","CONFIG","PolicyService","$rootScope","$window","$filter"]}(),function(){function ServiceController($scope,$state,CommonRequest,CONFIG,$rootScope,PolicyService,COMMON,TipService,$window){var vm=this;$scope.height5=document.body.offsetWidth-20,$scope.height1=$scope.height5/4.8,$scope.height2=$scope.height1-35,$scope.imgleft=$scope.height5/2*.2,$scope.spanleft=$scope.imgleft+36+10,$scope.height1<80&&($scope.height1=80,$scope.height2=45),$scope.height3=document.body.offsetWidth/3,$scope.height4=$scope.height3-30;var userData=$rootScope.userData;if(userData){var birthday=userData.birthday,reg=new RegExp("-","g");vm.birthday=birthday.replace(reg,""),vm.sex=userData.sex,vm.sceneType="21",vm.customerName=userData.customerName,vm.cretNo=userData.cretNo,vm.cretType=userData.cretType,"A"==vm.cretType?vm.cretType="0":"I"==vm.cretType?vm.cretType="1":"G"==vm.cretType?vm.cretType="9":"N"==vm.cretType&&(vm.cretType="3")}$scope.toChange=function(changeType){$state.go("policy-service-list",{changeType:changeType})},$scope.goSign=function(){$rootScope.userData?window.location.href=CONFIG.DOMAIN+"/elife-mep-sign/#/sign/list":COMMON.showModal("app/module/user/cert-bind/cert-bind.html")},$scope.bankAuth=function(){console.info("签约信息"),$window.location.href="http://cepp.ccb-life.com.cn:8901/service/sign/form.html"},$scope.goTrans=function(){$rootScope.userData?window.location.href=CONFIG.DOMAIN+"/elife-trans/#/list":COMMON.showModal("app/module/user/cert-bind/cert-bind.html")},$scope.goTrans1=function(){window.location.href=CONFIG.DOMAIN+"/statics/json/guide.html"},$scope.isPolicy=function(){var configPolicy={url:"../statics/json/PolicyAddChange.json",method:"GET"},params={};CommonRequest.request(params,configPolicy,function(result){result&&("Y"==result.isPolicyAddChange?($scope.policyConcat="通讯地址变更",$scope.isCommunication="Y"):($scope.policyConcat="联系方式变更",$scope.isCommunication="N"))})},$scope.isPolicy(),vm.invoiceDownload=function(){if(userData){var params={birthday:vm.birthday,sex:vm.sex,sceneType:vm.sceneType,customerName:vm.customerName,cerId:vm.cretNo,cerType:vm.cretType,type:"01"};PolicyService.invoiceSubmit(params,function(){PolicyService.setSessionData({userData:{policyNo:vm.policyNo,sceneType:vm.sceneType}})})}else $state.go("invoice-download",{id:"2"})},vm.applyPolicy=function(){$state.go("policy-apply")},vm.taxCheckHR=function(){$state.go("tax-extension")},vm.expireSwitch=function(){var params={t:new Date},config={url:CONFIG.SERVICE_ADDRESS+"star/getExpireSwitch",method:"GET"};CommonRequest.request(params,config,function(result){1==result.status&&"Y"==result.data&&(vm.isExpireSwitch=!0)},!0)},vm.expireSwitch()}angular.module("app").controller("ServiceController",ServiceController),ServiceController.$inject=["$scope","$state","CommonRequest","CONFIG","$rootScope","PolicyService","COMMON","TipService","$window"]}(),function(){function PolicyApplyInfoController($state,$rootScope,CommonRequest,CONFIG,COMMON,$scope,PolicyService,TipService,$ionicHistory){var vm=this,sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.allProId=10044,vm.userData?(vm.userData.customerName&&(vm.name=vm.userData.customerName,vm.nameDisabled=!0),vm.phone=vm.userData.phoneNo,vm.applyInfoData=JSON.parse($state.params.applyInfoData),$scope.$on("selectCityName",function(event,result){vm.locateArr=vm.locate.split("-"),vm.ProvinceName=vm.locateArr[0],vm.CityName=vm.locateArr[1],vm.DistrictName=vm.locateArr[2],vm.province=result[0].areaCode,vm.city=result[1].areaCode,vm.area=result[2].areaCode}),void(vm.infoSubmit=function(){var paramsList={cretNo:vm.userData.cretNo,customerName:vm.name,mobile:vm.phone,province:vm.ProvinceName,city:vm.CityName,district:vm.DistrictName,address:vm.address,zipCode:vm.zipCode,provinceCode:vm.province,cityCode:vm.city,districtCode:vm.area,channleCode:"811",insPaperApplyList:vm.applyInfoData};console.info(paramsList),CommonRequest.request(paramsList,CONFIG.SAVE_POLICY_LIST,function(result){1==result.status&&($ionicHistory.clearCache().then(function(){$state.go("tab.service")}),TipService.showMsg("电子保单寄送申请成功"))})})):void $state.go("tab.mall")}angular.module("app").controller("PolicyApplyInfoController",PolicyApplyInfoController),PolicyApplyInfoController.$inject=["$state","$rootScope","CommonRequest","CONFIG","COMMON","$scope","PolicyService","TipService","$ionicHistory"]}(),function(){function onlineReturnListController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$ionicScrollDelegate){var vm=this,sessionData=PolicyService.getSessionData(),userData=sessionData.userData;vm.policyList="",vm.checkedAll=!1,vm.checkArr=[],vm.butDisabled=!1,vm.selsctPolicyData=[],vm.isRequireValidateY=[],vm.isRequireValidateN=[];var u=navigator.userAgent,isAndroid=(navigator.appVersion,u.indexOf("Android")>-1||u.indexOf("Linux")>-1);isAndroid&&!function(){function handleFontSize(){WeixinJSBridge.invoke("setFontSizeCallback",{fontSize:0}),WeixinJSBridge.on("menu:setfont",function(){WeixinJSBridge.invoke("setFontSizeCallback",{fontSize:0})})}"object"==("undefined"==typeof WeixinJSBridge?"undefined":_typeof(WeixinJSBridge))&&"function"==typeof WeixinJSBridge.invoke?handleFontSize():document.addEventListener?document.addEventListener("WeixinJSBridgeReady",handleFontSize,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",handleFontSize),document.attachEvent("onWeixinJSBridgeReady",handleFontSize))}(),vm.onlineVisitSwitch=function(policyNo){CommonRequest.request({},CONFIG.ONLINE_VISIT_SWITCH,function(result){result&&"1"==result.status&&vm.getList()})},vm.onlineVisitSwitch(),vm.getList=function(){if($rootScope.isLogin){sessionData=PolicyService.getSessionData(),userData=sessionData.userData,vm.ID_BANK_TYPES=COMMON.getCommonData().ID_HF_TYPES;for(var i=0;i<vm.ID_BANK_TYPES.length;i++)if(userData.cretType==vm.ID_BANK_TYPES[i].value){vm.cretType=vm.ID_BANK_TYPES[i].label;break}var parse={certTp:vm.cretType,certNo:userData.cretNo,custName:userData.customerName};CommonRequest.request(parse,CONFIG.NEWONLINE_VISIT_POLICYLIST_SERVICE,function(result){if(result&&"1"==result.status){if(result.data&&""!=result.data){vm.policyList=result.data.onlinePolicyQryResList,window.localStorage.setItem("rootPolicyList",JSON.stringify(vm.policyList));for(var i=0;i<vm.policyList.length;i++)vm.policyList[i].checked=!1;1==vm.policyList.length&&(vm.butDisabled=!0,
vm.checkedAll=!0)}$rootScope.$broadcast("scroll.refreshComplete")}})}else $timeout(function(){vm.getList()},1e3)},vm.ckeckBox=function(val,ls){val=!val;for(var i=0;i<ls.length;i++)1==ls[i].checked&&vm.checkArr.push(ls[i].checked);return vm.checkArr.length==vm.policyList.length?vm.checkedAll=!0:vm.checkedAll=!1,0==vm.checkArr.length?void(vm.butDisabled=!1):(vm.checkArr.length>0&&(vm.butDisabled=!0),void(vm.checkArr=[]))},vm.ckeckBoxAll=function(val,ls){for(var i=0;i<vm.policyList.length;i++)1==val?vm.policyList[i].checked=!0:vm.policyList[i].checked=!1;1==val?vm.butDisabled=!0:vm.butDisabled=!1},vm.goValidate=function(state,ls){if(sessionData.onlineReturnData&&PolicyService.removeSessionData("onlineReturnData"),sessionData.onlineReturnWaitData&&PolicyService.removeSessionData("onlineReturnWaitData"),0==state){for(var i=0;i<ls.length;i++)1==ls[i].checked&&vm.selsctPolicyData.push(ls[i]);var alertPopup=$ionicPopup.confirm({template:"尊敬的用户，您还有保单未勾选，是否同时进行回访验证",okText:"是",cancelText:"否",cssClass:"confirm-online"});alertPopup.then(function(res){var param={};param=1==res?{insInfoList:ls}:{insInfoList:vm.selsctPolicyData},CommonRequest.request(param,CONFIG.ONLINE_VALIDATE,function(result){if(result){for(var i=0;i<result.data.length;i++)"Y"==result.data[i].isRequireValidate?vm.isRequireValidateY.push(result.data[i]):"N"==result.data[i].isRequireValidate&&vm.isRequireValidateN.push(result.data[i]);PolicyService.setSessionData({onlineReturnWaitData:vm.isRequireValidateY}),PolicyService.setSessionData({onlineReturnData:vm.isRequireValidateN}),0==vm.isRequireValidateN.length?$state.go("online-return-wait-list"):$state.go("online-return-validate")}})}),vm.selsctPolicy=[],vm.unSelsctPolicy=[]}else{var param={insInfoList:ls};CommonRequest.request(param,CONFIG.ONLINE_VALIDATE,function(result){if(result)for(var i=0;i<result.data.length;i++)"Y"==result.data[i].isRequireValidate?vm.isRequireValidateY.push(result.data[i]):"N"==result.data[i].isRequireValidate&&vm.isRequireValidateN.push(result.data[i]),PolicyService.setSessionData({onlineReturnWaitData:vm.isRequireValidateY}),PolicyService.setSessionData({onlineReturnData:vm.isRequireValidateN}),0==vm.isRequireValidateN.length?$state.go("online-return-wait-list"):$state.go("online-return-validate")})}},$scope.$on("$stateChangeStart",function(event,toState){"online-return-confirm"==toState.name&&(event.preventDefault(),$state.go("tab.mall"))})}angular.module("app").controller("onlineReturnListController",onlineReturnListController),onlineReturnListController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$ionicScrollDelegate"]}(),function(){function PolicyApplyController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$ionicScrollDelegate){var vm=this,sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.checked=[],vm.userData?(vm.initQueryPolicyList=function(){var params={cusId:vm.userData.cusId,role:"1",contType:"0",queryType:"0"};CommonRequest.request(params,CONFIG.QUERY_POLICY_APPLY,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)||(data=[]),vm.policyList=data}$rootScope.$broadcast("scroll.refreshComplete")})},vm.initQueryPolicyList(),vm.selectAll=function(){vm.select_all?(vm.checked=[],angular.forEach(vm.policyList,function(i){i.checked=!0,vm.checked.push({policyNo:i.policyNo,prdCode:i.mainClassCode,prdName:i.mainClassName,orgCode:i.managerCom})})):(vm.allChecked=!1,angular.forEach(vm.policyList,function(i){i.checked=!1,vm.checked=[]})),console.info(vm.checked)},vm.selectOne=function(){vm.checked=[],angular.forEach(vm.policyList,function(i){var index=vm.checked.indexOf(i.ContNo);i.checked&&-1===index&&vm.checked.push({policyNo:i.policyNo,prdCode:i.mainClassCode,prdName:i.mainClassName,orgCode:i.managerCom})}),vm.policyList.length===vm.checked.length?vm.select_all=!0:vm.select_all=!1,console.info(vm.checked)},void(vm.applyInfo=function(){""==vm.checked?TipService.showMsg("请选择保单"):$state.go("policy-apply-info",{applyInfoData:JSON.stringify(vm.checked)})})):void $state.go("tab.mall")}angular.module("app").controller("PolicyApplyController",PolicyApplyController),PolicyApplyController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$ionicScrollDelegate"]}(),function(){function ProgressChangeController($state,CommonRequest,CONFIG,$rootScope,$timeout){var vm=this;vm.changeState="0",vm.refreshTime=60,vm.changeLists=function(){return vm.refreshTipForShow?void $rootScope.$broadcast("scroll.refreshComplete"):void($rootScope.isLogin?CommonRequest.request({},CONFIG.POLIC_CHANGE_QUERY_SERVCIE,function(result){1==result.status&&(vm.changeList=result.data,vm.changeStatus(vm.changeState),vm.refreshTip())}):$timeout(function(){vm.changeLists()},1e3))},vm.changeLists(),vm.refreshTip=function(){vm.refreshTime--,vm.refreshTime>0?(vm.refreshTipForShow=!0,$timeout(function(){vm.refreshTip()},1e3)):(vm.refreshTime=60,vm.refreshTipForShow=!1)},vm.changeStatus=function(n){if(vm.changeState=n,vm.showList=[],"0"==vm.changeState)for(var i=0;i<vm.changeList.length;i++)"4"!=vm.changeList[i].EdorState&&"6"!=vm.changeList[i].EdorState&&"7"!=vm.changeList[i].EdorState&&"3"!=vm.changeList[i].EdorState||vm.showList.push(vm.changeList[i]);else if("1"==vm.changeState)for(var j=0;j<vm.changeList.length;j++)"1"!=vm.changeList[j].EdorState&&"2"!=vm.changeList[j].EdorState&&"5"!=vm.changeList[j].EdorState||vm.showList.push(vm.changeList[j]);$rootScope.$broadcast("scroll.refreshComplete")},vm.showDetail=function(ls){$state.go("change-info",{EdorName:ls.EdorName,EdorState:ls.EdorState,RiskName:ls.RiskName,EdorAppDate:ls.EdorAppDate,AppRoveIdea:ls.AppRoveIdea,Salechnl:ls.Salechnl,ContNo:ls.ContNo})}}angular.module("app").controller("ProgressChangeController",ProgressChangeController),ProgressChangeController.$inject=["$state","CommonRequest","CONFIG","$rootScope","$timeout"]}(),function(){function SelfServiceListController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,$location,LoginService,PolicyService,$state){var vm=this,loginParams=$location.search().login_params,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData;var urlAbs=$location.absUrl();vm.getLoginData=function(callback){if(!vm.userData&&loginParams){var params={login_parmas:loginParams,secretKey:urlAbs};CommonRequest.request(params,CONFIG.NEW_LOGIN_OR_REGIST,function(result){1==result.status&&angular.isFunction(callback)&&callback(result)})}},vm.getLoginData(function(result){LoginService.storeUserData(result),sessionStorage.setItem("elife-loginStatus",2);var data={plchdAppFlag:"Y"};PolicyService.setSessionData({userData:data})}),vm.goState=function(state){$rootScope.isLogin?$state.go(state):TipService.showMsg("登录失败,请退出重试")}}angular.module("app").controller("SelfServiceListController",SelfServiceListController),SelfServiceListController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","VALIDATION","$location","LoginService","PolicyService","$state"]}(),function(){function TaxExtensionController(CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,PolicyService,$state,$scope,$filter,$location,$ionicPopup,$timeout){var vm=this,sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.userData?(vm.taxPolicyInfo=function(){var param={insName:vm.userData.customerName,insCerType:vm.userData.cretType,insCerNo:vm.userData.cretNo};CommonRequest.request(param,CONFIG.TAX_GROUPHR,function(result){if(result.status&&"1"==result.status){if(vm.taxPolicyData=result.data,""==vm.taxPolicyData||void 0==vm.taxPolicyData)return void(vm.taxNoData=!0);vm.taxHasData=!0,vm.taxPolicyList=JSON.parse(result.data.businessInfo),vm.taxDataSet=vm.taxPolicyList.dataSet,0==vm.taxDataSet.policy.gender?vm.taxGender="男":vm.taxGender="女",1==vm.taxDataSet.policy.payintv?vm.taxPayintv="月缴":12==vm.taxDataSet.policy.payintv&&(vm.taxPayintv="年缴"),1==vm.taxDataSet.policy.firstpaytype?vm.dppm="单位代缴":2==vm.taxDataSet.policy.firstpaytype&&(vm.dppm="个人缴费"),1==vm.taxDataSet.policy.nextpaytype?vm.repm="单位代缴":2==vm.taxDataSet.policy.nextpaytype&&(vm.repm="个人缴费");for(var i=0;i<vm.taxDataSet.product.risk.length;i++)1==vm.taxDataSet.product.risk[0].getDutyKind?vm.taxGetDutyKind="保证返还账户价值":2==vm.taxDataSet.product.risk[0].getDutyKind?vm.taxGetDutyKind="固定期限15年":3==vm.taxDataSet.product.risk[0].getDutyKind&&(vm.taxGetDutyKind="固定期限20年"),1==vm.taxDataSet.product.risk[0].getintv?vm.taxGetintv="月领":12==vm.taxDataSet.product.risk[0].getintv&&(vm.taxGetintv="年领")}else if(0==result.status){vm.taxNoData=!0;$ionicPopup.confirm({title:'<img src="img/common/activation_error.png">',template:"请在“个人信息-客户信息采集”里提供身份证信息",cssClass:"distingguishPopupSuccess taxPopup",buttons:[{text:"我知道了",type:"button-positive",onTap:function(){$state.go("tab.user")}}]})}})},vm.taxPolicyInfo(),vm.materialsInit=function(){var config={url:"../statics/json/HrMaterialList.json",method:"GET"};CommonRequest.request({},config,function(result){result&&"1"==result.status&&(vm.materials=result.data)})},vm.materialsInit(),vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.materialDetail=function(ma){1==ma?(vm.showStatus=ma,vm.materialList()):2==ma&&(vm.showStatus=ma,vm.materialList())},void(vm.next=function(){$state.go("policy-promp-book")})):void $state.go("tab.mall")}angular.module("app").controller("TaxExtensionController",TaxExtensionController),TaxExtensionController.$inject=["CommonRequest","CONFIG","TipService","$rootScope","VALIDATION","PolicyService","$state","$scope","$filter","$location","$ionicPopup","$timeout"]}(),function(){function CompensateGuideController($scope){}angular.module("app").controller("CompensateGuideController",CompensateGuideController),CompensateGuideController.$inject=[]}(),function(){function CompensateQueryController($scope,$state,$rootScope,CommonRequest,CONFIG,$timeout,PolicyService){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.tab="2",vm.getList=function(tab){$rootScope.isLogin?"1"==tab?(vm.tab="1",vm.claimLists()):"2"==tab&&(vm.tab="2",vm.groupClaimsLists()):$timeout(function(){vm.getList(vm.tab)},1e3)},vm.goQueryInfo=function(id,status,tab){"2"!=status&&$state.go("claims-detail",{claimsId:id,claimStatus:status,claimsTab:tab})},vm.claimsList=[],vm.claimLists=function(){if($rootScope.isLogin){var params={cusId:$rootScope.userData.cusId};CommonRequest.request(params,CONFIG.QUERY_SETTLE_DETAIL_SERVCIE,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)||(data=[]),data.sort(vm.personalCompare),vm.claimsList=data}$rootScope.$broadcast("scroll.refreshComplete")})}else $timeout(function(){vm.claimLists()},1e3)},vm.groupClaimsList=[],vm.riskNames=[],vm.groupClaimsLists=function(){if($rootScope.isLogin){CommonRequest.request({},CONFIG.GROUP_CLAIMS_LISTS,function(result){if(1==result.status){vm.groupClaimsList=[];for(var data=result.data,k=0;k<data.lLCaseList.length;k++)vm.groupClaimsList.push(data.lLCaseList[k]);vm.groupClaimsList.sort(vm.groupCompare)}$rootScope.$broadcast("scroll.refreshComplete")})}else $timeout(function(){vm.groupClaimsLists()},1e3)},vm.groupCompare=function(a,b){if(a.caseState===b.caseState){var date1=new Date(a.makeDate).getTime(),date2=new Date(b.makeDate).getTime();return date2-date1}return b.caseState-a.caseState},vm.personalCompare=function(a,b){if(a.mainStatus===b.mainStatus){var date1=new Date(a.rptDate).getTime(),date2=new Date(b.rptDate).getTime();return date2-date1}return b.mainStatus-a.mainStatus},$scope.$on("$stateChangeSuccess",function(event,toState,toStateParams,fromState,fromStateParams){"claims-page-success"==fromState.name&&(event.preventDefault(),$timeout(function(){location.reload()},200))}),$scope.$on("$ionicView.afterEnter",function(){vm.getList(vm.tab)}),$scope.$on("$stateChangeStart",function(event,toState,toStateParams,fromState,fromStateParams){vm.plchdAppFlag||"claims-page-success"!=toState.name||(event.preventDefault(),$state.go("tab.user"))})}angular.module("app").controller("CompensateQueryController",CompensateQueryController),CompensateQueryController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","$timeout","PolicyService"]}(),function(){function ClaimsAccountInfoController($state,$rootScope,CommonRequest,CONFIG,COMMON,$scope,PolicyService,TipService,$ionicScrollDelegate,$timeout){var vm=this,sessionData=PolicyService.getSessionData();return vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData,vm.serialNo=vm.claimsPolicyInfo.serialNo,vm.claimsPolicyInfo&&vm.userData?(vm.init=function(){vm.accountBanks={},vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?vm.policyTypes=$rootScope.COMMON_DATA.CLAIMSPOLICYTYPES:vm.getCommonData()},200)},vm.getCommonData(),vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data}),vm.accountName=vm.claimsPolicyInfo.name,vm.accountName&&(vm.nameDisabled=!0)},vm.init(),$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),vm.getSerialNo=function(){if(!vm.serialNo&&vm.userData&&vm.userData.cusId){var serialNoParam={custId:vm.userData.cusId};PolicyService.createClaimsAppNo(serialNoParam,function(result){result&&1==result.status&&result.data&&""!=result.data&&(vm.serialNo=result.data)})}},vm.goImgUpload=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);var param={bankProvinceCode:vm.province.areaCode,bankProvinceName:vm.province.areaName,bankDistrictCode:vm.city.areaCode,bankDistrictName:vm.city.areaName,accName:vm.accountName,bankOpen:vm.accountBank,bankAccNo:vm.bankAccount,serialNo:vm.serialNo,channelCode:CONFIG.SALE_CHANNEL};param=angular.extend(param,vm.claimsPolicyInfo),sessionData=PolicyService.getSessionData(),PolicyService.control({state:"claims-account-info",control:"data",data:param}),PolicyService.control({state:"claims-account-info",control:"process"})},vm.getBankInfo=function(){CommonRequest.request({},CONFIG.GET_BANK_INFO,function(result){result&&result.status&&"1"==result.status&&result.data?vm.accountBanks=result.data:TipService.showMsg("获取开户银行失败")})},vm.getBankInfo(),void vm.getSerialNo()):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))}angular.module("app").controller("ClaimsAccountInfoController",ClaimsAccountInfoController),ClaimsAccountInfoController.$inject=["$state","$rootScope","CommonRequest","CONFIG","COMMON","$scope","PolicyService","TipService","$ionicScrollDelegate","$timeout"]}(),function(){function ClaimsApplyPolicyController($state,$rootScope,COMMON,$scope,TipService,PolicyService,$filter,$timeout,$ionicScrollDelegate,VALIDATION,CONFIG){var vm=this;document.body.scrollTop;vm.getSession=function(){var sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData||{},vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData?void(vm.plchdAppFlag=vm.userData.plchdAppFlag):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))},vm.getSession(),vm.init=function(){vm.certType="A",vm.claimsPolicyInfo&&vm.claimsPolicyInfo.prdId?vm.prdId=vm.claimsPolicyInfo.prdId:PolicyService.getAllAreaInfo(function(result){vm.prdId=result.data}),vm.isAmount=!1,vm.maxDate=new Date,vm.name=vm.userData.customerName,vm.certType=vm.userData.cretType,vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certNo=vm.userData.cretNo,vm.certExpireType=!1,vm.sex=vm.userData.sex,vm.sexShow="A"!=vm.certType,vm.phone=vm.userData.phoneNo,0==vm.phone.indexOf("100")?vm.phoneDisabled=!1:vm.phoneDisabled=!0,vm.birthday=new Date(vm.userData.birthday),vm.birthdayShow="A"!=vm.certType,vm.area="",vm.location="",vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.policyTypes=$rootScope.COMMON_DATA.CLAIMSPOLICYTYPES,vm.certTypeName=$filter("cerFilter")(vm.certType)):vm.getCommonData()},200)},vm.getCommonData()},$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),vm.watch=function(){$scope.$watch("claimsApplyPolicy.certType",function(newValue){newValue&&(vm.userData&&vm.userData.cretNo||(vm.certNo=""))}),$scope.$watch("claimsApplyPolicy.certNo",function(newValue){if(newValue&&vm.certType&&"A"==vm.certType){if(!VALIDATION.idCheck(newValue))return;vm.sex=VALIDATION.getSex(newValue)+"",vm.birthday=new Date(VALIDATION.getBirthday(newValue))}}),$scope.$watch("claimsApplyPolicy.certExpireType",function(newValue){1==newValue?vm.certExpireDate="2099-12-31":vm.certExpireDate=""}),$scope.$watch("claimsApplyPolicy.phone",function(newValue){0==newValue.indexOf("100")?vm.phoneVirCheck=!0:vm.phoneVirCheck=!1}),$scope.$watch("claimsApplyPolicy.area",function(newValue){newValue&&((vm.area+vm.location).length-2>60?vm.addrLenError=!0:vm.addrLenError=!1)}),$scope.$watch("claimsApplyPolicy.location",function(newValue){newValue&&((vm.area+vm.location).length-2>60?vm.addrLenError=!0:vm.addrLenError=!1)})},vm.goAccountInfo=function(invalid){if(invalid||vm.phoneVirCheck||vm.addrLenError)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);var data={name:vm.name,idType:vm.certType,idNo:vm.certNo,sex:vm.sex,mobile:vm.phone,birthday:$filter("date")(vm.birthday,"yyyy-MM-dd"),accCause:vm.healthTag,caseType:vm.policyType,preClaimMoney:0,accidentDate:$filter("date")(vm.policyDate,"yyyy-MM-dd"),rsrvFld2:vm.occupation,rsrvFld3:vm.province.areaName+vm.city.areaName+vm.district.areaName+vm.location,rsrvFld4:$filter("date")(vm.certExpireDate,"yyyyMMdd"),rsrvFld8:vm.plchdAppFlag?"APP":"",accAreaProvinceCode:vm.province.areaCode,accAreaDistrictCode:vm.city.areaCode,accAreaDstcCode:vm.district.areaCode};PolicyService.control({state:"claims-apply-policy",control:"data",data:data}),PolicyService.control({state:"claims-apply-policy",control:"process"})},vm.init(),vm.watch(),vm.intputFocus=function(id){var screenHeight=$(window).height();vm.isFocus=!0;var elementHeight=$("#"+id).offset().top-.5*screenHeight;elementHeight=0>elementHeight?0:elementHeight,$("#divSpace").css("height",elementHeight+"px"),screenHeight=0>elementHeight?screenHeight+elementHeight:screenHeight,$ionicScrollDelegate.scrollTo(0,screenHeight,[!0])},vm.inputBlur=function(id){var screenHeight=$(window).height();vm.isFocus=!1,$("#divSpace").css("height","0px"),$ionicScrollDelegate.scrollTo(0,screenHeight,[!0])},vm.moneyBlur=function(value){if(value&&""!=value){var moneyArray=value.split(".");return 1==moneyArray.length?void(vm.amount=vm.amount+".00"):2==moneyArray.length&&1==moneyArray[1].length?void(vm.amount=vm.amount+"0"):void 0}}}angular.module("app").controller("ClaimsApplyPolicyController",ClaimsApplyPolicyController),ClaimsApplyPolicyController.$inject=["$state","$rootScope","COMMON","$scope","TipService","PolicyService","$filter","$timeout","$ionicScrollDelegate","VALIDATION","CONFIG"]}(),function(){function ClaimsDigitalSignController($state,$rootScope,CommonRequest,CONFIG,PolicyService,TipService,$timeout){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=windowsHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=9,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/service/water_mark_claims.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight)}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0)}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL(),param={ifmCode:"F019",imgBase64Bytes:signBase64||"",serialNo:vm.claimsPolicyInfo.serialNo,suffix:"png"};CommonRequest.request(param,CONFIG.UPLOAD_BY_BASE64,function(result){"1"==result.status&&PolicyService.submitClaimsApply()})}.bind(this),!1)}var vm=this,sessionData=PolicyService.getSessionData();vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData,vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=44);var windowsHeight=parseInt(.96*$(window).height())-80-vm.headHeight;return vm.claimsPolicyInfo&&vm.userData?(document.body.addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.body.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),vm.signStart=!1,new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:2,color:"black",background:"#ffffff"}),vm.goNextPage=function(data){PolicyService.control({state:"claims-account-info",control:"data",data:data}),$state.go("claims-page-success")},void(vm.submitToCore=function(){var params={name:vm.claimsPolicyInfo.name,sex:vm.claimsPolicyInfo.sex,idNo:vm.claimsPolicyInfo.idNo,birthday:vm.claimsPolicyInfo.birthday,idType:vm.claimsPolicyInfo.idType,mobile:vm.claimsPolicyInfo.mobile,accCause:vm.claimsPolicyInfo.accCause,caseType:vm.claimsPolicyInfo.caseType,preClaimMoney:vm.claimsPolicyInfo.preClaimMoney,accidentDate:vm.claimsPolicyInfo.accidentDate,accAreaProvinceCode:vm.claimsPolicyInfo.accAreaProvinceCode,accAreaDistrictCode:vm.claimsPolicyInfo.accAreaDistrictCode,accAreaDstcCode:vm.claimsPolicyInfo.accAreaDstcCode,accName:vm.claimsPolicyInfo.accName,bankOpen:vm.claimsPolicyInfo.bankOpen,bankAccNo:vm.claimsPolicyInfo.bankAccNo,serialNo:vm.claimsPolicyInfo.serialNo,bankProvinceCode:vm.claimsPolicyInfo.bankProvinceCode,bankDistrictCode:vm.claimsPolicyInfo.bankDistrictCode,rsrvFld2:vm.claimsPolicyInfo.rsrvFld2,rsrvFld3:vm.claimsPolicyInfo.rsrvFld3,rsrvFld4:vm.claimsPolicyInfo.rsrvFld4,rsrvFld8:vm.claimsPolicyInfo.rsrvFld8};PolicyService.submitClaimsApply(params,function(result){"1"==result.status&&vm.goNextPage(result.data)})})):(TipService.showMsg($rootScope.TIPS.SYSTEM.INVALID_OPERATION),void $state.go("tab.mall"))}angular.module("app").controller("ClaimsDigitalSignController",ClaimsDigitalSignController),ClaimsDigitalSignController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","TipService","$timeout"]}(),function(){function ClaimsImgListController($state,$rootScope,CommonRequest,CONFIG,PolicyService,$timeout,$scope){var vm=this,imgListChoose=[],sessionData=PolicyService.getSessionData();vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",vm.ifmCode=$state.params.ifmCode,$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"claims-img-list"==toState.name&&vm.getThumbList()}),vm.chooseFlag=!1,vm.getThumbList=function(){if($rootScope.isLogin){var param={ifmCode:vm.ifmCode,serialNo:vm.serialNo};CommonRequest.request(param,CONFIG.NEW_THUMB_LIST,function(result){result.status&&"1"==result.status&&(vm.thumbList=result.data,0==vm.thumbList.length&&(vm.loadStatus=3))})}else $timeout(function(){vm.getThumbList()},1e3)},vm.cancel=function(){vm.chooseFlag=!1,vm.checkedFlag=!1,vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!1},vm.chooseAll=function(){vm.checkedFlag=!0,vm.isAllChoose=!0;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!0},vm.cancelAll=function(){vm.checkedFlag=!1,vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked=!1},vm.checkFlag=function(checked){if(checked){vm.checkedFlag=!0,vm.isAllChoose=!0;for(var i=0;i<vm.thumbList.length;i++)if(!vm.thumbList[i].checked)return void(vm.isAllChoose=!1)}else{vm.isAllChoose=!1;for(var i=0;i<vm.thumbList.length;i++)if(1==vm.thumbList[i].checked)return void(vm.checkedFlag=!0);vm.checkedFlag=!1}},vm.delChoose=function(){vm.chooseFlag=!1;for(var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[]},i=0;i<vm.thumbList.length;i++)vm.thumbList[i].checked?params.imgList.push(vm.thumbList[i].imgName):imgListChoose.push(vm.thumbList[i]);CommonRequest.request(params,CONFIG.NEW_DELETE_CLAIM_THUMB,function(result){result.status&&1==result.status&&(vm.thumbList=imgListChoose,0==vm.thumbList.length&&(vm.loadStatus=3),imgListChoose=[],"F000"==vm.ifmCode&&PolicyService.setSessionData({claimsPolicyInfo:{idCount:vm.thumbList.length}}),"F016"==vm.ifmCode&&PolicyService.setSessionData({claimsPolicyInfo:{historyCount:vm.thumbList.length}}),"F017"==vm.ifmCode&&PolicyService.setSessionData({claimsPolicyInfo:{chargeCount:vm.thumbList.length}}))})},vm.imgDetail=function(imgName){$state.go("claims-img-detail",{ifmCode:vm.ifmCode,imgName:imgName})},vm.imgRefesh=function(imgName,index){var params={serialNo:vm.serialNo,ifmCode:vm.ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){result.status&&1==result.status&&result.data&&(vm.thumbList[index]=result.data[0])})}}angular.module("app").controller("ClaimsImgListController",ClaimsImgListController),ClaimsImgListController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","$timeout","$scope"]}(),function(){function ClaimsImgUploadController($state,$rootScope,CommonRequest,CONFIG,TipService,PolicyService,$timeout,$window,$scope,$ionicLoading){var vm=this;if(vm.init=function(){var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.plchdAppFlag=vm.userData.plchdAppFlag,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.serialNo=vm.claimsPolicyInfo?vm.claimsPolicyInfo.serialNo:"",vm.idCount=vm.claimsPolicyInfo.idCount||0,vm.historyCount=vm.claimsPolicyInfo.historyCount||0,vm.chargeCount=vm.claimsPolicyInfo.chargeCount||0,vm.idCountImg=vm.claimsPolicyInfo.idCountImg||[],vm.historyCountImg=vm.claimsPolicyInfo.historyCountImg||[],vm.chargeCountImg=vm.claimsPolicyInfo.chargeCountImg||[]},vm.init(),!vm.claimsPolicyInfo||!vm.userData)return void $state.go("tab.mall");var uploadInfomation;vm.plchdAppFlag?(vm.maxSize="10MB",vm.delayTime=3500,uploadInfomation="<p class='tl'>1、您所上传的门（急）诊、住院病历、清单/处方、医疗票据原件须可清晰辨认。</p><p class='tl'>2. 您所上传的门（急）诊、住院病历、清单/处方须与上传的医疗票据原件出具日期相对应，若我司发现有不对应的，我司有权要求您提供缺少的相关资料或对不对应部分的费用不予认定。</p>"):(vm.maxSize="10MB",vm.delayTime=1e3,uploadInfomation="<p class='tl'>1、您所上传的身份证件正反面、门（急）诊、住院病历、清单/处方、医疗票据原件须可清晰辨认。</p><p class='tl'>2. 您所上传的身份证件正反面必须在有效期间内。</p><p class='tl'>3.您所上传的门（急）诊、住院病历、清单/处方须与上传的医疗票据原件出具日期相对应，若我司发现有不对应的，我司有权要求您提供缺少的相关资料或对不对应部分的费用不予认定。</p>"),vm.uploadInfo=function(){TipService.showMsg(uploadInfomation,"claims")},vm.uploadInfo(),$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){if("claims-img-upload"==toState.name&&("claims-img-list"==fromState.name,!0)){event.preventDefault(),vm.init();var ifmCodeList;fromParams.ifmCode&&(ifmCodeList=[fromParams.ifmCode],vm.queryLastImg(ifmCodeList,fromParams.ifmCode))}}),vm.queryLastImg=function(ifmCodeList,ifmCode){var param={serialNo:vm.serialNo,ifmCodeList:ifmCodeList};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTTWOIMG,function(result){if(result.status&&"1"==result.status&&result.data){var params;"F000"==ifmCode?(vm.idCountImg=result.data.F000||[],params={idCountImg:vm.idCountImg}):"F016"==ifmCode?(vm.historyCountImg=result.data.F016||[],params={historyCountImg:vm.historyCountImg}):"F017"==ifmCode&&(vm.chargeCountImg=result.data.F017||[],params={chargeCountImg:vm.chargeCountImg}),PolicyService.setSessionData({claimsPolicyInfo:params})}})},vm.checkPhoto=function(data,type){return"F000"==type&&vm.idCount>=2?void TipService.showMsg("最多支持上传2张照片"):"F016"==type&&vm.historyCount>=20?void TipService.showMsg("最多支持上传20张照片"):"F017"==type&&vm.chargeCount>=20?void TipService.showMsg("最多支持上传20张照片"):(wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["chooseImage","getLocalImgData"]}),wx.ready(function(){wx.chooseImage({count:1,sizeType:["compressed","original"],sourceType:["album","camera"],success:function(res){vm.localId=res.localIds[0],wx.getLocalImgData({localId:vm.localId,success:function(res){"iPhone"==vm.platForm?vm.localIds=res.localData:"android"==vm.platForm&&(vm.localIds="data:image/png;base64,"+res.localData),vm.upload(type)}})}})}),void wx.error(function(){alert("wx-error")}))},vm.upload=function(type){var param={imgBase64Bytes:vm.localIds||"",serialNo:vm.serialNo,suffix:"png",thumbWidth:"80",thumbHeight:"80",ifmCode:type,rsrvFld8:vm.plchdAppFlag?"APP":""};CommonRequest.request(param,CONFIG.UPLOAD_BY_BASE64,function(result){result&&result.status&&"1"==result.status?result.data&&(vm.localIds="",document.getElementById(type).src="",vm.getUploadType(type,result.data)):$ionicLoading.hide()},!0)},vm.getUploadType=function(type,data){var param;"F000"==type?(vm.idCount++,vm.idCountImg.unshift(data),param={idCount:vm.idCount,idCountImg:vm.idCountImg}):"F016"==type?(vm.historyCount++,vm.historyCountImg.length>=2&&vm.historyCountImg.pop(),vm.historyCountImg.unshift(data),param={historyCount:vm.historyCount,historyCountImg:vm.historyCountImg}):"F017"==type&&(vm.chargeCount++,vm.chargeCountImg.length>=2&&vm.chargeCountImg.pop(),vm.chargeCountImg.unshift(data),param={chargeCount:vm.chargeCount,chargeCountImg:vm.chargeCountImg}),PolicyService.setSessionData({claimsPolicyInfo:param}),$ionicLoading.hide()},vm.getImgDetail=function(type,imgName){$state.go("claims-img-detail",{ifmCode:type,imgName:imgName})},vm.imgRefesh=function(imgName,ifmCode,index){var params={serialNo:vm.serialNo,ifmCode:ifmCode,imgList:[imgName]};CommonRequest.request(params,CONFIG.NEW_QUERY_SPECIFIED_THUMBIMG,function(result){if(result.status&&1==result.status&&result.data){var param;"F000"==ifmCode&&(vm.idCountImg[index]=result.data[0],param={idCountImg:vm.idCountImg}),"F016"==ifmCode&&(vm.historyCountImg[index]=result.data[0],param={historyCountImg:vm.historyCountImg}),"F016"==ifmCode&&(vm.chargeCountImg[index]=result.data[0],param={chargeCountImg:vm.chargeCountImg}),PolicyService.setSessionData({claimsPolicyInfo:param})}})},vm.getSignature=function(){var pageURL=window.location.href.split("#")[0],pageInfo={currentUrl:pageURL};CommonRequest.request(pageInfo,CONFIG.SIGNATURE,function(result){result&&1==result.status&&(vm.signData=result.data)});var ua=navigator.userAgent.toLowerCase();-1!=ua.indexOf("android")?vm.platForm="android":-1!=ua.indexOf("iphone")&&(vm.platForm="iPhone")},vm.appCheckPhoto=function($files,type){return"F000"==type&&vm.idCount>=2?void TipService.showMsg("最多支持上传2张照片"):"F016"==type&&vm.historyCount>=20?void TipService.showMsg("最多支持上传20张照片"):"F017"==type&&vm.chargeCount>=20?void TipService.showMsg("最多支持上传20张照片"):void(0!=$files.length&&vm.getSrc(type))},vm.getSrc=function(type){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),$timeout(function(){document.getElementById(type).src?(vm.localIds=document.getElementById(type).src,vm.upload(type)):vm.getSrc(type)},vm.delayTime)},vm.claimsDocInfo=function(){CommonRequest.request({},CONFIG.CLAIMS_DOC_INFO,function(result){
result&&1==result.status&&(vm.docsList=result.data,vm.docsListSize=vm.docsList.length)})},vm.claimsDocInfo(),vm.openPDF=function(url){var url=url.replace("..",CONFIG.DOMAIN),savePath=PJF.client.getAppTempFolder().result+"/"+(new Date).getTime()+".pdf";PJF.client.fileDownload(savePath,url,function(data){PJF.client.openPDFMob(savePath,function(){})},null,null)},vm.goClaimsSign=function(){return!vm.plchdAppFlag&&vm.idCount<2?void TipService.showMsg("请上传身份证正反面"):vm.historyCount<1?void TipService.showMsg("请上传病历（含封面页）、费用清单/处方等其他资料"):vm.chargeCount<1?void TipService.showMsg("请上传医疗费用原始凭证"):vm.agree?void(vm.plchdAppFlag?PolicyService.submitClaimsApply():PolicyService.control({state:"claims-img-upload",control:"process"})):void TipService.showMsg("请阅读并同意相关信息")}}angular.module("app").controller("ClaimsImgUploadController",ClaimsImgUploadController),ClaimsImgUploadController.$inject=["$state","$rootScope","CommonRequest","CONFIG","TipService","PolicyService","$timeout","$window","$scope","$ionicLoading"]}(),function(){function ClaimsInstructionController($state,$rootScope,CommonRequest,CONFIG,PolicyService){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.plchdAppFlag=vm.userData.plchdAppFlag,vm.goClaimsApply=function(){$state.go("claims-apply-policy")}}angular.module("app").controller("ClaimsInstructionController",ClaimsInstructionController),ClaimsInstructionController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService"]}(),function(){function ClaimsPageSuccessController($scope,$state,$rootScope,CommonRequest,CONFIG,PolicyService,TipService){var vm=this;vm.stateStatus=!1;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.receiveFlag=vm.claimsPolicyInfo.receiveFlag,vm.receiveFlag&&"1"==vm.receiveFlag&&(vm.caseNo=vm.claimsPolicyInfo.caseNo,vm.claimType=!!(vm.claimsPolicyInfo&&vm.claimsPolicyInfo.preClaimMoney&&vm.claimsPolicyInfo.preClaimMoney<=3e3),vm.receivePath=vm.claimsPolicyInfo.receivePath),vm.goMainPage=function(){$state.go("claims-query")},$rootScope.$on("$stateChangeStart",function(event,toState,toParams,fromState,fromParams){vm.stateStatus||"claims-page-success"==fromState.name&&(event.preventDefault(),vm.stateStatus=!0,vm.goMainPage())})}angular.module("app").controller("ClaimsPageSuccessController",ClaimsPageSuccessController),ClaimsPageSuccessController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","PolicyService","TipService"]}(),function(){function ClaimsUploadInfoController($state,$rootScope,CommonRequest,CONFIG,PolicyService,TipService){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&vm.userData.plchdAppFlag?vm.infoImg="img/service/claims_upload_info_app.jpg":vm.infoImg="img/service/claims_upload_info.jpg"}angular.module("app").controller("ClaimsUploadInfoController",ClaimsUploadInfoController),ClaimsUploadInfoController.$inject=["$state","$rootScope","CommonRequest","CONFIG","PolicyService","TipService"]}(),function(){function onlineReturnConfirmController($state,$rootScope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$filter,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData(),onlineReturnData=sessionData.onlineReturnQuestion,userData=sessionData.userData;onlineReturnData&&userData||$state.go("tab.mall"),vm.policyInfo=onlineReturnData.policyInfo,vm.localAnswer=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo)),vm.signBase64=onlineReturnData.signBase64,vm.questionList=onlineReturnData.questionList,vm.visitTime=$filter("date")(new Date,"yyyy-MM-dd"),vm.answerSupplementList=[];for(var s=1;s<=vm.questionList.length;s++)vm.answerDate={},vm.answerDate.answer="0"==vm.localAnswer[s-1]?"否":"是",vm.answerDate.question=s+"."+vm.questionList[s-1].content,vm.answerSupplementList.push(vm.answerDate);vm.onlineVisitSubmit=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),html2canvas(document.getElementById("canvasImg")).then(function(canvas){vm.contentCanvas=canvas.toDataURL();var paramBase64={bytes:vm.contentCanvas,custId:userData.cusId,txCode:"CCBSB110",channelCode:CONFIG.SALE_CHANNEL,policyNo:vm.policyInfo.policyNo,branchCode:vm.policyInfo.branchCode,fileName:"F011.png"};vm.paramSign=JSON.parse(window.localStorage.getItem("paramSign")),PolicyService.submitBase64(paramBase64,vm.paramSign,function(result){if("1"==result.status&&result.data){var msg="尊敬的客户，您的保单已微信回访成功。为了维护您的权益并确保回访真实性，根据监管要求，我们将随机进行电话回访，请您留意接听我司95331回访电话，感谢您的配合";vm.VisitSupplement={prdName:vm.policyInfo.mainRiskName,policyNo:vm.policyInfo.policyNo,appName:vm.policyInfo.insuranceName,insureName:vm.policyInfo.rcgnName,startTime:vm.policyInfo.effectiveTime2String,answerSupplementList:vm.answerSupplementList,imageBase64:vm.signBase64,custId:userData.cusId,branchCode:vm.policyInfo.branchCode,channelCode:CONFIG.SALE_CHANNEL,fileName:"F011.png"},CommonRequest.request(vm.VisitSupplement,CONFIG.VISITSUPPLEMENT,function(result){"1"==result.status&&(vm.visitAlert(msg),window.localStorage.removeItem(vm.policyInfo.policyNo),window.localStorage.removeItem("paramSign"))})}})})},vm.visitAlert=function(msg){$ionicLoading.hide();var alertPopup=$ionicPopup.alert({title:"温馨提示",template:msg,okText:"我知道了"});alertPopup.then(function(res){if(res){var index,waitData=PolicyService.getSessionData().onlineReturnWaitData||[];if(1==waitData.length)PolicyService.removeSessionData("onlineReturnWaitData"),$state.go("online-return-list");else if(waitData.length>1){for(var i=0;i<waitData.length;i++)waitData[i].policyNo==vm.policyInfo.policyNo&&(index=i);waitData.splice(index,1),PolicyService.removeSessionData("onlineReturnWaitData"),PolicyService.setSessionData({onlineReturnWaitData:waitData}),0!=waitData.length?$state.go("online-return-wait-list"):$state.go("online-return-list")}else $state.go("online-return-list")}})},vm.onlineVisitReturn=function(){history.go(-2)}}angular.module("app").controller("onlineReturnConfirmController",onlineReturnConfirmController),onlineReturnConfirmController.$inject=["$state","$rootScope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$filter","$ionicLoading"]}(),function(){function onlineReturnQuestionController($state,$rootScope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$filter,$stateParams){function timedCount(){var policyNoObj=angular.fromJson(sessionStorage.getItem("policyNo"));"1"==policyNoObj.from?vm.duration<=0?(clearTimeout(time),vm.btnDisable=!1):time=$timeout(function(){vm.duration--,timedCount()},1e3):vm.btnDisable=!1}var vm=this;vm.questionListA=[];var sessionData=PolicyService.getSessionData(),onlineReturnData=sessionData.onlineReturnQuestion;onlineReturnData||$state.go("tab.mall"),vm.policyInfo=onlineReturnData.policyInfo,vm.visitTime=$filter("date")(new Date,"yyyy-MM-dd"),vm.healthTag=[];var nowDate=new Date,date=nowDate.getDate(),month=nowDate.getMonth()+1,strMonth=(nowDate.getFullYear(),month),strDate=date;month>=1&&10>month&&(strMonth="0"+month),date>=1&&10>date&&(strDate="0"+date),vm.getQuestionList=function(){vm.rootPolicyList=JSON.parse(window.localStorage.getItem("rootPolicyList"));for(var i=0;i<vm.rootPolicyList.length;i++)if(vm.rootPolicyList[i].policyNo==vm.policyInfo.policyNo){vm.taskId=vm.rootPolicyList[i].callTaskId;break}var param={agentNo:"wechat",calloutType1:"01",contNo:vm.policyInfo.policyNo,taskId:vm.taskId};CommonRequest.request(param,CONFIG.NEWONLINE_VISIT_GET_QUESTION,function(result){if(vm.questionList=[],result){if(result.status&&1==result.status)if(result.data){vm.subflag=result.data.showLangPattern,vm.questionnaireID=result.data.questionnaireID;for(var _i=0;_i<result.data.questionList.questions.length;_i++)vm.arrQuestionList={},vm.arrQuestionList.content=result.data.questionList.questions[_i].questionContent,vm.arrQuestionList.noStatus="NULL",vm.arrQuestionList.paperId=result.data.questionList.questions[_i].questionID,vm.arrQuestionList.questionId=result.data.questionList.questions[_i].questionID,vm.arrQuestionList.subjectId="NULL",vm.arrQuestionList.answers=result.data.questionList.questions[_i].answerArraysList.answerArrays.answersList.answers,vm.arrQuestionList.orderno=result.data.questionList.questions[_i].seqno,vm.arrQuestionList.noTips=result.data.questionList.questions[_i].handleTerm,vm.arrQuestionList.nairesubjectGuid="NULL",vm.arrQuestionList.nairesubjectContent=result.data.questionList.questions[_i].questionContent,vm.questionList.push(vm.arrQuestionList);if(window.localStorage.removeItem(vm.policyInfo.policyNo),vm.newQL={},vm.newQL.answers=Array.from({length:vm.questionList.length}),window.localStorage.getItem(vm.policyInfo.policyNo)){var a=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo));a.forEach(function(item,index,array){vm.questionList[index].buttonCont=item})}else{for(var result1=[],i=0;i<vm.questionList.length;i++)vm.questionList[i].buttonCont="";vm.questionList.forEach(function(item,index,array){result1.push(item.buttonCont)}),window.localStorage.setItem(vm.policyInfo.policyNo,JSON.stringify(result1))}}else TipService.showMsg("获取问卷信息失败");else TipService.showMsg("获取问卷信息失败");$rootScope.$broadcast("scroll.refreshComplete");for(var arr=[],i=0;i<vm.questionList.length;i++)arr.push(angular.element(document.getElementsByClassName("question-card")).eq(i).find(document.getElementsByTagName("button")).hasClass("question-bule"));var openswitch=arr.every(function(item,index,arr){return 1==item});vm.questionDisable=openswitch}})},vm.goQuestinSign=function(){var a=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo)),b=a.every(function(item,index,array){return""!=item});if(!b)return void TipService.showMsg("您尚有回访问卷未完成，请继续完成并提交问卷");for(var i=0;i<vm.questionList.length;i++){if(window.localStorage.getItem(vm.policyInfo.policyNo))var aa=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo)),index=0==aa[i]?1:0,answerCode={answerCode:0==aa[i]?1:0};vm.questionList[i]=angular.extend(vm.questionList[i],vm.questionList[i].answers[index]),vm.questionList[i]=angular.extend(vm.questionList[i],answerCode)}vm.paramSign={policyNo:vm.policyInfo.policyNo,paperId:vm.questionnaireID,answerLists:vm.newQL},window.localStorage.setItem("paramSign",JSON.stringify(vm.paramSign)),PolicyService.control({state:"online-return-question",control:"data",data:{questionList:vm.questionList}}),PolicyService.control({state:"online-return-question",control:"process"})},$timeout(function(){vm.getQuestionList()},200),vm.btnDisable=!0,vm.duration=60;var time;timedCount(),vm.questionDisable=!0,vm.clickVeto=function(index,flag,con){if(vm.answerArr={},vm.answerArr.answerList={},vm.answerArr.answerList.answer=[],vm.healthTag[index]=flag,"1"==flag){con.buttonCont="0";var a=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo));a[index]=con.buttonCont,window.localStorage.setItem(vm.policyInfo.policyNo,JSON.stringify(a));for(var x=0;x<con.answers.length;x++)if(vm.answerobj={},"0"==con.answers[x].answerPrefer){vm.answerobj.answerNo=con.answers[x].answerNo,vm.answerobj.answerContent=con.answers[x].answerContent,vm.answerArr.answerList.answer.push(vm.answerobj),vm.answerArr.questionId=con.questionId,vm.newQL.answers[index]=vm.answerArr;break}"是"==vm.subflag?TipService.showMsg(vm.questionList[index].noTips,"onlineVisit"):""}else{con.buttonCont="1";var a=JSON.parse(window.localStorage.getItem(vm.policyInfo.policyNo));a[index]=con.buttonCont,window.localStorage.setItem(vm.policyInfo.policyNo,JSON.stringify(a));for(var _x=0;_x<con.answers.length;_x++)if(vm.answerobj={},"1"==con.answers[_x].answerPrefer){vm.answerobj.answerNo=con.answers[_x].answerNo,vm.answerobj.answerContent=con.answers[_x].answerContent,vm.answerArr.answerList.answer.push(vm.answerobj),vm.answerArr.questionId=con.questionId,vm.newQL.answers[index]=vm.answerArr;break}}for(var arr1=[],i=0;i<vm.questionList.length;i++)arr1.push(angular.element(document.getElementsByClassName("question-card")).eq(i).find(document.getElementsByTagName("button")).hasClass("question-bule"));var openswitch=arr1.every(function(item,index,arr){return 1==item});vm.questionDisable=openswitch},vm.goBack=function(){window.history.back()}}angular.module("app").controller("onlineReturnQuestionController",onlineReturnQuestionController),onlineReturnQuestionController.$inject=["$state","$rootScope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$filter","$stateParams"]}(),function(){function onlineReturnSignController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000",this.background="#ffffff";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=screenHeight-70-vm.headHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=this.linewidth,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/service/water_mark_visit.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){vm.startNmae=!0,this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),$scope.$apply()}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){vm.startNmae=!1,vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0),$scope.$apply()}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL();signBase64&&(vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),PolicyService.control({state:"online-return-sign",control:"data",data:{signBase64:signBase64}}),PolicyService.control({state:"online-return-sign",control:"process"}))}.bind(this),!1)}var vm=this,sessionData=PolicyService.getSessionData(),onlineReturnData=sessionData.onlineReturnData,policyNoObj=angular.fromJson(sessionStorage.getItem("policyNo"));policyNoObj.from="2",console.info(policyNoObj),sessionStorage.setItem("policyNo",angular.toJson(policyNoObj)),onlineReturnData||$state.go("tab.mall"),vm.signStart=!1,vm.startNmae=!1,vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=44);var screenHeight=$(window).height();document.getElementById("online-reeturnsign").addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.getElementById("online-reeturnsign").addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:9,color:"black",background:"#ffffff"})}angular.module("app").controller("onlineReturnSignController",onlineReturnSignController),onlineReturnSignController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout"]}(),function(){function onlineReturnValidateController($state,$rootScope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout){var vm=this;vm.olineValidateIdType="A",vm.txCode="CCBSB100";var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.onlineReturnData=sessionData.onlineReturnData,vm.onlineReturnWaitData=sessionData.onlineReturnWaitData,vm.onineValidatePhone="",vm.phoneCode="";var rootScope=$rootScope;vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",console.info(vm.upFilePath),vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.phoneAlert=function(val){1==val.invalid&&(vm.phoneAlertshow=!0,$timeout(function(){vm.phoneAlertshow=!1},1500))},vm.dragShow=function(phone){if(vm.onineValidatePhone){if(vm.showDrag)return;vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg(),console.info(68)}else vm.showDrag=!1,vm.doAnimate=!0},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||vm.getdragimg()}),vm.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){vm.dragDisabled=!1,vm.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)});var alertMsg,TIPS=$rootScope.TIPS;vm.errorAlert=function(key,val){"onlineValidateName"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.USER_NAME_INVALID:1==val.length&&(alertMsg=TIPS.COMMON.USER_NAME_LENGTH_ERROR)),"onlineValidateNo"==key&&(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID2:1==val.length?alertMsg=TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?alertMsg=TIPS.COMMON.ID_INVALID:1==vm.holdAgeError?alertMsg="投保人年龄范围不符合要求":1==vm.insureAgeError&&(alertMsg="子女年龄范围不符合要求")),"onlineValidatePhone"==key&&1==val&&(alertMsg=TIPS.COMMON.PHONE_INVALID),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert"),alertMsg="")},vm.submitValidate=function(){if(vm.onlineValidateName!==vm.userData.customerName)return void TipService.showMsg("填写姓名与选中保单中姓名不一致");if(vm.onlineValidateNo!==vm.userData.cretNo)return void TipService.showMsg("填写证件号码与选中保单中证件号码不一致");if(vm.olineValidateIdType!==vm.userData.cretType)return void TipService.showMsg("填写证件类型与选中保单中证件类型不一致");for(var i=0;i<vm.onlineReturnData.length;i++){if(vm.onineValidatePhone==vm.onlineReturnData[i].mobilephone){vm.phoneFlag=!1;break}vm.phoneFlag=!0}if(vm.phoneFlag)return void TipService.showMsg("填写手机号码与选中的保单预留手机号码不一致");var params={insName:vm.onlineValidateName,cerType:vm.olineValidateIdType,cerNum:vm.onlineValidateNo,mobilePhone:vm.onineValidatePhone,phoneIdCode:vm.phoneCode,CCBSBCODE:vm.txCode};CommonRequest.request(params,CONFIG.NEWONLINE_INFO_VALIDATE,function(result){if(result&&1==result.status){for(var k=0;k<vm.onlineReturnData.length;k++)vm.onineValidatePhone==vm.onlineReturnData[k].mobilephone&&vm.onlineReturnWaitData.push(vm.onlineReturnData[k]);PolicyService.setSessionData({onlineReturnWaitData:vm.onlineReturnWaitData}),$state.go("online-return-wait-list")}else TipService.showMsg("短信验证码输入错误")})}}angular.module("app").controller("onlineReturnValidateController",onlineReturnValidateController),onlineReturnValidateController.$inject=["$state","$rootScope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout"]}(),function(){function onlineReturnWaitListController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$ionicScrollDelegate){var vm=this,sessionData=PolicyService.getSessionData();vm.policyList=sessionData.onlineReturnWaitData,vm.goQuestion=function(policyNo){var policyNoIs=policyNo,policyNoObj={policyNo:policyNoIs,from:"1"};sessionStorage.setItem("policyNo",angular.toJson(policyNoObj)),sessionData.onlineReturnQuestion&&PolicyService.removeSessionData("onlineReturnQuestion");for(var i=0;i<vm.policyList.length;i++)if(vm.policyList[i].policyNo==policyNo){var policyInfo=vm.policyList[i];PolicyService.control({state:"online-return-wait-list",control:"data",data:{policyInfo:policyInfo}}),PolicyService.control({state:"online-return-wait-list",control:"process"})}},$scope.$on("$stateChangeStart",function(event,toState,toStateParams,fromState,fromStateParams){toState.name;"online-return-wait-list"==fromState.name&&"online-return-question"!=toState.name&&(console.info("fanhuile"),event.preventDefault(),history.go(1))})}angular.module("app").controller("onlineReturnWaitListController",onlineReturnWaitListController),onlineReturnWaitListController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$ionicScrollDelegate"]}(),function(){function ProgressChangeDetailsController($scope,$state,PolicyChangeService,TipService){var vm=this;return vm.EdorName=$state.params.EdorName,vm.EdorState=$state.params.EdorState,vm.RiskName=$state.params.RiskName,vm.EdorAppDate=$state.params.EdorAppDate,vm.AppRoveIdea=$state.params.AppRoveIdea,vm.Salechnl=$state.params.Salechnl,vm.ContNo=$state.params.ContNo,vm.goBack=function(){history.back()},vm.EdorState?("1"==vm.EdorState?vm.line=1:"2"==vm.EdorState?vm.line=2:"6"==vm.EdorState||"7"==vm.EdorState?vm.line=4:vm.line=3,vm.RiskName&&PolicyChangeService.payRecord({policyNo:vm.ContNo},function(data){data.prdId&&(vm.prdId=data.prdId)}),void(vm.ContNo||history.back())):void vm.goBack()}angular.module("app").controller("ProgressChangeDetailsController",ProgressChangeDetailsController),ProgressChangeDetailsController.$inject=["$scope","$state","PolicyChangeService","TipService"]}(),function(){function BankSignContractController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,PolicyService,$timeout,TipService,$filter,$ionicPopup,$sce){var vm=this;vm.noticeList=function(){var params=[];CommonRequest.request(params,CONFIG.GYL_CONTRACT__NOTICE,function(result){1==result.status&&(vm.bankNotive=result.data,vm.bankNotive.beforeTableContent=$sce.trustAsHtml(vm.bankNotive.beforeTableContent),vm.bankNotive.afterTableContent=$sce.trustAsHtml(vm.bankNotive.afterTableContent),vm.bankNotive.customerPhone=$sce.trustAsHtml(vm.bankNotive.customerPhone),vm.bankNotive.company=$sce.trustAsHtml(vm.bankNotive.company),vm.banks=result.data.banks)})},vm.noticeList(),vm.noticeComfirm=function(){if($state.params.signBankList){var signBank=$state.params.signBankList;$state.go("bank-sign-notice",{signBankList:signBank})}else if($state.params.id){var id=$state.params.id;$state.go("bank-sign-notice",{id:id})}else $state.go("bank-sign-notice")}}angular.module("app").controller("BankSignContractController",BankSignContractController),BankSignContractController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","PolicyService","$timeout","TipService","$filter","$ionicPopup","$sce"]}(),function(){function BankSignNoticeController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,PolicyService,$timeout,TipService,$filter,$ionicPopup,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();vm.timea=60,vm.manualBankData=sessionData.manualBankData,CommonRequest.request([],CONFIG.GYL_CONTRACT__BANKS,function(result){if(1==result.status){vm.bankList=[];for(var i=0;i<result.data.length;i++)1==result.data[i].displayStatus&&vm.bankList.push(result.data[i]);for(var i=0;i<vm.bankList.length;i++)vm.bankName==vm.bankList[i].bankName&&(vm.bankCode=vm.bankList[i].bankCode)}}),vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.signBankList=[],vm.clearArrTrim=function(array){for(var i=0;i<array.length;i++)""!=array[i]&&void 0!=_typeof(array[i])||(array.splice(i,1),i-=1)},$state.params.signBankList&&(vm.signBankList=$state.params.signBankList,vm.signBankList[1]&&vm.signBankList[0]&&vm.signBankList[0]==vm.signBankList[1]&&(vm.signBankList=[vm.signBankList[0]]),vm.bankAccount=vm.signBankList[0]),vm.id=$state.params.id,vm.orderCodes=[],vm.manualBankData&&(vm.signFlag=!0,vm.clearArrTrim(vm.manualBankData.objBankcount),vm.signBankList=vm.manualBankData.objBankcount,vm.signBankList[1]&&vm.signBankList[0]&&vm.signBankList[0]==vm.signBankList[1]&&(vm.signBankList=[vm.signBankList[0]]),vm.bankAccount=vm.signBankList[0]),vm.bankNo=function(){var params={orderCodes:vm.orderCodes};CommonRequest.request(params,CONFIG.GYL_CONTRACT_BANK,function(result){1==result.status&&("1"!=result.data[0].payBankContractStatus&&"3"!=result.data[0].payBankContractStatus||result.data[0].payBankNo&&(vm.signBankList.push(result.data[0].payBankNo),vm.signFlag=!0,vm.bankAccount=vm.signBankList[0]),"1"!=result.data[0].accBankContractStatus&&"3"!=result.data[0].accBankContractStatus||result.data[0].accBankNo&&(vm.signBankList.push(result.data[0].accBankNo),vm.signFlag=!0,vm.bankAccount=vm.signBankList[0]))})},vm.id&&(vm.orderCodes.push(vm.id),vm.bankNo()),vm.signBankList&&vm.signBankList[0]?vm.signFlag=!0:vm.signFlag=!1,vm.phone="",vm.phoneCode="",vm.txCode="CCBSB100",vm.nameDisabled=!1,vm.bankAccountDisabled=!1,vm.idtypeDisabled=!1;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,$rootScope.$on("bind-result",function(erent,data){$timeout(function(){var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.userData.customerName&&(vm.name=vm.userData.customerName,vm.nameDisabled=!0),vm.userData.cretType&&vm.userData.cretNo&&(vm.idtype=vm.userData.cretType,vm.certNo=vm.userData.cretNo,vm.certName=$filter("cerFilter")(vm.idtype),vm.idtypeDisabled=!0),vm.userData.phoneNo&&(vm.showDrag=!0,vm.getdragimg(),vm.phone=vm.userData.phoneNo))},500)}),vm.showFlag=0,vm.showDetial=function(){if(vm.showFlag++,$rootScope.isLogin){var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.userData.customerName&&(vm.name=vm.userData.customerName,vm.nameDisabled=!0),vm.userData.cretType&&vm.userData.cretNo&&(vm.idtype=vm.userData.cretType,vm.certNo=vm.userData.cretNo,vm.certName=$filter("cerFilter")(vm.idtype),vm.idtypeDisabled=!0),vm.userData.phoneNo&&(vm.showDrag=!0,vm.getdragimg(),vm.phone=vm.userData.phoneNo))}else{if(!(vm.showFlag<5))return;$timeout(function(){vm.showDetial()},1e3)}},vm.showDetial(),$scope.$on("drag-down",function(event,result){vm.imagecode=result.position}),vm.contractApply=function(){vm.timea=60;var params={OppAct:vm.bankAccount,OppActName:vm.name,CertType:vm.idtype,CertNumber:vm.certNo,CellPhone:vm.phone,random:vm.random,txCode:vm.txCode,imageCode:vm.imagecode,OppBank:vm.bankCode};CommonRequest.request(params,CONFIG.GYL_CONTRACT_APPLY,function(result){1==result.status?(vm.successAccount=vm.bankAccount,vm.RdSeq=result.data.RdSeq,vm.getContractApply()):(vm.getdragimg(),vm.bankAccount="",vm.RdSeq="")})},vm.getContractApplyTimes=0,vm.getContractApply=function(callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'});var params={RdSeq:vm.RdSeq};return vm.getContractApplyTimes++,vm.getContractApplyTimes>15?($ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.SYSTEM.NETWORK_ERROR),void(vm.getContractApplyTimes=0)):void CommonRequest.request(params,CONFIG.GYL_CONTRACT_APPLY_RESULT,function(result){if(result.error)vm.getContractApplyTimes=0,$ionicLoading.hide(),vm.getdragimg(),vm.RdSeq="";else{if(!result.data)return void $timeout(function(){vm.getContractApply(callback)},3e3);result.data;vm.RdSeq=result.data.RdSeq,vm.getContractApplyTimes=0,$ionicLoading.hide(),angular.isFunction(callback)&&callback()}},!0)},vm.contractComfirm=function(){if(vm.RdSeq&&vm.successAccount==vm.bankAccount){var params={RdSeq:vm.RdSeq,VerfyCode:vm.phoneCode};CommonRequest.request(params,CONFIG.GYL_CONTRACT_COMFIRM,function(result){1==result.status&&vm.getContractComfirm()})}else vm.RdSeq&&vm.successAccount!=vm.bankAccount?$ionicPopup.alert({title:"温馨提示",template:"请重新获取验证码",okText:"我知道了"}):$ionicPopup.alert({title:"温馨提示",template:"请输入正确银行卡号或请先获取验证码",okText:"我知道了"})},vm.getContractComfirmTimes=0,vm.getContractComfirm=function(callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'});var params={RdSeq:vm.RdSeq};return vm.getContractComfirmTimes++,vm.getContractComfirmTimes>15?($ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.SYSTEM.NETWORK_ERROR),void(vm.getContractComfirmTimes=0)):void CommonRequest.request(params,CONFIG.GYL_CONTRACT_COMFIRM_RESULT,function(result){if(result.error)vm.getContractComfirmTimes=0,vm.RdSeq="",vm.timea=1,vm.phoneCode="",$ionicLoading.hide();else{if(!result.data)return void $timeout(function(){vm.getContractComfirm(callback)},3e3);1!=result.status||2!=result.data.SignState&&4!=result.data.SignState||$state.go("bank-sign-success");result.data;vm.RdSeq=result.data.RdSeq,vm.getContractComfirmTimes=0,$ionicLoading.hide(),angular.isFunction(callback)&&callback()}},!0)},sessionData.userData&&(vm.showDrag=!0,vm.getdragimg()),vm.dragShow=function(phone){if(phone){if(vm.showDrag)return;vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg(),$scope.$apply()}else vm.showDrag=!1,vm.doAnimate=!0},vm.dragDisabled=!0,$scope.$on("drag-down",function(event,result){vm.dragDisabled=!1,$scope.$apply()}),$scope.$on("send-drag-result",function(erent,data){var flag=data.result;flag?vm.contractApply():vm.getdragimg()})}angular.module("app").controller("BankSignNoticeController",BankSignNoticeController),BankSignNoticeController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","PolicyService","$timeout","TipService","$filter","$ionicPopup","$ionicLoading"]}(),function(){function BankSignSuccessController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,PolicyService,$timeout,TipService,$ionicPopup){$scope.divheight=$("#content").height()}angular.module("app").controller("BankSignSuccessController",BankSignSuccessController),BankSignSuccessController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","PolicyService","$timeout","TipService","$ionicPopup"]}(),function(){function PersonRevenueController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,PolicyService,CommonRequest,$ionicPopup,$timeout,PolicyChangeService,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.policyNo=$state.params.policyNo,vm.changeType=$state.params.changeType,vm.saleChannel=$state.params.saleChannel,vm.cardNo=$state.params.cardNo||window.sessionStorage.getItem("yz-cardNo"),vm.prdCode=$state.params.prdCode||window.sessionStorage.getItem("yz-prdCode"),vm.mainClassName=$state.params.mainClassName,$state.params.cretType&&$state.params.cretNo&&$state.params.cretArriveDate&&$state.params.oldTransNo&&$state.params.idImgFront&&$state.params.idImgBack&&(vm.changeIdtype=$state.params.cretType,vm.cretNo=$state.params.cretNo,vm.validity=$state.params.cretArriveDate,vm.seriaTransNo=$state.params.oldTransNo,vm.filePath1=$state.params.idImgFront,vm.filePath2=$state.params.idImgBack),vm.policyNo&&vm.changeType?(vm.checkCusId=!0,vm.checkInCusld=!1,vm.userData=sessionData.userData||{},vm.insuranceName=vm.userData.customerName,vm.citizenType="",vm.surname="",vm.secondName="",vm.crsBirthday=vm.userData.birthday,vm.liveZone="",vm.liveDetailAdr="",vm.birthCountry="",vm.birthProvince="",vm.birthDistrictData="",vm.birthDstc="",vm.insuranceSex=vm.userData.sex,vm.insuranceCerType=vm.userData.cretType,vm.insuranceCerNo=vm.userData.cretNo,vm.getVprdid=function(){var params={prdCode:"ALLIN"};CommonRequest.request(params,CONFIG.NEW_GETPRDID,function(result){result.data&&(vm.v_prdid=result.data)})},vm.getVprdid(),vm.getPolicyDetail=function(callback){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,"2099-12-31"!=vm.policyDetail.appIdArriveDate?(vm.certExpireDate=new Date(vm.policyDetail.appIdArriveDate),
vm.valueCer="2"):(vm.valueCer="1",vm.certExpireDate=new Date("2099-12-31")),angular.isFunction(callback)&&callback())})},vm.getPolicyDetail(function(){var params={policyNo:vm.policyNo};PolicyChangeService.riskDetail(params,function(data){vm.riskDetail=data}),PolicyChangeService.policyCustomerDetail(params,function(data){vm.customerDetail=data,vm.id=vm.policyDetail.holderIdNo,"身份证"==vm.customerDetail.holderIdType?(vm.idtype="A",vm.customerDetail.holderIdType="A"):"护照"==vm.customerDetail.holderIdType?(vm.idtype="I",vm.customerDetail.holderIdType="I"):"港澳台通行证"==vm.customerDetail.holderIdType?(vm.idtype="G",vm.customerDetail.holderIdType="G"):"外国人永久居留身份证"==vm.customerDetail.holderIdType&&(vm.idtype="N",vm.customerDetail.holderIdType="N")})}),vm.liveCountry="中国",vm.birthCountry="中国",vm.birthCode="CHN",$scope.$on("select-country-close",function(event,result){vm.birthCountry=result[0].countryName,vm.birthCode=result[0].countryCode}),$scope.$on("select-prdarea-close",function(event,result){vm.liveProvince=result[0],vm.liveDistrict=result[1],vm.liveDstc=result[2]}),vm.signDate=$filter("date")(new Date,"yyyy年MM月dd日"),vm.isSelf="本人",vm.crsList=[{seqNo:1,taxPymtNoType:""}],vm.addCrs=function(){if(!(vm.crsList.length>=3)){var seqNo=vm.crsList[vm.crsList.length-1].seqNo+1;vm.crsList.push({seqNo:seqNo,taxPymtNoType:""})}},vm.delCrs=function(seqNo){if(!(vm.crsList.length<=1))for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&vm.crsList.splice(i,1)},vm.clearInput=function(Type,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&("1"==Type?vm.crsList[i].nonTaxPymtDesc="":"2"==Type&&(vm.crsList[i].taxPymtNo=""))},vm.clearInputse=function(nonTaxPymtCd,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&"1"==nonTaxPymtCd&&(vm.crsList[i].nonTaxPymtDesc="")},$scope.$on("select-prdarea-close-crs",function(event,result){vm.birthProvince=result[0],vm.birthDistrict=result[1],vm.birthDstc=result[2]}),vm.next=function(){var birthFlag,isCitizenType=!0;"2"!=vm.citizenType&&"3"!=vm.citizenType||(isCitizenType=!1),birthFlag=("2"==vm.citizenType||"3"==vm.citizenType)&&"CHN"==vm.birthCode;var params={citizenType:vm.citizenType,insuranceName:vm.insuranceName,insuranceSex:vm.insuranceSex,birthday:vm.crsBirthday,insuranceCerType:vm.changeIdtype||vm.insuranceCerType,insuranceCerNo:vm.cretNo||vm.insuranceCerNo,surname:isCitizenType?"":vm.surname,secondName:isCitizenType?"":vm.secondName,liveCountry:isCitizenType?"":"CHN",liveProvince:isCitizenType?"":vm.liveProvince.areaCode,liveDistrict:isCitizenType?"":vm.liveDistrict.areaCode,liveDstc:isCitizenType?"":vm.liveDstc.areaCode,liveDetailAdr:isCitizenType?"":vm.liveDetailAdr,birthCountryCont:isCitizenType?"":vm.birthCountry.countryName,birthCountry:isCitizenType?"":vm.birthCountry.countryCode,birthProvinceCont:vm.birthProvince&&birthFlag?vm.birthProvince.areaName:"",birthProvince:vm.birthProvince&&birthFlag?vm.birthProvince.areaCode:"",birthDistrictCont:vm.birthDistrict&&birthFlag?vm.birthDistrict.areaName:"",birthDistrict:vm.birthDistrict&&birthFlag?vm.birthDistrict.areaCode:"",birthDstcCont:vm.birthDstc&&birthFlag?vm.birthDstc.areaName:"",birthDstc:vm.birthDstc&&birthFlag?vm.birthDstc.areaCode:"",birthDetailAdr:isCitizenType?"":vm.birthDetailAdr,taxCountry1:!isCitizenType&&vm.crsList[0]?vm.crsList[0].taxCountry||"":"",taxPymtNo1:!isCitizenType&&vm.crsList[0]?vm.crsList[0].taxPymtNo||"":"",nonTaxPymtCd1:!isCitizenType&&vm.crsList[0]?vm.crsList[0].nonTaxPymtCd||"":"",nonTaxPymtDesc1:!isCitizenType&&vm.crsList[0]?vm.crsList[0].nonTaxPymtDesc||"":"",taxCountry2:!isCitizenType&&vm.crsList[1]?vm.crsList[1].taxCountry||"":"",taxPymtNo2:!isCitizenType&&vm.crsList[1]?vm.crsList[1].taxPymtNo||"":"",nonTaxPymtCd2:!isCitizenType&&vm.crsList[1]?vm.crsList[1].nonTaxPymtCd||"":"",nonTaxPymtDesc2:!isCitizenType&&vm.crsList[1]?vm.crsList[1].nonTaxPymtDesc||"":"",taxCountry3:!isCitizenType&&vm.crsList[2]?vm.crsList[2].taxCountry||"":"",taxPymtNo3:!isCitizenType&&vm.crsList[2]?vm.crsList[2].taxPymtNo||"":"",nonTaxPymtCd3:!isCitizenType&&vm.crsList[2]?vm.crsList[2].nonTaxPymtCd||"":"",nonTaxPymtDesc3:!isCitizenType&&vm.crsList[2]?vm.crsList[2].nonTaxPymtDesc||"":"",isSelf:"1"};CommonRequest.request(params,CONFIG.UPLOAD_CES_INFO,function(result){if(1==result.status){var queryId=result.data.id;$timeout(vm.queryUpStatus(queryId,vm.goPolicy),3e3)}})},vm.getWithdrawResultTimes=0,vm.queryUpStatus=function(queryId,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'});var params={id:queryId};return vm.getWithdrawResultTimes++,vm.getWithdrawResultTimes>CONFIG.CORE_DECOUPLING_TIMES?($ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.SYSTEM.NETWORK_ERROR),void(vm.getWithdrawResultTimes=0)):void CommonRequest.request(params,CONFIG.GET_UPLOAD_CRS_STATUS,function(result){if(1==result.status){var data=result.data,isCanUpdate=data.status;if(!isCanUpdate||"2"==isCanUpdate||"1"==isCanUpdate)return void $timeout(function(){vm.queryUpStatus(queryId,callback)},CONFIG.CORE_DECOUPLING_DURATION);vm.getWithdrawResultTimes=0,$ionicLoading.hide(),angular.isFunction(callback)&&callback(result)}else vm.getWithdrawResultTimes=0,$ionicLoading.hide()},!0)},vm.expireGet=function(){var prams={policyNo:vm.policyNo,channleCode:vm.saleChannel,accName:vm.userData.customerName,sex:vm.userData.sex,cretType:vm.userData.cretType,cretNo:vm.userData.cretNo};PolicyChangeService.expireGet(prams,function(res){if(1==res.data.isCanUpdate){var data=res.data.fullPaymentModel;if(!data.appnRelation||!data.beneRela)return void TipService.showMsg("在线申请需投保人、受益人与被保险人的关系一致，您不满足在线申请条件，可联系业务人员");if(data.appnRelation!=data.beneRela)return void TipService.showMsg("在线申请需投保人、受益人与被保险人的关系一致，您不满足在线申请条件，可联系业务人员");data.serialTransNo=res.data.serialTransNo,PolicyService.removeSessionData("serviceExpireGetData"),data.policyNo=vm.policyNo,data.saleChannel=vm.saleChannel,PolicyService.setSessionData({serviceExpireGetData:data}),$state.go("policy-expire-get",{policyNo:vm.policyNo,saleChannel:vm.saleChannel})}})},void(vm.goPolicy=function(){var route,changeType=vm.changeType;switch(changeType){case"1":route="policy-change-id";break;case"4":route="policy-change-transfer-account";break;case"6":route="policy-change-bonus-choose";break;case"10":route="policy-change-withdraw";break;case"12":route="policy-change-pledge"}PolicyChangeService.showDetail({policyNo:vm.policyNo},function(data){vm.policyDetial=data,vm.isInHesitate=vm.policyDetial.isInHesitate,vm.effectDate=vm.policyDetial.effectDate,vm.planCode=vm.policyDetial.mainClassCode;var edit,params;if("1"==changeType){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html");var ocrToken=sessionStorage.getItem("elife-ocrStatus");PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.userData.custId,config:"CM",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.changeIdtype,cretNo:"A"==vm.changeIdtype?vm.cretNo.toUpperCase():vm.cretNo,cretArriveDate:vm.validity,birthday:vm.customerDetail.holderBirthday,oldTransNo:vm.seriaTransNo,idImgFront:vm.filePath1,idImgBack:vm.filePath2,CCBSBCODE:"CCBSB000",token:ocrToken}})}else if("4"==changeType||"6"==changeType)$state.go(route,{policyNo:vm.policyNo,saleChannel:vm.saleChannel});else if("10"==changeType)"826"!=vm.saleChannel&&PolicyChangeService.applyWithdraw(vm.policyNo,vm.saleChannel,function(result){if("1"==result.status)if("1"==result.data.isCanUpdate){vm.seriaTransNo=result.data.seriaTransNo,vm.backMoneyModel=result.data.backMoneyModel,vm.abandonMode=result.data.abandonMode,vm.backMoneyMode=result.data.backMoneyMode,vm.imageInfo=!!result.data.imageInfo,vm.filePath1=vm.imageInfo?result.data.imageInfo.frontImagePath+result.data.imageInfo.frontImageName+";":"",vm.filePath2=vm.imageInfo?result.data.imageInfo.backImagePath+result.data.imageInfo.backImageName+";":"";var policyServe={policyNo:vm.policyNo,seriaTransNo:vm.seriaTransNo,backMoneyModel:vm.backMoneyModel,abandonMode:vm.abandonMode,backMoneyMode:vm.backMoneyMode,imageInfo:vm.imageInfo,filePath1:vm.filePath1,filePath2:vm.filePath2,saleChannel:vm.saleChannel};PolicyService.setSessionData({policyServeData:policyServe}),$state.go("policy-change-withdraw")}else TipService.showMsg(result.data.resultDescrpt)}),"826"==vm.saleChannel&&PolicyChangeService.cardApplyWithdraw(vm.cardNo,vm.saleChannel,vm.prdCode,function(result){"1"==result.status&&("1"==result.data.respCode?(result.data.saleChannel=vm.saleChannel,result.data.mainClassName=vm.mainClassName,PolicyService.setSessionData({policyServeData:result.data}),$state.go("card-policy-change-withdraw")):TipService.showMsg(result.data.respDesc))});else if("12"==changeType){var edit="003",params={policyNo:vm.policyNo,editType:edit,channelCode:CONFIG.SALE_CHANNEL};PolicyChangeService.changeApply(params,function(data){vm.seriaTransNo=data.seriaTransNo,vm.premMoney=parseFloat(data.premMoney),$state.go(route,{policyNo:vm.policyNo,seriaTransNo:vm.seriaTransNo,premMoney:vm.premMoney})})}else"14"==changeType&&PolicyChangeService.isExpireGet(vm.policyNo,function(res){if(0==res.data.isCanUpdate)vm.expireGet();else if(1==res.data.isCanUpdate){var expire_confirm=$ionicPopup.confirm({title:"满期领取",template:res.data.resultDescrpt,okText:"确定",cancelText:"取消"});expire_confirm.then(function(res){res&&vm.expireGet()})}})})})):void $state.go("tab.mall")}angular.module("app").controller("PersonRevenueController",PersonRevenueController),PersonRevenueController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","PolicyService","CommonRequest","$ionicPopup","$timeout","PolicyChangeService","$ionicLoading"]}(),function(){function PleaseExpectController($state,COMMON,$scope,$log,CONFIG,CommonRequest,$rootScope,PolicyChangeService,PolicyService,TipService){$scope.width1=document.body.offsetWidth-40}angular.module("app").controller("PleaseExpectController",PleaseExpectController),PleaseExpectController.$inject=["$state","COMMON","$scope","$log","CONFIG","CommonRequest","$rootScope","PolicyChangeService","PolicyService","TipService"]}(),function(){function PolicyChangeAddPremiumController($state,COMMON,$scope,$log,CONFIG,CommonRequest,$rootScope,PolicyChangeService,PolicyService,TipService){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel;var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,!vm.policyNo)return void history.back();vm.money="",vm.date="6",vm.goset=function(){vm.rennewalDetail&&vm.rennewalDetail.paymentDate==vm.date&&parseInt(vm.rennewalDetail.paymentAmount)==parseInt(vm.money)?TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.NOT_SMALL):showModal()};var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,config:"FP",payDate:vm.date,payPrem:vm.money,policyNo:vm.policyNo,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})};vm.goBack=function(){history.back()};var params={policyNo:vm.policyNo};PolicyChangeService.currentRenewal(params,function(data){vm.rennewalDetail=data}),PolicyChangeService.showDetail(params,function(data){vm.productCode=data.mainClassCode})}angular.module("app").controller("PolicyChangeAddPremiumController",PolicyChangeAddPremiumController),PolicyChangeAddPremiumController.$inject=["$state","COMMON","$scope","$log","CONFIG","CommonRequest","$rootScope","PolicyChangeService","PolicyService","TipService"]}(),function(){function PolicyChangeBonusAccountController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,PolicyService,$timeout,$ionicLoading,TipService){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel,vm.serialTransNo=$state.params.serialTransNo;var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,vm.payMentMethon="1",vm.channelCode=vm.saleChannel,vm.goBack=function(){history.back()},!vm.policyNo)return void vm.goBack();vm.goset=function(){showModal()},vm.showDetial=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetial=result.data,vm.accName=vm.policyDetial.bankAccName&&"--"!=vm.policyDetial.bankAccName?vm.policyDetial.bankAccName:$rootScope.userData.customerName,vm.bankAccount=vm.policyDetial.bankAcc,vm.policyDetialBankCode=vm.policyDetial.bankCode,vm.policyDetialBankAcc=vm.bankAccount,vm.btk=vm.policyDetial.saleBranchCode.substring(0,4),vm.getBankList(),"--"!=vm.policyDetial.bankCode&&(vm.bankcode=vm.policyDetial.bankCode),"--"==vm.policyDetial.bankAcc&&(vm.bankAccount=""))})},"823"!=vm.channelCode&&vm.showDetial(),vm.accountDetial=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.CURRENT_RENEWAL_ACCOUNT_INFO,function(result){vm.policyDetial=result.data,vm.accName=vm.policyDetial.bankAccName&&"--"!=vm.policyDetial.bankAccName?vm.policyDetial.bankAccName:$rootScope.userData.customerName,vm.bankAccount=vm.policyDetial.bankAccNo,vm.btk=vm.policyDetial.bankCode.substring(0,2),vm.getBankList(),"--"!=vm.policyDetial.bankCode&&(vm.bankcode=vm.policyDetial.bankCode),"--"==vm.policyDetial.bankAccNo&&(vm.bankAccount="")})},"823"==vm.saleChannel&&vm.accountDetial(),vm.medicalAccInfo=function(val){"1"==vm.payMentMethon?(vm.bankAccount=vm.policyDetial.bankAccNo,vm.accName=vm.policyDetial.accName&&"--"!=vm.policyDetial.accName?vm.policyDetial.accName:$rootScope.userData.customerName,vm.btk=vm.policyDetial.bankCode.substring(0,2),vm.getBankList(),"--"!=vm.policyDetial.bankCode&&(vm.bankcode=vm.policyDetial.bankCode),"--"==vm.policyDetial.bankAccNo&&(vm.bankAccount="")):"2"==vm.payMentMethon&&(vm.medicalAccount=vm.policyDetial.medicalAccount,vm.medicalName=vm.policyDetial.medicalName&&"--"!=vm.policyDetial.medicalName?vm.policyDetial.medicalName:$rootScope.userData.customerName,"--"==vm.policyDetial.medicalAccount&&(vm.medicalAccount=""))};var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),"1"==vm.payMentMethon?PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,policyNo:vm.policyNo,pbHoldName:vm.userData.customerName,cretType:vm.userData.cretType,cretNo:vm.userData.cretNo,sex:vm.userData.sex,accType:vm.payMentMethon,accName:vm.accName,bankCode:vm.bankcode,bankAccNo:vm.bankAccount,rnBankAccNo:vm.bankAccount,serialTransNo:vm.serialTransNo,config:"PC",CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}}):PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,policyNo:vm.policyNo,pbHoldName:vm.userData.customerName,cretType:vm.userData.cretType,cretNo:vm.userData.cretNo,sex:vm.userData.sex,accType:vm.payMentMethon,accName:vm.medicalName,bankCode:vm.policyDetial.medicalPlace,bankAccNo:vm.medicalAccount.replace(/\s/g,""),medicalFlag:!0,rnBankAccNo:vm.medicalAccount.replace(/\s/g,""),serialTransNo:vm.serialTransNo,config:"PC",CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})};vm.getBankList=function(){vm.btk?("823"==vm.saleChannel&&(vm.btk="86"+vm.btk),vm.bankList,COMMON.getCommonBank(vm.btk,"1",function(bankList){vm.bankList=bankList,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode||(vm.bankcode=vm.bankList[0].bankCode))})):$timeout(function(){vm.getBankList()},100)},$scope.$watch("policyChangeBonusAccount.bankAccount",function(newValue,oldValue){if(newValue&&newValue!=oldValue){var blankValue=newValue.replace(/\s/g,"");blankValue.length>22&&(vm.bankAccount=blankValue.slice(0,22)),vm.bankAccount=vm.bankAccount.replace(/[\W]/g,""),vm.bankAccount=vm.bankAccount.replace(/[a-zA-Z]/g,""),vm.bankAccount=vm.bankAccount.replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 ")}}),$scope.$watch("policyChangeBonusAccount.medicalAccount",function(newValue,oldValue){if(newValue&&newValue!=oldValue){var blankValue=newValue.replace(/\s/g,"");blankValue.length>31&&(vm.medicalAccount=blankValue.slice(0,31)),vm.medicalAccount=vm.medicalAccount.replace(/[\W]/g,""),vm.medicalAccount=vm.medicalAccount.replace(/[a-zA-Z]/g,""),vm.medicalAccount=vm.medicalAccount.replace(/\s/g,"").replace(/(\d{4})(?=\d)/g,"$1 ")}}),vm.deleteIcon=function(){vm.bankAccount="",vm.medicalAccount=""},vm.findBankList=function(){vm.BankListFlag=!0},vm.iKnow=function(){vm.BankListFlag=!1},vm.submitCradNO=function(){var params={oppAct:vm.bankAccount.replace(/\s/g,""),comCode:vm.btk,bankAccountType:"1"};CommonRequest.request(params,CONFIG.IS_RULE_BANK,function(result){if(1==result.status){var info=result.data;"0"==info.RdCode?(vm.cardErrorMessage=info.RdMsg,$timeout(function(){vm.cardErrorMessage=!1},500)):4==info.CardType?(vm.cardErrorMessage="暂不支持准贷记卡账户",$timeout(function(){vm.cardErrorMessage=!1},500)):3==info.CardType?(vm.cardErrorMessage="暂不支持信用卡账户",$timeout(function(){vm.cardErrorMessage=!1},500)):"2"==info.RdCode?(vm.cardErrorMessage="暂不支持该开户行",$timeout(function(){vm.cardErrorMessage=!1},500)):"1"==info.RdCode&&$state.go("bonus-account-cardno-reco",{serialTransNo:vm.serialTransNo,policyNo:vm.policyNo,saleChannel:vm.saleChannel,accType:vm.payMentMethon,accName:vm.accName,bankCode:info.BankCode,bankAccNo:vm.bankAccount,btk:vm.btk,bankName:info.parentBankName,policyDetialBankCode:vm.policyDetialBankCode,policyDetialBankAcc:vm.policyDetialBankAcc})}})}}angular.module("app").controller("PolicyChangeBonusAccountController",PolicyChangeBonusAccountController),PolicyChangeBonusAccountController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","PolicyService","$timeout","$ionicLoading","TipService"]}(),function(){function PolicyChangeBonusChooseController($state,$scope,$log,CONFIG,CommonRequest,TipService,$rootScope,PolicyService,COMMON){var vm=this;if(vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel,!vm.policyNo)return void history.back();var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,vm.goset=function(){vm.OldBonusGetMode==vm.NewBonusGetMode?TipService.showMsg("对不起，您填写的变更后信息与变更前一致，请重新填写，谢谢！"):showModal()};var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,config:"BM",OldBonusGetMode:vm.OldBonusGetMode,NewBonusGetMode:vm.NewBonusGetMode,policyNo:vm.policyNo,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})};vm.goBack=function(){history.back()},vm.benefitDetail=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.BENEFIT_ORDDETAIL_SERVICE,function(result){1==result.status&&(vm.beneAccount=result.data,vm.OldBonusGetMode=vm.beneAccount.bonusGetMode)})},vm.benefitDetail()}angular.module("app").controller("PolicyChangeBonusChooseController",PolicyChangeBonusChooseController),PolicyChangeBonusChooseController.$inject=["$state","$scope","$log","CONFIG","CommonRequest","TipService","$rootScope","PolicyService","COMMON"]}(),function(){function PolicyMobileModalController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,TipService,PolicyChangeService,$timeout,$ionicPopup,$ionicLoading,$window,BankContractService){var rootScope=$rootScope,sessionData=PolicyService.getSessionData();$scope.userData=sessionData.poilicyChange,$scope.userDataMain=sessionData.userData,$scope.policyNo=$scope.userData.policyNo,$scope.rnBankAccNo=sessionData.poilicyChange.rnBankAccNo,$scope.manualBankData=sessionData.manualBankData,$scope.serialTransNo=$state.params.serialTransNo,$scope.phoneFlag=$scope.userData.phoneFlag;var vm=this;$scope.txCode="CCBSB000",$scope.cancel=function(){COMMON.hideModal()},vm.bankConfirm=function(callback){var params={oppAct:$scope.rnBankAccNo};CommonRequest.request(params,CONFIG.GYL_CONTRACT_NEWQRY,function(result){2!=result.data.SignState?(vm.SignFlag=!0,angular.isFunction(callback)&&callback(vm.SignFlag)):(vm.SignFlag=!1,angular.isFunction(callback)&&callback(vm.SignFlag))})},$scope.submit=function(){var phoneNo=this.phone,phoneCode=this.phoneCode;if(phoneNo&&phoneCode){this.userData.phoneIdCode=phoneCode,this.userData.phoneNo=phoneNo;var params=this.userData;if(PolicyService.removeSessionData("poilicyChange"),"CD"==params.config||"AS"==params.config)CommonRequest.request(params,CONFIG.CONTACT_CHANGE_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("PC"==params.config)vm.bankConfirm(function(SignFlag){var param={policyNo:params.policyNo,cusId:params.cusId,pbHoldName:params.pbHoldName,cretType:params.cretType,cretNo:params.cretNo,sex:params.sex,accType:params.accType,serialTransNo:$scope.serialTransNo,bankCode:params.bankCode,accName:params.accName,bankAccNo:params.bankAccNo,rnBankAccNo:params.rnBankAccNo,phoneNo:$scope.userData.phoneNo,phoneIdCode:$scope.userData.phoneIdCode,CCBSBCODE:"CCBSB000"};CommonRequest.request(param,CONFIG.RENEWAL_PAY_ACCOUNT_CONFIRM,function(result){if((result.status||1==result.status)&&result.data)if("1"==result.data.isCanUpdate)if(SignFlag){$timeout(function(){document.getElementById("attestation").onclick=function(){alertPopupTwo.close();var arrData=[$scope.rnBankAccNo];BankContractService.pushContract(arrData,"chance")}},1e3),$state.go("tab.service");var alertPopupTwo=$ionicPopup.confirm({title:"",subTitle:"您的变更申请已提交",cssClass:"approve",template:'可在变更进度查询中查看变更审核进度</br>为确保投保的保单能正常扣费承保</br><span id="attestation">请您进行 <span>银行卡号认证</span></span></br>',okText:"立即认证",cancelText:"<span></span>"});alertPopupTwo.then(function(res){if(res){var arrData=[$scope.rnBankAccNo];BankContractService.pushContract(arrData,"chance")}})}else{$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else if("2"==result.data.isCanUpdate)vm.renewalPayAccConfirm(result.data.recordId);else if("0"==result.data.isCanUpdate||"3"==result.data.isCanUpdate){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.resultDescrpt,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}})});else if("CT"==params.config||"RV"==params.config)"826"!=params.channelCode&&(params.channel=params.channelCode,PolicyChangeService.withdrawConfirm(params,function(result){if(1==result.status)if(1!=result.data.isError){if("1"==result.data.isCanUpdate){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else if("0"==result.data.isCanUpdate){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.resultDescrpt,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}})),"826"==params.channelCode&&(params={cancelConfirm:params},PolicyChangeService.cardWithdrawConfirm(params,function(result){if(1==result.status)if("1"==result.data.respCode){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else"0"==result.data.respCode&&($scope.cancel(),$state.go("tab.service"))}));else if("BX"==params.config)CommonRequest.request(params,CONFIG.CANCELRENEWAL_CHANGE_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("CM"==params.config)CommonRequest.request(params,CONFIG.CRET_CHANGE_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("BT"==params.config)params.reserveChannel=CONFIG.SALE_CHANNEL,CommonRequest.request(params,CONFIG.ORDER_APPLY_SERVICE_CONFIRM,function(result){if(1==result.status)if(1!=result.data.isError){if("1"==result.data.isCanAbandonPolicyReserve)$scope.cancel(),$state.go("policy-change-success");else if("0"==result.data.isCanAbandonPolicyReserve){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.description,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("AP"==params.config)CommonRequest.request(params,CONFIG.OVER_PREMIUM_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("BM"==params.config)CommonRequest.request(params,CONFIG.BONUS_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("FP"==params.config)CommonRequest.request(params,CONFIG.ADD_PREMIUM_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("PA"==params.config)CommonRequest.request(params,CONFIG.INVESTMENT_PROPORTIES_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("LN"==params.config)CommonRequest.request(params,CONFIG.BORROWS_CHANGE_CONFIRM_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("GC"==params.config)CommonRequest.request(params,CONFIG.BENIFIT_BANK_SERVCIE,function(result){if(1==result.status)if(1!=result.data.isError){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}});else if("DE"==params.config){var param={policyNo:$scope.userData.policyNo,cusId:$scope.userData.cusId,pbHoldName:$scope.userData.pbHoldName,cretType:$scope.userData.cretType,cretNo:sessionData.userData.cretNo,sex:$scope.userData.sex,newPayMode:$scope.userData.newPayMode,serialTransNo:$scope.userData.serialTransNo,phoneNo:$scope.userData.phoneNo,phoneIdCode:this.userData.phoneIdCode,CCBSBCODE:"CCBSB000"};CommonRequest.request(param,CONFIG.MEDICAL_DEDUCTION_CONFIRM,function(result){if(result.status||1==result.status)if("1"==result.data.isCanUpdate){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else if("2"==result.data.isCanUpdate)vm.medicalDeductionResultConfirm(result.data.recordId);else if("0"==result.data.isCanUpdate||"3"==result.data.isCanUpdate){$state.go("tab.service");$ionicPopup.confirm({template:result.data.resultDescrpt,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}})}else if("LA"==params.config){var param=params.fullPayment;PolicyChangeService.expireGetSubmit(param,function(res){if(1==res.data.isCanUpdate){$scope.cancel(),$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else $scope.cancel(),$state.go("tab.service");sessionStorage.removeItem("elife-serviceExpireGetData")})}}},vm.medicalconfirmNum=0,vm.medicalDeductionResultConfirm=function(recordId){var params={recordId:recordId};if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.medicalconfirmNum>=6){vm.medicalconfirmNum=0,$ionicLoading.hide();$ionicPopup.confirm({template:$rootScope.TIPS.SYSTEM.NETWORK_ERROR,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else CommonRequest.request(params,CONFIG.MEDICAL_DEDUCTION_CONFIRM_RESULT,function(result){if(result.status&&1==result.status){if("0"==result.data.isCanUpdate||"3"==result.data.isCanUpdate){$ionicLoading.hide(),$state.go("tab.service");$ionicPopup.confirm({template:result.data.resultDescrpt,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]});return}if("2"==result.data.isCanUpdate)return vm.medicalconfirmNum++,void $timeout(function(){$ionicLoading.hide(),vm.medicalDeductionResultConfirm(recordId)},1e4);$ionicLoading.hide(),$scope.cancel(),$state.go("tab.service"),vm.medicalconfirmNum=0;$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else{$ionicLoading.hide(),$scope.cancel(),$state.go("tab.service"),vm.medicalconfirmNum=0;$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"
}]})}},!0)},vm.renewalPayAccNum=0,vm.renewalPayAccConfirm=function(recordId){var params={recordId:recordId};if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.renewalPayAccNum>=6){vm.renewalPayAccNum=0,$ionicLoading.hide();$ionicPopup.confirm({template:$rootScope.TIPS.SYSTEM.NETWORK_ERROR,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}else CommonRequest.request(params,CONFIG.RENEWAL_PAY_ACCOUNT_CONFIRM_RESULT,function(result){if(result.status&&1==result.status){if("0"==result.data.isCanUpdate||"3"==result.data.isCanUpdate){$state.go("tab.service"),$ionicLoading.hide();$ionicPopup.confirm({template:result.data.resultDescrpt,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]});return}if("2"==result.data.isCanUpdate)return vm.renewalPayAccNum++,void $timeout(function(){$ionicLoading.hide(),vm.renewalPayAccConfirm(recordId)},1e4);$ionicLoading.hide(),vm.bankConfirm(function(SignFlag){if(SignFlag){$timeout(function(){document.getElementById("attestation").onclick=function(){alertPopupTwo.close();var arrData=[$scope.rnBankAccNo];BankContractService.pushContract(arrData,"chance")}},1e3),$state.go("tab.service");var alertPopupTwo=$ionicPopup.confirm({title:"",subTitle:"您的变更申请已提交",cssClass:"approve",template:'可在变更进度查询中查看变更审核进度</br>为确保投保的保单能正常扣费承保</br><span id="attestation">请您进行 <span>银行卡号认证</span></span></br>',okText:"立即认证",cancelText:"<span></span>"});alertPopupTwo.then(function(res){if(res){var arrData=[$scope.rnBankAccNo];BankContractService.pushContract(arrData,"chance")}})}else{$state.go("tab.service");$ionicPopup.confirm({template:"变更申请已提交！变更生效后会短信通知您，您也可以随时在保全进度查询中查看变更审核进度，谢谢！",title:"变更申请已提交",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}}),vm.renewalPayAccNum=0}else{$ionicLoading.hide(),$scope.cancel(),$state.go("tab.service"),vm.renewalPayAccNum=0;$ionicPopup.confirm({template:result.data.errorString,title:"",cssClass:"fontColor",buttons:[{text:"我知道了",type:"button-positive"}]})}},!0)},$scope.phoneAlert=function(val){1==val.invalid&&($scope.phoneAlertshow=!0,$timeout(function(){$scope.phoneAlertshow=!1},1500))},$scope.hide=function(){$scope.phoneAlertshow=!1},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.policyCustomerDetail=function(){if("826"==$scope.userData.channelCode){var policyNokd=sessionStorage.getItem("policyNokd");console.info(policyNokd);var params={policyNo:policyNokd}}else var params={policyNo:$scope.policyNo};CommonRequest.request(params,CONFIG.POLICY_CUSTOMER_DETAIL_SERVCIE,function(result){if(1==result.status){$scope.phone=result.data.holderMobile;var num=/(\d{3})\d*(\d{4})/;$scope.holderPhone=result.data.holderMobile.replace(num,"$1****$2"),$scope.showDrag=!0,$scope.getdragimg()}})},$scope.policyCustomerDetail()}angular.module("app").controller("PolicyMobileModalController",PolicyMobileModalController),PolicyMobileModalController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","TipService","PolicyChangeService","$timeout","$ionicPopup","$ionicLoading","$window","BankContractService"]}(),function(){function PolicyChangeContactController($scope,$state,CommonRequest,COMMON,$rootScope,CONFIG,PolicyService,TipService){var vm=this;vm.addressFlag=!1,vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel;var sessionData=PolicyService.getSessionData();return vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,vm.goBack=function(){history.back()},vm.policyNo?(vm.isPolicy=function(){var configPolicy={url:"../statics/json/PolicyAddChange.json",method:"GET"},params={};CommonRequest.request(params,configPolicy,function(result){result&&("Y"==result.isPolicyAddChange?(vm.policyConcat="通讯地址变更",vm.concatConfig="AS",vm.changeFlag=!0):(vm.policyConcat="联系方式变更",vm.concatConfig="CD",vm.changeFlag=!1))})},vm.isPolicy(),vm.showArea=function(){CommonRequest.request({},CONFIG.GET_AREA_SERVCIE,function(result){if("1"==result.status){vm.provinces=result.data;for(var i=0;i<vm.provinces.length;i++)vm.provinces[i].areaCode==vm.province&&(vm.area1=vm.provinces[i].areaName);CommonRequest.request({parentAreaCode:vm.province,areaLevel:2},CONFIG.GET_AREA_SERVCIE,function(result){if("1"==result.status){vm.cities=result.data;for(var i=0;i<vm.cities.length;i++)vm.cities[i].areaCode==vm.city&&(vm.area2=vm.cities[i].areaName,vm.provinceName=vm.area1+"-"+vm.area2)}})}})},vm.policyCustomerDetail=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.POLICY_CUSTOMER_DETAIL_EXT_SERVCIE,function(result){if("1"==result.status){vm.custmerInfo=result.data;var s=[];s=vm.custmerInfo.holderAreaCode.split(","),vm.email=vm.custmerInfo.holderEmail,vm.telephone=vm.custmerInfo.holderPhone,1==s.length?(vm.province=vm.custmerInfo.holderProvinceCode,vm.city=vm.custmerInfo.holderCityCode,vm.area=vm.custmerInfo.holderAreaCode):(vm.province=s[0],vm.custmerInfo.holderProvinceCode=s[0],vm.city=s[1],vm.custmerInfo.holderCityCode=s[1]),vm.area=vm.custmerInfo.holderAreaCode,vm.address=vm.custmerInfo.appPostalAddress,vm.zipCode=vm.custmerInfo.holderZipCode,vm.phone=vm.custmerInfo.holderMobile,vm.showArea()}})},vm.policyCustomerDetail(),vm.addressFlagFn2=function(){vm.addressFlag=!vm.addressFlag},vm.goset=function(){if(vm.email==vm.custmerInfo.holderEmail&&vm.telephone==vm.custmerInfo.holderPhone&&vm.province==vm.custmerInfo.holderProvinceCode&&vm.city==vm.custmerInfo.holderCityCode&&vm.address==vm.custmerInfo.holderAddress&&vm.zipCode==vm.custmerInfo.holderZipCode)TipService.showMsg("变更后的信息不能与之前相同！");else{var params={cusId:vm.custId,policyNo:vm.policyNo,mobile:vm.phone,email:vm.email,phone:vm.telephone,provinceCode:vm.province,cityCode:vm.city,countyCode:vm.area,postalAddress:vm.address,zipCode:vm.zipCode,config:vm.concatConfig,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel};PolicyService.control({state:"policy-change",control:"data",data:params}),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html")}},void $scope.$on("select-area-close",function(event,result){vm.province=result[0].areaCode,vm.city=result[1].areaCode,vm.area=result[2].areaCode})):void vm.goBack()}angular.module("app").controller("PolicyChangeContactController",PolicyChangeContactController),PolicyChangeContactController.$inject=["$scope","$state","CommonRequest","COMMON","$rootScope","CONFIG","PolicyService","TipService"]}(),function(){function PolicyChangeDeductionController($state,$scope,$log,CONFIG,CommonRequest,TipService,$rootScope,PolicyService,COMMON,$timeout,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.policyNo=$state.params.policyNo,vm.CurrentAccoInfo=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.CURRENT_RENEWAL_ACCOUNT_INFO,function(result){1==result.status&&(vm.currentRenewalPayType=result.data.currentRenewalPayType,1==vm.currentRenewalPayType?vm.currentRenewalPayCon="医保账户优先，余额不足时银行卡全额扣款":2==vm.currentRenewalPayType?vm.currentRenewalPayCon="仅医保账户扣款":3==vm.currentRenewalPayType&&(vm.currentRenewalPayCon="仅银行账户扣款")),vm.medicalDeductionPay()})},vm.CurrentAccoInfo(),vm.medicalDeductionNum=0,vm.medicalDeductionPay=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.MEDICAL_DEDUCTION_PAY,function(result){result.status&&1==result.status&&("1"==result.data.isCanUpdate?vm.deductionData=result.data:"2"==result.data.isCanUpdate?vm.medicalDeductionResult(result.data.recordId):"0"!=result.data.isCanUpdate&&"3"!=result.data.isCanUpdate||TipService.showMsg(result.data.resultDescrpt))})},vm.medicalDeductionResult=function(recordId){var params={recordId:recordId};return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.medicalDeductionNum>=6?(vm.medicalDeductionNum=0,$ionicLoading.hide(),void TipService.showMsg("操作失败")):void CommonRequest.request(params,CONFIG.MEDICAL_DEDUCTION_CONFIRM_RESULT,function(result){if(result.status&&1==result.status){if("0"==result.data.isCanUpdate||"3"==result.data.isCanUpdate)TipService.showMsg(result.data.resultDescrpt);else if("2"==result.data.isCanUpdate)return vm.medicalDeductionNum++,void $timeout(function(){vm.medicalDeductionResult(recordId)},1e3);$ionicLoading.hide(),vm.deductionData=result.data,vm.medicalDeductionNum=0}else $ionicLoading.hide(),vm.medicalDeductionNum=0},!0)},vm.deductionConfirm=function(){vm.currentRenewalPayType==vm.deductionMethon?TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.NOT_SMALL):showModal()};var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{policyNo:vm.policyNo,cusId:vm.userData.cusId,pbHoldName:vm.userData.customerName,cretType:vm.userData.cretType,sex:vm.userData.sex,newPayMode:vm.deductionMethon,serialTransNo:vm.deductionData.serialTransNo,config:"DE",CCBSBCODE:"CCBSB000"}})};vm.goBack=function(){history.back()}}angular.module("app").controller("PolicyChangeDeductionController",PolicyChangeDeductionController),PolicyChangeDeductionController.$inject=["$state","$scope","$log","CONFIG","CommonRequest","TipService","$rootScope","PolicyService","COMMON","$timeout","$ionicLoading"]}(),function(){function PolicyChangeExpiredController($state,$scope,$log,CONFIG,CommonRequest,TipService,$rootScope,PolicyService,COMMON){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel;var userData=PolicyService.getSessionData().userData;if(vm.custId=userData.cusId,vm.oldAutoPayFlag=0,!vm.policyNo)return void history.back();vm.goset=function(){vm.oldAutoPayFlag==vm.newAutoPayFlag?TipService.showMsg("对不起，您填写的变更后信息与变更前一致，请重新填写，谢谢！"):showModal()};var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,config:"AP",oldAutoPayFlag:vm.oldAutoPayFlag,newAutoPayFlag:vm.newAutoPayFlag,policyNo:vm.policyNo,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})};vm.goBack=function(){history.back()},vm.changePayFlag=function(flag){return flag="中止"==flag?"0":"1"},vm.showDetial=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_SERVCIE,function(result){1==result.status&&(vm.policyDetial=result.data,vm.oldAutoPayFlag=vm.changePayFlag(vm.policyDetial.outstandPolicy),vm.newAutoPayFlag=vm.oldAutoPayFlag)})},vm.showDetial()}angular.module("app").controller("PolicyChangeExpiredController",PolicyChangeExpiredController),PolicyChangeExpiredController.$inject=["$state","$scope","$log","CONFIG","CommonRequest","TipService","$rootScope","PolicyService","COMMON"]}(),function(){function PolicyChangeIdController($scope,CommonRequest,CONFIG,TipService,$ionicPopup,Upload,PolicyService,$ionicLoading,COMMON,$state,$rootScope,PolicyChangeService,$filter,VALIDATION,$timeout){function imgTest(val){var reg=new RegExp("(.jpg|.png|.jpeg|.JPG|.PNG|.JPEG|.gif|.GIF)$","g");return reg.test(val)}var vm=this;vm.idtype="A",vm.idexpire=1;var sessionData=PolicyService.getSessionData(),imagePath="/app/gmc2image/",userData=sessionData.userData;if(vm.saleChannel=$state.params.saleChannel,vm.imageList=[],vm.uploaded=0,vm.seriaTransNo=$state.params.seriaTransNo,!vm.seriaTransNo)return TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),void history.back();vm.policyNo=$state.params.policyNo,vm.editType="004",vm.idtypes=$rootScope.COMMON_DATA.ID_TYPES,vm.custId=$rootScope.userData.cusId,vm.checkContract=!1,vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.showAlert=function(){$ionicPopup.alert({title:"警告",template:"您申请变更的证件信息,将同步更新您名下所有保单相关的证件信息,请确认是否继续操作?",okText:"确认"})},vm.crsShowMsg=function(callback){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"请提供“个人税收居民身份声明文件”信息!",okText:"确定",cancelText:"取消"});alertPopup.then(function(res){res&&angular.isFunction(callback)&&callback()})},vm.submit=function(){2!=vm.ocrStatus&&"A"==vm.idtype&&(vm.certExpireDate="",vm.valueCer="2","A"==vm.customerDetail.holderIdType&&(vm.id=vm.lastCerNum)),"A"!=vm.idtype&&(vm.token=""),vm.filePath1=vm.filePath2=null,vm.imageList=[],vm.uploaded=0,1==vm.valueCer?vm.validity=new Date("2099-12-31"):vm.validity=vm.certExpireDate,vm.validity=$filter("date")(vm.validity,"yyyy-MM-dd"),vm.idtype==vm.customerDetail.holderIdType&&vm.id==vm.customerDetail.holderIdNum&&vm.validity==vm.policyDetail.appIdArriveDate?TipService.showMsg("变更后的信息不能与之前相同"):(vm.file1&&vm.file2?vm.imageList.push({F001:vm.file1},{F002:vm.file2}):$ionicLoading.show({template:"图片不能为空",duration:2e3}),"A"==vm.idtype&&vm.imageList.push({F003:vm.mosaicFile1}),vm.checkUpload(vm.uploaded))},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.imageList[uploaded],data),function(){vm.uploaded++})},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?(vm.imageFrontPath=path[i].imageTempPath,vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName):"F002"==path[i].imageFlag&&(vm.imageBackPath=path[i].imageTempPath,vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(result.data.error.message+result.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.goset=function(){return navigator.onLine?void vm.submit():void TipService.showMsg("当前网络不可用，请检查网络状态")};var showModal=function(){return"A"==vm.idtype&&vm.ocrName&&vm.customerDetail.holderName!=vm.ocrName?void TipService.showMsg("填写的姓名与投保人不一致！"):"A"!=vm.idtype||vm.customerDetail.holderBirthday==VALIDATION.getBirthday(vm.id)&&("男"==vm.customerDetail.holderGender?"1":"2")==VALIDATION.getSex(vm.id)?(1==vm.valueCer?vm.validity=new Date("2099-12-31"):vm.validity=vm.certExpireDate,vm.validity=$filter("date")(vm.validity,"yyyy-MM-dd"),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),void PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,config:"CM",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.idtype,cretNo:"A"==vm.idtype?vm.id.toUpperCase():vm.id,cretArriveDate:vm.validity,birthday:vm.customerDetail.holderBirthday,oldTransNo:vm.seriaTransNo,idImgFront:vm.filePath1,idImgBack:vm.filePath2,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel,token:vm.token}})):void TipService.showMsg("该证件信息与投保时的信息不符！")};vm.goBack=function(){history.back()},vm.getPolicyDetail=function(callback){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.planCode=vm.policyDetail.mainClassCode,"2099-12-31"!=vm.policyDetail.appIdArriveDate?(vm.certExpireDate=new Date(vm.policyDetail.appIdArriveDate),vm.valueCer="2",vm.lastCertExpireDate=vm.policyDetail.appIdArriveDate?new Date(vm.policyDetail.appIdArriveDate):"",vm.lastExpireType="2"):(vm.valueCer="1",vm.certExpireDate=new Date("2099-12-31"),vm.lastExpireType="1",vm.lastCertExpireDate=new Date("2099-12-31")),angular.isFunction(callback)&&callback())})},vm.getPolicyDetail(function(){var params={policyNo:vm.policyNo};PolicyChangeService.riskDetail(params,function(data){vm.riskDetail=data}),PolicyChangeService.policyCustomerDetail(params,function(data){vm.customerDetail=data,vm.id=vm.policyDetail.holderIdNo,"身份证"==vm.customerDetail.holderIdType?(vm.idtype="A",vm.customerDetail.holderIdType="A"):"护照"==vm.customerDetail.holderIdType?(vm.idtype="I",vm.customerDetail.holderIdType="I"):"港澳台通行证"==vm.customerDetail.holderIdType?(vm.idtype="G",vm.customerDetail.holderIdType="G"):"外国人永久居留身份证"==vm.customerDetail.holderIdType?(vm.idtype="N",vm.customerDetail.holderIdType="N"):(vm.idtype="R",vm.customerDetail.holderIdType="R"),vm.preIdtype=vm.idtype,vm.showLastInfo(vm.customerDetail,vm.id)})}),vm.seriaTransNo||(TipService.showMsg("申请失效"),$state.go("tab.service")),vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},$scope.$watch("policyChangeId.uploaded",function(newValue,oldValue){if(newValue)if(newValue!=oldValue&&newValue<vm.imageList.length)vm.checkUpload(newValue);else if(newValue==vm.imageList.length){if(vm.idtype!=vm.customerDetail.holderIdType||vm.id!=vm.customerDetail.holderIdNum){var params={planCode:vm.planCode,cusId:vm.custId,crsType:"1"};PolicyChangeService.validateCrsInfo(params,function(result){result?(sessionStorage.setItem("elife-ocrStatus",vm.token),vm.crsShowMsg(function(){$state.go("person-revenue-distinguish",{policyNo:vm.policyNo,changeType:"1",cretType:vm.idtype,cretNo:"A"==vm.idtype?vm.id.toUpperCase():vm.id,cretArriveDate:vm.validity,oldTransNo:vm.seriaTransNo,idImgFront:vm.filePath1,idImgBack:vm.filePath2,saleChannel:vm.saleChannel})})):"A"==vm.idtype&&(2!=vm.ocrStatus||vm.isImgChange)?vm.ocrSwitch():showModal()})}else"A"==vm.idtype&&(2!=vm.ocrStatus||vm.isImgChange)?vm.ocrSwitch():showModal();vm.isImgChange=!1}}),vm.ShowOcrMsg=function(type,templateMsg,info){var alertPopup;if(1==type)alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新识别"});else if(2==type)alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:templateMsg,okText:"重新上传"});else if(3==type){var name="",num="",expireT="";if(info&&(name=info.name,num=info.idCardNo,info.expiryDate&&8==info.expiryDate.replace("/(^s*)|(s*$)/g","").length)){var t=info.expiryDate.substring(0,4)+"-"+info.expiryDate.substring(4,6)+"-"+info.expiryDate.substring(6,8);expireT=t}vm.ocrPopup=$ionicPopup.show({title:'<div><span class="ocr-warn-icon">&nbsp;</span>'+templateMsg+"</div>",template:'<div>已识别信息</div><div class="ocr-dialog-item"><span>姓名</span><span>'+name+'</span></div><div class="ocr-dialog-item"><span>证件号码</span><span>'+num+'</span></div><div class="ocr-dialog-item"><span>证件有效期</span><span>'+expireT+'</span></div><div class="ocr-dialog-btn-box"><button class="button" ng-click="alertCallback()">重新上传</button></div>',scope:$scope,cssClass:"ocr-dialog",buttons:[{text:"更正信息",onTap:function(res){vm.ocrStatus=2}}]})}alertPopup&&alertPopup.then(function(res){1==type?vm.idCardRecognize():2==type&&$scope.alertCallback()})},vm.showIdMask=function(){vm.idMask=!0},vm.hideIdMask=function(){vm.idMask=!1},vm.fileChange=function(file){if(file&&"A"==vm.idtype){if(file.$ngfOrigSize>5242880){vm.tipsDivShow=!0,vm.tipsDiv="上传的图片不能大于5M";var timer=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer)},3e3)}if(!imgTest(file.type)){vm.tipsDiv="您上传的图片类型错误",vm[key]=null;var timer2=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer2)},3e3)}COMMON.identityImg(file,function(img,bolbVal){var timer=$timeout(function(){vm.mosaicImg1=img,$timeout.cancel(timer)},100);bolbVal.name="a.png",vm.mosaicFile1=bolbVal})}},$scope.alertCallback=function(alertPopup){vm.ocrPopup&&(vm.ocrPopup.close(),vm.ocrPopup=null),vm.file1=null,vm.file2=null,vm.uploadMsg=""},vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){result&&1==result.status&&("Y"==result.data?(vm.ocrOpenState=!0,vm.idCardRecognize()):"N"==result.data&&(vm.ocrOpenState=!1,vm.ocrError()))})},vm.clearOcrData=function(){vm.ocrStatus=null,vm.ocrName="",vm.id="",vm.certExpireDate="",vm.valueCer="2"},vm.ocrError=function(){vm.ocrStatus=2,vm.ocrName="",vm.id="",vm.certExpireDate="",vm.valueCer="2"},vm.ocrInfoShow=function(obj){if(vm.ocrName=obj.name||"",vm.id=obj.idCardNo||"",vm.valueCer="2",obj.expiryDate&&8==obj.expiryDate.replace("/(^s*)|(s*$)/g","").length){var t=obj.expiryDate.substring(0,4)+"-"+obj.expiryDate.substring(4,6)+"-"+obj.expiryDate.substring(6,8);vm.certExpireDate=new Date(t)}else vm.certExpireDate=""},vm.errorTimes=function(){if(3==vm.getPolicyResultTimes){vm.messageErr=!0,vm.ocrStatus=2;var timer=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer)},3e3);return!0}if(3==vm.getOtherResultTimes){vm.messageErr=!0,vm.ocrError();var timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3);return!0}return!1},vm.idCardRecognize=function(){if(vm.recognizeFlg=!1,vm.ocrOpenState){var u_data=sessionData.userData;vm.openId=sessionStorage.getItem("elife-openid");var params={idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,referenName:u_data.customerName,referenSex:u_data.sex,referenBirthday:u_data.birthday,referenCerid:u_data.cretNo,referenCertype:u_data.cretType,custId:u_data.cusId,openId:vm.openId,sceneCode:"SC002",channelCode:"811"};if(vm.errorTimes())return;vm.getOtherResultTimes||(vm.getOtherResultTimes=0),vm.timeoutdata="",vm.clearOcrData(),$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner><div class="ocr-load-text">努力识别中...</div>'}),CommonRequest.request(params,CONFIG.BD_IDCARD_RECOGNIZE,function(result){if($ionicLoading.hide(),vm.timeoutdata=result,"1"==result.status){var recognizeData=result.data;if(vm.token=recognizeData.tocken,"000000"==recognizeData.responseStatus){var userdata=vm.customerDetail||{},bith_date=userdata.holderBirthday.replace(/-/g,"");if(userdata.holderName==recognizeData.name&&userdata.holderGender==recognizeData.gender&&bith_date==recognizeData.birthday)vm.ocrStatus=1,vm.ocrInfoShow(recognizeData),showModal();else if(vm.getPolicyResultTimes?vm.getPolicyResultTimes++:vm.getPolicyResultTimes=1,3==vm.getPolicyResultTimes){vm.messageErr=!0,vm.ocrStatus=2,vm.ocrInfoShow(recognizeData);var timer=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer)},3e3)}else vm.ShowOcrMsg(2,"请上传投保人的有效证件")}else"111111"==recognizeData.responseStatus&&(vm.ocrInfoShow(recognizeData),vm.ShowOcrMsg(3,"您好，身份证核查未通过，请检查后重新上传",recognizeData)),"222222"==recognizeData.responseStatus&&(vm.ocrInfoShow(recognizeData),vm.ShowOcrMsg(3,"您上传的身份证件已过有效期，请检查",recognizeData)),"333333"==recognizeData.responseStatus&&(vm.getOtherResultTimes++,vm.getOtherResultTimes<3&&vm.ShowOcrMsg(1,"识别失败，请重新识别")),"555555"!=recognizeData.responseStatus&&"666666"!=recognizeData.responseStatus||vm.ShowOcrMsg(2,"请上传正确且清晰的身份证正反面照片")}else vm.getOtherResultTimes++;if(3==vm.getOtherResultTimes){vm.messageErr=!0,vm.ocrError();var timer1=$timeout(function(){vm.messageErr=!1,$timeout.cancel(timer1)},3e3)}},!0)}},vm.showLastInfo=function(info,id){vm.lastCerNum=id,info&&(vm.lastName=info.holderName,vm.lastSex=info.holderGender,vm.lastBirthday=info.holderBirthday,vm.lastCerType=info.holderIdType)},vm.idtypeChange=function(){"A"!=vm.idtype&&"A"==vm.preIdtype&&(vm.id="",vm.valueCer="2",vm.certExpireDate="",vm.ocrStatus=null,vm.getPolicyResultTimes=0,vm.getOtherResultTimes=0),"A"==vm.idtype&&(vm.file1=null,vm.file2=null,vm.mosaicImg1=null),vm.preIdtype=vm.idtype},vm.changeIdExpire=function(){"2"==vm.valueCer?vm.valueCer="1":vm.valueCer="2"},vm.fullImage=!1,vm.currentFullImage="",vm.isImgChange=!0,vm.changePic=function($event,file){vm.currentFullImage=file;var img=$event.srcElement||$event.target;$scope.bigimage=img.src,vm.fullImage=!0},vm.delUpload=function(){vm.isImgChange=!0,$scope.bigimage="",vm[vm.currentFullImage]=null,vm.fullImage=!1},vm.closePic=function(){vm.fullImage=!1}}angular.module("app").controller("PolicyChangeIdController",PolicyChangeIdController),PolicyChangeIdController.$inject=["$scope","CommonRequest","CONFIG","TipService","$ionicPopup","Upload","PolicyService","$ionicLoading","COMMON","$state","$rootScope","PolicyChangeService","$filter","VALIDATION","$timeout"]}(),function(){function PolicyChangeInvestRatioController($state,COMMON,$scope,$log,CONFIG,CommonRequest,TipService,$rootScope,PolicyService){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel;var userData=PolicyService.getSessionData().userData;return vm.custId=userData.cusId,vm.policyNo?(vm.goset=function(){var type1=vm.value1,type2=vm.value2,type3=vm.value3,type4=vm.value4,allScale=parseInt(type1,10)+parseInt(type2,10)+parseInt(type3,10)+parseInt(type4,10);type1&&type2&&type3&&type4?100!=allScale?TipService.showMsg("对不起，投资账户比例之和需为100%，请重新填写，谢谢！"):type1%5!=0||type2%5!=0||type3%5!=0||type4%5!=0?TipService.showMsg("对不起，投资账户比例需为5%的整数倍，请重新填写，谢谢！"):type1==vm.rate01&&type2==vm.rate02&&type3==vm.rate03&&type4==vm.rate04?TipService.showMsg("对不起，您填写的变更后信息与变更前一致，请重新填写，谢谢！"):vm.showModal():TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.NULL_RATIO)},vm.showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,policyNo:vm.policyNo,rateIL04:vm.value1,rateIL03:vm.value2,rateIL02:vm.value3,rateIL01:vm.value4,rateIL00:"0",config:"PA",CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})},vm.goBack=function(){history.back()},vm.showRatio=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.INVESTPOLICY_CHANGE_APPLY_SERVCIE,function(result){if(1==result.status)for(var tra=result.data,i=0;i<tra.length;i++)"IL01"==tra[i].accountOrder?vm.rate04=tra[i].investScale:"IL02"==tra[i].accountOrder?vm.rate03=tra[i].investScale:"IL03"==tra[i].accountOrder?vm.rate02=tra[i].investScale:"IL04"==tra[i].accountOrder&&(vm.rate01=tra[i].investScale)})},void vm.showRatio()):void history.back()}angular.module("app").controller("PolicyChangeInvestRatioController",PolicyChangeInvestRatioController),PolicyChangeInvestRatioController.$inject=["$state","COMMON","$scope","$log","CONFIG","CommonRequest","TipService","$rootScope","PolicyService"]}(),function(){function PolicyChangePledgeController($state,$stateParams,$scope,CommonRequest,PolicyChangeService,COMMON,CONFIG,$rootScope,TipService,PolicyService,$timeout,$interval){var vm=this,userData=PolicyService.getSessionData().userData,timerScroll=null;if(vm.policyNo=$stateParams.policyNo,vm.seriaTransNo=$stateParams.seriaTransNo,vm.saleChannel=$state.params.saleChannel,vm.custId=userData.cusId,vm.editType="003",vm.checkContract=!1,vm.goBack=function(){history.back()},vm.scrollControl=function(){var wrapScroll=document.querySelector(".scroll-wrap"),first=document.querySelector(".wrap-begin"),end=document.querySelector(".wrap-end");end.innerHTML=first.innerHTML,timerScroll=$interval(function(){end.offsetWidth-wrapScroll.scrollLeft<=0?wrapScroll.scrollLeft=wrapScroll.scrollLeft-first.offsetWidth:wrapScroll.scrollLeft++},40)},vm.scrollControl(),$scope.$on("$destroy",function(){$interval.cancel(timerScroll)}),!vm.seriaTransNo||!vm.policyNo)return TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),void vm.goBack();vm.premMoney=$stateParams.premMoney;var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.btk=vm.policyDetail.saleBranchCode.substring(0,4))}),PolicyChangeService.policyCustomerDetail($state.params,function(data){vm.customerDetail=data}),vm.goset=function(){PolicyService.control({state:"policy-change-pledge",control:"data",data:{borrowsAmount:vm.applyMoney}}),$state.go("policy-change-pledge-info",{policyNo:vm.policyNo,seriaTransNo:vm.seriaTransNo,premMoney:vm.premMoney,saleChannel:vm.saleChannel})}}angular.module("app").controller("PolicyChangePledgeController",PolicyChangePledgeController),PolicyChangePledgeController.$inject=["$state","$stateParams","$scope","CommonRequest","PolicyChangeService","COMMON","CONFIG","$rootScope","TipService","PolicyService","$timeout","$interval"]}(),function(){function PolicyChangeRenewalController($state,$scope,COMMON,CONFIG,CommonRequest,PolicyChangeService,$rootScope,$ionicPopup,$ionicLoading,TipService,PolicyService){var vm=this;if(vm.seriaTransNo=$state.params.seriaTransNo,vm.saleChannel=$state.params.saleChannel,vm.oldRnewFlags=$state.params.oldRnewFlags,vm.riskCodes=$state.params.riskCodes,vm.risksFlagList=$state.params.risksFlagList,vm.risksList=$state.params.risksList,vm.statesArr=[],vm.applyState=[],vm.buttonDisabled=!1,vm.applyChecked=0,vm.polno=$state.params.polno,vm.mainPolno=$state.params.mainPolno,vm.titleFlag=[],vm.valStates=[],vm.idtype="A",!vm.seriaTransNo)return TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),void history.back();vm.policyNo=$state.params.policyNo;var userData=PolicyService.getSessionData().userData;vm.custId=userData.cusId,vm.checkBox=function(ls,len){ls.checked=!ls.checked,vm.applyState=[];for(var i=0;i<vm.policyLists.length;i++)0==vm.policyLists[i].checked&&vm.applyState.push(vm.policyLists[i].checked),0!=vm.applyChecked&&1==vm.policyLists[i].checked&&vm.alikeState(vm.applyChecked);vm.applyState.length==len?(vm.applyCheckedState(0,1),vm.buttonDisabled=!1):vm.buttonDisabled=!0},vm.applyCheckedState=function(val,sta){vm.valStates=[],vm.titleFlag=[],vm.applyState=[],vm.applyChecked=val;for(var i=0;i<vm.policyLists.length;i++)0==vm.policyLists[i].checked?vm.applyState.push(vm.policyLists[i].checked):1==vm.policyLists[i].checked&&vm.alikeState(val);if(vm.applyState.length==vm.policyLists.length&&0==sta){if(0!=sta)return void(vm.applyChecked=0);$ionicLoading.show({template:"请先选择变更产品",duration:2e3}),vm.applyChecked=0}},vm.alikeState=function(val){for(var i=0;i<vm.policyLists.length;i++)1==vm.policyLists[i].checked&&(vm.titleFlag.push(vm.policyLists[i].oldRnewFlag),vm.valStates.push(val));for(var i=0;i<vm.titleFlag.length;i++)"0"==vm.titleFlag[i]?vm.titleFlag[i]=2:vm.titleFlag[i]=1;return vm.titleFlag.toString()==vm.valStates.toString()?($ionicLoading.show({template:"您选择的续保变更状态与当前险种状态一致，无需变更",duration:2e3}),vm.applyChecked=0,void(val=0)):(vm.titleFlag=[],void(vm.valStates=[]))},vm.goset=function(val){vm.policyIds=[],vm.policyName=[];for(var i=0;i<vm.policyLists.length;i++)1==vm.policyLists[i].checked&&vm.policyName.push(vm.policyLists[i].addClassName),vm.policyIds.push(vm.policyLists[i].addClassCode);if(vm.policyLists.length>1)for(var i=1;i<vm.policyLists.length;i++){var applyAdd=0==vm.policyLists[0].oldRnewFlag&&0==vm.policyLists[0].checked&&0==vm.policyLists[i].oldRnewFlag&&1==vm.policyLists[i].checked&&1==vm.applyChecked,applyAddN=1==vm.policyLists[0].oldRnewFlag&&1==vm.policyLists[0].checked&&1==vm.policyLists[i].oldRnewFlag&&0==vm.policyLists[i].checked&&2==vm.applyChecked;if(1==applyAdd||1==applyAddN)return void $ionicLoading.show({template:"主险不自动续保，附加险不可自动续保",duration:2e3})}if(null!=vm.policyIds){if(1==val)var alertPopup=$ionicPopup.confirm({title:"警告",template:"您选择的 "+vm.policyName+" 自"+vm.policyDetail.beginDate+"至"+vm.policyDetail.endDate+"年度起及后续年度将自动续保，请确认是否申请，谢谢",
okText:"确认",cancelText:"取消"});else var alertPopup=$ionicPopup.confirm({title:"警告",template:"您选择的 "+vm.policyName+" 自"+vm.policyDetail.beginDate+"至"+vm.policyDetail.endDate+"年度起及后续年度将不再续保，请确认是否申请，谢谢",okText:"确认",cancelText:"取消"});alertPopup.then(function(res){res&&vm.showModal(vm.policyLists)})}},vm.showModal=function(lis){for(var _data,renewalFlagList=[],renewalFlagMain="",i=0;i<lis.length;i++)1==lis[i].checked&&1==vm.applyChecked?(lis[i].checked=1,renewalFlagList.push(lis[i].checked)):1!=lis[i].checked&&0!==lis[i].checked||2!=vm.applyChecked?renewalFlagList.push(Number(lis[i].oldRnewFlag)):(lis[i].checked=0,renewalFlagList.push(lis[i].checked));renewalFlagMain=String(renewalFlagList[0]),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:(_data={cusId:vm.custId,config:"BX",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,renewalFlagList:renewalFlagList.slice(1).join(","),sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.changeId(vm.customerDetail.holderIdType),cretNo:vm.customerDetail.holderIdNum,cretArriveDate:vm.policyDetail.appIdArriveDate},_defineProperty(_data,"cretNo",vm.customerDetail.holderIdNum),_defineProperty(_data,"cretArriveDate",vm.policyDetail.appIdArriveDate),_defineProperty(_data,"birthday",vm.customerDetail.holderBirthday),_defineProperty(_data,"oldTransNo",vm.seriaTransNo),_defineProperty(_data,"riskList",vm.policyIds.slice(1).join(",")),_defineProperty(_data,"CCBSBCODE","CCBSB000"),_defineProperty(_data,"channelCode",vm.saleChannel),_defineProperty(_data,"risksFlagList",renewalFlagMain),_defineProperty(_data,"risksList",vm.risksList),_defineProperty(_data,"mainPolno",vm.mainPolno),_defineProperty(_data,"polno",vm.polno),_data)})},vm.changeId=function(id){return id="身份证"==id?"A":"护照"==id?"I":"G"},vm.goBack=function(){history.back()},vm.getPolicyDetail=function(callback){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,angular.isFunction(callback)&&callback())})},vm.getPolicyDetail(function(){var params={policyNo:vm.policyNo,editType:vm.editType},params={policyNo:vm.policyNo};PolicyChangeService.riskDetail(params,function(data){vm.riskDetail=data;for(var renewalMain,i=0;i<vm.riskDetail.length;i++)for(var j=0;j<vm.oldRnewFlags.length;j++)vm.riskDetail[i].addClassCode!=vm.risksList&&(vm.riskDetail[i].oldRnewFlag=vm.oldRnewFlags[j]);for(var i=0;i<vm.riskDetail.length;i++)vm.riskDetail[i].checked=!1,vm.oldRnewFlags.split(","),vm.riskDetail[i].addClassCode==vm.risksList&&(vm.riskDetail[i].oldRnewFlag=vm.risksFlagList,renewalMain=vm.riskDetail[i]),1==vm.riskDetail[i].oldRnewFlag?vm.riskDetail[i].oldRnew="自动续保":vm.riskDetail[i].oldRnew="不自动续保";for(var i=0;i<vm.riskDetail.length;i++)vm.riskDetail[i]==renewalMain&&vm.riskDetail.splice(i,1);vm.riskDetail.unshift(renewalMain),vm.policyLists=vm.riskDetail}),PolicyChangeService.policyCustomerDetail(params,function(data){vm.customerDetail=data}),CommonRequest.request(params,CONFIG.POLICY_CUSTOMER_DETAIL_EXT_SERVCIE,function(result){1==result.status&&(vm.customerDetail=result.data)})}),vm.seriaTransNo||(TipService.showMsg("申请失效"),$state.go("tab.service"))}angular.module("app").controller("PolicyChangeRenewalController",PolicyChangeRenewalController),PolicyChangeRenewalController.$inject=["$state","$scope","COMMON","CONFIG","CommonRequest","PolicyChangeService","$rootScope","$ionicPopup","$ionicLoading","TipService","PolicyService"]}(),function(){function PolicyChangeTransferAccountController($state,$scope,$log,CONFIG,CommonRequest,COMMON,$filter,$rootScope,PolicyService,$timeout,$ionicSlideBoxDelegate){var vm=this;vm.policyNo=$state.params.policyNo,vm.saleChannel=$state.params.saleChannel;var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,vm.custId=vm.userData.cusId,vm.bankcode="",vm.bankAccount="",!vm.policyNo)return void history.back();vm.goset=function(){return vm.bankcode?("0"==vm.choose?vm.choose="1":"3"==vm.choose&&(vm.choose="2"),void showModal()):void TipService.showMsg("请选择开户银行")},vm.showDetial=function(){if($rootScope.isLogin){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_SERVCIE,function(result){1==result.status&&(vm.policyDetial=result.data,vm.btk=vm.policyDetial.saleBranchCode.substring(0,4),vm.getBankList(),vm.accName=vm.policyDetial.bankAccName&&"--"!=vm.policyDetial.bankAccName?vm.policyDetial.bankAccName:$rootScope.userData.customerName)})}else $timeout(function(){vm.showDetial()},1e3)},vm.showDetial();var showModal=function(){COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"),PolicyService.control({state:"policy-change",control:"data",data:{cusId:vm.custId,bankCode:vm.bankcode,config:"GC",accName:vm.accName,accNo:vm.bankAccount,policyNo:vm.policyNo,queryType:vm.choose,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel}})};vm.goBack=function(){history.back()},vm.getBankList=function(){vm.btk?(vm.bankList,COMMON.getCommonBank(vm.btk,"1",function(bankList){vm.bankList=bankList})):$timeout(function(){vm.getBankList()},100)},vm.index=0,vm.showTra=function(){if($rootScope.isLogin){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.BENEFIT_CUSLIST_MASK_SERVCIE,function(result){1==result.status&&(vm.tra=result.data,vm.choose=vm.tra[0].bnfType,"--"!=vm.tra[0].bankCodeNum&&(vm.bankcode=vm.tra[0].bankCodeNum,vm.bankName=vm.tra[0].bankName),"--"!=vm.tra[0].bankAccNo&&(vm.bankAccount=vm.tra[0].bankAccNo),$ionicSlideBoxDelegate.update())})}else $timeout(function(){vm.showTra()},1e3)},vm.showTra(),vm.bankListShow=!1,vm.change=function(index){vm.index=index,vm.bankListShow=!1,vm.choose=vm.tra[index].bnfType,"--"!=vm.tra[index].bankCodeNum?(vm.bankcode=vm.tra[index].bankCodeNum,vm.bankName=vm.tra[index].bankName):(vm.bankcode="",vm.bankName=""),"--"!=vm.tra[index].bankAccNo?vm.bankAccount=vm.tra[index].bankAccNo:vm.bankAccount=""}}angular.module("app").controller("PolicyChangeTransferAccountController",PolicyChangeTransferAccountController),PolicyChangeTransferAccountController.$inject=["$state","$scope","$log","CONFIG","CommonRequest","COMMON","$filter","$rootScope","PolicyService","$timeout","$ionicSlideBoxDelegate"]}(),function(){function PolicyChangeSuccessController($state,$rootScope,$scope,$ionicModal,$log,CONFIG,CommonRequest,TipService,$window){}angular.module("app").controller("PolicyChangeSuccessController",PolicyChangeSuccessController),PolicyChangeSuccessController.$inject=["$state","$rootScope","$scope","$ionicModal","$log","CONFIG","CommonRequest","TipService","$window"]}(),function(){function PolicyChangeWithdrawController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout,$ionicPopup,$interval,$ionicModal){function imgTest(val){var reg=new RegExp("(.jpg|.png|.jpeg|.JPG|.PNG|.JPEG|.gif|.GIF)$","g");return reg.test(val)}var vm=this,sessionData=PolicyService.getSessionData(),userData=sessionData.userData;vm.policyServeData=sessionData.policyServeData;var imagePath="/app/gmc2image/",timerScroll=null;return vm.policyNo=vm.policyServeData.policyNo,vm.seriaTransNo=vm.policyServeData.seriaTransNo,vm.backMoneyModel=vm.policyServeData.backMoneyModel,vm.abandonMode=vm.policyServeData.abandonMode,vm.backMoneyMode=vm.policyServeData.backMoneyMode,vm.imageInfo=vm.policyServeData.imageInfo,vm.filePath1=vm.policyServeData.filePath1,vm.filePath2=vm.policyServeData.filePath2,vm.saleChannel=vm.policyServeData.saleChannel,vm.realPayMoney=vm.policyServeData.backMoneyModel.realPayMoney,vm.imageList=[],vm.seriaTransNo&&vm.policyNo&&vm.backMoneyModel&&vm.abandonMode?(vm.btnisshow=!1,vm.btnisshowtext="点击查看全部",vm.btnisshowchange=function(){vm.btnisshow=!vm.btnisshow,vm.btnisshow?vm.btnisshowtext="点击收起":vm.btnisshow||(vm.btnisshowtext="点击查看全部")},vm.scrollControl=function(){var wrapScroll=document.querySelector(".scroll-wrap"),first=document.querySelector(".wrap-begin"),end=document.querySelector(".wrap-end");end.innerHTML=first.innerHTML,timerScroll=$interval(function(){end.offsetWidth-wrapScroll.scrollLeft<=0?wrapScroll.scrollLeft=wrapScroll.scrollLeft-first.offsetWidth:wrapScroll.scrollLeft++},40)},vm.scrollControl(),$scope.$on("$destroy",function(){$interval.cancel(timerScroll)}),"001"!=vm.abandonMode&&"000"!=vm.abandonMode||(vm.identityAdjust=!0),vm.uploaded=0,"000"==vm.abandonMode?vm.hesitateFlg="0":vm.hesitateFlg="1",vm.backWays=function(){vm.abandonMode&&"001"==vm.abandonMode?(vm.withdrawWay="1",vm.withdrawWayTest="授权转账"):(vm.withdrawWay="0",vm.withdrawWayTest="原卡原退")},vm.backWays(),vm.minStartDate=new Date,vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.changeId=function(id){return id="身份证"==id?"A":"护照"==id?"I":"外国人永久居留身份证"==id?"N":"港澳台通行证"==id?"G":"R"},vm.applyWithdraw=function(){vm.agree||"1"!=vm.withdrawWay?((vm.renewMask=!0)&&(vm.renewMask=!1),vm.showModal()):vm.renewMask=!0},vm.goSet=function(){if("1"==vm.withdrawWay&&!vm.backMoneyModel.payChannel&&!vm.bankcode)return void TipService.showMsg("请选择开户银行");if(!navigator.onLine)return void TipService.showMsg("当前网络不可用，请检查网络状态");if("A"!=vm.idtype&&(vm.token=""),vm.imageInfo||(vm.filePath1=vm.filePath2=null),vm.imageInfo||(vm.filePath1=vm.filePath2=null),vm.imageList=[],vm.uploaded=0,"1"==vm.idexpire?vm.certExpireDate=new Date("2099/12/31"):vm.certExpireDate||(vm.certExpireDate=vm.policyDetail.appIdArriveDate),vm.repeal)if(vm.imageInfo)vm.applyWithdraw();else{if(!vm.file1||!vm.file2)return void $ionicLoading.show({template:"图片不能为空",duration:2e3});vm.imageList.push({F001:vm.file1},{F002:vm.file2}),"A"==vm.idtype&&vm.imageList.push({F003:vm.mosaicFile1}),PolicyService.isAllowUpload(vm.imageList.length,function(){vm.checkUpload(vm.uploaded)})}else"005"==vm.abandonMode?vm.applyWithdraw():"000"==vm.abandonMode&&parseFloat(vm.backMoneyModel.premMoney)<1e4&&vm.applyWithdraw()},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.imageList[uploaded],data),function(){vm.uploaded++})},vm.showModal=function(){var params={};params="005"==vm.abandonMode?{contYearCount:$rootScope.ContYearCount,abandonMode:vm.abandonMode,cusId:vm.custId,config:"CT",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.idtype?vm.idtype:vm.changeId(vm.customerDetail.holderIdType),cretNo:vm.id?vm.id:vm.customerDetail.holderIdNum,pbCretIdArriveDate:vm.certExpireDate?$filter("date")(vm.certExpireDate,"yyyy-MM-dd"):vm.policyDetail.appIdArriveDate,birthday:vm.customerDetail.holderBirthday,oldTransNo:vm.seriaTransNo,changeReason:vm.reason,CCBSBCODE:"CCBSB000",realPayMoney:vm.realPayMoney,channelCode:vm.saleChannel,token:vm.token,phoneFlag:"1"}:{contYearCount:$rootScope.ContYearCount,abandonMode:vm.abandonMode,cusId:vm.custId,config:"CT",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.idtype?vm.idtype:vm.changeId(vm.customerDetail.holderIdType),cretNo:vm.id?vm.id:vm.customerDetail.holderIdNum,pbCretIdArriveDate:vm.certExpireDate?$filter("date")(vm.certExpireDate,"yyyy-MM-dd"):vm.policyDetail.appIdArriveDate,birthday:vm.customerDetail.holderBirthday,pbBankCode:vm.bankcode?vm.bankcode:"",pbBankAccount:vm.bankAccount?vm.bankAccount:"",oldTransNo:vm.seriaTransNo,changeReason:vm.reason,imagePath1:vm.filePath1,imagePath2:vm.filePath2,CCBSBCODE:"CCBSB000",CTPDFlag:"0"==vm.withdrawWay?"1":"2",hesitateFlg:vm.hesitateFlg,realPayMoney:vm.realPayMoney,channelCode:vm.saleChannel,token:vm.token,phoneFlag:"1"},PolicyService.control({state:"policy-change",control:"data",data:params}),vm.showlose?vm.pledgeModal("您本次退保申请将遭受损失,请慎重申请。如遇到资金困难，建信为您提供保单质押贷款服务，您可以选择此业务来缓解压力，谢谢!"):COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html")},vm.pledgeModal=function(templateMsg){var alertPopup=$ionicPopup.confirm({title:"温馨提示",cssClass:"ocr-notice-show",template:templateMsg,okText:"<span  >确认退保</span>",cancelText:"<span class='shallow-grey1'>取消</span>"});alertPopup.then(function(res){res&&(vm.renewMask=!1,alertPopup.close(),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html"))})},vm.getProductConfig=function(callback){var params={prdCode:vm.riskCode,planType:vm.planType,prdType:vm.prdType};CommonRequest.request(params,CONFIG.PRODUCT_CONFIG_SERVCIE,function(result){1==result.status&&(1==result.data.isChangeInvestaccount?vm.isChangeInvestaccount=!0:vm.isChangeInvestaccount=!1,1==result.data.isChangeInvestbalance?vm.isChangeInvestbalance=!0:vm.isChangeInvestbalance=!1,1==result.data.isChangeOnlineLoan?vm.isChangeOnlineLoan=!0:vm.isChangeOnlineLoan=!1,angular.isFunction(callback)&&callback())})},vm.getPolicyDetail=function(callback){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.btk=vm.policyDetail.saleBranchCode.substring(0,4),"1"==$rootScope.ContYearCount&&"830"==vm.saleChannel||vm.getBankList(),vm.id=vm.policyDetail.holderIdNo,"2099-12-31"!=vm.policyDetail.appIdArriveDate?(vm.certExpireDate=vm.policyDetail.appIdArriveDate,vm.idexpire="2"):vm.idexpire="1",vm.riskCode=result.data.mainClassCode,vm.planType=result.data.planType,vm.prdType=result.data.prdType,"3"!=vm.backMoneyMode?vm.withdrawWay="0":vm.withdrawWay="1","2"==vm.backMoneyModel.payChannel&&(vm.backMoneyMode="1",vm.withdrawWay="0",vm.repeal=!0,vm.backWays()),angular.isFunction(callback)&&callback())})},vm.getPolicyDetail(function(){vm.riskCode&&vm.getProductConfig(function(){var payInfo={policyNo:vm.policyNo};PolicyChangeService.payDetail(payInfo,function(data){vm.payList=data,"1"==$rootScope.ContYearCount&&"830"==vm.saleChannel&&(vm.bankAccount=vm.payList[0].newBankAccNo,vm.rebankAccount=vm.payList[0].newBankAccNo,vm.bankcode=vm.payList[0].newBankCode,vm.bancodeName="建设银行",vm.bankDisabled=!0),vm.payMon=0;for(var i=0;i<vm.payList.length;i++)vm.payMon=parseFloat(vm.payList[i].chargeAmout);"005"==vm.abandonMode?(vm.backMoneyModel.premMoney=vm.payMon,vm.showlose=!1):(vm.backMoneyModel.premMoney=parseFloat(vm.backMoneyModel.premMoney),parseFloat(vm.backMoneyModel.premMoney)<vm.payMon?vm.showlose=!0:vm.showlose=!1,"000"==vm.abandonMode&&parseFloat(vm.backMoneyModel.premMoney)<1e4?vm.repeal=!1:vm.repeal=!0),vm.backMoneyModel.bankAccountNo?vm.payType=2:vm.payType=1})});var params={policyNo:vm.policyNo};PolicyChangeService.policyCustomerDetail(params,function(data){vm.customerDetail=data,vm.idtype=vm.changeId(vm.customerDetail.holderIdType),vm.lastIdType=vm.idtype})}),vm.getBankList=function(){vm.btk?(vm.bankList,COMMON.getCommonBank(vm.btk,"2",function(bankList){vm.bankList=bankList,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode=vm.bankList[0].bankCode)})):$timeout(function(){vm.getBankList()},100)},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?(vm.imageFrontPath=path[i].imageTempPath,vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName):"F002"==path[i].imageFlag&&(vm.imageBackPath=path[i].imageTempPath,vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(resp.data.error.message+resp.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},vm.changeRenewal=function(){var params={policyNo:vm.policyNo,editType:"003"};PolicyChangeService.changeApply(params,function(data){vm.seriaTransNo=data.seriaTransNo,vm.premMoney=parseFloat(data.premMoney),$state.go("policy-change-pledge",{policyNo:vm.policyNo,premMoney:vm.premMoney,seriaTransNo:vm.seriaTransNo})})},$scope.$watch("policyChangeWithdraw.uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&newValue<vm.imageList.length?vm.checkUpload(newValue):newValue==vm.imageList.length&&("A"==vm.idtype?vm.ocrSwitch():vm.applyWithdraw(),vm.isImgChange=!1))}),vm.idTypeChange=function(){vm.identityAdjust&&("A"!=vm.idtype&&"A"==vm.lastIdType&&(vm.id="",vm.idexpire="2",vm.certExpireDate="",vm.ocrStatus=null,vm.getPolicyResultTimes=0,vm.getOtherResultTimes=0),vm.lastIdType=vm.idtype),"A"==vm.idtype&&(vm.file1=null,vm.file2=null,vm.mosaicImg1=null),"A"==vm.idtype&&(vm.ocrOpenState||(vm.ocrStatus="2"))},vm.changeIdExpire=function(){"2"==vm.idexpire?vm.idexpire="1":vm.idexpire="2"},vm.fileChange=function(file){if(file&&"A"==vm.idtype){if(file.$ngfOrigSize>5242880){vm.tipsDivShow=!0,vm.tipsDiv="上传的图片不能大于5M";var timer=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer)},3e3)}if(!imgTest(file.type)){vm.tipsDiv="您上传的图片类型错误",vm[key]=null;var timer2=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer2)},3e3)}COMMON.identityImg(file,function(img,bolbVal){var timer=$timeout(function(){vm.mosaicImg1=img,$timeout.cancel(timer)},100);bolbVal.name="a.png",vm.mosaicFile1=bolbVal})}},vm.ShowOcrMsg=function(type,templateMsg,info){var alertPopup;if(1==type)alertPopup=$ionicPopup.alert({title:"温馨提示",cssClass:"ocr-notice-show",template:templateMsg,okText:"<span>重新识别</span>"});else if(2==type)alertPopup=$ionicPopup.alert({title:"温馨提示",cssClass:"ocr-notice-show",template:templateMsg,okText:"<span >重新上传</span>"});else if(3==type){var name="",num="",expireT="";if(info&&(name=info.name,num=info.idCardNo,info.expiryDate&&8==info.expiryDate.replace("/(^s*)|(s*$)/g","").length)){var t=info.expiryDate.substring(0,4)+"-"+info.expiryDate.substring(4,6)+"-"+info.expiryDate.substring(6,8);expireT=t}vm.ocrPopup=$ionicPopup.show({title:"温馨提示",template:templateMsg,scope:$scope,cssClass:"ocr-notice-show",buttons:[{text:"<span class='shallow-grey1'>手动填写</span>",onTap:function(res){vm.showNotice("app/module/service/policy-service/policy-change-withdraw/policy-change-notice/edit.html")}},{text:"<span>重新上传</span>",onTap:function(res){$scope.alertCallback()}}]})}alertPopup&&alertPopup.then(function(res){1==type?vm.idCardRecognize():2==type&&$scope.alertCallback()})},$scope.alertCallback=function(){vm.ocrPopup&&(vm.ocrPopup.close(),vm.ocrPopup=null),vm.file1=null,vm.mosaicImg1="",vm.file2=null,vm.uploadMsg=""},vm.clearOcrData=function(){vm.ocrStatus=null,vm.ocrName="",vm.id="",vm.certExpireDate="",vm.idexpire="2"},vm.ocrError=function(){vm.ocrStatus=2,vm.ocrName="",vm.id="",vm.certExpireDate="",vm.idexpire="2"},vm.getOcrNew=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){result&&1==result.status&&("Y"==result.data?vm.ocrOpenState=!0:"N"==result.data&&(vm.ocrOpenState=!1,vm.ocrStatus=2))})},vm.getOcrNew(),vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){if(result&&1==result.status)if("Y"==result.data)vm.ocrOpenState=!0,vm.idCardRecognize();else if("N"==result.data){vm.ocrOpenState=!1;var alertPopup;alertPopup=$ionicPopup.alert({title:"温馨提示",cssClass:"ocr-notice-show",template:"身份信息多次识别失败，请手动填写",okText:"<span >手动填写</span>"}),alertPopup.then(function(res){res&&vm.showNotice("app/module/service/policy-service/policy-change-withdraw/policy-change-notice/edit.html")})}})},vm.ocrInfoShow=function(obj){if(vm.ocrName=obj.name||"",vm.id=obj.idCardNo||"",vm.idexpire="2",obj.expiryDate&&8==obj.expiryDate.replace("/(^s*)|(s*$)/g","").length){var t=obj.expiryDate.substring(0,4)+"-"+obj.expiryDate.substring(4,6)+"-"+obj.expiryDate.substring(6,8);vm.certExpireDate=new Date(t)}else vm.certExpireDate=""},vm.errorTimes=function(){var alertPopup;return 3==vm.getPolicyResultTimes?(alertPopup=$ionicPopup.alert({title:"温馨提示",cssClass:"ocr-notice-show",template:"身份信息多次识别失败，请手动填写",okText:"<span >手动填写</span>"}),alertPopup.then(function(res){res&&vm.showNotice("app/module/service/policy-service/policy-change-withdraw/policy-change-notice/edit.html")}),!0):3==vm.getOtherResultTimes?(alertPopup=$ionicPopup.alert({title:"温馨提示",cssClass:"ocr-notice-show",template:"身份信息多次识别失败，请手动填写",okText:"<span >手动填写</span>"}),alertPopup.then(function(res){res&&vm.showNotice("app/module/service/policy-service/policy-change-withdraw/policy-change-notice/edit.html")}),!0):!1},vm.idCardRecognize=function(){if(vm.recognizeFlg=!1,vm.ocrOpenState){var u_data=sessionData.userData;vm.openId=sessionStorage.getItem("elife-openid");var params={idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,referenName:u_data.customerName,referenSex:u_data.sex,referenBirthday:u_data.birthday,referenCerid:u_data.cretNo,referenCertype:u_data.cretType,custId:u_data.cusId,openId:vm.openId,sceneCode:"SC004",channelCode:"811"};if(vm.errorTimes())return;vm.getOtherResultTimes||(vm.getOtherResultTimes=0),vm.timeoutdata="",vm.clearOcrData(),$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner><div class="ocr-load-text">努力识别中...</div>'}),CommonRequest.request(params,CONFIG.BD_IDCARD_RECOGNIZE,function(result){if($ionicLoading.hide(),vm.timeoutdata=result,"1"==result.status){var recognizeData=result.data;if(vm.token=recognizeData.tocken,"000000"==recognizeData.responseStatus){var userdata=vm.customerDetail||{},bith_date=userdata.holderBirthday.replace(/-/g,"");if(userdata.holderName==recognizeData.name&&userdata.holderGender==recognizeData.gender&&bith_date==recognizeData.birthday)vm.ocrInfoShow(recognizeData),vm.applyWithdraw();else if(vm.getPolicyResultTimes?vm.getPolicyResultTimes++:vm.getPolicyResultTimes=1,3==vm.getPolicyResultTimes){if(vm.errorTimes())return}else vm.ShowOcrMsg(2,"请上传投保人的有效证件")}else"111111"==recognizeData.responseStatus&&(vm.ocrInfoShow(recognizeData),vm.ShowOcrMsg(3,"您好，身份证核查未通过，请检查后重新上传",recognizeData)),"222222"==recognizeData.responseStatus&&(vm.ocrInfoShow(recognizeData),vm.ShowOcrMsg(3,"您上传的身份证件已过有效期，请检查",recognizeData)),"333333"==recognizeData.responseStatus&&(vm.getOtherResultTimes++,vm.getOtherResultTimes<3&&vm.ShowOcrMsg(1,"识别失败，请重新识别")),"555555"!=recognizeData.responseStatus&&"666666"!=recognizeData.responseStatus||vm.ShowOcrMsg(2,"请上传正确且清晰的身份证正反面照片")}else vm.getOtherResultTimes++;3==vm.getOtherResultTimes&&vm.errorTimes()},!0)}},vm.showIdMask=function(){vm.idMask=!0},vm.hideIdMask=function(){vm.idMask=!1},vm.fullImage=!1,vm.currentFullImage="",vm.isImgChange=!0,vm.changePic=function($event,file){vm.currentFullImage=file;var img=$event.srcElement||$event.target;$scope.bigimage=img.src,vm.fullImage=!0},vm.delUpload=function(){vm.isImgChange=!0,$scope.bigimage="",vm[vm.currentFullImage]=null,"file1"==vm.currentFullImage&&(vm.mosaicImg1=""),vm.fullImage=!1},vm.closePic=function(){vm.fullImage=!1},vm.openNotice=function(){vm.renewMask=!0,vm.authTrans=!0},vm.hideNotice=function(){vm.renewMask=!1,vm.authTrans=!1,vm.agree=!0},vm.sureNotice=function(){vm.renewMask=!1,vm.agree=!0,vm.showModal()},void(vm.showNotice=function(url,ifcheck,animation){var self=$rootScope;$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.ocrData={insuerName:"",insuerId:"",idexpire:"2",certExpireDate:""},"1"==self.ocrData.idexpire?self.ocrData.certExpireDate=new Date("2099/12/31"):self.ocrData.certExpireDate||(self.ocrData.certExpireDate=vm.policyDetail.appIdArriveDate),self.close=function(){self.modal.remove()},self.changeIdExpire=function(){"2"==self.ocrData.idexpire?self.ocrData.idexpire="1":(self.ocrData.idexpire="2",self.ocrData.certExpireDate="")},$rootScope.$on("$stateChangeStart",function(){self.modal.remove()}),self.submitForm=function(){return vm.policyDetail.holderName!=self.ocrData.insuerName?void TipService.showMsg("填写的姓名与投保人不一致！"):("1"==self.ocrData.idexpire?self.ocrData.certExpireDate=new Date("2099/12/31"):self.ocrData.certExpireDate||(self.ocrData.certExpireDate=vm.policyDetail.appIdArriveDate),vm.ocrName=self.ocrData.insuerName,vm.certExpireDate=self.ocrData.certExpireDate,vm.id=self.ocrData.insuerId,self.close(),void vm.applyWithdraw())}})})):(TipService.showMsg("申请失效，请重新再试"),void history.back())}angular.module("app").controller("PolicyChangeWithdrawController",PolicyChangeWithdrawController),PolicyChangeWithdrawController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout","$ionicPopup","$interval","$ionicModal"]}(),function(){function PolicyExpireGetController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout){function transNationality(code){var name="";if(code)for(var i=0;i<vm.NationalList.length;i++)if(code==vm.NationalList[i].countryCode){name=vm.NationalList[i].countryName;break}return name}function judgeCretType(key1,key2,key3){var flag=!1;return vm.pageData[key1]&&vm.pageData[key2]&&vm[key3]&&(flag=!0),flag}function getCityName(id,arr){for(var name="",i=0;i<arr.length;i++)arr[i].areaCode==id&&(name=arr[i].areaName);return name}var vm=this,sessionData=PolicyService.getSessionData();if(vm.pageData=sessionData.serviceExpireGetData?sessionData.serviceExpireGetData:{},vm.policyNo=vm.pageData.policyNo,vm.searchCustomer=vm.pageData.searchCustomer,!vm.policyNo)return void history.back();var nowDate=$filter("date")(new Date,"yyyy-MM-dd");vm.pageData.beneArriveDate&&new Date(vm.pageData.beneArriveDate)<new Date(nowDate)?vm.beneDatePast=!0:vm.beneDatePast=!1,vm.pageData.beneArriveDate&&(vm.pageData.beneArriveDate=new Date(vm.pageData.beneArriveDate)),vm.pageData.appnArriveDate&&(vm.pageData.appnArriveDate=new Date(vm.pageData.appnArriveDate)),vm.init=function(){vm.appProvinceName=vm.pageData.appProvinceName||"",vm.provinceName=vm.pageData.provinceName||"","1"==vm.pageData.certExpireType?vm.isCertTypeLong=!0:vm.isCertTypeLong=!1,"1"==vm.pageData.appCertExpireType?vm.appIsCertTypeLong=!0:vm.appIsCertTypeLong=!1,vm.pageData.beneProvinceCode&&!vm.provinceName&&vm.showArea({},1),vm.pageData.appnProvinceCode&&!vm.appProvinceName&&vm.showArea({},2),vm.getNationalList()},vm.isFull=function(){judgeCretType("appnNation","appnCretType","appnNationName")&&vm.pageData.appnName&&vm.pageData.appnSex&&vm.pageData.appnBirthData&&vm.pageData.appnCretType&&vm.pageData.appnCretNo&&vm.pageData.appnArriveDate&&vm.pageData.appnPhone&&vm.pageData.appnAddress&&vm.pageData.appnOccupationName&&vm.pageData.appnProvinceCode&&vm.pageData.appnCityCode&&vm.pageData.appnCountyCode?vm.appnIsIntact=!0:vm.appnIsIntact=!1,judgeCretType("beneNation","beneCretType","beneNationName")&&vm.pageData.beneName&&vm.pageData.beneSex&&vm.pageData.beneBirthData&&vm.pageData.beneCretType&&vm.pageData.beneCretNo&&vm.pageData.beneArriveDate&&vm.pageData.benePhone&&vm.pageData.beneAddress&&vm.pageData.beneOccupationName&&vm.pageData.beneProvinceCode&&vm.pageData.beneCityCode&&vm.pageData.beneCountyCode&&!vm.beneDatePast?vm.beneIsIntact=!0:vm.beneIsIntact=!1},vm.isPerson="1",vm.getNationalList=function(){var config={url:"../statics/json/CRScountry.json",method:"GET"};CommonRequest.request({},config,function(result){vm.NationalList=result.data,vm.pageData.beneNation?vm.beneNationName=transNationality(vm.pageData.beneNation):"0"==vm.pageData.beneCretType&&(vm.beneNationName="中国",vm.pageData.beneNation="CHN"),vm.pageData.appnNation?vm.appnNationName=transNationality(vm.pageData.appnNation):"0"==vm.pageData.appnCretType&&(vm.appnNationName="中国",vm.pageData.appnNation="CHN"),vm.isFull()})},vm.nationChange=function(key){"appnNationName"===key?vm[key]=transNationality(vm.pageData.appnNation):"beneNationName"===key&&(vm[key]=transNationality(vm.pageData.beneNation))},vm.showArea=function(prams,id){CommonRequest.request(prams,CONFIG.GET_AREA_SERVCIE,function(result){"1"==result.status&&(vm.provinces=result.data,prams.areaLevel?2==prams.areaLevel?1===id?(vm.area2=getCityName(vm.pageData.beneCityCode,result.data),vm.showArea({parentAreaCode:vm.pageData.beneCityCode,areaLevel:3},id)):(vm.appArea2=getCityName(vm.pageData.appnCityCode,result.data),vm.showArea({parentAreaCode:vm.pageData.appnCityCode,areaLevel:3},id)):3==prams.areaLevel&&(1===id?(vm.area3=getCityName(vm.pageData.beneCountyCode,result.data),vm.provinceName=vm.area1+"-"+vm.area2+"-"+vm.area3):(vm.appArea3=getCityName(vm.pageData.appnCountyCode,result.data),vm.appProvinceName=vm.appArea1+"-"+vm.appArea2+"-"+vm.appArea3)):1===id?(vm.area1=getCityName(vm.pageData.beneProvinceCode,result.data),vm.showArea({parentAreaCode:vm.pageData.beneProvinceCode,areaLevel:2},id)):(vm.appArea1=getCityName(vm.pageData.appnProvinceCode,result.data),vm.showArea({parentAreaCode:vm.pageData.appnProvinceCode,areaLevel:2},id)))})},vm.startSelectArea=function(val){vm.isPerson=val},vm.changeInfo=function(val){PolicyService.setSessionData({serviceExpireGetData:{beneSex:vm.pageData.beneSex,beneBirthData:vm.pageData.beneBirthData,beneCretType:vm.pageData.beneCretType,beneCretNo:vm.pageData.beneCretNo,benePhone:vm.pageData.benePhone,beneAddress:vm.pageData.beneAddress,beneOccupationName:vm.pageData.beneOccupationName,beneArriveDate:vm.pageData.beneArriveDate,beneProvinceCode:vm.pageData.beneProvinceCode,beneCountyCode:vm.pageData.beneCountyCode,beneCityCode:vm.pageData.beneCityCode,beneOccupationCode:vm.pageData.beneOccupationCode,searchCustomer:vm.searchCustomer}}),"2"==val?(PolicyService.setSessionData({serviceExpireGetData:{appnNationName:vm.appnNationName,appnNation:vm.pageData.appnNation,appProvinceName:vm.appProvinceName}}),$state.go("policy-expire-get-insured",{policyNo:vm.policyNo})):"1"==val&&(PolicyService.setSessionData({serviceExpireGetData:{beneNationName:vm.beneNationName,beneNation:vm.pageData.beneNation,provinceName:vm.provinceName}}),$state.go("policy-expire-get-bene",{policyNo:vm.policyNo}))},vm.checkCretNo=function(val){PolicyService.setSessionData({serviceExpireGetData:{policyNo:vm.policyNo,beneNationName:vm.beneNationName,beneNation:vm.pageData.beneNation,provinceName:vm.provinceName,beneSex:vm.pageData.beneSex,beneBirthData:vm.pageData.beneBirthData,beneCretType:vm.pageData.beneCretType,beneCretNo:vm.pageData.beneCretNo,benePhone:vm.pageData.benePhone,beneAddress:vm.pageData.beneAddress,beneOccupationName:vm.pageData.beneOccupationName,beneArriveDate:vm.pageData.beneArriveDate,beneProvinceCode:vm.pageData.beneProvinceCode,beneCountyCode:vm.pageData.beneCountyCode,beneCityCode:vm.pageData.beneCityCode,beneOccupationCode:vm.pageData.beneOccupationCode,appnNationName:vm.appnNationName,appnNation:vm.pageData.appnNation,appProvinceName:vm.appProvinceName,searchCustomer:vm.searchCustomer}}),$state.go("policy-expire-get-upload")},vm.changeAppLong=function(event){event.preventDefault(),$timeout(function(){$scope.appIslong=!0},100)},vm.getCustomerInfo=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.POLICY_CUSTOMER_DETAIL_EXT_SERVCIE,function(result){1==result.status?($rootScope.yearsFlag=result.data.years,vm.coverValue(result.data),vm.searchCustomer=!0):$state.go("tab.service")})},vm.coverValue=function(data){vm.pageData.beneBirthData=vm.pageData.beneBirthData||data.holderBirthday,vm.pageData.beneSex=vm.pageData.beneSex||vm.filterHolderSex(data.holderGender),vm.pageData.beneCretType=vm.pageData.beneCretType||vm.filterHolderIdType(data.holderIdType),vm.pageData.beneCretNo=vm.pageData.beneCretNo||data.holderIdNum,
vm.pageData.beneNation=vm.pageData.beneNation||vm.filterHolderNation(data.holderAppNativePlace),vm.pageData.benePhone=vm.pageData.benePhone||data.holderHomeTel,vm.pageData.beneProvinceCode=vm.pageData.beneProvinceCode||data.HolderHomeProvinceCode,vm.pageData.beneCityCode=vm.pageData.beneCityCode||data.HolderHomeCityCode,vm.pageData.beneCountyCode=vm.pageData.beneCountyCode||data.holderHomeAreaCode,vm.pageData.beneAddress=vm.pageData.beneAddress||data.holderHomeAddress,vm.pageData.beneOccupationName=vm.pageData.beneOccupationName||data.holderAppOccupationName,vm.pageData.beneOccupationCode=vm.pageData.beneOccupationCode||data.holderAppOccupationCode,vm.init()},vm.filterHolderNation=function(str){var code="";return"中国"==str?code="CHN":"中国香港"==str?code="HKG":"中国台湾"==str?code="TWN":"中国澳门"==str&&(code="MAC"),code},vm.filterHolderSex=function(str){var code="";return"男"==str?code="0":"女"==str&&(code="1"),code},vm.filterHolderIdType=function(str){var code="";return"身份证"==str?code="0":"外国护照"==str?code="1":"港澳台通行证"==str?code="6":"外国人永久居留身份证"==str&&(code="C"),code},vm.searchCustomer?vm.init():vm.getCustomerInfo()}angular.module("app").controller("PolicyExpireGetController",PolicyExpireGetController),PolicyExpireGetController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout"]}(),function(){function PolicyOrderWithdrawController($state,$scope,$log,CommonRequest,CONFIG,PolicyChangeService,$filter,COMMON,$rootScope,Upload,$ionicLoading,PolicyService,TipService,$timeout){var vm=this;vm.saleChannel=$state.params.saleChannel;var sessionData=PolicyService.getSessionData(),userData=sessionData.userData,imagePath="/app/gmc2image/";if(vm.policyNo=$state.params.policyNo,vm.polciyPeriod=$state.params.polciyPeriod,vm.transToken=$state.params.transToken,vm.effectDate=$state.params.effectDate,vm.effectDate){var effectDateForMin=(new Date,new Date(vm.effectDate.replace("-","/"))),effectDateForMax=new Date(vm.effectDate.replace("-","/")),addPeriod=parseInt(vm.polciyPeriod),maxEndDateForYear=new Date(effectDateForMax.setFullYear(effectDateForMax.getFullYear()+addPeriod)),minStartDateForYear=new Date(effectDateForMin.setFullYear(effectDateForMin.getFullYear()+addPeriod));vm.maxEndDate=new Date(maxEndDateForYear.setDate(maxEndDateForYear.getDate()+30)),vm.minStartEffectDate=new Date(minStartDateForYear.setDate(minStartDateForYear.getDate()+1)),vm.orderDate=vm.minStartEffectDate}vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)},vm.imageList=[],vm.effectDate&&vm.policyNo&&vm.transToken&&vm.polciyPeriod||(TipService.showMsg($rootScope.TIPS.POLICY_CHANGE.MISS_DATA),history.back()),vm.uploaded=0,"000"==vm.abandonMode?vm.hesitateFlg="0":vm.hesitateFlg="1",vm.payTypeWay=[{label:"授权转账",value:"1"}],vm.minStartDate=new Date,vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.changeId=function(id){return id="身份证"==id?"A":"护照"==id?"I":"外国人永久居留身份证"==id?"N":"G"},vm.goSet=function(){if(vm.imageInfo||(vm.filePath1=vm.filePath2=null),vm.imageList=[],vm.uploaded=0,"1"==vm.idexpire?vm.certExpireDate=new Date("2099/12/31"):vm.certExpireDate||(vm.certExpireDate=vm.policyDetail.appIdArriveDate),vm.imageInfo)vm.showModal();else{if(!vm.file1||!vm.file2)return void $ionicLoading.show({template:"图片不能为空",duration:2e3});vm.imageList.push({F001:vm.file1},{F002:vm.file2}),PolicyService.isAllowUpload(vm.imageList.length,function(){vm.checkUpload(vm.uploaded)})}},vm.checkUpload=function(uploaded){var data={custId:userData?userData.cusId:"",token:userData?userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB001"};vm.upload(angular.extend(vm.imageList[uploaded],data),function(){vm.uploaded++})},vm.showModal=function(){var params={abandonMode:vm.abandonMode,cusId:vm.custId,config:"BT",policyNo:vm.policyNo,pbHoldName:vm.customerDetail.holderName,sex:"男"==vm.customerDetail.holderGender?"1":"2",cretType:vm.idtype?vm.idtype:vm.changeId(vm.customerDetail.holderIdType),cretNo:vm.id?vm.id:vm.customerDetail.holderIdNum,pbCretIdArriveDate:vm.certExpireDate?$filter("date")(vm.certExpireDate,"yyyy-MM-dd"):vm.policyDetail.appIdArriveDate,birthday:vm.customerDetail.holderBirthday,pbBankCode:vm.bankcode?vm.bankcode:"",pbBankAccount:vm.bankAccount?vm.bankAccount:"",oldTransNo:vm.seriaTransNo,changeReason:vm.reason,imagePath1:vm.filePath1,imagePath2:vm.filePath2,CCBSBCODE:"CCBSB000",channelCode:vm.saleChannel,CTPDFlag:"0"==vm.withdrawWay?"1":"2",hesitateFlg:vm.hesitateFlg,polciyPeriod:vm.polciyPeriod,transToken:vm.transToken,applyTime:$filter("date")(vm.orderDate,"yyyy-MM-dd")};PolicyService.control({state:"policy-change",control:"data",data:params}),COMMON.showModal("app/module/service/policy-service/policy-change-confirm/policy-change-confirm.html")},vm.getProductConfig=function(callback){var params={prdCode:vm.riskCode,planType:vm.planType,prdType:vm.prdType};CommonRequest.request(params,CONFIG.PRODUCT_CONFIG_SERVCIE,function(result){1==result.status&&(1==result.data.isChangeInvestaccount?vm.isChangeInvestaccount=!0:vm.isChangeInvestaccount=!1,1==result.data.isChangeInvestbalance?vm.isChangeInvestbalance=!0:vm.isChangeInvestbalance=!1,1==result.data.isChangeOnlineLoan?vm.isChangeOnlineLoan=!0:vm.isChangeOnlineLoan=!1,angular.isFunction(callback)&&callback())})},vm.getPolicyDetail=function(callback){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GET_POLICY_EXT_SERVCIE,function(result){1==result.status&&(vm.policyDetail=result.data,vm.btk=vm.policyDetail.saleBranchCode.substring(0,4),vm.getBankList(),vm.id=vm.policyDetail.holderIdNo,"2099-12-31"!=vm.policyDetail.appIdArriveDate?(vm.certExpireDate=vm.policyDetail.appIdArriveDate,vm.idexpire="2"):vm.idexpire="1",vm.riskCode=result.data.mainClassCode,vm.planType=result.data.planType,vm.prdType=result.data.prdType,"3"!=vm.backMoneyMode?vm.withdrawWay="0":vm.withdrawWay="1",angular.isFunction(callback)&&callback())})},vm.getPolicyDetail(function(){vm.riskCode&&vm.getProductConfig(function(){var payInfo={policyNo:vm.policyNo};PolicyChangeService.payDetail(payInfo,function(data){vm.payList=data,vm.payMon=0;for(var i=0;i<vm.payList.length;i++)vm.payMon=parseFloat(vm.payList[i].chargeAmout)})});var params={policyNo:vm.policyNo};PolicyChangeService.policyCustomerDetail(params,function(data){vm.customerDetail=data,vm.idtype=vm.changeId(vm.customerDetail.holderIdType)})}),vm.getBankList=function(){vm.btk?(vm.bankList,COMMON.getCommonBank(vm.btk,"2",function(bankList){vm.bankList=bankList,angular.isArray(vm.bankList)&&vm.bankList.length>0&&(vm.bankcode=vm.bankList[0].bankCode)})):$timeout(function(){vm.getBankList()},100)},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(resp){if($ionicLoading.hide(),"1"==resp.data.status){vm.uploadMsg="上传成功！";for(var path=resp.data.data,i=0;i<path.length;i++)"F001"==path[i].imageFlag?vm.filePath1=vm.changePath(path[i].imagePath)+"/"+path[i].imageName:"F002"==path[i].imageFlag&&(vm.filePath2=vm.changePath(path[i].imagePath)+"/"+path[i].imageName);angular.isFunction(callback)&&callback()}else TipService.showMsg(result.data.error.message+result.data.error.code),vm.uploadMsg="上传失败"},function(resp){$ionicLoading.hide(),vm.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);vm.uploadMsg="上传进度: "+progressPercentage+"%"})},vm.changePath=function(name){return-1!=name.indexOf(imagePath)?name.substring(imagePath.length,name.length):name},$scope.$watch("policyOrderWithdraw.uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&2>newValue?vm.checkUpload(newValue):2==newValue&&vm.showModal())})}angular.module("app").controller("PolicyOrderWithdrawController",PolicyOrderWithdrawController),PolicyOrderWithdrawController.$inject=["$state","$scope","$log","CommonRequest","CONFIG","PolicyChangeService","$filter","COMMON","$rootScope","Upload","$ionicLoading","PolicyService","TipService","$timeout"]}(),function(){function PolicyServiceListController($rootScope,$scope,$state,PolicyService,CommonRequest,CONFIG,$filter,PolicyChangeService,TipService,$ionicLoading,$ionicPopup,$timeout,$q,$log,VALIDATION){var vm=this,sessionData=PolicyService.getSessionData();if(vm.changeType=$state.params.changeType,!vm.changeType)return void $state.go("tab.service");if(vm.userData=sessionData.userData,vm.day=function(a,b){var arr=a.split("-"),starttime=new Date(arr[0],arr[1],arr[2]),starttimes=starttime.getTime(),arrs=b.split("-"),lktime=new Date(arrs[0],arrs[1],arrs[2]),lktimes=lktime.getTime();return starttimes==lktimes?"0":starttimes>lktimes?"1":"2"},!vm.changeType)return void $ionicLoading.show({template:"缺少保全类型！",duration:2e3});if(!vm.userData||!vm.userData.cusId)return void $ionicLoading.show({template:"缺少客户信息！",duration:2e3});var defer1=$q.defer(),promise1=defer1.promise;$log.info(vm.changeType),"10"==vm.changeType?(vm.getCardNameByCode=function(){var params={},config={url:"../statics/json/cardPrdList.json",method:"GET"};CommonRequest.request(params,config,function(result){return vm.cardPrdList=result.data||"",defer1.resolve(),promise1},!0)},vm.getCardNameByCode()):(vm.getCardNameByCode=function(){var params={},config={url:"../statics/json/cardPrdList.json",method:"GET"};CommonRequest.request(params,config,function(result){return vm.cardPrdList=result.data||"",defer1.resolve(),promise1},!0)},vm.getCardNameByCode()),promise1.then(function(){vm.formatCardNameFilter=function(data){for(var i=0;i<vm.cardPrdList.length;i++)if(data==vm.cardPrdList[i].prdCode)return vm.cardPrdList[i].prdName},vm.getPolicyList(vm.changeType)}),vm.currentPage=1,vm.itemPerPage=5,vm.totalItems=0,vm.currentPagePolicys=[],vm.getPolicyList=function(changeType){if($rootScope.isLogin)if("99"==changeType)CommonRequest.request({},CONFIG.GET_APPLY_LIST_SERVICE,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)||(data=[]),vm.policyList=data,vm.totalItems=vm.policyList.length,vm.changePage()}});else{var params={cusId:vm.userData.cusId,riskType:vm.changeType,role:"1",contType:"0",queryType:"0"};CommonRequest.request(params,CONFIG.QUERY_POLICY_BY_CHANGE_TYPE_SERVICE,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)||(data=[]);for(var i=0;i<data.length;i++)"826"==data[i].salechnl&&($log.info(111111111),data[i].policyType=vm.formatCardNameFilter(data[i].cardPrdCode));vm.policyList=data,vm.totalItems=vm.policyList.length,vm.changePage()}})}else $timeout(function(){vm.getPolicyList(changeType)},1e3)},vm.changePage=function(){var page=vm.currentPage,itemPerPage=vm.itemPerPage,policyList=vm.policyList,totalItems=vm.totalItems,pages=parseInt(totalItems/itemPerPage)+1;page&&pages>=page&&(vm.currentPagePolicys=policyList.slice((page-1)*itemPerPage,page*itemPerPage))},vm.outInsure=function(policyNo,cardNo,saleChannel,prdCode,mainClassName){"826"!=saleChannel&&PolicyChangeService.applyWithdraw(policyNo,saleChannel,function(result){if("1"==result.status)if("1"==result.data.isCanUpdate){vm.seriaTransNo=result.data.seriaTransNo,vm.backMoneyModel=result.data.backMoneyModel,vm.abandonMode=result.data.abandonMode,vm.backMoneyMode=result.data.backMoneyMode,vm.realPayMoney=result.data.backMoneyModel.realPayMoney,vm.imageInfo=!!result.data.imageInfo,vm.filePath1=vm.imageInfo?result.data.imageInfo.frontImagePath+result.data.imageInfo.frontImageName+";":"",vm.filePath2=vm.imageInfo?result.data.imageInfo.backImagePath+result.data.imageInfo.backImageName+";":"";var policyServe={policyNo:policyNo,seriaTransNo:vm.seriaTransNo,backMoneyModel:vm.backMoneyModel,abandonMode:vm.abandonMode,backMoneyMode:vm.backMoneyMode,imageInfo:vm.imageInfo,filePath1:vm.filePath1,filePath2:vm.filePath2,realPayMoney:vm.realPayMoney,saleChannel:saleChannel};PolicyService.setSessionData({policyServeData:policyServe}),$state.go("policy-change-withdraw")}else TipService.showMsg(result.data.resultDescrpt)}),"826"==saleChannel&&PolicyChangeService.cardApplyWithdraw(cardNo,saleChannel,prdCode,function(result){"1"==result.status&&("1"==result.data.respCode?(result.data.saleChannel=saleChannel,result.data.mainClassName=mainClassName,PolicyService.setSessionData({policyServeData:result.data}),$state.go("card-policy-change-withdraw")):TipService.showMsg(result.data.respDesc))})},vm.changeIdCard=function(policyNo,saleChannel){var edit="004",params={policyNo:policyNo,editType:edit,channelCode:saleChannel};PolicyChangeService.changeApply(params,function(data){vm.seriaTransNo=data.seriaTransNo;var alertPopup=$ionicPopup.confirm({title:"警告",template:"您本次申请变更的证件信息，将同步更新您名下所有保单相关的证件信息，请确认是否继续操作？",okText:"确认",cancelText:"取消"});alertPopup.then(function(res){res&&data&&$state.go("policy-change-id",{policyNo:policyNo,seriaTransNo:data.seriaTransNo,saleChannel:saleChannel})})})},vm.insurePledge=function(policyNo,saleChannel,route){var edit="003",params={policyNo:policyNo,editType:edit,channelCode:saleChannel};PolicyChangeService.changeApply(params,function(data){vm.seriaTransNo=data.seriaTransNo,vm.premMoney=parseFloat(data.premMoney),$state.go(route,{policyNo:policyNo,seriaTransNo:vm.seriaTransNo,premMoney:vm.premMoney,saleChannel:saleChannel})})},vm.crsShowMsg=function(callback){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"请提供“个人税收居民身份声明文件”信息!",okText:"确定",cancelText:"取消"});alertPopup.then(function(res){res&&angular.isFunction(callback)&&callback()})},vm.setStoreInfo=function(data,policyNo){data.policyNo=policyNo,PolicyService.setSessionData({serviceExpireGetData:data}),$state.go("policy-expire-get",{policyNo:policyNo})},vm.expireGet=function(policyNo,saleChannel){PolicyService.removeSessionData("serviceExpireGetData");var prams={policyNo:policyNo,channleCode:saleChannel,accName:vm.userData.customerName,sex:vm.userData.sex,cretType:vm.userData.cretType,cretNo:vm.userData.cretNo};PolicyChangeService.expireGet(prams,function(res){if(1==res.data.isCanUpdate){var data=res.data.fullPaymentModel;if(!data.appnRelation||!data.beneRela)return void TipService.showMsg("在线申请需投保人、受益人与被保险人的关系一致，您不满足在线申请条件，可联系业务人员");if(data.appnRelation!=data.beneRela)return void TipService.showMsg("在线申请需投保人、受益人与被保险人的关系一致，您不满足在线申请条件，可联系业务人员");data.serialTransNo=res.data.serialTransNo,vm.setStoreInfo(data,policyNo)}})},vm.doPolicyChange=function(policy){sessionStorage.setItem("policyNokd",policy.policyNo),$rootScope.ContYearCount=policy.contYearCount;var route,changeType=vm.changeType,policyNo=policy.policyNo,cardNo=policy.plchdCardNo||"",saleChannel=policy.salechnl,prdCode=policy.cardPrdCode,policyType=policy.policyType;switch(changeType){case"1":route="policy-change-id";break;case"2":route="policy-change-contact";break;case"3":route="policy-change-bonus-account";break;case"4":route="policy-change-transfer-account";break;case"5":route="policy-change-expired";break;case"6":route="policy-change-bonus-choose";break;case"7":route="policy-change-add-premium";break;case"8":route="policy-change-invest-account";break;case"9":route="policy-change-invest-ratio";break;case"10":route="policy-change-withdraw";break;case"11":route="policy-change-renewal";break;case"12":route="policy-change-pledge";break;case"99":route="policy-order-withdraw";break;case"13":route="policy-change-deduction"}PolicyChangeService.showDetail({policyNo:policyNo,channelCode:saleChannel},function(data){vm.policyDetial=data,vm.isInHesitate=vm.policyDetial.isInHesitate,vm.effectDate=vm.policyDetial.effectDate,vm.planCode=vm.policyDetial.mainClassCode;var info=vm.policyDetial;if(vm.holderInfo={name:info.holderName,age:info.holderBirthday,certNo:info.holderIdNo,certArriveDate:info.appIdArriveDate?info.appIdArriveDate:"",nation:info.holderNationality,holderNationalityCode:info.holderNationalityCode,certType:info.appIdType},vm.insureInfo={name:info.insuredName,age:info.inseredBirthday,certNo:info.insuredIdnmbr,certArriveDate:info.insIdArriveDate?info.insIdArriveDate:"",nation:info.insuredNatioality,insouredNationalityCode:info.insouredNationalityCode,certType:info.insIdType},"1"==changeType)vm.changeIdCard(policyNo,saleChannel);else if("10"==changeType){var params={cusId:vm.userData.cusId};PolicyChangeService.validateCrsInfo(params,function(result){result?(window.sessionStorage.setItem("yz-cardNo",cardNo),window.sessionStorage.setItem("yz-prdCode",prdCode),vm.crsShowMsg(function(){$state.go("person-revenue-distinguish",{policyNo:policyNo,cardNo:cardNo,prdCode:prdCode,changeType:changeType,saleChannel:saleChannel,mainClassName:policyType})})):vm.outInsure(policyNo,cardNo,saleChannel,prdCode,policyType)})}else if("11"==changeType){var edit="002",params={policyNo:policyNo,editType:edit,channelCode:saleChannel};PolicyChangeService.changeApply(params,function(data){vm.seriaTransNo=data.seriaTransNo,vm.oldRnewFlags=data.changeResultModel.oldRnewFlags,vm.riskCodes=data.changeResultModel.riskCodes,vm.risksFlagList=data.changeResultModel.risksFlagList,vm.risksList=data.changeResultModel.risksList,vm.mainPolno=data.changeResultModel.mainPolno,vm.polno=data.changeResultModel.polno,$state.go(route,{policyNo:policyNo,saleChannel:saleChannel,seriaTransNo:vm.seriaTransNo,oldRnewFlags:vm.oldRnewFlags,riskCodes:vm.riskCodes,risksFlagList:vm.risksFlagList,risksList:vm.risksList,mainPolno:vm.mainPolno,polno:vm.polno})})}else if("12"==changeType){var params={planCode:vm.planCode,cusId:vm.userData.cusId,crsType:"2",channelCode:saleChannel};PolicyChangeService.validateCrsInfo(params,function(result){result?(window.sessionStorage.setItem("yz-cardNo",cardNo),window.sessionStorage.setItem("yz-prdCode",prdCode),vm.crsShowMsg(function(){$state.go("person-revenue-distinguish",{policyNo:policyNo,changeType:changeType,saleChannel:saleChannel})})):vm.insurePledge(policyNo,saleChannel,route)})}else if("99"==changeType){var params={policyNo:policyNo,channelCode:saleChannel};CommonRequest.request(params,CONFIG.ORDER_APPLY_SERVICE,function(result){1==result.status&&("1"==result.data.isCanAbandonPolicyReserve?(vm.polciyPeriod=result.data.polciyPeriod,vm.transToken=result.data.transToken,$state.go("policy-order-withdraw",{policyNo:policyNo,polciyPeriod:vm.polciyPeriod,transToken:vm.transToken,effectDate:vm.effectDate,saleChannel:saleChannel})):TipService.showMsg(result.data.description))})}else if("4"==changeType||"6"==changeType){if(vm.UnRealPolicyChangeRule(policyNo,saleChannel))return;params={planCode:vm.planCode,cusId:vm.userData.cusId,crsType:"2",channelCode:saleChannel},PolicyChangeService.validateCrsInfo(params,function(result){result?(window.sessionStorage.setItem("yz-cardNo",cardNo),window.sessionStorage.setItem("yz-prdCode",prdCode),vm.crsShowMsg(function(){$state.go("person-revenue-distinguish",{policyNo:policyNo,changeType:changeType,saleChannel:saleChannel})})):$state.go(route,{policyNo:policyNo,saleChannel:saleChannel})})}else if("3"==changeType)params={policyNo:policyNo},PolicyChangeService.bonusAccount(params,function(data){vm.serialTransNo=data.data.serialTransNo,"1"==data.data.isCanUpdate&&$state.go(route,{serialTransNo:vm.serialTransNo,policyNo:policyNo,saleChannel:saleChannel})});else if("14"==changeType){var params={planCode:vm.planCode,cusId:vm.userData.cusId,crsType:"2",channelCode:saleChannel};PolicyChangeService.validateCrsInfo(params,function(result){result?(window.sessionStorage.setItem("yz-cardNo",cardNo),window.sessionStorage.setItem("yz-prdCode",prdCode),vm.crsShowMsg(function(){$state.go("person-revenue-distinguish",{policyNo:policyNo,changeType:changeType,saleChannel:saleChannel})})):PolicyChangeService.isExpireGet(policyNo,function(res){if(0==res.data.isCanUpdate)vm.expireGet(policyNo,saleChannel);else if(1==res.data.isCanUpdate){var expire_confirm=$ionicPopup.confirm({title:"满期领取",template:res.data.resultDescrpt,okText:"确定",cancelText:"取消"});expire_confirm.then(function(res){res&&vm.expireGet(policyNo,saleChannel)})}})})}else{if(vm.UnRealPolicyChangeRule(policyNo,saleChannel))return;$state.go(route,{policyNo:policyNo,saleChannel:saleChannel})}})},vm.UnRealPolicyChangeRule=function(policyNo,saleChannel){var holderInfo=vm.holderInfo,insureInfo=vm.insureInfo;return vm.policyNoSave=policyNo,vm.saleChannelSave=saleChannel,vm.errorList=[[],[]],"0"==holderInfo.certType&&15==holderInfo.certNo.length&&vm.errorList[0].push(holderInfo.name+"证件为第一代身份证，需先进行证件信息变更后方可继续申请"),"5"!=holderInfo.certType&&"4"!=holderInfo.certType&&""==holderInfo.certArriveDate&&vm.errorList[0].push(holderInfo.name+"证件为有效期为空，需先进行证件信息变更后方可继续申请"),holderInfo.certArriveDate&&(new Date).getTime()>new Date(holderInfo.certArriveDate.split("-").join(",")).getTime()&&vm.errorList[0].push(holderInfo.name+"证件有效期已过期，需先进行证件信息变更后方可继续申请"),holderInfo.name==insureInfo.name&&holderInfo.certNo==insureInfo.certNo&&holderInfo.certType==insureInfo.certType?VALIDATION.getAgeByBirth(vm.insureInfo.age)>=16&&("CHN"==vm.insureInfo.insouredNationalityCode&&"0"!=vm.insureInfo.certType||"CHN"!=vm.insureInfo.insouredNationalityCode&&"5"==vm.insureInfo.certType)&&vm.errorList[1].push(insureInfo.name+"已年满16周岁证件需更新为身份证"):("0"==insureInfo.certType&&15==insureInfo.certNo.length&&vm.errorList[1].push(insureInfo.name+"证件为第一代身份证，需先进行证件信息变更后方可继续申请"),"5"!=insureInfo.certType&&"4"!=insureInfo.certType&&""==insureInfo.certArriveDate&&vm.errorList[1].push(insureInfo.name+"证件为有效期为空，需先进行证件信息变更后方可继续申请"),insureInfo.certArriveDate&&(new Date).getTime()>new Date(insureInfo.certArriveDate.split("-").join(",")).getTime()&&vm.errorList[1].push(insureInfo.name+"证件有效期已过期，需先进行证件信息变更后方可继续申请"),VALIDATION.getAgeByBirth(vm.insureInfo.age)>=16&&("CHN"==vm.insureInfo.insouredNationalityCode&&"0"!=vm.insureInfo.certType||"CHN"!=vm.insureInfo.insouredNationalityCode&&"5"==vm.insureInfo.certType)&&vm.errorList[1].push(insureInfo.name+"已年满16周岁证件需更新为身份证")),0!=vm.errorList[0].length&&0==vm.errorList[1].length?(vm.holederModalFlag=!0,vm.message=vm.errorList[0],!0):0==vm.errorList[0].length&&0!=vm.errorList[1].length?(vm.insuerModalFlag=!0,vm.message=vm.errorList[1],!0):0!=vm.errorList[0].length&&0!=vm.errorList[1].length?(vm.holeInserModalFlag=!0,vm.holderMessage=vm.errorList[0],vm.insuerrMessage=vm.errorList[1],!0):!1},vm.doCerInfo=function(){vm.holeInserModalFlag=!1,vm.insuerModalFlag=!1,vm.holederModalFlag=!1,vm.changeIdCard(vm.policyNoSave,vm.saleChannelSave)},vm.iKnow=function(){vm.holeInserModalFlag=!1,vm.insuerModalFlag=!1,vm.holederModalFlag=!1}}angular.module("app").controller("PolicyServiceListController",PolicyServiceListController),PolicyServiceListController.$inject=["$rootScope","$scope","$state","PolicyService","CommonRequest","CONFIG","$filter","PolicyChangeService","TipService","$ionicLoading","$ionicPopup","$timeout","$q","$log","VALIDATION"]}(),function(){function SelfServiceClaimsController($ionicPopup,$scope,$state,$stateParams,CommonRequest,CONFIG,TipService,PolicyService,$rootScope){var vm=this;vm.claimsInstruction=function(){CommonRequest.request({},CONFIG.CLAIMS_AUTHORITY,function(result){result&&1==result.status&&result.data&&"1"==result.data&&(vm.instructionShow=!0)})},vm.claimsInstruction()}angular.module("app").controller("SelfServiceClaimsController",SelfServiceClaimsController),SelfServiceClaimsController.$inject=["$ionicPopup","$scope","$state","$stateParams","CommonRequest","CONFIG","TipService","PolicyService","$rootScope"]}(),function(){function PolicySignController($scope,CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,PolicyService,$state,$ionicHistory){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=windowsHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=9,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/service/policy-tax-sign.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight)}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0)}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL(),param={bytes:signBase64,custId:vm.taxCustId,fileName:"HR01.png",txCode:"HR01",channelCode:vm.taxChannelCode};CommonRequest.request(param,CONFIG.TAX_GROUP_SIGNBYBASE64,function(result){"1"==result.status&&(vm.signResult=result.data,vm.submitSave())})}.bind(this),!1)}var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData||$state.go("tab.mall"),document.body.addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.body.addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=44);var windowsHeight=parseInt(.96*$(window).height())-80-vm.headHeight;vm.signStart=!1,vm.taxChannelCode=$rootScope.SALE_CHANNEL,vm.taxCustId=vm.userData.cusId,vm.checkPolicyInfo=function(){var paramInit={insName:vm.userData.customerName,insCerType:vm.userData.cretType,insCerNo:vm.userData.cretNo};CommonRequest.request(paramInit,CONFIG.TAX_GROUPHR,function(result){result.status&&"1"==result.status&&(vm.taxSignAppNo=result.data.appNo,vm.taxSignId=result.data.id)})},vm.checkPolicyInfo(),new lineCanvas({el:document.getElementById("canvasTax"),clearEl:document.getElementById("clearCanvasTax"),saveEl:document.getElementById("saveCanvasTax"),linewidth:2,color:"black",background:"#ffffff"}),vm.submitSave=function(){var paramBase={id:vm.taxSignId,appNo:vm.taxSignAppNo,imageFlag:"HR01",imageName:vm.signResult.imageName,imagePath:vm.signResult.imagePath,insName:vm.userData.customerName,insCerType:vm.userData.cretType,insCerNo:vm.userData.cretNo};CommonRequest.request(paramBase,CONFIG.TAX_GROUP_SUBMITBASE,function(result){"1"==result.status&&$state.go("policy-complete")})},$rootScope.$on("$locationChangeSuccess",function(){location.reload()})}angular.module("app").controller("PolicySignController",PolicySignController),PolicySignController.$inject=["$scope","CommonRequest","CONFIG","TipService","$rootScope","VALIDATION","PolicyService","$state","$ionicHistory"]}(),function(){function PolicyCompleteController(CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,PolicyService,$state,$ionicHistory){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.next=function(){$state.go("tab.mall")}}angular.module("app").controller("PolicyCompleteController",PolicyCompleteController),PolicyCompleteController.$inject=["CommonRequest","CONFIG","TipService","$rootScope","VALIDATION","PolicyService","$state","$ionicHistory"]}(),function(){function PolicyPrompBookController(CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,PolicyService,$state){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.next=function(){$state.go("policy-sign")}}angular.module("app").controller("PolicyPrompBookController",PolicyPrompBookController),PolicyPrompBookController.$inject=["CommonRequest","CONFIG","TipService","$rootScope","VALIDATION","PolicyService","$state"]}(),function(){function claimsDirectoryController($scope,$state){var vm=this;vm.examples=function(){$state.go("claims-examples")},vm.flowPath=function(){$state.go("claims-flowpath")}}angular.module("app").controller("claimsDirectoryController",claimsDirectoryController),claimsDirectoryController.$inject=["$scope","$state"]}(),function(){function ClaimsInquiryController($scope,$state,$rootScope,CommonRequest,CONFIG,$timeout,PolicyService,$ionicLoading,TipService,$window,$interval){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData;var time;vm.timedCount=function(index,val){time=$interval(function(){var hour=0,minute=0,second=0;val>0&&(hour=Math.floor(val/3600),minute=Math.floor(val/60)-60*hour,second=Math.floor(val)-60*hour*60-60*minute),9>=hour&&(hour="0"+hour),9>=minute&&(minute="0"+minute),9>=second&&(second="0"+second),vm.claimsList[index].countDown=hour+":"+minute+":"+second,val--,0==val&&vm.claimLists()},1e3)},vm.claimLists=function(){var params={rcgnNm:vm.userData.customerName,rcgnGndCd:vm.userData.sex,rcgnCrdtNo:vm.userData.cretNo,rcgnBrthDt:vm.userData.birthday,rcgnCrdtTpCd:vm.userData.cretType};CommonRequest.request(params,CONFIG.QUERY_CLAIM_LIST,function(result){1==result.status&&vm.claimListsResult()})},vm.submitApplyNum=0;var time;vm.claimListsResult=function(){var params={};return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.submitApplyNum>=CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_TIMES?(vm.submitApplyNum=0,$ionicLoading.hide(),void TipService.showMsg("查询结果超时，请重新查询！")):void CommonRequest.request(params,CONFIG.QUERY_CLAIM_LIST_RESULT,function(result){if(result.status&&1==result.status){if(0==result.data.errorCode)return vm.submitApplyNum++,void $timeout(function(){vm.claimListsResult()},CONFIG.ONLINE_CLAIMS_APPLY_DECOUPLING_DURATION);$ionicLoading.hide(),vm.submitApplyNum=0,vm.claimsList=result.data.list;for(var i=0;i<vm.claimsList.length;i++)"0"==vm.claimsList[i].status&&vm.timedCount(i,vm.claimsList[i].duration);$rootScope.$broadcast("scroll.refreshComplete")}else $ionicLoading.hide(),vm.submitApplyNum=0},!0)},vm.detail=function(status,coreType,caseNo,interfaceCode){$state.go("claims-inquiry-detail",{status:status,coreType:coreType,claimsId:caseNo,interfaceCode:interfaceCode})},vm.queryFromCache=function(val){vm.params={serialNo:val},CommonRequest.request(vm.params,CONFIG.QUERY_CLAIM_FROM_CACHE,function(result){1==result.status&&(PolicyService.setSessionData({claimsPolicyInfo:result.data}),$state.go("claims-apply-message"))})},$scope.$on("$stateChangeStart",function(event,toState,toStateParams,fromState,fromStateParams){$interval.cancel(time)}),vm.getClaimLists=function(){$rootScope.isLogin?vm.claimLists():$timeout(function(){vm.getClaimLists()},1e3)},$scope.$on("$stateChangeSuccess",function(event,toState,toStateParams,fromState,fromStateParams){"claims-inquiry"==toState.name&&vm.getClaimLists()})}angular.module("app").controller("ClaimsInquiryController",ClaimsInquiryController),ClaimsInquiryController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","$timeout","PolicyService","$ionicLoading","TipService","$window","$interval"]}(),function(){function ClaimsRecordController($state,$rootScope,CommonRequest,CONFIG,COMMON,$scope,PolicyService,TipService,$ionicScrollDelegate,$timeout,$filter){var vm=this;vm.caseNo=$state.params.caseNo,vm.serialNo=$state.params.serialNo,vm.coreType=$state.params.coreType,"Z"==vm.coreType?vm.fileNameFlag=!0:vm.fileNameFlag=!1;var headHeight=0;if($rootScope.TITLEBAR&&(headHeight=44),!vm.containerRate){var containerH=$(".wx-claims-record").eq(0).height()-headHeight,containerW=$(".wx-claims-record").eq(0).width();vm.containerRate=containerW/containerH}vm.loadingPage=function(callback){vm.queryLastImg=function(ifmCodeArr,countNum,ifmCode){var param={serialNo:vm.serialNo,ifmCodeList:ifmCodeArr,rsrvFld8:"elife",countNum:countNum,sorted:0};CommonRequest.request(param,CONFIG.NEW_QUERY_LASTCOUNTIMG,function(result){if(result.status&&"1"==result.status&&result.data){var params;if("F016"==ifmCode){var arrList=result.data.imgDetail.F016;vm.historyCount=result.data.imgCount.F016}else if("F017"==ifmCode){
var arrList=result.data.imgDetail.F017;vm.chargeCount=result.data.imgCount.F017}else if("F000"==ifmCode)var arrList=result.data.imgDetail.F000;vm.minImgListst=[],vm.minImgInvoicest=[],vm.minImgIdst=[];for(var i=0;i<arrList.length;i++)arrList[i].imgURL=CONFIG.NEW_GET_CLAIM_IMAGE.url+"?serialNo="+vm.serialNo+"&ifmCode="+arrList[i].ifmCode+"&fileName="+arrList[i].imgName+"&type=THUMB";"F016"==ifmCode?(vm.minImgListst=arrList,params={F016:vm.minImgListst}):"F017"==ifmCode?(vm.minImgInvoicest=arrList,params={F017:vm.minImgInvoicest}):"F000"==ifmCode&&(vm.minImgIdst=arrList,params={F000:vm.minImgIdst}),PolicyService.setSessionData({claimsPolicyInfo:params})}})},vm.queryFromCache=function(val){var params={caseNo:vm.caseNo};CommonRequest.request(params,CONFIG.CLAIMS_CLAIMAPPLYINFO,function(result){1==result.status&&(vm.claimsData=result.data,PolicyService.setSessionData({claimsPolicyInfo:vm.claimsData}),vm.policyType="A"==vm.claimsData.rsrvFld9?"门诊费用":"住院费用",vm.claimsData.rcgnCrdtTpCd&&(vm.nationalities=COMMON.getNutNationalByCertType(vm.claimsData.rcgnCrdtTpCd),vm.nationnal=vm.nationalities[0].label),vm.accCause="1"==vm.claimsData.accCause?"意外":"疾病")})},vm.queryLastImg(["F000"],"2","F000"),vm.queryLastImg(["F016"],"4","F016"),vm.queryLastImg(["F017"],"4","F017"),vm.queryFromCache(),$timeout(function(){return vm.minImgListst&&vm.minImgInvoicest&&vm.minImgIdst?void(angular.isFunction(callback)&&callback()):void vm.loadingPage(callback)},500)},vm.goImgUpload=function(){var params={caseNo:vm.caseNo,serialNo:vm.caseNo};CommonRequest.request(params,CONFIG.CLAIMS_REAPPLY,function(result){1==result.status&&(vm.upload=result.data,PolicyService.setSessionData({claimsPolicyInfo:vm.upload}),$state.go("claims-apply-message"))})},vm.loadingPage(function(){var sessionData=PolicyService.getSessionData();vm.claimsPolicyInfo=sessionData.claimsPolicyInfo,vm.userData=sessionData.userData||null,vm.minImgId=vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F000||{},vm.minImgIdOne=vm.minImgId&&vm.minImgId[0]?vm.minImgId[0]:"",vm.minImgIdTwo=vm.minImgId&&vm.minImgId[1]?vm.minImgId[1]:"",vm.imgRateOne=vm.minImgIdOne.width/vm.minImgIdOne.height,vm.imgRateTwo=vm.minImgIdTwo.width/vm.minImgIdTwo.height,vm.minImgList=vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F016||{},vm.minImgInvoice=vm.claimsPolicyInfo&&vm.claimsPolicyInfo.F017||{},"+"==vm.minImgIdOne.description?vm.sortBy="+":vm.sortBy="-"}),vm.getImgDetail=function(type,imgName){$state.go("wxclaims-img-detail",{ifmCode:type,imgName:imgName,frompage:"record"})}}angular.module("app").controller("ClaimsRecordController",ClaimsRecordController),ClaimsRecordController.$inject=["$state","$rootScope","CommonRequest","CONFIG","COMMON","$scope","PolicyService","TipService","$ionicScrollDelegate","$timeout","$filter"]}(),function(){function ClaimsServiceController($ionicPopup,$scope,$state,$stateParams,CommonRequest,CONFIG,TipService,PolicyService,$rootScope,COMMON,$timeout){var vm=this;vm.goGuide=function(){$state.go("claims-directory")},vm.alertTip=function(val){$ionicPopup.confirm({template:"您有尚未填写完成的理赔申请，是否继续填写",cssClass:"alert-tip",buttons:[{text:"取消",type:"sale-cancle",onTap:function(res){if(res){var listData=val,rum={};rum.prdId=listData.prdId||"",rum.zipCode=listData.zipCode,rum.zipCode&&(rum.accDetailAdr=listData.accDetailAdr||"",rum.accAreaProvinceCode=listData.accAreaProvinceCode||"",rum.accAreaDistrictCode=listData.accAreaDistrictCode||"",rum.accAreaDstcCode=listData.accAreaDstcCode||"",rum.accAreaProvinceName=listData.accAreaProvinceName||"",rum.accAreaDistrictName=listData.accAreaDistrictName||"",rum.accAreaDstcName=listData.accAreaDstcName||"",rum.touchAddress=listData.touchAddress||""),rum.nation=listData.nation||"",rum.nationName=listData.nationName||"",rum.rcgnCareer=listData.rcgnCareer||"",rum.idArriveDate=listData.idArriveDate.replace(/-/g,"")||"",rum.bankAccNo=listData.bankAccNo||"",rum.bankOpen=listData.bankOpen||"",rum.bankProvince=listData.bankProvince||"",rum.bankCity=listData.bankCity||"",rum.bankProvinceName=listData.bankProvinceName||"",rum.bankDistrictName=listData.bankDistrictName||"",rum.accountLocation=listData.accountLocation||"",rum.bankOpenProvince={},rum.bankOpenCity={},PolicyService.setSessionData({claimsPolicyInfo:rum})}}},{text:"继续",type:"sale-sure",onTap:function(res){res&&(val?(PolicyService.setSessionData({claimsPolicyInfo:val}),$state.go(vm.pageNo)):$state.go("claims-inquiry"))}}]})},vm.queryClaimListCache=function(){CommonRequest.request({},CONFIG.QUERY_CLAIM_LIST_CACHE,function(result){result.data&&(vm.alertTip(result.data),vm.pageNo="claims-apply-message")})},vm.islogin=function(){$rootScope.isLogin?vm.queryClaimListCache():$timeout(function(){vm.islogin()},1e3)},$scope.$on("$stateChangeSuccess",function(event,toState,toStateParams,fromState,fromStateParams){"claims-service"==toState.name&&vm.islogin()}),vm.policyHave=function(){$rootScope.isLogin?CommonRequest.request({},CONFIG.WX_EXISTS_CLAIMS,function(result){if("0"==result.data.exists)TipService.showMsg("尊敬的客户：您的保单信息获取失败，个险业务请联系业务员、通过建信e保或我司分支机构柜面申请，团险业务请至我司分支机构进行理赔申请");else if("1"==result.data.exists)$state.go("claims-flowpath");else if("2"==result.data.exists){var msg="抱歉，暂不支持未满18周岁的被保险人在线申请理赔，请您通过我司服务柜面或服务人员申请理赔，如有疑问可咨询95331服务热线，谢谢！",ionicMsg=$ionicPopup.alert({title:"<i>!</i>",cssClass:"popup-icon",template:msg,okText:"我知道了"});ionicMsg.then(function(){})}}):$rootScope.WECHAT?COMMON.showModal("app/module/user/cert-bind/cert-bind.html"):COMMON.showModal("app/module/user/login/login.html")}}angular.module("app").controller("ClaimsServiceController",ClaimsServiceController),ClaimsServiceController.$inject=["$ionicPopup","$scope","$state","$stateParams","CommonRequest","CONFIG","TipService","PolicyService","$rootScope","COMMON","$timeout"]}(),function(){function DeclarationAccreditController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,CommonRequest){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.templateCode=productData.templateCode,$scope.noticeTag=function(healthTag){COMMON.hideModal()}}angular.module("app").controller("DeclarationAccreditController",DeclarationAccreditController),DeclarationAccreditController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","CommonRequest"]}(),function(){function FleeceAgreeController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,CommonRequest){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.templateCode=productData.templateCode,$scope.noticeTag=function(healthTag){COMMON.hideModal()}}angular.module("app").controller("FleeceAgreeController",FleeceAgreeController),FleeceAgreeController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","CommonRequest"]}(),function(){function PromptStatementController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,CommonRequest){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.templateCode=productData.templateCode,$scope.noticeTag=function(healthTag){COMMON.hideModal()}}angular.module("app").controller("PromptStatementController",PromptStatementController),PromptStatementController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","CommonRequest"]}(),function(){function RoutingCodeController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,CommonRequest){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.templateCode=productData.templateCode,$scope.noticeTag=function(healthTag){COMMON.hideModal()}}angular.module("app").controller("RoutingCodeController",RoutingCodeController),RoutingCodeController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","CommonRequest"]}(),function(){function StarAgentDetailController($ionicPopup,CommonRequest,CONFIG,TipService,$interval,$rootScope,$state,$scope,PolicyService,$ionicLoading,$timeout,COMMON,$location,$window){var vm=this;vm.id=$state.params.id,vm.tipsDivShow=!1,vm.commonImgPath="img/agent/agent-prod/",vm.domainURL=CONFIG.DOMAIN+"/";vm.duration=60,vm.messContent="获取验证码",vm.isLoadPrdId=!1,vm.showPreorder=!1,vm.isHonorBox=!1,vm.isHonor=!1,vm.isIntroduceBox=!1,vm.isIntroduce=!1,vm.productList=[{name:"金享未来两全保险",price:"600",title:"计划保险",img:"jxwl_main.png",id:"jxwl_"},{name:"康乐人生B款保险产品计划",price:"600",title:"计划保险",img:"klrs_b_main.png",id:"klrs_b_"},{name:"龙龘无双A款重疾医疗保险产品计划",price:"600",title:"计划保险",img:"ldws_a_main.png",id:"ldws_a_"},{name:"康乐安心保险产品计划",price:"600",title:"计划保险",img:"klax_main.png",id:"klax_"},{name:"龙耀一世B款终身寿险",price:"600",title:"计划保险",img:"lyys_b_main.png",id:"lyys_b_"}];var sessionData=PolicyService.getSessionData(),userdata=sessionData.userData||{};vm.agentInfo={},null!=userdata&&(vm.name=userdata.customerName,vm.phone=userdata.phoneNo),vm.hideLoading=function(){$ionicLoading.hide()},vm.showLoading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.productDetail=function(obj){$state.go("star-product-detail",{name:obj.name,title:obj.title,id:obj.id})},vm.getStarAgentDetail=function(){var params={id:vm.id,openId:vm.openid};CommonRequest.request(params,CONFIG.GET_STAR_AGENT_DETAIL,function(result){result.data&&(vm.agentInfo=result.data,document.querySelector("title").textContent=vm.agentInfo.name+"微名片",vm.agentInfo.imgPath?vm.isHasImg=!0:vm.isHasImg=!1,"1"==vm.agentInfo.isPrice?vm.priceName="已赞":vm.priceName="赞"),vm.init(),vm.checkHeight()})},vm.checkHeight=function(){var timer=$timeout(function(){var honorHeight=document.getElementById("honorText").offsetHeight;honorHeight>63&&(vm.isHonorBox=!0);var introduceHeight=document.getElementById("introduceText").offsetHeight;introduceHeight>63&&(vm.isIntroduceBox=!0),$timeout.cancel(timer)},200)},vm.hideTips=function(){vm.tipsDivShow=!1},vm.price=function(){if("1"!=vm.agentInfo.isPrice){var params={id:vm.id,openId:vm.openid};CommonRequest.request(params,CONFIG.NEW_PRICE_STAR_AGENT,function(result){"1"==result.status&&(vm.agentInfo.isPrice="1",vm.agentInfo.priceCount++,vm.priceName="已赞")})}else{vm.tipsDivShow=!0;var timer=$timeout(function(){vm.tipsDivShow=!1,$timeout.cancel(timer)},3e3)}},vm.call=function(){window.location.href="tel://"+vm.agentInfo.mobileNo},vm.openPreorderFrame=function(){vm.showPreorder=!0},vm.closePreorderFrame=function(){vm.showPreorder=!1},vm.toggleDown=function(key){vm[key]=!0},vm.toggleUp=function(key){vm[key]=!1},vm.order=function(){PolicyService.setSessionData({orderData:{agentId:vm.agentInfo.id,agentMobile:vm.agentInfo.mobileNo,agentName:vm.agentInfo.name}}),COMMON.showModal("app/module/star-agent/postcard-order/postcard-order.html")},vm.getOpenID=function(){$rootScope.openid?(vm.openid=$rootScope.openid,vm.getStarAgentDetail()):(vm.showLoading(),$timeout(function(){vm.getOpenID()},200))},vm.init=function(){var pageURL=window.location.href.split("#")[0],title="微名片："+vm.agentInfo.name,link=CONFIG.DOMAIN+"/elife-wechat/#/star-agent-detail/"+vm.id,desc="TA 是建信人寿最优秀的营销员伙伴之一",imgUrl=vm.domainURL+vm.agentInfo.imgPath,params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage"]}),wx.ready(function(){console.log(link),wx.onMenuShareTimeline({title:title,desc:desc,link:link,imgUrl:imgUrl,type:"link",dataUrl:"",success:function(){},cancle:function(){}}),wx.onMenuShareAppMessage({title:title,desc:desc,link:link,imgUrl:imgUrl,type:"link",dataUrl:"",success:function(){},cancle:function(){}})}),wx.error(function(res){alert(JSON.stringify(res)),alert("wx-error")})}},!0)},vm.isLongLink=function(){var code,url=$location.absUrl(),param=url.split("?")[1]||"";if(-1!=param.indexOf("code"))var codeStr=param?param.split("&")[0]:"",code=codeStr?codeStr.split("=")[1]:"";if(code||(code=$location.search().code),!code){var a_id=$state.params.id;$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fstar-agent-detail%2F"+a_id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}},vm.isLongLink(),vm.getOpenID()}angular.module("app").controller("StarAgentDetailController",StarAgentDetailController),StarAgentDetailController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$interval","$rootScope","$state","$scope","PolicyService","$ionicLoading","$timeout","COMMON","$location","$window"]}(),function(){function StarAgentIndexController($ionicPopup,CommonRequest,CONFIG,TipService,$interval,$rootScope,$state,$scope,$ionicLoading,$timeout){function transOrigin(data){if(vm.transOriginTime>5&&(vm.pageStatus=3),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer),vm.transOriginTime++},200)}function translateCallback(data){0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var data=result.addressComponents;-1!=data.province.indexOf("上海")||-1!=data.province.indexOf("重庆")||-1!=data.province.indexOf("天津")||-1!=data.province.indexOf("北京")?(vm.locate=data.province+"-"+data.district,vm.locateName=vm.locate):(vm.locate=data.province+"-"+data.city+"-"+data.district,vm.locateName=data.province+"-"+data.city),vm.queryAgentList()}else positionError()})}function positionError(){vm.pageStatus=2,$ionicLoading.hide()}function winResize(){var nowHeight=document.documentElement.clientHeight||document.body.clientHeight;clHeight-nowHeight>20||document.getElementById("wordSearch").blur()}var vm=this,pageData=sessionStorage.getItem("elife-agent");vm.domainURL=CONFIG.DOMAIN+"/",pageData?(pageData=JSON.parse(pageData),vm.locate=pageData.locate,vm.locateName=pageData.locateName,vm.list=pageData.list,vm.keyword=pageData.keyword):(vm.locate="",vm.locateName=""),vm.tipsDivShow=!1,vm.selctCity=!0,vm.isLoadPrdId=!1,vm.pageStatus=1,vm.portStatus=1,vm.hideLoading=function(){$ionicLoading.hide()},vm.timingHide=function(res){vm.tipsDiv=res,vm.tipsDivShow=!0,interval=$interval(function(){vm.timing>0&&vm.timing--},1e3)},vm.showLoading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.loadPrdId=function(){var params={prdCode:"ALLIN"};CommonRequest.request(params,CONFIG.NEW_GETPRDID,function(result){vm.isLoadPrdId=!0,vm.hideLoading(),result.data&&(vm.curProId=result.data)},!0)},vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){vm.showLoading(),wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){positionError()}})}),wx.error(function(res){positionError()})}else positionError()})},vm.transOriginTime=1,vm.queryAgentList=function(callBack,val){vm.portStatus=1;var params={address:vm.locate},flag=!1;val&&(flag=!0),CommonRequest.request(params,CONFIG.QUERY_STAR_AGENT_LIST,function(result){result&&1==result.status?(vm.list=result.data,vm.list.length>0?vm.pageStatus=1:vm.pageStatus=4):vm.pageStatus=3,callBack&&callBack()},flag)},vm.wordSearchList=function(callBack,val){vm.portStatus=2;var params={name:vm.keyword},flag=!1;val&&(flag=!0),CommonRequest.request(params,CONFIG.QUERY_STAR_AGENT_KEYWORD_LIST,function(result){result&&1==result.status?(vm.list=result.data,vm.list.length>0?vm.pageStatus=1:vm.pageStatus=4):vm.pageStatus=3,callBack&&callBack()},flag)},vm.viewStarAgentDetail=function(agentId){vm.inputSearchBlur=!0;var data={list:vm.list,locate:vm.locate,keyword:vm.keyword,locateName:vm.locateName};sessionStorage.setItem("elife-agent",JSON.stringify(data)),$state.go("star-agent-detail",{id:agentId})},vm.loadingPage=function(){$timeout(function(){$rootScope.loadingPage?vm.getPosition():vm.loadingPage()},100)},vm.refresh=function(){1==vm.portStatus?vm.queryAgentList(function(){$rootScope.$broadcast("scroll.refreshComplete")},!0):2==vm.portStatus&&vm.wordSearchList(function(){$rootScope.$broadcast("scroll.refreshComplete")},!0)},vm.getOpenID=function(){$rootScope.openid?console.info($rootScope.openid):$timeout(function(){vm.getOpenID()},1e3)},vm.keywordSearch=function(e){var keycode=e.keyCode;"13"==keycode&&document.getElementById("wordSearch").blur()};var clHeight=document.documentElement.clientHeight||document.body.clientHeight;window.addEventListener("resize",winResize),vm.blurSearch=function(){var timer=$timeout(function(){vm.inputSearchBlur||(vm.inputSearchBlur=!1,vm.wordSearchList()),$timeout.cancel(timer)},100)},$scope.$on("select-area-back",function(e,val){var str=vm.locate;str=str.split("-"),str.length>2?-1!=str[0].indexOf("上海")||-1!=str[0].indexOf("重庆")||-1!=str[0].indexOf("天津")||-1!=str[0].indexOf("北京")?vm.locateName=str[0]+"-"+str[2]:vm.locateName=str[0]+"-"+str[1]:vm.locateName=vm.locate,vm.queryAgentList()}),pageData||vm.loadingPage(),$rootScope.$on("$stateChangeStart",function(event,toState){window.removeEventListener("resize",winResize)})}angular.module("app").controller("StarAgentIndexController",StarAgentIndexController),StarAgentIndexController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$interval","$rootScope","$state","$scope","$ionicLoading","$timeout"]}(),function(){function PostcardOrderController($ionicPopup,CommonRequest,CONFIG,PolicyService,TipService,$interval,$rootScope,$state,$scope,$ionicLoading,$timeout,COMMON,TIPS){var vm=this;vm.messContent="获取验证码",vm.tipsDivShow=!1,vm.orderData=sessionStorage.getItem("elife-orderData"),vm.orderData&&(vm.orderData=JSON.parse(vm.orderData));var codetiming;vm.close=function(){COMMON.hideModal()},vm.timingHide=function(res){vm.tipsDiv=res,vm.tipsDivShow=!0;var timer=$timeout(function(){vm.tipsDivShow=!1,vm.tipsDiv="",$timeout.cancel(timer)},3e3)},vm.hideTips=function(){vm.tipsDivShow=!1},vm.codeStatus=!0,vm.getMessageInfo=function(flag){if(flag&&vm.phone){if(vm.codeStatus)return;var messParams={mobileNo:vm.phone,txCode:"CCBSB100"};CommonRequest.request(messParams,CONFIG.SEND_EXPS_MSG_SERVICE,function(result){vm.duration=60,vm.codeStatus=!0,vm.messContent="60s",vm.countDown()})}},vm.countDown=function(){codetiming=$interval(function(){vm.duration<=0?($interval.cancel(codetiming),vm.codeStatus=!1,vm.messContent="获取验证码"):(vm.duration--,vm.messContent=vm.duration+"s")},1e3)};var regxPhone=/^[1][0-9]{10}$/;$scope.$watch("postcardOrder.phone",function(newValue){vm.phone&&(11==newValue.length&&regxPhone.test(vm.phone)?(vm.phoneImg=!0,vm.codeStatus=!1):vm.phoneImg=!1)}),vm.errorAlert=function(name,err){vm.iosBlur(),"name"==name?(err.length&&vm.timingHide(TIPS.getTips().COMMON.USER_NAME_LENGTH_ERROR),err.invalid&&vm.timingHide(TIPS.getTips().COMMON.USER_NAME_INVALID)):"phone"==name?err.invalid&&vm.timingHide(TIPS.getTips().COMMON.PHONE_INVALID):"phoneCode"==name&&(err.invalid&&vm.timingHide(TIPS.getTips().COMMON.PHONECODE_INVALID),err.length&&vm.timingHide(TIPS.getTips().COMMON.PHONECODE_LENGTH_ERROR))},vm.iosBlur=function(){var timer=$timeout(function(){var scrollHeight=document.documentElement.scrollTop||document.body.scrollTop||0;window.scrollTo(0,Math.max(scrollHeight-1,0)),$timeout.cancel(timer)},100)},vm.pretSubimt=function(allErr){if(console.info(allErr),!vm.name)return void vm.timingHide("请填写您的姓名");if(allErr.name.$error.length)return void vm.timingHide(TIPS.getTips().COMMON.USER_NAME_LENGTH_ERROR);if(allErr.name.$error.invalid)return void vm.timingHide(TIPS.getTips().COMMON.USER_NAME_INVALID);if(!vm.phone)return void vm.timingHide("请填写您的手机号码");if(allErr.phone.$error.invalid)return void vm.timingHide(TIPS.getTips().COMMON.PHONE_INVALID);if(void 0==vm.phoneCode||""==vm.phoneCode)return void vm.timingHide("请输入短信验证码");if(allErr.phoneCode.$error.invalid)return void vm.timingHide(TIPS.getTips().COMMON.PHONECODE_INVALID);if(allErr.phoneCode.$error.length)return void vm.timingHide(TIPS.getTips().COMMON.PHONECODE_LENGTH_ERROR);var params={agentId:vm.orderData.agentId,agentMobile:vm.orderData.agentMobile,agentName:vm.orderData.agentName,orderName:vm.name,orderMobile:vm.phone,validCode:vm.phoneCode};CommonRequest.request(params,CONFIG.PREORDER_STAR_AGENT,function(result){if(vm.close(),sessionStorage.removeItem("elife-orderData"),"1"==result.status){$ionicPopup.confirm({title:'<img src="img/user/activation_success.png">',template:"<br>您已成功预约</br>明星营销员 "+vm.orderData.agentName+"将与您联系并为您提供服务请注意电话接听!",cssClass:"distingguishPopupSuccess postcardAlert",buttons:[{text:"我知道了",type:"button-positive",onClick:function(){}}]})}else"9"==result.status&&(TipService.showMsg("您已预约过该明星代理人"),vm.name="",vm.phoneCode="",vm.phone="",vm.showPreorder=!1)})}}angular.module("app").controller("PostcardOrderController",PostcardOrderController),PostcardOrderController.$inject=["$ionicPopup","CommonRequest","CONFIG","PolicyService","TipService","$interval","$rootScope","$state","$scope","$ionicLoading","$timeout","COMMON","TIPS"]}(),function(){function StarProductDetailController($ionicPopup,CommonRequest,CONFIG,TipService,$interval,$rootScope,$state,$scope,PolicyService,$ionicLoading,$timeout,COMMON){var vm=this;vm.id=$state.params.id,vm.imgList=[],vm.getList=function(){"jxwl_"===vm.id?(vm.imgList=vm.createList(vm.id,1),vm.name="金享未来两全保险",vm.desc="长期规划更放心 保额递增更安心 资金安全更舒心 周全保障更贴心"):"klrs_b_"===vm.id?(vm.imgList=vm.createList(vm.id,4),vm.name="康乐人生B款保险产品计划",vm.desc="（本计划由《康乐人生B款两全保险》与《附加康乐人生B款重大疾病保险》构成）"):"klax_"===vm.id?(vm.imgList=vm.createList(vm.id,4),vm.name="康乐安心保险产品计划",vm.desc="健康管家“医”夫当关 特重兼备150中疾病 理赔有劲 医疗补偿金 确诊零负 豁免保费 提前给付"):"lyys_b_"===vm.id?(vm.imgList=vm.createList(vm.id,4),vm.name="龙耀一世B款终身寿险",vm.desc="住院可享每日津贴 重症监护双倍赔付 有无社保人人皆享 满级给付人财两得"):"ldws_a_"===vm.id?(vm.imgList=vm.createList(vm.id,13),vm.name="龙龘无双A款重疾医疗保险产品计划",vm.desc="保额累计 复利增长 抵御膨胀 抵御膨胀 锁定利益 灵活领取 一张保单 三代共享"):(vm.imgList=vm.createList(vm.id,4),vm.name="",vm.desc="")},vm.createList=function(id,num){for(var arr=[],i=0;num>i;i++){var index=i+1;arr.push("img/agent/agent-prod/"+id+index+".jpg")}return arr},vm.init=function(){var pageURL=window.location.href.split("#")[0],title=vm.name,link=CONFIG.DOMAIN+"/elife-wechat/#/star-product-detail/"+vm.id,desc=vm.desc,imgUrl=CONFIG.DOMAIN+"/elife-wechat/img/agent/agent-prod/"+vm.id+"main.png",params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","getLocation"]}),wx.ready(function(){wx.onMenuShareTimeline({title:title,desc:desc,link:link,imgUrl:imgUrl,type:"link",dataUrl:"",success:function(){},cancle:function(){}}),wx.onMenuShareAppMessage({title:title,desc:desc,link:link,imgUrl:imgUrl,type:"link",dataUrl:"",success:function(){},cancle:function(){}})}),wx.error(function(res){alert(JSON.stringify(res)),alert("wx-error")})}},!0)},vm.getList(),vm.init()}angular.module("app").controller("StarProductDetailController",StarProductDetailController),StarProductDetailController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$interval","$rootScope","$state","$scope","PolicyService","$ionicLoading","$timeout","COMMON"]}(),function(){function AppDownLoadController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){var vm=this,nowDate=new Date;vm.nowDate=nowDate.getMonth()+1+"月"+nowDate.getDate()+"日"}angular.module("app").controller("AppDownLoadController",AppDownLoadController),AppDownLoadController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function DyAboutCompanyController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state,$scope){var vm=this;vm.userServiceActived="3",vm.productList=[];var params={userServiceActived:vm.userServiceActived};CommonRequest.request(params,CONFIG.SUBSCRIBE_USERSERVICE_PRODUCTLIST,function(result){if(1==result.status){var data=result.data;vm.productList=data}})}angular.module("app").controller("DyAboutCompanyController",DyAboutCompanyController),DyAboutCompanyController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state","$scope"]}(),function(){function DyCompanyInfoController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,VALIDATION,$location,$state){var vm=this,nowDate=new Date;vm.nowDate=nowDate.getMonth()+1+"月"+nowDate.getDate()+"日"}angular.module("app").controller("DyCompanyInfoController",DyCompanyInfoController),DyCompanyInfoController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$location","$state"]}(),function(){function DyHotProductController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){}angular.module("app").controller("DyHotProductController",DyHotProductController),DyHotProductController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function DyOccupationController($ionicPopup,CommonRequest,CONFIG,TipService,$scope,$rootScope){function transData(result){if(!result||!angular.isArray(result))return[];for(var arr=[],i=0;i<result.length;i++){var list=recursiveItem(result[i],[],1,0);arr.push({id:i,num:list})}return arr}function recursiveItem(res,list,level){if(res&&res.data&&angular.isArray(res.data))for(var i=0;i<res.data.length;i++)1==level&&(res.data[i].p1code=res.careerTypeCode,res.data[i].p1Name=res.careerTypeName,res.data[i].level=level+1,res.data[i].lid=level+1+"-"+i),2==level&&(res.data[i].p1code=res.p1code,res.data[i].p1Name=res.p1Name,res.data[i].p2code=res.careerSubtypeCode,res.data[i].p2Name=res.careerSubtypeName,res.data[i].rowNum=res.data.length,res.data[i].plid=res.lid,res.data[i].lid=res.lid+"-"+i),recursiveItem(res.data[i],list,level+1);else res&&angular.isObject(res)&&(list.length>0?res.plid!==list[list.length-1].plid?res.maxTd=list[list.length-1].rowNum+list[list.length-1].maxTd:res.maxTd=list[list.length-1].maxTd:res.maxTd=0,list.push(res));return list}var vm=this;$scope.$watch("dyOccupation.searchInput",function(newValue){if(newValue){var params={param:newValue};CommonRequest.request(params,CONFIG.SUBSCRIBE_OCCUPATION,function(result){"1"==result.status?vm.searchLists=result.data:vm.searchLists="",vm.mapList=transData(vm.searchLists)})}else{var params={param:""};CommonRequest.request(params,CONFIG.SUBSCRIBE_OCCUPATION,function(result){"1"==result.status&&(vm.searchLists=result.data,vm.mapList=transData(vm.searchLists))})}}),vm.goRefresh=function(){var params={param:vm.searchInput||""};CommonRequest.request(params,CONFIG.SUBSCRIBE_OCCUPATION,function(result){"1"==result.status?vm.searchLists=result.data:vm.searchLists="",vm.mapList=transData(vm.searchLists),$rootScope.$broadcast("scroll.refreshComplete")},!0)},vm.clearInput=function(){vm.searchInput="",vm.searchLists=""}}angular.module("app").controller("DyOccupationController",DyOccupationController),DyOccupationController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$scope","$rootScope"]}(),function(){function DyPartnerInfoController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){var vm=this,nowDate=new Date;vm.nowDate=nowDate.getMonth()+1+"月"+nowDate.getDate()+"日"}angular.module("app").controller("DyPartnerInfoController",DyPartnerInfoController),DyPartnerInfoController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function DyPayforHospitalController($ionicPopup,CommonRequest,CONFIG,TipService,$timeout,$scope,$ionicLoading){function getDataFn(param){CommonRequest.request(param,CONFIG.DY_PAY_HOSPITAL,function(result){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),"1"==result.status?($ionicLoading.hide(),vm.province=result.data,vm.province.forEach(function(items,index){items.data.forEach(function(item,index){$timeout(function(){for(var i=0;i<item.data.length%3;i++)item.data.push({});$(".hos-table .one-right")[0]&&$(".hos-table .one-right").each(function(){$(this).children().length<=3?$(this).children().css({height:"100%",padding:"12px 5px"}):$(this).children().length<=6&&$(this).children().length>3&&$(this).children().css({height:"50%",padding:"5px 5px"})})},0)})})):(vm.province=[],$ionicLoading.hide())},!0)}var vm=this;vm.overAdress=null,vm.isFlag=!1,vm.getPosAdress=function(){function transOrigin(data){if(vm.transOriginTime>5&&TipService.showMsg("网络异常，请稍后重试"),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer),vm.transOriginTime++},200)}function translateCallback(data){0===data.status?(getAddress(data.points[0]),vm.nowlongitude=data.points[0].lng,vm.noelatitude=data.points[0].lat,$ionicLoading.hide()):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){result?(vm.isFlag=!0,$timeout(function(){$scope.$apply(function(){vm.address=result.address,$ionicLoading.hide(),vm.oneAdr=result.addressComponents.city,vm.twoAdr=result.addressComponents.district,vm.addressCity=vm.address.split("市")[0]+"市"})},0)):positionError()})}function positionError(){alert("定位失败请手动选择"),$ionicLoading.hide(),vm.isFlag=!0;var param={hptSheng:"",hptShi:"",hptName:""};getDataFn(param)}$timeout(function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},0),vm.list=[1,1,1,1,1,1,1],vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(vm.positionTy=1,1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){vm.positionTy=0,positionError(),alert(JSON.stringify(eror))},cancel:function(){alert("用户取消")}})}),wx.error(function(res){positionError()})}else positionError()},!0)},vm.transOriginTime=1,vm.getPosition()};var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"允许定位吗？",okText:"允许",cancelText:"拒绝"});alertPopup.then(function(res){res?vm.getPosAdress():(vm.isFlag=!0,vm.searchInput="")}),$scope.$watch("dyPayforHospital.searchInput",function(newValue){if(vm.isFlag){var param={hptSheng:vm.oneAdr||"",hptShi:vm.twoAdr||"",hptName:newValue||""};getDataFn(param)}});var hosSecAdr=document.getElementById("hosSecAdr");CommonRequest.request({hptSheng:"",hptShi:"",hptName:""},CONFIG.DY_PAY_HOSPITAL_ADRESS,function(result){if(1==result.status&&(vm.cityData=result.data,vm.cityData)){new PickerExtend({trigger:hosSecAdr,title:"地区选择-联动",wheels:[{data:vm.cityData}],position:[0,0],callback:function(indexArr,data){$scope.$apply(function(){vm.addressCity=data[0].value,vm.overAdress=data[0].value+data[1].value,vm.oneAdr=data[0].value,vm.twoAdr=data[1].value})}})}},!0),$scope.$watch("dyPayforHospital.twoAdr",function(newValue){if(newValue){var param={hptSheng:vm.oneAdr||"",hptShi:vm.twoAdr||"",hptName:""};getDataFn(param)}}),vm.clearInput=function(){vm.searchInput="",vm.province=[]}}angular.module("app").controller("DyPayforHospitalController",DyPayforHospitalController),
DyPayforHospitalController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$timeout","$scope","$ionicLoading"]}(),function(){function DyPolicyRegularController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state,$scope){var vm=this,nowDate=new Date;vm.nowDate=nowDate.getMonth()+1+"月"+nowDate.getDate()+"日",vm.userServiceActived="3",vm.productList=[];var params={userServiceActived:vm.userServiceActived};CommonRequest.request(params,CONFIG.SUBSCRIBE_USERSERVICE_PRODUCTLIST,function(result){if(1==result.status){var data=result.data;vm.productList=data}})}angular.module("app").controller("DyPolicyRegularController",DyPolicyRegularController),DyPolicyRegularController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state","$scope"]}(),function(){function DyRecruitPeopleController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){}angular.module("app").controller("DyRecruitPeopleController",DyRecruitPeopleController),DyRecruitPeopleController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function DyProductListController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){}angular.module("app").controller("DyProductListController",DyProductListController),DyProductListController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function DySubscribeController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state,$timeout){var vm=this;CommonRequest.request({},CONFIG.SUBSCRIBE_GET_STATIC,function(result){if("1"==result.status){vm.linkStatic=result.data,vm.linkStaticArr=[];for(var i=0;i<result.data.length;i++)switch(result.data[i].StaticCode){case"01":vm.downLoad=result.data[i].StaticResource;break;case"02":vm.downLoadImg=result.data[i].StaticResource;break;case"03":vm.dyRecruitPeople=result.data[i].StaticResource;break;case"04":vm.doubleKnowlage=result.data[i].StaticResource;break;case"05":vm.rateAnnounce=result.data[i].StaticResource;break;case"06":vm.physicalNotice=result.data[i].StaticResource;break;case"07":vm.highIntro=result.data[i].StaticResource;break;case"08":vm.preservationKnowlage=result.data[i].StaticResource;break;case"09":vm.preservationUp=result.data[i].StaticResource;break;case"10":vm.preservationDown=result.data[i].StaticResource;break;case"11":vm.claimDocumnet=result.data[i].StaticResource;break;case"12":vm.claimExample=result.data[i].StaticResource;break;case"13":vm.claimKnowlage=result.data[i].StaticResource;break;case"14":vm.selfClaimIntro=result.data[i].StaticResource;break;case"15":vm.onlineActive=result.data[i].StaticResource;break;case"16":vm.insureQustion=result.data[i].StaticResource;break;case"17":vm.cashQustion=result.data[i].StaticResource;break;case"18":vm.skyInfo=result.data[i].StaticResource;break;case"19":vm.debitBank=result.data[i].StaticResource;break;case"20":vm.conpanyInfo=result.data[i].StaticResource}}});for(var aLi=document.querySelectorAll(".one li"),i=0;i<aLi.length;i++)aLi[i].onclick=function(e){if(e.stopPropagation(),this.querySelector("ul")){for(var oLi=document.querySelectorAll(".one>li ul"),i=0;i<oLi.length;i++)oLi[i].style.display="none";for(var iLi=document.querySelectorAll(".one>li>ul"),i=0;i<iLi.length;i++)this!==iLi[i]&&(this.parentNode.style.display="block"),this.querySelector("ul").style.display="block"}}}angular.module("app").controller("DySubscribeController",DySubscribeController),DySubscribeController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state","$timeout"]}(),function(){function UserServiceController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state,$scope){var vm=this;vm.userServiceActived="1",vm.productList=[],$scope.$watch("userService.userServiceActived",function(newdata){vm.productList=[];var params={serviceType:vm.userServiceActived};CommonRequest.request(params,CONFIG.SUBSCRIBE_USER_SERVICE,function(result){if(1==result.status){var data=result.data;vm.productList=data;for(var i=0;i<vm.productList.length;i++)vm.productList[i].serviceImg=CONFIG.IMAGE_SERVICE_ADDRESS+"/"+vm.productList[i].serviceImg}})}),vm.goDetailList=function(newValue){"0"==newValue.subType?$state.go("user-service-detail",{readNum:newValue.readNum,serviceId:newValue.serviceId,serviceName:newValue.serviceName,sendTime:newValue.sendTime}):"1"==newValue.subType?$state.go("user-service-detail",{readNum:newValue.readNum}):"2"==newValue.subType&&$state.go("user-service-detail",{readNum:newValue.readNum})}}angular.module("app").controller("UserServiceController",UserServiceController),UserServiceController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state","$scope"]}(),function(){function VipServiceController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope){}angular.module("app").controller("VipServiceController",VipServiceController),VipServiceController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope"]}(),function(){function DyUserserCounterController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$scope,$timeout,$interval,$ionicLoading){var vm=this;vm.dyCopyMask=!1,vm.poiIsTrue=!1,vm.getPoiIsTrue=!1,vm.isFlag=!1,vm.searchListTotal=0,vm.getPosAdress=function(){function transOrigin(data){if(vm.transOriginTime>5&&TipService.showMsg("网络异常，请稍后重试"),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer),vm.transOriginTime++},200)}function translateCallback(data){0===data.status?(getAddress(data.points[0]),vm.nowlongitude=data.points[0].lng,vm.noelatitude=data.points[0].lat):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){result?($ionicLoading.hide(),$timeout(function(){$scope.$apply(function(){vm.address=result.address,vm.addressCity=vm.address.split("市")[0]+"市",vm.oneAdr=result.addressComponents.city,vm.twoAdr=result.addressComponents.district})},0)):positionError()})}function positionError(){vm.getPoiIsTrue=!0,alert("定位失败请手动选择"),vm.getCounterList()}vm.poiIsTrue||($timeout(function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},0),vm.list=[1,1,1,1,1,1,1],vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(vm.positionTy=1,1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){vm.positionTy=0,positionError(),alert(JSON.stringify(eror))},cancel:function(){alert("用户取消")}})}),wx.error(function(res){positionError()})}else positionError()},!0)},vm.transOriginTime=1,vm.getPosition())};var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"允许定位吗？",okText:"允许",cancelText:"拒绝"});alertPopup.then(function(res){res?(vm.getPosAdress(),vm.poiIsTrue=!0,vm.getPoiIsTrue=!0):(vm.getPoiIsTrue=!0,vm.searchInput="")}),vm.adressGetAtitude=function(addressName,Dom,callback){if(BMap){var myGeo=new BMap.Geocoder;myGeo.getPoint(addressName,function(point){callback(point.lng,point.lat,Dom)},vm.addressCity)}else $ionicLoading.hide()},vm.getPosDistance=function(lng1,lat1,lng2,lat2,Dom,callback){var map=new BMap.Map("allmap"),pointA=new BMap.Point(lng1,lat1),pointB=new BMap.Point(lng2,lat2),getdistance=map.getDistance(pointA,pointB).toFixed(0);getdistance>1e3?getdistance=getdistance/1e3+"km":getdistance+="m",callback(getdistance,Dom)},vm.callPhone=function(surfaceTel){window.location.href="tel://"+surfaceTel},vm.endNum=1,vm.ifUpLoad=!1,vm.searchLists=[],vm.pageSize="6",vm.getCounterList=function(newValue){var params={surfaceProvince:vm.oneAdr||"",surfaceCity:vm.twoAdr||"",param:newValue||"",beginPage:vm.endNum,pageSize:vm.pageSize};CommonRequest.request(params,CONFIG.SUBSCRIBE_FACE_SERVICE,function(result){"1"==result.status?(vm.ifUpLoadBefore=!0,vm.searchListTotal=result.data.totalRows,vm.searchLists.length<result.data.totalRows&&(vm.searchLists=vm.searchLists.concat(result.data.dataList),$scope.$broadcast("scroll.infiniteScrollComplete"))):vm.searchLists=[]})},$scope.$watch("dyUserserCounter.twoAdr",function(newValue,oldValue){vm.ifUpLoadBefore=!0,vm.searchListTotal=0,newValue&&(vm.searchLists=[],vm.endNum=1,vm.getCounterList())}),$scope.$watch("dyUserserCounter.searchInput",function(newValue){vm.searchValue=newValue,vm.getPoiIsTrue&&(newValue?(vm.searchLists=[],vm.endNum=1,vm.getCounterList(newValue)):(vm.endNum=1,vm.getCounterList("")))}),$scope.$watch("dyUserserCounter.searchLists",function(newValue,oldValue){if(newValue[0]){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.addressTimes=0;var interVal=$interval(function(){if(vm.addressTimes<6)if(vm.addressTimes++,vm.nowlongitude&&vm.noelatitude){$interval.cancel(interVal);for(var key in newValue){var thisDom=newValue[key];thisDom.index=key;var address=thisDom.surfaceDetail;vm.adressGetAtitude(address,thisDom,function(olng,olat,thisDom){vm.getPosDistance(vm.nowlongitude,vm.noelatitude,olng,olat,thisDom,function(distance,thisDom){newValue[thisDom.index].attitude={lng:olng,lat:olat},newValue[thisDom.index].distance=distance,$ionicLoading.hide()})})}}else $ionicLoading.hide();else $interval.cancel(interVal),$ionicLoading.hide(),vm.poiIsTrue},1e3)}}),vm.clearInput=function(){vm.searchInput="",vm.searchLists=[]};var clipboard=new ClipboardJS(".dy-copy");clipboard.on("success",function(e){if(!vm.dyCopyMask){$timeout(function(){vm.dyCopyMask=!0;var timer=$timeout(function(){vm.dyCopyMask=!1,$timeout.cancel(timer)},1e3)},100)}e.clearSelection()}),clipboard.on("error",function(e){console.error("Action:",e.action)});var counSecAdr=document.getElementById("counSecAdr"),params={surfaceProvince:"",surfaceCity:"",param:""};CommonRequest.request(params,CONFIG.SUBSCRIBE_CITY_FACE,function(result){if("1"==result.status){vm.cityData=result.data;new PickerExtend({trigger:counSecAdr,title:"地区选择-联动",wheels:[{data:vm.cityData}],position:[0,0],callback:function(indexArr,data){$scope.$apply(function(){vm.addressCity=data[0].value,vm.overAdress=data,vm.oneAdr=data[0].value,vm.twoAdr=data[1].value})}})}}),vm.clientHeight=$(window).height(),vm.ifUpLoadBefore=!0,vm.do_infinite=function(){return vm.searchLists.length<5?$("#dyCounterHamore").css("top",vm.clientHeight):($("#dyCounterHamore").css("top","auto"),$("#dyCounterHamore").css("marginTop","-20px")),vm.searchLists.length>=vm.searchListTotal?void(vm.ifUpLoadBefore=!1):(vm.ifUpLoad=!0,vm.endNum++,void vm.getCounterList(vm.searchValue))}}angular.module("app").controller("DyUserserCounterController",DyUserserCounterController),DyUserserCounterController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$scope","$timeout","$interval","$ionicLoading"]}(),function(){function AppDownLoadDetailController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){var vm=this;vm.readNum=$state.params.readNum,vm.serviceId=$state.params.serviceId,vm.serviceName=$state.params.serviceName,vm.sendTime=$state.params.sendTime,vm.nowDate=new Date(vm.sendTime).toLocaleString(),vm.nowDate=vm.nowDate.substr(5,1)+"月"+vm.nowDate.substr(7,2)+"日";var params={resourceId:vm.serviceId,resourceType:"3"};CommonRequest.request(params,CONFIG.SUBSCRIBE_USER_SERVICE_DETAIL,function(result){if(1==result.status){result.data}})}angular.module("app").controller("AppDownLoadDetailController",AppDownLoadDetailController),AppDownLoadDetailController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function UserServiceDetailController($ionicPopup,CommonRequest,CONFIG,TipService,$rootScope,$state){var vm=this;vm.readNum=$state.params.readNum,vm.serviceId=$state.params.serviceId,vm.serviceName=$state.params.serviceName,vm.sendTime=$state.params.sendTime,vm.nowDate=new Date(vm.sendTime).toLocaleString(),vm.nowDate=vm.nowDate.substr(5,1)+"月"+vm.nowDate.substr(7,2)+"日";var params={resourceId:vm.serviceId,resourceType:"3"};CommonRequest.request(params,CONFIG.SUBSCRIBE_USER_SERVICE_DETAIL,function(result){1==result.status&&(vm.detailList=result.data,vm.detailList[0].imgUrl=CONFIG.IMAGE_SERVICE_ADDRESS+"/"+vm.detailList[0].imgUrl)})}angular.module("app").controller("UserServiceDetailController",UserServiceDetailController),UserServiceDetailController.$inject=["$ionicPopup","CommonRequest","CONFIG","TipService","$rootScope","$state"]}(),function(){function analyticalInfoController($ionicPopup,$ionicLoading,LoginService,$scope,$state,$stateParams,CommonRequest,CONFIG,TipService,PolicyService,$rootScope,$location,COMMON,$timeout){var vm=this;$rootScope.isLogin=!0,vm.loading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.loading();var loginParmas=$state.params.loginParmas,goto=$state.params["goto"],params={login_parmas:loginParmas};CommonRequest.request(params,CONFIG.NEW_LOGIN_OR_REGIST,function(result){if(1==result.status){sessionStorage.setItem("fromapp","Y");var userIn=result.data;if(userIn.plchdAppFlag="Y",$rootScope.userData=result.data,sessionStorage.setItem("elife-userData",JSON.stringify(userIn)),$rootScope.userData=angular.fromJson(sessionStorage.getItem("elife-userData")),LoginService.storeUserData(result),sessionStorage.setItem("elife-loginStatus",2),goto.length>1)$state.go(goto);else{var getUrlList={url:CONFIG.DOMAIN+"/statics/json/0188list.json",method:"GET"};CommonRequest.request({},getUrlList,function(res){if(res.data){res.data;goto=res.data[goto],console.info(res.data),$state.go(goto)}})}}}),vm.goState=function(state){"Y"==sessionStorage.getItem("fromapp")?$state.go(state):TipService.showMsg("登录失败,请退出重试")}}angular.module("app").controller("analyticalInfoController",analyticalInfoController),analyticalInfoController.$inject=["$ionicPopup","$ionicLoading","LoginService","$scope","$state","$stateParams","CommonRequest","CONFIG","TipService","PolicyService","$rootScope","$location","COMMON","$timeout"]}(),function(){function CertUnbindController($state,CommonRequest,CONFIG,$ionicPopup,LoginService){var vm=this;vm.unbind=function(){var alertPopup=$ionicPopup.confirm({title:"警告",template:"本次操作将把您的个人信息与微信解绑，请确认是否继续操作？",okText:"确认",cancelText:"取消"});alertPopup.then(function(res){res&&CommonRequest.request({},CONFIG.WECHAT_UNBIND_SERVCIE,function(result){1==result.status&&(LoginService.logout(),$state.go("cert-unbind-success"))})})}}angular.module("app").controller("CertUnbindController",CertUnbindController),CertUnbindController.$inject=["$state","CommonRequest","CONFIG","$ionicPopup","LoginService"]}(),function(){function CertBindController($state,CommonRequest,TipService,CONFIG,$ionicHistory,$rootScope,$log,VALIDATION,$filter,LoginService,$scope,COMMON,$ionicLoading,$ionicModal,$timeout){$scope.txCode="CCBSB109";var rootScope=$rootScope;$log.info(window.location.href,"window.href");var objYXJK={},fromYXJK=window.location.href;if(-1!=fromYXJK.indexOf("uriYXJK")&&-1!=fromYXJK.indexOf("appidYXJK")){var arrYXJK=window.location.href.split("?")[2].split("&");arrYXJK.forEach(function(val,i,arr){objYXJK[arrYXJK[i].split("=")[0]]=arrYXJK[i].split("=")[1]||""})}$log.info(objYXJK,"objYXJK"),$scope.cancel=function(){if($rootScope.ydbq){var url="";return url="http://www.yuqi56.cn/ng166"==CONFIG.DOMAIN?"http://www.yuqi56.cn/sit1/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&flag=007":CONFIG.DOMAIN+"/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&flag=007",console.info(url),$rootScope.ydbq=!1,void(window.location.href=url)}return-1!=fromYXJK.indexOf("uriYXJK")&&-1!=fromYXJK.indexOf("appidYXJK")?void(window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+objYXJK.appidYXJK+"&redirect_uri="+encodeURIComponent(decodeURIComponent(objYXJK.uriYXJK)+"?awaitBind=Y&channelCode="+objYXJK.channelCode)+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"):void COMMON.hideModal()},$rootScope.openid||(COMMON.hideModal(),$log.info("openid为空，不可进行绑定")),$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.nameAlert=function(val){1==val.invalid?($scope.nameErr=!0,$timeout(function(){$scope.nameErr=!1},1500)):1==val.length&&(nameLen=!0,$timeout(function(){nameLen=!1},1500))},$scope.cretNoAlert=function(val){$scope.cretNo1=!1,$scope.cretNo2=!1,$scope.cretNo3=!1,1==val.invalid2?($scope.cretNo1=!0,$scope.cretNoOdd=!0,$timeout(function(){$scope.cretNoOdd=!1},1500)):1==val.length?($scope.cretNo2=!0,$scope.tostCretShow=!0,$timeout(function(){$scope.tostCretShow=!1},1500)):1==val.invalid&&($scope.cretNo3=!0,$scope.tostCretErrShow=!0,$timeout(function(){$scope.tostCretErrShow=!1},1500))},$scope.phoneAlert=function(val){1==val&&($scope.phoneErr=!0,$timeout(function(){$scope.phoneErr=!1},1500))},$scope.hide=function(){$scope.nameErr=!1,$scope.nameLen=!1,$scope.cretNoOdd=!1,$scope.tostCretShow=!1,$scope.tostCretErrShow=!1,$scope.phoneErr=!1},$scope.idtype="A",$scope.gender="1",$scope.maxEndDate=new Date,$scope.birthdayCallback=function(val){val&&($scope.birthday=val)},$scope.bind=function(){if(!this.name)return void TipService.showMsg("姓名不能为空");if(!this.id)return void TipService.showMsg("证件号码不能为空");if($scope.cretNo1)return void TipService.showMsg("请输入正确的证件号！");if($scope.cretNo2)return void TipService.showMsg("您输入的证件号过长！");if($scope.cretNo3)return void TipService.showMsg("您输入的证件号格式不正确！");var cretType=this.idtype,birthday="",sex="";"A"==this.idtype?(birthday=VALIDATION.getBirthday(this.id),sex=VALIDATION.getSex(this.id)):(birthday=this.birthday,sex=this.gender),birthday=$filter("date")(birthday,"yyyy-MM-dd");var params={CusThirtyModel:{thirtyCode:$rootScope.openid},customerName:this.name,sex:sex,bronToString:birthday,cretNo:"A"==this.idtype?this.id.toUpperCase():this.id,cretType:this.idtype,CCBSBCODE:"CCBSB109",PhoneNo:this.phone,PhoneIdCode:this.phonecode},checkedbox=document.getElementById("checked").checked;if(!checkedbox)return void TipService.showMsg("请阅读相关条款并同意");var parmas1={custName:this.name,cretNo:this.id,phoneNo:this.phone,cretType:this.idtype};CommonRequest.request(parmas1,CONFIG.PHONE_REAL_AUTH,function(result){result&&1==result.status&&CommonRequest.request({prodId:""},CONFIG.IS_NEED_FACEDETECT,function(result){if(result&&1==result.status)if(1==result.data.status&&"A"==cretType){COMMON.hideModal(),$rootScope.isFromBind=!0,$rootScope.bindParams=params;var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/face-detect/face-detect.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show()})}else CommonRequest.request(params,CONFIG.WECHAT_BIND_SERVCIE,function(result){if(1==result.status){if($rootScope.isBinded=!0,$ionicLoading.show({template:$rootScope.TIPS.USER.BIND.BIND_SUCCESS,duration:2e3}),$rootScope.$broadcast("bind-result",{result:!0}),LoginService.loginByWechat($rootScope.openid),$rootScope.ydbq){var url="";return url="http://www.yuqi56.cn/ng166"==CONFIG.DOMAIN?"http://www.yuqi56.cn/sit1/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&openid="+$rootScope.openid:CONFIG.DOMAIN+"/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&openid="+$rootScope.openid,console.info(url),$rootScope.ydbq=!1,void(window.location.href=url)}if(-1!=fromYXJK.indexOf("uriYXJK")&&-1!=fromYXJK.indexOf("appidYXJK"))return void(window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+objYXJK.appidYXJK+"&redirect_uri="+encodeURIComponent(decodeURIComponent(objYXJK.uriYXJK)+"?channelCode="+objYXJK.channelCode)+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect")}})})})},$scope.showModal=function(url,animation){var self=$scope;$ionicModal.fromTemplateUrl(url,{scope:$scope,animation:animation||"slide-in-up",backdropClickToClose:!1}).then(function(modal){self.modal=modal,self.modal.show()})},$scope.showMsg=function(temp){"temp1"==temp?$scope.showModal("app/module/user/cert-bind/register-agreement/register-agreement.html"):$scope.showModal("app/module/user/cert-bind/register-privacyPolicy/register-privacyPolicy.html")},$scope.handSpan=function(){var checkedbox=document.getElementById("checked").checked;document.getElementById("checked").checked=!checkedbox},document.body.addEventListener("focusout",function(){-1!=navigator.userAgent.toLowerCase().indexOf("iphone")&&(window.scrollTo({top:0,behavior:"smooth"}),scrollTo(0,0))})}angular.module("app").controller("CertBindController",CertBindController),CertBindController.$inject=["$state","CommonRequest","TipService","CONFIG","$ionicHistory","$rootScope","$log","VALIDATION","$filter","LoginService","$scope","COMMON","$ionicLoading","$ionicModal","$timeout"]}(),function(){function ComplaintController($state,CommonRequest,CONFIG,$ionicPopup,LoginService){var vm=this;vm.goAreapro=function(){$state.go("complaint-area-pro")},vm.userCenter=function(){$state.go("tab.user")}}angular.module("app").controller("ComplaintController",ComplaintController),ComplaintController.$inject=["$state","CommonRequest","CONFIG","$ionicPopup","LoginService"]}(),function(){function ImgCodeCheckController($scope,$state,$rootScope,CommonRequest,CONFIG,COMMON,$document){$scope.cancel=function(){COMMON.hideModal()},$scope.submit=function(){var params={imageCode:this.code,random:this.random};CommonRequest.request(params,CONFIG.CUS_SPECIAL_SERVICE,function(result){if(1==result.status){var data=result.data;data?window.location.href=data:$state.go("special")}})},$scope.random=Date.parse(new Date)+Math.random(8),$scope.imgpath=CONFIG.SERVICE_ADDRESS+"new/ImgVerifyCode?random="+$scope.random,$scope.getimg=function(){$scope.random=Date.parse(new Date)+Math.random(8),$scope.imgpath=CONFIG.SERVICE_ADDRESS+"new/ImgVerifyCode?random="+$scope.random};var rootScope=$rootScope;rootScope.$on("send-result",function(erent,data){var flag=data.result;flag||$scope.getimg()})}angular.module("app").controller("ImgCodeCheckController",ImgCodeCheckController),ImgCodeCheckController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","COMMON","$document"]}(),function(){function LoginController($scope,$state,$rootScope,CommonRequest,CONFIG,LoginService,COMMON,$document,$timeout){$scope.txCode="CCBSB101",$scope.txCode="CCBSB101";var rootScope=$rootScope;$scope.cancel=function(){COMMON.hideModal()},$scope.phoneAlert=function(val){1==val.invalid&&($scope.phoneAlertshow=!0,$timeout(function(){$scope.phoneAlertshow=!1},1500))},$scope.hide=function(){$scope.phoneAlertshow=!1},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.submit=function(){var params={phone:this.phone,phoneCode:this.phoneCode,verToken:$scope.verToken};$scope.getVerToken(function(){LoginService.loginByPhone(params)})},$scope.getVerToken=function(callback){CommonRequest.request({},CONFIG.GET_VERTOKEN_SERVICE,function(result){"1"==result.status&&($scope.verToken=result.data.verToken,angular.isFunction(callback)&&callback())})},$scope.getVerToken()}angular.module("app").controller("LoginController",LoginController),LoginController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","LoginService","COMMON","$document","$timeout"]}(),function(){function LoginService($rootScope,$state,CONFIG,CommonRequest,COMMON,TipService,$location,$log,$ionicLoading,$timeout,$window,PolicyService,$ionicPopup){var vm=this,notShowModalList=["card-activation","activation-success"];vm.login=function(loginParams){if(loginParams){var password=CryptoJS.SHA1(loginParams.password).toString(),params={cretNo:loginParams.userName,password:password,imageCode:loginParams.code,random:loginParams.random};CommonRequest.request(params,CONFIG.LOGIN_SERVICE,function(result){1==result.status&&(vm.storeUserData(result),sessionStorage.setItem("elife-loginStatus",1))})}},vm.loginByPhone=function(loginParams){if(loginParams){var params={phoneNo:loginParams.phone,phoneIdCode:loginParams.phoneCode,CCBSBCODE:"CCBSB101",verToken:loginParams.verToken};CommonRequest.request(params,CONFIG.LOGIN_BYPHONE_SERVICE,function(result){1==result.status&&(vm.storeUserData(result),sessionStorage.setItem("elife-loginStatus",2))})}};var getOpenIDCount=0;vm.getOpenID=function(type,callback){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),getOpenIDCount>=3)return getOpenIDCount=0,$ionicLoading.hide(),TipService.showMsg("网络繁忙，请稍后再试"),$log.info("获取OPENID接口错误"),void($rootScope.wechatLoginProcess=!1);var token=localStorage.getItem("elife-userToken"),url=$location.absUrl(),param=url.split("?")[1]||"";if(-1!=param.indexOf("code")){var codeStr=param.split("&");codeStr[codeStr.length-1]=codeStr[codeStr.length-1].split("#")[0];var code=codeStr.find(function(item){return-1!=item.indexOf("code")});code=code?code.split("=")[1]:""}if(code||(code=$location.search().code),$log.info("微信code："+code),code){var params={code:code};token&&(params.token=token),CommonRequest.request(params,CONFIG.GET_OPENID_SERVICE,function(result){if(getOpenIDCount++,"1"==result.status)$rootScope.openid=result.data.openid,sessionStorage.setItem("elife-openid",$rootScope.openid),angular.isFunction(callback)&&callback($rootScope.openid);else if(result.error&&-1!=result.error.code.indexOf("80004"))$timeout(function(){vm.getOpenID(type,callback)},500);else{if(getOpenIDCount=0,$ionicLoading.hide(),"mall"==type)$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Ftab%2Fmall&response_type=code&scope=snsapi_base&state=test#wechat_redirect";else if("list"==type){var tag=$state.params.tag||"";$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Flist%2Ftag="+tag+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}else if("detail"==type||"count"==type)if("count"==type)$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct-share%2F"+$state.params.id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect";else if("product-kangLe"==$state.current.namee)$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct-kangLe%2F"+$state.params.id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect";else if("product-purchase-policy-activity"==$state.current.name)$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fpurchase%2Fpolicy%2Factivity%2F"+$state.params.id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect";else if("product-hmrc-calculate"==$state.current.name){var id=$state.params.id||"",prams=encodeURIComponent(CONFIG.DOMAIN+"/elife-wechat/#/product/hmrc/calculate/"+productData.prd_id);$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+prams+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}else if("product-optimze"==$state.current.name){var id=$state.params.id||"",prams=encodeURIComponent(CONFIG.DOMAIN+"/elife-wechat/#/product/product-optimze/"+productData.prd_id);$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+prams+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}else if("product-lays"==$state.current.name){var id=$state.params.id||"",prams=encodeURIComponent(CONFIG.DOMAIN+"/elife-wechat/#/product/detail/"+productData.prd_id+"////////");$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+prams+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}else if("product-ankang-info"==$state.current.name){var id=$state.params.id||"",prams=encodeURIComponent(CONFIG.DOMAIN+"/elife-wechat/#/product/product-ankang/"+productData.prd_id);$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+prams+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}else{var id=$state.params.id||"",buttonShow=$state.params.buttonShow||"",salesId=$state.params.salesId||"",parentSalesId=$state.params.parentSalesId||"",salesLevel=$state.params.salesLevel||"",saleChnl=$state.params.saleChnl||"",activityId=$state.params.activityId||"",salerId=$state.params.salerId||"";$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fdetail%2F"+id+"%2F"+buttonShow+"%2F"+salesId+"%2F"+parentSalesId+"%2F"+salesLevel+"%2F"+saleChnl+"%2F"+activityId+"%2F"+salerId+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}if(-1!=location.href.indexOf("star-product-detail")){var p_id=$state.params.id;$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fstar-product-detail%2F"+p_id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}if(-1!=location.href.indexOf("star-agent-detail")){var a_id=$state.params.id;$window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fstar-agent-detail%2F"+a_id+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"}}},!0)}else $ionicLoading.hide()},vm.loginByWechat=function(openid,callback){if(openid){$log.info("openid: "+openid+" 微信登录中...");var params={thirtyCode:openid};CommonRequest.request(params,CONFIG.WECHAT_LOGIN_SERVCIE,function(result){if(1==result.status&&result.data&&(vm.storeUserData(result),
sessionStorage.setItem("elife-loginStatus",3),localStorage.getItem("channelLogo")&&localStorage.removeItem("channelLogo"),$log.info("微信登录成功，result:"+result.toString())),0==result.status){if(-1!=notShowModalList.indexOf($state.current.name))return;localStorage.getItem("channelLogo")?localStorage.removeItem("channelLogo"):(TipService.showMsg($rootScope.TIPS.USER.BIND.NON_CERTIFICATE),COMMON.showModal("app/module/user/cert-bind/cert-bind.html")),$log.info("登录失败，result:"+result.toString())}$rootScope.wechatLoginProcess=!1,angular.isFunction(callback)&&callback(result)})}},vm.logout=function(){$rootScope.isLogin=!1,sessionStorage&&(sessionStorage.removeItem("elife-login"),sessionStorage.removeItem("elife-loginStatus"),sessionStorage.removeItem("elife-userData"),sessionStorage.removeItem("elife-policyInvoice"),sessionStorage.removeItem("elife-medical"));var params={};CommonRequest.request(params,CONFIG.LOGINOUT_SERVICE,function(result){1==result.status&&($rootScope.userData=null,$rootScope.isLogin=!1,$rootScope.isBinded=!1)})},vm.storeUserData=function(result){$rootScope.isLogin=!0,$rootScope.WECHAT&&($rootScope.isBinded=!0),$rootScope.userData=result.data,sessionStorage&&(sessionStorage.setItem("elife-login",1),sessionStorage.setItem("elife-userData",angular.toJson(result.data)),localStorage.setItem("elife-userToken",result.data.token)),$rootScope.loginGo?$state.go($rootScope.loginGo):$rootScope.loginGo=null,vm.getLocalData(),COMMON.hideModal()},vm.getLocalData=function(){var localData=PolicyService.getLocalData(),localProductData=localData.productData,localPolicyData=(localData.userData,localData.insureData,localData.policyData);if(localProductData&&localProductData.basicProfile&&"Y"==localProductData.basicProfile.P023){var alertContinue=$ionicPopup.confirm({template:localProductData.prd_title+"产品有未完成的投保，是否继续投保？",okText:"是",cancelText:"否"});alertContinue.then(function(res){if(res){if(localPolicyData&&PolicyService.setSessionData({policyData:localPolicyData}),PolicyService.removeLocalData(["productData","userData","insureData","policyData"]),"ENQL"==localProductData.prd_code)return void $state.go("product-kangLe",{id:localProductData.prd_id});if("BEDH"==localProductData.prd_code)return void $state.go("product-bedh",{id:localProductData.prd_id});if("Y"==localProductData.basicProfile.PA001)return void $state.go("product-purchase-policy-activity",{id:localProductData.prd_id});if("Y"==localProductData.basicProfile.PA003)return void $state.go("product-share",{id:localProductData.prd_id});if("Y"==localProductData.basicProfile.PA004)return void $state.go("product-purchase-calculate-jipaa",{id:localProductData.prd_id});if("HMRA"==localProductData.prd_code)return void $state.go("product-lays",{id:localProductData.prd_id});if("GHMB"==localProductData.prd_code&&"Y"==localProductData.basicProfile.P021)return void $state.go("product-optimze",{id:localProductData.prd_id});if("HMRCa"==localProductData.prd_code)return void $state.go("product-hmrc-calculate",{id:localProductData.prd_id});if("GDDC"==localProductData.prd_code)return void $state.go("product-ankang-info",{id:localProductData.prd_id});$state.go("product-detail",{id:localProductData.prd_id})}else PolicyService.removeLocalData(["productData","userData","insureData","policyData"])})}}}angular.module("app").service("LoginService",LoginService),LoginService.$inject=["$rootScope","$state","CONFIG","CommonRequest","COMMON","TipService","$location","$log","$ionicLoading","$timeout","$window","PolicyService","$ionicPopup"]}(),function(){function JianbaolifeController($scope,$state,CommonRequest,CONFIG,$rootScope,TipService,$ionicPopup,$timeout,$ionicLoading,COMMON,$location){var vm=this;vm.url="javascript:;",$scope.height1=document.body.offsetWidth/3,$scope.height2=$scope.height1-30,vm.CCBapp=!1;var fromapp=sessionStorage.getItem("fromapp")?sessionStorage.getItem("fromapp"):"";vm.AppLogin=function(){var param={login_parmas:vm.userinfo};CommonRequest.request(param,CONFIG.UNIFIED_LOGIN,function(result){if(1==result.status){sessionStorage.setItem("elife-login",1),sessionStorage.setItem("elife-loginStatus",2);var info=result.data;info.plchdAppFlag="Y",sessionStorage.setItem("elife-userData",JSON.stringify(info)),localStorage.setItem("elife-userToken",result.data.token),sessionStorage.setItem("Token",result.data.token),$rootScope.userData=info,sessionStorage.setItem("fromapp","Y"),vm.CCBapp=!0}})},$location.search().login_params&&(vm.userinfo=decodeURIComponent($location.search().login_params),vm.AppLogin()),CONFIG.WECHAT||"Y"==fromapp||$location.search().login_params||$state.go("tab.mall"),vm.disabled=!0,$timeout(function(){vm.disabled=!1},2500),vm.loading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),$timeout(function(){vm.disabled?vm.loading():$ionicLoading.hide()},500)},vm.loading(),vm.getVIPInfo=function(params,callback){fromapp||$location.search().login_params?CommonRequest.request(params,CONFIG.VIP_GET_CUSTOMERID,function(result){1==result.status&&(vm.vipInfo=result.data,vm.viptoken=result.data.token,vm.viptokens=result.data.token1,vm.skipUrl=result.data.url,vm.diagnosesUrl=result.data.token2,vm.thirdUrl=result.data.thirdUrl,vm.consultUrl=result.data.token3,angular.isFunction(callback)&&callback(vm.vipInfo))}):CommonRequest.request(params,CONFIG.VIP_GET_WECHAT_CUSTOMERID,function(result){1==result.status&&(vm.vipInfo=result.data,vm.viptoken=result.data.token,vm.viptokens=result.data.token1,vm.skipUrl=result.data.url,vm.diagnosesUrl=result.data.token2,vm.thirdUrl=result.data.thirdUrl,vm.consultUrl=result.data.token3,angular.isFunction(callback)&&callback(vm.vipInfo))})},vm.getAccredit=function(){var params={customerId:$rootScope.userData.cusId};CommonRequest.request(params,CONFIG.VIP_WECHAT_ACCREDIT,function(result){if(1==result.status)vm.vipInfo&&(vm.vipInfo.VipA&&(vm.vipInfo.VipA="2"),vm.vipInfo.VipB&&(vm.vipInfo.VipB="2"));else if(result.error.message){$ionicPopup.confirm({title:"温馨提示",template:result.error.message,buttons:[{text:"我知道了",type:"button-positive"}]})}})},vm.getCusId=function(){$timeout(function(){$rootScope.userData?(vm.params={customerId:$rootScope.userData.cusId},vm.getVIPInfo(vm.params,function(data){var accreditFlag=!0;if("1"==data.VipA&&"1"==data.VipB?accreditFlag=!1:"1"!=data.VipA||data.VipB?data.VipA||"1"!=data.VipB||(accreditFlag=!1):accreditFlag=!1,0==accreditFlag){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"您是否授权悦享健康读取您的信息？",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.getAccredit():$state.go("tab.mall")})}})):vm.getCusId()},500)},$timeout(function(){vm.getCusId()},500),vm.vipView=function(skipTo){if(!vm.disabled)if($rootScope.userData||vm.CCBapp){if(vm.vipInfo){var data=vm.vipInfo,accreditFlag=!0;if("1"==data.VipA&&"1"==data.VipB?accreditFlag=!1:"1"!=data.VipA||data.VipB?data.VipA||"1"!=data.VipB||(accreditFlag=!1):accreditFlag=!1,0==accreditFlag){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"您是否授权悦享健康读取您的信息？",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.getAccredit():$state.go("tab.mall")})}else{if("healthInfo"==skipTo)return void(vm.url=vm.consultUrl);if("green-channel"==skipTo)return void $state.go("green-channel");if("overseas"==skipTo)return void $state.go("overseas");if("mores"==skipTo)return void $state.go("comming-soon");if("others"==skipTo)return void(vm.url=vm.skipUrl+vm.viptokens);if("diagnoses"==skipTo)return void(vm.url=vm.diagnosesUrl+$rootScope.userData.cusId);if(1==vm.vipInfo.VipASxEndTime||1==vm.vipInfo.VipBSxEndTime)return"register"==skipTo?void(vm.url=vm.skipUrl+vm.viptoken):(vm.encrypt=encodeURIComponent(vm.vipInfo.encrypt),void(vm.url=vm.thirdUrl+vm.encrypt+"&skipTo="+skipTo+"&from=jianxin"));vm.url="javascript:;",TipService.showMsg("尊敬的客户，由于部分服务仅限于建信人寿受邀客户，具体详情请咨询您的销售顾问。")}}}else COMMON.showModal("app/module/user/cert-bind/cert-bind.html")}}angular.module("app").controller("JianbaolifeController",JianbaolifeController),JianbaolifeController.$inject=["$scope","$state","CommonRequest","CONFIG","$rootScope","TipService","$ionicPopup","$timeout","$ionicLoading","COMMON","$location"]}(),function(){function UserController($scope,$location,$state,$interval,$rootScope,CommonRequest,CONFIG,COMMON,LoginService,TipService,$ionicPopup,$timeout){var vm=this;if($scope.photoUrl="",$rootScope.ydbq=!1,vm.ydbqshortLink=$location.search().shortLink||"",vm.flag=$location.search().flag||"","ydbq"==vm.flag&&vm.ydbqshortLink&&($rootScope.ydbq=!0,$rootScope.ydbqshortLink=vm.ydbqshortLink),vm.point=0,vm.getPoint=function(){var params={};CommonRequest.request(params,CONFIG.CUS_POINT_SERVICE,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)&&data.length>0&&(vm.point=data[0].point)}})},CONFIG.WECHAT){vm.num=0,vm.getBasicInfo=function(){vm.num++,vm.num>=6&&$interval.cancel(interval),console.info(vm.num++);var openid=sessionStorage.getItem("elife-openid");null==openid&&(openid="12233211265151212");var params={openId:openid};CommonRequest.request(params,CONFIG.GET_BASIC_INFO,function(result){"1"===result.status&&result.data.headImgUrl&&($scope.photoUrl=result.data.headImgUrl,$interval.cancel(interval))})};var interval=$interval(function(){vm.getBasicInfo()},1e3)}""==$scope.photoUrl&&($scope.photoUrl="img/user/user-top-avatar.png"),vm.specialServiceURL="",vm.hasGetSpecial=!1,vm.getSpecialService=function(){var params={};CommonRequest.request(params,CONFIG.CUS_SPECIAL_SERVICE,function(result){if(1==result.status){var data=result.data;vm.hasGetSpecial=!0,data&&(vm.specialServiceURL=data)}})},vm.goSpecial=function(){if($rootScope.isLogin){var flag=!!vm.specialServiceURL;flag?window.location.href=vm.specialServiceURL:$state.go("special")}else vm.showLogin()},$scope.$watch("isLogin",function(newValue){newValue&&(vm.getPoint(),vm.getSpecialService())},!0),vm.showLogin=function(){COMMON.showModal("app/module/user/login/login.html")},vm.showCertBind=function(){COMMON.showModal("app/module/user/cert-bind/cert-bind.html")},vm.logout=function(){var popup=$ionicPopup.confirm({cssClass:"popup-icon",template:$rootScope.TIPS.USER.LOGOUT.USER_LOGOUT_CONFIRM,okText:"确认",cancelText:"取消"});popup.then(function(result){result&&LoginService.logout()})}}angular.module("app").controller("UserController",UserController),UserController.$inject=["$scope","$location","$state","$interval","$rootScope","CommonRequest","CONFIG","COMMON","LoginService","TipService","$ionicPopup","$timeout"]}(),function(){function ReportController($rootScope,$location,Upload,CONFIG,$scope,TipService,PolicyService,COMMON,$ionicLoading,$timeout,$ionicPopup,$state,CommonRequest,VALIDATION,$filter,$document){var vm=this,sessionData=PolicyService.getSessionData();vm.picUrl=[],vm.picState="1",vm.description="",vm.material="",vm.idMask2=!0;var MaskSession=sessionStorage.getItem("elife-MaskSession");vm.overError="",vm.titleStatus=!1,vm.reportCeridChanner=!1,vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){result&&1==result.status&&("Y"==result.data?vm.ocrOpenState=!0:"N"==result.data&&(vm.ocrOpenState=!1))})},vm.ocrSwitch(),vm.getCompany=function(params,callback){var config={url:"../statics/json/sysOrgList.json",method:"GET"};CommonRequest.request({},config,function(result){if(result&&result.status&&1==result.status){var materials=result.data;materials&&materials.length>0&&(vm.materials=materials,vm.material="-1")}})},vm.getCompany(),$scope.files={},$scope.files.file1="",$scope.files.file2="",$scope.imageList=[],$scope.uploaded=0,vm.submit=function(){if(2!=$scope.uploaded){var file1=$scope.files.file1,file2=$scope.files.file2;return $scope.imageList=[],file1&&file2&&$scope.imageList.push({F001:file1,uploadType:"1000"},{F002:file2,uploadType:"0100"}),2!=$scope.imageList.length?void TipService.showMsg("请上传身份证正面和反面"):void PolicyService.isAllowUpload($scope.imageList.length,function(){vm.checkUpload($scope.uploaded)})}},vm.checkUpload=function(uploaded){var data={custId:sessionData.userData?sessionData.userData.cusId:"",token:sessionData.userData?sessionData.userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB111"};vm.upload(angular.extend($scope.imageList[uploaded],data),function(){$scope.uploaded++})},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(result){$ionicLoading.hide(),"1"==result.data.status?(vm.uploadMsg="上传成功！","F001"==result.data.data[0].imageFlag?vm.picUrl.push({F:result.data.data[0].imageFlag,value:result.data.data[0].imageName}):"F002"==result.data.data[0].imageFlag&&vm.picUrl.push({F:result.data.data[0].imageFlag,value:result.data.data[0].imageName}),angular.isFunction(callback)&&callback()):(vm.picState="0",TipService.showMsg(result.data.error.message+result.data.error.code),$scope.uploadMsg="上传失败")},function(resp){vm.picState="0",$ionicLoading.hide(),$scope.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$scope.uploadMsg="上传进度: "+progressPercentage+"%"})},$scope.$watch("uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&2>newValue?vm.checkUpload(newValue):2==newValue&&vm.backUp())}),vm.submit_form=function(){vm.submit()},vm.backUp=function(){if("1"!=vm.picState)return $scope.uploaded=0,void TipService.showMsg("图片上传操作失败");for(var i=0;i<vm.picUrl.length;i++)"F001"==vm.picUrl[i].F?vm.idFront=vm.picUrl[i].value:"F002"==vm.picUrl[i].F&&(vm.idBehind=vm.picUrl[i].value);if(vm.ocrOpenState){var params={picUrl:vm.getTime()+vm.idFront+"#"+vm.getTime()+vm.idBehind};CommonRequest.request(params,CONFIG.OCR_QUERY_A_MESSAGE,function(result){result&&1==result.status&&(1==result.data.flag?(vm.reportName=result.data.name,vm.reportCerid=result.data.cardNum,vm.material="",vm.certPeriod=vm.reportDataTime(result.data.period),vm.reportCeridChanner=!0,vm.reportCheckMessage()):(vm.reportName="识别失败",vm.reportCerid="000000000000000000",vm.material="",vm.certPeriod="2099-01-01",vm.type="1",vm.reportStatus="2",vm.description="识别失败！",vm.overError="识别失败！",vm.submitReport()))})}else vm.ocrOpenState||("长期"!=vm.birthday?vm.certPeriod=$filter("date")(vm.birthday,"yyyy-MM-dd"):vm.certPeriod="2099-12-31",vm.reportCheckMessage())},vm.reportCheckMessage=function(){vm.ocrOpenState?vm.type="1":vm.type="2","长期"==vm.certPeriod||vm.compareDate(vm.certPeriod)?VALIDATION.idCheck(vm.reportCerid)?vm.reportCheck():($scope.uploaded=0,vm.reportStatus="2",vm.reportCeridChanner?(vm.description="识别失败",vm.overError="识别失败"):(vm.description="证件号不合法！",vm.overError="证件号不合法！"),vm.submitReport()):($scope.uploaded=0,vm.reportStatus="2",vm.description="证件有效期已过期！",vm.overError="证件有效期已过期！",vm.submitReport())},vm.reportCheck=function(){var checkParams={cusInfoList:[{insureType:"A",cretNo:vm.reportCerid,name:vm.reportName}]};CommonRequest.request(checkParams,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.ocrOpenState?vm.reportStatus="1":vm.ocrOpenState||(vm.reportStatus="0"),vm.submitReport()):(vm.reportStatus="2",vm.description="身份信息不一致！",vm.overError="身份信息不一致！",vm.submitReport()))})},vm.submitReport=function(){if(VALIDATION.idCheck(vm.reportCerid))var reportBirthday=VALIDATION.getBirthday(vm.reportCerid),reportSex=VALIDATION.getSex(vm.reportCerid);else var reportBirthday="2099-01-01",reportSex="0";"长期"==vm.certPeriod&&(vm.certPeriod="2099-12-31");var params2={referenName:sessionData.userData.customerName,referenSex:sessionData.userData.sex,referenBirthday:sessionData.userData.birthday,referenCertype:sessionData.userData.cretType,referenCerid:sessionData.userData.cretNo,reportName:vm.reportName,reportSex:reportSex,reportBirthday:reportBirthday,reportCertype:"A",reportCerid:vm.reportCerid,certPeriod:vm.certPeriod,idFront:vm.getTime()+vm.idFront,idBehind:vm.getTime()+vm.idBehind,reportOrgcode:vm.material,type:vm.type,reportStatus:vm.reportStatus,description:vm.description,channelCode:"811"};CommonRequest.request(params2,CONFIG.BACKUP_AUTHENTICATION_RESULET,function(result){result&&1==result.status&&(vm.reddotStatus(),"2"==vm.reportStatus?vm.ocrOpenState?vm.showResultModal():vm.showResultModal2():(vm.removeMessage(),vm.ocrOpenState?TipService.showMsg("信息采集成功！"):TipService.showMsg("提交成功！")))})},$scope.changePic=function($event){var img=$event.srcElement||$event.target;$scope.bigimage=img.src,$("#js-imgview")[0].style.display="block",$("#js-imgview-mask")[0].style.display="block",vm.delUpload=function(){$scope.bigimage=img.src="",$scope.files.file1=!1}},$scope.closePic=function(){$("#js-imgview")[0].style.display="none",$("#js-imgview-mask")[0].style.display="none"},$scope.changePic2=function($event){var img2=$event.srcElement||$event.target;$scope.bigimage2=img2.src,$("#js-imgview2")[0].style.display="block",$("#js-imgview-mask2")[0].style.display="block",vm.delUpload2=function(){$scope.bigimage2=img2.src="",$scope.files.file2=!1}},$scope.closePic2=function(){$("#js-imgview2")[0].style.display="none",$("#js-imgview-mask2")[0].style.display="none"},vm.showResultModal=function(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:vm.overError,okText:"重新采集",cancelText:"去人工核查"});alertPopup.then(function(res){res?vm.removeMessage():($scope.uploaded=0,vm.reportName="",vm.reportCerid="",vm.birthday="",vm.material="-1",vm.ocrOpenState=!1,vm.titleStatus=!0)})},vm.showResultModal2=function(){var alertPopup=$ionicPopup.alert({title:"温馨提示",template:vm.overError,okText:"重新采集"});alertPopup.then(function(res){res&&($scope.uploaded=0)})},vm.getTime=function(){var nowTime=new Date,nowYear=nowTime.getFullYear(),nowMonth=nowTime.getMonth()+1,nowData=nowTime.getDate();10>nowMonth&&(nowMonth="0"+nowMonth),10>nowData&&(nowData="0"+nowData);var dataValue="/"+nowYear+"/"+nowMonth+"/"+nowData+"/";return dataValue},vm.errorAlert=function(key,val){"reportName"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"reportCerid"==key&&(1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)))},vm.reportDataTime=function(str){var splitDate=str.split("-")[1];return splitDate},vm.compareDate=function(str){var nowData=(new Date).getTime(),compareDate=new Date(str).getTime();return compareDate>=nowData},vm.removeMessage=function(){$scope.uploaded=0,$scope.files.file1=!1,$scope.files.file2=!1,vm.reportName="",vm.reportCerid="",vm.birthday="",vm.material="-1",vm.longData=!1},vm.reddotStatus=function(){PolicyService.setSessionData({reddot:"1"}),$rootScope.checkResultStatus=!0},vm.fisstReddotStatus=function(){var reddot=sessionStorage.getItem("elife-reddot");void 0!=reddot&&""!=reddot||(PolicyService.setSessionData({reddot:"2"}),$rootScope.checkResultStatus=!1)},vm.fisstReddotStatus(),vm.idMask=function(){vm.idMask2=!1,PolicyService.setSessionData({MaskSession:"1"})},1==MaskSession&&(vm.idMask2=!1),vm.reportIdImgQues=function(){vm.idMask2=!0},vm.longDataFun=function(){vm.longData?(vm.longData=!1,vm.birthday=""):(vm.longData=!0,vm.birthday="长期")},vm.longDataInput=function(){"长期"==vm.birthday&&(vm.longData=!1)}}angular.module("app").controller("ReportController",ReportController),ReportController.$inject=["$rootScope","$location","Upload","CONFIG","$scope","TipService","PolicyService","COMMON","$ionicLoading","$timeout","$ionicPopup","$state","CommonRequest","VALIDATION","$filter","$document"]}(),function(){function MyContactsController($state,$rootScope,CommonRequest,CONFIG,$scope){var vm=this,userid="";vm.selectContacts=function(){$rootScope.userData&&(userid=$rootScope.userData.cusId);var params={Id:userid};CommonRequest.request(params,CONFIG.GET_CONTACTS_SERVICE,function(result){1==result.status&&(vm.mycontacts=result.data),$rootScope.$broadcast("scroll.refreshComplete")})},$scope.$watch("myContacts.mycontacts",function(n){console.info(n)}),vm.selectContacts(),vm.getContactDetail=function(ls){$state.go("my-contact-edit",{bronTo:ls.bronTo,contactId:ls.contactId,contactName:ls.contactName,cretNo:ls.cretNo,cretPeriodString:ls.cretPeriodString,cretType:ls.cretType,nationality:ls.nationality,relation:ls.relation,sex:ls.sex})}}angular.module("app").controller("MyContactsController",MyContactsController),MyContactsController.$inject=["$state","$rootScope","CommonRequest","CONFIG","$scope"]}(),function(){function MyInfoController($state,CommonRequest,CONFIG,PolicyService,$rootScope,$ionicHistory,VALIDATION){var vm=this;vm.back=function(){$ionicHistory.goBack()};var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&$rootScope.isLogin&&(vm.name=vm.userData.customerName,vm.certType=vm.userData.cretType,vm.certNo=vm.userData.cretNo,vm.gender=vm.userData.sex,vm.birthday=VALIDATION.dateFormat(vm.userData.birthday),vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.save=function(){var params={id:vm.id,relation:vm.relation,name:vm.name,nationality:vm.nationality,idtype:vm.idtype,idno:vm.idno,certExpireDate:vm.certExpireDate,gender:vm.gender,birthday:vm.birthday};CommonRequest.request(params,CONFIG.MY_INFO_EDIT_SERVICE,function(result){1==result.status&&$ionicHistory.goBack()})})}angular.module("app").controller("MyInfoController",MyInfoController),MyInfoController.$inject=["$state","CommonRequest","CONFIG","PolicyService","$rootScope","$ionicHistory","VALIDATION"]}(),function(){function MyOrderController(CommonRequest,CONFIG,$rootScope,TipService,$timeout,PolicyService,$state,COMMON,$scope,$ionicPopup,$ionicModal){var vm=this;vm.checkDay="7",vm.checkDayVal="一周内";var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.channel=$state.params.channel,vm.orderList=[],vm.changeState="0",vm.orderCodes=[],vm.payMent=[],vm.renewal=[],vm.signStatu=[],vm.signOrder=[],$scope.initAgePicker=function(){vm.ageRangeList=COMMON.getCommonData().CHECK_ORDER_BY_DAY},$scope.initAgePicker(),$scope.$on("agePickerCallback",function(event,data){vm.checkDayVal=data[0].label,vm.checkDay=data[0].id,vm.getOrderlist(vm.checkDay)}),vm.getOrderlist=function(day){if($rootScope.isLogin){var params={queryTimeArea:day,channelCode:CONFIG.SALE_CHANNEL};CommonRequest.request(params,CONFIG.ORDER_LIST_SERVCIE,function(result){if(1==result.status){if(vm.orderList=[],vm.channel&&"811"==vm.channel)for(var i=0;i<result.data.length;i++)"820"==result.data[i].saleChannel,vm.orderList.push(result.data[i]);else vm.orderList=result.data;vm.changeStatus(vm.changeState)}$rootScope.$broadcast("scroll.refreshComplete")})}else $timeout(function(){vm.getOrderlist(vm.checkDay)},1e3)},vm.getOrderlist(vm.checkDay),vm.backNO=function(orderCode){var params={orderCodes:orderCode};CommonRequest.request(params,CONFIG.GYL_CONTRACT_BANK,function(result){if(1==result.status){for(var i=0;i<result.data.length;i++)vm.signOrder.push(result.data[i]);for(var i=0;i<vm.signOrder.length;i++)for(var j=0;j<vm.showList.length;j++)if(vm.signOrder[i].orderCode==vm.showList[j].orderCode){var accStatu=vm.signOrder[i].accBankContractStatus,payStatu=vm.signOrder[i].payBankContractStatus,payBankNo=vm.signOrder[i].payBankNo,accBankNo=vm.signOrder[i].accBankNo;vm.signOrder[i].payBank,vm.signOrder[i].accBank;payBankNo&&accBankNo&&("1"==payStatu&&"1"==accStatu||"1"==payStatu&&"2"==accStatu||"1"==payStatu&&"3"==accStatu||"1"==payStatu&&"4"==accStatu||"2"==payStatu&&"1"==accStatu||"3"==payStatu&&"1"==accStatu||"4"==payStatu&&"1"==accStatu?vm.showList[j].signstatu="1":"4"==payStatu&&"4"==accStatu||"2"==payStatu&&"4"==accStatu||"4"==payStatu&&"2"==accStatu?vm.showList[j].signstatu="4":"3"==payStatu&&"3"==accStatu||"2"==payStatu&&"3"==accStatu||"3"==payStatu&&"2"==accStatu||"3"==payStatu&&"4"==accStatu||"4"==payStatu&&"3"==accStatu?vm.showList[j].signstatu="3":vm.showList[j].signstatu=""),payBankNo&&!accBankNo&&("1"==payStatu?vm.showList[j].signstatu="1":"4"==payStatu?vm.showList[j].signstatu="4":"3"==payStatu?vm.showList[j].signstatu="3":vm.showList[j].signstatu=""),!payBankNo&&accBankNo&&("1"==accStatu?vm.showList[j].signstatu="1":"4"==accStatu?vm.showList[j].signstatu="4":"3"==accStatu?vm.showList[j].signstatu="3":vm.showList[j].signstatu="")}}})},vm.bankSign=function(orderCode){vm.bankNoSingle(orderCode,function(objBankcount){objBankcount&&(console.info("立即签约000000000"),BankContractService.pushContract([objBankcount],"chance"))})},vm.bankNoSingle=function(orderCode,callback){var params={orderCodes:[orderCode]};CommonRequest.request(params,CONFIG.GYL_CONTRACT_BANK,function(result){if(1==result.status){if(("1"==result.data[0].payBankContractStatus||"3"==result.data[0].payBankContractStatus)&&result.data[0].payBankNo)return vm.bankAccount=result.data[0].payBankNo,void(angular.isFunction(callback)&&callback(vm.bankAccount));"1"!=result.data[0].accBankContractStatus&&"3"!=result.data[0].accBankContractStatus||!result.data[0].accBankNo||(vm.bankAccount=result.data[0].accBankNo,angular.isFunction(callback)&&callback(vm.bankAccount))}})},vm.deleteOrder=function(orderCode){if(orderCode){var params={orderCode:orderCode};CommonRequest.request(params,CONFIG.DELETE_ORDER_SERVICE,function(result){1==result.status&&(TipService.showMsg("删除订单成功！"),vm.getOrderlist())})}},vm.cancelOrder=function(orderCode){if(orderCode){var params={orderCode:orderCode};CommonRequest.request(params,CONFIG.CANCEL_ORDER_SERVICE,function(result){1==result.status&&(TipService.showMsg("取消订单成功！"),vm.getOrderlist())})}},vm.continuePay=function(order){var params={prdId:order.prdId},sessionData=PolicyService.getSessionData();CommonRequest.request(params,CONFIG.PRODUCT_INFO_SERVICE,function(result){if("1"==result.status){var productData=result.data;"1"==order.orderDiscount?productData.hasDiscount="0":productData.hasDiscount="1";var policyData;policyData="GHMB"==order.prdCode?{LiRcgnName:sessionData.userData.customerName,LiRcgnSex:sessionData.userData.sex,itemOrderRealPayAmt:order.orderRealAmnt,payType:productData.payType,orderCode:order.orderCode,BkBrchNo:order.branchCode,allInsuExp:order.orderOriAmnt,discount:order.orderDiscount,groupProName:order.prdName,PbHoldEmail:order.email}:{LiRcgnName:sessionData.userData.customerName,LiRcgnSex:sessionData.userData.sex,itemOrderRealPayAmt:order.orderRealAmnt,payType:productData.payType,orderCode:order.orderCode,BkBrchNo:order.branchCode,allInsuExp:order.orderOriAmnt,discount:order.orderDiscount},order.effectiveTime&&(order.effectiveTimeY=new Date(order.effectiveTime).getFullYear(),order.effectiveTimeM=new Date(order.effectiveTime).getMonth()+1,order.effectiveTimeD=new Date(order.effectiveTime).getDate(),order.effectiveTimeH=new Date(order.effectiveTime),order.effectiveTimeM<10&&(order.effectiveTimeM="0"+order.effectiveTimeM),order.effectiveTimeD<10&&(order.effectiveTimeD="0"+order.effectiveTimeD),order.effectiveDate=order.effectiveTimeY+"-"+order.effectiveTimeM+"-"+order.effectiveTimeD,order.effectiveTime=new Date(order.effectiveTime).getHours()+":"+new Date(order.effectiveTime).getMinutes()+":"+new Date(order.effectiveTime).getSeconds()),PolicyService.setSessionData({productData:productData,policyData:policyData}),PolicyService.setSessionData({productData:{cityCode:order.cityCode,insureName:order.rcgnName,prelnsureFlag:order.preInsureFlag,PbBeginDate:order.effectiveDate,effectiveTime:order.effectiveTime}});var payReqData={orderCode:order.orderCode,pbCertNo:sessionData.userData.cretNo,branchCode:policyData.BkBrchNo,payAmount:policyData.itemOrderRealPayAmt};CommonRequest.request(payReqData,CONFIG.CHECK_PAY_CHANNEL,function(result){if("1"==result.status)if("01"==result.data.prdPayPlatFormCode){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var payData={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:policyData.BkBrchNo,orderCode:policyData.orderCode,payAmount:policyData.itemOrderRealPayAmt,platForm:platForm,browserType:CONFIG.WECHAT?"01":"02",opendId:$rootScope.openid||"blank",channelCode:order.saleChannel?order.saleChannel:CONFIG.SALE_CHANNEL,paySign:result.data.paySign};CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE,function(result){if("1"==result.status){var data=result.data;"000000"==data.payStatus&&(window.location.href=data.payRedirectUrl)}})}else"00"==result.data.prdPayPlatFormCode&&$state.go("product-pay");else if(result.error&&"X1590200061"==result.error.code){var self=$rootScope,url="app/module/mall/product/product-purchase/product-purchase-sign/product-purchase-sign.html";$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.fromMyorder=!0,self.close=function(){self.modal.remove()},self.payAgain=function(){self.modal.remove(),vm.continuePay(order)}})}})}})},vm.changeStatus=function(n){if(vm.changeState=n,vm.showList=[],"0"==vm.changeState){for(var i=0;i<vm.orderList.length;i++)32==vm.orderList[i].orderStatus&&vm.showList.push(vm.orderList[i]);if(vm.showList.length>0){for(var i=0;i<vm.showList.length;i++)vm.orderCodes.push(vm.showList[i].orderCode);vm.backNO(vm.orderCodes)}}else if("1"==vm.changeState){for(var j=0;j<vm.orderList.length;j++)32!=vm.orderList[j].orderStatus&&vm.showList.push(vm.orderList[j]);if(vm.showList.length>0){for(var i=0;i<vm.showList.length;i++)vm.orderCodes.push(vm.showList[i].orderCode);vm.backNO(vm.orderCodes)}}},vm.getOrderInfo=function(order,errormsg){console.log(order);var params={orderCode:order.orderCode};CommonRequest.request(params,CONFIG.ORDER_DETAIL_SERVCIE,function(result){if(1==result.status){var orderInfo=result.data;if(errormsg){order.errormsg=orderInfo.errorMsg;$ionicPopup.alert({template:order.errormsg,okText:"我知道了",cssClass:"order-pup"})}else vm.againBuy(orderInfo)}})},vm.againBuy=function(orderInfo){var config={url:"../statics/product/"+CONFIG.SALE_CHANNEL+"/"+orderInfo.prdId+"/"+orderInfo.prdId+".json",method:"GET"},params={prdId:orderInfo.prdId,prdName:orderInfo.prdName};CommonRequest.request({},config,function(data){if(data&&data.status){if("HMRA"==orderInfo.prdCode)return void $state.go("product-lays",{id:orderInfo.prdId});if("ENQL"==orderInfo.prdCode)return void $state.go("product-kangLe",{id:orderInfo.prdId});if("GHMB"==orderInfo.prdCode&&"Y"==data.data.basicProfile.P021)return void $state.go("product-optimze",{id:orderInfo.prdId});if("HMRCa"==orderInfo.prdCode)return void $state.go("product-hmrc-calculate",{id:orderInfo.prdId});if("GDDC"==orderInfo.prdCode)return void $state.go("product-ankang-info",{id:orderInfo.prdId});$state.go("product-detail",{id:orderInfo.prdId})}else CommonRequest.request(params,CONFIG.CHECK_PRODUCT_SALE,function(result){if(1==result.status){var saleTip=result.data;TipService.showMsg(saleTip)}})})},vm.upload=function(order){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{pbApplNoNum:1}});var params={orderCode:order.orderCode,BkBrchNo:order.branchCode,PbHoldName:vm.userData.customerName};PolicyService.control({state:"upload-img",control:"data",data:params}),PolicyService.getPolicyResult(CONFIG.GET_POLICY_RESULT_SERVICE,function(result){console.log("跳回登陆页！")})};var rootScope=$rootScope;rootScope.$on("img-uploadsuccess",function(erent,data){var flag=data.result;flag&&vm.getOrderlist(vm.checkDay)})}angular.module("app").controller("MyOrderController",MyOrderController),MyOrderController.$inject=["CommonRequest","CONFIG","$rootScope","TipService","$timeout","PolicyService","$state","COMMON","$scope","$ionicPopup","$ionicModal"]}(),function(){function MyPolicyControllerNew($state,$location,$log,$interval,$rootScope,CONFIG,CommonRequest,TipService,$window,$timeout,PolicyService){function arrayFindMin(num,obj){var flag=0,item=0;for(var i in obj)item++,num-0<=obj[i]-0&&flag++;return flag==item}function hasVal(obj){
var flag=0;for(var i in obj)obj[i]-0&&flag++;return flag}function isArray(o){return"Array"===Object.prototype.toString.call(o).slice(8,-1)}function prodListInit(current,total){if(!isArray(total))return!1;if(total.length<vm.initPages){current.length=0;for(var k=0;k<total.length;k++)current.push(total[k])}else{current.length=0;for(var j=0;j<vm.initPages;j++)current.push(total[j])}}var vm=this;vm.cusId="",vm.see=!1,vm.broadcast=!1,vm.channel=$state.params.channel;var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,vm.policyData=JSON.parse(sessionStorage.getItem("policyData")),vm.AppLogin=function(){var param={login_parmas:vm.userinfo};CommonRequest.request(param,CONFIG.UNIFIED_LOGIN,function(result){if(1==result.status){sessionStorage.setItem("elife-login",1),sessionStorage.setItem("elife-loginStatus",2);var info=result.data;return info.plchdAppFlag="Y",sessionStorage.setItem("elife-userData",JSON.stringify(info)),localStorage.setItem("elife-userToken",result.data.token),sessionStorage.setItem("Token",result.data.token),$rootScope.userData=info,sessionStorage.setItem("fromapp","Y"),vm.cusId=result.data.cusId,vm.plchdAppFlag="Y",void $state.go("my-policy-detail-new",{contNo:vm.policyData.contNo,sysType:vm.policyData.sysType,relation:vm.policyData.relationToAppnt2,grpcontno:vm.policyData.grpcontno,isGroup:!1})}})},$location.search().login_params&&!sessionStorage.getItem("fromapp"))return vm.userinfo=decodeURIComponent($location.search().login_params),sessionStorage.setItem("login_params",$location.search().login_params),void vm.AppLogin();if($location.search().login_params&&"Y"==sessionStorage.getItem("fromapp"))return window.location.href=CONFIG.DOMAIN+"/clife-stuff-app/#/converge/family-policy?login_params="+$location.search().login_params,void sessionStorage.removeItem("fromapp");vm.concealListFile=[],vm.loadingFinish=!1,vm.userHasPolicy=!1,vm.posterShow=!1,"1"===window.sessionStorage.getItem("posterShow")?vm.posterShow=!1:window.sessionStorage.setItem("posterShow","1"),document.getElementById("newpolicy").addEventListener("touchstart",function(){document.getElementById("kefu").classList.add("customer-wrapper-check")}),document.getElementById("newpolicy").addEventListener("touchend",function(){document.getElementById("kefu").classList.remove("customer-wrapper-check")}),vm.guardDays=0,vm.isflip_flag=JSON.parse(window.sessionStorage.getItem("isflip_flag"))||!1,vm.userName="",vm.photoUrl="",vm.personSex="",vm.recommendShow=JSON.parse(window.sessionStorage.getItem("recommendShow"))||!1,vm.products={myself:[],lover:[],children:[],parents:[],other:[]},vm.enterprise=[],vm.enterpriseList=[],vm.enterpriseExpired=[],vm.expiredPolicyShow=[!1,!1,!1,!1,!1],vm.showAllExpired=function(index){vm.expiredPolicyShow[index]=!vm.expiredPolicyShow[index]},CommonRequest.request({},CONFIG.QUERY_CONCEAL,function(result){1==result.status&&(vm.concealListFile=result.data)}),vm.getBasicInfo=function(){var openid=sessionStorage.getItem("elife-openid");null==openid&&(openid="12233211265151212");var params={openId:openid};CommonRequest.request(params,CONFIG.GET_BASIC_INFO,function(result){"1"===result.status&&result.data&&(vm.photoUrl=result.data.headImgUrl?result.data.headImgUrl:""),vm.getList()})},vm.flip_flag=!1,vm.letsFlip=function($event,key){"policy-front"===key?(window.sessionStorage.setItem("isflip_flag",JSON.stringify(!0)),this.isflip_flag=!0):(window.sessionStorage.setItem("isflip_flag",JSON.stringify(!1)),this.isflip_flag=!1),-1==$event.target.className.search("radar-recommend")&&(vm.flip_flag=!vm.flip_flag),vm.recommendShow===!0&&(window.sessionStorage.setItem("recommendShow",JSON.stringify(!1)),vm.recommendShow=!1)},vm.myPolicyCount=0,vm.familyCount=0,vm.overPercent=0,vm.isPercentZero=!1,vm.ismyCountZero=!1,vm.isFamilyCountZero=!1,vm.getPolicy=function(){var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.cusId=vm.userData.cusId);var params={cusId:vm.cusId,role:"1",contType:"0",queryType:"0"};if(CommonRequest.request(params,CONFIG.GET_POLICY_LIST,function(result){if(1==result.status){vm.concealList=[],vm.policyData=result;var policySort=[];if(result.data.myself.valid&&policySort.push("myself"),result.data.children.valid&&policySort.push("children"),result.data.lover.valid&&policySort.push("lover"),result.data.other.valid&&policySort.push("other"),result.data.parents.valid&&policySort.push("parents"),console.info(policySort,"数组内含有保单"),policySort.length){for(var m=0;m<policySort.length;m++)result.data[policySort[m]].valid.forEach(function(a){-1!=vm.concealListFile.indexOf(a.riskCode)&&vm.concealList.push(a.riskCode)});if(vm.concealList.length){var param={cretNo:$rootScope.userData.cretNo};vm.seeConceal=[],CommonRequest.request(param,CONFIG.SEE_CONCEAL,function(result){if(1==result.status){vm.seeConceal=result.data;var listLength=[];if(vm.concealList.forEach(function(a){-1==vm.seeConceal.indexOf(a)&&listLength.push(a)}),listLength.length){console.info(listLength,"列表中有隐私险种不在白名单中");for(var t=0;t<policySort.length;t++)for(var p=0;p<listLength.length;p++)for(var y=0;y<vm.policyData.data[policySort[t]].valid.length;y++)vm.policyData.data[policySort[t]].valid[y].riskCode==listLength[p]&&(console.info(vm.policyData.data[policySort[t]].valid[[y]],"执行删除"),vm.policyData.data[policySort[t]].valid.splice(y,1));vm.broadcast=!0,vm.dataProcessing(vm.policyData)}else console.info("列表中隐私险种都在白名单中"),vm.dataProcessing(vm.policyData)}else vm.dataProcessing(vm.policyData)})}else console.info("保单中无隐私险种"),vm.dataProcessing(result)}else console.info("保单数组中无数据"),vm.dataProcessing(result)}},!0),CONFIG.WECHAT){vm.num=0,vm.getuserImg=function(){vm.num++,vm.num>=8&&$interval.cancel(interval);var openid=sessionStorage.getItem("elife-openid");null==openid&&(openid="12233211265151212");var params={openId:openid};console.info(vm.num),CommonRequest.request(params,CONFIG.GET_BASIC_INFO,function(result){"1"===result.status&&result.data.headImgUrl&&(vm.photoUrl=result.data.headImgUrl,$interval.cancel(interval))})};var interval=$interval(function(){vm.getuserImg()},1e3)}},vm.texExtention=function(obj){return"1"==obj.sellType?"我的税延产品":obj.riskName},vm.typeTitle=function(index){var title=["我的保障","爱人的保障","子女的保障","父母的保障","其他"];return title[index]},vm.showRecommend=function(event){event.stopPropagation(),window.sessionStorage.setItem("recommendShow",JSON.stringify(!0)),vm.recommendShow=!0};var recommendProdList={others:{title:"担当，责任，感恩，建信人寿为您保驾护航",subTitle:"CCBLife will be always with you",color:"policy-prod-yellow",prodTitle:"龙行乐享百万身价B款产品计划",prodDesc:"满期领取130%已缴主险保险费",link:"10023",imageClass:"prod-icon-accident"},health:{title:"身体健康，幸福快乐，建信人寿给您爱的呵护",subTitle:"CCBLife will be always with you",color:"policy-prod-green",prodTitle:"龙安e生医疗保险",prodDesc:"一站式解决您的医疗费用 提供全方面保障",link:"10039",imageClass:"prod-icon-health"},accident:{title:"人生需要未雨绸缪，建信人寿与您风雨同舟",subTitle:"CCBLife will be always with you",color:"policy-prod-blue",prodTitle:"龙行无忧保险产品计划",prodDesc:"出行安全全面保障 意外医疗赔付不限",link:"121",imageClass:"prod-icon-others"}};vm.recommendProd={},vm.echartsOption={radar:[{splitNumber:9,indicator:[{text:{chinese:"健康医疗",english:"Health & Medical"},max:10},{text:{chinese:"意外保障",english:"Accident Protection"},max:10},{text:{chinese:"养老保障",english:"Pension Security"},max:10},{text:{chinese:"生命保障",english:"Life Support"},max:10},{text:{chinese:"财富管理",english:"Wealth Management"},max:10}],name:{formatter:function(value){var res="{top|"+value.chinese+"}";return res},triggerEvent:!0,textStyle:{color:"#33D5F4",textAlign:"center"},rich:{top:{fontSize:10,verticalAlign:"top",align:"center"}}},splitArea:{areaStyle:{color:[]}},splitLine:{lineStyle:{color:"#CAEFF6"}},axisLine:{lineStyle:{color:"#CAEFF6"}},center:["50%","50%"],radius:40,triggerEvent:!0}],series:[{name:"成绩单",type:"radar",itemStyle:{normal:{lineStyle:{color:"#36BFFF",width:.8}}},data:[{value:[0,113,12,30,70],symbol:"image://data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAMAAAADCAYAAABWKLW/AAAAJklEQVQYV2M02f+/hfE/Q+F/RoZ+RtN9/78yMjJw/f/P8I0RWQYATqoQ10542wIAAAAASUVORK5CYII=",name:"李四",areaStyle:{normal:{opacity:.55,color:new echarts.graphic.RadialGradient(.5,.1,1.6,[{color:"#012cff",offset:.1},{color:"#45c4fd",offset:.5}])}}}]}]},vm.getList=function(tab){$rootScope.isLogin?vm.getPolicy():$timeout(function(){vm.getList(vm.tab)},1e3)},vm.getBasicInfo(),vm.dataProcessing=function(result){vm.loadingFinish=!0;var data=result.data;vm.guardDays=data.guardDays,vm.guardDays<=364?vm.guardDays=vm.guardDays+" 天":365==vm.guardDays?vm.guardDays=vm.guardDays+" 年":vm.guardDays=parseInt(vm.guardDays/365)+" 年 "+vm.guardDays%365+" 天",vm.userName=data.customerName,vm.personSex=data.customerSex,""===vm.photoUrl&&(vm.photoUrl="1"===vm.personSex?"img/user/policy/male.png":"img/user/policy/female.png");for(var i in data){var valid=data[i].valid,expired=data[i].expired;valid&&valid.length&&(vm.userHasPolicy=!0),expired&&expired.length&&(vm.userHasPolicy=!0)}if(data.hasOwnProperty("enterprise")&&data.enterprise.length&&(vm.userHasPolicy=!0),vm.userHasPolicy){vm.familyCount=data.familyCount,vm.echartsOption.series[0].data[0].value=[data.radarInfo.healthTotal,data.radarInfo.accidentTotal,data.radarInfo.retireTotal,data.radarInfo.lifeTotal,data.radarInfo.wealthTotal];var radarFlag=0,radarCount=0;Object.keys(data.radarInfo).forEach(function(key){radarFlag++,radarCount+=data.radarInfo[key]-0}),vm.overPercent=radarCount/radarFlag*10,vm.overPercent>=90&&(vm.overPercent=90),vm.policyRadar=echarts.init(document.getElementById("policy-service-echart")),vm.policyRadar.setOption(vm.echartsOption),window.addEventListener("resize",function(){vm.policyRadar.resize()}),vm.policyRadar.on("click",function(params){if("axisName"==params.targetType)switch(params.name){case"健康医疗":$state.go("product-lays",{id:recommendProdList.health.link});break;case"意外保障":$state.go("product-detail",{id:recommendProdList.accident.link});break;default:$state.go("product-detail",{id:recommendProdList.others.link})}}),vm.products={myself:data.myself.valid,lover:data.lover.valid,children:data.children.valid,parents:data.parents.valid,other:data.other.valid},vm.expiredPolicyList=[data.myself.expired,data.lover.expired,data.children.expired,data.parents.expired,data.other.expired],vm.myPolicyCount=vm.products.myself.length,vm.enterprise=data.enterprise;for(var j in vm.enterprise){var arr=[];prodListInit(arr,vm.enterprise[j].valid),vm.enterpriseList.push(arr),vm.enterpriseExpired.push(!1),vm.myPolicyCount=vm.myPolicyCount+vm.enterprise[j].valid.length}vm.myselfProduct=[],vm.loverProduct=[],vm.childrenProduct=[],vm.parentsProduct=[],vm.otherProduct=[],prodListInit(vm.myselfProduct,vm.products.myself),prodListInit(vm.loverProduct,vm.products.lover),prodListInit(vm.childrenProduct,vm.products.children),prodListInit(vm.parentsProduct,vm.products.parents),prodListInit(vm.otherProduct,vm.products.other),arrayFindMin(data.radarInfo.accidentTotal,data.radarInfo)&&hasVal(data.radarInfo)?vm.recommendProd=recommendProdList.accident:arrayFindMin(data.radarInfo.healthTotal,data.radarInfo)&&hasVal(data.radarInfo)?vm.recommendProd=recommendProdList.health:arrayFindMin(data.radarInfo.healthTotal,data.radarInfo)&&arrayFindMin(data.radarInfo.accidentTotal,data.radarInfo)&&hasVal(data.radarInfo)?vm.recommendProd=recommendProdList.accident:hasVal(data.radarInfo)?vm.recommendProd=recommendProdList.others:vm.recommendProd=recommendProdList.accident}else vm.echartsOption.series[0].data[0].value=[0,0,0,0,0],vm.policyRadar=echarts.init(document.getElementById("policy-service-echart")),vm.policyRadar.setOption(vm.echartsOption),window.addEventListener("resize",function(){vm.policyRadar.resize()}),vm.recommendProd=recommendProdList.accident;0===vm.myPolicyCount&&(vm.ismyCountZero=!0),0==vm.familyCount&&(vm.isFamilyCountZero=!0),0===vm.overPercent&&(vm.isPercentZero=!0)},vm.prodContainerHeight={myself:function($index){var key=Object.keys(vm.products)[$index];return{height:vm.wrapperHeight(vm[key+"Product"].length)}}},vm.guaranteePeriod=function(start,end){if("string"==typeof start&&"string"==typeof end){var startYear=start.split("-")[0],endYear=end.split("-")[0],gap=endYear-startYear;if(gap>=100)return"终身";var period=vm.dateReplace(end),reg=new RegExp("/","g");return period=period.replace(reg,".")}},vm.setImgStyle=function(item,index){var types=["health","wealth","life","retire","accident"],indexType={"我的保障":"myself","爱人的保障":"lover","子女的保障":"children","父母的保障":"parents","其他":"parents"},riskType=types[item.riskType-0+1];return"undefined"==typeof riskType&&(riskType="health"),["policy-icon-"+riskType+"-"+indexType[index],"policy-icon-"+riskType]},vm.titleImgSrc=function($index){var imgSrc=["myself","lover","children","parents","other"];return imgSrc[$index]},vm.containerClass=function($index){var key=Object.keys(vm.products)[$index];return"policy-type-"+key},vm.dateInterval=function(start,end){var dateSpan;return start=Date.parse(start),end=Date.parse(end),dateSpan=end-start,0>dateSpan&&(dateSpan=0),Math.floor(dateSpan/864e5)},vm.dateFormate=function(date){return date.getFullYear()+"/"+(date.getMonth()+1)+"/"+date.getDate()},vm.todayDate=function(){return new Date},vm.dateReplace=function(str){return"string"==typeof str&&(str=str.replace(/-/g,"/")),str},vm.countDate=function(start,end){var today=vm.dateFormate(vm.todayDate()),startDay=vm.dateReplace(start),endDate=vm.dateReplace(end),isExpired=vm.dateInterval(endDate,today),interval=0;return interval=isExpired>0?vm.dateInterval(startDay,endDate):vm.dateInterval(startDay,today),interval>364?interval%365?parseInt(interval/365)+"年+":parseInt(interval/365)+"年":interval+"天"},vm.getStartDate=function(cvaliDate){var startDate=vm.dateReplace(cvaliDate),reg=new RegExp("/","g");return startDate=startDate.replace(reg,".")},vm.barPerecentage=function(cvaliDate,endDate){var total=vm.dateInterval(cvaliDate,endDate),lasted=vm.dateInterval(cvaliDate,vm.dateFormate(new Date)),percents=lasted/total;return{width:100*percents+"%",opacity:"0.7"}},vm.myselfArrow=function($index){var key=Object.keys(vm.products)[$index];return vm[key+"Product"].length>=vm.products[key].length||vm.expiredPolicyShow[$index]},vm.enterpriseArrow=function($index){Object.keys(vm.products)[$index];return vm.enterpriseList[$index].length>=vm.enterprise[$index].length||vm.enterpriseExpired[$index]},vm.initPages=10,vm.currentProduct=function($index){return vm[Object.keys(vm.products)[$index]+"Product"]},vm.totalProduct=function($index){return vm.products[Object.keys(vm.products)[$index]]};var countPerPage=10;vm.prodListPager=function($index){var key=Object.keys(vm.products)[$index],current=vm[key+"Product"],total=vm.products[key];if(total.length>current.length)if(total.length-current.length>=countPerPage)for(var currentLength=current.length,j=0;countPerPage>j;j++)current.push(total[currentLength+j]);else{current.length=0;for(var i in total)vm[key+"Product"].push(total[i])}else prodListInit(vm[key+"Product"],vm.products[key]),vm.expiredPolicyShow[$index]=!1},vm.enterprisePager=function(key){var current=vm.enterpriseList[key],total=vm.enterprise[key].valid;if(total.length>current.length)if(total.length-current.length>=countPerPage)for(var currentLength=current.length,j=0;countPerPage>j;j++)current.push(total[currentLength+j]);else{current.length=0;for(var i in total)vm.enterpriseList[key].push(total[i])}else prodListInit(vm.enterpriseList[key],vm.enterprise[key].valid),vm.enterpriseExpired[key]=!1},vm.showExpired=function($index){for(var key=Object.keys(vm.products)[$index],current=vm[key+"Product"],total=vm.products[key],i=0,flag=!1;total[i];)"0"==total[i].contState&&(flag=!0);return current.length==total.length&&flag},vm.toMall=function(){$state.go("tab.mall",{})},vm.toImprove=function(event){event.stopPropagation(),vm.toMall()},vm.wrapperHeight=function(num){switch(num){case 0:case 1:return"145px";case 2:return"230px";case 3:return"330px";default:return 74*(num-3)+300+"px"}},vm.showDetail=function(policy,isGroup){$state.go("my-policy-detail-new",{contNo:policy.contNo,sysType:policy.sysType,relation:policy.relationToAppnt2,grpcontno:policy.grpcontno,isGroup:isGroup})},vm.prodRecommend=function(id){"10039"==id?$state.go("product-lays",{id:id}):$state.go("product-detail",{id:id})}}angular.module("app").controller("MyPolicyControllerNew",MyPolicyControllerNew),MyPolicyControllerNew.$inject=["$state","$location","$log","$interval","$rootScope","CONFIG","CommonRequest","TipService","$window","$timeout","PolicyService"]}(),function(){function MyPolicyController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$location){var vm=this;vm.concealListFile=[],vm.cusId="",vm.AppLogin=function(){var param={login_parmas:vm.userinfo};CommonRequest.request(param,CONFIG.UNIFIED_LOGIN,function(result){if(1==result.status){sessionStorage.setItem("elife-login",1),sessionStorage.setItem("elife-loginStatus",2);var info=result.data;info.plchdAppFlag="Y",sessionStorage.setItem("elife-userData",JSON.stringify(info)),localStorage.setItem("elife-userToken",result.data.token),sessionStorage.setItem("Token",result.data.token),$rootScope.userData=info,sessionStorage.setItem("fromapp","Y"),vm.ccbApp=!0,vm.cusId=result.data.cusId,vm.plchdAppFlag="Y",vm.tab="2"}})},CommonRequest.request({},CONFIG.QUERY_CONCEAL,function(result){1==result.status&&(vm.concealListFile=result.data)}),$location.search().login_params&&(vm.userinfo=decodeURIComponent($location.search().login_params),vm.AppLogin()),vm.channel=$state.params.channel;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.cusId=vm.userData.cusId,vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.plchdAppFlag?vm.tab="2":vm.tab="1",vm.getList=function(tab){$rootScope.isLogin?"1"==tab?(vm.tab="1",vm.getPolicy()):"2"==tab&&(vm.tab="2",vm.broadcast=!1,vm.getGroupPolicy()):$timeout(function(){vm.getList(vm.tab)},1e3)},vm.refreshTime=60,vm.groupRefreshTime=60,vm.getCardNameByCode=function(){var params={},config={url:"../statics/json/cardPrdList.json",method:"GET"};CommonRequest.request(params,config,function(result){vm.cardPrdList=result.data},!0)},vm.formatCardNameFilter=function(data){for(var i=0;i<vm.cardPrdList.length;i++)if(data==vm.cardPrdList[i].prdCode)return vm.cardPrdList[i].prdName},vm.getPolicy=function(){if(vm.refreshTipForShow)return void $rootScope.$broadcast("scroll.refreshComplete");var params={cusId:vm.cusId,role:"1",contType:"0",queryType:"0"};vm.concealList=[],CommonRequest.request(params,CONFIG.MY_POLICY_SERVCIE,function(result){if(1==result.status&&result.data&&angular.isArray(result.data))if(vm.policyData=result,result.data.forEach(function(a){-1!=vm.concealListFile.indexOf(a.mainClassCode)&&vm.concealList.push(a.mainClassCode),console.info(vm.concealList,"111")}),console.info(vm.concealList,"隐私险种编码"),vm.concealList.length>0){var param={cretNo:$rootScope.userData.cretNo};vm.seeConceal=[],CommonRequest.request(param,CONFIG.SEE_CONCEAL,function(result){if(1==result.status){vm.seeConceal=result.data;var listLength=[];if(vm.concealList.forEach(function(a){-1==vm.seeConceal.indexOf(a)&&listLength.push(a)}),listLength.length){console.info(listLength,"列表中有隐私险种不在白名单中");for(var p=0;p<listLength.length;p++)for(var y=0;y<vm.policyData.data.length;y++)vm.policyData.data[y].mainClassCode==listLength[p]&&(vm.policyData.data.splice(y,1),console.info(vm.policyData.data,"执行删除"));vm.broadcast=!0,vm.dataProcessing(vm.policyData)}else console.info("列表中隐私险种都在白名单中"),vm.dataProcessing(vm.policyData)}else vm.dataProcessing(vm.policyData)})}else console.info("个险保单中无隐私险种"),vm.dataProcessing(result);$rootScope.$broadcast("scroll.refreshComplete")})},vm.dataProcessing=function(result){var data=result.data;if(vm.policyList=[],data&&angular.isArray(data)||(data=[],TipService.showMsg("暂时没有查询到保单"),vm.refreshTip("single")),vm.channel&&"811"==vm.channel)for(var i=0;i<data.length;i++)"820"==data[i].salechnl,vm.policyList.push(data[i]);else vm.policyList=data;for(var i=0;i<vm.policyList.length;i++)""==vm.policyList[i].effectTime||void 0==vm.policyList[i].effectTime?vm.policyList[i].effectDate=vm.policyList[i].effectDate+" 24时":(vm.startHour=vm.policyList[i].effectTime.substring(0,2),vm.policyList[i].effectDate=vm.policyList[i].effectDate+" "+vm.startHour+"时"),""==vm.policyList[i].endTime||void 0==vm.policyList[i].endTime?vm.policyList[i].polEndDate=vm.policyList[i].polEndDate+" 24时":(vm.endHour=vm.policyList[i].endTime.substring(0,2),vm.policyList[i].polEndDate=vm.policyList[i].polEndDate+" "+vm.endHour+"时"),"826"==vm.policyList[i].salechnl&&(vm.policyList[i].cardPrdName=vm.formatCardNameFilter(vm.policyList[i].cardPrdCode))},vm.getGroupPolicy=function(){if(vm.groupRefreshTipForShow)return void $rootScope.$broadcast("scroll.refreshComplete");var params={cusId:vm.cusId,saleChnlCd:CONFIG.SALE_CHANNEL};vm.plchdAppFlag&&"Y"==vm.plchdAppFlag&&(params.plchdAppFlag=vm.plchdAppFlag),CommonRequest.request(params,CONFIG.GROUP_POLICY_GROUP_POLICYLIST,function(result){if(1==result.status){var data=result.data;data&&angular.isArray(data)||(data=[],TipService.showMsg("暂时没有查询到保单"),vm.refreshTip("group")),vm.groupPolicyList=data}$rootScope.$broadcast("scroll.refreshComplete")})},vm.refreshTip=function(type){"single"==type&&(vm.refreshTime--,vm.refreshTime>0?(vm.refreshTipForShow=!0,$timeout(function(){vm.refreshTip("single")},1e3)):(vm.refreshTime=60,vm.refreshTipForShow=!1)),"group"==type&&(vm.groupRefreshTime--,vm.groupRefreshTime>0?(vm.groupRefreshTipForShow=!0,$timeout(function(){vm.refreshTip("group")},1e3)):(vm.groupRefreshTime=60,vm.groupRefreshTipForShow=!1))},vm.getCardNameByCode(),vm.getList(vm.tab),vm.showDetail=function(policy){"826"==policy.salechnl?$state.go("my-card-policy",{plchdCardNo:policy.plchdCardNo}):$state.go("my-policy-detail",{policyNo:policy.policyNo,totalMoney:policy.insFeePayed,mainClassCode:policy.mainClassCode})},vm.showGroupDetail=function(policyNo){$state.go("my-group-policy-detail",{policyNo:policyNo})}}angular.module("app").controller("MyPolicyController",MyPolicyController),MyPolicyController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$location"]}(),function(){function CertUnbindSuccessController($state,LoginService){var vm=this;vm.goMain=function(){$state.go("tab.mall")}}angular.module("app").controller("CertUnbindSuccessController",CertUnbindSuccessController),CertUnbindSuccessController.$inject=["$state","LoginService"]}(),function(){function ComplaintAreaProController($state,$rootScope,CommonRequest,CONFIG){var vm=this;vm.getList=function(){vm.aid="1",vm.pid="1",CommonRequest.request({},CONFIG.NETWORK_AREA_PRO,function(result){1==result.status&&(vm.list=result.data,vm.list.forEach(function(item){item.area_id==vm.aid&&(vm.pros=item.province)}))})},vm.getList(),vm.changePro=function(id){for(var list=vm.list,i=0;i<list.length;i++)list[i].area_id==id&&(vm.pros=list[i].province)},vm.showNetWork=function(aid,pid){$state.go("complaint-bank-pro",{aid:aid,pid:pid})},vm.returnKey=function(){$state.go("complaint")}}angular.module("app").controller("ComplaintAreaProController",ComplaintAreaProController),ComplaintAreaProController.$inject=["$state","$rootScope","CommonRequest","CONFIG"]}(),function(){function ComplaintBankProController($state,$rootScope,CommonRequest,CONFIG,$ionicHistory){var vm=this;vm.getList=function(){CommonRequest.request({},CONFIG.NETWORK_PRO_BANK,function(result){1==result.status&&(vm.list=result.data);for(var list=vm.list,i=0;i<list.length;i++)list[i].area_id==$state.params.aid&&list[i].pro_id==$state.params.pid&&(vm.bankList=list[i].bank)})},vm.getList(),vm.back=function(){$ionicHistory.goBack()}}angular.module("app").controller("ComplaintBankProController",ComplaintBankProController),ComplaintBankProController.$inject=["$state","$rootScope","CommonRequest","CONFIG","$ionicHistory"]}(),function(){function InvoiceDownloadController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$ionicLoading,$window,$sce,$ionicPopup){var vm=this;vm.tag=4,vm.id=$state.params.id;var sessionData=PolicyService.getSessionData(),userData=sessionData.userData;if(vm.cardNo=userData.cardNo,vm.type=userData.type,userData&&userData.birthday){var birthday=userData.birthday,reg=new RegExp("-","g");vm.birthday=birthday.replace(reg,""),vm.sex=userData.sex,vm.sceneType="21",vm.customerName=userData.customerName,vm.cretNo=userData.cretNo,vm.cretType=userData.cretType,"A"==vm.cretType?vm.cretType="0":"I"==vm.cretType?vm.cretType="1":"G"==vm.cretType?vm.cretType="9":"N"==vm.cretType&&(vm.cretType="3")}vm.submitApplyNum=0,vm.invoiceDownload=function(callback){var userData=PolicyService.getSessionData().userData;PolicyService.getSessionData().policyInvoice;if(userData.sceneType&&"10"==userData.sceneType)if("CARD"==userData.channelFlag)var params={sceneType:userData.sceneType,type:userData.type,channelFlag:"CARD",cardNo:userData.cardNo,customerName:userData.customerName,cerType:userData.cerType,cerId:userData.cerId};else var params={sceneType:userData.sceneType,type:userData.type,policyNo:userData.policyNo,customerName:userData.customerName,cerType:userData.cerType,cerId:userData.cerId};else if(userData.sceneType&&"20"==userData.sceneType)var params={birthday:vm.birthday,sex:vm.sex,sceneType:"20",customerName:vm.customerName,cerId:vm.cretNo,cerType:vm.cretType,type:"01",policyNo:userData.policyNo};else var params={birthday:vm.birthday,sex:vm.sex,sceneType:"21",customerName:vm.customerName,cerId:vm.cretNo,cerType:vm.cretType,type:"01"};CommonRequest.request(params,CONFIG.GET_INVOICE_INVOICE,function(result){if(1==result.status){var dataParams={token:result.token};result.data?(PolicyService.setSessionData({policyInvoice:result.data}),vm.invoiceList(result.data),$rootScope.$broadcast("scroll.refreshComplete")):(dataParams=angular.extend(dataParams,params),vm.anainSubmit(dataParams,callback))}else $rootScope.$broadcast("scroll.refreshComplete")})},vm.anainSubmit=function(params,callback){return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.submitApplyNum>=6?(vm.submitApplyNum=0,$ionicLoading.hide(),PolicyService.setSessionData({policyInvoice:params}),TipService.showMsg("查询无结果"),void $rootScope.$broadcast("scroll.refreshComplete")):void CommonRequest.request(params,CONFIG.GET_INVOICE_INVOICE_TWO,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return vm.submitApplyNum++,void $timeout(function(){vm.anainSubmit(params,callback)},5e3);$ionicLoading.hide(),PolicyService.setSessionData({policyInvoice:result.data}),vm.invoiceList(result.data),vm.submitApplyNum=0,angular.isFunction(callback)&&callback(result)}else $ionicLoading.hide(),vm.submitApplyNum=0;$rootScope.$broadcast("scroll.refreshComplete")},!0)};var twoYearList=[],oneYearList=[],thirdMonthList=[],oneMonthList=[],sevenDayList=[];vm.invoiceList=function(val){var sessionData=PolicyService.getSessionData();if(sessionData.policyInvoice){var electronicPolicyList=sessionData.policyInvoice||val;console.log(electronicPolicyList);for(var i=0;i<electronicPolicyList.length;i++)if(-1!=electronicPolicyList[i].xZMC.indexOf(";")){var reg=new RegExp(";","g");electronicPolicyList[i].xZMC=$sce.trustAsHtml(electronicPolicyList[i].xZMC.replace(reg,"<br/>"))}var date=new Date,month=date.getMonth()+1,strDate=date.getDate();month>=1&&9>=month&&(month="0"+month),strDate>=1&&9>=strDate&&(strDate="0"+strDate);for(var newTime=date.getFullYear()+month+strDate,i=0;i<electronicPolicyList.length;i++){var year=electronicPolicyList[i].zFRQ,reg=new RegExp("-","g"),timeDifferece=newTime-year.replace(reg,"");2e4>=timeDifferece&&twoYearList.push(electronicPolicyList[i]),1e4>=timeDifferece&&oneYearList.push(electronicPolicyList[i]),300>=timeDifferece&&thirdMonthList.push(electronicPolicyList[i]),100>=timeDifferece&&oneMonthList.push(electronicPolicyList[i]),7>=timeDifferece&&sevenDayList.push(electronicPolicyList[i]),electronicPolicyList[i].policymoney=(1*electronicPolicyList[i].policymoney).toFixed(2)}vm.electronicPolicyList=sevenDayList}vm.getPolicy(4),vm.policyDown=function(val){$window.location.href=val}},vm.policyApply=function(id,apply){if("1"==apply){var myPopup=$ionicPopup.show({template:"已提交开票申请",buttons:[{text:'<p class="blue m0">确定</p>',onTap:function(){console.info(1)}}]});return void myPopup.then(function(res){console.log("tapped!",res)})}var params={policyNo:id,customerName:vm.customerName,cerType:vm.cretType,cerId:vm.cretNo,channelCode:$rootScope.SALE_CHANNEL};CommonRequest.request(params,CONFIG.EINVOICE_APPLY,function(result){if(1==result.status){var myPopup=$ionicPopup.show({template:result.data,buttons:[{text:"确定",onTap:function(){console.info(1)}}]});myPopup.then(function(res){console.log("tapped!",res)})}else{var myPopup1=$ionicPopup.show({template:result.data,buttons:[{text:"确定",onTap:function(){console.info(1)}}]});myPopup1.then(function(res){console.log("tapped!",res)})}})},vm.getPolicy=function(tag){switch(vm.tag=tag,tag){case 1:vm.electronicPolicyList=oneYearList;break;case 2:vm.electronicPolicyList=thirdMonthList;break;case 3:vm.electronicPolicyList=oneMonthList;break;case 4:vm.electronicPolicyList=sevenDayList;break;case 5:vm.electronicPolicyList=twoYearList}},vm.invoiceRefresh=function(){twoYearList=[],oneYearList=[],thirdMonthList=[],oneMonthList=[],sevenDayList=[],vm.invoiceDownload()},"1"==vm.id?vm.invoiceList():vm.invoiceDownload()}angular.module("app").controller("InvoiceDownloadController",InvoiceDownloadController),InvoiceDownloadController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$ionicLoading","$window","$sce","$ionicPopup"]}(),function(){function InvoiceLoginController($scope,$state,$rootScope,CommonRequest,CONFIG,LoginService,COMMON,$document,$timeout,PolicyService,TipService,$ionicLoading){var vm=this;if(vm.type=$state.params.tapy,vm.certTypes=[],vm.sceneType="10",vm.invoicePersonType=[{name:"保单号"},{name:"卡单号"}],vm.invoicePersonClass=vm.invoicePersonType[0],vm.invoiceBusType=[{name:"保单号"},{name:"批次号"}],vm.invoiceBusClass=vm.invoiceBusType[0],"01"==vm.type){var params={};CommonRequest.request(params,CONFIG.ONE_INVOIVE_TYPE,function(result){1==result.status&&(vm.certTypes=result.data)}),vm.certType="0"}else{var params={};CommonRequest.request(params,CONFIG.INVOIVE_TYPE,function(result){1==result.status&&(vm.certTypes=result.data)}),vm.certType="0"}vm.errorAlert=function(model,invalid,key,val){$rootScope.loadingPage&&model&&invalid&&(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),"policyNo"==key&&(1==val.$error.length?vm.errorMsg="您输入的保单号码过长":1==val.$invalid&&(vm.errorMsg="请输入正确的保单号码")),"name"==key&&(1==val.length?vm.errorMsg="您输入姓名过长":1==val.invalid&&(vm.errorMsg="您输入姓名不正确"),1==val.length2?vm.errorMsg="您输入的单位联系人过长":1==val.invalid2&&(vm.errorMsg="您输入的单位联系人不正确")),"certNo"==key&&(1==val.invalid?vm.errorMsg="您输入的证件号码不正确":1==val.length&&(vm.errorMsg="您输入的保单号码过长")),"cardNo"==key&&(1==val.$error.length?vm.errorMsg="您输入的卡单号码过长":1==val.$invalid&&(vm.errorMsg="您输入的卡单号码不正确")))},vm.hide=function(){vm.showError=!1},vm.submit=function(callback){PolicyService.getSessionData().userData&&PolicyService.removeSessionData("userData");var params={};params=vm.invoicePersonClass==vm.invoicePersonType[0]&&"01"==vm.type||vm.invoiceBusClass==vm.invoiceBusType[0]&&"02"==vm.type?{sceneType:vm.sceneType,type:vm.type,policyNo:vm.policyNo,customerName:vm.name,cerType:vm.certType,cerId:vm.certNo}:{sceneType:vm.sceneType,type:vm.type,channelFlag:"CARD",cardNo:vm.cardNo,customerName:vm.name,cerType:vm.certType,cerId:vm.certNo},PolicyService.invoiceSubmit(params,function(){PolicyService.setSessionData({userData:params})})},$rootScope.$on("invoiceVal",function(event,result){vm.cardNo="",vm.policyNo="",vm.name="",vm.certNo="",vm.certType="0"})}angular.module("app").controller("InvoiceLoginController",InvoiceLoginController),InvoiceLoginController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","LoginService","COMMON","$document","$timeout","PolicyService","TipService","$ionicLoading"];
}(),function(){function InvoiceUserController($scope,$state,$rootScope,CommonRequest,CONFIG,LoginService,COMMON,$document){}angular.module("app").controller("InvoiceUserController",InvoiceUserController),InvoiceUserController.$inject=["$scope","$state","$rootScope","CommonRequest","CONFIG","LoginService","COMMON","$document"]}(),function(){function CommingSoonController(CONFIG){var vm=this;vm.divShow=!1,CONFIG.WECHAT?vm.divShow=!1:vm.divShow=!0}angular.module("app").controller("CommingSoonController",CommingSoonController),CommingSoonController.$inject=["CONFIG"]}(),function(){function GreenChannelController(CONFIG){var vm=this;vm.divShow=!1,CONFIG.WECHAT?vm.divShow=!1:vm.divShow=!0}angular.module("app").controller("GreenChannelController",GreenChannelController),GreenChannelController.$inject=["CONFIG"]}(),function(){function OverseasController(CONFIG){var vm=this;vm.divShow=!1,CONFIG.WECHAT?vm.divShow=!1:vm.divShow=!0}angular.module("app").controller("OverseasController",OverseasController),OverseasController.$inject=["CONFIG"]}(),function(){function Report($rootScope,$location,Upload,CONFIG,$scope,TipService,PolicyService,COMMON,$ionicLoading,$timeout,$ionicPopup,$state,CommonRequest,VALIDATION,$filter,$document){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.picUrl=[],vm.picState="1",vm.material="",vm.idMask2=!0;var MaskSession=sessionStorage.getItem("elife-MaskSession");vm.titleStatus=!1,vm.errorStatus="N",vm.description="",vm.ocrSwitch=function(){var ocrParams={};CommonRequest.request(ocrParams,CONFIG.BACKUP_QUEURY_OCR_SWITCH,function(result){result&&1==result.status&&("Y"==result.data?vm.ocrOpenState=!0:"N"==result.data&&(vm.ocrOpenState=!1))})},vm.ocrSwitch(),vm.getCompany=function(params,callback){var config={url:"../statics/json/sysOrgList.json",method:"GET"};CommonRequest.request({},config,function(result){if(result&&result.status&&1==result.status){var materials=result.data;materials&&materials.length>0&&(vm.materials=materials)}})},vm.getCompany(),$scope.files={},$scope.files.file1="",$scope.files.file2="",$scope.imageList=[],$scope.uploaded=0,vm.submit=function(){var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,$scope.uploaded=0,2!=$scope.uploaded){var file1=$scope.files.file1,file2=$scope.files.file2;if($scope.imageList=[],file1&&file2&&$scope.imageList.push({F001:file1,uploadType:"1000"},{F002:file2,uploadType:"0100"}),2!=$scope.imageList.length)return void TipService.showMsg("请上传身份证正面和反面");vm.mosaicFile1&&$scope.imageList.push({F003:vm.mosaicFile1,uploadType:"1000"}),PolicyService.isAllowUpload($scope.imageList.length,function(){vm.checkUpload($scope.uploaded)})}},vm.checkUpload=function(uploaded){var data={custId:vm.userData?vm.userData.cusId:"",token:vm.userData?vm.userData.token:"",channelCode:CONFIG.SALE_CHANNEL,txCode:"CCBSB111"};vm.upload(angular.extend($scope.imageList[uploaded],data),function(){$scope.uploaded++})},vm.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(result){if($ionicLoading.hide(),"1"==result.data.status){vm.uploadMsg="上传成功！";var path=result.data.data;"F001"==result.data.data[0].imageFlag?(vm.imageFrontPath=path[0].imageTempPath,vm.picUrl.push({F:result.data.data[0].imageFlag,value:result.data.data[0].imageName})):"F002"==result.data.data[0].imageFlag&&(vm.imageBackPath=path[0].imageTempPath,vm.picUrl.push({F:result.data.data[0].imageFlag,value:result.data.data[0].imageName})),angular.isFunction(callback)&&callback()}else vm.picState="0",TipService.showMsg(result.data.error.message+result.data.error.code),$scope.uploadMsg="上传失败"},function(resp){vm.picState="0",$ionicLoading.hide(),$scope.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$scope.uploadMsg="上传进度: "+progressPercentage+"%"})},$scope.$watch("uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&newValue<$scope.imageList.length?vm.checkUpload(newValue):newValue==$scope.imageList.length&&vm.backUp())}),vm.submit_form=function(){if(vm.ocrOpenState&&"2"!=vm.RecognizeSatus)vm.ocrStatus="Y",vm.reportCerid="",vm.certPeriod="",vm.reportName="";else{if(vm.reportCerid=vm.reportCerid.replace(/ /g,""),"长期"!=vm.birthday?vm.certPeriod=$filter("date")(vm.birthday,"yyyy-MM-dd"):vm.certPeriod="2099-12-31",vm.ocrStatus="N",void 0==vm.reportName||""==vm.reportName)return void vm.alertErrorMessage("采集人姓名不能为空！");if(void 0==vm.reportCerid||""==vm.reportCerid)return void vm.alertErrorMessage("采集人证件号不能为空！");if(void 0==vm.certPeriod||""==vm.certPeriod)return void vm.alertErrorMessage("请选择有效期！");if(void 0==vm.material||""==vm.material)return void vm.alertErrorMessage("请选择区域信息！");if(!VALIDATION.idCheck(vm.reportCerid))return void vm.alertErrorMessage("证件号不合法！")}"2"==vm.RecognizeSatus?vm.backUp():vm.submit()},vm.backUp=function(){var sessionData=PolicyService.getSessionData();if(vm.userData=sessionData.userData,vm.openId=sessionStorage.getItem("elife-openid"),"1"!=vm.picState)return $scope.uploaded=0,void TipService.showMsg("图片上传操作失败");for(var i=0;i<vm.picUrl.length;i++)"F001"==vm.picUrl[i].F?vm.idFront=vm.picUrl[i].value:"F002"==vm.picUrl[i].F&&(vm.idBehind=vm.picUrl[i].value);var params={picUrl:vm.getTime()+vm.idFront+"#"+vm.getTime()+vm.idBehind,referenName:vm.userData.customerName,referenSex:vm.userData.sex,referenBirthday:vm.userData.birthday,referenCertype:vm.userData.cretType,referenCerid:vm.userData.cretNo,reportName:vm.reportName,reportCertype:"A",reportCerid:vm.reportCerid.trim(),certPeriod:vm.certPeriod,idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,reportOrgcode:vm.material,type:"",channelCode:"811",ocrStatus:vm.ocrStatus,openId:vm.openId};vm.ocrOpenState&&"2"!=vm.RecognizeSatus?vm.idCardRecognize():CommonRequest.request(params,CONFIG.SUBMIT_REPORT_MESSAGE,function(result){vm.reddotStatus(),vm.removeMessage(),vm.alertMessage(),vm.RecognizeSatus=""})},vm.idCardRecognize=function(){if(vm.recognizeFlg=!1,vm.ocrOpenState){var u_data=sessionData.userData;vm.openId=sessionStorage.getItem("elife-openid");var params={idFront:vm.imageFrontPath,idBehind:vm.imageBackPath,referenName:u_data.customerName,referenSex:u_data.sex,referenBirthday:u_data.birthday,referenCerid:u_data.cretNo,referenCertype:u_data.cretType,custId:u_data.cusId,openId:vm.openId,sceneCode:"SC001",channelCode:"811"};$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner><div class="ocr-load-text">努力识别中...</div>'}),CommonRequest.request(params,CONFIG.BD_IDCARD_RECOGNIZE,function(result){if($ionicLoading.hide(),vm.timeoutdata=result,"1"==result.status){var recognizeData=result.data;vm.token=recognizeData.tocken,"000000"==recognizeData.responseStatus?(vm.ocrInfoShow(recognizeData),vm.removeMessage(),vm.RecognizeSatus="1"):("111111"==recognizeData.responseStatus&&vm.ShowOcrMsg("身份信息有误"),"222222"==recognizeData.responseStatus&&vm.ShowOcrMsg("证件过期"),"333333"==recognizeData.responseStatus&&vm.ShowOcrMsg("识别失败"),"555555"!=recognizeData.responseStatus&&"666666"!=recognizeData.responseStatus||vm.ShowOcrMsg("请上传正确且清晰的身份证正反面照片"))}},!0)}},vm.ShowOcrMsg=function(templateMsg){var alertPopup=$ionicPopup.confirm({cssClass:"popup-icon",template:templateMsg,okText:"重新上传",cancelText:"手动修改"});alertPopup.then(function(res){res?vm.removeMessage():vm.RecognizeSatus="2"})},vm.ocrInfoShow=function(obj){if(vm.reportName=obj.name||"",vm.reportCerid=obj.idCardNo||"",vm.idexpire="2",obj.expiryDate&&8==obj.expiryDate.replace("/(^s*)|(s*$)/g","").length){var t=obj.expiryDate.substring(0,4)+"-"+obj.expiryDate.substring(4,6)+"-"+obj.expiryDate.substring(6,8);vm.birthday=new Date(t)}else vm.birthday="";$ionicPopup.show({title:'<img src="img/user/activation_success.png">',template:'<div>信息采集成功，可在“结果查询”处查看</div><div class="ocr-dialog-item"><span>姓名</span><span>'+obj.name+'</span></div><div class="ocr-dialog-item"><span>证件号码</span><span>'+obj.idCardNo+'</span></div><div class="ocr-dialog-item"><span>证件有效期</span><span>'+obj.expiryDate+"</span></div>",scope:$scope,cssClass:"ocr-dialog",buttons:[{text:"确定",onTap:function(res){res&&$state.go("select-result")}}]})},vm.fileChange=function(file){file&&COMMON.identityImg(file,function(img,bolbVal){var timer=$timeout(function(){vm.mosaicImg1=img,$timeout.cancel(timer)},100);bolbVal.name="a.png",vm.mosaicFile1=bolbVal})},$scope.changePic=function($event){var img=$event.srcElement||$event.target;$scope.bigimage=img.src,$("#js-imgview")[0].style.display="block",vm.delUpload=function(){$scope.bigimage=img.src="",$scope.files.file1=!1,$("#js-imgview")[0].style.display="none"},$scope.closePic=function(){$("#js-imgview")[0].style.display="none"}},$scope.changePic2=function($event){var img2=$event.srcElement||$event.target;$scope.bigimage2=img2.src,$("#js-imgview-mask2")[0].style.display="block",vm.delUpload2=function(){$scope.bigimage2=img2.src="",$scope.files.file2=!1,$("#js-imgview-mask2")[0].style.display="none"},$scope.closePic2=function(){$("#js-imgview-mask2")[0].style.display="none"}},vm.alertMessage=function(){var alertPopup=$ionicPopup.alert({title:'<img src="img/user/activation_success.png">',template:"提交成功，可在“结果查询”处查看",okText:"确定",cssClass:"distingguishPopupSuccess"});alertPopup.then(function(res){res&&$state.go("select-result")})},vm.alertErrorMessage=function(errorMessage){var alertPopup=$ionicPopup.alert({title:'<img src="img/user/activation_success.png">',template:errorMessage,okText:"确定",cssClass:"distingguishPopupSuccess"});alertPopup.then(function(res){})},vm.getTime=function(){var nowTime=new Date,nowYear=nowTime.getFullYear(),nowMonth=nowTime.getMonth()+1,nowData=nowTime.getDate();10>nowMonth&&(nowMonth="0"+nowMonth),10>nowData&&(nowData="0"+nowData);var dataValue="/"+nowYear+"/"+nowMonth+"/"+nowData+"/";return dataValue},vm.errorAlert=function(key,val){"reportName"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"reportCerid"==key&&(1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)))},vm.compareDate=function(str){var nowData=(new Date).getTime(),compareDate=new Date(str).getTime();return compareDate+864e5>=nowData},vm.holderStartDate=new Date((new Date).getTime()+864e5),vm.CerSlice=function(){vm.reportCerid=VALIDATION.certNoFormat(vm.reportCerid)},vm.removeMessage=function(){$scope.uploaded=0,$scope.files.file1=!1,$scope.files.file2=!1,vm.reportName="",vm.reportCerid="",vm.birthday="",vm.material="",vm.longData=!1},vm.reddotStatus=function(){PolicyService.setSessionData({reddot:"1"}),$rootScope.checkResultStatus=!0},vm.fisstReddotStatus=function(){var reddot=sessionStorage.getItem("elife-reddot");void 0!=reddot&&""!=reddot||(PolicyService.setSessionData({reddot:"2"}),$rootScope.checkResultStatus=!1)},vm.fisstReddotStatus(),vm.idMask=function(){vm.idMask2=!1,PolicyService.setSessionData({MaskSession:"1"})},1==MaskSession&&(vm.idMask2=!1),vm.reportIdImgQues=function(){vm.idMask2=!0},vm.longDataFun=function(){vm.longData?(vm.longData=!1,vm.birthday=""):(vm.longData=!0,vm.birthday="长期")},vm.longDataInput=function(){"长期"==vm.birthday&&(vm.longData=!1)}}angular.module("app").controller("Report",Report),Report.$inject=["$rootScope","$location","Upload","CONFIG","$scope","TipService","PolicyService","COMMON","$ionicLoading","$timeout","$ionicPopup","$state","CommonRequest","VALIDATION","$filter","$document"]}(),function(){function SelectResultController($scope,CommonRequest,$rootScope,CONFIG,$timeout,$state,$window,PolicyService,VALIDATION,$ionicPopup){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.noQueryData=!1,vm.getResults=function(){if(void 0==vm.keyword||""==vm.keyword)vm.reportName="",vm.reportCerid="";else if(VALIDATION.chineseCheck(vm.keyword))vm.reportName=vm.keyword;else{if(!VALIDATION.idCheck(vm.keyword))return;vm.reportCerid=vm.keyword}var params={referenName:vm.userData.customerName,referenSex:vm.userData.sex,referenBirthday:vm.userData.birthday,referenCertype:vm.userData.cretType,referenCerid:vm.userData.cretNo,reportName:vm.reportName,reportCerid:vm.reportCerid,queryType:"2"};CommonRequest.request(params,CONFIG.BACKUP_QUERY_MESSAGE,function(result){result&&1==result.status&&(result.data.length>0&&angular.isArray(result.data)?vm.data=result.data.filter(function(val){var str=val.reportName.toLowerCase(),id=val.reportCerid.toLowerCase();return"admin"!=str&&"1111111111111111"!=id}):vm.data="",result.data.length>0&&(vm.noQueryData=!0),vm.reportName="",vm.reportCerid="")},!0),$rootScope.$broadcast("scroll.refreshComplete")},vm.getResults(),vm.selectResultList=function(){vm.getResults();var fxmSelectInput=document.querySelector(".fxm-xxcu-search div");fxmSelectInput.onclick=function(){vm.getResults()}},vm.reddotStatus=function(){PolicyService.setSessionData({reddot:"2"}),$rootScope.checkResultStatus=!1},vm.reddotStatus(),vm.getTime=function(){var nowTime=new Date,nowYear=nowTime.getFullYear(),nowMonth=nowTime.getMonth()+1,nowData=nowTime.getDate();10>nowMonth&&(nowMonth="0"+nowMonth);var dataValue=nowYear+"-"+nowMonth+"-"+nowData;return dataValue}}angular.module("app").controller("SelectResultController",SelectResultController),SelectResultController.$inject=["$scope","CommonRequest","$rootScope","CONFIG","$timeout","$state","$window","PolicyService","VALIDATION","$ionicPopup"]}(),function(){function MyContactAddController($state,$scope,CommonRequest,CONFIG,$ionicHistory,$rootScope,$filter,VALIDATION,COMMON){var vm=this;vm.nationality="0156",vm.idtypes=[{label:"身份证",value:"A"}],vm.selectCerType=function(national){"0156"==national?vm.idtypes=[{label:"身份证",value:"A"}]:"0999"==national?vm.idtypes=[{label:"护照",value:"I"},{label:"外国人永久居留身份证",value:"N"}]:vm.idtypes=[{label:"港澳台通行证",value:"G"}],vm.idtype=vm.idtypes[0].value,vm.id=""},vm.idtype="A",vm.loading=!1,vm.relation="",vm.relations=COMMON.getCommonData().RELATIONS,vm.name="",vm.idtype="A",vm.id="",vm.idexpire="1",vm.minStartDate=new Date,vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.gender="1",vm.birthday="",vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.nationalityList=$rootScope.COMMON_DATA.NATIONALITIES,vm.add=function(){var validity=vm.certExpireDate,sex=vm.gender,bd=vm.birthday;validity="1"==vm.idexpire?new Date("2099-12-31"):vm.certExpireDate,validity=$filter("date")(validity,"yyyy-MM-dd"),"A"==vm.idtype?(bd=VALIDATION.getBirthday(vm.id),sex=VALIDATION.getSex(vm.id),vm.nationality="0156"):(bd=bd,sex=sex);var params={contactName:vm.name,cretType:vm.idtype,cretNo:vm.id,sex:sex,bronToString:$filter("date")(bd,"yyyy-MM-dd"),relation:vm.relation,nationality:vm.nationality,cretPeriodString:validity};CommonRequest.request(params,CONFIG.ADD_CONTACT_SERVICE,function(result){1==result.status&&$state.go("my-contacts")})},$scope.$watch("myContactAdd.relation",function(){"02"==vm.relation||"04"==vm.relation||"06"==vm.relation?vm.gender="1":"03"==vm.relation||"05"==vm.relation||"07"==vm.relation?vm.gender="2":vm.gender=$rootScope.userData.sex},!0),vm.longData=!1,vm.longDataInput=function(){vm.longData=!1},vm.longDataFun=function(){vm.longData?(vm.longData=!1,vm.certExpireDate=""):(vm.longData=!0,vm.certExpireDate="长期")}}angular.module("app").controller("MyContactAddController",MyContactAddController),MyContactAddController.$inject=["$state","$scope","CommonRequest","CONFIG","$ionicHistory","$rootScope","$filter","VALIDATION","COMMON"]}(),function(){function MyContactEditController($state,$scope,CommonRequest,CONFIG,$rootScope,$ionicHistory,$filter,$ionicPopup,COMMON,$timeout){var vm=this;if(vm.contactId=$state.params.contactId,vm.contactId||$state.go("my-contacts"),vm.relation="0"+$state.params.relation||"01",vm.relations=COMMON.getCommonData().RELATIONS,vm.name=$state.params.contactName||"",vm.longData=!1,vm.nationality=$state.params.nationality||"0156",vm.idtype=$state.params.cretType||"A",vm.idno=$state.params.cretNo||"",vm.certExpireDate=$state.params.cretPeriodString||1,"2099-12-31"==vm.certExpireDate)var timer=$timeout(function(){vm.certExpireDate="长期",vm.longData=!0,vm.idexpire="1",$timeout.cancel(timer)},300);else vm.idexpire="2";vm.minStartDate=new Date,vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.gender=$state.params.sex.toString()?$state.params.sex.toString():"1",vm.birthday=new Date($state.params.bronTo),vm.birthdayCallback=function(val){val&&(vm.birthday=val)};var userid="";$rootScope.userData&&(userid=$rootScope.userData.cusId);var params={Id:userid};if(CommonRequest.request(params,CONFIG.GET_CONTACTS_EXT_SERVICE,function(result){if(1==result.status){vm.mycontacts=result.data;for(var i=0;i<vm.mycontacts.length;i++)vm.mycontacts[i].contactId==vm.contactId&&(vm.relation="0"+parseInt(vm.mycontacts[i].relation)||"01",vm.name=vm.mycontacts[i].contactName,vm.idtype=vm.mycontacts[i].cretType,vm.idno=vm.mycontacts[i].cretNo,vm.gender=vm.mycontacts[i].sex.toString(),vm.birthday=vm.mycontacts[i].bronTo,vm.contactId=vm.mycontacts[i].contactId,vm.nationality=vm.mycontacts[i].nationality,vm.certExpireDate=vm.mycontacts[i].cretPeriodString)}}),"2099-12-31"==vm.certExpireDate){var timer=$timeout(function(){vm.certExpireDate="长期",$timeout.cancel(timer)});vm.longData=!0,vm.idexpire="1"}else vm.idexpire="2";vm.selectCerType=function(national){"0156"==national?vm.idtypes=[{label:"身份证",value:"A"}]:"0999"==national?vm.idtypes=[{label:"护照",value:"I"},{label:"外国人永久居留身份证",value:"N"}]:vm.idtypes=[{label:"港澳台通行证",value:"G"}],vm.idtype=vm.idtypes[0].value,vm.idno="",national==$state.params.nationality&&(vm.idno=$state.params.cretNo)},vm.selectCerType(vm.nationality),vm.edit=function(){"1"==vm.idexpire&&(vm.certExpireDate="2099-12-31");var params={contactName:vm.name,cretType:vm.idtype,cretNo:vm.idno,sex:vm.gender,bronToString:$filter("date")(vm.birthday,"yyyy-MM-dd"),relation:vm.relation,Id:vm.contactId,nationality:vm.nationality,cretPeriodString:$filter("date")(vm.certExpireDate,"yyyy-MM-dd")};CommonRequest.request(params,CONFIG.MODIFY_CONTACT_SERVICE,function(result){1==result.status&&$ionicHistory.goBack()})},vm["delete"]=function(){var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png>',template:"是否继续删除联系人?",okText:"确认",cancelText:"取消"});alertPopup.then(function(res){if(res){var params={Id:vm.contactId};CommonRequest.request(params,CONFIG.DELETE_CONTACTS_SERVICE,function(result){1==result.status&&$ionicHistory.goBack()})}})},$scope.$watch("myContactEdit.relation",function(){"02"==vm.relation||"04"==vm.relation||"06"==vm.relation?vm.gender="1":"03"==vm.relation||"05"==vm.relation||"07"==vm.relation?vm.gender="2":vm.gender=$rootScope.userData.sex},!0),$scope.$watch("myContactEdit.idtype",function(){"A"!=vm.idtype&&(vm.birthday="")},!0),vm.longDataInput=function(){vm.longData=!1,vm.certExpireDate="",vm.idexpire="2"},vm.longDataFun=function(){"长期"==vm.certExpireDate?(vm.certExpireDate="",vm.longData=!1,vm.idexpire="2"):(vm.certExpireDate="长期",vm.longData=!0,vm.idexpire="1")}}angular.module("app").controller("MyContactEditController",MyContactEditController),MyContactEditController.$inject=["$state","$scope","CommonRequest","CONFIG","$rootScope","$ionicHistory","$filter","$ionicPopup","COMMON","$timeout"]}(),function(){function MyOrderDetailController($state,CommonRequest,CONFIG,PolicyService,$filter,$rootScope,$ionicModal){var vm=this;return vm.orderCode=$state.params.orderCode,vm.orderCode?(vm.order={},vm.getOrderDetail=function(){var params={orderCode:vm.orderCode,channelCode:CONFIG.SALE_CHANNEL};CommonRequest.request(params,CONFIG.ORDER_DETAIL_SERVCIE,function(result){if(1==result.status){vm.order=result.data;var effectiveTime=$filter("date")(new Date(vm.order.policyList[0].effectiveTime),"yyyy-MM-dd HH:mm");if("00:00"==effectiveTime.substring(11,16)?vm.effectiveTime=$filter("date")(new Date(new Date(new Date(new Date(new Date(vm.order.policyList[0].effectiveTime).toLocaleDateString()).getTime()+864e5-1))),"yyyy-MM-dd HH:mm:ss"):vm.effectiveTime=effectiveTime,"5"==vm.order.orderStatus||"10"==vm.order.orderStatus?vm.line=1:"11"==vm.order.orderStatus||"13"==vm.order.orderStatus||"14"==vm.order.orderStatus||"15"==vm.order.orderStatus||"16"==vm.order.orderStatus?vm.line=2:"12"==vm.order.orderStatus?vm.line=3:"32"==vm.order.orderStatus?vm.line=5:vm.line=4,vm.order.recentRecord&&("0201"==vm.order.recentRecord.payChannelCode?vm.order.recentRecord.payChannelCode="02":"0101"==vm.order.recentRecord.payChannelCode?vm.order.recentRecord.payChannelCode="01":"0301"==vm.order.recentRecord.payChannelCode&&(vm.order.recentRecord.payChannelCode="03")),vm.branchCode=vm.order.policyList[0].branchCode,void 0==$rootScope.traceData){var params2={orderCode:vm.orderCode};PolicyService.createOrderYeefxSrc(params2)}}})},vm.getOrderDetail(),vm.openSignModal=function(){var params={orderCode:vm.orderCode,custType:""};CommonRequest.request(params,CONFIG.GET_VERIFY_LIST,function(result){if("1"==result.status)if(result.data&&result.data.length>0){$rootScope.fromMyorderCode=vm.orderCode,$rootScope.fromMyorderPrdId=vm.order.prdId,$rootScope.fromMyorder=!0;var self=$rootScope,url="app/module/mall/product/product-purchase/product-purchase-sign/product-purchase-sign.html";$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.close=function(){self.modal.remove()},self.payAgain=function(){self.modal.remove(),vm.continuePay()}})}else vm.continuePay()})},vm.continuePay=function(){var params={prdId:vm.order.policyList[0].prdId,planId:vm.order.policyList[0].planId,channelCode:vm.order.policyList[0].channelCode,orgCode:vm.order.policyList[0].orgCode};PolicyService.getProductDiscount(params,function(result){vm.hasDiscount=result.hasDiscount;var params={prdId:vm.order.prdId},sessionData=PolicyService.getSessionData();CommonRequest.request(params,CONFIG.PRODUCT_INFO_SERVICE,function(result){if(1==result.status){var productData=result.data;productData.hasDiscount=vm.hasDiscount;var policyData;policyData="GHMB"==vm.order.prdCode?{LiRcgnName:sessionData.userData.customerName,LiRcgnSex:sessionData.userData.sex,itemOrderRealPayAmt:vm.order.orderRealAmnt,payType:productData.payType,orderCode:vm.orderCode,BkBrchNo:vm.branchCode,groupProName:vm.order.prdName,PbHoldEmail:vm.order.email}:{LiRcgnName:sessionData.userData.customerName,LiRcgnSex:sessionData.userData.sex,itemOrderRealPayAmt:vm.order.orderRealAmnt,payType:productData.payType,orderCode:vm.orderCode,BkBrchNo:vm.branchCode},vm.order.effectiveTime=vm.order.policyList[0].effectiveTime,vm.order.effectiveTime&&(vm.order.effectiveTimeY=new Date(vm.order.effectiveTime).getFullYear(),vm.order.effectiveTimeM=new Date(vm.order.effectiveTime).getMonth()+1,vm.order.effectiveTimeD=new Date(vm.order.effectiveTime).getDate(),vm.order.effectiveTimeH=new Date(vm.order.effectiveTime),vm.order.effectiveTimeM<10&&(vm.order.effectiveTimeM="0"+vm.order.effectiveTimeM),vm.order.effectiveTimeD<10&&(vm.order.effectiveTimeD="0"+vm.order.effectiveTimeD),vm.order.effectiveDate=vm.order.effectiveTimeY+"-"+vm.order.effectiveTimeM+"-"+vm.order.effectiveTimeD,vm.order.effectiveTime=new Date(vm.order.effectiveTime).getHours()+":"+new Date(vm.order.effectiveTime).getMinutes()+":"+new Date(vm.order.effectiveTime).getSeconds()),PolicyService.setSessionData({productData:productData,policyData:policyData}),PolicyService.setSessionData({productData:{prelnsureFlag:vm.order.preInsureFlag,PbBeginDate:vm.order.effectiveDate,effectiveTime:vm.order.effectiveTime}})}var payReqData={orderCode:vm.orderCode,pbCertNo:sessionData.userData.cretNo,branchCode:policyData.BkBrchNo,payAmount:policyData.itemOrderRealPayAmt};CommonRequest.request(payReqData,CONFIG.CHECK_PAY_CHANNEL,function(result){if("1"==result.status)if("01"==result.data.prdPayPlatFormCode){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var payData={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:policyData.BkBrchNo,orderCode:policyData.orderCode,payAmount:policyData.itemOrderRealPayAmt,platForm:platForm,browserType:CONFIG.WECHAT?"01":"02",opendId:$rootScope.openid||"blank",channelCode:vm.order.policyList[0].channelCode?vm.order.policyList[0].channelCode:CONFIG.SALE_CHANNEL,paySign:result.data.paySign};CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE,function(result){if("1"==result.status){var data=result.data;if("000000"==data.payStatus){if("function"==typeof _yfx_sendorderid)try{console.info("录屏结束，发送结束请求，保单号："+policyData.PbApplNo+"，交易号："+policyData.orderCode),_yfx_sendorderid(policyData.PbApplNo,policyData.orderCode)}catch(e){console.log("finish trace error: "+e.message)}window.location.href=data.payRedirectUrl}}})}else"00"==result.data.prdPayPlatFormCode&&$state.go("product-pay")})})})},vm.deleteOrder=function(){if(vm.orderCode){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.DELETE_ORDER_SERVICE,function(result){1==result.status&&$state.go("my-order")})}},vm.cancelOrder=function(){if(vm.orderCode){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.CANCEL_ORDER_SERVICE,function(result){1==result.status&&$state.go("my-order")})}},vm.showProductDetail=function(){$state.go("product-detail",{id:vm.order.prdId})},vm.checkPolicyStatus=function(callback){var params={};CommonRequest.request(params,CONFIG.CHECK_POLICY_STATUS_SERVICE,function(result){angular.isFunction(callback)&&callback(result.data)})},void vm.checkPolicyStatus(function(){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.CHECK_POLICY_CONCLUSION_SERVICE,function(result){1==result.status&&result.data[0]&&(vm.conclusion=result.data[0].checkIdea)})})):void $state.go("my-order")}angular.module("app").controller("MyOrderDetailController",MyOrderDetailController),MyOrderDetailController.$inject=["$state","CommonRequest","CONFIG","PolicyService","$filter","$rootScope","$ionicModal"]}(),function(){function ePolicyEmailController($state,$rootScope,$location,CONFIG,PolicyService,TipService,CommonRequest,$ionicLoading){var vm=this;vm.email=$state.params.email||"",vm.policyNo=$state.params.policyNo||"",vm.keyMD5=$state.params.keyMD5||"",vm.next=function(){var params;params={policyNo:vm.policyNo,verToken:vm.keyMD5,emailPath:vm.email},CommonRequest.request(params,CONFIG.NEW_EPOLICY_SENDMAIL_YH,function(result){result&&(1==result.status&&TipService.showMsg("电子保单会在24小时内发送至您所填写的邮箱，请注意查收！"),$ionicLoading.hide(),$state.go("my-policy"))})}}angular.module("app").controller("ePolicyEmailController",ePolicyEmailController),ePolicyEmailController.$inject=["$state","$rootScope","$location","CONFIG","PolicyService","TipService","CommonRequest","$ionicLoading"]}(),function(){function EmailCheckController($state,$rootScope,$location,CONFIG,PolicyService,TipService,CommonRequest,$ionicLoading){var vm=this;vm.email=$state.params.email||"",vm.policyNo=$state.params.policyNo||"",vm.keyMD5=$state.params.keyMD5||"",vm.isGHMB=$state.params.isGHMB||!1,console.log(vm.isGHMB),vm.next=function(){var params;params=vm.isGHMB?{policyNo:vm.policyNo,keyMD5:vm.keyMD5,emailPath:vm.email,isGHMB:!0}:{policyNo:vm.policyNo,keyMD5:vm.keyMD5,emailPath:vm.email},CommonRequest.request(params,CONFIG.NEW_EPOLICY_SENDMAIL,function(result){result&&(1==result.status&&TipService.showMsg("电子保单会在24小时内发送至您所填写的邮箱，请注意查收！"),$ionicLoading.hide(),$state.go("my-policy"))})}}angular.module("app").controller("EmailCheckController",EmailCheckController),EmailCheckController.$inject=["$state","$rootScope","$location","CONFIG","PolicyService","TipService","CommonRequest","$ionicLoading"]}(),function(){function MyCardPolicyController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService){var vm=this;vm.cusId="",vm.plchdCardNo=$state.params.plchdCardNo;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.cusId=vm.userData.cusId,vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.getCardPolicy=function(){if(vm.refreshTipForShow)return void $rootScope.$broadcast("scroll.refreshComplete");var params={plchdCardNo:vm.plchdCardNo};CommonRequest.request(params,CONFIG.CARD_POLICY_LIST,function(result){if(1==result.status){var data=result.data;vm.cardPolicyList=[],data&&angular.isArray(data)||(data=[],TipService.showMsg("暂时没有查询到保单"),vm.refreshTip()),vm.cardPolicyList=data}$rootScope.$broadcast("scroll.refreshComplete")})},vm.refreshTip=function(){vm.refreshTime--,vm.refreshTime>0?(vm.refreshTipForShow=!0,$timeout(function(){vm.refreshTip()},1e3)):(vm.refreshTime=60,vm.refreshTipForShow=!1)},vm.showDetail=function(policyNo,totalMoney){$state.go("my-policy-detail",{policyNo:policyNo,totalMoney:totalMoney})},vm.getCardPolicy()}angular.module("app").controller("MyCardPolicyController",MyCardPolicyController),MyCardPolicyController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService"]}(),function(){function MyGroupPolicyDetailController($state,$stateParams,CONFIG,CommonRequest,$log,TipService,PolicyChangeService,$filter,$window,$rootScope,GroupPolicyService,$timeout,$ionicLoading,PolicyService,$ionicPopup){var vm=this;if(vm.dwAddress=CONFIG.ELEGROUP_POLICY_DOWNLOAD_SERVCIE.url,vm.policyNo=$state.params.policyNo,!vm.policyNo)return void $state.go("my-policy");var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.userData&&(vm.cusId=vm.userData.cusId,vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.getGroupPolicyDetailResultTimes=0,vm.getGroupPolicyDetailResult=function(){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getGroupPolicyDetailResultTimes++,vm.getGroupPolicyDetailResultTimes>CONFIG.GROUP_CORE_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.SYSTEM.TIMEOUT),void(vm.getGroupPolicyDetailResultTimes=0);var params={insPolicyNo:vm.policyNo};CommonRequest.request(params,CONFIG.GROUP_POLICY_GET_GROUP_POLICY_DETAIL_RESULT,function(result){if(1==result.status){var data=result.data||"";if(""==data)return void $timeout(function(){vm.getGroupPolicyDetailResult()},CONFIG.GROUP_CORE_DECOUPLING_DURATION);$ionicLoading.hide(),vm.policyDetail=data;for(var i=0;i<vm.policyDetail.riskInfoList.length;i++)vm.policyDetail.riskInfoList[i].riskPayDate&&"3000-01-01"==vm.policyDetail.riskInfoList[i].riskPayDate&&(vm.policyDetail.riskInfoList[i].riskPayDate="长期有效");vm.getGroupPolicyDetailResultTimes=0}else $ionicLoading.hide(),vm.getGroupPolicyDetailResultTimes=0},!0)},vm.myPolicyDetail=function(){var params={insPolicyNo:vm.policyNo,plchdCrdtNo:vm.userData?vm.userData.cretNo:"",plchdRcgnNm:vm.userData?vm.userData.customerName:""};vm.plchdAppFlag&&"Y"==vm.plchdAppFlag&&(params.plchdAppFlag=vm.plchdAppFlag),CommonRequest.request(params,CONFIG.GROUP_POLICY_GROUP_PRE_POLICY_DETAIL,function(result){if("1"==result.status){if(result.data&&""!=result.data)return vm.policyDetail=result.data,void(vm.policyDetail.insPayDate&&"3000-01-01"==vm.policyDetail.insPayDate&&(vm.policyDetail.insPayDate="长期有效"));vm.getGroupPolicyDetailResult()}})},vm.myPolicyDetail(),vm.benefitInfoDetail=function(){return vm.showEpolicyDownloadFlag?void $ionicPopup.alert({title:"温馨提示",template:"暂无支持下载的凭证类型",okText:"我知道了"}):vm.showEpolicyDownloadFlag1?(vm.idNo=$rootScope.userData.cretNo,vm.cusId=$rootScope.userData.cusId,vm.token=$rootScope.userData.token,void CommonRequest.request({},CONFIG.QUERY_NEWDOWN,function(result){if("Y"==result.data){var params={idNo:vm.idNo,contNo:vm.policyNo,token:vm.token,cusId:vm.cusId,downType:"E"};CommonRequest.request(params,CONFIG.E_POLICYDOWNLOAD,function(result){vm.isEmail=result.data.emailFlag,vm.keyMD5=result.data.verToken;
var params_n={verToken:result.data.verToken};PolicyService.NewDownloadDone(params_n,function(result){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("e-policy-email",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"new/epolicyPush?verToken="+vm.keyMD5+"&contNo="+vm.policyNo,$ionicLoading.hide()})})}else{var params_v={idNo:vm.idNo,token:vm.token,cusId:vm.cusId,policyNo:vm.policyNo,downType:"E"};GroupPolicyService.validateEPolicyDownload(params_v,function(result){var params_d={policyNo:vm.policyNo,keyMD5:result.keyMD5};vm.keyMD5=result.keyMD5,vm.isEmail=result.isEmail,vm.email=result.email,GroupPolicyService.isDownloadDone(params_d,function(){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5,isGHMB:!0};$state.go("email-check",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"pushEPolicy?keyMD5="+vm.keyMD5+"&policyNo="+vm.policyNo+"&idNo="+vm.idNo+"&downType=E&custId="+vm.cusId+"&token="+vm.token+"&channelCode="+CONFIG.SALE_CHANNEL})})}})):void $ionicPopup.alert({title:"温馨提示",template:"请登录官网下载被保险人凭证",okText:"我知道了"})},vm.changeState="0",vm.changeStatus=function(n){vm.changeState=n},vm.getGroupInfoFlagFn=function(){if(vm.showEpolicyDownloadFlag1=!0,$state.params.policyNo&&"R"==$state.params.policyNo.trim().substr(0,1)){var dateRes={idNo:$rootScope.userData.cretNo,ContNo:$state.params.policyNo};CommonRequest.request(dateRes,CONFIG.GETGROUPINfO_SERVCIE,function(res){1==res.status&&(vm.ContFlag=res.data.contFlag,vm.CertFlag=res.data.certFlag,"N"==vm.ContFlag&&"N"==vm.CertFlag?vm.showEpolicyDownloadFlag=!0:"N"==vm.ContFlag&&"Y"==vm.CertFlag&&(vm.showEpolicyDownloadFlag1=!1))})}},vm.getGroupInfoFlagFn()}angular.module("app").controller("MyGroupPolicyDetailController",MyGroupPolicyDetailController),MyGroupPolicyDetailController.$inject=["$state","$stateParams","CONFIG","CommonRequest","$log","TipService","PolicyChangeService","$filter","$window","$rootScope","GroupPolicyService","$timeout","$ionicLoading","PolicyService","$ionicPopup"]}(),function(){function MyPolicyDetailControllerNew($state,$stateParams,$ionicPopup,CONFIG,CommonRequest,$log,TipService,PolicyChangeService,$filter,$window,$rootScope,PolicyService,$timeout,$ionicLoading,$http){var vm=this;vm.exclusiveOpen=!1,vm.insuredOpen=!1,vm.asuredOpen=!1,vm.dwAddress=CONFIG.ELEGROUP_POLICY_DOWNLOAD_SERVCIE.url,vm.buttonFlag=!0,vm.checkEpolicyDownload=function(){var config={url:"../statics/json/download.json",method:"GET"};CommonRequest.request({},config,function(result){var data=result.downloadSwitch;"Y"==data?vm.buttonFlag=!0:vm.buttonFlag=!1})},vm.checkEpolicyDownload(),vm.exclusiveClick=function(){vm.exclusiveOpen=!vm.exclusiveOpen},vm.insuredClick=function(){vm.insuredOpen=!vm.insuredOpen},vm.asuredClick=function(){vm.asuredOpen=!vm.asuredOpen},vm.contNo=$state.params.contNo,vm.sysType=$state.params.sysType,vm.relation=$state.params.relation,vm.isGroup=$state.params.isGroup,vm.policyDetail={},vm.truedutyList=[],vm.falsedutyList=[],vm.seeFalg=!1,vm.resultData=[],vm.accountInfo=[],vm.falseOpen=[],vm.dutyOpen=[],vm.accountOpen=[],vm.see=!1,vm.isGroup=!1,vm.changeFalg=function(){var truelist=[],falseList=[];if(vm.dutyOpen=[],vm.resultData.length)for(var i in vm.resultData)if(vm.see){var _index=truelist.indexOf(vm.resultData[i].polNo),index2=falseList.indexOf(vm.resultData[i].polNo);1==vm.resultData[i].stateFlag?_index>-1?(vm.truedutyList[_index].push(vm.resultData[i]),vm.dutyOpen.push(!1)):(truelist.push(vm.resultData[i].polNo),vm.truedutyList.push([vm.resultData[i]])):index2>-1?(vm.falsedutyList[index2].push(vm.resultData[i]),vm.falseOpen.push(!1)):(falseList.push(vm.resultData[i].polNo),vm.falsedutyList.push([vm.resultData[i]]))}else{var index=truelist.indexOf(vm.resultData[i].polNo);1==vm.resultData[i].stateFlag&&(index>-1?(vm.truedutyList[index].push(vm.resultData[i]),vm.dutyOpen.push(!1)):(truelist.push(vm.resultData[i].polNo),vm.truedutyList.push([vm.resultData[i]])))}},vm.changesee=function(){vm.see=!vm.see,vm.truedutyList=[],vm.falsedutyList=[],vm.changeFalg()},vm.goBack=function(){window.location.href=CONFIG.DOMAIN+"/clife-stuff-app/#/converge/home?login_params="+sessionStorage.getItem("login_params")},vm.getDetail=function(){var params={contNo:vm.contNo,sysType:vm.sysType};CommonRequest.request(params,CONFIG.GET_POLICY_DETAIL,function(result){1==result.status&&(vm.policyDetail=result.data,"2"==vm.sysType&&"0"==result.data.grpFlag&&(vm.isGroup=!0))}),CommonRequest.request(params,CONFIG.GET_POLICY_DUTYLIST,function(result){1==result.status&&(vm.resultData=result.data,vm.seeFalg=0==result.data.filter(function(v){return 0==v.stateFlag}).length,vm.changeFalg())}),CommonRequest.request(params,CONFIG.GET_ACCOUNT_INFO,function(result){if(1==result.status){var data=result.data;vm.accountInfo=result.data;for(var i in data)vm.accountOpen.push(!1)}})},vm.getDetail(),vm.dutyClick=function(index){vm.dutyOpen[index]=!vm.dutyOpen[index]},vm.falseClick=function(index){vm.falseOpen[index]=!vm.falseOpen[index]},vm.accountClick=function(index){vm.accountOpen[index]=!vm.accountOpen[index]},vm.isGuarantee=function(boolean){return"1"==boolean?"policy-detail-guarantee":"policy-detail-expired"},vm.toMall=function(){$state.go("tab.mall",{})},vm.dateReplace=function(str){return"string"==typeof str&&(str=str.replace(/-/g,".")),str},vm.dateFormate=function(date){var arr=date.split(".");for(var i in arr)arr[i]=arr[i]-0;return arr[0]+"年"+arr[1]+"月"+arr[2]+"日"},vm.dateFormateShort=function(date){if("string"==typeof date){var arr=date.split("-");for(var i in arr)arr[i]=arr[i]-0;return arr[1]+"月"+arr[2]+"日"}},vm.guaranteePeriod=function(start,end){if("string"==typeof start&&"string"==typeof end){var startYear=start.split("-")[0],endYear=end.split("-")[0],gap=endYear-startYear;return gap>=100?"终身":vm.dateReplace(start)+" - "+vm.dateReplace(end)}},vm.buttonFlag=!0,vm.checkEpolicyDownload=function(){var config={url:"../statics/json/download.json",method:"GET"};CommonRequest.request({},config,function(result){var data=result.downloadSwitch;"Y"==data?vm.buttonFlag=!0:vm.buttonFlag=!1})},vm.checkEpolicyDownload();var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.policyNo=$state.params.contNo,vm.totalMoney=$state.params.totalMoney;var birthday=vm.userData.birthday,reg=new RegExp("-","g");return vm.birthday=birthday.replace(reg,""),vm.sex=vm.userData.sex,vm.sceneType="20",vm.customerName=vm.userData.customerName,vm.cretNo=vm.userData.cretNo,vm.cretType=vm.userData.cretType,"A"==vm.cretType?vm.cretType="0":"I"==vm.cretType?vm.cretType="1":"G"==vm.cretType?vm.cretType="9":"N"==vm.cretType&&(vm.cretType="3"),vm.userData&&(console.log("1",vm.userData),vm.plchdAppFlag=vm.userData.plchdAppFlag,console.log("2",vm.plchdAppFlag),"Y"==vm.plchdAppFlag&&($rootScope.userData=vm.userData,console.log("3",$rootScope.userData))),vm.contNo||"Y"==vm.userData.plchdAppFlag?(vm.invoiceDownload=function(callback){var params={birthday:vm.birthday,sex:vm.sex,sceneType:vm.sceneType,customerName:vm.customerName,cerId:vm.cretNo,cerType:vm.cretType,type:"01",policyNo:vm.policyNo};PolicyService.invoiceSubmit(params,function(){PolicyService.setSessionData({userData:{policyNo:vm.policyNo,sceneType:vm.sceneType}})})},vm.productConfig=function(){var params={prdCode:vm.riskCode,planType:vm.planType};CommonRequest.request(params,CONFIG.PRODUCT_CONFIG_SERVCIE,function(result){if(1==result.status){if(1==result.data.isChangeAbandoninvest&&(vm.isChangeAbandoninvest=!0),1==result.data.isChangeBonuschoose){vm.isChangeBonuschoose=!0;var params={policyNo:vm.policyNo};PolicyChangeService.benefitAccountDetail(params,function(data){vm.benefitAccount=data})}1==result.data.isChangeCard&&(vm.isChangeCard=!0),1==result.data.isChangeContact&&(vm.isChangeContact=!0),1==result.data.isChangeDisagree&&(vm.isChangeDisagree=!0),1==result.data.isChangeExpiredPay&&(vm.isChangeExpiredPay=!0),1==result.data.isChangeInvestaccount&&(vm.isChangeInvestaccount=!0),1==result.data.isChangeInvestbalance&&(vm.isChangeInvestbalance=!0),1==result.data.isChangeOnlineCert&&(vm.isChangeOnlineCert=!0),1==result.data.isChangeOnlineLoan&&(vm.isChangeOnlineLoan=!0),1==result.data.isChangeTimeadd&&(vm.isChangeTimeadd=!0),1==result.data.isChangeWarrant&&(vm.isChangeWarrant=!0)}})},vm.benefitInfoDetail=function(){vm.idNo=$rootScope.userData.cretNo,vm.cusId=$rootScope.userData.cusId,vm.token=$rootScope.userData.token;var params_v={idNo:vm.idNo,token:vm.token,cusId:vm.cusId,policyNo:vm.policyNo,downType:"E"};PolicyService.validateEPolicyDownload(params_v,function(result){var params_d={policyNo:vm.policyNo,keyMD5:result.keyMD5};vm.keyMD5=result.keyMD5,vm.isEmail=result.isEmail,vm.email=result.email,PolicyService.isDownloadDone(params_d,function(){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("email-check",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"pushEPolicy?keyMD5="+vm.keyMD5+"&policyNo="+vm.policyNo+"&idNo="+vm.idNo+"&downType=E&custId="+vm.cusId+"&token="+vm.token+"&channelCode="+CONFIG.SALE_CHANNEL})})},vm.ePolicyDownload=function(){return vm.showEpolicyDownloadFlag?void $ionicPopup.alert({title:"温馨提示",template:"暂无支持下载的凭证类型",okText:"我知道了"}):vm.showEpolicyDownloadFlag1?($state.params.grpcontno&&(vm.policyNo=$state.params.grpcontno),vm.idNo=$rootScope.userData.cretNo,void CommonRequest.request({},CONFIG.QUERY_NEWDOWN,function(result){if("Y"==result.data){var params={idNo:vm.idNo,contNo:vm.policyNo};CommonRequest.request(params,CONFIG.E_POLICYDOWNLOAD,function(result){vm.isEmail=result.data.emailFlag,vm.keyMD5=result.data.verToken;var params_n={verToken:result.data.verToken};PolicyService.NewDownloadDone(params_n,function(result){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("e-policy-email",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"new/epolicyPush?verToken="+vm.keyMD5+"&contNo="+vm.policyNo,$ionicLoading.hide()})})}else{var params_v={idNum:vm.idNo,policyNo:vm.policyNo};PolicyService.validateEPolicyDownload_yh(params_v,function(result){console.log(result);var params_d={verToken:result.verToken};vm.keyMD5=result.verToken,vm.emailFlag=result.emailFlag,PolicyService.isDownloadDone_yh(params_d,function(result){if(vm.email=result.emailPath,"Y"==vm.emailFlag){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("e-policy-email",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.FILE_SERVICE_ADDRESS+"new/downloadPolicy?verToken="+vm.keyMD5+"&policyNo="+vm.policyNo})})}})):void $ionicPopup.alert({title:"温馨提示",template:"请登录官网下载被保险人凭证",okText:"我知道了"})},vm.getGroupInfoFlagFn=function(){if(vm.showEpolicyDownloadFlag1=!0,$state.params.grpcontno&&"R"==$state.params.grpcontno.trim().substr(0,1)){var dateRes={idNo:$rootScope.userData.cretNo,ContNo:$state.params.grpcontno};CommonRequest.request(dateRes,CONFIG.GETGROUPINfO_SERVCIE,function(res){1==res.status&&(vm.ContFlag=res.data.contFlag,vm.CertFlag=res.data.certFlag,"N"==vm.ContFlag&&"N"==vm.CertFlag?vm.showEpolicyDownloadFlag=!0:"N"==vm.ContFlag&&"Y"==vm.CertFlag&&(vm.showEpolicyDownloadFlag1=!1))})}},void vm.getGroupInfoFlagFn()):void $state.go("my-policy-new")}angular.module("app").controller("MyPolicyDetailControllerNew",MyPolicyDetailControllerNew),MyPolicyDetailControllerNew.$inject=["$state","$stateParams","$ionicPopup","CONFIG","CommonRequest","$log","TipService","PolicyChangeService","$filter","$window","$rootScope","PolicyService","$timeout","$ionicLoading","$http"]}(),function(){function MyPolicyDetailController($state,$stateParams,CONFIG,CommonRequest,$log,TipService,PolicyChangeService,$filter,$window,$rootScope,PolicyService,$timeout,$ionicLoading,$http){var vm=this;vm.buttonFlag=!0,vm.checkEpolicyDownload=function(){var config={url:"../statics/json/download.json",method:"GET"};CommonRequest.request({},config,function(result){var data=result.downloadSwitch;"Y"==data?vm.buttonFlag=!0:vm.buttonFlag=!1})},vm.checkEpolicyDownload();var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.policyNo=$state.params.policyNo,vm.totalMoney=$state.params.totalMoney,vm.showAssociated=$state.params.mainClassCode?"BULX"===$state.params.mainClassCode.slice(0,-2):!1;var birthday=vm.userData.birthday,reg=new RegExp("-","g");return vm.birthday=birthday.replace(reg,""),vm.sex=vm.userData.sex,vm.sceneType="20",vm.customerName=vm.userData.customerName,vm.cretNo=vm.userData.cretNo,vm.cretType=vm.userData.cretType,"A"==vm.cretType?vm.cretType="0":"I"==vm.cretType?vm.cretType="1":"G"==vm.cretType?vm.cretType="9":"N"==vm.cretType&&(vm.cretType="3"),vm.policyNo?(vm.userData&&(vm.plchdAppFlag=vm.userData.plchdAppFlag),vm.contentText=vm.contentText2="点击展开",CommonRequest.request({policyNo:vm.policyNo},CONFIG.ALLOWED_STATUS_SERVICE,function(result){return"0"==result.data.allowed?void $state.go("my-policy"):(vm.getBenefitList(),void vm.myPolicyDetail())}),vm.invoiceDownload=function(callback){var params={birthday:vm.birthday,sex:vm.sex,sceneType:vm.sceneType,customerName:vm.customerName,cerId:vm.cretNo,cerType:vm.cretType,type:"01",policyNo:vm.policyNo};PolicyService.invoiceSubmit(params,function(){PolicyService.setSessionData({userData:{policyNo:vm.policyNo,sceneType:vm.sceneType}})})},vm.productConfig=function(){var params={prdCode:vm.riskCode,planType:vm.planType};CommonRequest.request(params,CONFIG.PRODUCT_CONFIG_SERVCIE,function(result){if(1==result.status){if(vm.isChangeBonuschooseLi=!1,1==result.data.isChangeAbandoninvest&&(vm.isChangeAbandoninvest=!0),1==result.data.isChangeBonuschoose){vm.isChangeBonuschoose=!0;var params={policyNo:vm.policyNo};PolicyChangeService.benefitAccountDetail(params,function(data){vm.benefitAccount=data,vm.benefitAccount&&0!=vm.benefitAccount.length&&""!=vm.benefitAccount&&void 0!=vm.benefitAccount?vm.isChangeBonuschooseLi=!0:vm.isChangeBonuschooseLi=!1})}1==result.data.isChangeCard&&(vm.isChangeCard=!0),1==result.data.isChangeContact&&(vm.isChangeContact=!0),1==result.data.isChangeDisagree&&(vm.isChangeDisagree=!0),1==result.data.isChangeExpiredPay&&(vm.isChangeExpiredPay=!0),1==result.data.isChangeInvestaccount&&(vm.isChangeInvestaccount=!0),1==result.data.isChangeInvestbalance&&(vm.isChangeInvestbalance=!0),1==result.data.isChangeOnlineCert&&(vm.isChangeOnlineCert=!0),1==result.data.isChangeOnlineLoan&&(vm.isChangeOnlineLoan=!0),1==result.data.isChangeTimeadd&&(vm.isChangeTimeadd=!0),1==result.data.isChangeWarrant&&(vm.isChangeWarrant=!0)}})},vm.getBenefitList=function(){var params={policyNo:vm.policyNo};CommonRequest.request(params,CONFIG.BENEFIT_CUSLIST_MASK_SERVCIE,function(result){1==result.status&&(vm.benefitList=result.data)})},vm.benefitInfoDetail=function(){vm.idNo=$rootScope.userData.cretNo,vm.cusId=$rootScope.userData.cusId,vm.token=$rootScope.userData.token;var params_v={idNo:vm.idNo,token:vm.token,cusId:vm.cusId,policyNo:vm.policyNo,downType:"E"};PolicyService.validateEPolicyDownload(params_v,function(result){var params_d={policyNo:vm.policyNo,keyMD5:result.keyMD5};vm.keyMD5=result.keyMD5,vm.isEmail=result.isEmail,vm.email=result.email,PolicyService.isDownloadDone(params_d,function(){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("email-check",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"pushEPolicy?keyMD5="+vm.keyMD5+"&policyNo="+vm.policyNo+"&idNo="+vm.idNo+"&downType=E&custId="+vm.cusId+"&token="+vm.token+"&channelCode="+CONFIG.SALE_CHANNEL})})},vm.ePolicyDownload=function(){vm.idNo=$rootScope.userData.cretNo,CommonRequest.request({},CONFIG.QUERY_NEWDOWN,function(result){if("Y"==result.data){var params={idNo:vm.idNo,contNo:vm.policyNo};CommonRequest.request(params,CONFIG.E_POLICYDOWNLOAD,function(result){vm.isEmail=result.data.emailFlag,vm.keyMD5=result.data.verToken;var params_n={verToken:result.data.verToken};PolicyService.NewDownloadDone(params_n,function(result){if("Y"==vm.isEmail){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("e-policy-email",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.SERVICE_ADDRESS+"new/epolicyPush?verToken="+vm.keyMD5+"&contNo="+vm.policyNo,$ionicLoading.hide()})})}else{var params_v={idNum:vm.idNo,policyNo:vm.policyNo};PolicyService.validateEPolicyDownload_yh(params_v,function(result){console.log(result);var params_d={verToken:result.verToken};vm.keyMD5=result.verToken,vm.emailFlag=result.emailFlag,PolicyService.isDownloadDone_yh(params_d,function(result){if(vm.email=result.emailPath,"Y"==vm.emailFlag){var emailparams={policyNo:vm.policyNo,email:vm.email,keyMD5:vm.keyMD5};$state.go("e-policy-email",emailparams),$ionicLoading.hide()}else $window.location.href=CONFIG.FILE_SERVICE_ADDRESS+"new/downloadPolicy?verToken="+vm.keyMD5+"&policyNo="+vm.policyNo})})}})},vm.myPolicyDetail=function(){var params={policyNo:vm.policyNo};PolicyChangeService.showDetail(params,function(data){if(vm.policyDetail=data,vm.riskCode=data.mainClassCode,vm.planType=data.planType,""==vm.policyDetail.effectTime||void 0==vm.policyDetail.effectTime?vm.policyDetail.effectDateHour="24时":(vm.startHour=vm.policyDetail.effectTime.substring(0,2),vm.policyDetail.effectDateHour=vm.startHour+"时"),""==vm.policyDetail.endTime||void 0==vm.policyDetail.endTime?vm.policyDetail.endDateHour="24时":(vm.endHour=vm.policyDetail.endTime.substring(0,2),vm.policyDetail.endDateHour=vm.endHour+"时"),vm.riskCode){({policyNo:vm.policyNo,riskCode:vm.riskCode});vm.productConfig()}}),PolicyChangeService.benefitDetail(params,function(data){vm.benefitDetailInfo=data,vm.benefitDetailInfo&&0!=vm.benefitDetailInfo.length&&""!=vm.benefitDetailInfo&&void 0!=vm.benefitDetailInfo?vm.benefitDetailInfoLi=!0:vm.benefitDetailInfoLi=!1}),PolicyChangeService.riskDetail(params,function(data){vm.riskDe=data}),PolicyChangeService.policyCustomerDetail(params,function(data){vm.custmerInfo=data});var payInfo={policyNo:vm.policyNo};PolicyChangeService.payDetail(payInfo,function(data){if(vm.payDetailInfo=data,!$state.params.totalMoney)for(var i=0;i<vm.payDetailInfo.length;i++)vm.totalMoney=vm.totalMoney+parseFloat(vm.payDetailInfo[i].chargeAmout)}),PolicyChangeService.payRecord(params,function(data){vm.payRecordDetail=data})},vm.getPolicyBusinessDetail=function(){var params={policyNo:vm.policyNo};PolicyChangeService.policyBusinessCustomerDetail(params,function(data){vm.business=data})},vm.getMulRisk=function(){if(vm.riskCode){var params={policyNo:vm.policyNo,riskCode:vm.riskCode};PolicyChangeService.mulRiskQuery(params,function(data){vm.mulRisk=data,vm.mulRisk&&0!=vm.mulRisk.length&&""!=vm.mulRisk&&void 0!=vm.mulRisk?vm.mulRiskLi=!0:vm.mulRiskLi=!1,0==vm.mulRiskLi&&0==vm.benefitDetailInfoLi&&0==vm.isChangeBonuschooseLi?vm.mubeisImg=!0:vm.mubeisImg=!1})}},vm.getAssociatedPolicy=function(){var params={contNo:vm.policyNo};CommonRequest.request(params,CONFIG.ASSOCIATED_POLICY,function(result){1==result.status&&(vm.policyAssociatedDetail=result.data)})},vm.showProductDetail=function(id){$state.go("product-detail",{id:id})},vm.changeState="0",vm.changeStatus=function(n){vm.changeState=n,"1"==n&&vm.getMulRisk(),"2"==n&&vm.getPolicyBusinessDetail(),"3"==n&&vm.getAssociatedPolicy()},vm.contentDiv=function(){vm.contentShow=!vm.contentShow,vm.contentShow?vm.contentText="点击收起":vm.contentText="点击展开"},void(vm.contentDiv2=function(){vm.contentShow2=!vm.contentShow2,vm.contentShow2?vm.contentText2="点击收起":vm.contentText2="点击展开"})):void $state.go("my-policy")}angular.module("app").controller("MyPolicyDetailController",MyPolicyDetailController),MyPolicyDetailController.$inject=["$state","$stateParams","CONFIG","CommonRequest","$log","TipService","PolicyChangeService","$filter","$window","$rootScope","PolicyService","$timeout","$ionicLoading","$http"]}(),function(){function NetWorkAreaProController($state,$rootScope,CommonRequest,CONFIG){var vm=this;vm.getList=function(){vm.aid="1",vm.pid="1",CommonRequest.request({},CONFIG.NETWORK_AREA_PRO,function(result){1==result.status&&(vm.list=result.data,vm.list.forEach(function(item){item.area_id==vm.aid&&(vm.pros=item.province)})),$rootScope.$broadcast("scroll.refreshComplete")})},vm.getList(),vm.changePro=function(id){for(var list=vm.list,i=0;i<list.length;i++)list[i].area_id==id&&(vm.pros=list[i].province)},vm.showNetWork=function(aid,pid){$state.go("network-city-bank",{aid:aid,pid:pid})}}angular.module("app").controller("NetWorkAreaProController",NetWorkAreaProController),NetWorkAreaProController.$inject=["$state","$rootScope","CommonRequest","CONFIG"]}(),function(){function NetWorkProBankController($state,$rootScope,CommonRequest,CONFIG,$ionicHistory){var vm=this;vm.getList=function(){CommonRequest.request({},CONFIG.NETWORK_PRO_BANK,function(result){1==result.status&&(vm.list=result.data);for(var list=vm.list,i=0;i<list.length;i++)list[i].area_id==$state.params.aid&&list[i].pro_id==$state.params.pid&&(vm.bankList=list[i].bank);$rootScope.$broadcast("scroll.refreshComplete")}),CommonRequest.request({},CONFIG.NETWORK_AREA_PRO,function(result){1==result.status&&(vm.areaList=result.data,vm.areaList.forEach(function(item){item.area_id==$state.params.aid&&(vm.proList=item.province,vm.currentPro=vm.proList[$state.params.pid-1].pro_name)})),vm.pid=$state.params.pid,$rootScope.$broadcast("scroll.refreshComplete")})},vm.getList(),vm.back=function(){$ionicHistory.goBack()}}angular.module("app").controller("NetWorkProBankController",NetWorkProBankController),NetWorkProBankController.$inject=["$state","$rootScope","CommonRequest","CONFIG","$ionicHistory"]}();