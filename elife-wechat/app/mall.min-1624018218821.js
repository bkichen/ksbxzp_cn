"use strict";function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};!function(){function PolicyCompleteWxController(CommonRequest,CONFIG,TipService,$rootScope,PolicyService,$state,$location){var vm=this,sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData,vm.splitPolicyNo=JSON.stringify($location.search().p),vm.submit=function(){var paramBase={p:vm.splitPolicyNo.replace(/\"/g,"")};CommonRequest.request(paramBase,CONFIG.TAX_GROUP_SIGNFOR,function(result){"1"==result.status})},vm.submit()}angular.module("app").controller("PolicyCompleteWxController",PolicyCompleteWxController),PolicyCompleteWxController.$inject=["CommonRequest","CONFIG","TipService","$rootScope","PolicyService","$state","$location"]}(),function(){function MallController($scope,CommonRequest,$rootScope,CONFIG,$timeout,$state,$window,PolicyService,$compile,$http){var vm=this;vm.newDate=(new Date).getTime(),vm.prdSubscribe=[],$http({url:CONFIG.DOMAIN+"/statics/json/bdSwitch.json?time="+new Date,method:"GET"}).success(function(res){for(var i=0;i<res.data.length;i++)if(CONFIG.SALE_CHANNEL==res.data[i].channelCode&&"Y"==res.data[i].bdSwitch){var html='<script type="text/javascript" src="https://api.map.baidu.com/api?v=2.0&ak=lfkQsHgKXS8hkCZvHs3TCeqwK5Ca4GBQ"></script>',$html=$compile(html)($scope);$("head").prepend($html);var h='<script>var _hmt = _hmt || [];(function() {var hm = document.createElement("script");hm.src = "https://hm.baidu.com/hm.js?ed15f21fc8935ff1d4bdec79c5de2b33";var s = document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm, s);})();</script>',$html=$compile(h)($scope);return void $("head").prepend($html)}}).error(function(res){console.info(res)});var sessionPicuterData=sessionStorage.getItem("elife-overPicuter")||{};sessionPicuterData?"[object Object]"===Object.prototype.toString.call(sessionPicuterData)?vm.picuter={}:vm.picuter=JSON.parse(sessionPicuterData).picuter:vm.picuter={},vm.getKgBTn=function(){CommonRequest.request({},CONFIG.GET_THREE_PICUTER,function(result){if(1==result.status&&($rootScope.nowStatus=result.data,1==$rootScope.nowStatus?($rootScope.nowStatus=1,vm.nowStatus=1):(vm.nowStatus=0,vm.speProductList(),vm.hotSaleProductList()),window.sessionStorage.setItem("elife_nowStatus",$rootScope.nowStatus),1==vm.nowStatus)){var times=0;vm.getPicuter=function(){times++,CommonRequest.request({},CONFIG.GET_OVER_PICUTER,function(result){1==result.status?(PolicyService.setSessionData({overPicuter:{picuter:result.data}}),vm.picuter=result.data,vm.speProductList(),vm.hotSaleProductList()):6>times&&vm.getPicuter()})},vm.getPicuter()}})},vm.getAD=function(){var params={channel:CONFIG.SALE_CHANNEL,position:"4",isUsed:"1",publishStatus:"1"};CommonRequest.request(params,CONFIG.GET_AD_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.length>=1){vm.slides=data;for(var i=vm.slides.length-1;i>=0;i--)vm.slides[i].path=CONFIG.IMAGE_SERVICE_ADDRESS+vm.slides[i].path}}})},vm.hotSaleProductList=function(callback){vm.hotSaleProList=[],CommonRequest.request({},CONFIG.HOT_PRODUCT_LIST_SERVCIE,function(result){if(1==result.status){var data=result.data;if(data&&data.length>0)for(var i=0;3>i;i++)vm.hotSaleProList.push(data[i])}3==vm.hotSaleProList.length&&vm.hotSaleProList.forEach(function(item1,index){if(1==$rootScope.nowStatus&&"[object Array]"===Object.prototype.toString.call(vm.picuter)&&vm.picuter[0]){vm.picuter.map(function(item2,index){if(item1.prd_code==item2.prdCode)for(var i=0;i<item2.picInfo.length;i++)"1"==item2.picInfo[i].picLocation?item1.onePicuter=item2.picInfo[i].prdPic:"2"==item2.picInfo[i].picLocation?item1.twoPicuter=item2.picInfo[i].prdPic:"3"==item2.picInfo[i].picLocation&&(item1.threePicuter=item2.picInfo[i].prdPic)})}}),angular.isFunction(callback)&&callback()},!0)},vm.speProductList=function(callback){vm.speProList=[],CommonRequest.request({},CONFIG.SPE_PRODUCT_LIST_SERVCIE,function(result){if(1==result.status){for(var data=result.data,i=0;i<data.length;i++)if(data[i].prdSubscribe){var preEndDate=new Date(data[i].prdSubscribe[0].preEndDate),preEndDateY=preEndDate.getFullYear(),preEndDateM=preEndDate.getMonth()+1,preEndDateD=preEndDate.getDate();10>preEndDateM&&(preEndDateM=0+preEndDateM),10>preEndDateD&&(preEndDateD=0+preEndDateD),preEndDate=preEndDateY+"-"+preEndDateM+"-"+preEndDateD+" 23:59:59",preEndDate=new Date(preEndDate).getTime(),preEndDate>vm.newDate&&vm.newDate>data[i].prdSubscribe[0].preStartDate?data[i].bespakFlay=!0:data[i].bespakFlay=!1}if(data&&data.length>0)if(1==$rootScope.nowStatus){for(var l_length=data.length>4?4:data.length,i=0;l_length>i;i++)vm.speProList.push(data[i]);if(vm.speProList.length>0){var speGetPic=function(){vm.speProList.forEach(function(item1,index){if(1==$rootScope.nowStatus&&"[object Array]"===Object.prototype.toString.call(vm.picuter)){vm.picuter.map(function(item2,index){if(item1.prd_code==item2.prdCode)for(var i=0;i<item2.picInfo.length;i++)"1"==item2.picInfo[i].picLocation?item1.onePicuter=item2.picInfo[i].prdPic:"2"==item2.picInfo[i].picLocation?item1.twoPicuter=item2.picInfo[i].prdPic:"3"==item2.picInfo[i].picLocation&&(item1.threePicuter=item2.picInfo[i].prdPic)})}})};speGetPic()}}else for(var i=0;3>i;i++)vm.speProList.push(data[i])}angular.isFunction(callback)&&callback()},!0)},vm.jumpPrdDetail=function(id,isMarketingStatus,PA001,prdCode,P021){return"Y"==PA001?void $state.go("product-purchase-policy-activity",{id:id}):"HMRA"==prdCode?void $state.go("product-lays",{id:id}):"GHMB"==prdCode&&"Y"==P021?void $state.go("product-optimze",{id:id}):void("HMRCa"==prdCode?$state.go("product-hmrc-calculate",{id:id}):$state.go("product-detail",{id:id}))},vm.perExpertSwitch=function(){CommonRequest.request({},CONFIG.PER_EXPERTS_SWITCH,function(result){1==result.status&&("Y"==result.data?vm.perSwitch=!0:vm.perSwitch=!1)})},vm.perExpertSwitch(),vm.loadingPage=function(){$timeout(function(){$rootScope.loadingPage?vm.getKgBTn():vm.loadingPage()},100)},vm.loadingPage(),vm.refresh=function(){vm.hotSaleProductList(function(){vm.speProductList(function(){$rootScope.$broadcast("scroll.refreshComplete")})})}}angular.module("app").controller("MallController",MallController),MallController.$inject=["$scope","CommonRequest","$rootScope","CONFIG","$timeout","$state","$window","PolicyService","$compile","$http"]}(),function(){function AutoBindControllerNew($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,VALIDATION,$timeout){$scope.phone="",$scope.phoneCode="",$scope.txCode="CCBSB109";var rootScope=$rootScope,sessionData=PolicyService.getSessionData();$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},sessionData.policyData&&($scope.policyData=sessionData.policyData,$scope.phone=$scope.policyData.PbHoldMobl,$scope.showDrag=!0,$scope.getdragimg()),$scope.cancel=function(){PolicyService.control({state:"product-purchase-confirm",control:"process"}),COMMON.hideModal()},$scope.phoneAlert=function(val){1==val.invalid&&($scope.phoneAlertshow=!0,$timeout(function(){$scope.phoneAlertshow=!1},1500))},$scope.hide=function(){$scope.phoneAlertshow=!1},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.submit=function(){var phone=this.phone,phoneCode=this.phoneCode;if(phone&&phoneCode){var params={CusThirtyModel:{thirtyCode:$rootScope.openid},customerName:$scope.policyData.PbHoldName,sex:$scope.policyData.PbHoldSex,bronToString:VALIDATION.dateFormat($scope.policyData.PbHoldBirdy),cretNo:$scope.policyData.PbHoldId,cretType:$scope.policyData.PbHoldIdType,CCBSBCODE:"CCBSB109",PhoneNo:phone,PhoneIdCode:phoneCode};CommonRequest.request(params,CONFIG.WECHAT_BIND_SERVCIE,function(result){1==result.status&&($rootScope.isBinding=!0,$scope.cancel())})}}}angular.module("app").controller("AutoBindControllerNew",AutoBindControllerNew),AutoBindControllerNew.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","VALIDATION","$timeout"]}(),function(){function AutoBindController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,VALIDATION,$timeout){$scope.phone="",$scope.phoneCode="",$scope.txCode="CCBSB109";var rootScope=$rootScope,sessionData=PolicyService.getSessionData();$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},sessionData.policyData&&($scope.policyData=sessionData.policyData,$scope.phone=$scope.policyData.PbHoldMobl,$scope.showDrag=!0,$scope.getdragimg()),$scope.cancel=function(){COMMON.hideModal()},$scope.phoneAlert=function(val){1==val.invalid&&($scope.phoneAlertshow=!0,$timeout(function(){$scope.phoneAlertshow=!1},1500))},$scope.hide=function(){$scope.phoneAlertshow=!1},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.submit=function(){var phone=this.phone,phoneCode=this.phoneCode;if(phone&&phoneCode){var params={CusThirtyModel:{thirtyCode:$rootScope.openid},customerName:$scope.policyData.PbHoldName,sex:$scope.policyData.PbHoldSex,bronToString:VALIDATION.dateFormat($scope.policyData.PbHoldBirdy),cretNo:$scope.policyData.PbHoldId,cretType:$scope.policyData.PbHoldIdType,CCBSBCODE:"CCBSB109",PhoneNo:phone,PhoneIdCode:phoneCode};CommonRequest.request(params,CONFIG.WECHAT_BIND_SERVCIE,function(result){1==result.status&&($rootScope.isBinding=!0,$scope.cancel())})}}}angular.module("app").controller("AutoBindController",AutoBindController),AutoBindController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","VALIDATION","$timeout"]}(),function(){function FaceDetectModalController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,TipService,$ionicLoading,LoginService){var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||"",vm.userData=sessionData.userData||"",$rootScope.isFromBind?(vm.certNo=$rootScope.bindParams.cretNo,vm.custName=$rootScope.bindParams.customerName,vm.certType=$rootScope.bindParams.cretType):(vm.certNo=vm.userData.cretNo,vm.custName=vm.userData.customerName,vm.certType=vm.userData.cretType),vm.getQrcode=function(){$scope.miniProgramImg=CONFIG.PAY_SERVICE_ADDRESS+"getSmallProgQrCode?certNo="+vm.certNo+"&custName="+vm.custName+"&certType="+vm.certType+"&width=280"},vm.getQrcode(),$scope.goback=function(){COMMON.hideModal(),$rootScope.isFromBind?COMMON.showModal("app/module/user/cert-bind/cert-bind.html"):COMMON.showModal("app/module/mall/product/identity-modal/identity-modal.html")},$scope.goAuth=function(){CommonRequest.request({certNo:vm.certNo},CONFIG.GET_FACE_STATUS_BY_CERTNO,function(result){if(1==result.status)if(1==result.data.status)if($rootScope.isFromBind)CommonRequest.request($rootScope.bindParams,CONFIG.WECHAT_BIND_SERVCIE,function(result){if(1==result.status){if($rootScope.isBinded=!0,$ionicLoading.show({template:$rootScope.TIPS.USER.BIND.BIND_SUCCESS,duration:2e3}),$rootScope.$broadcast("bind-result",{result:!0}),LoginService.loginByWechat($rootScope.openid),$rootScope.ydbq){var url="";return url="http://www.yuqi56.cn/ng166"==CONFIG.DOMAIN?"http://www.yuqi56.cn/sit1/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&openid="+$rootScope.openid:CONFIG.DOMAIN+"/elife-mep-ydbq/?"+$rootScope.ydbqshortLink+"&openid="+$rootScope.openid,console.info(url),$rootScope.ydbq=!1,void(window.location.href=url)}if(-1!=fromYXJK.indexOf("uriYXJK")&&-1!=fromYXJK.indexOf("appidYXJK"))return void(window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+objYXJK.appidYXJK+"&redirect_uri="+encodeURIComponent(decodeURIComponent(objYXJK.uriYXJK)+"?channelCode="+objYXJK.channelCode)+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect")}});else if("Y"==vm.productData.prelnsureFlag)$state.go("product-bespeak");else if("Y"==vm.productData.creditCard){var params=vm.productData.paramsArgument;PolicyService.doCalc(params,function(){}),$state.go("product-purchase-policy-info")}else"Y"==vm.productData.jipaaDate?$state.go("product-purchase-policy-info"):"BEDH"==vm.productData.prd_code?($rootScope.dateParams.orderCode=orderCode,PolicyService.doCalc($rootScope.dateParams,function(){$rootScope.dateParams="",PolicyService.control({state:"product-purchase-calculate",control:"process"})})):PolicyService.control({state:"mobile-modal",control:"process"});else TipService.showMsg("人脸核身未通过")})}}angular.module("app").controller("FaceDetectModalController",FaceDetectModalController),FaceDetectModalController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","TipService","$ionicLoading","LoginService"]}(),function(){function healthModalController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,$filter,TipService){var sessionData=PolicyService.getSessionData();$scope.productData=sessionData.productData,$scope.insureData=sessionData.insureData,$rootScope.showAgreeModal=!1,$scope.flag_notify=!0;var prd_id=$scope.productData.prd_id;$scope.getTempNotice=function(){var GET_TEMP_NOTICE={url:"../statics/json/notifyMessage/"+prd_id+".json",method:"GET"};CommonRequest.request({},GET_TEMP_NOTICE,function(result){result&&result.data&&($scope.flag_notify=!1,$scope.dataList=result.data)})},$scope.getTempNotice(),$scope.leftButten=function(){TipService.showMsg("尊敬的客户，您的情况不符合本产品的投保要求，暂时无法购买，感谢您的理解与支持！")}}angular.module("app").controller("healthModalController",healthModalController),healthModalController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","$filter","TipService"]}(),function(){function IdentityModalController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,$ionicModal){var vm=this;$scope.name="",$scope.cretNo="",$scope.cretType="A",$scope.nameDisabled=!1,$scope.certNoDisabled=!1,$scope.certTypeDisabled=!1;var smsCode=sessionStorage.getItem("elife-sms"),sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,$scope.userData=sessionData.userData||{},$scope.phoneNo=$scope.userData.phoneNo,$scope.userData.customerName&&($scope.name=$scope.userData.customerName,$scope.nameDisabled=!0),$scope.userData.cretType&&($scope.cretType=$scope.userData.cretType,$scope.certTypeDisabled=!0),$scope.userData.cretNo&&($scope.cretNo=$scope.userData.cretNo,$scope.certNoDisabled=!0,"A"==$scope.userData.cretType&&($scope.cretNo=$scope.userData.cretNo.toUpperCase().replace(/\s+/g,""))),$scope.errorAlert=function(key,val){"name"==key?1==val.invalid?($scope.lengthShow=!0,$timeout(function(){$scope.lengthShow=!1},1500)):1==val.length&&($scope.formShow=!0,$timeout(function(){$scope.formShow=!1},1500)):"cretNo"==key&&(1==val.invalid2?($scope.cretNoOdd=!0,$timeout(function(){$scope.cretNoOdd=!1},1500)):1==val.length?($scope.tostCretShow=!0,$timeout(function(){$scope.tostCretShow=!1},1500)):1==val.invalid?($scope.tostCretErrShow=!0,$timeout(function(){$scope.tostCretErrShow=!1},1500)):1==val.rr&&("cretNo"==key?($scope.rr=!0,$timeout(function(){$scope.rr=!1},1500)):($scope.RR=!0,$timeout(function(){$scope.RR=!1},1500))))},$scope.goAuth=function(){var name=this.name,cretNo=this.cretNo,cretType=this.cretType,parmas={custName:name,cretNo:cretNo,phoneNo:$scope.phoneNo,cretType:cretType,prodId:vm.productData.prd_id,smsCode:smsCode?smsCode:""};CommonRequest.request(parmas,CONFIG.PHONE_REAL_AUTH_WHIH_SMSCODE,function(result){result&&1==result.status&&($rootScope.phoneAuth=!0,PolicyService.setSessionData({userData:{cretType:cretType,cretNo:cretNo,customerName:name,inputId:result.data.inputId}}),CommonRequest.request({prodId:vm.productData.prd_id},CONFIG.IS_NEED_FACEDETECT,function(result){if(result&&1==result.status)if(1==result.data.status&&"A"==cretType){COMMON.hideModal(),$rootScope.isFromBind=!1;var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/face-detect/face-detect.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show()})}else if("Y"==vm.productData.prelnsureFlag)$state.go("product-bespeak");else if("Y"==vm.productData.creditCard){var params=vm.productData.paramsArgument;PolicyService.doCalc(params,function(){}),$state.go("product-purchase-policy-info")}else"Y"==vm.productData.jipaaDate?$state.go("product-purchase-policy-info"):"BEDH"==vm.productData.prd_code?($rootScope.dateParams.orderCode=orderCode,PolicyService.doCalc($rootScope.dateParams,function(){$rootScope.dateParams="",PolicyService.control({state:"product-purchase-calculate",control:"process"})})):PolicyService.control({state:"mobile-modal",control:"process"})}))})}}angular.module("app").controller("IdentityModalController",IdentityModalController),IdentityModalController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","$ionicModal"]}(),function(){function MobileModalController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,$filter){$scope.phone="",$scope.phoneCode="",$scope.txCode="CCBSB100",$rootScope.phoneAuth=!1;var rootScope=$rootScope,sessionData=PolicyService.getSessionData(),productData=sessionData.productData;$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},sessionData.userData&&(/^100\d{8}$/.test(sessionData.userData.phoneNo)?$scope.phone="":($scope.phone=sessionData.userData.phoneNo,"830"==$rootScope.SALE_CHANNEL&&($scope.checkFlag="1")),$scope.showDrag=!0,$scope.getdragimg()),$scope.cancel=function(){COMMON.hideModal()},$scope.phoneAlert=function(val){1==val.invalid&&($scope.phoneAlertshow=!0,$timeout(function(){$scope.phoneAlertshow=!1},1500))},$scope.hide=function(){$scope.phoneAlertshow=!1},$scope.dragShow=function(phone){if(phone){if($scope.showDrag)return;$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()}else $scope.showDrag=!1,$scope.doAnimate=!0},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),$scope.dragDisabled=!0,rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.submit=function(){var phone=this.phone,phoneCode=this.phoneCode,HmrcOrderCode="";if(productData.orderCode&&(HmrcOrderCode=productData.orderCode),phone&&phoneCode){var params={prdId:productData.prd_id,mobileNo:phone,smsCode:phoneCode,orderCode:HmrcOrderCode};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){if(1==result.status){var orderCode=result.data.orderCode;PolicyService.setSessionData({productData:{orderCode:orderCode,phoneValid:!0}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{phoneValidateTime:now,orderCode:orderCode,noticeUrl:window.location.href}}),PolicyService.control({state:"mobile-modal",control:"data",data:{phoneNo:phone}}),PolicyService.control({state:"mobile-modal",control:"process"}),sessionStorage.setItem("elife-sms",phoneCode),COMMON.hideModal()}})}}}angular.module("app").controller("MobileModalController",MobileModalController),MobileModalController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","$filter"]}(),function(){function PreExpertsController($state,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,TipService,$interval,$ionicPopup,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData(),userdata=vm.userData=sessionData.userData;null!=userdata&&(vm.name=userdata.customerName,vm.phone=userdata.phoneNo);var interval;vm.selctCity=!0,vm.tipsDivShow=!1;var codetiming;vm.duration=60,vm.messContent="获取验证码",vm.isLoadPrdId=!1,vm.hideLoading=function(){console.info(vm.isLoadPrdId,vm.isGeolocation),vm.isLoadPrdId&&vm.isGeolocation&&$ionicLoading.hide()},vm.loadPrdId=function(){var prdParams={prdCode:"ALLIN"};$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),CommonRequest.request(prdParams,CONFIG.NEW_GETPRDID,function(result){vm.isLoadPrdId=!0,vm.hideLoading(),result.data&&(vm.curProId=result.data)},!0)},vm.getAdreTimes=0,vm.getPosAdress=function(){function transOrigin(data){if(vm.transOriginTime>5&&TipService.showMsg("网络异常，请稍后重试"),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer),vm.transOriginTime++},200)}function translateCallback(data){0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder,listArr=["上海市","天津市","北京市","重庆市"];myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){result?($ionicLoading.hide(),$timeout(function(){$scope.$apply(function(){-1!=listArr.indexOf(result.addressComponents.province)?vm.locate=result.addressComponents.province+"-"+result.addressComponents.district:vm.locate=result.addressComponents.province+"-"+result.addressComponents.city+"-"+result.addressComponents.district})},0)):positionError()})}function positionError(){alert("定位失败请手动选择")}vm.getAdreTimes++,$timeout(function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},0),vm.list=[1,1,1,1,1,1,1],vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(vm.positionTy=1,1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){vm.getAdreTimes<6&&vm.getPosAdress(),positionError(),alert(JSON.stringify(eror))},cancel:function(){alert("用户取消")}})}),wx.error(function(res){positionError()})}else positionError()},!0)},vm.transOriginTime=1,vm.getPosition()};var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"允许定位吗？",okText:"允许",cancelText:"拒绝"});alertPopup.then(function(res){res?(vm.getPosAdress(),vm.poiIsTrue=!0,vm.getPoiIsTrue=!0):(vm.getPoiIsTrue=!0,vm.searchInput="")}),vm.timingHide=function(res){vm.tipsDiv=res,vm.tipsDivShow=!0,interval=$interval(function(){vm.timing>0&&vm.timing--},1e3)};var regxPhone=/^[1][0-9]{10}$/;vm.phoneImg=!1,$scope.$watch("preexperts.timing",function(newValue){0==newValue&&($interval.cancel(interval),vm.tipsDivShow=!1)}),$scope.$watch("preexperts.phone",function(newValue){vm.phone&&(11==newValue.length&&regxPhone.test(vm.phone)?vm.phoneImg=!0:vm.phoneImg=!1)}),vm.getMessageInfo=function(){if(void 0==vm.phone||""==vm.phone)return vm.timing=2,void vm.timingHide("手机号码不能为空");if(11!=vm.phone.length||!regxPhone.test(vm.phone))return vm.timing=2,void vm.timingHide("手机号码格式不正确");var messParams={mobileNo:vm.phone,txCode:"CCBSB100"};CommonRequest.request(messParams,CONFIG.SEND_EXPS_MSG_SERVICE,function(result){vm.countDown()})},vm.countDown=function(){vm.duration<=0?(vm.codeStatus=!0,$interval.cancel(codetiming)):codetiming=$interval(function(){vm.duration--,vm.messContent=vm.duration+"s"},1e3)},$scope.$watch("preexperts.messContent",function(newValue){"0s"!=newValue&&"获取验证码"!=newValue||($interval.cancel(codetiming),vm.duration=60,vm.messContent="获取验证码",vm.codeStatus=!1),"获取验证码"!=newValue&&(vm.codeStatus=!0)}),vm.pretSubimt=function(){if(vm.timing=2,void 0==vm.name||""==vm.name)return void vm.timingHide("请填写您的姓名");if(void 0==vm.locate||""==vm.locate)return void vm.timingHide("请填写您的地址");if(void 0==vm.phone||""==vm.phone)return void vm.timingHide("请填写您的手机号码");if(void 0==vm.phoneCode||""==vm.phoneCode)return void vm.timingHide("请输入短信验证码");var expParams={cusName:vm.name,location:vm.locate,cusPhone:vm.phone,phoneCode:vm.phoneCode};CommonRequest.request(expParams,CONFIG.QUERY_EXPS_INFO_SERVICE,function(result){if(1==result.status){var expName=result.data.expName,telPhone=result.data.expPhone;$ionicPopup.confirm({title:'<img src="img/user/activation_success.png">',template:"您已成功预约保险专家，<br><span>"+expName+" </span><span> "+telPhone+"</span>, 将竭诚为您提供服务! 请注意电话接听!",cssClass:"distingguishPopupSuccess pretDialog",buttons:[{text:"我知道了",type:"button-positive",onTap:function(){$state.go("tab.mall")}},{text:"联系专家",type:"button-positive",onTap:function(){window.location.href="tel://"+telPhone}}]})}else"errorFlag"==result.status&&vm.timingHide("该地区暂无匹配到预约专家，请您更改预约地址")})},vm.loadPrdId(),$scope.$on("$destroy",function(){jsapi&&jsapi.remove()})}angular.module("app").controller("PreExpertsController",PreExpertsController),PreExpertsController.$inject=["$state","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","TipService","$interval","$ionicPopup","$ionicLoading","$timeout"]}(),function(){function ProductAnkangController($state,VALIDATION,$document,GroupPolicyService,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicPopup,COMMON,$http){function ages(str){var r=str.match(/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/);if(null==r)return!1;var d=new Date(r[1],r[3]-1,r[4]);if(d.getFullYear()==r[1]&&d.getMonth()+1==r[3]&&d.getDate()==r[4]){var Y=(new Date).getFullYear();return Y-r[1]}}var vm=this,userData=GroupPolicyService.getSessionData().userData;vm.checkCrettype="",vm.monterrMsg="",vm.newRule=!1,"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.a=[[1,"趸缴",65],[3,"3年交",60],[5,"5年交",60],[10,"10年交",55],[20,"20年交",45]],vm.b=[0,1,3,5,10,20];var boy1year,boy3year,boy5year,boy10year,boy20year,girl1year,girl3year,girl5year,girl10year,girl20year;vm.jinianjiao="0",vm.triqi="",vm.tbf=0,vm.bbrf=0,vm.showError=!1,vm.errorMsg="输入的金额必须大于等于10000并且是1000的整数倍";var $timepiker,x1=/^\+?[1-9][0-9]*$/;vm.minrili="",vm.maxrili=$filter("date")(new Date,"yyyy-MM-dd"),vm.timer=null,vm.hide=function(){vm.showError=!1},vm.tbaorenyiwan=1e4,$timeout(function(){$(".inputjq").on("input propertychange",function(e){console.info($(this).val());var v=Number($(this).val()),$this=$(this);vm.timer&&(vm.showError=!1,$timeout.cancel(vm.timer)),x1.test(v)&&(v>=1e4&&x1.test(v/1e3)?vm.event&&vm.fatherclick(vm.event):(vm.showError=!0,vm.timer=$timeout(function(){vm.showError=!1,$($this).val(1e4),vm.fatherclick(vm.event)},3e3)))}),$timepiker=$(".timepiker"),$($timepiker).bind("input propertychange",function(e){vm.event&&vm.fatherclick(vm.event)})},0);var nowy=(new Date).getFullYear(),nowm=(new Date).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=(new Date).getDate()<10?"0"+(new Date).getDate():(new Date).getDate();vm.minrili=["1900-01-01",nowy-vm.a[0][2]+"-"+nowm+"-"+nowd,nowy-vm.a[1][2]+"-"+nowm+"-"+nowd,nowy-vm.a[2][2]+"-"+nowm+"-"+nowd,nowy-vm.a[3][2]+"-"+nowm+"-"+nowd,nowy-vm.a[4][2]+"-"+nowm+"-"+nowd],vm.mindata=nowy-vm.a[0][2]+"-"+nowm+"-"+nowd,vm.secShow=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secIsShow=!vm.secList[i].secIsShow,vm.secInfo[i].secIsShow=!vm.secInfo[i].secIsShow;break}},$scope.$watch("{a:ProductAnkang.jinianjiao,b:ProductAnkang.xingbie,c:ProductAnkang.triqi,d:ProductAnkang.priInfo.priChecked,e:ProductAnkang.tbaorenyiwan}",function(n,o){console.info(n),console.info(o),n.a!==o.a&&(vm.triqi="",vm.tbf=0,vm.bbrf=0,$(".timepiker").val(""));(new Date).getFullYear(),(new Date).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,(new Date).getDate()<10?"0"+(new Date).getDate():(new Date).getDate();switch(n.a){case"0":var ww=0;break;case"1":var ww=1;console.info(vm.minrili);break;case"3":var ww=2;break;case"5":var ww=3;break;case"10":var ww=4;console.info(vm.minrili);break;case"20":var ww=5}if(vm.timer&&($timeout.cancel(vm.timer),vm.showError=!1),n.d){if(x1.test(vm.tbaorenyiwan)&&!(vm.tbaorenyiwan>=1e4&&x1.test(vm.tbaorenyiwan/1e3)))return vm.showError=!0,void(vm.timer=$timeout(function(){vm.showError=!1,vm.tbaorenyiwan=1e4},3e3));var nn,nianling=ages($(".birthday").eq(ww).val());nn=0===nianling?!0:nianling;var non=n.b,baoe=n.e;console.info(nianling,non,baoe);var go;if(go="nan"!=non&&"nv"!=non||!nn||isNaN(baoe)?0:1)switch(non){case"nan":switch(n.a){case"0":vm.tbf=0;break;case"1":for(var i=0;i<boy1year.length;i++){var age=boy1year[i].age;if(age==nianling)return void(vm.tbf=boy1year[i].charge*Number(baoe))}break;case"3":for(var i=0;i<boy3year.length;i++){var age=boy3year[i].age;if(age==nianling)return void(vm.tbf=boy3year[i].charge*Number(baoe))}break;case"5":for(var i=0;i<boy5year.length;i++){var age=boy5year[i].age;if(age==nianling)return void(vm.tbf=boy5year[i].charge*Number(baoe))}break;case"10":for(var i=0;i<boy10year.length;i++){var age=boy10year[i].age;if(age==nianling)return void(vm.tbf=boy10year[i].charge*Number(baoe))}break;case"20":for(var i=0;i<boy20year.length;i++){var age=boy20year[i].age;if(age==nianling)return void(vm.tbf=boy20year[i].charge*Number(baoe))}}break;case"nv":switch(n.a){case"0":vm.tbf=0;break;case"1":for(var i=0;i<girl1year.length;i++){var age=girl1year[i].age;if(age==nianling)return void(vm.tbf=girl1year[i].charge*Number(baoe))}break;case"3":for(var i=0;i<girl3year.length;i++){var age=girl3year[i].age;if(age==nianling)return void(vm.tbf=girl3year[i].charge*Number(baoe))}break;case"5":for(var i=0;i<girl5year.length;i++){var age=girl5year[i].age;
if(age==nianling)return void(vm.tbf=girl5year[i].charge*Number(baoe))}break;case"10":for(var i=0;i<girl10year.length;i++){var age=girl10year[i].age;if(age==nianling)return void(vm.tbf=girl10year[i].charge*Number(baoe))}break;case"20":for(var i=0;i<girl20year.length;i++){var age=girl20year[i].age;if(age==nianling)return void(vm.tbf=girl20year[i].charge*Number(baoe))}}}else vm.tbf=0}else vm.tbf=0,vm.xingbie=void 0});var rate_gddc={};$http({method:"GET",url:"../statics/json/rate_GDDC.json?"+new Date}).then(function(res){rate_gddc=res.data.data,console.table(res),boy1year=res.data.data.rate_boy_1N,boy3year=res.data.data.rate_boy_3N,boy5year=res.data.data.rate_boy_5N,boy10year=res.data.data.rate_boy_10N,boy20year=res.data.data.rate_boy_20N,girl1year=res.data.data.rate_girl_1N,girl3year=res.data.data.rate_girl_3N,girl5year=res.data.data.rate_girl_5N,girl10year=res.data.data.rate_girl_10N,girl20year=res.data.data.rate_girl_20N});var arr=[];vm.fatherclick=function(e){vm.monterrMsg||(vm.bbrf=0,vm.event=e,$timeout(function(){arr.length=0;for(var i=0;i<$(e.target).parents("ul").find("li").length;i++)if($(e.target).parents("ul").find("li").eq(i).find("i").hasClass("opt-right")){var $li=$(e.target).parents("ul").find("li").eq(i),$date=$($li).find("input[type=date]"),$text=$($li).find("input[type=text]");if($($li).find(".pro-byj-plane-active").length>0){var h=$($li).children("div").eq(1).find("div").eq(0).children("div:last").find(".pro-byj-plane-active").html();switch(vm.jinianjiao){case 0:var whichdate=0;break;case"1":var whichdate=1;break;case"3":var whichdate=2;break;case"5":var whichdate=3;break;case"10":var whichdate=4;break;case"20":var whichdate=5}var hdate=$($date).eq(whichdate).val(),htext=$($text).val();hdate=ages(hdate),console.info(h.indexOf("男"));var obj={};h&&(-1!=h.indexOf("男")?(obj.xingbie="nan",obj.riqi=hdate,obj.baoe=htext,arr.push(obj)):(obj.xingbie="nv",obj.riqi=hdate,obj.baoe=htext,arr.push(obj)))}}for(var i=0;i<arr.length;i++){var go,nn1;nn1=0===arr[i].riqi?!0:arr[i].riqi;var baoe=Number(arr[i].baoe);if(go="nan"!=arr[i].xingbie&&"nv"!=arr[i].xingbie||!nn1||isNaN(arr[i].baoe)?0:1)switch(arr[i].xingbie){case"nan":switch(vm.jinianjiao){case 0:vm.bbrf+=0;break;case"1":for(var j=0;j<boy1year.length;j++){var age=boy1year[j].age;age==arr[i].riqi&&(vm.bbrf+=boy1year[j].charge*Number(baoe))}break;case"3":for(var j=0;j<boy3year.length;j++){var age=boy3year[j].age;age==arr[i].riqi&&(vm.bbrf+=boy3year[j].charge*Number(baoe))}break;case"5":for(var j=0;j<boy5year.length;j++){var age=boy5year[j].age;age==arr[i].riqi&&(vm.bbrf+=boy5year[j].charge*Number(baoe))}break;case"10":for(var j=0;j<boy10year.length;j++){var age=boy10year[j].age;age==arr[i].riqi&&(vm.bbrf+=boy10year[j].charge*Number(baoe))}break;case"20":for(var j=0;j<boy20year.length;j++){var age=boy20year[j].age;age==arr[i].riqi&&(vm.bbrf+=boy20year[j].charge*Number(baoe))}}break;case"nv":switch(vm.jinianjiao){case"0":vm.bbrf+=0;break;case"1":for(var j=0;j<girl1year.length;j++){var age=girl1year[j].age;age==arr[i].riqi&&(vm.bbrf+=girl1year[j].charge*Number(baoe))}break;case"3":for(var j=0;j<girl3year.length;j++){var age=girl3year[j].age;age==arr[i].riqi&&(vm.bbrf+=girl3year[j].charge*Number(baoe))}break;case"5":for(var j=0;i<girl5year.length;j++){var age=girl5year[j].age;age==arr[i].riqi&&(vm.bbrf+=girl5year[j].charge*Number(baoe))}break;case"10":for(var j=0;j<girl10year.length;j++){var age=girl10year[j].age;age==arr[i].riqi&&(vm.bbrf+=girl10year[j].charge*Number(baoe))}break;case"20":for(var j=0;j<girl20year.length;j++){var age=girl20year[j].age;age==arr[i].riqi&&(vm.bbrf+=girl20year[j].charge*Number(baoe))}}}}},0))},vm.calculation=function(sex,age,amount,method){var flag=rate_gddc["rate_"+("1"==sex?"boy_":"girl_")+method+"N"],age_charge=flag.find(function(item){return item.age==age});return age_charge||TipService.showMsg("被保人年龄不在该缴费方式投保范围之内"),age_charge?(10*Number(age_charge.charge)*Number(amount)/1e3/10).toFixed(2):0},vm.userInfo=[{sex:"",birth:"",age:0,amount:1e4,money:0,ifSoread:!1},{sex:"",age:0,amount:1e4,money:0,ifSoread:!1},{sex:"",birth:"",age:0,amount:1e4,money:0,ifSoread:!1}],vm.total=0,vm.paymentlist=[[0,"请选择",99],[1,"趸缴",65],[3,"3年交",60],[5,"5年交",60],[10,"10年交",55],[20,"20年交",45]],vm.payment=0,vm.maxbirth=function(i){if(1>i){var date=new Date(VALIDATION.getDateByAge(18));return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()}var date1=new Date,date2=new Date(date1);return date2.setDate(date1.getDate()-30),date2.getFullYear()+"-"+(date2.getMonth()+1)+"-"+date2.getDate()},vm.minbirth=function(i){var date=new Date(VALIDATION.getDateByAge(65));return date.getFullYear()+"-"+(date.getMonth()+1)+"-"+date.getDate()},$scope.$watch("ProductAnkang.payment",function(newValue){vm.userInfo.forEach(function(item,i){vm.checkmsg=vm.formcheck(),vm.checkmsg||vm.groupChange(i)})},!0),vm.groupChange=function(i){vm.totalmoney=0,vm.checkmsg=vm.formcheck(),vm.checkmsg||(vm.userInfo[i].birth&&(vm.userInfo[i].age=VALIDATION.getAgeByBirth(vm.userInfo[i].birth),vm.userInfo[i].sex&&vm.payment>0&&(vm.userInfo[i].money=vm.calculation(vm.userInfo[i].sex,vm.userInfo[i].age,vm.userInfo[i].amount,vm.payment))),vm.userInfo.forEach(function(item){vm.totalmoney=(Number(item.money)+Number(vm.totalmoney)).toFixed(2)}))},vm.checkmsg="",vm.formcheck=function(){var msg="";return vm.userInfo.forEach(function(item,index){item.amount<1e4?("被保人保额不低于1万"!==vm.checkmsg&&TipService.showMsg("被保人保额不低于1万"),msg="被保人保额不低于1万",vm.userInfo[index].money=0):item.amount>1e6&&("被保人保额最高不超过100万"!==vm.checkmsg&&TipService.showMsg("被保人保额最高不超过100万"),msg="被保人保额最高不超过100万",vm.userInfo[index].money=0);var maxage=0;if(item.age){switch(item.method){case 0:maxage=65;break;case 3:maxage=60;break;case 5:maxage=60;break;case 10:maxage=55;break;case 20:maxage=45;break;default:maxage=65}1>index&&(item.age<18||item.age>maxage)&&(TipService.showMsg("被保人年龄不在投保范围之内"),msg="被保人年龄不在投保范围之内",vm.userInfo[index].money=0),index>=1&&item.age>maxage&&(TipService.showMsg("被保人年龄不在投保范围之内"),msg="被保人年龄不在投保范围之内",vm.userInfo[index].money=0)}}),msg},vm.spreadUser=function(i){vm.userInfo[i].ifSoread=!vm.userInfo[i].ifSoread},vm.addUser=function(){vm.userInfo.push({sex:"",birth:"",age:0,amount:1e4,money:0,ifSoread:!1})},vm.addAmount=function(i){vm.userInfo[i].amount=Number(vm.userInfo[i].amount)+1e3,vm.groupChange(i)},vm.delAmount=function(i){vm.userInfo[i].amount=Number(vm.userInfo[i].amount)-1e3,vm.groupChange(i)},vm.deleatUser=function(i){vm.userInfo.splice(i,1)},vm.user={},vm.user.securityAge=null,vm.nextStep=!0,vm.nextStep=!0,vm.ifShowInfo0=!1,vm.ifShowInfo1=!1,vm.id=$state.params.id,window.localStorage.setItem("GDDC",vm.id),vm.reduce=function(e,index){Number(1e4==$(e.target).next().val())||("99"==index?vm.tbaorenyiwan=Number(vm.tbaorenyiwan)-1e3:vm.secList[index].secMount=Number(vm.secList[index].secMount)-1e3,vm.changeMount(index))},vm.add2=function(e,index){Number(1e4==$(e.target).next().val())||("99"==index?vm.tbaorenyiwan=Number(vm.tbaorenyiwan)+1e3:vm.secList[index].secMount=Number(vm.secList[index].secMount)+1e3,vm.changeMount(index))},vm.changeMount=function(index){var mon=0;mon="99"==index?vm.tbaorenyiwan:vm.secList[index].secMount,mon%1e3!==0&&(vm.monterrMsg||TipService.showMsg("保额必须是1000的整数倍"),vm.monterrMsg="保额必须是1000的整数倍",vm.tbf=0,vm.bbrf=0),mon>1e6||1e4>mon?(vm.monterrMsg||TipService.showMsg("投被保人最低投保1万，最高可投保100万"),vm.monterrMsg="投被保人最低投保1万，最高可投保100万",vm.tbf=0,vm.bbrf=0):(vm.monterrMsg="",vm.event&&vm.fatherclick(vm.event))},vm.buttonShow=$state.params.buttonShow,vm.salesId=$state.params.salesId,vm.parentSalesId=$state.params.parentSalesId,vm.salesLevel=$state.params.salesLevel,vm.newSaleChnl=$state.params.saleChnl,vm.salerId=$state.params.salerId,vm.activityId=$state.params.activityId,vm.ageRangeList=COMMON.getCommonData().AGE_RANGE_LIST.slice(0,10),vm.newSaleChnl&&vm.newSaleChnl.length>0&&(CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl),"false"==vm.buttonShow?(vm.nextButton=!1,PolicyService.control({state:$state.current.name,control:"data",data:{buttonShow:vm.buttonShow}})):vm.nextButton=!0,vm.salesId&&PolicyService.control({state:$state.current.name,control:"data",data:{salesId:vm.salesId}}),vm.parentSalesId&&PolicyService.control({state:$state.current.name,control:"data",data:{parentSalesId:vm.parentSalesId}}),vm.salesLevel&&PolicyService.control({state:$state.current.name,control:"data",data:{salesLevel:vm.salesLevel}}),vm.newSaleChnl&&PolicyService.control({state:$state.current.name,control:"data",data:{newSaleChnl:vm.newSaleChnl}}),vm.salerId&&PolicyService.control({state:$state.current.name,control:"data",data:{salerId:vm.salerId}}),vm.activityId&&PolicyService.control({state:$state.current.name,control:"data",data:{activityId:vm.activityId}}),vm.channelCode=CONFIG.SALE_CHANNEL,vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){if(vm.productData=result.data,vm.productData){var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),vm.changePayAge()}PolicyService.control({state:$state.current.name,control:"data",data:vm.productData}),$timeout(function(){$rootScope.showProductDialog=!0},100)}vm.getProductMaterials(),vm.getProductToken(),vm.getAll(vm.productData),vm.getPremium(vm.productData)}if(vm.productData){var second=vm.productData.tag_name[0],secondLink=vm.productData.tag_code[0],third=vm.productData.prd_title;$rootScope.$broadcast("refresh-location",{second:second,secondLink:"product-list({tag:"+secondLink.substr(secondLink.length-1,1)+"})",third:third})}$rootScope.$broadcast("scroll.refreshComplete")})},vm.getAll=function(productData){function evalFun(bodyContent){var regDetectJs=/<script(.|\n)*?>(.|\n|\r\n)*?<\/script>/gi,jsContained=bodyContent.match(regDetectJs);if(jsContained){for(var regGetJS=/<script(.|\n)*?>((.|\n|\r\n)*)?<\/script>/im,jsNums=jsContained.length,i=0;jsNums>i;i++){var jsSection=jsContained[i].match(regGetJS);jsSection[2]&&(window.execScript?window.execScript(jsSection[2]):window.eval(jsSection[2]))}$timeout(function(){vm.navLinkFun=function(){if(document.querySelectorAll("#case p")&&vm.maDetail[0]){var navPTK=document.querySelectorAll("#case p"),navLink=navPTK[0].lastElementChild;navLink.onclick=function(){window.open(vm.maDetail[0].materialPath,"_blank")}}},vm.navLinkFun()},100)}}productData?vm.tabs=productData.tabs:$state.go("tab.mall"),"false"==productData.buttonShow?vm.nextButton=!1:vm.nextButton=!0,vm.tab=0,vm.getHtml=function(){CommonRequest.request({},{url:$filter("iframeFilter")(vm.productData.prd_id),method:"GET"},function(result){if(result){var regBody=/<body[^>]*>([\s\S]*)<\/body>/,bodyContent=regBody.exec(result);bodyContent&&2==bodyContent.length&&(bodyContent=bodyContent[1]),angular.element(document.querySelector("#content")).html(bodyContent),evalFun(bodyContent)}})},vm.getHtml()},vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()};var times=0;vm.loadingPage=function(ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage())},2e3))},vm.loadingPage($rootScope),vm.getLotCode=function(callback){if("tacb"==vm.productData.templateCode.toLowerCase()&&"Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:$state.current.name,control:"data",data:{token:"",lotCode:""}})})},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):void PolicyService.control({state:$state.current.name,control:"data",data:{token:token,lotCode:data.lotCode}})}))})},vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}}),vm.materialDetail=function(){if(vm.productData){var ma=materials.find(function(item){return"M01"==item.materialType});if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};GroupPolicyService.getMaterialDetailOpen(params)}}}})},vm.getProductMaterialsWithoutCache=function(){PolicyService.getMaterialsWithoutCache({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.requestWithoutCache(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.process=function(id){return vm.checkCrettype?void TipService.showMsg(vm.checkCrettype):(PolicyService.control({state:$state.current.name,control:"data",data:{plchdBrthDt:$filter("date")(vm.priInfo.birthday,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredList:vm.insuredList,totalInsCvr:vm.totalInsCvr,insCvr:vm.insCvr,rateList:vm.rateList,groupProName:vm.productData.prd_title,pbApplNoNum:"1",params:vm.params}}),void PolicyService.control({state:$state.current.name,control:"process"}))},vm.backTop=function(){$ionicScrollDelegate.scrollTop()},vm.getYearMore=function(){},vm.getQuestionMore=function(){"false"==vm.proFotterShow?vm.proFotterShow=!1:vm.proFotterShow=!0},vm.getQuestionMoreClose=function(){"true"==vm.proFotterShow?vm.proFotterShow=!0:vm.proFotterShow=!1},vm.getPremium=function(productData){vm.hasSpecial=!0;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.minHolderAge,vm.maxAge=payTypeConfig.maxHolderAge}VALIDATION.getDateByAge("23"),VALIDATION.getDateByAge("0");vm.planChecked="",vm.planDet=!1,vm.planMoney="50万元",vm.nextStep=!1,vm.planOneCheck=function(){vm.planChecked="1",vm.planDet=!1,vm.planMoney="50万元",vm.planOneImg=!0,vm.planTwoImg=!1},vm.planTwoCheck=function(){vm.planChecked="2",vm.planDet=!1,vm.planMoney="100万元",vm.planOneImg=!1,vm.planTwoImg=!0},vm.planType="",vm.planOneImg=!1,vm.planTwoImg=!1,vm.choosePlan=function(plan){vm.planType=plan,"1"==plan?(vm.planOneImg=!vm.planOneImg,vm.planTwoImg=!1):(vm.planTwoImg=!vm.planTwoImg,vm.planOneImg=!1),vm.planOneImg||vm.planTwoImg||(vm.planType="")},$scope.$watch("ProductAnkang.planType",function(newValue){vm.priInfo.planType=newValue;for(var i=vm.secInfo.length-1;i>=0;i--)vm.secInfo[i].planType=newValue},!0),vm.slideUp=function(){vm.planDet=!1},vm.priInfo={isMedic:"",securityAge:"30-34",secOneImg:!1,planType:"",priMount:0,priChecked:!1},vm.priMedic=function(medic){vm.priInfo.isMedic=medic,"1"==medic?(vm.medicOneImg=!vm.medicOneImg,vm.medicTwoImg=!1,vm.xingbie="nan"):(vm.medicOneImg=!1,vm.medicTwoImg=!vm.medicTwoImg,vm.xingbie="nv"),vm.medicOneImg||vm.medicTwoImg||(vm.priInfo.isMedic="",vm.xingbie=void 0)},vm.prisecurityAge=function(securityAge){"1"==securityAge?(vm.priInfo.secOneImg=!vm.priInfo.secOneImg,vm.secTwoImg=!1):vm.secOneImg=!1},vm.secList=[{id:1,trashShow:!1,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:1e4,ifSelect:!1,ifSelectBtn:!0},{id:2,trashShow:!1,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:1e4,ifSelect:!1,ifSelectBtn:!0}],vm.secInfo=[{id:1,securityAge:"",isMedic:"",secMount:0,planType:"",secOneImg:!1,secIsShow:!1},{id:2,securityAge:"",isMedic:"",secMount:0,planType:"",secOneImg:!1,secIsShow:!1}];var picker1=new Picker({data:[vm.ageRangeList]});picker1.on("picker.select",function(selectedVal,selectedIndex){$scope.$apply(function(){vm.priInfo.securityAge=vm.ageRangeList[selectedIndex[0]].text})}),vm.upagerange=function(){vm.priInfo.secOneImg=!0},vm.upagerange1=function(){vm.ifSelectBtn=!vm.ifSelectBtn,vm.ifSelect=!vm.ifSelect},vm.upagerangeOpt=function(){for(var i=0;i<vm.secList.length;i++)!function(index){var sec=i+1;$scope.$on("agePickerCallback"+sec,function(event,data){vm.secList[index].secOneImg=!0,vm.secList[index].securityAge=data[0].value,vm.secInfo[index].secOneImg=!0,vm.secInfo[index].securityAge=data[0].value})}(i)},vm.upagerangeOpt(),vm.upagerange1Opt=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secOneImg=!0,vm.secList[i].ifSelect=!vm.secList[i].ifSelect,vm.secList[i].ifSelectBtn=!vm.secList[i].ifSelectBtn;break}},vm.setsecurityAge=function(id,securityAge){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){var tempUser=vm.secList[i],tempInfo=vm.secInfo[i];tempInfo.securityAge=tempUser.securityAge,"1"==securityAge?(tempUser.secOneImg=!tempUser.secOneImg,tempInfo.secOneImg=tempUser.secOneImg,tempUser.secTwoImg=!1):(tempUser.secOneImg=!1,tempInfo.secOneImg=tempUser.secOneImg,tempUser.secTwoImg=!tempUser.secTwoImg),tempUser.secTwoImg||tempUser.secOneImg||(vm.secInfo[i].securityAge="");break}},vm.setpriMedic=function(id,medic){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){var tempUser=vm.secList[i],tempInfo=vm.secInfo[i];tempUser.isMedic=medic,tempInfo.isMedic=medic,"1"==medic?(tempUser.medicOneImg=!tempUser.medicOneImg,tempUser.medicTwoImg=!1):(tempUser.medicOneImg=!1,tempUser.medicTwoImg=!tempUser.medicTwoImg),tempUser.medicOneImg||tempUser.medicTwoImg||(tempUser.isMedic="",tempInfo.isMedic="");break}},vm.calcAll=function(priMount,secInfo){vm.totalPolicyMount=0;var totalPolicyMount=0;totalPolicyMount=vm.totalPolicyMount+priMount;for(var i=vm.secInfo.length-1;i>=0;i--)totalPolicyMount=vm.totalPolicyMount+secInfo[i].secMount;totalPolicyMount>1e6||(vm.totalPolicyMount=totalPolicyMount)},$scope.$watch("ProductAnkang.secList",function(newValue){if(newValue)for(var i=vm.secList.length-1;i>=0;i--)vm.secInfo[i].securityAge=vm.secList[i].securityAge},!0),$scope.$watch("ProductAnkang.secInfo",function(newValue){newValue&&vm.calculate11(newValue)},!0),vm.calculate11=function(newValue){for(var i=0;i<newValue.length;i++){var policyUser=newValue[i];if(policyUser.secIsShow)if(policyUser.planType>0&&policyUser.isMedic>0&&policyUser.secOneImg)for(var rList=vm.getRateList(policyUser.planType,policyUser.isMedic),j=rList.length-1;j>=0;j--)rList[j].age==policyUser.securityAge&&(vm.secInfo[i].secMount=parseInt(rList[j].charge));else vm.secInfo[i].secMount=0;else vm.secInfo[i].secMount=0,vm.secInfo[i].isMedic="",vm.secList[i].securityAge="30-34",vm.secList[i].secOneImg=!1,vm.secList[i].secTwoImg=!1,vm.secList[i].medicOneImg=!1,vm.secList[i].medicTwoImg=!1,vm.secInfo[i].securityAge="30-34",vm.secInfo[i].secOneImg=!1,vm.secInfo[i].secTwoImg=!1,vm.secInfo[i].medicOneImg=!1,vm.secInfo[i].medicTwoImg=!1}vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.priInfo={isMedic:"",securityAge:"30-34",secOneImg:!1,planType:"",priMount:0,priChecked:!1},$scope.$watch("ProductAnkang.priInfo",function(newValue){newValue&&(newValue.priChecked?vm.calculate00(newValue):(vm.priInfo.securityAge="30-34",vm.priInfo.secOneImg=!1,vm.priInfo.isMedic="",vm.medicOneImg=!1,vm.medicTwoImg=!1,vm.priInfo.priMount=0))},!0),vm.calculate0=function(newValue){var isM=newValue.isMedic;if(newValue.planType>0&&isM>0&&newValue.secOneImg&&newValue.priChecked)for(var rList=$scope.rateList[newValue.planType-1][isM-1],i=0;i<=vm.ageRangeList.length-1;i++)vm.ageRangeList[i].text==newValue.securityAge&&(vm.priInfo.priMount=rList[i]);else vm.priInfo.priMount=0;vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.getRateList=function(planType,isMedic){return"1"==planType&&"1"==isMedic?vm.rateList.data.rateList_50_Y:"1"==planType&&"2"==isMedic?vm.rateList.data.rateList_50_N:"2"==planType&&"1"==isMedic?vm.rateList.data.rateList_100_Y:"2"==planType&&"2"==isMedic?vm.rateList.data.rateList_100_N:void 0},vm.calculate00=function(newValue){var isM=newValue.isMedic;if(newValue.planType>0&&isM>0&&newValue.secOneImg&&newValue.priChecked)for(var rList=vm.getRateList(newValue.planType,isM),i=0;i<=rList.length-1;i++)rList[i].age==newValue.securityAge&&(vm.priInfo.priMount=parseInt(rList[i].charge));else vm.priInfo.priMount=0;vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.totalPolicyMount=0,vm.longActive=1,vm.goToTab=function(index){$location.hash("tab"+index),$anchorScroll(),vm.longActive=index},vm.goToContent=function(){$location.hash("content"),$anchorScroll()},vm.add=function(){var id=vm.secList[vm.secList.length-1].id+1;vm.secList.push({id:id,trashShow:!0,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:1e4,ifSelect:!1,ifSelectBtn:!0}),vm.secInfo.push({id:id,securityAge:"",secOneImg:!1,isMedic:"",secMount:0,planType:vm.planType,secIsShow:!1}),$timeout(function(){console.info($(".timepiker")),$(".timepiker").bind("input propertychange",function(e){vm.event&&vm.fatherclick(vm.event)})},0),vm.upagerangeOpt()},vm.del=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList.splice(i,1),vm.secInfo.splice(i,1),3==vm.secList.length&&vm.secList[i]&&(vm.secList[i].secIsShow=!vm.secList[i].secIsShow);break}},vm.secMate=function(id,relation){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].securityAge="";break}};var params,insuredList=[],plans=[];vm.calCulateToBaoRen=function(){plans=vm.productData.plans[0],insuredList=[{rcgnNm:"0",rcgnBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),insuredSSflag:vm.priInfo.isMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]}];for(var i=0;i<vm.secList.length;i++)insuredList.push({rcgnNm:vm.secList[i].id.toString(),rcgnBrthDt:$filter("date")(vm.secList[i].securityAge,"yyyyMMdd"),insuredSSflag:vm.secList[i].isMedic,cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]});params={premiumAppEntity:{plchdBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredNum:insuredList.length,insuredList:insuredList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL},CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(result.data)})},vm.submitAccount=function(){},vm.upgrade=function(){$rootScope.isLogin&&"A"==userData.cretType?vm.checkUpgrade():$state.go("product-upgrade")},vm.checkUpgrade=function(){vm.getbirth=function(){var num=VALIDATION.getSex(userData.cretNo.replace(/\s/g,""));return num-1};var params={upgradeRequest:{plchdNm:userData.customerName,plchdGndCd:vm.getbirth(),plchdCrdtNo:userData.cretNo.replace(/\s/g,""),plchdBrthDt:VALIDATION.getBirthday(userData.cretNo.replace(/\s/g,"")),plchdCrdtTpCd:"A"}};vm.verToken="",vm.upgradeData="",CommonRequest.request(params,CONFIG.ID_UPGRADE_CHECK,function(result){1==result.status&&(vm.verToken=result.data,""!=vm.verToken&&(vm.getPolicyResultTimes=0,vm.getUpdatePolicyResult()))})},vm.getUpdatePolicyResult=function(){if(vm.getPolicyResultTimes++,vm.getPolicyResultTimes>CONFIG.CORE_DECOUPLING_TIMES){$ionicLoading.hide();$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"});return void(vm.getPolicyResultTimes=0)}CommonRequest.request({verToken:vm.verToken},CONFIG.ID_UPGRADE_CHECK_RESULT,function(qresult){if(1==qresult.status){var flg="data"in qresult;if(!flg)return void $timeout(function(){vm.getUpdatePolicyResult()},500);vm.getPolicyResultTimes=0,vm.upgradeData=qresult.data,vm.handleUpdateResult(vm.upgradeData)}})},vm.handleUpdateResult=function(updateData){if(updateData){var sysRespCode=updateData.sysRespCode,sysRespDesc=updateData.sysRespDesc;updateData.rcgnList;if("00000"==sysRespCode&&(vm.showError=!0,$timeout(function(){for(var insureData=[],i=updateData.rcgnList.length-1;i>=0;i--){var tempData=updateData.rcgnList[i];if("01"!=tempData.rcgnAndRcgnReTpCd){var policyUser={};policyUser.id=i+1,policyUser.confirmRela=tempData.rcgnAndRcgnReTpCd,policyUser.LiNationality="0156",policyUser.LiRcgnName=tempData.rcgnNm,policyUser.trashShow=!1,policyUser.LiRcgnMedic=tempData.rcgnSSFLAG,policyUser.LiRcgnIdType=tempData.rcgnCrdtTpCd,policyUser.LiRcgnId=tempData.rcgnCrdtNo,policyUser.LiRcgnBirdy=tempData.rcgnBrthDt,policyUser.LiRcgnSex=VALIDATION.getSex(tempData.rcgnCrdtNo)+"",policyUser.LiRcgnOccupCode=tempData.rcgnOcpCd,policyUser.LiRcgnMobl=tempData.rcgnMoveTelNo,policyUser.LiIdEndDate=tempData.rcgnCrdtExpDt,policyUser.insureChecked=!0,policyUser.LiRcgnAddress=tempData.rcgnCommAdr,policyUser.LiRcgnZipCode=tempData.rcgnZipECD,insureData.push(policyUser)}}PolicyService.setSessionData({insureData:{planType:updateData.sysCpCode}}),PolicyService.setSessionData({policyData:{LiRcgnList:insureData}}),PolicyService.setSessionData({insureData:{pbApplNoNum:"1"}}),PolicyService.setSessionData({policyData:{isGhmbUpdate:!0,PbHoldBirdy:updateData.rcgnMNBrthDt,PbHoldAddress:updateData.rcgnMNCommAdr,PbIdEndDate:updateData.rcgnMNCrdtExpDt,PbHoldId:updateData.rcgnMNCrdtNo,PbHoldIdType:updateData.rcgnMNCrdtTpCd,PbHoldEmail:updateData.rcgnMNEmailAdr,PbNationality:"0156",PbHoldSex:VALIDATION.getSex(updateData.rcgnMNCrdtNo)+"",PbHoldMobl:updateData.rcgnMNMoveTelNo,PbHoldName:updateData.rcgnMNNm,PbHoldOccupCode:updateData.rcgnMNOcpCd,PbHoldMedic:updateData.rcgnMNSSFLAG,yearIncome:updateData.rcgnMNYrIncmAm,PbHoldAmount:updateData.rcgnMNYrIncmAm,PbHoldZipCode:updateData.rcgnMNZipECD,livePlace:updateData.rsdntTpCd,priChecked:!1,referrerCode:updateData.insRecommendId,referrerName:updateData.insRecommendNm}}),$state.go("product-purchase-ankang-optimze")},3e3)),"11111"==sysRespCode){var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:sysRespDesc,okText:"我知道了"});alertPopup.then(function(res){$state.go("product-optimze",{id:productData.prd_id})})}}else var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"})},vm.next=function(){GroupPolicyService.control({state:"product-purchase-group-calculate",control:"data",data:{plchdBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredList:insuredList,totalInsCvr:vm.totalInsCvr,insCvr:vm.insCvr,groupProName:vm.productData.prd_title,pbApplNoNum:"1",params:params}}),GroupPolicyService.control({state:"product-purchase-group-calculate",control:"process"})}},$scope.$on("agePickerCallbackOne",function(event,data){vm.priInfo.securityAge=data[0].value,vm.priInfo.secOneImg=!0}),vm.ifNavFloTrue=!1,vm.scroll=function(){var navScrollTop=document.querySelector(".optimze-byj").scrollTop,h1=document.getElementById("heightBox").offsetHeight,t1=document.getElementById("tab1").offsetTop,t2=document.getElementById("tab2").offsetTop,t3=document.getElementById("tab3").offsetTop,t4=document.getElementById("tab4").offsetTop,timer=$timeout(function(){navScrollTop>=h1?(vm.ifNavFloTrue=!0,navScrollTop+145>=t1&&(vm.longActive=1,navScrollTop+145>=t2&&(vm.longActive=2,navScrollTop+145>=t3&&(vm.longActive=3,navScrollTop+145>=t4&&(vm.longActive=4))))):vm.ifNavFloTrue=!1,$timeout.cancel(timer)},50)},vm.gotoOtherInfo=function(kid){$state.go("product-ankang-otherinfo",{kid:kid,prdid:vm.id})}}angular.module("app").controller("ProductAnkangController",ProductAnkangController),ProductAnkangController.$inject=["$state","VALIDATION","$document","GroupPolicyService","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicPopup","COMMON","$http"];
}(),function(){function ProductBedhController($state,$ionicModal,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,rootScope,PolicyService,TipService,$timeout,$filter,VALIDATION,$ionicScrollDelegate,$anchorScroll,MallCommonService,$ionicPopup,$window){var vm=this;vm.id=$state.params.id,vm.sex="1",vm.longActive="1",vm.birthday=null,vm.insuredPeriod="5",vm.navFalg=!1;var bedhSelf=$rootScope;vm.mainPlan={rate:0,amount:"0.00",exp:1e4},vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){1==result.status&&(vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val})))})}PolicyService.control({state:"product-detail",control:"data",data:{materials:materials}})})},vm.getProductMaterials(),vm.newRule=!0,"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.getMaxbirth=function(){var flag_age=VALIDATION.getDateByAge("0"),nowy=flag_age.getFullYear(),nowm=flag_age.getMonth()+1<10?"0"+(flag_age.getMonth()+1):flag_age.getMonth()+1,nowd=flag_age.getDate()<10?"0"+flag_age.getDate():flag_age.getDate();return nowy+"-"+nowm+"-"+nowd},vm.getMinbirth=function(){var flag_age=VALIDATION.getDateByAge("70"),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()+1<10?"0"+((new Date).getDate()+1):(new Date).getDate()+1;return nowy+"-"+nowm+"-"+nowd},vm.formatDate=function(date){var date=new Date(date),YY=date.getFullYear(),MM=date.getMonth()+1<10?"0"+(date.getMonth()+1):date.getMonth()+1,DD=date.getDate()<10?"0"+date.getDate():date.getDate();return YY+"-"+MM+"-"+DD},vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;var plan=vm.productData.plans,len=plan.length;if(vm.productData&&vm.productData.prdSubscribe&&(vm.preEndDate=vm.productData.prdSubscribe[0].preEndDate,vm.preStartDate=vm.productData.prdSubscribe[0].preStartDate,vm.presentDate=new Date,vm.presentDate=new Date($filter("date")(vm.presentDate,"yyyy/MM/dd")).getTime(),vm.preStartDate<=vm.presentDate&&vm.presentDate<=vm.preEndDate?vm.aheadSellFlag=!0:vm.aheadSellFlag=!1),plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType&&angular.extend(vm.mainPlan,item)}PolicyService.setSessionData({productData:result.data})}})},vm.getProductDetail(vm.id,$rootScope),vm.longActive=1,vm.navCheck=function(index){var name="img"+index;$anchorScroll(name),vm.longActive=index},vm.showBack=function(){var navScrollTop=document.getElementById("ion-content").scrollTop;console.info(navScrollTop);var h1=document.querySelector(".nav_ul_li").offsetTop,img1=document.getElementById("img1").offsetTop,img2=document.getElementById("img2").offsetTop,img3=document.getElementById("img3").offsetTop,timer=(document.getElementById("img4").offsetTop,$timeout(function(){navScrollTop>=h1?(vm.navFalg=!0,navScrollTop+88>=img1&&(vm.longActive="1",navScrollTop+88>=img2&&(vm.longActive="2",navScrollTop+88>=img3&&(vm.longActive="3",navScrollTop+88>=1300&&(vm.longActive="4"))))):vm.navFalg=!1,$timeout.cancel(timer)},50))},vm.openSafe=function(){vm.showModal_hmrc("app/module/mall/product/product-bedh/popup/safe.html")},vm.openBookingInsurance=function(){vm.showModal_hmrc("app/module/mall/product/product-bedh/popup/bookingInsurance.html")},vm.showModel=function(){bedhSelf.bookingInsuranceFlag="N",vm.showModal_hmrc("app/module/mall/product/product-bedh/popup/count.html")},vm.showModal_hmrc=function(url,animation){vm.mainPlan.exp=1e4,vm.mainPlan.amount=0,vm.payAge=vm.productData.pay_age,vm.paymentType=vm.productData.payment_type,vm.minHolderAge="0",vm.maxHolderAge="70",vm.birthday=null,bedhSelf.maxbirth=vm.getMaxbirth(),bedhSelf.minbirth=vm.getMinbirth(),$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){bedhSelf.modal=modal,bedhSelf.modal.show(),bedhSelf.bedhData={insurerBirthDay:vm.birthday,sex:vm.sex,PbInsuExp:vm.mainPlan.exp,PbInsuAmt:vm.mainPlan.amount},vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.presentDate=new Date,vm.presentDate=new Date($filter("date")(vm.presentDate,"yyyy/MM/dd")).getTime(),vm.presentDate>vm.productData.prdSubscribe[0].effectStartDate&&(vm.productData.prdSubscribe[0].effectStartDate=vm.presentDate),bedhSelf.bedhData.effectiveStartDate=vm.formatDate(vm.productData.prdSubscribe[0].effectStartDate),bedhSelf.bedhData.effectiveEndDate=vm.formatDate(vm.productData.prdSubscribe[0].effectEndDate)),$rootScope.$on("$stateChangeStart",function(){bedhSelf.modal.remove()}),bedhSelf.reduceFn=function(){bedhSelf.bedhData.PbInsuExp>1e4&&(bedhSelf.bedhData.PbInsuExp=Number(bedhSelf.bedhData.PbInsuExp)-1e3)},bedhSelf.addFn=function(){bedhSelf.bedhData.PbInsuExp>=1e4&&(bedhSelf.bedhData.PbInsuExp=Number(bedhSelf.bedhData.PbInsuExp)+1e3)},bedhSelf.sexCheck=function(sexCheck){bedhSelf.bedhData.sex=sexCheck},bedhSelf.close=function(){bedhSelf.modal.remove()},bedhSelf.bookingInsuranceFn=function(){bedhSelf.bookingInsuranceFlag="Y",bedhSelf.close(),vm.showModal_hmrc("app/module/mall/product/product-bedh/popup/count.html")},$scope.$watch("bedhData.insurerBirthDay + bedhData.sex + bedhData.PbInsuExp",function(){$timeout(function(){bedhSelf.bedhData.insurerBirthDay&&vm.calc(vm)},50)}),bedhSelf.nextFn=function(){return bedhSelf.bedhData.effecDates||"Y"!=bedhSelf.bookingInsuranceFlag?bedhSelf.bedhData.insurerBirthDay?bedhSelf.bedhData.PbInsuExp<1e4?void $ionicPopup.alert({title:"温馨提示",template:"投保保费应大于等于10000",okText:"我知道了"}):bedhSelf.bedhData.PbInsuExp%1e3!=0?void $ionicPopup.alert({title:"温馨提示",template:"投保保费应是1000的倍数",okText:"我知道了"}):(PolicyService.setSessionData({productData:{prelnsureFlag:bedhSelf.bookingInsuranceFlag}}),$rootScope.dateParams={prdId:vm.productData.prd_id,sex:bedhSelf.bedhData.sex,insurerBirthDay:$filter("date")(bedhSelf.bedhData.insurerBirthDay,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:bedhSelf.bedhData.PbInsuExp,orderCode:vm.productData.orderCode||""},PolicyService.control({state:"product-purchase-calculate",control:"data",data:{PbBeginDate:bedhSelf.bedhData.effecDates,birthday:bedhSelf.bedhData.insurerBirthDay,sex:bedhSelf.bedhData.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}}),void PolicyService.control({state:$state.current.name,control:"process"})):void $ionicPopup.alert({title:"温馨提示",template:"请选择被保人的出生日期",okText:"我知道了"}):void $ionicPopup.alert({title:"温馨提示",template:"请选择生效日期",okText:"我知道了"})}})},vm.calc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=new Number(amountExp[1]).toFixed(2),bedhSelf.bedhData.PbInsuAmt=new Number(amountExp[1]).toFixed(2),vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:bedhSelf.bedhData.insurerBirthDay,sex:bedhSelf.bedhData.sex,PbInsuExp:bedhSelf.bedhData.PbInsuExp,insuredDays:vm.insuredPeriod,insuYearFlag:"Y",planCode:"BEDH11",payendyear:vm.payAge,paymentType:vm.paymentType,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=new Number(amountExp[1]).toFixed(2),bedhSelf.bedhData.PbInsuAmt=new Number(amountExp[1]).toFixed(2),vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})}}angular.module("app").controller("ProductBedhController",ProductBedhController),ProductBedhController.$inject=["$state","$ionicModal","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$rootScope","PolicyService","TipService","$timeout","$filter","VALIDATION","$ionicScrollDelegate","$anchorScroll","MallCommonService","$ionicPopup","$window"]}(),function(){function ProductBespeakController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,TipService,$timeout,$filter){var vm=this;vm.prdSubscribe=[];var sessionData=PolicyService.getSessionData(),productData=sessionData.productData;vm.bespeakApply=function(){$state.go("product-purchase-calculate-"+productData.templateCode.toLowerCase())},vm.bespeakTime=function(){productData&&productData.prdSubscribe&&(vm.prdSubscribe[0]=productData.prdSubscribe[0],vm.effectStartDate=new Date(productData.prdSubscribe[0].effectStartDate),vm.effectEndDate=new Date(productData.prdSubscribe[0].effectEndDate),vm.now=new Date,vm.effectStartDate<vm.now&&vm.effectEndDate>vm.now&&(vm.prdSubscribe[0].effectStartDate=new Date(vm.now).getTime(),PolicyService.setSessionData({productData:{prdSubscribe:vm.prdSubscribe}})))},vm.bespeakTime()}angular.module("app").controller("ProductBespeakController",ProductBespeakController),ProductBespeakController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","TipService","$timeout","$filter"]}(),function(){function ProductContentController($state,$filter,CommonRequest,PolicyService,$timeout,$scope){function evalFun(bodyContent){var regDetectJs=/<script(.|\n)*?>(.|\n|\r\n)*?<\/script>/gi,jsContained=bodyContent.match(regDetectJs);if(jsContained)for(var regGetJS=/<script(.|\n)*?>((.|\n|\r\n)*)?<\/script>/im,jsNums=jsContained.length,i=0;jsNums>i;i++){var jsSection=jsContained[i].match(regGetJS);jsSection[2]&&(window.execScript?window.execScript(jsSection[2]):window.eval(jsSection[2]))}}var vm=this,sessionData=PolicyService.getSessionData(),login=sessionData.login,loginStatus=sessionData.loginStatus;vm.newDate=(new Date).getTime();var productData=vm.productData=sessionData.productData;productData?vm.tabs=productData.tabs:$state.go("tab.mall"),"false"==productData.buttonShow?vm.nextButton=!1:vm.nextButton=!0,vm.tab=0,vm.select=function(index){vm.tab=index},vm.getHtml=function(){CommonRequest.request({},{url:$filter("iframeFilter")(vm.productData.prd_id),method:"GET"},function(result){if(result){var regBody=/<body[^>]*>([\s\S]*)<\/body>/,bodyContent=regBody.exec(result);bodyContent&&2==bodyContent.length&&(bodyContent=bodyContent[1]),angular.element(document.querySelector("#content")).html(bodyContent),evalFun(bodyContent)}})},vm.getHtml(),vm.bespeakText=function(){"Y"!=vm.productData.basicProfile.P005||"1"==login&&"2"==loginStatus?($state.go("product-bespeak"),PolicyService.setSessionData({productData:{prelnsureFlag:"Y"}})):(PolicyService.setSessionData({productData:{prelnsureFlag:"Y"}}),PolicyService.showMobileModal())},vm.starFun=function(){var tabId=document.getElementById("nav");if(tabId)vm.navLiLen=document.getElementById("nav").children,vm.cont=document.getElementById("tab-pane"),vm.tabsContent();else var timer=$timeout(function(){vm.starFun(),$timeout.cancel(timer)},100)},vm.starFun(),vm.tabsContent=function(){for(var i=0;i<vm.navLiLen.length;i++)vm.navLiLen[i].addEventListener("touchstart",function(){for(var index=this.getAttribute("i"),j=0;j<vm.navLiLen.length;j++)if(j==index)if("案例演示"==vm.navLiLen[index].innerText.trim()){document.getElementById("tab-pane").className+=" star-mt15";var time1=$timeout(function(){vm.tipShow=!0,$timeout.cancel(time1)},100)}else{document.getElementById("tab-pane").classList.remove("star-mt15");var time2=$timeout(function(){vm.tipShow=!1,$timeout.cancel(time2)},100)}})},vm.process=function(){PolicyService.control({state:"product-detail",control:"process"})}}angular.module("app").controller("ProductContentController",ProductContentController),ProductContentController.$inject=["$state","$filter","CommonRequest","PolicyService","$timeout","$scope"]}(),function(){function ProductDetailController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,TipService,$timeout,$filter){var vm=this;vm.newRule=!1;var userData=PolicyService.getSessionData().userData,sessionData=PolicyService.getSessionData(),login=sessionData.login,loginStatus=sessionData.loginStatus;vm.newDate=(new Date).getTime(),"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),1==$rootScope.nowStatus?vm.nowStatus=1:vm.nowStatus=0;var sessionPicuterData=sessionStorage.getItem("elife-overPicuter")||{};sessionPicuterData?"[object Object]"===Object.prototype.toString.call(sessionPicuterData)?vm.picuter={}:vm.picuter=JSON.parse(sessionPicuterData).picuter:vm.picuter={},sessionData.productData&&(vm.productData=sessionData.productData,vm.basicProfile=vm.productData.basicProfile),vm.id=$state.params.id,vm.buttonShow=$state.params.buttonShow,vm.salesId=$state.params.salesId,vm.parentSalesId=$state.params.parentSalesId,vm.salesLevel=$state.params.salesLevel,vm.newSaleChnl=$state.params.saleChnl,vm.salerId=$state.params.salerId,vm.activityId=$state.params.activityId,vm.newSaleChnl&&vm.newSaleChnl.length>0&&(CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl),"false"==vm.buttonShow?(vm.nextButton=!1,PolicyService.control({state:$state.current.name,control:"data",data:{buttonShow:vm.buttonShow}})):vm.nextButton=!0,vm.salesId&&PolicyService.control({state:$state.current.name,control:"data",data:{salesId:vm.salesId}}),vm.salesId&&"827"==vm.newSaleChnl&&PolicyService.setSessionData({productData:{salesId:vm.salesId,newSaleChnl:vm.newSaleChnl}}),vm.parentSalesId&&PolicyService.control({state:$state.current.name,control:"data",data:{parentSalesId:vm.parentSalesId}}),vm.salesLevel&&PolicyService.control({state:$state.current.name,control:"data",data:{salesLevel:vm.salesLevel}}),vm.newSaleChnl&&PolicyService.control({state:$state.current.name,control:"data",data:{newSaleChnl:vm.newSaleChnl}}),vm.salerId&&PolicyService.control({state:$state.current.name,control:"data",data:{salerId:vm.salerId}}),vm.activityId&&PolicyService.control({state:$state.current.name,control:"data",data:{activityId:vm.activityId}}),vm.channelCode=CONFIG.SALE_CHANNEL,vm.WxChanelShow=!0;var timeIsMarke=$timeout(function(){var isMarkeFlg=!1;angular.isObject(vm.productData)&&vm.productData.isMarketingStatus&&(isMarkeFlg=!0),isMarkeFlg&&"1"==vm.productData.isMarketingStatus&&$rootScope.WECHAT&&(vm.WxChanelShow=!0,$timeout.cancel(timeIsMarke))},100);vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;if(vm.productData){1==$rootScope.nowStatus&&"[object Array]"===Object.prototype.toString.call(vm.picuter)&&vm.picuter.length>0&&vm.picuter.forEach(function(item,index){if(item.prdCode==vm.productData.prd_code)for(var i=0;i<item.picInfo.length;i++)"3"==item.picInfo[i].picLocation&&(vm.productData.prd_pic1=item.picInfo[i].prdPic)});var payTypeConfigs=(vm.productData.prdDetails,vm.productData.prdPayments,vm.productData.payTypeConfigs);if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),vm.changePayAge()}PolicyService.control({state:$state.current.name,control:"data",data:vm.productData}),$timeout(function(){$rootScope.showProductDialog=!0},100)}vm.getProductMaterials(),vm.getProductToken()}if(vm.productData){var second=vm.productData.tag_name[0],secondLink=vm.productData.tag_code[0],third=vm.productData.prd_title;$rootScope.$broadcast("refresh-location",{second:second,secondLink:"product-list({tag:"+secondLink.substr(secondLink.length-1,1)+"})",third:third})}$rootScope.$broadcast("scroll.refreshComplete")})},vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()};var times=0;vm.loadingPage=function(ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage($rootScope))},2e3))},vm.loadingPage($rootScope),vm.getLotCode=function(callback){if("tacb"==vm.productData.templateCode.toLowerCase()&&"Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:$state.current.name,control:"data",data:{token:"",lotCode:""}})})},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):void PolicyService.control({state:$state.current.name,control:"data",data:{token:token,lotCode:data.lotCode}})}))})},vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){1==result.status&&(vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val})))})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.getProductMaterialsWithoutCache=function(){PolicyService.getMaterialsWithoutCache({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.requestWithoutCache(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.process=function(){return vm.newSaleChnl&&vm.productData.orderCode&&vm.productData.orderCode>0&&PolicyService.setSessionData({productData:{orderCode:null}}),"TAC"==vm.productData.templateCode&&$rootScope.isLogin&&"A"!=userData.cretType?void TipService.showMsg($rootScope.TIPS.PRODUCT.TAC_CERTTYPE_FAILED):(PolicyService.control({state:$state.current.name,control:"process"}),void PolicyService.setSessionData({productData:{prelnsureFlag:"N"}}))},vm.bespeakText=function(){"Y"!=vm.productData.basicProfile.P005||"1"==login&&"2"==loginStatus?($state.go("product-bespeak"),PolicyService.setSessionData({productData:{prelnsureFlag:"Y"}})):(PolicyService.setSessionData({productData:{prelnsureFlag:"Y"}}),PolicyService.showMobileModal())},vm.clauseJump=function(url){window.location.href=url}}angular.module("app").controller("ProductDetailController",ProductDetailController),ProductDetailController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","TipService","$timeout","$filter"]}(),function(){function ProductKangLeController($state,$ionicModal,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,rootScope,PolicyService,TipService,$timeout,$filter,VALIDATION,$ionicScrollDelegate,$anchorScroll,MallCommonService,$ionicPopup,$window){$scope.id=$state.params.id,$scope.modelFlag=!1,$scope.btnFlag=!1,$scope.longActive="2",$scope.sexChecked="1",$scope.payChecked="12",$scope.feeChecked="10",$scope.termChecked="70",$scope.money={},$scope.money.moneyChecked=15e4,$scope.money.insurerBirthDay=null,$scope.exp="--",$scope.money.isBatts=!0,$scope.moneySelect=!1,$scope.navFalg=!1,$scope.checkFlag=!0,$scope.newRule=!1,"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||($scope.newRule=!0),$scope.getMaxbirth=function(){var flag_age=VALIDATION.getDateByAge("18"),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()<10?"0"+(new Date).getDate():(new Date).getDate();$scope.maxEndDate=nowy+"-"+nowm+"-"+nowd},$scope.getMinbirth=function(){var flag_age=VALIDATION.getDateByAge("55"),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()+1<10?"0"+((new Date).getDate()+1):(new Date).getDate()+1;$scope.minStartDate=nowy+"-"+nowm+"-"+nowd},$scope.getMaxbirth(),$scope.getMinbirth(),$scope.getProductDetail=function(id){var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){1==result.status&&($scope.productData=result.data,PolicyService.setSessionData({productData:result.data}))})},$scope.getProductDetail($scope.id),$scope.sexCheck=function(sexChecked){$scope.sexChecked=sexChecked},$scope.payCheck=function(payChecked){$scope.payChecked=payChecked},$scope.feeCheck=function(feeChecked){$scope.feeChecked=feeChecked},$scope.termCheck=function(termChecked){$scope.termChecked=termChecked},$scope.moneyCheck=function(moneyChecked){$scope.moneySelect=!1,$scope.money.moneyChecked=moneyChecked},$scope.moneyCheckOther=function(){$scope.money.moneyChecked=15e4,$scope.moneySelect=!0},$scope.navCheck=function(tab,tabid){$scope.longActive=tab,$scope.slideTo(tabid)},$scope.slideTo=function(location){var location=$location.hash(location);$ionicScrollDelegate.$getByHandle("dashboard").anchorScroll("#"+location)},$scope.backTop=function(){$ionicScrollDelegate.$getByHandle("dashboard").scrollTop(!0)},$scope.showFlag=!1;var topPositon;$scope.showBack=function(){topPositon=$ionicScrollDelegate.getScrollPosition().top,topPositon>1400?($scope.showFlag=!0,$scope.$apply()):($scope.showFlag=!1,$scope.$apply()),1100>topPositon&&($scope.navFalg=!1,$scope.longActive="2"),topPositon>=1100&&($scope.navFalg=!0,$scope.longActive="2"),topPositon>=1660&&($scope.navFalg=!0,$scope.longActive="3"),topPositon>=2010&&($scope.navFalg=!0,$scope.longActive="4")},$scope.reduceFn=function(){$scope.money.moneyChecked>15e4&&($scope.money.moneyChecked=Number($scope.money.moneyChecked)-1e4)},$scope.addFn=function(){$scope.money.moneyChecked>=15e4&&($scope.money.moneyChecked=Number($scope.money.moneyChecked)+1e4)},$scope.hideError=function(){$scope.lengthShow=!1,$scope.formatShow=!1},$scope.openSafe=function(){$scope.showModal_hmrc("app/module/mall/product/product-kangLe/popup/safe.html")},$scope.openSafe1=function(){$scope.showModal_hmrc("app/module/mall/product/product-kangLe/popup/optional.html")},$scope.showModal_hmrc=function(url,animation){var self=$rootScope;$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),$rootScope.$on("$stateChangeStart",function(){self.modal.remove()}),self.close=function(){self.modal.remove()}})},$scope.showModel=function(){$scope.modelFlag=!$scope.modelFlag},$scope.$watch("money.insurerBirthDay + sexChecked + payChecked + feeChecked + termChecked + money.moneyChecked + money.isBatts",function(){$timeout(function(){if($scope.money.moneyChecked<15e4?($scope.lengthShow=!0,$timeout(function(){$scope.lengthShow=!1},1500)):$scope.money.moneyChecked%1e4!=0&&($scope.formatShow=!0,$timeout(function(){$scope.formatShow=!1},1500)),$scope.age=VALIDATION.getAgeByBirth($scope.money.insurerBirthDay),$scope.btnFlag=!1,("10"==$scope.feeChecked&&$scope.age>46&&$scope.age<=56||"15"==$scope.feeChecked&&$scope.age>44&&$scope.age<50||"20"==$scope.feeChecked&&$scope.age>40&&$scope.age<45)&&($scope.btnFlag=!0,$scope.checkFlag?($scope.termChecked="80",$scope.checkFlag=!1):$scope.termChecked=$scope.termChecked),"10"==$scope.feeChecked){if($scope.age>46&&"70"==$scope.termChecked)return $ionicPopup.alert({title:"温馨提示",template:"被保人年龄大于或等于47周岁，缴费期间为10年，保险期间“至70周岁”不可选择，其余可选择！",okText:"我知道了"}),void($scope.exp="--");if($scope.age>55&&("80"==$scope.termChecked||"88"==$scope.termChecked))return $ionicPopup.alert({title:"温馨提示",template:"已超出该区间的保险范围！",okText:"我知道了"}),void($scope.exp="--")}if("15"==$scope.feeChecked){if($scope.age>44&&$scope.age<50&&"70"==$scope.termChecked)return $ionicPopup.alert({title:"温馨提示",template:"被保人年龄大于或等于45周岁且小于或等于50周岁，缴费期间为15年，保险期间“至70周岁”不可选择，其余可选择！",okText:"我知道了"}),void($scope.exp="--");if($scope.age>50&&("80"==$scope.termChecked||"88"==$scope.termChecked))return $ionicPopup.alert({title:"温馨提示",template:"已超出该区间的保险范围，请重新选择缴费期间10年！",okText:"我知道了"}),void($scope.exp="--")}if("20"==$scope.feeChecked){if($scope.age>40&&$scope.age<=45&&"70"==$scope.termChecked)return $ionicPopup.alert({title:"温馨提示",template:"被保人年龄大于或等于41周岁且小于或等于45周岁，缴费期间为20年，保险期间“至70周岁”不可选择，其余可选择！",okText:"我知道了"}),void($scope.exp="--");if($scope.age>45&&$scope.age<=50&&("80"==$scope.termChecked||"88"==$scope.termChecked))return $ionicPopup.alert({title:"温馨提示",template:"已超出该年龄的缴费期间，请重新选择10年或者15年！",okText:"我知道了"}),void($scope.exp="--");if($scope.age>50&&("80"==$scope.termChecked||"88"==$scope.termChecked))return $ionicPopup.alert({title:"温馨提示",template:"已超出该年龄的缴费期间，请重新选择10年！",okText:"我知道了"}),void($scope.exp="--")}return $scope.money.moneyChecked<15e4?($scope.lengthShow=!0,void $timeout(function(){$scope.lengthShow=!1},1500)):$scope.money.moneyChecked%1e4!=0?($scope.formatShow=!0,void $timeout(function(){$scope.formatShow=!1},1500)):void($scope.money.insurerBirthDay&&$scope.calc($scope.calcAdd))},50)}),$scope.calcAdd=function(){$scope.money.isBatts&&($scope.calcParams={prdCode:"DDSL",prdName:$scope.productData.prd_title,insurerBirthDay:$filter("date")($scope.money.insurerBirthDay,"yyyyMMdd"),insuredDays:$scope.termChecked,insuYearFlag:"Y",planCode:"ENQL_01",channel:CONFIG.SALE_CHANNEL,sex:$scope.sexChecked,paymentType:$scope.payChecked,PbInsuAmt:$scope.money.moneyChecked,payendyear:$scope.feeChecked},CommonRequest.request($scope.calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");$scope.exp=(Number($scope.mainexp)+Number(amountExp[0])).toFixed(2),$scope.amount=amountExp[1]}result.data.redisKey&&($scope.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}}));var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:$scope.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");
$scope.exp=(Number($scope.mainexp)+Number(amountExp[0])).toFixed(2),$scope.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&($scope.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}},$scope.calc=function(callback){$scope.calcParam={prdCode:$scope.productData.prd_code,prdName:$scope.productData.prd_title,insurerBirthDay:$filter("date")($scope.money.insurerBirthDay,"yyyyMMdd"),insuredDays:$scope.termChecked,insuYearFlag:"Y",planCode:"ENQL_01",channel:CONFIG.SALE_CHANNEL,sex:$scope.sexChecked,paymentType:$scope.payChecked,PbInsuAmt:$scope.money.moneyChecked,payendyear:$scope.feeChecked},CommonRequest.request($scope.calcParam,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");$scope.mainexp=amountExp[0],$scope.amount=amountExp[1],$scope.exp=$scope.mainexp,angular.isFunction(callback)&&callback()}result.data.redisKey&&($scope.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:$scope.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");$scope.mainPlan.exp=amountExp[0],$scope.mainPlan.amount=amountExp[1],checkPremiumNum=0,angular.isFunction(callback)&&callback()}result.data.redisKey&&($scope.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}}}angular.module("app").controller("ProductKangLeController",ProductKangLeController),ProductKangLeController.$inject=["$state","$ionicModal","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$rootScope","PolicyService","TipService","$timeout","$filter","VALIDATION","$ionicScrollDelegate","$anchorScroll","MallCommonService","$ionicPopup","$window"]}(),function(){function ProductLasyDetailController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,rootScope,PolicyService,TipService,$timeout,$filter,VALIDATION,$ionicScrollDelegate,$anchorScroll,COMMON){function evalFun(bodyContent){var regDetectJs=/<script(.|\n)*?>(.|\n|\r\n)*?<\/script>/gi,jsContained=bodyContent.match(regDetectJs);if(jsContained){for(var regGetJS=/<script(.|\n)*?>((.|\n|\r\n)*)?<\/script>/im,jsNums=jsContained.length,i=0;jsNums>i;i++){var jsSection=jsContained[i].match(regGetJS);jsSection[2]&&(window.execScript?window.execScript(jsSection[2]):window.eval(jsSection[2]))}$timeout(function(){vm.navLinkFun=function(){if(document.querySelectorAll("#prd_content .content a[name='tab2']+p")[0]&&vm.maDetail[0]){var navPTK=document.querySelectorAll("#prd_content .content a[name='tab2']+p"),navLink=navPTK[0].lastElementChild;navLink.onclick=function(){window.open(vm.maDetail[0].materialPath,"_blank")}}},vm.navLinkFun()},100)}}var vm=this,userData=PolicyService.getSessionData().userData;vm.id=$state.params.id,vm.salesId=$state.params.salesId,vm.parentSalesId=$state.params.parentSalesId,vm.salesLevel=$state.params.salesLevel,vm.newSaleChnl=$state.params.saleChnl,vm.salerId=$state.params.salerId,vm.activityId=$state.params.activityId,vm.newRule=!1,vm.chooseAgeShow=!1,localStorage.getItem("channelLogo")&&(CONFIG.SALE_CHANNEL=$rootScope.SALE_CHANNEL=localStorage.getItem("channelLogo"),CONFIG.NEW_SALE_CHANNEL=CONFIG.SALE_CHANNEL),"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.mainPlan={rate:0,amount:0,exp:0},vm.priChecked=!1,vm.priInfo={isMedic:"",securityAge:"",planType:"1",secOneImg:""},vm.planImg=!0,vm.user={},vm.user.age=null,vm.mainPlan.amount=1e6,vm.mainPlan.socialSecurity="Y",vm.ifShowInfo0=!1,vm.ifShowInfo1=!1,$scope.$watch("hmra.user.age",function(newValue){newValue&&(vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex&&vm.mainPlan.amount&&vm.calc(vm))}),vm.navActiveCss=function(index,amount,socialSecurity){for(var normalNav=document.getElementsByName("nav"),i=0;i<normalNav.length;i++)normalNav[i].className="normal-nav",normalNav[0].style.marginLeft="0px",i==index&&(normalNav[i].className="active-nav");vm.mainPlan.amount=amount,vm.mainPlan.socialSecurity=socialSecurity,vm.showInfoStr(amount,socialSecurity),vm.setPlan()},$scope.initAgePicker=function(){COMMON.getCommonData().AGE_RANGE_LIST&&(vm.ageRangeList=COMMON.getCommonData().AGE_RANGE_LIST)},$scope.initAgePicker(),vm.upagerange=function(){return!1},vm.upagerange1=function(){return vm.priInfo.secOneImg=!0,!1},vm.priMedic=function(medic){vm.priInfo.isMedic=medic,"1"==medic?(vm.medicOneImg=!vm.medicOneImg,vm.medicTwoImg=!1):(vm.medicOneImg=!1,vm.medicTwoImg=!vm.medicTwoImg),vm.medicOneImg||vm.medicTwoImg||(vm.priInfo.isMedic="")},vm.prisecurityAge=function(securityAge){"1"==securityAge?(vm.priInfo.secOneImg=!vm.priInfo.secOneImg,vm.secTwoImg=!1):vm.priInfo.secOneImg=!1},vm.choosePlan=function(){"1"==vm.priInfo.planType?(vm.priInfo.planType="0",vm.planImg=!1):(vm.priInfo.planType="1",vm.planImg=!0)},vm.totalMount=0,vm.getJson=function(){var getRateList={url:"../statics/json/rate_hmra.json",method:"GET"};CommonRequest.request({},getRateList,function(result){vm.rateList=result})},vm.getJson(),vm.calculate11=function(newValue){var tempRateList;if(newValue.isMedic&&newValue.secOneImg&&"1"==newValue.planType){tempRateList="1"==newValue.isMedic?vm.rateList.data.rateList_100_Y:vm.rateList.data.rateList_100_N;for(var i=0;i<tempRateList.length;i++)tempRateList[i].age==newValue.securityAge&&(vm.totalMount=tempRateList[i].charge)}else vm.totalMount=0},vm.calculate=function(newValue){if(newValue.isMedic&&newValue.secOneImg&&"1"==newValue.planType)for(var i=0;i<vm.ageRangeList.length;i++)vm.ageRangeList[i].value==newValue.securityAge&&("1"==newValue.isMedic?vm.totalMount=$scope.rateList1[i]:vm.totalMount=$scope.rateList2[i]);else vm.totalMount=0},$scope.$watch("productLaysDetail.priInfo",function(newValue){newValue&&vm.calculate11(newValue)},!0),vm.chooseAge=function(){},vm.cancelChooseAge=function(){vm.chooseAgeShow=!1},vm.newSaleChnl&&vm.newSaleChnl.length>0&&(CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl),"false"==vm.buttonShow?(vm.nextButton=!1,PolicyService.control({state:$state.current.name,control:"data",data:{buttonShow:vm.buttonShow}})):vm.nextButton=!0,vm.salesId&&PolicyService.control({state:$state.current.name,control:"data",data:{salesId:vm.salesId}}),vm.parentSalesId&&PolicyService.control({state:$state.current.name,control:"data",data:{parentSalesId:vm.parentSalesId}}),vm.salesLevel&&PolicyService.control({state:$state.current.name,control:"data",data:{salesLevel:vm.salesLevel}}),vm.newSaleChnl&&PolicyService.control({state:$state.current.name,control:"data",data:{newSaleChnl:vm.newSaleChnl}}),vm.salerId&&PolicyService.control({state:$state.current.name,control:"data",data:{salerId:vm.salerId}}),vm.activityId&&PolicyService.control({state:$state.current.name,control:"data",data:{activityId:vm.activityId}}),vm.channelCode=CONFIG.SALE_CHANNEL,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)},vm.navActiveCss=function(index,amount,socialSecurity){for(var normalNav=document.getElementsByName("nav"),i=0;i<normalNav.length;i++)normalNav[i].className="normal-nav",normalNav[0].style.marginLeft="0px",i==index&&(normalNav[i].className="active-nav");vm.mainPlan.amount=amount,vm.mainPlan.socialSecurity=socialSecurity,vm.showInfoStr(amount,socialSecurity),vm.setPlan()},vm.jumpPrimary=function(){alert("跳转基本信息页面"),$state.go("product-purchase-policy-info")},vm.goProductContent=function(){$location.hash("tabContent"),$anchorScroll()},vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;if(vm.productData){var payTypeConfigs=(vm.productData.prdDetails,vm.productData.prdPayments,vm.productData.payTypeConfigs);if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),vm.changePayAge()}PolicyService.control({state:$state.current.name,control:"data",data:vm.productData}),$timeout(function(){$rootScope.showProductDialog=!0},100)}vm.getProductMaterials(),vm.getProductToken()}if(vm.productData){var second=vm.productData.tag_name[0],secondLink=vm.productData.tag_code[0],third=vm.productData.prd_title;$rootScope.$broadcast("refresh-location",{second:second,secondLink:"product-list({tag:"+secondLink.substr(secondLink.length-1,1)+"})",third:third})}$rootScope.$broadcast("scroll.refreshComplete"),vm.handleCalculate(PolicyService.getSessionData().productData),vm.handlePrdContent(PolicyService.getSessionData().productData)})},vm.longActive=1,vm.goToTab=function(val){var name="tab"+(val-1);$anchorScroll(name),vm.longActive=val},vm.handlePrdContent=function(productData){CommonRequest.request({},{url:$filter("iframeFilter")(productData.prd_id),method:"GET"},function(result){if(result){var regBody=/<body[^>]*>([\s\S]*)<\/body>/,bodyContent=regBody.exec(result);bodyContent&&2==bodyContent.length&&(bodyContent=bodyContent[1]),angular.element(document.querySelector("#prd_content")).html(bodyContent),evalFun(bodyContent)}})},vm.showInfoContent=function(index){0==index?vm.ifShowInfo0?vm.ifShowInfo0=!1:vm.ifShowInfo0=!0:1==index&&(vm.ifShowInfo1?vm.ifShowInfo1=!1:vm.ifShowInfo1=!0)},vm.handleCalculate=function(productData){var payTypeConfigs=productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.getPlan=function(){for(var plan=productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=productData.payment_type,vm.payAge=productData.pay_age,vm.setPlan=function(){if(vm.chosePlanFlag=vm.mainPlan.amount/1e6-1,vm.productData.plans&&productData.plans.length>0)for(var i=0;i<productData.plans.length;i++)vm.chosePlanFlag==i&&(vm.selectedPlans=productData.plans[i],angular.extend(vm.mainPlan,vm.selectedPlans));vm.user.birthdayfm&&vm.user.sex&&vm.calc(vm)},vm.setPlan(),vm.showInfoStr=function(amount,socialSecurity){vm.amountStr=amount/1e4+"万",vm.doubleAmountStr=amount/1e4*2+"万"},vm.showInfoStr(vm.mainPlan.amount,vm.mainPlan.socialSecurity),vm.calc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:productData.prd_code,prdName:productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:vm.mainPlan.socialSecurity,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.productData.token,vm.goPolicy=function(){var params={prdId:productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:vm.mainPlan.socialSecurity,calc:vm.calc.toString(),calcCtrl:vm}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}},vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()};var times=0;vm.loadingPage=function(ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage())},2e3))},vm.loadingPage($rootScope),vm.getLotCode=function(callback){if("tacb"==vm.productData.templateCode.toLowerCase()&&"Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:$state.current.name,control:"data",data:{token:"",lotCode:""}})})},vm.planCheck=function(){vm.planChecked="1",vm.planDet=!1,vm.planMoney="50万元",vm.planOneImg=!0,vm.planTwoImg=!1},vm.getQuestionMore=function(){"false"==vm.proFotterShow?vm.proFotterShow=!1:vm.proFotterShow=!0},vm.planChecked="0",vm.planOneCheck=function(){vm.planChecked="1"},vm.planTwoCheck=function(){vm.planChecked="2"},vm.ageChecked="0",vm.ageOneCheck=function(){vm.ageChecked="1"},vm.ageMoreCheck=function(){vm.ageChecked="2"},vm.getQuestionMoreClose=function(){"true"==vm.proFotterShow?vm.proFotterShow=!0:vm.proFotterShow=!1},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):void PolicyService.control({state:$state.current.name,control:"data",data:{token:token,lotCode:data.lotCode}})}))})},vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){1==result.status&&(vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val})))})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.getProductMaterialsWithoutCache=function(){PolicyService.getMaterialsWithoutCache({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.requestWithoutCache(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.backTop=function(){$ionicScrollDelegate.scrollTop(),vm.longActive="1"},vm.process=function(){return vm.newSaleChnl&&vm.productData.orderCode&&vm.productData.orderCode>0&&PolicyService.setSessionData({productData:{orderCode:null}}),"TAC"==vm.productData.templateCode&&$rootScope.isLogin&&"A"!=userData.cretType?void TipService.showMsg($rootScope.TIPS.PRODUCT.TAC_CERTTYPE_FAILED):(PolicyService.control({state:$state.current.name,control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:vm.mainPlan.socialSecurity,calc:vm.calculate.toString(),calcCtrl:vm}}),PolicyService.setSessionData({insureData:{PbInsuExp:vm.totalMount,paymentType:vm.paymentType}}),void PolicyService.control({state:$state.current.name,control:"process"}))},vm.laysBzxqwhp1=!1,vm.laysBzxqwhp2=!1,vm.laysBzxqwh1=function(){vm.laysBzxqwhp1=!vm.laysBzxqwhp1},vm.laysBzxqwh2=function(){vm.laysBzxqwhp2=!vm.laysBzxqwhp2},$scope.$on("agePickerCallback",function(event,data){vm.priInfo.securityAge=data[0].value,vm.priInfo.secOneImg=!0}),vm.ifNavFloTrue=!1,vm.scroll=function(){var navScrollTop=document.querySelector(".fxm-lays1").scrollTop,h1=document.getElementById("heightBox").offsetHeight,timer=$timeout(function(){navScrollTop>=h1?(vm.ifNavFloTrue=!0,document.getElementById("prd_content").style.marginTop="44px"):(vm.ifNavFloTrue=!1,document.getElementById("prd_content").style.marginTop=0),$timeout.cancel(timer)},50)}}angular.module("app").controller("ProductLaysDetailController",ProductLasyDetailController),ProductLasyDetailController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$rootScope","PolicyService","TipService","$timeout","$filter","VALIDATION","$ionicScrollDelegate","$anchorScroll","COMMON"]}(),function(){function ProductListController($state,$rootScope,CommonRequest,CONFIG,$filter,$timeout,$window,PolicyService){var vm=this;vm.tag=$state.params.tag||1,vm.newDate=(new Date).getTime(),vm.prdSubscribe=[],$rootScope.phoneAuth=!1;var sessionPicuterData=sessionStorage.getItem("elife-overPicuter")||{};sessionPicuterData?"[object Object]"===Object.prototype.toString.call(sessionPicuterData)?vm.picuter={}:vm.picuter=JSON.parse(sessionPicuterData).picuter:vm.picuter={},vm.getList=function(tag){if(vm.products=[],tag){vm.tag=tag;var prdTagCode="TAG000"+vm.tag,params={prdTagCode:"TAG000"+vm.tag,beginPage:vm.currentPage};CommonRequest.request(params,CONFIG.PRODUCT_LIST_SERVICE,function(result){if(1==result.status){for(var list=result.data,i=0;i<list.length;i++)for(var tagCodeList=list[i].tag_code,j=0;j<tagCodeList.length;j++)prdTagCode==tagCodeList[j]&&vm.products.push(list[i]);$timeout(function(){vm.products&&vm.products.forEach(function(item1,index){if(1==$rootScope.nowStatus&&"[object Array]"===Object.prototype.toString.call(vm.picuter)&&vm.picuter[0]){vm.picuter.map(function(item2,index){if(item1.prd_code==item2.prdCode)for(var i=0;i<item2.picInfo.length;i++)"1"==item2.picInfo[i].picLocation?item1.onePicuter=item2.picInfo[i].prdPic:"2"==item2.picInfo[i].picLocation?item1.twoPicuter=item2.picInfo[i].prdPic:"3"==item2.picInfo[i].picLocation&&(item1.threePicuter=item2.picInfo[i].prdPic)})}})},0);for(var i=0;i<vm.products.length;i++)if(1==vm.products[i].subst&&"Y"==vm.products[i].basicProfile.P024&&vm.products[i].prdSubscribe){var preEndDate=new Date(vm.products[i].prdSubscribe[0].preEndDate),preEndDateY=preEndDate.getFullYear(),preEndDateM=preEndDate.getMonth()+1,preEndDateD=preEndDate.getDate();preEndDate=preEndDateY+"/"+preEndDateM+"/"+preEndDateD+" 23:59:59",preEndDate=new Date(preEndDate).getTime(),preEndDate>vm.newDate&&vm.newDate>vm.products[i].prdSubscribe[0].preStartDate?vm.products[i].bespakFlay=!0:vm.products[i].bespakFlay=!1}}$rootScope.$broadcast("scroll.refreshComplete")})}vm.getPrepareSalePrd()},vm.getPrdStatus=function(prdList){for(var prdIdList=[],k=0;k<prdList.length;k++)prdIdList.push(prdList[k].id);var params={prdIds:prdIdList};CommonRequest.request(params,CONFIG.PRD_STATUS_SERVICE,function(result){if(1==result.status)for(var prdStatusList=result.data,m=0;m<prdStatusList.length;m++)for(var n=0;n<vm.products.length;n++)prdStatusList[m].prdId==vm.products[n].id&&(vm.products[n].hasDiscount=prdStatusList[m].hasDiscount,vm.products[n].prd_sale_code=prdStatusList[m].prdSaleCode,vm.products[n].saleAvailFlag=prdStatusList[m].saleAvailFlag)})},vm.getListWithoutCache=function(tag){if(tag){vm.tag=tag;var params={prdTagCode:"TAG000"+vm.tag,beginPage:vm.currentPage};CommonRequest.requestWithoutCache(params,CONFIG.PRODUCT_LIST_SERVICE,function(result){1==result.status&&(vm.products=result.data),$rootScope.$broadcast("scroll.refreshComplete")})}},vm.getPrepareSalePrd=function(){var params={};CommonRequest.request(params,CONFIG.NEW_SYSPARAM_PREPARESALEPRD,function(result){if(1==result.status&&result.data)for(var m=0;m<result.data.length;m++)for(var n=0;n<vm.products.length;n++)if(result.data[m].prdId==vm.products[n].id){var date=$filter("date")(new Date,"yyyyMMdd");date-result.data[m].effectiveTime<0&&(vm.products[n].prepareSalePrd="1")}})},vm.jumpPrdDetail=function(id,PA001,isMarketingStatus,PA003,prdCode,P021,PA004){return"ENQL"==prdCode?void $state.go("product-kangLe",{id:id}):"HMRE"==prdCode||"HMRFa"==prdCode?void $state.go("product-hmrfa-hmre-calculate",{id:id}):"BEDH"==prdCode?void $state.go("product-bedh",{id:id}):"Y"==PA001?void $state.go("product-purchase-policy-activity",{id:id}):"Y"==PA003?void $state.go("product-share",{id:id}):"Y"==PA004?void $state.go("product-purchase-calculate-jipaa",{id:id}):"HMRA"==prdCode?void $state.go("product-lays",{id:id}):"GHMB"==prdCode&&"Y"==P021?void $state.go("product-optimze",{id:id}):"HMRCa"==prdCode?void $state.go("product-hmrc-calculate",{id:id}):"GDDC"==prdCode?void $state.go("product-ankang-info",{id:id}):void $state.go("product-detail",{id:id})},vm.loadingPage=function(){$timeout(function(){$rootScope.loadingPage?vm.getKgBTn(function(){vm.getList(vm.tag)}):vm.loadingPage()},100)},vm.getKgBTn=function(callback){var now_status=sessionStorage.getItem("elife_nowStatus");now_status?("1"==now_status?(vm.nowStatus=1,$rootScope.nowStatus=1):vm.nowStatus=0,callback()):CommonRequest.request({},CONFIG.GET_THREE_PICUTER,function(result){1==result.status&&($rootScope.nowStatus=result.data,1==$rootScope.nowStatus?($rootScope.nowStatus=1,vm.nowStatus=1):vm.nowStatus=0),callback()})},vm.loadingPage()}angular.module("app").controller("ProductListController",ProductListController),ProductListController.$inject=["$state","$rootScope","CommonRequest","CONFIG","$filter","$timeout","$window","PolicyService"]}(),function(){function ProductOptimzeController($state,VALIDATION,$document,GroupPolicyService,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicPopup,COMMON){var vm=this,userData=PolicyService.getSessionData().userData;GroupPolicyService.getSessionData();vm.user={},vm.user.securityAge=null,vm.nextStep=!0,vm.nextStep=!0,vm.ifShowInfo0=!1,vm.ifShowInfo1=!1,vm.id=$state.params.id,vm.buttonShow=$state.params.buttonShow,vm.salesId=$state.params.salesId,vm.parentSalesId=$state.params.parentSalesId,vm.salesLevel=$state.params.salesLevel,vm.newSaleChnl=$state.params.saleChnl,vm.salerId=$state.params.salerId,vm.newRule=!1,vm.activityId=$state.params.activityId,"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.ageRangeList=COMMON.getCommonData().AGE_RANGE_LIST.slice(0,10),vm.newSaleChnl&&vm.newSaleChnl.length>0&&(CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl),"false"==vm.buttonShow?(vm.nextButton=!1,PolicyService.control({state:$state.current.name,control:"data",data:{buttonShow:vm.buttonShow}})):vm.nextButton=!0,vm.salesId&&PolicyService.control({state:$state.current.name,control:"data",data:{salesId:vm.salesId}}),vm.parentSalesId&&PolicyService.control({state:$state.current.name,control:"data",data:{parentSalesId:vm.parentSalesId}}),vm.salesLevel&&PolicyService.control({state:$state.current.name,control:"data",data:{salesLevel:vm.salesLevel}}),vm.newSaleChnl&&PolicyService.control({state:$state.current.name,control:"data",data:{newSaleChnl:vm.newSaleChnl}}),vm.salerId&&PolicyService.control({state:$state.current.name,control:"data",data:{salerId:vm.salerId}}),vm.activityId&&PolicyService.control({state:$state.current.name,control:"data",data:{activityId:vm.activityId}}),vm.channelCode=CONFIG.SALE_CHANNEL,vm.byjBzxqcss=!1,vm.byjBzxq=document.querySelector(".byj-bzxq"),vm.byjBzxq.offsetWidth>370?vm.byjBzxqcss=!0:vm.byjBzxqcss=!1,vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;if(vm.productData){var payTypeConfigs=(vm.productData.prdDetails,vm.productData.prdPayments,vm.productData.payTypeConfigs);if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),vm.changePayAge()}PolicyService.control({state:$state.current.name,control:"data",data:vm.productData}),$timeout(function(){$rootScope.showProductDialog=!0},100)}vm.getProductMaterials(),vm.getProductToken(),vm.getAll(vm.productData),vm.getPremium(vm.productData)}if(vm.productData){var second=vm.productData.tag_name[0],secondLink=vm.productData.tag_code[0],third=vm.productData.prd_title;$rootScope.$broadcast("refresh-location",{second:second,secondLink:"product-list({tag:"+secondLink.substr(secondLink.length-1,1)+"})",third:third})}$rootScope.$broadcast("scroll.refreshComplete")})},vm.getJson=function(){var getRateList={url:"../statics/json/rate_ghmb.json",method:"GET"};CommonRequest.request({},getRateList,function(result){vm.rateList=result,PolicyService.setSessionData({insureData:{rateList:vm.rateList}})})},vm.getJson(),vm.getAll=function(productData){function evalFun(bodyContent){var regDetectJs=/<script(.|\n)*?>(.|\n|\r\n)*?<\/script>/gi,jsContained=bodyContent.match(regDetectJs);if(jsContained){for(var regGetJS=/<script(.|\n)*?>((.|\n|\r\n)*)?<\/script>/im,jsNums=jsContained.length,i=0;jsNums>i;i++){var jsSection=jsContained[i].match(regGetJS);jsSection[2]&&(window.execScript?window.execScript(jsSection[2]):window.eval(jsSection[2]))}$timeout(function(){vm.navLinkFun=function(){if(document.querySelectorAll("#case p")&&vm.maDetail[0]){var navPTK=document.querySelectorAll("#case p"),navLink=navPTK[0].lastElementChild;navLink.onclick=function(){window.open(vm.maDetail[0].materialPath,"_blank")}}},vm.navLinkFun()},100)}}productData?vm.tabs=productData.tabs:$state.go("tab.mall"),"false"==productData.buttonShow?vm.nextButton=!1:vm.nextButton=!0,vm.tab=0,vm.getHtml=function(){CommonRequest.request({},{url:$filter("iframeFilter")(vm.productData.prd_id),method:"GET"},function(result){if(result){var regBody=/<body[^>]*>([\s\S]*)<\/body>/,bodyContent=regBody.exec(result);bodyContent&&2==bodyContent.length&&(bodyContent=bodyContent[1]),angular.element(document.querySelector("#content")).html(bodyContent),evalFun(bodyContent)}})},vm.getHtml()},vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){
for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()};var times=0;vm.loadingPage=function(ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage())},2e3))},vm.loadingPage($rootScope),vm.getLotCode=function(callback){if("tacb"==vm.productData.templateCode.toLowerCase()&&"Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:$state.current.name,control:"data",data:{token:"",lotCode:""}})})},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):void PolicyService.control({state:$state.current.name,control:"data",data:{token:token,lotCode:data.lotCode}})}))})},vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.getProductMaterialsWithoutCache=function(){PolicyService.getMaterialsWithoutCache({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.requestWithoutCache(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.control({state:$state.current.name,control:"data",data:{materials:materials}})})},vm.process=function(){PolicyService.control({state:$state.current.name,control:"data",data:{plchdBrthDt:$filter("date")(vm.priInfo.birthday,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredList:vm.insuredList,totalInsCvr:vm.totalInsCvr,insCvr:vm.insCvr,rateList:vm.rateList,groupProName:vm.productData.prd_title,pbApplNoNum:"1",params:vm.params}}),PolicyService.control({state:$state.current.name,control:"process"})},vm.backTop=function(){$ionicScrollDelegate.scrollTop()},vm.getYearMore=function(){},vm.getQuestionMore=function(){"false"==vm.proFotterShow?vm.proFotterShow=!1:vm.proFotterShow=!0},vm.getQuestionMoreClose=function(){"true"==vm.proFotterShow?vm.proFotterShow=!0:vm.proFotterShow=!1},vm.getPremium=function(productData){vm.hasSpecial=!0;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.minHolderAge,vm.maxAge=payTypeConfig.maxHolderAge}VALIDATION.getDateByAge("23"),VALIDATION.getDateByAge("0");vm.planChecked="",vm.planDet=!1,vm.planMoney="50万元",vm.nextStep=!1,vm.planOneCheck=function(){vm.planChecked="1",vm.planDet=!1,vm.planMoney="50万元",vm.planOneImg=!0,vm.planTwoImg=!1},vm.planTwoCheck=function(){vm.planChecked="2",vm.planDet=!1,vm.planMoney="100万元",vm.planOneImg=!1,vm.planTwoImg=!0},vm.planType="",vm.planOneImg=!1,vm.planTwoImg=!1,vm.choosePlan=function(plan){vm.planType=plan,"1"==plan?(vm.planOneImg=!vm.planOneImg,vm.planTwoImg=!1):(vm.planTwoImg=!vm.planTwoImg,vm.planOneImg=!1),vm.planOneImg||vm.planTwoImg||(vm.planType="")},$scope.$watch("ProductOptimze.planType",function(newValue){vm.priInfo.planType=newValue;for(var i=vm.secInfo.length-1;i>=0;i--)vm.secInfo[i].planType=newValue},!0),vm.slideUp=function(){vm.planDet=!1},vm.priInfo={isMedic:"",securityAge:"30-34",secOneImg:!1,planType:"",priMount:0,priChecked:!1},vm.priMedic=function(medic){vm.priInfo.isMedic=medic,"1"==medic?(vm.medicOneImg=!vm.medicOneImg,vm.medicTwoImg=!1):(vm.medicOneImg=!1,vm.medicTwoImg=!vm.medicTwoImg),vm.medicOneImg||vm.medicTwoImg||(vm.priInfo.isMedic="")},vm.prisecurityAge=function(securityAge){"1"==securityAge?(vm.priInfo.secOneImg=!vm.priInfo.secOneImg,vm.secTwoImg=!1):vm.secOneImg=!1},vm.secList=[{id:1,trashShow:!1,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:0,ifSelect:!1,ifSelectBtn:!0},{id:2,trashShow:!1,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:0,ifSelect:!1,ifSelectBtn:!0}],vm.secInfo=[{id:1,securityAge:"",isMedic:"",secMount:0,planType:"",secOneImg:!1,secIsShow:!1},{id:2,securityAge:"",isMedic:"",secMount:0,planType:"",secOneImg:!1,secIsShow:!1}],vm.secShow=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secIsShow=!vm.secList[i].secIsShow,vm.secInfo[i].secIsShow=!vm.secInfo[i].secIsShow;break}};var picker1=new Picker({data:[vm.ageRangeList]});picker1.on("picker.select",function(selectedVal,selectedIndex){$scope.$apply(function(){vm.priInfo.securityAge=vm.ageRangeList[selectedIndex[0]].text})}),vm.upagerange=function(){vm.priInfo.secOneImg=!0},vm.upagerange1=function(){vm.ifSelectBtn=!vm.ifSelectBtn,vm.ifSelect=!vm.ifSelect},vm.upagerangeOpt=function(){for(var i=0;i<vm.secList.length;i++)!function(index){var sec=i+1;$scope.$on("agePickerCallback"+sec,function(event,data){vm.secList[index].secOneImg=!0,vm.secList[index].securityAge=data[0].value,vm.secInfo[index].secOneImg=!0,vm.secInfo[index].securityAge=data[0].value})}(i)},vm.upagerangeOpt(),vm.upagerange1Opt=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secOneImg=!0,vm.secList[i].ifSelect=!vm.secList[i].ifSelect,vm.secList[i].ifSelectBtn=!vm.secList[i].ifSelectBtn;break}},vm.setsecurityAge=function(id,securityAge){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){var tempUser=vm.secList[i],tempInfo=vm.secInfo[i];tempInfo.securityAge=tempUser.securityAge,"1"==securityAge?(tempUser.secOneImg=!tempUser.secOneImg,tempInfo.secOneImg=tempUser.secOneImg,tempUser.secTwoImg=!1):(tempUser.secOneImg=!1,tempInfo.secOneImg=tempUser.secOneImg,tempUser.secTwoImg=!tempUser.secTwoImg),tempUser.secTwoImg||tempUser.secOneImg||(vm.secInfo[i].securityAge="");break}},vm.setpriMedic=function(id,medic){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){var tempUser=vm.secList[i],tempInfo=vm.secInfo[i];tempUser.isMedic=medic,tempInfo.isMedic=medic,"1"==medic?(tempUser.medicOneImg=!tempUser.medicOneImg,tempUser.medicTwoImg=!1):(tempUser.medicOneImg=!1,tempUser.medicTwoImg=!tempUser.medicTwoImg),tempUser.medicOneImg||tempUser.medicTwoImg||(tempUser.isMedic="",tempInfo.isMedic="");break}},vm.calcAll=function(priMount,secInfo){vm.totalPolicyMount=0,vm.totalPolicyMount=vm.totalPolicyMount+priMount;for(var i=vm.secInfo.length-1;i>=0;i--)vm.totalPolicyMount=vm.totalPolicyMount+secInfo[i].secMount},$scope.$watch("ProductOptimze.secList",function(newValue){if(newValue)for(var i=vm.secList.length-1;i>=0;i--)vm.secInfo[i].securityAge=vm.secList[i].securityAge},!0),$scope.$watch("ProductOptimze.secInfo",function(newValue){newValue&&vm.calculate11(newValue)},!0),vm.calculate=function(newValue){for(var i=0;i<newValue.length;i++){var policyUser=newValue[i];if(policyUser.secIsShow)if(policyUser.planType>0&&policyUser.isMedic>0&&policyUser.secOneImg)for(var j=vm.ageRangeList.length-1;j>=0;j--)vm.ageRangeList[j].value==policyUser.securityAge&&(vm.secInfo[i].secMount=$scope.rateList[policyUser.planType-1][policyUser.isMedic-1][j]);else vm.secInfo[i].secMount=0;else vm.secInfo[i].secMount=0,vm.secInfo[i].isMedic="",vm.secList[i].securityAge="30-34",vm.secList[i].secOneImg=!1,vm.secList[i].secTwoImg=!1,vm.secList[i].medicOneImg=!1,vm.secList[i].medicTwoImg=!1,vm.secInfo[i].securityAge="30-34",vm.secInfo[i].secOneImg=!1,vm.secInfo[i].secTwoImg=!1,vm.secInfo[i].medicOneImg=!1,vm.secInfo[i].medicTwoImg=!1;vm.secList[i].secMount=vm.secInfo[i].secMount}vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.calculate11=function(newValue){for(var i=0;i<newValue.length;i++){var policyUser=newValue[i];if(policyUser.secIsShow)if(policyUser.planType>0&&policyUser.isMedic>0&&policyUser.secOneImg)for(var rList=vm.getRateList(policyUser.planType,policyUser.isMedic),j=rList.length-1;j>=0;j--)rList[j].age==policyUser.securityAge&&(vm.secInfo[i].secMount=parseInt(rList[j].charge));else vm.secInfo[i].secMount=0;else vm.secInfo[i].secMount=0,vm.secInfo[i].isMedic="",vm.secList[i].securityAge="30-34",vm.secList[i].secOneImg=!1,vm.secList[i].secTwoImg=!1,vm.secList[i].medicOneImg=!1,vm.secList[i].medicTwoImg=!1,vm.secInfo[i].securityAge="30-34",vm.secInfo[i].secOneImg=!1,vm.secInfo[i].secTwoImg=!1,vm.secInfo[i].medicOneImg=!1,vm.secInfo[i].medicTwoImg=!1;vm.secList[i].secMount=vm.secInfo[i].secMount}vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.priInfo={isMedic:"",securityAge:"30-34",secOneImg:!1,planType:"",priMount:0,priChecked:!1},$scope.$watch("ProductOptimze.priInfo",function(newValue){newValue&&(newValue.priChecked?vm.calculate00(newValue):(vm.priInfo.securityAge="30-34",vm.priInfo.secOneImg=!1,vm.priInfo.isMedic="",vm.medicOneImg=!1,vm.medicTwoImg=!1,vm.priInfo.priMount=0))},!0),vm.calculate0=function(newValue){var isM=newValue.isMedic;if(newValue.planType>0&&isM>0&&newValue.secOneImg&&newValue.priChecked)for(var rList=$scope.rateList[newValue.planType-1][isM-1],i=0;i<=vm.ageRangeList.length-1;i++)vm.ageRangeList[i].text==newValue.securityAge&&(vm.priInfo.priMount=rList[i]);else vm.priInfo.priMount=0;vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.getRateList=function(planType,isMedic){return"1"==planType&&"1"==isMedic?vm.rateList.data.rateList_50_Y:"1"==planType&&"2"==isMedic?vm.rateList.data.rateList_50_N:"2"==planType&&"1"==isMedic?vm.rateList.data.rateList_100_Y:"2"==planType&&"2"==isMedic?vm.rateList.data.rateList_100_N:void 0},vm.calculate00=function(newValue){var isM=newValue.isMedic;if(newValue.planType>0&&isM>0&&newValue.secOneImg&&newValue.priChecked)for(var rList=vm.getRateList(newValue.planType,isM),i=0;i<=rList.length-1;i++)rList[i].age==newValue.securityAge&&(vm.priInfo.priMount=parseInt(rList[i].charge));else vm.priInfo.priMount=0;vm.calcAll(vm.priInfo.priMount,vm.secInfo)},vm.totalPolicyMount=0,vm.longActive=1,vm.goToTab=function(index){$location.hash("tab"+(index-1)),$anchorScroll(),vm.longActive=index},vm.goToContent=function(){$location.hash("content"),$anchorScroll()},vm.add=function(){var id=vm.secList[vm.secList.length-1].id+1;vm.secList.push({id:id,trashShow:!0,secIsShow:!1,securityAge:"30-34",isMedic:"",disabled:null,secOneImg:!1,secTwoImg:!1,secMount:0,ifSelect:!1,ifSelectBtn:!0}),vm.secInfo.push({id:id,securityAge:"",secOneImg:!1,isMedic:"",secMount:0,planType:vm.planType,secIsShow:!1}),vm.upagerangeOpt()},vm.del=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList.splice(i,1),vm.secInfo.splice(i,1),3==vm.secList.length&&vm.secList[i]&&(vm.secList[i].secIsShow=!vm.secList[i].secIsShow);break}},vm.secMate=function(id,relation){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].securityAge="";break}},vm.secMedic=function(id,medic){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].isMedic=medic,vm.secInfo[i].isMedic=medic,vm.secList[i].id==id&&"1"==medic?(vm.secmedicOneImg=!0,vm.secmedicTwoImg=!1):(vm.secmedicTwoImg=!0,vm.secmedicOneImg=!1);break}},vm.addPic=!0,$scope.$watch("ProductOptimze.secList.length",function(newValue){newValue>=4?vm.addPic=!1:vm.addPic=!0},!0);var params,insuredList=[],plans=[];vm.calCulateToBaoRen=function(){plans=1==vm.planChecked?vm.productData.plans[0]:vm.productData.plans[1],insuredList=[{rcgnNm:"0",rcgnBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),insuredSSflag:vm.priInfo.isMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]}];for(var i=0;i<vm.secList.length;i++)insuredList.push({rcgnNm:vm.secList[i].id.toString(),rcgnBrthDt:$filter("date")(vm.secList[i].securityAge,"yyyyMMdd"),insuredSSflag:vm.secList[i].isMedic,cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]});params={premiumAppEntity:{plchdBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredNum:insuredList.length,insuredList:insuredList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL},CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(result.data)})},vm.submitAccount=function(){},vm.upgrade=function(){$rootScope.isLogin&&"A"==userData.cretType?vm.checkUpgrade():$state.go("product-upgrade")},vm.checkUpgrade=function(){vm.getbirth=function(){var num=VALIDATION.getSex(userData.cretNo.replace(/\s/g,""));return num-1};var params={upgradeRequest:{plchdNm:userData.customerName,plchdGndCd:vm.getbirth(),plchdCrdtNo:userData.cretNo.replace(/\s/g,""),plchdBrthDt:VALIDATION.getBirthday(userData.cretNo.replace(/\s/g,"")),plchdCrdtTpCd:"A"}};vm.verToken="",vm.upgradeData="",CommonRequest.request(params,CONFIG.ID_UPGRADE_CHECK,function(result){1==result.status&&(vm.verToken=result.data,""!=vm.verToken&&(vm.getPolicyResultTimes=0,vm.getUpdatePolicyResult()))})},vm.getUpdatePolicyResult=function(){if(vm.getPolicyResultTimes++,vm.getPolicyResultTimes>CONFIG.CORE_DECOUPLING_TIMES){$ionicLoading.hide();$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"});return void(vm.getPolicyResultTimes=0)}CommonRequest.request({verToken:vm.verToken},CONFIG.ID_UPGRADE_CHECK_RESULT,function(qresult){if(1==qresult.status){var flg="data"in qresult;if(!flg)return void $timeout(function(){vm.getUpdatePolicyResult()},500);vm.getPolicyResultTimes=0,vm.upgradeData=qresult.data,vm.handleUpdateResult(vm.upgradeData)}})},vm.handleUpdateResult=function(updateData){if(updateData){var sysRespCode=updateData.sysRespCode,sysRespDesc=updateData.sysRespDesc;updateData.rcgnList;if("00000"==sysRespCode&&(vm.showError=!0,$timeout(function(){for(var insureData=[],i=updateData.rcgnList.length-1;i>=0;i--){var tempData=updateData.rcgnList[i];if("01"!=tempData.rcgnAndRcgnReTpCd){var policyUser={};policyUser.id=i+1,policyUser.confirmRela=tempData.rcgnAndRcgnReTpCd,policyUser.LiNationality="0156",policyUser.LiRcgnName=tempData.rcgnNm,policyUser.trashShow=!1,policyUser.LiRcgnMedic=tempData.rcgnSSFLAG,policyUser.LiRcgnIdType=tempData.rcgnCrdtTpCd,policyUser.LiRcgnId=tempData.rcgnCrdtNo,policyUser.LiRcgnBirdy=tempData.rcgnBrthDt,policyUser.LiRcgnSex=VALIDATION.getSex(tempData.rcgnCrdtNo)+"",policyUser.LiRcgnOccupCode=tempData.rcgnOcpCd,policyUser.LiRcgnMobl=tempData.rcgnMoveTelNo,policyUser.LiIdEndDate=tempData.rcgnCrdtExpDt,policyUser.insureChecked=!0,policyUser.LiRcgnAddress=tempData.rcgnCommAdr,policyUser.LiRcgnZipCode=tempData.rcgnZipECD,insureData.push(policyUser)}}PolicyService.setSessionData({insureData:{planType:updateData.sysCpCode}}),PolicyService.setSessionData({policyData:{LiRcgnList:insureData}}),PolicyService.setSessionData({insureData:{pbApplNoNum:"1"}}),PolicyService.setSessionData({policyData:{isGhmbUpdate:!0,PbHoldBirdy:updateData.rcgnMNBrthDt,PbHoldAddress:updateData.rcgnMNCommAdr,PbIdEndDate:updateData.rcgnMNCrdtExpDt,PbHoldId:updateData.rcgnMNCrdtNo,PbHoldIdType:updateData.rcgnMNCrdtTpCd,PbHoldEmail:updateData.rcgnMNEmailAdr,PbNationality:"0156",PbHoldSex:VALIDATION.getSex(updateData.rcgnMNCrdtNo)+"",PbHoldMobl:updateData.rcgnMNMoveTelNo,PbHoldName:updateData.rcgnMNNm,PbHoldOccupCode:updateData.rcgnMNOcpCd,PbHoldMedic:updateData.rcgnMNSSFLAG,yearIncome:updateData.rcgnMNYrIncmAm,PbHoldAmount:updateData.rcgnMNYrIncmAm,PbHoldZipCode:updateData.rcgnMNZipECD,livePlace:updateData.rsdntTpCd,priChecked:!1,referrerCode:updateData.insRecommendId,referrerName:updateData.insRecommendNm}}),$state.go("product-purchase-policy-info-optimze")},3e3)),"11111"==sysRespCode){var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:sysRespDesc,okText:"我知道了"});alertPopup.then(function(res){$state.go("product-optimze",{id:productData.prd_id})})}}else var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"})},vm.next=function(){GroupPolicyService.control({state:"product-purchase-group-calculate",control:"data",data:{plchdBrthDt:$filter("date")(vm.priInfo.securityAge,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredList:insuredList,totalInsCvr:vm.totalInsCvr,insCvr:vm.insCvr,groupProName:vm.productData.prd_title,pbApplNoNum:"1",params:params}}),GroupPolicyService.control({state:"product-purchase-group-calculate",control:"process"})}},$scope.$on("agePickerCallbackOne",function(event,data){vm.priInfo.securityAge=data[0].value,vm.priInfo.secOneImg=!0}),vm.ifNavFloTrue=!1,vm.scroll=function(){var navScrollTop=document.querySelector(".optimze-byj").scrollTop,h1=document.getElementById("heightBox").offsetHeight,timer=$timeout(function(){navScrollTop>=h1?(vm.ifNavFloTrue=!0,document.getElementById("content").style.marginTop="44px"):(vm.ifNavFloTrue=!1,document.getElementById("content").style.marginTop=0),$timeout.cancel(timer)},50)}}angular.module("app").controller("ProductOptimzeController",ProductOptimzeController),ProductOptimzeController.$inject=["$state","VALIDATION","$document","GroupPolicyService","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicPopup","COMMON"]}(),function(){function ProductPayController($rootScope,$scope,$state,CONFIG,CommonRequest,$log,PolicyService,TipService,$window,COMMON,$ionicPopup,$filter){var vm=this;vm.payMedicareData={};var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.policyData=sessionData.policyData,vm.userData=sessionData.userData,vm.medicInfoshow=!1,vm.medicalPayBatts=vm.policyData.isBatts,vm.relation=vm.policyData.confirmRela,vm.relation=vm.productData.insureName==vm.productData.rcgnName?"01":"NaN",!vm.productData||!vm.policyData||!vm.policyData.orderCode)return void $state.go("tab.mall");vm.orderCode=vm.policyData.orderCode,vm.payways=vm.productData.payType,vm.hasDiscount=vm.productData.hasDiscount,-1!=vm.payways.indexOf("109")&&(vm.newPayMode="7"),vm.payAmount=vm.policyData.itemOrderRealPayAmt,vm.BkBrchNo=vm.policyData.BkBrchNo,vm.newGetAccName=vm.policyData.PbHoldName?vm.policyData.PbHoldName:sessionData.userData.customerName,vm.policyData.checkPolicyGroupApp&&(vm.plchdNm=vm.policyData.checkPolicyGroupApp.plchdNm),vm.policyData.LiRcgnName&&(vm.plchdNm=vm.policyData.LiRcgnName),""==vm.productData.insureName&&(vm.productData.insureName=vm.newGetAccName),vm.showModal=function(){var modalInstance=$uibModal.open({templateUrl:"app/module/product/product-pay/pay-modal/pay-modal.html",controller:"PayModalController",controllerAs:"payModal",size:"md",scope:$scope});modalInstance.result.then(function(check){vm.checkContract=check},function(){$log.info("Modal dismissed at: "+new Date)})},vm.pay=function(){vm.medicare;var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var params={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:vm.BkBrchNo,orderCode:vm.orderCode,payAmount:vm.payAmount,payType:vm.payment,platForm:platForm,payChannel:CONFIG.SALE_CHANNEL};CommonRequest.request(params,CONFIG.PAY_SERVICE,function(result){1==result.status&&($window.location.href=CONFIG.PAY_SERVICE_ADDRESS+result.data.payUrl+"?tokenId="+result.data.tokenId+"&platForm="+params.platForm+"&payChannel="+params.payChannel+"&orderCode="+vm.orderCode+"&payAmount="+vm.payAmount+"&payType="+vm.payment+"&branchCode="+vm.BkBrchNo+"&openid="+$rootScope.openid)})},COMMON.getCommonBank(vm.BkBrchNo,"1",function(bankList){vm.bankList=bankList,vm.newGetBk=vm.bankList[0]});var objBankcount=["",""],oppActs=[{},{}];vm.downBankcount=function(callback){if(console.info("第一次签约"),vm.policyData.NewGetAccCode&&""!=vm.policyData.NewGetAccCode&&(objBankcount[0]=vm.policyData.NewGetAccCode),vm.policyData.BkAcctNo3&&""!=vm.policyData.BkAcctNo3&&(objBankcount[1]=vm.policyData.BkAcctNo3),""==objBankcount[0]&&""==objBankcount[1])angular.isFunction(callback)&&callback(objBankcount);else{for(var i=0;i<objBankcount.length;i++)oppActs[i].OppAct=objBankcount[i];var params={oppActs:oppActs};CommonRequest.request(params,CONFIG.GYL_CONTRACT_QRY,function(result){if(1==result.status){for(var data=result.data,i=0;i<data.length;i++)""!=data[i]&&2==data[i].SignState&&(objBankcount[i]="");angular.isFunction(callback)&&callback(objBankcount)}})}},vm.policyData.BankCode&&-1==vm.policyData.BankCode.indexOf("00051")&&vm.downBankcount(function(objBankcount){var bankdata={oppActs:[{OppAct:objBankcount[0]},{OppAct:objBankcount[1]}]};console.info("第二次签约"),CommonRequest.request(bankdata,CONFIG.GYL_CONTRACT_QRY,function(result){2!=result.data.SignState;var data={objBankcount:objBankcount};PolicyService.control({state:"product-purchase-policy-agreement",control:"data",data:data})})}),vm.paytra=function(){var params={accountName:vm.newGetAccName,bankCode:vm.newGetBk.bankCode,bankName:vm.newGetBk.bankName,accountNumber:vm.newGetAccCode,orderCode:vm.orderCode,payType:vm.newPayMode,pbApplName:vm.newGetAccName};return"JIPAA"==vm.productData.templateCode?(angular.extend(vm.policyData,params),void CommonRequest.request(vm.policyData,CONFIG.NU_CLEAR_PORCH,function(result){1==result.status?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"5"}):TipService.showMsg(result.error.message)})):void CommonRequest.request(params,CONFIG.ACCREDIT_TRANSFER_SERVICE,function(result){1==result.status?(vm.holdStatus=result.data.holdStatus,vm.downBankcount(function(objBankcount){var bankdata={OppAct:vm.newGetAccCode};CommonRequest.request(bankdata,CONFIG.GYL_CONTRACT_QRY,function(result){if(-1==vm.newGetBk.bankCode.indexOf("00051")){2!=result.data.SignState&&(objBankcount[0]=vm.newGetAccCode);var data={objBankcount:objBankcount};PolicyService.control({state:"product-purchase-policy-agreement",control:"data",data:data})}"1"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"5"}):"2"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"4"}):"3"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"5"}):"0"==vm.holdStatus&&$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"6"})})})):0==result.status&&"Y1200044014"==result.error.code&&$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"8"})})},vm.medicalEnsure=function(){vm.check="unconfirmed";var alertPopup=$ionicPopup.confirm({title:"福州市医保卡个人购买商业健康险须知",template:"<p>如您选择支付方式为“医保卡支付”付款，则根据“关于规范职工医保个人账户购买商业健康保险的通知” 榕医保文〔2017〕100号文件规定，建信人寿将按照如下规则执行：</p><p>1.仅接受医保卡持有人为本人投保时方可以通过医保个账支付相应保费。不接受医保卡持有人为其他第三人投保付款；</p><p>2.使用福州市职工医保卡个人账户付款投保后，被保险人于当年度申请退保的，应退保费将退还至福州市医保中心；</p><p>3.如您选择“自动续保”，则续期保费将优先从您的医保卡个人账户扣款，扣款不成功后从授权银行账户扣款；</p><p>4. 若选择医保卡支付方式，退保则应等到次月结算日之后。</p>",okText:"阅读并同意",cancelText:"取消",cssClass:"medicalcare"});alertPopup.then(function(res){1==res?vm.payment="3501":vm.payment="NaN"})};var pay_medicare_check={url:"../statics/product/"+CONFIG.SALE_CHANNEL+"/"+vm.productData.prd_id+"/"+vm.productData.cityCode+".json",method:"GET"};vm.payMedicreCheck=function(){var params={areaCode:vm.productData.cityCode,prdId:vm.productData.prd_id};CommonRequest.request(params,pay_medicare_check,function(result){1==result.status&&(vm.payChannelCode=result.data.payChannelCode,vm.medicInfoshow=!0,vm.payMedicareData.payChannelName=result.data.payChannelName,vm.payMedicareData.medicalPay=result.data.medicalPay,vm.payMedicareData.medicalPayBatts=result.data.medicalPayBatts)})},vm.payMedicreCheck(),vm.payMdiceareAlert=function(){$ionicPopup.alert({title:"支付失败",template:'<p>医保卡与本人不符，请再次确认</p><img src="img/mall/fail.png" class="fail">',okText:"我知道了",cssClass:"payFail"})},vm.payMedical=function(){if(vm.newGetAccName!=vm.productData.insureName)return void vm.payMdiceareAlert();if(1==vm.productData.isBatts)var params={accountName:vm.newGetAccName,bankCode:vm.newGetBk.bankCode,bankName:vm.newGetBk.bankName,accountNumber:vm.newGetAccCode,orderCode:vm.orderCode,payType:vm.payment,pbApplName:vm.newGetAccName,payAmount:vm.payAmount,medicalName:vm.newGetAccName,medicalAccount:vm.medicareCode,payChannelCode:vm.payment,medicalKnow:"1",payChannel:CONFIG.SALE_CHANNEL,payChannelName:vm.payMedicareData.payChannelName,medicalPay:vm.payMedicareData.medicalPay,medicalPayBatts:vm.payMedicareData.medicalPayBatts};else var params={accountName:vm.newGetAccName,bankCode:vm.newGetBk.bankCode,bankName:vm.newGetBk.bankName,accountNumber:vm.newGetAccCode,orderCode:vm.orderCode,payType:vm.payment,pbApplName:vm.newGetAccName,payAmount:vm.payAmount,medicalName:vm.newGetAccName,medicalAccount:vm.medicareCode,payChannelCode:vm.payment,medicalKnow:"1",payChannel:CONFIG.SALE_CHANNEL,payChannelName:vm.payMedicareData.payChannelName,medicalPay:vm.payMedicareData.medicalPay};CommonRequest.request(params,CONFIG.PAY_MEDICAL,function(result){0==result.status?"400001"==result.error.code?$ionicPopup.alert({title:"支付失败",template:'<p>余额不足，请选择其他支付方式</p><img src="img/mall/fail.png" class="fail">',okText:"我知道了",cssClass:"payFail"}):$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"3"}):1==result.status&&$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"2"})})},vm.medicareShow=function(){vm.medicalEnsure()},vm.ensurePay=function(payment){var now=new Date;if(now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{policypayInfoTime:now}}),$rootScope.traceData){var traceData=angular.toJson($rootScope.traceData);if(sessionStorage.setItem("elife-traceData",traceData),"function"==typeof _yfx_sendorderid)try{console.info("录屏结束，发送结束请求，保单号："+vm.policyData.PbApplNo+"，交易号："+vm.orderCode),_yfx_sendorderid(vm.policyData.PbApplNo,vm.orderCode)}catch(e){console.log("finish trace error: "+e.message)}}"109"==payment?vm.paytra():"3501"==payment?vm.payMedical():vm.pay()}}angular.module("app").controller("ProductPayController",ProductPayController),ProductPayController.$inject=["$rootScope","$scope","$state","CONFIG","CommonRequest","$log","PolicyService","TipService","$window","COMMON","$ionicPopup","$filter"]}(),function(){function ProductPaySuccessController(PolicyService,$state,$rootScope,$scope,$ionicModal,$log,CONFIG,CommonRequest,TipService,$window,BankContractService){var vm=this,params=$state.params,sessionData=PolicyService.getSessionData();if(vm.activationTime=new Date,vm.userData=sessionData.userData,vm.productData=sessionData.productData||{},vm.policyData=sessionData.policyData,vm.activationTime=new Date,vm.BkBrchNo=vm.policyData.BkBrchNo,vm.activityId="",vm.salerId="",vm.activityFlag=!1,vm.activityContent="",vm.bankCode=vm.policyData.BankCode,vm.productData.activityId&&void 0!=vm.productData.activityId&&(vm.activityId=vm.productData.activityId),vm.productData.salerId&&void 0!=vm.productData.salerId&&(vm.salerId=vm.productData.salerId),vm.orderCode=params.orderCode,vm.status=params.payResult,vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.insureData?vm.insureData.groupProName&&(vm.groupProName=vm.insureData.groupProName):vm.policyData&&vm.policyData.groupProName&&(vm.groupProName=vm.policyData.groupProName),sessionData.productData&&(sessionData.insureData&&sessionData.insureData.PbBeginDate&&sessionData.insureData.beginTime?vm.effectiveDate=sessionData.insureData.PbBeginDate+sessionData.insureData.beginTime:sessionData.productData.effectiveTime&&"0:0:0"!=sessionData.productData.effectiveTime?vm.effectiveDate=sessionData.productData.PbBeginDate+" "+sessionData.productData.effectiveTime:vm.effectiveDate=sessionData.productData.PbBeginDate+" 24:00:00"),vm.clearArrTrim=function(array){for(var i=0;i<array.length;i++)""!=array[i]&&void 0!=_typeof(array[i])||(array.splice(i,1),i-=1)},(vm.policyData.BkAcctNo3||vm.policyData.plchdAccNo)&&vm.policyData){var params={OppAct:vm.policyData.BkAcctNo3||vm.policyData.plchdAccNo};CommonRequest.request(params,CONFIG.GYL_CONTRACT_NEWQRY,function(result){"1"==result.status&&("success"==result.data.RdCode&&("1"!=result.data.NeedSign||"1"!=result.data.SignState&&"3"!=result.data.SignState)?(vm.showFlag=!1,vm.sortFlag=!1):(vm.BkAcctNoConfirm=vm.policyData.BkAcctNo3||vm.policyData.plchdAccNo,
vm.sortFlag=!0,vm.showFlag=!0))})}vm.signContract=function(){var array=[vm.BkAcctNoConfirm];BankContractService.pushContract(array)},vm.saveTradeSnapShoot=function(){var params=sessionData.insureData;CommonRequest.request(params,CONFIG.SAVE_TRADE_SNAPSHOOT,function(result){"1"==result.status&&console.info("交易快照保存成功")})},vm.getPolicy=function(){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.FIND_POILCYNO_SERVICE,function(result){if(1==result.status){vm.order=result.data;var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData||{},("820"==vm.productData.newSaleChnl||"821"==vm.productData.newSaleChnl)&&vm.order&&vm.order.length>0){for(var policyNoStr="",i=0;i<vm.order.length;i++)policyNoStr+=i==vm.order.length-1?vm.order[i].pbInsuSlipNo:vm.order[i].pbInsuSlipNo+",";vm.salesId=vm.productData.salesId?vm.productData.salesId:"",$window.location.href=CONFIG.weChatMaketDOMAIN+"/elife_wx/insuredComplete.do?policyNo="+policyNoStr+"&pNo="+vm.productData.salesId+"&orderCode="+vm.orderCode+"&activeId="+vm.activityId+"&salerId="+vm.salerId}if(vm.order&&vm.order.length>0){var policyParams={orderCode:vm.orderCode,channelCode:vm.productData.newSaleChnl||CONFIG.NEW_SALE_CHANNEL};CommonRequest.request(policyParams,CONFIG.SYS_ACTIVITY_JUDGE_ACTIVITY,function(result){"1"==result.status&&"1"==result.data.activityFlag&&(vm.activityFlag=!0,vm.activityContent=result.data.activityContent)})}if(vm.order[0].flag&&"1"==vm.order[0].flag)return void $state.go("automatic-refund",{orderCode:vm.orderCode});vm.order&&vm.order.length>0?vm.policyList=vm.order:TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)}else TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)})},2==vm.status&&vm.getPolicy(),vm.onlineQuestionnaire=function(){$ionicModal.fromTemplateUrl("app/module/mall/product/product-pay-success/online-return-questionnaire/online-return-questionnaire.html",{scope:$scope}).then(function(modal){$scope.modal=modal})}}angular.module("app").controller("ProductPaySuccessController",ProductPaySuccessController),ProductPaySuccessController.$inject=["PolicyService","$state","$rootScope","$scope","$ionicModal","$log","CONFIG","CommonRequest","TipService","$window","BankContractService"]}(),function(){function ProductShareController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,rootScope,PolicyService,TipService,$timeout,$filter,VALIDATION,$ionicScrollDelegate,$anchorScroll,MallCommonService,$ionicPopup,$window){var vm=this;vm.butml=.16*document.body.offsetWidth+"px",vm.butwidthx=.17*document.body.offsetWidth+2+"px",vm.butwidths=.17*document.body.offsetWidth+6+"px",vm.butwidth="75px",vm.modelFlag=!1,vm.id=$state.params.id,vm.sexChecked="1",vm.termChecked="80",vm.payChecked=12,vm.feeChecked=10,vm.moneyChecked=1e5,vm.whetheroption=1,vm.maxflag=!1,vm.insurerBirthDay=null,MallCommonService.wechatShareLink("count"),vm.getProductDetail=function(id){var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],PolicyService.setSessionData({productData:result.data})}}})};var times=0;vm.loadingPage=function(callback){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id),void $timeout(function(){return vm.productData?void(angular.isFunction(callback)&&callback()):void vm.loadingPage(callback)},500))},vm.loadingPage(function(){vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr,console.info(vm.materialArr);for(var i=0;i<vm.materialArr.length;i++)"建信龙安馨康重大疾病保险条款"==vm.materialArr[i].materialName?(vm.mainPath=vm.materialArr[i].materialPath+"",console.info(vm.mainPath)):(vm.addPath=vm.materialArr[i].materialPath+"",console.info(vm.addPath))})}},vm.materialDetail({materialTypeDesc:"产品条款",materialType:"M01"})}),vm.minStartDate1=VALIDATION.getDateByAge("55"),vm.minStartDate2=VALIDATION.getDateByAge("50"),vm.minStartDate3=VALIDATION.getDateByAge("40"),vm.minStartDate4=VALIDATION.getDateByAge("60"),vm.maxEndDate1=VALIDATION.getDateByAge("0"),vm.maxEndDate2=VALIDATION.getDateByAge("18"),vm.dataflag1=!1,vm.dataflag2=!0,vm.dataflag3=!1,vm.dataflag4=!1,vm.dataflag5=!1,vm.dataflag6=!1,vm.dataflag7=!1,vm.dataflag8=!1,vm.changeState=function(no){vm.dataflag1=!1,vm.dataflag2=!1,vm.dataflag3=!1,vm.dataflag4=!1,vm.dataflag5=!1,vm.dataflag6=!1,vm.dataflag7=!1,vm.dataflag8=!1,this[no]=!0},$scope.$watch("productShare.payChecked + productShare.feeChecked + productShare.termChecked",function(){(vm.payChecked||0==vm.payChecked)&&(vm.userAge=VALIDATION.getAgeByBirth(vm.insurerBirthDay),vm.exp="",0==vm.payChecked?"Y"==vm.insuYearFlag?(vm.minAge="18",vm.maxAge="60",(vm.userAge>60||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag8")):"A"==vm.insuYearFlag&&(vm.minAge="0",vm.maxAge="60",(vm.userAge>60||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag4")):12==vm.payChecked?"Y"==vm.insuYearFlag?5==vm.feeChecked?(vm.minAge="18",vm.maxAge="55",(vm.userAge>55||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag5")):10==vm.feeChecked?(vm.minAge="18",vm.maxAge="50",(vm.userAge>50||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag6")):20==vm.feeChecked&&(vm.minAge="18",vm.maxAge="40",(vm.userAge>40||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag7")):"A"==vm.insuYearFlag&&(5==vm.feeChecked?(vm.minAge="0",vm.maxAge="55",(vm.userAge>55||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag1")):10==vm.feeChecked?(vm.minAge="0",vm.maxAge="50",(vm.userAge>50||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag2")):20==vm.feeChecked&&(vm.minAge="0",vm.maxAge="40",(vm.userAge>40||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag3"))):6==vm.payChecked?"Y"==vm.insuYearFlag?5==vm.feeChecked?(vm.minAge="18",vm.maxAge="55",(vm.userAge>55||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag5")):10==vm.feeChecked?(vm.minAge="18",vm.maxAge="50",(vm.userAge>50||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag6")):20==vm.feeChecked&&(vm.minAge="18",vm.maxAge="40",(vm.userAge>40||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag7")):"A"==vm.insuYearFlag&&(5==vm.feeChecked?(vm.minAge="0",vm.maxAge="55",(vm.userAge>55||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag1")):10==vm.feeChecked?(vm.minAge="0",vm.maxAge="50",(vm.userAge>50||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag2")):20==vm.feeChecked&&(vm.minAge="0",vm.maxAge="40",(vm.userAge>40||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag3"))):3==vm.payChecked&&("Y"==vm.insuYearFlag?5==vm.feeChecked?(vm.minAge="18",vm.maxAge="55",(vm.userAge>55||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag5")):10==vm.feeChecked?(vm.minAge="18",vm.maxAge="50",(vm.userAge>50||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag6")):20==vm.feeChecked&&(vm.minAge="18",vm.maxAge="40",(vm.userAge>40||vm.userAge<18)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag7")):"A"==vm.insuYearFlag&&(5==vm.feeChecked?(vm.minAge="0",vm.maxAge="55",(vm.userAge>55||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag1")):10==vm.feeChecked?(vm.minAge="0",vm.maxAge="50",(vm.userAge>50||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag2")):20==vm.feeChecked&&(vm.minAge="0",vm.maxAge="40",(vm.userAge>40||vm.userAge<0)&&null!=vm.insurerBirthDay&&(vm.insurerBirthDay=null,$ionicPopup.alert({title:"温馨提示",template:"请重新选择被保人出生日期！",okText:"我知道了"})),vm.changeState("dataflag3")))),vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge))},!0),vm.sexCheck=function(sex){vm.sexChecked=sex},vm.insuYearFlag="A",vm.termCheck=function(math){"30"==math?vm.insuYearFlag="Y":vm.insuYearFlag="A",vm.termChecked=math},vm.navChecked=1,vm.navCheck=function(tab,tabid){vm.navChecked=tab,vm.slideTo(tabid)};var nav=document.getElementById("nav"),lisLen=nav.getElementsByTagName("li").length-1;vm.ulWidth=88*lisLen+"px",vm.slideTo=function(location){var location=$location.hash(location);$ionicScrollDelegate.$getByHandle("dashboard").anchorScroll("#"+location)},vm.backTop=function(){$ionicScrollDelegate.$getByHandle("dashboard").scrollTop(!0)},vm.showFlag=!1;var topPositon;vm.showBack=function(){if(topPositon=$ionicScrollDelegate.getScrollPosition().top,topPositon>1400){if(vm.showFlag)return;vm.showFlag=!0,$scope.$apply()}else{if(!vm.showFlag)return;vm.showFlag=!1,$scope.$apply()}},vm.feeflag=!0,vm.payCheck=function(paytype){vm.payChecked=paytype,0==paytype?vm.feeflag=!1:vm.feeflag=!0},vm.moneySelect=!1,vm.moneyCheck=function(money){money&&(vm.moneyChecked=money,vm.moneySelect=!1)},vm.whether=function(num){num&&(vm.whetheroption=num,vm.whetherSelect=!1)},vm.moneyflag=function(){vm.scrollFlag=!1,vm.moneyChecked="",vm.moneySelect=!0},vm.feeCheck=function(fee){vm.feeChecked=fee},vm.a=function(){vm.scrollFlag=!0,$("#shareborder").blur()},vm.errorAlert=function(){vm.moneyChecked<5e4?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):vm.moneyChecked%1e3!=0?(vm.formatShow=!0,$timeout(function(){vm.formShow=!1},1500)):(vm.moneyShow=!0,$timeout(function(){vm.moneyShow=!1},1500))},vm.hideError=function(){vm.lengthShow=!1,vm.formatShow=!1},vm.showModel=function(){0==vm.modelFlag?vm.modelFlag=!0:vm.modelFlag=!1},$scope.$watch("productShare.payChecked + productShare.feeChecked + productShare.termChecked + productShare.insurerBirthDay + productShare.whetheroption + productShare.moneyChecked + productShare.sexChecked",function(){if(vm.moneyChecked%1e3!=0&&vm.moneyChecked>1e3)return vm.formatShow=!0,void $timeout(function(){vm.formatShow=!1},1500);if(vm.insurerBirthDay){if(vm.exp=null,vm.beiage=VALIDATION.getAgeByBirth(vm.insurerBirthDay),vm.beiage>=18?vm.maxflag=!1:vm.maxflag=!0,vm.beiage<18&&vm.moneyChecked>56e4||vm.beiage>=18&&vm.moneyChecked>1e8)return vm.moneyShow=!0,void $timeout(function(){vm.moneyShow=!1},1500);if(!vm.moneyChecked)return;if(vm.moneyChecked<5e4)return;if(vm.moneyChecked%1e3!=0&&void 0!=vm.moneyChecked)return vm.formatShow=!0,void $timeout(function(){vm.formatShow=!1},1500);vm.calc(vm.calcAdd)}}),vm.calcAdd=function(){if(1==vm.whetheroption){var calcParams={prdCode:"HENA",prdName:"龙安馨康保险产品计划",insurerBirthDay:$filter("date")(vm.insurerBirthDay,"yyyyMMdd"),insuredDays:vm.termChecked,insuYearFlag:vm.insuYearFlag,planCode:"HDDA_01",channel:CONFIG.SALE_CHANNEL,sex:vm.sexChecked,paymentType:vm.payChecked,PbInsuAmt:vm.moneyChecked,payendyear:vm.feeChecked||""};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.exp=(Number(vm.mainexp)+Number(amountExp[0])).toFixed(2),vm.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}})}var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.exp=(Number(vm.mainexp)+Number(amountExp[0])).toFixed(2),vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}},vm.calc=function(callback){var calcParams={prdCode:"HDDA",prdName:"龙安馨康保险产品计划",insurerBirthDay:$filter("date")(vm.insurerBirthDay,"yyyyMMdd"),insuredDays:vm.termChecked,insuYearFlag:vm.insuYearFlag,planCode:"HDDA_01",channel:CONFIG.SALE_CHANNEL,sex:vm.sexChecked,paymentType:vm.payChecked,PbInsuAmt:vm.moneyChecked,payendyear:vm.feeChecked||""};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainexp=amountExp[0],vm.amount=amountExp[1],vm.exp=vm.mainexp,angular.isFunction(callback)&&callback()}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0,angular.isFunction(callback)&&callback()}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}}}angular.module("app").controller("ProductShareController",ProductShareController),ProductShareController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$rootScope","PolicyService","TipService","$timeout","$filter","VALIDATION","$ionicScrollDelegate","$anchorScroll","MallCommonService","$ionicPopup","$window"]}(),function(){function TransferPageController(TipService,$window,$location,$scope,$state,CONFIG,CommonRequest){$scope.goTransferPage=function(){var vm=this;vm.prdCode=$state.params.prdCode,vm.channelLogo=$state.params.channelLogo,localStorage.setItem("channelLogo",vm.channelLogo),CONFIG.CHANNELVALIDATECHECK_SERVICE={url:CONFIG.SERVICE_ADDRESS+"channelValidateCheck",method:"POST"},CONFIG.NOWPRODUCT_LIST_SERVICE={url:"../statics/json/"+vm.channelLogo+"/productList.json",method:"GET"},CommonRequest.request({},CONFIG.NOWPRODUCT_LIST_SERVICE,function(result){if(1==result.status)for(var i=0;i<result.data.length;i++)if(vm.prdCode==result.data[i].prd_code)for(var j=0;j<result.data[i].tag_code.length;j++)if("TAG0005"==result.data[i].tag_code[j])return vm.prdId=result.data[i].id,vm.params={prdId:vm.prdId,channel:vm.channelLogo},void CommonRequest.request(vm.params,CONFIG.CHANNELVALIDATECHECK_SERVICE,function(data1){1==data1.status&&$window.location.replace("https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fdetail%2F"+vm.prdId+"%2F%2F%2F%2F%2F%2F%2F%2F&response_type=code&scope=snsapi_base&state=test#wechat_redirect")})})},$scope.goTransferPage()}angular.module("app").controller("TransferPageController",TransferPageController),TransferPageController.$inject=["TipService","$window","$location","$scope","$state","CONFIG","CommonRequest"]}(),function(){function ProductUpgradeController($state,CONFIG,CommonRequest,PolicyService,TipService,$rootScope,$timeout,$ionicPopup,$scope,VALIDATION,$ionicLoading,$window){var vm=this,sessionData=PolicyService.getSessionData(),productData=(sessionData.userData,sessionData.productData);vm.cerType="A",vm.errorAlert=function(model,invalid,key,val){$rootScope.loadingPage&&model&&invalid&&(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),"name"==key?1==val.invalid?vm.errorMsg=$rootScope.TIPS.COMMON.USER_NAME_INVALID:1==val.length&&(vm.errorMsg=$rootScope.TIPS.COMMON.USER_NAME_LENGTH_ERROR):"certNo"==key&&(1==val.length?vm.errorMsg=$rootScope.TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?vm.errorMsg=$rootScope.TIPS.COMMON.ID_INVALID:1==val.invalid2&&(vm.errorMsg=$rootScope.TIPS.COMMON.ID_INVALID2)))},vm.hide=function(){vm.showError=!1},vm.fgsfz=function(){vm.certNo=VALIDATION.certNoFormat(vm.certNo)},vm.checkUpgrade=function(){vm.getbirth=function(){var num=VALIDATION.getSex(vm.certNo.replace(/\s/g,""));return num-1};var params={upgradeRequest:{plchdNm:vm.name,plchdGndCd:vm.getbirth(),plchdCrdtNo:vm.certNo.replace(/\s/g,""),plchdBrthDt:VALIDATION.getBirthday(vm.certNo.replace(/\s/g,"")),plchdCrdtTpCd:"A"}};vm.verToken="",vm.upgradeData="",CommonRequest.request(params,CONFIG.ID_UPGRADE_CHECK,function(result){console.info(result),1==result.status&&(vm.verToken=result.data,""!=vm.verToken&&(vm.getPolicyResultTimes=0,vm.getUpdatePolicyResult()))})},vm.getUpdatePolicyResult=function(){if(vm.getPolicyResultTimes++,vm.getPolicyResultTimes>CONFIG.CORE_DECOUPLING_TIMES){$ionicLoading.hide();$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"});return void(vm.getPolicyResultTimes=0)}$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),CommonRequest.request({verToken:vm.verToken},CONFIG.ID_UPGRADE_CHECK_RESULT,function(qresult){if(1==qresult.status){var flg="data"in qresult;if(!flg)return void $timeout(function(){vm.getUpdatePolicyResult()},CONFIG.CORE_DECOUPLING_DURATION);$ionicLoading.hide(),vm.getPolicyResultTimes=0,console.info(qresult.data),vm.upgradeData=qresult.data,vm.handleUpdateResult(vm.upgradeData)}},!0)},vm.handleUpdateResult=function(updateData){if(updateData){var sysRespCode=updateData.sysRespCode,sysRespDesc=updateData.sysRespDesc;updateData.rcgnList;if("00000"==sysRespCode&&(vm.showError=!0,vm.errorMsg="恭喜您可立即升级",$timeout(function(){for(var insureData=[],i=updateData.rcgnList.length-1;i>=0;i--){var tempData=updateData.rcgnList[i];if("01"!=tempData.rcgnAndRcgnReTpCd){var policyUser={};policyUser.id=i+1,policyUser.confirmRela=tempData.rcgnAndRcgnReTpCd,policyUser.LiNationality="0156",policyUser.LiRcgnName=tempData.rcgnNm,policyUser.trashShow=!1,policyUser.LiRcgnMedic=tempData.rcgnSSFLAG,policyUser.LiRcgnIdType=tempData.rcgnCrdtTpCd,policyUser.LiRcgnId=tempData.rcgnCrdtNo,policyUser.LiRcgnBirdy=tempData.rcgnBrthDt,policyUser.LiRcgnSex=VALIDATION.getSex(tempData.rcgnCrdtNo)+"",policyUser.LiRcgnOccupCode=tempData.rcgnOcpCd,policyUser.LiRcgnMobl=tempData.rcgnMoveTelNo,policyUser.LiIdEndDate=tempData.rcgnCrdtExpDt,policyUser.insureChecked=!0,policyUser.LiRcgnAddress=tempData.rcgnCommAdr,policyUser.LiRcgnZipCode=tempData.rcgnZipECD,insureData.push(policyUser)}}PolicyService.setSessionData({insureData:{planType:updateData.sysCpCode}}),PolicyService.setSessionData({policyData:{LiRcgnList:insureData}}),PolicyService.setSessionData({insureData:{pbApplNoNum:"1"}}),PolicyService.setSessionData({policyData:{isGhmbUpdate:!0,PbHoldBirdy:updateData.rcgnMNBrthDt,PbHoldAddress:updateData.rcgnMNCommAdr,PbIdEndDate:updateData.rcgnMNCrdtExpDt,PbHoldId:updateData.rcgnMNCrdtNo,PbHoldIdType:updateData.rcgnMNCrdtTpCd,PbNationality:"0156",PbHoldEmail:updateData.rcgnMNEmailAdr,PbHoldSex:VALIDATION.getSex(updateData.rcgnMNCrdtNo)+"",PbHoldMobl:updateData.rcgnMNMoveTelNo,PbHoldName:updateData.rcgnMNNm,PbHoldOccupCode:updateData.rcgnMNOcpCd,PbHoldMedic:updateData.rcgnMNSSFLAG,yearIncome:updateData.rcgnMNYrIncmAm,PbHoldAmount:updateData.rcgnMNYrIncmAm,PbHoldZipCode:updateData.rcgnMNZipECD,livePlace:updateData.rsdntTpCd,priChecked:!1,referrerCode:updateData.insRecommendId,referrerName:updateData.insRecommendNm}}),$state.go("product-purchase-policy-info-optimze")},3e3)),"11111"==sysRespCode){var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:sysRespDesc,okText:"我知道了"});alertPopup.then(function(res){$state.go("product-optimze",{id:productData.prd_id})})}}else var alertPopup=$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"查询失败,请重试",okText:"确定"})}}angular.module("app").controller("ProductUpgradeController",ProductUpgradeController),ProductUpgradeController.$inject=["$state","CONFIG","CommonRequest","PolicyService","TipService","$rootScope","$timeout","$ionicPopup","$scope","VALIDATION","$ionicLoading","$window"]}(),function(){function TwentyAnniversaryController($state,PolicyService,CONFIG,$timeout,CommonRequest){var vm=this,_h=parseInt($(window).height()),_w=parseInt($(window).width()),rate=_w/1242,btnHeight=1636*rate;vm.actualBgH=_h-44,vm.prdId=$state.params.prdId,vm.initImg=function(){var params={channel:"812",prdId:vm.prdId};CommonRequest.request(params,CONFIG.GET_TWENTY_ANNIVERSARY,function(result){if(1==result.status){for(var blooer=!1,i=0;i<result.data.length;i++)if(vm.prdId==result.data[i].font&&"812"==result.data[i].channel&&"6"==result.data[i].position&&"1"==result.data[i].isUsed&&"1"==result.data[i].publishStatus)return vm.annImgUrl=CONFIG.DOMAIN+"/images"+result.data[i].path,vm.url=result.data[i].url,void(blooer=!0);if(0==blooer)return void $state.go("tab.mall")}})},vm.initImg(),$(".anniversary-bg").eq(0).on("load",function(){vm.annImgUrlH=$(".anniversary-bg").eq(0).height(),$(".anniversary-btn").eq(0).css("top",btnHeight),vm.annImgUrlH<vm.actualBgH&&$(".anniversary-bg").eq(0).css("height",vm.actualBgH)})}angular.module("app").controller("TwentyAnniversaryController",TwentyAnniversaryController),TwentyAnniversaryController.$inject=["$state","PolicyService","CONFIG","$timeout","CommonRequest"]}(),function(){function TwentyAnniversaryThreeController($state,PolicyService,CONFIG,$timeout,CommonRequest,$window,$ionicPopup){var vm=this,flag=!1,_h=parseInt($(window).height()),_w=parseInt($(window).width()),rate=_w/1242,btnHeight=1750*rate;vm.actualBgH=_h-44,CommonRequest.request([],CONFIG.GET_TWENTY_ANNIVERSARY,function(result){if(1==result.status)for(var i=0;i<result.data.length;i++)"20周年活动三"==result.data[i].advertisementName&&"812"==result.data[i].channel&&"6"==result.data[i].position&&"1"==result.data[i].isUsed&&"1"==result.data[i].publishStatus&&"1"==result.data[i].sortNo&&(vm.prdId=result.data[i].font,vm.left=result.data[i].url,flag=!0),"20周年活动三"==result.data[i].advertisementName&&"812"==result.data[i].channel&&"6"==result.data[i].position&&"1"==result.data[i].isUsed&&"1"==result.data[i].publishStatus&&"2"==result.data[i].sortNo&&(vm.right=result.data[i].url)}),vm.address=function(){var params={channel:"812",prdId:vm.prdId};CommonRequest.request(params,CONFIG.NEW_PRD_CHECK_LIMIT,function(result){if(result&&flag)if(1==result.data)$window.location.href=vm.left;else{vm.left="",flag=!1;$ionicPopup.confirm({title:"温馨提示",template:"暂无赠送额度，请点击“优惠购”-立即参与。",okText:"确认",cancelText:"取消"})}})},$(".anniversary-three").eq(0).on("load",function(){vm.annImgUrlH=$(".anniversary-three").eq(0).height(),console.log(vm.annImgUrlH),$(".anniversary-left").eq(0).css("top",btnHeight),vm.annImgUrlH<vm.actualBgH&&$(".anniversary-three").eq(0).css("height",vm.actualBgH),$(".anniversary-right").eq(0).css("top",btnHeight),vm.annImgUrlH<vm.actualBgH&&$(".anniversary-three").eq(0).css("height",vm.actualBgH)})}angular.module("app").controller("TwentyAnniversaryThreeController",TwentyAnniversaryThreeController),TwentyAnniversaryThreeController.$inject=["$state","PolicyService","CONFIG","$timeout","CommonRequest","$window","$ionicPopup"]}(),function(){function XyproductPaySuccessController(PolicyService,$state,$rootScope,$scope,$ionicModal,$log,CONFIG,CommonRequest,TipService,$window){var vm=this,params=$state.params,sessionData=PolicyService.getSessionData();vm.activationTime=new Date,vm.userData=sessionData.userData,vm.productData=sessionData.productData||{},vm.policyData=sessionData.policyData,vm.activationTime=new Date,vm.BkBrchNo=vm.policyData.BkBrchNo,vm.activityId="",vm.salerId="",vm.activityFlag=!1,vm.activityContent="",vm.bankCode=vm.policyData.BankCode,vm.productData.activityId&&void 0!=vm.productData.activityId&&(vm.activityId=vm.productData.activityId),vm.productData.salerId&&void 0!=vm.productData.salerId&&(vm.salerId=vm.productData.salerId),vm.orderCode=params.orderCode,vm.status=params.payResult,vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.insureData?vm.insureData.groupProName&&(vm.groupProName=vm.insureData.groupProName):vm.policyData&&vm.policyData.groupProName&&(vm.groupProName=vm.policyData.groupProName),sessionData.productData&&(sessionData.insureData&&sessionData.insureData.PbBeginDate&&sessionData.insureData.beginTime?vm.effectiveDate=sessionData.insureData.PbBeginDate+sessionData.insureData.beginTime:sessionData.productData.effectiveTime&&"0:0:0"!=sessionData.productData.effectiveTime?vm.effectiveDate=sessionData.productData.PbBeginDate+" "+sessionData.productData.effectiveTime:vm.effectiveDate=sessionData.productData.PbBeginDate+" 24:00:00"),vm.clearArrTrim=function(array){for(var i=0;i<array.length;i++)""!=array[i]&&void 0!=_typeof(array[i])||(array.splice(i,1),i-=1)},vm.policyData&&vm.policyData.objBankcount&&(""!=vm.policyData.objBankcount[0]||""!=vm.policyData.objBankcount[1])&&(CommonRequest.request([],CONFIG.GYL_CONTRACT__BANKS,function(result){if(1==result.status){console.info(vm.bankCode.substr(2,7));for(var i=0;i<result.data.length;i++)if(console.info(result.data[i].elifeBankCode),result.data[i].elifeBankCode==vm.bankCode.substr(2,7)){if(vm.arrCode=result.data[i],"N"!=result.data[i].signBankFlag)return void(vm.sortFlag=!1);vm.downBankcount=function(callback){var oppActsList=[{},{}];vm.policyData.NewGetAccCode&&""!=vm.policyData.NewGetAccCode&&(oppActsList[0].OppAct=vm.policyData.NewGetAccCode),vm.policyData.objBankcount&&(oppActsList[1].OppAct=vm.policyData.objBankcount);var paramszx={oppActs:oppActsList};CommonRequest.request(paramszx,CONFIG.GYL_CONTRACT_QRY,function(result){if(1==result.status)for(var i=0;i<result.data.length;i++){if(""==data[i]||2!=data[i].SignState)return void(vm.showFlag=!1);vm.sortFlag=!0}})},vm.downBankcount()}else vm.sortFlag=!0}}),vm.signBankList=vm.policyData.objBankcount,vm.clearArrTrim(vm.signBankList)),vm.saveTradeSnapShoot=function(){var params=sessionData.insureData;CommonRequest.request(params,CONFIG.SAVE_TRADE_SNAPSHOOT,function(result){"1"==result.status&&console.info("交易快照保存成功")})},vm.goBackHome=function(){document.addEventListener(" WeixinJSBridgeReady",function(){WeixinJSBridge.call("closeWindow")},!1),WeixinJSBridge.call("closeWindow")},vm.getPolicy=function(){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.FIND_POILCYNO_SERVICE,function(result){if(1==result.status){vm.order=result.data;var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData||{},("820"==vm.productData.newSaleChnl||"821"==vm.productData.newSaleChnl)&&vm.order&&vm.order.length>0){for(var policyNoStr="",i=0;i<vm.order.length;i++)policyNoStr+=i==vm.order.length-1?vm.order[i].pbInsuSlipNo:vm.order[i].pbInsuSlipNo+",";vm.salesId=vm.productData.salesId?vm.productData.salesId:"",$window.location.href=CONFIG.weChatMaketDOMAIN+"/elife_wx/insuredComplete.do?policyNo="+policyNoStr+"&pNo="+vm.productData.salesId+"&orderCode="+vm.orderCode+"&activeId="+vm.activityId+"&salerId="+vm.salerId}if(vm.order&&vm.order.length>0){var policyParams={orderCode:vm.orderCode,channelCode:vm.productData.newSaleChnl||CONFIG.NEW_SALE_CHANNEL};CommonRequest.request(policyParams,CONFIG.SYS_ACTIVITY_JUDGE_ACTIVITY,function(result){"1"==result.status&&"1"==result.data.activityFlag&&(vm.activityFlag=!0,vm.activityContent=result.data.activityContent)})}if(vm.order[0].flag&&"1"==vm.order[0].flag)return void $state.go("automatic-refund",{orderCode:vm.orderCode});vm.order&&vm.order.length>0?vm.policyList=vm.order:TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)}else TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)})},2==vm.status&&vm.getPolicy(),vm.onlineQuestionnaire=function(){$ionicModal.fromTemplateUrl("app/module/mall/product/product-pay-success/online-return-questionnaire/online-return-questionnaire.html",{scope:$scope}).then(function(modal){$scope.modal=modal})}}angular.module("app").controller("XyproductPaySuccessController",XyproductPaySuccessController),XyproductPaySuccessController.$inject=["PolicyService","$state","$rootScope","$scope","$ionicModal","$log","CONFIG","CommonRequest","TipService","$window"]}(),function(){function HmrbController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicLoading,$timeout,$location){var vm=this;vm.id=$state.params.id,vm.newRule=!CONFIG.WECHAT,vm.newSaleChnl="819",PolicyService.control({state:"product-detail",control:"data",data:{newSaleChnl:"819"}}),CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl,vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);
for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],PolicyService.setSessionData({productData:result.data})}}})},vm.getProductMaterialsWithoutCache=function(){PolicyService.getMaterialsWithoutCache({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.requestWithoutCache(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductMaterialsWithoutCache();var times=0;vm.loadingPage=function(callback,ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):vm.productData?void(angular.isFunction(callback)&&callback()):void vm.loadingPage(callback,ars)},2e3))},vm.getLotCode=function(callback){if("Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()};var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate)))),vm.loadingPage(function(){var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData;var basicProfile=vm.productData.basicProfile;sessionData.login,sessionData.loginStatus;vm.mainPlan={rate:0,amount:0,exp:0},vm.user={},vm.user.sex=null,vm.user.birthday=null,vm.nextStep=!0,vm.mainPlan.amount=1e6,vm.mainPlan.socialSecurity="Y",vm.nextStep=!0,vm.ifShowInfo0=!1,vm.ifShowInfo1=!1,vm.haveShow="有社保",vm.navActiveCss=function(index,amount,socialSecurity){var normalNav=document.getElementsByName("nav");"Y"==socialSecurity?(vm.haveShow="有社保",vm.mainPlan.socialSecurity="Y"):(vm.haveShow="无社保",vm.mainPlan.socialSecurity="N");for(var i=0;i<normalNav.length;i++)normalNav[i].className="normal-nav",normalNav[0].style.marginLeft="0px",i==index&&(normalNav[i].className="active-nav");vm.mainPlan.amount=amount,vm.mainPlan.socialSecurity=socialSecurity,vm.showInfoStr(amount,socialSecurity),vm.setPlan()},vm.showInfoContent=function(index){0==index?vm.ifShowInfo0?vm.ifShowInfo0=!1:vm.ifShowInfo0=!0:1==index&&(vm.ifShowInfo1?vm.ifShowInfo1=!1:vm.ifShowInfo1=!0)},vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.setPlan=function(){if(vm.chosePlanFlag=vm.mainPlan.amount/1e6-1,vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.chosePlanFlag==i&&(vm.selectedPlans=vm.productData.plans[i],angular.extend(vm.mainPlan,vm.selectedPlans));vm.user.birthdayfm&&vm.user.sex&&vm.calc(vm)},vm.setPlan(),vm.showInfoStr=function(amount,socialSecurity){vm.amountStr=amount/1e4+"万",vm.doubleAmountStr=amount/1e4*2+"万"},vm.showInfoStr(vm.mainPlan.amount,vm.mainPlan.socialSecurity),$scope.$watch("hmrb.user.birthday",function(newValue){newValue&&(vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex&&vm.mainPlan.amount&&vm.calc(vm))}),$scope.$watch("hmrb.user.sex",function(newValue){newValue&&vm.user.birthdayfm&&vm.mainPlan.amount&&vm.calc(vm)}),vm.calc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:vm.mainPlan.socialSecurity,channel:"819"};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.block=function(){vm.toggle=!0},vm.toggle=!1,vm.hide=function(e){vm.toggle=!1},vm.goPolicy=function(){if(!vm.user.sex||!vm.user.birthday)return void(vm.toggle=!0);vm.toggle=!1;({prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""});if(PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:vm.mainPlan.socialSecurity,calc:vm.calc.toString(),calcCtrl:vm}}),"Y"==basicProfile.P005){var _dfdfdf,dfdfdf=(_dfdfdf={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:vm.mainPlan.socialSecurity,channel:"819",prdId:vm.productData.prd_id},_defineProperty(_dfdfdf,"sex",vm.user.sex),_defineProperty(_dfdfdf,"insurerBirthDay",$filter("date")(vm.user.birthday,"yyyyMMdd")),_defineProperty(_dfdfdf,"planId",vm.mainPlan.planId),_defineProperty(_dfdfdf,"premiumResult",vm.mainPlan.exp),_defineProperty(_dfdfdf,"orderCode",vm.productData.orderCode||""),_dfdfdf);PolicyService.setSessionData({productData:{creditCard:"Y",paramsArgument:dfdfdf}}),PolicyService.showMobileModal()}}},$rootScope)}angular.module("app").controller("HmrbController",HmrbController),HmrbController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicLoading","$timeout","$location"]}(),function(){function HmrcCalculateController($state,$sce,VALIDATION,$document,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,$ionicPopup,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicModal,COMMON,$http){var vm=this;if(vm.newRule=!1,vm.insureData=PolicyService.getSessionData().insureData,vm.userData=PolicyService.getSessionData().userData||{},vm.cretType="A",vm.userData.cretType&&"A"!==vm.userData.cretType){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"本产品在手机端仅支持身份证类型的客户投保，其他证件类型的客户请到建信人寿官网投保，谢谢！",okText:"我知道了"});alertPopup.then(function(res){vm.cretType=vm.userData.cretType})}"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.id=$state.params.id,vm.addMoneylist={1:"0",2:"50000",3:"100000"},vm.mainPlan={},vm.addPlan=[],vm.plans={},vm.sex=vm.insureData?vm.insureData.sex||"1":"1",vm.birthday=vm.insureData?vm.insureData.birthday||"":"",vm.social=vm.insureData?vm.insureData.socialSecurity||"Y":"Y",vm.pay_methed=vm.insureData?vm.insureData.paymentType||"1":"1",vm.coverage=vm.insureData&&vm.insureData.mainPlan?vm.insureData.mainPlan.num:"1",vm.excess=vm.insureData&&vm.insureData.mainPlan?vm.insureData.mainPlan.freeMoney:"1",vm.disabtes=vm.insureData?vm.insureData.disabtes||"1":"1",vm.geriatric=vm.insureData?vm.insureData.geriatric||"1":"1",vm.hmrc_a={plan:"",rate:""},vm.hmrc_b={plan:"",rate:""},vm.hmrc_c={plan:"",rate:""},vm.herc_qus0="",vm.herc_qus="",vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){1==result.status&&(vm.productData=result.data,PolicyService.control({state:$state.current.name,control:"data",data:{productData:vm.productData}}),$timeout(function(){$rootScope.showProductDialog=!0},100),vm.premium=vm.insureData?vm.insureData.PbInsuExp||vm.productData.prdStartPrice:vm.productData.prdStartPrice,vm.productData.plans.forEach(function(item){vm.plans[item.planCode]=item}),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[0].html_file_link,method:"GET"},function(result){vm.herc_qus0=$sce.trustAsHtml(result)}),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[1].html_file_link,method:"GET"},function(result){vm.herc_qus=$sce.trustAsHtml(result)}))})};var rate_hmrc={};$http({method:"GET",url:"../statics/json/rate_HMRC.json?"+new Date}).then(function(res){rate_hmrc=res.data.data});var times=0;vm.loadingPage=function(ars){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage())},2e3))},vm.loadingPage($rootScope),vm.openSafe=function(){vm.showModal_hmrc("app/module/mall/product/hmrc/popup/safe.html")},vm.openOptional=function(){vm.showModal_hmrc("app/module/mall/product/hmrc/popup/optional.html")},vm.next=function(){vm.showModal_hmrc("app/module/mall/product/hmrc/popup/count.html")};var getMaxbirth=function(){var flag_age=VALIDATION.getDateByAge("39"),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()<10?"0"+(new Date).getDate():(new Date).getDate();return nowy+"-"+nowm+"-"+nowd},getMinbirth=function(){var flag_age=VALIDATION.getDateByAge("75"),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()+1<10?"0"+((new Date).getDate()+1):(new Date).getDate()+1;return nowy+"-"+nowm+"-"+nowd};vm.showModal_hmrc=function(url,animation){var self=$rootScope;self.maxbirth=getMaxbirth(),self.minbirth=getMinbirth(),$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.policyData={sex:vm.sex,birthday:vm.birthday,social:vm.social,pay_methed:vm.pay_methed,coverage:vm.coverage,excess:vm.excess,disabtes:vm.disabtes,geriatric:vm.geriatric,premium:vm.premium,plans:self.plans},$rootScope.$on("$stateChangeStart",function(){self.modal.remove()}),self.close=function(){self.modal.remove()},self.plans={},self.next=function(){if(!self.policyData.birthday)return void TipService.showMsg("请选择被保人出生日期","errorAlert",1e3);var params={insurerBirthDay:self.policyData.birthday,orderCode:"",planId:self.plans.planId,prdId:vm.productData.prd_id,premiumResult:self.policyData.premium,sex:Number(self.policyData.sex)};CommonRequest.request(params,CONFIG.PREMIUM_RESULT_SERVICE,function(result){1==result.status&&(vm.productData.orderCode=result.data.orderCode,PolicyService.control({state:$state.current.name,control:"data",data:{productData:vm.productData,insureData:{birthday:$filter("date")(self.policyData.birthday,"yyyy-MM-dd"),sex:self.policyData.sex,orderCode:result.data.orderCode,mainPlan:vm.getMainPlan(self.policyData),addPlan:vm.getAddPlan(self.policyData),payendyear:"1",paymentType:self.policyData.pay_methed,PbInsuExp:self.policyData.premium,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:"40",maxAge:"75",minHolderAge:"40",maxHolderAge:"75",calcCtrl:vm,disabtes:self.policyData.disabtes,geriatric:self.policyData.geriatric,socialSecurity:self.policyData.social,rate_hmrc:rate_hmrc}}}),PolicyService.control({state:$state.current.name,control:"process"}),self.modal.remove())})},self.calculation=function(key,value){if(self.policyData[key]=value,vm[key]=value,61<=VALIDATION.getAgeByBirth(self.policyData.birthday)&&VALIDATION.getAgeByBirth(self.policyData.birthday)<=75&&"1"!==self.policyData.disabtes){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"您所选的年龄不支持投保该项责任",okText:"0万"});alertPopup.then(function(res){res&&(self.policyData.disabtes="1")})}var age=VALIDATION.getAgeByBirth(self.policyData.birthday);if(40>age)return void(self.policyData.premium=0);var getF=function(){if("1"===self.policyData.coverage){var x="1"===self.policyData.excess?"HMRC00001":"HMRC00002",y="1"===self.policyData.excess?0:1;return self.plans=vm.plans[x],"0000"+(y+1)}var x="1"===self.policyData.excess?"HMRC00003":"HMRC00004",y="1"===self.policyData.excess?2:3;return self.plans=vm.plans[x],"0000"+(y+1)},flag="HMRCa_"+getF()+("1"===self.policyData.pay_methed?"M":"Y"),getM=function(){return rate_hmrc[flag].find(function(item){return item.age.split("-")[0]<=age&&age<=item.age.split("-")[1]?item:void 0})};vm.hmrc_a.rate=getM(),vm.hmrc_a.plan=self.plans,vm.hmrc_b.plan=vm.plans.HMRCb,vm.hmrc_c.plan=vm.plans.HMRCc,"1"!==self.policyData.disabtes?(flag="HMRCb_"+("1"===self.policyData.sex?"b":"g")+("1"===self.policyData.pay_methed?"M":"Y"),vm.hmrc_b.rate=getM()):vm.hmrc_b.rate=0,"1"!==self.policyData.geriatric?(flag="HMRCc_"+("1"===self.policyData.sex?"b":"g")+("1"===self.policyData.pay_methed?"M":"Y"),vm.hmrc_c.rate=getM()):vm.hmrc_c.rate=0;var b=vm.hmrc_b.rate?Number(vm.hmrc_b.rate.rate)*("3"===self.policyData.disabtes?2:1):0,c=vm.hmrc_c.rate?Number(vm.hmrc_c.rate.rate)*("3"===self.policyData.geriatric?2:1):0;self.policyData.premium=(Number(vm.hmrc_a.rate.rate)+b+c).toFixed(2),vm.premium=(Number(vm.hmrc_a.rate.rate)+b+c).toFixed(2)},$scope.$watch("policyData.birthday",function(newValue){self.calculation("birthday",newValue)})})},vm.getMainPlan=function(item){return vm.mainPlan={amount:"1"===item.coverage?"1000000":"2000000",exp:vm.hmrc_a.rate.rate,freeMoney:item.excess,insuYear:vm.hmrc_a.plan.insuYear,insuYearFlag:vm.hmrc_a.plan.insuYearFlag,maxBuyQautity:vm.hmrc_a.plan.maxBuyQautity,minBuyQautity:vm.hmrc_a.plan.minBuyQautity,normalPrice:vm.hmrc_a.plan.normalPrice,num:item.coverage,planCode:vm.hmrc_a.plan.planCode,planId:vm.hmrc_a.plan.planId,planName:vm.hmrc_a.plan.planName,planType:vm.hmrc_a.plan.planType,rate:0},vm.mainPlan},vm.getAddPlan=function(item){return vm.addPlan=[],"1"!==item.disabtes&&vm.addPlan.push({amount:vm.addMoneylist[item.disabtes],exp:vm.hmrc_b.rate.rate,num:item.disabtes,planCode:vm.hmrc_b.plan.planCode,planId:vm.hmrc_b.plan.planId,planName:vm.hmrc_b.plan.planName,planType:vm.hmrc_b.plan.planType,rate:0,insScmInf:""}),"1"!==item.geriatric&&vm.addPlan.push({amount:vm.addMoneylist[item.geriatric],exp:vm.hmrc_c.rate.rate,num:item.geriatric,planCode:vm.hmrc_c.plan.planCode,planId:vm.hmrc_c.plan.planId,planName:vm.hmrc_c.plan.planName,planType:vm.hmrc_c.plan.planType,rate:0,insScmInf:""}),vm.addPlan},vm.ifNavFloTrue=!1,vm.scroll=function(){var navScrollTop=document.querySelector(".optimze-byj").scrollTop,h1=document.getElementById("heightBox").offsetHeight,t1=document.getElementById("tab1").offsetTop,t2=document.getElementById("tab2").offsetTop,t3=document.getElementById("tab3").offsetTop,timer=$timeout(function(){navScrollTop>=h1?(vm.ifNavFloTrue=!0,navScrollTop+145>=t1&&(vm.longActive=1,navScrollTop+145>=t2&&(vm.longActive=2,navScrollTop+145>=t3&&(vm.longActive=3)))):vm.ifNavFloTrue=!1,$timeout.cancel(timer)},50)},vm.longActive=1,vm.goToTab=function(index){$location.hash("tab"+index),$anchorScroll(),vm.longActive=index},vm.goToContent=function(){$location.hash("content"),$anchorScroll()}}angular.module("app").controller("HmrcCalculateController",HmrcCalculateController),HmrcCalculateController.$inject=["$state","$sce","VALIDATION","$document","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$ionicPopup","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicModal","COMMON","$http"]}(),function(){function HmrcInfoinputController($state,$compile,VALIDATION,$document,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,PolicyService,$ionicPopup,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicModal,COMMON,$http){function transOrigin(data){if(BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var dataLocation=result.addressComponents;vm.area=result.addressComponents,vm.gudgeIsLocation=dataLocation.province,vm.gudgeCity=dataLocation.city,vm.gudgeDistrict=dataLocation.district,$scope.getDistrictLevel1([vm.gudgeIsLocation,vm.gudgeCity],vm.gudgeDistrict)}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"定位功能暂不可用",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.preInsureFlag=vm.productData.preInsureFlag,vm.saleNetAdress=!1,$rootScope.prdId=vm.productData.prd_id,vm.calc=vm.insureData.calc?eval("("+vm.insureData.calc+")"):null,vm.calcAdd=vm.insureData.calcAdd?eval("("+vm.insureData.calcAdd+")"):null,vm.addplanFlag=!1,vm.calcCtrl=vm.insureData.calcCtrl||null,vm.userData=sessionData.userData||{},vm.policyData=sessionData.policyData||{};var codetiming;vm.isMsg=!1,vm.agree1=!1,vm.mindate=new Date,vm.maxdate=new Date("2099-12-31"),vm.init=function(){vm.maDetailM01={},vm.maDetailM03={},vm.maDetailM05={},vm.coverage=vm.insureData.mainPlan.num,vm.excess=vm.insureData.mainPlan.freeMoney,vm.disabtes=vm.insureData.disabtes,vm.geriatric=vm.insureData.geriatric,vm.name="",vm.bank="",vm.refeFlag=!0;if(vm.selctCity=!0,vm.tipsDivShow=!1,vm.duration=60,vm.messContent="获取验证码",vm.msg="",vm.isshowSale=!1,vm.PbInsuExp=vm.insureData.PbInsuExp,vm.userData.cretType?(vm.certType=vm.userData.cretType,vm.certTypeDisabled=!0,vm.certTypes=COMMON.getCertTypesByCode(vm.userData.cretType)):(vm.certType=vm.policyData.PbHoldIdType||"A",vm.certTypes=COMMON.getCertTypesByCode(vm.certType)),vm.userData.cretNo?(vm.certNo=vm.userData.cretNo,vm.certNoDisabled=!0):vm.certNo=vm.policyData.PbHoldId||"",vm.nationalities="",vm.userData.cretType?(vm.nationalities=COMMON.getNationalitiesByCertType(vm.userData.cretType),vm.nationality=vm.nationalities[0].value):vm.nationality=vm.policyData.PbNationality||"0156",vm.userData.customerName?(vm.name=vm.userData.customerName,vm.nameDisabled=!0):vm.name=vm.policyData.PbHoldName||"",vm.certStartDate=vm.policyData.PbIdStartDate||"",vm.certExpireDate=vm.policyData.certExpireDate||"20991231",vm.certExpireType="20991231"===vm.certExpireDate?"01":"02",vm.gender="1",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender=VALIDATION.getSex(vm.certNo),vm.genderDisabled=!0):vm.userData.sex?(vm.gender=vm.userData.sex,vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender=vm.policyData.PbHoldSex),vm.birthday="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.birthday=$filter("date")(new Date(VALIDATION.getBirthday(vm.certNo)),"yyyy-MM-dd"),vm.birthdayDisabled=!0):vm.userData.birthday&&8==vm.userData.birthday.length?(vm.birthday=$filter("date")(new Date(VALIDATION.dateFormat(vm.userData.birthday)),"yyyy-MM-dd"),vm.birthdayDisabled=!0):vm.policyData.PbHoldBirdy&&8==vm.policyData.PbHoldBirdy.length&&(vm.birthday=$filter("date")(new Date(VALIDATION.dateFormat(vm.policyData.PbHoldBirdy)),"yyyy-MM-dd")),vm.userData.phoneNo?(vm.phone=vm.userData.phoneNo,vm.phoneDisabled=!0,vm.isMsg=!0):vm.phone=vm.policyData.PbHoldMobl||"",vm.email=vm.policyData.PbHoldEmail||"",vm.occupation=vm.policyData.PbHoldOccupCode||"",vm.occupations="",vm.PbHoldOccupCode=vm.policyData.PbHoldOccupCode||"C0000",vm.PbHoldOccupText=vm.policyData.PbHoldOccupText||"办事人员和有关人员",vm.area="",vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.homeTel=vm.policyData.PbHoldHomeTele||"",vm.officeAddress=vm.policyData.PbHoldAddr||"",vm.officeZipCode=vm.policyData.PbHoldPost||"",vm.officeTel=vm.policyData.PbHoldOfficTele||"",vm.loanContractCode=vm.policyData.loanContractCode||"",vm.theBankCode=COMMON.getCommonData().BANK_CODE,vm.policyData.newGetBkCode&&""!=vm.policyData.newGetBkCode)for(var i=0;i<vm.theBankCode.length;i++)vm.policyData.newGetBkCode==vm.theBankCode[i].value&&(vm.newGetBkCode=vm.theBankCode[i]);switch(vm.BkAcctNo3=vm.policyData.BkAcctNo3||"",vm.getAllProvince=function(){var params={};CommonRequest.request(params,CONFIG.GET_ALL_LEVEL_ONE_SERVCIE,function(result){if(1==result.status&&(vm.allProvince=result.data,vm.policyData.NewGetBkPvCode&&""!=vm.policyData.NewGetBkPvCode))for(i=0;i<vm.allProvince.length;i++)vm.policyData.NewGetBkPvCode==vm.allProvince[i].areaCode&&(vm.newBankProvince=vm.allProvince[i])})},vm.PbBenfer=vm.policyData.PbBenfer||"",vm.startdate=new Date,vm.policyData.surLoanTime&&vm.policyData.surLoanTime.length>0&&(vm.surLoanTime=$filter("date")(vm.policyData.surLoanTime,"yyyy-MM-dd")),vm.noPepayLoanPrice=vm.insureData.noPepayLoanPrice,vm.minHolderAge=vm.insureData.minHolderAge,vm.maxHolderAge=vm.insureData.maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.socialSecurity=vm.policyData.socialSecurity||"Y",vm.relation="08",vm.iflocinit=!1,vm.policyData.confirmRela&&(vm.relation="06"==vm.policyData.confirmRela||"07"==vm.policyData.confirmRela?"08":vm.policyData.confirmRela,vm.iflocinit=!0),vm.referrNameFlag=1,vm.referrerCodeChecked=!1,vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.NEW_SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data){var res=result.data.filter(function(v){return v.prdId==$rootScope.prdId});vm.referrNameFlag=0!=res.length?1:0}})},vm.getSaleChannelPort(),vm.checkReferrer=function(){1==vm.referrNameFlag&&vm.referrerCode&&CommonRequest.request({agentNo:vm.referrerCode},CONFIG.SELECT_AgentInfo,function(res){if(1==res.status){if("C99"==res.data.agentgrade||!res.data.agentgrade)return void TipService.showMsg("推荐人填写有误，请确认");vm.referrerName=res.data.name,vm.referrerOrg=res.data.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0}else vm.referrerName="",vm.referrerOrg="",vm.showCodeList=!1,vm.referrerCodeChecked=!0})},vm.checkReferrerName=function(){if(1==vm.referrNameFlag&&vm.referrerName&&vm.referrerName.length>0){for(var len=0,i=0;i<vm.referrerName.length;i++)vm.referrerName.charCodeAt(i)>255?len+=2:len++;console.info("referrerName",len),len>3?"1"==vm.referrNameFlag&&CommonRequest.request({agentName:vm.referrerName},CONFIG.SELECT_AgentInfoByname,function(res){1==res.status&&res.data&&res.data.length?(vm.showCodeList=!0,vm.referrerCodeList=res.data):(vm.showCodeList=!1,vm.referrerCodeList=[])}):vm.showCodeList=!1}},vm.selectCode=function(val){val&&(vm.referrerCode=val.agentNumber,vm.referrerName=val.name,vm.referrerOrg=val.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0)},vm.isshowSaleCheck=function(){vm.isshowSale=!vm.isshowSale,vm.referrerCode="",vm.referrerName="",vm.showCodeList=!1,vm.referrerCodeChecked=!1},vm.insureCertType="A",vm.insureCertNo=vm.policyData.LiRcgnId||"",vm.insureCertTypes=[],vm.insureNationalities=vm.policyData.LiNationality||"0156",vm.insureName=vm.policyData.LiRcgnName||"",vm.insureGender=vm.insureData.LiRcgnSex||"1",vm.insureCertNo?vm.insureGender=VALIDATION.getSex(vm.insureCertNo):vm.policyData.LiRcgnSex&&(vm.insureGender=vm.policyData.LiRcgnSex),vm.insureBirthday=vm.insureData.birthday||"",vm.insureCertNo?vm.insureBirthday=$filter("date")(new Date(VALIDATION.getBirthday(vm.insureCertNo)),"yyyy-MM-dd"):vm.policyData.LiRcgnBirdy&&8==vm.policyData.LiRcgnBirdy.length&&(vm.insureBirthday=$filter("date")(new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy)),"yyyy-MM-dd")),vm.LiRcgnOccupText=vm.policyData.LiRcgnOccupText||"离退休人员",vm.LiRcgnOccupCode=vm.insureData.LiRcgnOccupCode||"R0054",vm.insureCertExpireDate=vm.policyData.insureCertExpireDate||"20991231",vm.LiIdStartDate="20991231"===vm.insureCertExpireDate?"01":"02",vm.minAge=vm.insureData.minAge,vm.maxAge=vm.insureData.maxAge,vm.insureStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.insureEndDate=VALIDATION.getDateByAge(vm.minAge),vm.children=VALIDATION.getDateByAge("18"),vm.minStartDate=new Date((new Date).getTime()+864e5),vm.province={},vm.provinceData=[],PolicyService.getDistrict({prdId:vm.productData.prd_id,areaLevel:1,preInsureFlag:vm.preInsureFlag},function(data){if(vm.provinceData=data,vm.city={},vm.cityData=[],vm.district={},vm.districtData=[],vm.policyData.districtCode)for(var i=0;i<vm.provinceData.length;i++)vm.policyData.districtCode==vm.provinceData[i].areaCode&&(vm.province=vm.provinceData[i])}),vm.city={},vm.cityData=[],vm.district={},vm.districtData=[],vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.provinceNets=[],vm.provinceNet={},vm.cityNets=[],vm.cityNet={},vm.districtNets=[],vm.districtNet={},vm.livePlace=vm.policyData.PbLivePlace||"0",vm.yearIncome=vm.policyData.PbYearIncome||"",vm.referrerCode=vm.policyData.referrerCode||"",vm.referrerName=vm.policyData.referrerName||"",vm.benefitNumber=0,vm.disputeHanding="1",vm.showDisName=function(){$document[0].policyInfoForm.disputeGroupName.focus()},vm.renteDrawMode="1",vm.bonusGetMode="2",vm.isBatts="1"===vm.insureData.paymentType||!0,vm.paymentType=vm.insureData.paymentType,vm.newPayMode="7",vm.healthTag="0",vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params)}},vm.showRenewal1=!1,vm.showRenewal2=!1,"Y"==vm.productData.basicProfile.P010&&("1"==vm.isBatts&&$scope.$watch("policyInfo.isBatts",function(newValue){"1"==newValue?vm.showRenewal1=!0:vm.showRenewal1=!1}),vm.insureData.isWholeSale?vm.showRenewal2=!1:vm.showRenewal2=!0),vm.insuYearFlag=vm.insureData.mainPlan.insuYearFlag,vm.insuYearFlag){case"D":vm.PbInsuYearFlag="5";break;case"M":vm.PbInsuYearFlag="4";break;case"Y":vm.PbInsuYearFlag="2";break;case"A":vm.PbInsuYearFlag="6"}if(vm.prdAccount=vm.insureData.prdAccount,vm.PbInsuExp1="",vm.PbInsuExp2="",vm.LiImpawnTag="",vm.prdAccount&&vm.prdAccount.length>0){for(var j=0;j<vm.prdAccount.length;j++)vm.PbInsuExp2=vm.PbInsuExp2+vm.prdAccount[j].PbInsuExp+";",vm.PbInsuExp1=vm.PbInsuExp1+vm.prdAccount[j].accountCode+";";vm.PbInsuExp2=vm.PbInsuExp2.substr(0,vm.PbInsuExp2.length-1),vm.PbInsuExp1=vm.PbInsuExp1.substr(0,vm.PbInsuExp1.length-1),vm.LiImpawnTag="2"}vm.liveCountry="中国",vm.taxPymtNoType="01",vm.signDate=$filter("date")(new Date,"yyyy年MM月dd日"),vm.isSelf="本人",vm.crsList=[{seqNo:1,taxPymtNoType:""}],vm.addCrs=function(){if(!(vm.crsList.length>=3)){var seqNo=vm.crsList[vm.crsList.length-1].seqNo+1;vm.crsList.push({seqNo:seqNo,taxPymtNoType:""})}},vm.delCrs=function(seqNo){if(vm.crsList.length<=1)return void vm.addCrs();for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&vm.crsList.splice(i,1)},vm.clearInput=function(Type,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&("1"==Type?vm.crsList[i].nonTaxPymtDesc="":"2"==Type&&(vm.crsList[i].taxPymtNo=""))},vm.birthProvince={},vm.birthProvinceData=[],PolicyService.getCrsDistrict({areaLevel:1},function(data){if(vm.birthProvinceData=data,vm.birthDistrict={},vm.birthDistrictData=[],vm.birthDstc={},vm.birthDstcData=[],vm.policyData.districtCode)for(var i=0;i<vm.birthProvinceData.length;i++)vm.policyData.districtCode==vm.birthProvinceData[i].areaCode&&(vm.birthProvince=vm.birthProvinceData[i])}),vm.birthDistrict={},vm.birthDistrictData=[],vm.birthDstc={},vm.birthDstcData=[],vm.rate_hmrc=vm.insureData.rate_hmrc},vm.ifRightIdcer="0",vm.ifRightIdins="0",vm.ifRightSection="0",vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.productData.prd_id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if(("M01"==vm.materials[i].materialType||"M03"==vm.materials[i].materialType||"M05"==vm.materials[i].materialType)&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){var key="maDetail"+result.data[0].materialType;result.data[0].url=CONFIG.IMAGE_SERVICE_ADDRESS+result.data[0].materialPath,vm[key]=result.data[0]}})}})},vm.getProductMaterials(),$scope.$watch("hmrcInfoinput.referrerCode",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$watch("hmrcInfoinput.referrerName",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$watch("hmrcInfoinput.insureCertNo",function(newValue){!newValue||18>newValue||vm.ifAge(newValue,"ins")||(vm.setSex(),vm.setExp(newValue))}),$scope.$watch("hmrcInfoinput.certNo",function(newValue){if(!(!newValue||18>newValue||vm.ifAge(newValue,"cer"))&&(vm.setSex(),"01"==vm.relation)){if(vm.ifAge(newValue,"ins"))return;if(vm.iflocinit)return;
vm.setExp(newValue)}}),$scope.$watch("hmrcInfoinput.relation",function(newValue){if("01"==newValue){if(vm.iflocinit)return void(vm.iflocinit=!1);vm.setExp(vm.certNo),vm.ifAge(vm.certNo,"ins")}vm.setSex()}),vm.setSex=function(){vm.gender=vm.certNo?VALIDATION.getSex(vm.certNo):"",vm.insureGender=vm.insureCertNo?VALIDATION.getSex(vm.insureCertNo):"","01"==vm.relation&&(vm.insureGender=vm.gender)},vm.ifAge=function(id,or){if(!VALIDATION.idCheck(id))return!0;var birth=VALIDATION.getBirthday(id);if("cer"==or&&birth){var cerBirmsg="";if(VALIDATION.getAgeByBirth(birth)<18?cerBirmsg="本产品的投保人年龄范围为18周岁以上。":VALIDATION.getAgeByBirth(birth)>75&&(cerBirmsg="本产品的投保人年龄范围为75周岁以下。"),cerBirmsg){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:cerBirmsg,okText:"我知道了"});return alertPopup.then(function(res){res&&(vm.ifRightIdcer=cerBirmsg)}),!0}vm.ifRightIdcer="0"}if(("ins"==or||"01"==vm.relation)&&birth){if(VALIDATION.getAgeByBirth(birth)<40||VALIDATION.getAgeByBirth(birth)>75){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"本产品的被保人年龄范围为40周岁至75周岁。",okText:"我知道了"});return alertPopup.then(function(res){res&&("ins"==or?vm.ifRightIdins="本产品的被保人年龄范围为40周岁至75周岁。":vm.ifRightIdcer="本产品的被保人年龄范围为40周岁至75周岁。")}),!0}"ins"==or?vm.ifRightIdins="0":vm.ifRightIdcer="0"}if(vm.insureCertNo&&VALIDATION.idCheck(vm.insureCertNo)&&vm.certNo&&VALIDATION.idCheck(vm.certNo)&&"08"===vm.relation&&VALIDATION.getAgeByBirth(VALIDATION.getBirthday(vm.insureCertNo))<=VALIDATION.getAgeByBirth(VALIDATION.getBirthday(vm.certNo))){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"为父母投保时，被保险人的年龄不能小于投保人得年龄。",okText:"我知道了"});return alertPopup.then(function(res){res&&(vm.ifRightSection="为父母投保时，被保险人的年龄不能小于投保人得年龄。")}),!0}return vm.ifRightSection="0",!1},vm.setExp=function(id){var i,addplan={},birth=VALIDATION.getBirthday(id);if(birth&&VALIDATION.getAgeByBirth(birth)>=61&&VALIDATION.getAgeByBirth(birth)<=75){if(addplan=vm.insureData.addPlan.find(function(item,index){return i=index,"HMRCb"===item.planCode})){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"由于被保险人的年龄发生变化，您所选择的附加险种“2性糖尿病发症”的保额已变化，请知晓，谢谢！",okText:"我知道了"});alertPopup.then(function(res){res&&(vm.disabtes="1",vm._planblank=addplan,vm.insureData.addPlan.splice(i,1),PolicyService.setSessionData({insureData:{disabtes:"1"}}))})}}else if(birth&&vm._planblank&&(addplan=vm.insureData.addPlan.find(function(item,index){return i=index,"HMRCb"===item.planCode}),!addplan)){var alertPopup=$ionicPopup.alert({cssClass:"popup-icon",template:"由于被保险人的年龄发生变化，您所选择的附加险种“2性糖尿病发症”的保额已变化，请知晓，谢谢！",okText:"我知道了"});alertPopup.then(function(res){res&&(vm.disabtes=vm._planblank.num,vm.insureData.addPlan.push(vm._planblank),PolicyService.setSessionData({insureData:{disabtes:vm._planblank.num}}),vm._planblank="")})}vm.calculation()},vm.calculation=function(){var id="01"==vm.relation?vm.certNo:vm.insureCertNo;if(!id)return void(vm.PbInsuExp=0);var birth=VALIDATION.getBirthday(id),sex=VALIDATION.getSex(id),age=VALIDATION.getAgeByBirth(birth);if(40>age)return void(vm.PbInsuExp=0);var getF=function(){if("1"===vm.coverage){var x="1"===vm.excess?0:1;return"0000"+(x+1)}var x="1"===vm.excess?2:3;return"0000"+(x+1)},flag="HMRCa_"+getF()+("1"===vm.paymentType?"M":"Y"),getM=function(){return vm.rate_hmrc[flag].find(function(item){return item.age.split("-")[0]<=age&&age<=item.age.split("-")[1]?item:void 0})};vm.hmrc_a=getM(),"1"!==vm.disabtes?(flag="HMRCb_"+("1"==sex?"b":"g")+("1"===vm.paymentType?"M":"Y"),vm.hmrc_b=getM()):vm.hmrc_b=0,"1"!==vm.geriatric?(flag="HMRCc_"+("1"==sex?"b":"g")+("1"===vm.paymentType?"M":"Y"),vm.hmrc_c=getM()):vm.hmrc_c=0;var b=vm.hmrc_b?Number(vm.hmrc_b.rate)*("3"===vm.disabtes?2:1):0,c=vm.hmrc_c?Number(vm.hmrc_c.rate)*("3"===vm.geriatric?2:1):0;vm.PbInsuExp=vm.hmrc_a.rate?(Number(vm.hmrc_a.rate)+b+c).toFixed(2):0},vm.setPaymentType=function(item){vm.paymentType=item,vm.calculation()},vm.setRelation=function(key){vm.relation=key,"08"!==key&&"03"!==key||(vm.insureName="",vm.insureCertNo="",vm.insureCertExpireDate="20991231",vm.socialSecurity="Y",vm.LiRcgnOccupText="离退休人员"),vm.calculation()},$scope.$watch("hmrcInfoinput.certNo",function(newValue){vm.birthday=$filter("date")(new Date(VALIDATION.getBirthday(vm.certNo)),"yyyy-MM-dd")}),$scope.$watch("hmrcInfoinput.insureCertNo",function(newValue){vm.insureBirthday=$filter("date")(new Date(VALIDATION.getBirthday(vm.insureCertNo)),"yyyy-MM-dd")}),$scope.$watch("hmrcInfoinput.LiRcgnOccupCode",function(newValue){"Y0000"!=newValue&&"R0047"!=newValue&&"R0022"!=newValue||(vm.LiRcgnOccupCode="",vm.LiRcgnOccupText="")}),$scope.$watch("hmrcInfoinput.PbHoldOccupCode",function(newValue){"Y0000"!=newValue&&"R0047"!=newValue&&"R0022"!=newValue||(vm.PbHoldOccupCode="",vm.PbHoldOccupText="")}),vm.setExpireDate=function(key){"20991231"===vm[key]?vm[key]="":vm[key]="20991231"};var TIPS=$rootScope.TIPS,alertMsg;vm.errorAlert=function(key,val){"a_name"!=key&&"b_name"!=key||(1==val.invalid?alertMsg=TIPS.COMMON.USER_NAME_INVALID:"length"==val&&(alertMsg=TIPS.COMMON.USER_NAME_LENGTH_ERROR)),"phone"==key&&1==val.invalid&&(alertMsg=TIPS.COMMON.PHONE_INVALID),"insureCertNo"!=key&&"a_id"!=key||(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID:1==val.length&&(alertMsg="您输入的证件号长度不符")),"email"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符")),"account"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.ZIPCODE_INVALID:1==val.length&&(alertMsg=TIPS.COMMON.BANKNO_LENGTH_ERROR)),"address"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.ADDRESS_INVALID:1==val.length?alertMsg=TIPS.COMMON.ADDRESS_LENGTH_ERROR:1==val.number&&(alertMsg=TIPS.COMMON.ADDRESS_NUMBER_ERROR)),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")},vm.dataCheck=function(){return(vm.insureName&&vm.insureCertNo&&vm.insureCertExpireDate&&vm.LiRcgnOccupText||"01"===vm.relation)&&vm.name&&vm.certNo&&vm.certExpireDate&&vm.PbHoldOccupText&&(vm.bank&&vm.BkAcctNo3||!vm.isBatts&&"1"!==vm.paymentType)&&(vm.isMsg||vm.phoneDisabled)&&vm.email&&vm.area&&vm.address?!!(!vm.isshowSale||vm.referrerName&&vm.referrerCode):!1},vm.getPolicyData=function(){if(vm.checkRelation=function(relation,gender){return"01"==relation?"01":"03"==relation?"03":"08"==relation?"08":void 0},vm.addPlan=vm.insureData.addPlan,vm.addPlan)if(angular.isArray(vm.addPlan)||(vm.addPlan=[vm.addPlan]),vm.BkNum1=0,vm.AppdList=[],vm.insureData.loveheaPlan)for(var i=0;i<vm.addPlan.length;i++)vm.BkNum1++,vm.AppdList.push({cvrID:vm.addPlan[i].planCode,cvrNm:vm.addPlan[i].planName,insCps:1,insPremAmt:"",insCvr:vm.addPlan[i].amount,insDdln:vm.insureData.addPlan.insuYear,insPremPyFMtdCd:"0"==vm.paymentType?"0":"12",insPremPyFPrdNum:"1",LiBackTag:vm.isBatts,mainAndAdlInsInd:"0",prdId:vm.productData.prd_id,planId:vm.addPlan[i].planId,socialSecurity:vm.socialSecurity});else for(var i=0;i<vm.addPlan.length;i++)vm.BkNum1++,vm.AppdList.push({cvrID:vm.addPlan[i].planCode,cvrNm:vm.addPlan[i].planName,insCps:1,insPremAmt:"",insCvr:vm.addPlan[i].amount,insDdln:vm.insureData.mainPlan.insuYear,insPremPyFPrdNum:vm.insureData.payendyear,LiBackTag:vm.isBatts,mainAndAdlInsInd:"0",prdId:vm.productData.prd_id,planId:vm.addPlan[i].planId,socialSecurity:vm.socialSecurity});if(vm.provinceNet&&vm.cityNet&&vm.districtNet){var provinceName=vm.provinceNet.netName?vm.provinceNet.netName:"",cityName=vm.cityNet.netName?"-"+vm.cityNet.netName:"",districtName=vm.districtNet.netName?"-"+vm.districtNet.netName:"";vm.allWebsite=provinceName+cityName+districtName}var params={SellTypeDetail:CONFIG.SALE_CHANNEL,orderCode:vm.productData.orderCode,PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldIdType:vm.certType,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase():vm.certNo,PbIdStartDate:vm.certStartDate,PbIdEndDate:vm.certExpireDate.replace(/-/g,""),certExpireDate:vm.certExpireDate,PbNationality:vm.nationality,PbHoldAddr:vm.province.areaCode+","+vm.city.areaCode,PbHoldPost:vm.zipCode,PbHoldOfficTele:"",PbHoldHomeAddr:vm.address,PbHoldHomePost:"000000",PbHoldHomeTele:vm.phone,PbHoldMobl:vm.phone,PbHoldEmail:vm.email,PbHoldOccupCode:vm.PbHoldOccupCode,PbHoldOccupText:vm.PbHoldOccupText,confirmRela:"08"===vm.relation?"1"==vm.gender?"06":"07":vm.relation,PbHoldRcgnRela:"08"===vm.relation?"1"==vm.gender?"06":"07":vm.relation,certExpireType:vm.certExpireType,area:vm.area,socialSecurity:vm.socialSecurity,LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase():vm.certNo:"A"==vm.insureCertType?vm.insureCertNo.toUpperCase():vm.insureCertNo,LiIdStartDate:vm.LiIdStartDate,insureCertExpireDate:vm.insureCertExpireDate,LiIdEndDate:"01"==vm.relation?vm.certExpireDate.replace(/-/g,""):vm.insureCertExpireDate.replace(/-/g,""),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationalities,LiRcgnAddr:vm.address,LiRcgnPost:"000000",LiRcgnTele:"",LiRcgnMobl:vm.phone,LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.PbHoldOccupCode:vm.LiRcgnOccupCode,LiRcgnOccupText:"01"==vm.relation?vm.PbHoldOccupText:vm.LiRcgnOccupText,liveProvince:vm.province.areaName||"",districtCode:vm.province.areaCode||"",PlchdProvCd:vm.province.areaCode||"",liveDistrict:vm.city.areaName||"",cityCode:vm.city.areaCode||"",PlchdCityCd:vm.city.areaCode||"",PlchdDstcCd:vm.district.areaCode||"",liveDstc:vm.district.areaName||"",PbOtherProvinceCode:vm.isCrossArea?vm.province.areaCode:"",crossAreaFlag:vm.isCrossArea?"1":"0",BkBrchNo:vm.staffOrgCode,PbLivePlace:vm.livePlace,PbYearIncome:vm.yearIncome,agentCode:vm.staffId,PbWebsiteCode:vm.bank.netCode||"",PbWebsiteName:vm.bank.netName||"",allWebsite:vm.allWebsite,bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||"",referrerCode:vm.isshowSale?vm.referrerCode:"",referrerName:vm.isshowSale?vm.referrerName:"",insScmInf:vm.insureData.mainPlan.planCode,PbBenfNum:"0",PbInsuType:vm.productData.prd_code,PbInsuName:vm.productData.prd_title,mainAndAdlInsInd:"1",PbSlipNumb:1,PbInsuExp:"",PbInsuAmt:vm.insureData.mainPlan.amount,PbMainInsuExp:0,PbInsuExpAppd:0,PbSendMode:"2",PbBeginDate:vm.insureData.BaigPbBeginDate||vm.insureData.PbBeginDate,PbInsuPayMode:vm.renewalBankAccount&&vm.renewalBank?"0":"",LiSpec:"",LiExpireInsuDrawMode:"",PbAutoPayTag:"0",LiPayOffTag:"",PbPayPeriod:vm.paymentType,PbPayAgeTag:vm.insureData.BaigPbPayAgeTag||vm.insureData.payendyear||"1",PbInsuYearFlag:vm.PbInsuYearFlag,LiInsuPeriod:vm.insureData.mainPlan.insuYear,PbInsuYear:0,PbPayAge:0,PbDrawAgeTag:"",PbDrawAge:0,LiImpawnTag:vm.LiImpawnTag||"",BkNum1:vm.BkNum1||0,AppdList:vm.AppdList||[],BkNum2:0,PbApplNo:vm.PbApplNo||"",BkVchNo:"",LiInsuSlipPWD:"",PiTrfVchNo:"",BkRckrNo:"",PiZyzcfs:vm.disputeHanding,PiZcinst:vm.disputeGroupName,PiZxbe20:0,BkAreaNo:"",PiManBankNo:"",PbRemark1:vm.productData.token||"1"==vm.hasDiscount?"0":"1",PbRemark2:vm.productData.token?2:"1"==vm.hasDiscount?"1":"0",PbRemark3:vm.productData.token?"0.00000000":vm.discount||"",PbRemark4:vm.productData.lotCode?vm.productData.lotCode:vm.disActivityId||"",PbRemark5:vm.productData.prd_title,PbRemark6:vm.insureData.BaigPbRemark6||"",disActId:vm.productData.token||"1"==vm.configType||"4"==vm.configType?"0000":vm.staffOrgCode.substr(0,4),saleChnl:"2"==vm.configType||"4"==vm.configType?"000":CONFIG.SALE_CHANNEL,PbInsuExp1:vm.PbInsuExp1,PbInsuExp2:vm.PbInsuExp2,allInsuExp:vm.insureData.PbInsuExp,benfSetType:"1",SpecFlag:vm.combineCheck,isBatts:vm.isBatts?"1":"0",BankCode:vm.isBatts||"1"===vm.paymentType?vm.bank.bankCode:"",BankName:vm.name,BkAcctNo3:vm.isBatts||"1"===vm.paymentType?vm.BkAcctNo3:"",renewalBankName:vm.isBatts||"1"===vm.paymentType?vm.bank.netName:"",NewPayMode:vm.newGetBk&&vm.newGetAccount?vm.newPayMode:"",NewGetAccName:vm.newGetBk&&vm.newGetAccount?vm.newGetAccountName:"",NewGetBkName:vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankName:"",NewGetBkCode:vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankCode:"",NewGetAccCode:vm.newGetAccount||"",LiRenteDrawMode:vm.renteDrawMode,AnutyPcsgMtdCd:vm.renteDrawMode,bonusBankCode:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankCode:"",bonusBankName:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankName:"",bonusBankAccountName:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBankAccountName:"",bonusBankAccount:vm.bonusBankAccount||"",LiBonusDistbTag:"",LiBonusGetMode:vm.bonusGetMode,BkAcctNo1:vm.authBankAccount,BkAcctNo2:vm.bonusBankAccount,liBonusBankCode:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankCode:"",LiBonusBankName:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankName:"",liBonusBankAccountName:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBankAccountName:"",liBonusBankAccount:vm.liBonusBankAccount||"",payBankCode:vm.authBank&&vm.authBankAccount?vm.authBank.bankCode:"",authBankName:vm.authBank&&vm.authBankAccount?vm.authBank.bankName:"",payBankNo:vm.authBankAccount||"",payBankName:vm.authBank&&vm.authBankAccount?vm.authAccountName:"",LiHealthTag:vm.healthTag,materials:vm.materials,prdId:vm.productData.prd_id,planId:vm.insureData.mainPlan.planId,dutys:vm.insureData.mainPlan.dutys,discount:vm.discount,payAgeUnit:vm.insureData.BaigPbRemark6?"M":"",preInsureFlag:vm.preInsureFlag,cardToken:vm.productData.token};vm.checkImgCodeForShow?(params.cpRandom=vm.cpRandom,params.cpImageCode=vm.cpImageCode):(params.cpRandom="",params.cpImageCode="");var now=new Date;return now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{insureInfoTime:now}}),params},$rootScope.$on("$stateChangeStart",function(event,toState,toStateParams,fromState,fromStateParams){"product-hmrc-calculate"==toState.name&&(vm.policyData=vm.getPolicyData(),PolicyService.setSessionData({policyData:vm.policyData}))}),$scope.blur=!1,$scope.blurClick=function(){$scope.blur=!0},$scope.focusClick=function(){$scope.blur=!1},$scope.phoneCode="",$scope.txCode="CCBSB100",$scope.dragDisabled=!0,$rootScope.$on("drag-down",function(event,result){$scope.dragDisabled=!1,$scope.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),$scope.getDistrictLevel1=function(areas){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_FIRST_SERVCIE,function(result){if(1==result.status)if(areas){var c=result.data.find(function(item){return item.areaName==areas[0]});$scope.getDistrictLevel2(c,areas)}else $scope.getDistrictLevel2(result.data[0])})},$scope.getDistrictLevel2=function(obj,areas){var params={parentAreaCode:obj.areaCode,areaLevel:2,prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_SECOND_SERVCIE,function(result){if(1==result.status)if(areas){var c=result.data.find(function(item){return item.areaName==areas[1]});$scope.getDistrictLevel3(c,areas)}else $scope.getDistrictLevel3(result.data[0])})},$scope.getDistrictLevel3=function(obj2,areas){var params={parentAreaCode:obj2.areaCode,areaLevel:3,prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_SECOND_SERVCIE,function(result){if(1==result.status){if(areas)var c=result.data.find(function(item){return item.areaName==areas[2]}),config={url:"../statics/product/proxys/"+c.areaCode+".json",method:"GET"};else var config={url:"../statics/product/proxys/"+result.data[0].areaCode+".json",method:"GET"};CommonRequest.request({},config,function(result){var data=result;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}})},$scope.$watch("hmrcInfoinput.staffOrgCode",function(newValue){vm.staffOrgCode&&vm.getBankList(function(){vm.bank&&(vm.bank=vm.bankList.find(function(item){return vm.bank.bankName==item.bankName}))})}),vm.getBankList=function(callback){COMMON.getCommonBank(vm.staffOrgCode,"1",function(bankList){vm.bankList=bankList,vm.newGetBk=vm.bankList[0],angular.isFunction(callback)&&callback()})},$scope.getDistrictLevel1();var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.curData="",vm.occupationData="",vm.tag=$state.params.tag||0,vm.whereType="";var insure_id="";vm.skipCareerType=function(where,contrast,id){vm.careerType=!0,vm.whereType=where,throwContrast=contrast,insure_id=id,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.agecheck=function(birthday){if(birthday){var b=new Date(birthday),d=new Date,age=d.getFullYear()-b.getFullYear()-(d.getMonth()<b.getMonth()||d.getMonth()==b.getMonth()&&d.getDate()<b.getDate()?1:0);return $log.info(age),age}return!1},vm.throwContrastData=function(){if(1===throwContrast?(vm.PbHoldOccupText=vm.curData,vm.PbHoldOccupCode=vm.occupationData):2===throwContrast&&(vm.LiRcgnOccupText=vm.curData,vm.LiRcgnOccupCode=vm.occupationData),"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}vm.careerType=!1},vm.goNext=function(){""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode,pg){if("03"==pg)vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode,vm.careerType=!1;else{if(1===throwContrast?(vm.PbHoldOccupText=vm.curData,vm.PbHoldOccupCode=vm.occupationData):2===throwContrast&&(vm.LiRcgnOccupText=vm.curData,vm.LiRcgnOccupCode=vm.occupationData),"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}vm.careerType=!1}},$scope.$on("selectAreaName",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode},config={url:"../statics/product/proxys/"+vm.district.areaCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}}),$scope.$on("select-branch-group-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),vm.ifLocation=!1,vm.getPosition=function(check){vm.selectCityCompent=0;var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&check&&transOrigin(res)},fail:function(eror){},cancel:function(){}})}),wx.error(function(res){})}})},vm.getPosition(),vm.timingHide=function(res){vm.tipsDiv=res,vm.tipsDivShow=!0,interval=$interval(function(){vm.timing>0&&vm.timing--},1e3)};var regxPhone=/^[1][0-9]{10}$/;vm.phoneImg=!1,$scope.$watch("hmrcInfoinput.timing",function(newValue){0==newValue&&($interval.cancel(interval),vm.tipsDivShow=!1)}),vm.codeStatus=!1,$scope.$watch("hmrcInfoinput.phone",function(newValue){vm.phone&&(11==newValue.length&&regxPhone.test(vm.phone)?(vm.isMsg=!1,vm.messContent="获取验证码",vm.phoneImg=!0,$interval.cancel(codetiming),vm.codeStatus=!1,vm.duration=60):vm.phoneImg=!1)}),vm.getMessageInfo=function(){return void 0==vm.phone||""==vm.phone?(vm.timing=2,void vm.timingHide("手机号码不能为空")):11==vm.phone.length&&regxPhone.test(vm.phone)?void(vm.codeStatus||vm.showMsgSlider()):(vm.timing=2,void vm.timingHide("手机号码格式不正确"))},vm.getmsg=0,vm.showMsgSlider=function(){vm.codeStatus=!0;var self=this;$ionicModal.fromTemplateUrl("app/module/mall/product/hmrc/sms-slider/sms-slider.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!1}).then(function(modal){self.modal=modal,self.modal.show(),$rootScope.hmrcRemove=function(){self.modal.remove()}})};var iTime;$rootScope.hmrcCheck=function(){clearTimeout(iTime),iTime=setTimeout(function(){var messParams={mobileNo:vm.phone,txCode:"CCBSB100"};CommonRequest.request(messParams,CONFIG.SEND_EXPS_MSG_SERVICE,function(result){1==result.status?($interval.cancel(codetiming),vm.countDown()):($interval.cancel(codetiming),vm.messContent="获取验证码",vm.codeStatus=!1,vm.duration=60)})},100)},vm.countDown=function(){codetiming=$interval(function(){vm.duration<=0?($interval.cancel(codetiming),vm.messContent="重新获取",vm.codeStatus=!1,vm.duration=60):(vm.duration--,vm.messContent=vm.duration+"s")},1e3)},$scope.$watch("hmrcInfoinput.msg",function(newValue){if(6==newValue.length){var params={prdId:vm.productData.prd_id,mobileNo:vm.phone,smsCode:newValue};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){1==result.status?(vm.isMsg=!0,$interval.cancel(codetiming),vm.messContent="校验成功",vm.codeStatus=!0,vm.duration=60):(vm.isMsg=!1,$interval.cancel(codetiming),vm.messContent="验证码错误",vm.codeStatus=!1,vm.duration=60)})}}),vm.openRenew=function(){vm.showModal_hmrc("app/module/mall/product/hmrc/popup/renew.html")},vm.next=function(){if(!vm.referrerCodeChecked&&vm.isshowSale)var timer=$timeout(function(){vm.operation(),$timeout.cancel(timer)},800);else vm.operation()},vm.operation=function(){if(vm.referrNameFlag)if(vm.isshowSale){if(!vm.referrerName||!vm.referrerCode)return void TipService.showMsg("请填写推荐人工号或推荐人姓名")}else vm.referrerName="",vm.referrerCode="";if(vm.referrerCode&&"1"==vm.referrNameFlag){if(vm.isCrossArea)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！");if(vm.staffOrgCode!=vm.referrerOrg)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！")}vm.isCrossArea&&(vm.referrerName="",vm.referrerCode=""),vm.showModal_hmrc("app/module/mall/product/hmrc/notice/hmrc-notice.html",!0)},vm.showModal_hmrc=function(url,ifcheck,animation){var rq=vm.dataCheck();if("0"!==vm.ifRightIdcer){if("01"===vm.relation||"本产品的被保人年龄范围为40周岁至75周岁。"!=vm.ifRightIdcer)return void TipService.showMsg(vm.ifRightIdcer,"errorAlert",3e3);vm.ifRightIdcer="0"}if("0"!==vm.ifRightIdins)return void TipService.showMsg(vm.ifRightIdins,"errorAlert",3e3);if("0"!==vm.ifRightSection)return void TipService.showMsg(vm.ifRightSection,"errorAlert",3e3);if(!rq&&ifcheck)return void TipService.showMsg("请完善投保信息","errorAlert",3e3);vm.policyData=vm.getPolicyData(),PolicyService.setSessionData({policyData:vm.policyData});var self=$rootScope;$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.disabtes=vm.disabtes,self.geriatric=vm.geriatric,self.close=function(){self.modal.remove()},self.complete=function(){PolicyService.createPbApplNo(vm.staffOrgCode,function(pbApplNoList){vm.PbApplNo=pbApplNoList[0],vm.PbApplNoList=pbApplNoList,vm.policyData=vm.getPolicyData(),PolicyService.setSessionData({policyData:vm.policyData}),PolicyService.checkPolicy(vm.policyData,"single",function(itemOrderRealPayAmt){PolicyService.setSessionData({productData:{itemOrderRealPayAmt:itemOrderRealPayAmt||0},policyData:{itemOrderRealPayAmt:itemOrderRealPayAmt||0}});var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status){var now=new Date;if(now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{insureConfirmTime:now}}),1==$rootScope.isLogin||$rootScope.HLIFE)self.modal.remove(),PolicyService.control({state:"product-purchase-confirm",control:"process"});else{var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"是否需要将您的投保信息绑定至此微信账号？",okText:"需要",cancelText:"取消"});alertPopup.then(function(res){res?COMMON.showModal("app/module/mall/product/auto-bind/auto-bind-new.html"):(self.modal.remove(),PolicyService.control({state:"product-purchase-confirm",control:"process"}))})}}else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})})})}})},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){$scope.blur=!1,vm.emailListShow=!0},vm.emailBlur=function(val){$scope.blur=!0,vm.emailListShow=!1},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.init()}angular.module("app").controller("HmrcInfoinputController",HmrcInfoinputController),HmrcInfoinputController.$inject=["$state","$compile","VALIDATION","$document","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","PolicyService","$ionicPopup","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicModal","COMMON","$http"]}(),function(){function HmrcNoticeController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,$filter,$ionicModal,TipService,$ionicPopup,$ionicLoading){var sessionData=PolicyService.getSessionData(),vm=this;$scope.productData=sessionData.productData,$scope.insureData=sessionData.insureData,$scope.paymentType=$scope.insureData.paymentType,$scope.policyData=sessionData.policyData,vm.provinceCode=$scope.policyData.PlchdProvCd||"",$scope.PbInsuExp=$scope.insureData.PbInsuExp,$scope.tabList=["相关条款"],$scope.productData.hotTip&&$scope.productData.hotTip.length>0&&$scope.tabList.push("特别提示"),$scope.productData.exoneration&&$scope.productData.exoneration.length>0&&$scope.tabList.push("责任免除"),$scope.submitIdx=0,$scope.checkImgCodeForShow=!1,$scope.PbInsuExp=$scope.insureData.PbInsuExp,$scope.materials=[],$scope.allRead=!0,$scope.getProductMaterials=function(){PolicyService.getMaterials({prdId:$scope.productData.prd_id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){for(var i=0;i<materials.length;i++)if($scope.ma=materials[i],$scope.ma&&"M6"!=$scope.ma.materialType){var materialTypeDesc=$scope.ma.materialTypeDesc,materialType=$scope.ma.materialType,params={prdId:$scope.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc},material=[];CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status&&(material=result.data,material&&material.length>0)){for(var j=0;j<material.length;j++)material[j].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[j].materialPath,material[j].isRead=!1,$scope.materials.push(material[j]);if($scope.materials&&$scope.materials.length>0){var arr=$scope.materials.filter(function(item){return item.areaCode&&item.areaCode==vm.provinceCode});arr.length>0?$scope.materials=$scope.materials.filter(function(item){return!item.areaCode||item.areaCode==vm.provinceCode}):$scope.materials=$scope.materials.filter(function(item){return!item.areaCode||"all"==item.areaCode})}$scope.allRead=!1}})}})},$scope.getProductMaterials(),$scope.goRead=function(ma,index){vm.MaterialIndex=index,vm.showMaterialModal()},vm.showMaterialModal=function(){var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/hmrc/popup/material.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){$scope.modal=modal,$scope.modal.show(),self.nowRead=vm.MaterialIndex+1,self.allNeadRead=$scope.materials.length,self.activeMaterial=$scope.materials[vm.MaterialIndex],self.materialUrl=$scope.materials[vm.MaterialIndex].materialPath,
self.hasMaterialCanvans=!1,self.noMaterialPDF=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(console.info(65465456465),self.hasMaterialCanvans=!0,$ionicLoading.hide(),self.noMaterialPDF=!1,vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){console.info(e),self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){$scope.materials[vm.MaterialIndex].isRead=!0,$scope.allRead=$scope.materials.every(function(arr){return arr.isRead}),$scope.modal.remove(),$scope.allRead||(vm.MaterialIndex++,vm.MaterialIndex>$scope.materials.length-1&&(vm.MaterialIndex=0),vm.showMaterialModal())}})},$scope.submit=function(){if($scope.submitIdx<$scope.tabList.length-1)return void $scope.submitIdx++;var self=$rootScope;self.modal.remove(),$ionicModal.fromTemplateUrl("app/module/mall/product/hmrc/popup/health.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.close=function(){self.modal.remove()},self.nextleft=function(){TipService.showMsg("尊敬的客户，您的情况不符合本产品的投保要求，暂时无法购买，感谢您的理解与支持！")},self.nextright=function(){"Y"==$scope.productData.basicProfile.P028&&"01"!=$scope.policyData.confirmRela?($rootScope.showAgreeModal=!0,$ionicPopup.show({template:"<p>被保险人已同意本次投保，并已认可本次投保的保险金额</p>",buttons:[{text:"否",onTap:function(e){$rootScope.showAgreeModal=!1}},{text:"是",type:"button-positive",onTap:function(e){$rootScope.showAgreeModal=!1,self.complete()}}]})):self.complete()}}),self.modal.remove()}}angular.module("app").controller("HmrcNoticeController",HmrcNoticeController),HmrcNoticeController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","$filter","$ionicModal","TipService","$ionicPopup","$ionicLoading"]}(),function(){function hrmcSigController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$timeout,$filter){var vm=this,sessionData=PolicyService.getSessionData();vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.productData=sessionData.productData,"01"==vm.policyData.confirmRela?$scope.showInsured=!1:$scope.showInsured=!0,vm.certExpireDate=vm.policyData.certExpireDate||"20991231",vm.certExpireType="20991231"===vm.certExpireDate?"01":"02",vm.signStart=!1,$scope.startNmae=!1,vm.signName="",$scope.showSign=!1,$scope.insureImg="",$scope.insuredImg="",vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=44),$scope.openSign=function(name){vm.signName=name,$scope.showSign=!0,vm.showSignBox()};var screenHeight=$(window).height();vm.showSignBox=function(){$timeout(function(){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000",this.background="#ffffff";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=screenHeight-70-vm.headHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=this.linewidth,this.cxt.lineCap="round";var signMark=new Image;signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){$scope.startNmae=!0,this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),$scope.$apply()}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){$scope.startNmae=!1,vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0),$scope.$apply()}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL();signBase64&&(vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),"insure"==vm.signName?$scope.insureImg=signBase64:"insured"==vm.signName&&($scope.insuredImg=signBase64),$scope.showSign=!1,$scope.startNmae=!1,$scope.$apply())}.bind(this),!1)}document.getElementById("product-purchasesign").addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.getElementById("product-purchasesign").addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:9,color:"black",background:"#ffffff"})},10)}}angular.module("app").controller("hrmcSigController",hrmcSigController),hrmcSigController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$timeout","$filter"]}(),function(){function SmsSliderController($state,$rootScope,$location,CONFIG,CommonRequest,$scope,COMMON,PolicyService,$document,$timeout,$filter,$ionicModal){$scope.phone="",$scope.phoneCode="",$scope.txCode="CCBSB100";var rootScope=$rootScope;$scope.init=function(){$scope.showDrag=!0,$scope.doAnimate=!0,$scope.getdragimg()},$scope.getdragimg=function(){$scope.random=Date.parse(new Date)+Math.random(8);var params={randomId:$scope.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;$scope.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",$scope.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},$scope.init(),$scope.cancel=function(){COMMON.hideModal()},rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||$scope.getdragimg()}),rootScope.$on("drag-down",function(event,result){$rootScope.hmrcRemove(),$rootScope.hmrcCheck()})}angular.module("app").controller("SmsSliderController",SmsSliderController),SmsSliderController.$inject=["$state","$rootScope","$location","CONFIG","CommonRequest","$scope","COMMON","PolicyService","$document","$timeout","$filter","$ionicModal"]}(),function(){function HmreCifController($scope,$sce,$ionicLoading,$rootScope,CONFIG,CommonRequest,$ionicPopup,PolicyService,TipService,$timeout,$ionicModal,COMMON){var vm=this;vm.initFn=function(){vm.checkPolicyResultCount=0,$rootScope.articleNum=1,$rootScope.hotTip=[];var sessionData=PolicyService.getSessionData();switch(vm.productData=sessionData.productData||{},vm.insureData=sessionData.insureData||{},vm.CheckPolicydata=JSON.parse(sessionStorage.getItem("CheckPolicydata")),vm.orderCode=vm.insureData.orderCode,vm.CheckPolicydata.orderCode=vm.orderCode,vm.materials=JSON.parse(sessionStorage.getItem("materials")),$rootScope.articleStyle=1,$rootScope.exoneration=vm.productData.exoneration[0].trim().split(" "),vm.newHotTip=vm.productData.hotTip[0].trim().split("entre"),vm.newHotTip.forEach(function(element){vm.contextTip=element.trim().split(" "),$rootScope.hotTip.push(vm.contextTip)}),$rootScope.prdMaterials=[],$rootScope.tbsmMaterials=[],$rootScope.materialsFlagArr=["1","0","0","0"],vm.CheckPolicydata.rcgnList[0].plchdAndRcgnReTpCd){case"01":vm.plchdAndRcgnReTpCd="本人";break;case"03":vm.plchdAndRcgnReTpCd="配偶";break;case"06":vm.plchdAndRcgnReTpCd="父母";break;case"07":vm.plchdAndRcgnReTpCd="父母";break;case"04":vm.plchdAndRcgnReTpCd="子女";break;case"05":vm.plchdAndRcgnReTpCd="子女"}vm.materials.forEach(function(element,index){"M01"==element.materialType&&(element.isRead=!1,$rootScope.prdMaterials.push(element)),"M05"!=element.materialType&&"M07"!=element.materialType||(element.isRead=!1,$rootScope.tbsmMaterials.push(element))}),$rootScope.allRead=!1,CommonRequest.request({prdId:vm.productData.prd_id},{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[4].html_file_link,method:"GET"},function(result){vm.health=$sce.trustAsHtml(result)})},vm.initFn(),$rootScope.readNumFn=function(){return 4==$rootScope.articleNum?void vm.checkPolicyFn():(2==$rootScope.articleNum&&($rootScope.allRead=!1),$rootScope.articleNum+=1,$rootScope.materialsFlagArr[$rootScope.articleNum-1]="1",void($rootScope.articleStyle=$rootScope.articleNum))},vm.openSafe=function(){return 4==$rootScope.articleNum4?void vm.checkPolicyFn():void vm.showTerm("app/module/mall/product/hmrfa-hmre/popup/article.html")},vm.showTerm=function(url,animation){$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),$rootScope.$on("$stateChangeStart",function(){self.modal.remove()})})},$rootScope.goRead=function(ma,index){vm.showMaterialModal(ma,index)},vm.showMaterialModal=function(materials,index){var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/hmrfa-hmre/popup/material1.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){$scope.modal=modal,$scope.modal.show(),self.nowRead=index+1,self.allNeadRead=materials.length,self.activeMaterial=materials[index],self.materialUrl=materials[index].materialPath,self.hasMaterialCanvans=!1,self.noMaterialPDF=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(console.info(65465456465),self.hasMaterialCanvans=!0,$ionicLoading.hide(),self.noMaterialPDF=!1,vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){console.info(e),self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas2"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){materials[index].isRead=!0,$rootScope.allRead=materials.every(function(arr){return arr.isRead}),$scope.modal.remove(),$rootScope.allRead||(index++,index>materials.length-1&&(index=0),vm.showMaterialModal(materials,index))}})},vm.checkPolicyFn=function(){vm.objArr={BkBrchNo:vm.CheckPolicydata.orgCode||"",pbApplNoNum:1,orderCode:vm.orderCode},CommonRequest.request(vm.objArr,CONFIG.CREATE_PB_APPL_NO_SERVICE,function(result){1==result.status&&(vm.PbApplNo=result.data.pbApplNoList,vm.CheckPolicydata.pbApplNoList=vm.PbApplNo,vm.CheckPolicydata.insBlPrtNo=vm.PbApplNo[0],vm.checkPolicyDataFn())})},vm.checkPolicyDataFn=function(){CommonRequest.request({data:vm.CheckPolicydata},CONFIG.CHECK_POLICY_SERVICE,function(result){1==result.status&&(vm.flowNo=result.data.flowNo,vm.checkPolicyResultFn())})},vm.checkPolicyResultFn=function(){return $ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),$rootScope.zbPolicyData="",sessionStorage.removeItem("CheckPolicydata"),vm.obj={orderCode:vm.orderCode,expectResultNum:"1",flowNo:vm.flowNo.flowNo},vm.checkPolicyResultCount++,vm.checkPolicyResultCount>=CONFIG.CORE_DECOUPLING_TIMES?($ionicLoading.hide(),PolicyService.showResultModal(),vm.checkPolicyResultCount=0,void TipService.showMsg("系统繁忙，请稍后再试")):void CommonRequest.request(vm.obj,CONFIG.GET_POLICY_RESULT_SERVICE,function(res){if(1==res.status){var policyResults=res.data.policyResults||"";if(!policyResults||0==policyResults.length)return void $timeout(function(){vm.checkPolicyResultFn()},CONFIG.CORE_DECOUPLING_DURATION);if(res.data.orderRealPayAmt<=0)$ionicLoading.hide(),vm.checkPolicyResultCount=0,TipService.showMsg(policyResults[0].bkOthRetMsg||"核保失败！"),$ionicLoading.hide();else if(vm.orderRealPayAmt=res.data.orderRealPayAmt,PolicyService.setSessionData({policyData:{BkBrchNo:vm.CheckPolicydata.orgCode,itemOrderRealPayAmt:vm.orderRealPayAmt,orderCode:vm.orderCode,PbHoldId:vm.CheckPolicydata.plchdCrdtNo,PbHoldName:vm.CheckPolicydata.plchdNm,PbHoldIdType:"A",PbHoldSex:vm.CheckPolicydata.plchdGndCd,PbHoldMobl:vm.CheckPolicydata.plchdMoveTelNo,PbHoldBirdy:vm.CheckPolicydata.PbHoldBirdy,PbApplNo:vm.PbApplNo[0]}}),1==$rootScope.isLogin||$rootScope.HLIFE)PolicyService.control({state:"product-purchase-confirm",control:"process"});else{$ionicLoading.hide();var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"是否需要将您的投保信息绑定至此微信账号？",okText:"需要",cancelText:"取消"});alertPopup.then(function(res){res?COMMON.showModal("app/module/mall/product/auto-bind/auto-bind-new.html"):(self.modal.remove(),PolicyService.control({state:"product-purchase-confirm",control:"process"}))})}}},!0)}}angular.module("app").controller("HmreCifController",HmreCifController),HmreCifController.$inject=["$scope","$sce","$ionicLoading","$rootScope","CONFIG","CommonRequest","$ionicPopup","PolicyService","TipService","$timeout","$ionicModal","COMMON"]}(),function(){function HmreController($state,$sce,VALIDATION,$document,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,$ionicPopup,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicModal,COMMON,$http){var vm=this;vm.newRule=!1;var sessionData=PolicyService.getSessionData();vm.userData=sessionData.userData||{};var self=$rootScope;self.zbPolicyData={},vm.relation="01",vm.longActive="1",vm.hmreFlag="1",vm.insureSex="1",vm.insureBirth="",vm.social="Y",vm.coverage="1",vm.excess="1",vm.disabtes="1",vm.geriatric="1",self.premiumResult=0,self.disabtesAge=0,self.zbPolicyData={coverage:vm.coverage,excess:vm.excess,disabtes:vm.disabtes,geriatric:vm.geriatric,hmreFlag:vm.hmreFlag},vm.pay_methed="0",vm.bank="",vm.isshowSale=!1,$scope.materials=[],vm.CheckPolicy={},vm.rcgnList=[],vm.busiList=[],vm.mainPlan=[],vm.trialPremiumFlag=!1,vm.mindate=new Date((new Date).getTime()+864e5),vm.referrNameFlag=0,vm.xtNewDate=new Date,vm.xtNewDate_Y=vm.xtNewDate.getFullYear(),vm.xtNewDate_M=vm.xtNewDate.getMonth()+1,vm.xtNewDate_D=vm.xtNewDate.getDate(),vm.PbBeginDate=vm.xtNewDate_Y+"-"+vm.xtNewDate_M+"-"+vm.xtNewDate_D,vm.id=$state.params.id,$rootScope.prdId=vm.id,vm.idCard=function(cardNo,index){if(1===index){var birth=cardNo.substring(6,10)+"-"+cardNo.substring(10,12)+"-"+cardNo.substring(12,14);return birth}if(2===index)return parseInt(cardNo.substr(16,1))%2===1?"1":"2";if(3===index){var myDate=new Date,month=myDate.getMonth()+1,day=myDate.getDate(),age=myDate.getFullYear()-cardNo.substring(6,10)-1,birthDay=cardNo.substring(12,14),birthMonth=cardNo.substring(10,12);return(month>birthMonth||birthMonth==month&&day+1>birthDay)&&age++,age}},vm.getAge=function(birth){birth=birth.split("-");var myDate=new Date,month=myDate.getMonth()+1,day=myDate.getDate(),age=myDate.getFullYear()-birth[0]-1,birthDay=birth[2],birthMonth=birth[1];return(month>birthMonth||birthMonth==month&&day>birthDay)&&age++,age},vm.openSafe=function(safeFlag){self.safeFlag=safeFlag,vm.showModal_hmrfa("app/module/mall/product/hmrfa-hmre/popup/safe.html")},vm.trialPremium=function(){vm.trialPremiumFlag=!0,vm.showModal_hmrfa("app/module/mall/product/hmrfa-hmre/popup/count.html")},vm.checkReferrer=function(){vm.referrerCode&&vm.isshowSale&&CommonRequest.request({agentNo:vm.referrerCode},CONFIG.SELECT_AgentInfo,function(res){if(1==res.status){if(vm.staffOrgCode!=res.data.managecom)return TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！"),vm.referrerName="",void(vm.referrerCode="");if("C99"==res.data.agentgrade||!res.data.agentgrade)return vm.referrerName="",vm.referrerCode="",void TipService.showMsg("推荐人填写有误，请确认");vm.referrerName=res.data.name,vm.referrerOrg=res.data.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0}else vm.referrerName="",vm.referrerCode="",vm.referrerOrg="",vm.showCodeList=!1,vm.referrerCodeChecked=!0})},vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data){var res=result.data.filter(function(v){return v.prdId==vm.productData.prd_id});vm.referrNameFlag=0!=res.length?1:0,console.info(vm.referrNameFlag+"是否显示：推荐人[是][否]")}})},vm.checkReferrerName=function(){vm.referrerName&&vm.isshowSale&&CommonRequest.request({agentName:vm.referrerName},CONFIG.SELECT_AgentInfoByname,function(res){1==res.status?res.data&&res.data.length?(vm.showCodeList=!0,vm.referrerCodeList=res.data):(vm.showCodeList=!1,vm.referrerCodeList=[]):(vm.referrerName="",vm.referrerCode="",vm.showCodeList=!1,vm.referrerCodeList=[])})},vm.selectCode=function(val){val&&(vm.referrerCode=val.agentNumber,vm.referrerName=val.name,vm.referrerOrg=val.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0)},vm.isshowSaleCheck=function(){vm.isshowSale=!vm.isshowSale,vm.referrerCode="",vm.referrerName="",vm.showCodeList=!1,vm.referrerCodeChecked=!1},vm.nextDs=function(){$ionicPopup.alert({cssClass:"popup-icon",template:"请正确完善页面信息",okText:"我知道了"})},vm.next=function(){if(!vm.insureName)return vm.alertPopup4=$ionicPopup.alert({title:"温馨提示",template:"请输入被保人姓名",okText:"我知道了"}),void vm.alertPopup4.then(function(res){res&&vm.goToTab(1)});if(!vm.insureCertNo||18!=vm.insureCertNo.length)return vm.alertPopup5=$ionicPopup.alert({title:"温馨提示",template:"请正确输入被保人证件号",okText:"我知道了"}),void vm.alertPopup5.then(function(res){res&&vm.goToTab(1)});if(!vm.insureCertExpireDate)return vm.alertPopup6=$ionicPopup.alert({title:"温馨提示",template:"请输入被保人证件有效日期",okText:"我知道了"}),void vm.alertPopup6.then(function(res){res&&vm.goToTab(1)});if(!vm.LiRcgnOccupCode)return vm.alertPopup7=$ionicPopup.alert({title:"温馨提示",template:"请选择被保人职业",okText:"我知道了"}),void vm.alertPopup7.then(function(res){res&&vm.goToTab(5)});if("01"!=vm.relation){if(!vm.name)return vm.alertPopup8=$ionicPopup.alert({title:"温馨提示",template:"请输入投保人姓名",okText:"我知道了"}),void vm.alertPopup8.then(function(res){res&&vm.goToTab(7)});if(!vm.certNo||18!=vm.certNo.length)return vm.alertPopup9=$ionicPopup.alert({title:"温馨提示",template:"请正确输入投保人证件号",okText:"我知道了"}),void vm.alertPopup9.then(function(res){res&&vm.goToTab(7)});if(!vm.certExpireDate)return vm.alertPopup10=$ionicPopup.alert({title:"温馨提示",template:"请输入投保人证件有效日期",okText:"我知道了"}),void vm.alertPopup10.then(function(res){res&&vm.goToTab(7)});if(!vm.PbHoldOccupCode)return vm.alertPopup11=$ionicPopup.alert({title:"温馨提示",template:"请选择投保人职业",okText:"我知道了"}),void vm.alertPopup11.then(function(res){res&&vm.goToTab(8)})}if(!vm.phone||"11"!=vm.phone.length)return vm.alertPopup12=$ionicPopup.alert({title:"温馨提示",template:"请输入正确投保人手机号",okText:"我知道了"}),void vm.alertPopup12.then(function(res){res&&vm.goToTab("01"==vm.relation?7:9)});if(!vm.email)return vm.alertPopup13=$ionicPopup.alert({title:"温馨提示",template:"请输入投保人邮箱地址",okText:"我知道了"}),void vm.alertPopup13.then(function(res){res&&vm.goToTab(12)});if(!vm.area)return vm.alertPopup14=$ionicPopup.alert({title:"温馨提示",template:"请选择投保人省市区地址",okText:"我知道了"}),void vm.alertPopup14.then(function(res){res&&vm.goToTab(12)});if(!vm.address)return vm.alertPopup17=$ionicPopup.alert({title:"温馨提示",template:"请输入投保人详细地址",okText:"我知道了"}),void vm.alertPopup17.then(function(res){res&&vm.goToTab(13)});if("HMRFa"==vm.productData.prd_code){if("1"==vm.pay_methed&&!vm.bank.bankCode)return vm.alertPopup15=$ionicPopup.alert({title:"温馨提示",template:"请选择开户银行",okText:"我知道了"}),void vm.alertPopup15.then(function(res){res&&vm.goToTab(17)});if("1"==vm.pay_methed&&!vm.BkAcctNo3)return vm.alertPopup16=$ionicPopup.alert({title:"温馨提示",template:"请输入银行卡号",okText:"我知道了"}),void vm.alertPopup16.then(function(res){res&&vm.goToTab(17)})}if(vm.isshowSale&&(!vm.referrerCode||!vm.referrerName))return vm.alertPopup18=$ionicPopup.alert({title:"温馨提示",template:"请填写推荐人信息，如无推荐人请收起推荐人信息栏",okText:"我知道了"}),void vm.alertPopup18.then(function(res){res&&vm.goToTab(18)});if(!vm.trialPremiumFlag)return vm.alertPopup19=$ionicPopup.alert({title:"温馨提示",template:"请选择保障方案",okText:"我知道了"}),void vm.alertPopup19.then(function(res){res&&vm.goToTab(17)});if("01"==vm.relation&&(vm.certNo=vm.insureCertNo,vm.name=vm.insureName),vm.certBirth=vm.idCard(vm.certNo,1),vm.certSex=vm.idCard(vm.certNo,2),vm.certAge=vm.idCard(vm.certNo,3),vm.insureBirth=vm.idCard(vm.insureCertNo,1),vm.insureSex=vm.idCard(vm.insureCertNo,2),vm.insureAge=vm.idCard(vm.insureCertNo,3),vm.certAge<vm.productData.minHolderAge)return void $ionicPopup.alert({title:"温馨提示",template:"十分抱歉，未成年人不能给本人及家人投保",okText:"我知道了"});if("03"==vm.relation&&vm.insureSex==vm.certSex)return void $ionicPopup.alert({title:"温馨提示",template:"投被保人关系为配偶时，投保人和被保险人的性别不能相同,请重新选择",okText:"我知道了"});if("09"==vm.relation&&vm.insureAge>18)return void $ionicPopup.alert({title:"温馨提示",template:"网上投保成年人仅接受本人投保，未成年人可由父母投保",okText:"我知道了"});if(vm.certAge>vm.productData.maxHolderAge)return void $ionicPopup.alert({title:"温馨提示",template:"十分抱歉，投保人该年龄不在投保范围之内",okText:"我知道了"});if((vm.insureAge<vm.productData.min_app_age||vm.insureAge>vm.productData.max_app_age)&&"HMRFa"==vm.productData.prd_code||vm.insureAge>60&&"HMRE"==vm.productData.prd_code)return void $ionicPopup.alert({title:"温馨提示",template:"十分抱歉，被保人该年龄不在承保范围之内,请重新输入",okText:"我知道了"});var res1=vm.mainPlan.filter(function(v){return"HMRFb"==v.planCode});return vm.HMRFbFlag=0!=res1.length?1:0,"HMRFa"==vm.productData.prd_code&&vm.insureAge>60&&1==vm.HMRFbFlag?(vm.disabtes="1",vm.alertPopup2=$ionicPopup.alert({title:"温馨提示",template:"十分抱歉，被保人该年龄不在可选责任2型糖尿病的承保范围之内，请重新选择保障方案",okText:"我知道了"}),void vm.alertPopup2.then(function(res){res&&$timeout(function(){vm.goToTab(17)},50)})):void vm.goNextFn()},vm.goNextFn=function(){vm.CheckPolicy={plchdProvCd:vm.province.areaCode.substring(0,2)+"0000",plchdCityCd:vm.city.areaCode.substring(0,4)+"00",bnkProvCd:"",orgCode:vm.staffOrgCode,rsdntTpCd:"0",plchdYrIncmAm:"50000",bOSaleStffID:vm.staffId,bnkBOCd:"",bnkBONm:"",lv1BrNo:vm.provinceNet.netCode,lv2BrNo:"",lv3BrNo:"",referrerCode:vm.referrerCode||"",referrerName:vm.referrerName||"",benfNum:"0",pbMainInsuExp:0,pbInsuExpAppd:0,rnewPyFPyMdCd:"",rsrvFld11:"",insPolcyPswd:"",invNo:"",bkRckrNo:"",minrAcmCvr:0,benfAndRcgnReTpCd:"1",insPolcyEfDt:vm.PbBeginDate,dsptPcsgMtdCd:1,dsptArbtrInstNm:"",specAuditFlag:"01",prelnsureFlag:"",area:vm.area,address:vm.address,PbHoldOccupText:"01"==vm.relation?vm.LiRcgnOccupText:vm.PbHoldOccupText,LiRcgnOccupText:vm.LiRcgnOccupText,allInsuExp:self.premiumResult,plchdAccNm:"1"==vm.pay_methed?vm.name:"",plchdPyFAccNo:"1"==vm.pay_methed?vm.BkAcctNo3:"",newPyFPyMdCd:"",isBatts:"0",plchdAccID:"1"==vm.pay_methed?vm.bank.bankCode:"",newPyFAccNm:"",newGetBkName:"",newPyFAccBnkCd:"",newPyFAccID:"",ntfItmInd:"0",plchdNm:"01"==vm.relation?vm.insureName:vm.name,plchdGndCd:"01"==vm.relation?vm.insureSex:vm.certSex,plchdBrthDt:"01"==vm.relation?vm.insureBirth.replace(/-/g,""):vm.certBirth.replace(/-/g,""),sellTypeDetail:CONFIG.SALE_CHANNEL,plchdCommAdr:vm.address,plchdCrdtTpCd:"A",plchdCrdtNo:"01"==vm.relation?vm.insureCertNo:vm.certNo,plchdCrdtEfDt:"",plchdCrdtExpDt:"01"==vm.relation?"长期有效"==vm.insureCertExpireDate?"20991231":vm.insureCertExpireDate.replace(/-/g,""):"长期有效"==vm.certExpireDate?"20991231":vm.certExpireDate.replace(/-/g,""),plchdNatCd:"CHN",plchdCntyAndDstcCd:vm.district.areaCode,plchdZipECD:"000000",plchdFixTelNo:vm.phone,plchdMoveTelNo:vm.phone,plchdEmailAdr:vm.email,insPremBdgtAmt:vm.mainPlan[0].mainpremiumResult,plchdOcpCd:"01"==vm.relation?vm.LiRcgnOccupCode:vm.PbHoldOccupCode,PbHoldBirdy:"01"==vm.relation?vm.insureBirth.replace(/-/g,""):vm.certBirth.replace(/-/g,"")},vm.rcgnListObj={plchdAndRcgnReTpCd:"08"==vm.relation?"1"==vm.certSex?"06":"07":"09"==vm.relation?"1"==vm.certSex?"04":"05":vm.relation,rcgnNm:vm.insureName,rcgnGndCd:vm.insureSex,rcgnBrthDt:vm.insureBirth.replace(/-/g,""),rcgnCrdtTpCd:"A",rcgnCrdtNo:vm.insureCertNo,rcgnCrdtEfDt:"",rcgnCrdtExpDt:"长期有效"==vm.insureCertExpireDate?"20991231":vm.insureCertExpireDate.replace(/-/g,""),rcgnNatCd:"CHN",rcgnFixTelNo:"",rcgnMoveTelNo:vm.phone,rcgnEmail:vm.email,rcgnOcpCd:vm.LiRcgnOccupCode,rcgnCommAdr:vm.address,rcgnZipECD:"000000"},vm.rcgnList.push(vm.rcgnListObj),vm.CheckPolicy.rcgnList=vm.rcgnList,vm.CheckPolicy.busiList=vm.busiList,sessionStorage.setItem("CheckPolicydata",JSON.stringify(vm.CheckPolicy)),$state.go("product-hmrfa-hmre-health")};var getMaxbirth=function(val){var flag_age=VALIDATION.getDateByAge(val),nowy=flag_age.getFullYear(),nowm=flag_age.getMonth()+1<10?"0"+(flag_age.getMonth()+1):flag_age.getMonth()+1,nowd=flag_age.getDate()<10?"0"+flag_age.getDate():flag_age.getDate();return nowy+"-"+nowm+"-"+nowd},getMinbirth=function(val){var flag_age=VALIDATION.getDateByAge(val),nowy=new Date(flag_age).getFullYear(),nowm=new Date(flag_age).getMonth()+1<10?"0"+((new Date).getMonth()+1):(new Date).getMonth()+1,nowd=new Date(flag_age).getDate()+1<10?"0"+((new Date).getDate()+1):(new Date).getDate()+1;return nowy+"-"+nowm+"-"+nowd};vm.showModal_hmrfa=function(url,animation){self.maxbirth=getMaxbirth(vm.productData.min_app_age),self.minbirth=getMinbirth(vm.productData.max_app_age),$ionicModal.fromTemplateUrl(url,{scope:$rootScope,animation:animation||"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),vm.insureCertNo&&18==vm.insureCertNo.length&&(vm.insureBirth=vm.idCard(vm.insureCertNo,1),vm.insureSex=vm.idCard(vm.insureCertNo,2),vm.insureAge=vm.idCard(vm.insureCertNo,3),self.disabtesAge=vm.insureAge),self.zbPolicyData.birthday=vm.insureBirth,self.zbPolicyData.pay_methed="HMRFa"==vm.productData.prd_code?vm.pay_methed:"0",self.zbPolicyData.premium=vm.premium,self.zbPolicyData.prd_code=vm.productData.prd_code,$rootScope.$on("$stateChangeStart",function(){self.modal.remove()}),self.next=function(){var mainPlanNew=[];self.zbPolicyData&&"1"==self.zbPolicyData.hmreFlag&&"HMRE"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00001/.test(element.planCode)&&(element.planCodeFlag="计划一",mainPlanNew[0]=element)}),self.zbPolicyData&&"2"==self.zbPolicyData.hmreFlag&&"HMRE"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00002/.test(element.planCode)&&(element.planCodeFlag="计划二",mainPlanNew[0]=element)}),self.zbPolicyData&&"1"==self.zbPolicyData.coverage&&"1"==self.zbPolicyData.excess&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00001/.test(element.planCode)&&(element.planCodeFlag="计划一",mainPlanNew[0]=element)}),self.zbPolicyData&&"1"==self.zbPolicyData.coverage&&"2"==self.zbPolicyData.excess&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00002/.test(element.planCode)&&(element.planCodeFlag="计划二",mainPlanNew[0]=element)}),self.zbPolicyData&&"2"==self.zbPolicyData.coverage&&"1"==self.zbPolicyData.excess&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00003/.test(element.planCode)&&(element.planCodeFlag="计划三",mainPlanNew[0]=element)}),self.zbPolicyData&&"2"==self.zbPolicyData.coverage&&"2"==self.zbPolicyData.excess&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/00004/.test(element.planCode)&&(element.planCodeFlag="计划四",mainPlanNew[0]=element)}),self.zbPolicyData&&"2"==self.zbPolicyData.disabtes&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/HMRFb/.test(element.planCode)&&(element.insuredAmount="50000",mainPlanNew.push(element))}),self.zbPolicyData&&"3"==self.zbPolicyData.disabtes&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/HMRFb/.test(element.planCode)&&(element.insuredAmount="100000",mainPlanNew.push(element))}),self.zbPolicyData&&"2"==self.zbPolicyData.geriatric&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/HMRFc/.test(element.planCode)&&(element.insuredAmount="50000",mainPlanNew.push(element))}),self.zbPolicyData&&"3"==self.zbPolicyData.geriatric&&"HMRFa"==vm.productData.prd_code&&vm.productData.plans.forEach(function(element){/HMRFc/.test(element.planCode)&&(element.insuredAmount="100000",mainPlanNew.push(element))}),vm.coverage=self.zbPolicyData.coverage,vm.excess=self.zbPolicyData.excess,vm.disabtes=self.zbPolicyData.disabtes,vm.geriatric=self.zbPolicyData.geriatric,vm.hmreFlag=self.zbPolicyData.hmreFlag,vm.mainPlan=mainPlanNew},self.close=function(){self.modal.remove()},self.closeNext=function(){self.next(),self.close()}})},$scope.$on("selectAreaName",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}});var params={areaCode:vm.district.areaCode},config={url:"../statics/product/proxys/"+vm.district.areaCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}}),$scope.$on("select-branch-group-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),$scope.getDistrictLevel1=function(){var params={prdId:vm.id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_FIRST_SERVCIE,function(result){1==result.status&&$scope.getDistrictLevel2(result.data[0])})},$scope.getDistrictLevel2=function(obj){var params={parentAreaCode:obj.areaCode,areaLevel:2,prdId:vm.id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_SECOND_SERVCIE,function(result){1==result.status&&$scope.getDistrictLevel3(result.data[0])})},$scope.getDistrictLevel3=function(obj2){var params={parentAreaCode:obj2.areaCode,areaLevel:3,prdId:vm.id};CommonRequest.request(params,CONFIG.GET_DISTRICT_LEVEL_SECOND_SERVCIE,function(result){if(1==result.status){var config={url:"../statics/product/proxys/"+result.data[0].areaCode+".json",method:"GET"};CommonRequest.request({},config,function(result){var data=result;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,
vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}})},vm.getBankList=function(callback){COMMON.getCommonBank(vm.staffOrgCode.substring(0,4),"1",function(bankList){vm.bankList=bankList,vm.newGetBk=vm.bankList[0],angular.isFunction(callback)&&callback()})},$scope.$watch("hmrfahmrecalculate.staffOrgCode",function(newValue){vm.staffOrgCode&&vm.getBankList(function(){vm.bank&&(vm.bank=vm.bankList.find(function(item){return vm.bank.bankName==item.bankName}))})}),vm.getProductDetail=function(id,ars){var params={prdId:id};CommonRequest.request(params,{url:$filter("prodJsonFilter")(id,CommonRequest.request,ars),method:"GET"},function(result){if(1==result.status){if(vm.productData=result.data,$rootScope.productHFlag=vm.productData.prd_code,vm.productData.plans.forEach(function(element){/00001/.test(element.planCode)&&(element.planCodeFlag="计划一",vm.mainPlan.push(element),console.info(vm.mainPlan))}),PolicyService.control({state:$state.current.name,control:"data",data:{productData:vm.productData}}),vm.cretType="A",1==$rootScope.isLogin&&vm.userData&&"A"==vm.userData.cretType&&(vm.name=vm.userData.customerName,vm.certNo=vm.userData.cretNo,vm.phone=vm.userData.phoneNo,vm.cretType=vm.userData.cretType,vm.certBirth=vm.idCard(vm.certNo,1),vm.certSex=vm.idCard(vm.certNo,2),vm.certAge=vm.idCard(vm.certNo,3)),1==$rootScope.isLogin&&vm.userData&&"A"==vm.userData.cretType&&"01"==vm.relation&&((vm.certAge<vm.productData.min_app_age||vm.certAge>vm.productData.max_app_age)&&"HMRFa"==vm.productData.prd_code||vm.certAge>60&&"HMRE"==vm.productData.prd_code?(vm.insureName="",vm.insureCertNo="",vm.insureBirth="",vm.insureSex="1",vm.insureAge="",vm.relation="03",vm.relationFlag=!0):(vm.insureName=vm.userData.customerName,vm.insureCertNo=vm.userData.cretNo,vm.insureBirth=vm.idCard(vm.insureCertNo,1),vm.insureSex=vm.idCard(vm.insureCertNo,2),vm.insureAge=vm.idCard(vm.insureCertNo,3),vm.getPremium())),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[0].html_file_link,method:"GET"},function(result){vm.herc_qus0=$sce.trustAsHtml(result)}),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[1].html_file_link,method:"GET"},function(result){self.herc_qus1=$sce.trustAsHtml(result)}),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[2].html_file_link,method:"GET"},function(result){self.herc_qus2=$sce.trustAsHtml(result)}),CommonRequest.request(params,{url:CONFIG.IMAGE_SERVICE_ADDRESS+vm.productData.tabs[3].html_file_link,method:"GET"},function(result){self.herc_qus3=$sce.trustAsHtml(result)}),1==$rootScope.isLogin&&vm.userData&&"A"!==vm.userData.cretType)return vm.alertPopup1=$ionicPopup.alert({title:"温馨提示",template:"本产品在线上仅支持身份证类型的客户投保，其他证件类型的客户请到建信人寿营业部门投保，谢谢！",okText:"我知道了"}),void vm.alertPopup1.then(function(res){res&&$state.go("product-list",{tag:5})});if(1==$rootScope.isLogin&&vm.certAge>vm.productData.maxHolderAge)return vm.alertPopup1=$ionicPopup.alert({title:"温馨提示",template:"十分抱歉，投保人该年龄不在投保范围之内",okText:"我知道了"}),void vm.alertPopup1.then(function(res){res&&$state.go("product-list",{tag:5})});if(1==$rootScope.isLogin&&vm.certAge<vm.productData.minHolderAge)return vm.alertPopup1=$ionicPopup.alert({title:"温馨提示",template:"十分抱歉，未成年人不能给本人及家人投保",okText:"我知道了"}),void vm.alertPopup1.then(function(res){res&&$state.go("product-list",{tag:5})});$rootScope.showProductDialog=!0,vm.getSaleChannelPort()}})},$scope.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){for(var i=0;i<materials.length;i++){$scope.ma=materials[i];var materialTypeDesc=$scope.ma.materialTypeDesc,materialType=$scope.ma.materialType,params={prdId:vm.id,materialType:materialType,materialTypeDesc:materialTypeDesc},material=[];CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status&&(material=result.data,material&&material.length>0)){for(var j=0;j<material.length;j++)material[j].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[j].materialPath,$scope.materials.push(material[j]);sessionStorage.setItem("materials",JSON.stringify($scope.materials))}})}})},$scope.goRead=function(ma,index){vm.MaterialIndex=index,vm.showMaterialModal()},vm.loadingPage=function(ars){var times=0;return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id,ars),void $timeout(function(){return void 0==ars.traceData?(TipService.showMsg("非常抱歉，该产品当前不支持销售"),void $timeout(function(){$state.go("product-list",{tag:5})},1e3)):void(vm.productData||vm.loadingPage())},2e3))},vm.getPremium=function(){return vm.trialPremiumFlag&&self.next(),self.premiumResult=0,vm.insureCertNo&&18==vm.insureCertNo.length?(vm.insureBirth=vm.idCard(vm.insureCertNo,1),vm.insureSex=vm.idCard(vm.insureCertNo,2),vm.insureAge=vm.idCard(vm.insureCertNo,3),vm.busiList=[],void vm.mainPlan.forEach(function(element,index){vm.objArr={prdCode:"HMRE"==vm.productData.prd_code?"HMRE":/HMRF0000/.test(element.planCode)?"HMRFa":element.planCode,prdName:element.planName,insurerBirthDay:vm.insureBirth.replace(/-/g,""),sex:vm.insureSex,PbInsuAmt:element.insuredAmount,insuredDays:"1",insuYearFlag:"Y",planCode:"HMRFc"==element.planCode||"HMRFb"==element.planCode?"":element.planCode,paymentType:"HMRE"==vm.productData.prd_code?"0":vm.pay_methed,socialSecurity:vm.social,channel:CONFIG.SALE_CHANNEL,payendyear:"1",sszbflag:"NB",isAdditionRisk:"HMRFc"==element.planCode||"HMRFb"==element.planCode?"Y":"",PbBeginDate:vm.PbBeginDate},CommonRequest.request(vm.objArr,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){element.mainpremiumResult=result.data.premiumResult.split(":")[0],self.premiumResult+=parseFloat(element.mainpremiumResult),self.premiumResult=Math.round(100*self.premiumResult)/100;var busiListObj={LiBackTag:"",liSpec:"",expPrmmRcvModCgyCd:"",svBnfDrwCycCd:"1",anutyPcsgMtdCd:"1",apntInsPremPyAdvnInd:"0",xtraDvdnPcsgMtdCd:"2",cvrID:/HMRFb/.test(element.planCode)||/HMRFc/.test(element.planCode)?element.planCode:vm.productData.prd_code,cvrNm:element.planName,mainAndAdlInsInd:/0000/.test(element.planCode)?"1":"0",insCps:1,insPremAmt:element.mainpremiumResult,insCvr:element.insuredAmount,rdAmtPyClsInd:"",insPremPyFMtdCd:"HMRE"==vm.productData.prd_code?"0":vm.pay_methed,insPremPyFPrdNum:"1",insYrPrdCgyCd:"2",insDdln:"1",rsrvFld15:0,insPremPyFCycCd:0,anutyDrwPrdNum:0,ivsMtdCd:"",cvrNum:vm.mainPlan.length-1,tlBkNum:0,rsrvFld1:"1",rsrvFld2:"0",rsrvFld3:"",rsrvFld4:"",rsrvFld5:vm.productData.prd_title,insPolcyExpDt:"",insScmInf:/HMRFb/.test(element.planCode)||/HMRFc/.test(element.planCode)?"":element.planCode,disActId:vm.staffOrgCode?vm.staffOrgCode.substr(0,4):"",saleChnl:CONFIG.SALE_CHANNEL,prdId:vm.productData.prd_id,planId:element.planId,socialSecurity:vm.social};vm.busiList.push(busiListObj),vm.mainPlan.length-1==index&&$timeout(function(){$ionicLoading.hide()},1e3)}},!0)})):void $ionicLoading.hide()},vm.loadingPage($rootScope),$scope.getProductMaterials(),$scope.getDistrictLevel1(),vm.relationCheck=function(relation){return vm.relation=relation,vm.insureCertExpireDate="",vm.insureName="",vm.insureCertNo="",vm.insureBirth="",vm.insureSex="",vm.insureAge="",vm.LiRcgnOccupCode="",vm.LiRcgnOccupText="",vm.social="Y",vm.getPremium(),"01"==vm.relation&&vm.userData&&1==$rootScope.isLogin?1==$rootScope.isLogin&&vm.userData&&"A"!==vm.userData.cretType?void $ionicPopup.alert({cssClass:"popup-icon",template:"本产品在线上仅支持身份证类型的客户投保，其他证件类型的客户请到建信人寿营业部门投保，谢谢！",okText:"我知道了"}):(vm.certAge<vm.productData.min_app_age||vm.certAge>vm.productData.max_app_age)&&"HMRFa"==vm.productData.prd_code||vm.certAge>60&&"HMRE"==vm.productData.prd_code?($ionicPopup.alert({title:"温馨提示",template:"由于投保人年龄，超出该产品的承保年龄范围，不能为本人投保。",okText:"我知道了"}),"03"==vm.relation,vm.insureName="",void(vm.insureCertNo="")):(vm.insureName=vm.userData.customerName,vm.insureCertNo=vm.userData.cretNo,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),void vm.getPremium()):"01"==vm.relation&&1!=$rootScope.isLogin&&(vm.insureName="",vm.insureCertNo="",(vm.certNo&&18==vm.certNo.length||vm.insureCertNo&&18==vm.insureCertNo.length)&&(vm.insureAge=vm.idCard(vm.insureCertNo,3),vm.certAge=vm.idCard(vm.certNo,3),(vm.certAge<vm.productData.min_app_age||vm.certAge>vm.productData.max_app_age)&&"HMRFa"==vm.productData.prd_code||vm.certAge>60&&"HMRE"==vm.productData.prd_code))?($ionicPopup.alert({title:"温馨提示",template:"由于投保人年龄，超出该产品的承保年龄范围，不能为本人投保。",okText:"我知道了"}),"03"==vm.relation,vm.insureName="",void(vm.insureCertNo="")):void 0},$scope.$watch("hmrfahmrecalculate.referrerCode",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$watch("hmrfahmrecalculate.referrerName",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),vm.changeFn=function(){return 18!=vm.insureCertNo.length?(self.premiumResult=0,self.disabtesAge=0,vm.insureBirth="",vm.insureSex="",void(vm.insureAge="")):18==vm.insureCertNo.length?($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.insureBirth=vm.idCard(vm.insureCertNo,1),vm.insureSex=vm.idCard(vm.insureCertNo,2),vm.insureAge=vm.idCard(vm.insureCertNo,3),void vm.getPremium()):void 0},vm.socialFn=function(val){vm.social=val,18==vm.insureCertNo.length&&($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremium())},vm.pay_methedFn=function(val){vm.pay_methed=val,18==vm.insureCertNo.length&&($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremium())},$scope.$watch("zbPolicyData.geriatric",function(newValue,oldValue){console.info("oldValue==",oldValue),console.info("newValue==",newValue),18==vm.insureCertNo.length&&$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),newValue!=oldValue&&vm.productData&&"HMRFa"==vm.productData.prd_code&&vm.trialPremiumFlag&&(console.info("oldValue==",oldValue),console.info("newValue==",newValue),$timeout(function(){return self.premiumResult=0,self.zbPolicyData&&self.zbPolicyData.birthday?(self.disabtesAge=vm.getAge(self.zbPolicyData.birthday),self.disabtesAge>60?(self.zbPolicyData.disabtes="1",vm.disabtes="1",void vm.getPremium()):void vm.getPremium()):void 0},50))}),$scope.$watch("zbPolicyData.coverage",function(newValue,oldValue){return console.info("oldValue==",oldValue),console.info("newValue==",newValue),18==vm.insureCertNo.length&&$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),newValue!=oldValue&&vm.productData&&"HMRFa"==vm.productData.prd_code&&vm.trialPremiumFlag&&self.zbPolicyData&&self.zbPolicyData.birthday?(self.disabtesAge=vm.getAge(self.zbPolicyData.birthday),self.disabtesAge>60?(self.zbPolicyData.disabtes="1",vm.disabtes="1",void vm.getPremium()):void vm.getPremium()):void 0}),$scope.$watch("zbPolicyData.disabtes",function(newValue,oldValue){console.info("oldValue==",oldValue),console.info("newValue==",newValue),18==vm.insureCertNo.length&&$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),newValue!=oldValue&&vm.productData&&"HMRFa"==vm.productData.prd_code&&vm.trialPremiumFlag&&$timeout(function(){return self.zbPolicyData&&self.zbPolicyData.birthday?(self.disabtesAge=vm.getAge(self.zbPolicyData.birthday),self.disabtesAge>60?(self.zbPolicyData.disabtes="1",vm.disabtes="1",void vm.getPremium()):void vm.getPremium()):void 0},50)}),$scope.$watch("zbPolicyData.excess",function(newValue,oldValue){console.info("oldValue==",oldValue),console.info("newValue==",newValue),18==vm.insureCertNo.length&&$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),newValue!=oldValue&&vm.productData&&"HMRFa"==vm.productData.prd_code&&vm.trialPremiumFlag&&$timeout(function(){return self.zbPolicyData&&self.zbPolicyData.birthday?(self.disabtesAge=vm.getAge(self.zbPolicyData.birthday),self.disabtesAge>60?(self.zbPolicyData.disabtes="1",vm.disabtes="1",void vm.getPremium()):void vm.getPremium()):void 0},50)}),$scope.$watch("zbPolicyData.hmreFlag",function(newValue,oldValue){console.info("oldValue==",oldValue),console.info("newValue==",newValue),18==vm.insureCertNo.length&&$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),newValue!=oldValue&&vm.productData&&"HMRE"==vm.productData.prd_code&&vm.trialPremiumFlag&&$timeout(function(){return self.zbPolicyData&&self.zbPolicyData.birthday?void vm.getPremium():void 0},50)}),vm.showMaterialModal=function(){$ionicModal.fromTemplateUrl("app/module/mall/product/hmrfa-hmre/popup/material.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!1}).then(function(modal){$scope.modal=modal,$scope.modal.show(),self.nowRead=vm.MaterialIndex+1,self.activeMaterial=$scope.materials[vm.MaterialIndex],self.materialUrl=$scope.materials[vm.MaterialIndex].materialPath,self.hasMaterialCanvans=!1,self.noMaterialPDF=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(self.hasMaterialCanvans=!0,$ionicLoading.hide(),self.noMaterialPDF=!1,vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans1=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans1.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas1"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){$scope.modal.remove()}})};var alertMsg,TIPS=$rootScope.TIPS;vm.errorAlert=function(key,val){"a_name"!=key&&"b_name"!=key||(1==val.invalid?alertMsg=TIPS.COMMON.USER_NAME_INVALID:"length"==val&&(alertMsg=TIPS.COMMON.USER_NAME_LENGTH_ERROR)),"phone"==key&&1==val.invalid&&(alertMsg=TIPS.COMMON.PHONE_INVALID),"insureCertNo"!=key&&"a_id"!=key||(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID:1==val.length&&(alertMsg="您输入的证件号长度不符")),"email"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符")),"account"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.ZIPCODE_INVALID:1==val.length&&(alertMsg=TIPS.COMMON.BANKNO_LENGTH_ERROR)),"address"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.ADDRESS_INVALID:1==val.length?alertMsg=TIPS.COMMON.ADDRESS_LENGTH_ERROR:1==val.number&&(alertMsg=TIPS.COMMON.ADDRESS_NUMBER_ERROR)),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")};var searchResultList="";vm.careerType=!1,vm.searchResultDiv=!1,vm.curData="",vm.occupationData="",vm.tag=$state.params.tag||0,vm.whereType="",vm.skipCareerType=function(where,contrast,id){vm.careerType=!0,vm.whereType=where,vm.throwContrast=contrast,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.agecheck=function(birthday){if(birthday){var b=new Date(birthday),d=new Date,age=d.getFullYear()-b.getFullYear()-(d.getMonth()<b.getMonth()||d.getMonth()==b.getMonth()&&d.getDate()<b.getDate()?1:0);return $log.info(age),age}return!1},vm.throwContrastData=function(){return 1===vm.throwContrast?(vm.PbHoldOccupText=vm.curData,vm.PbHoldOccupCode=vm.occupationData):2===vm.throwContrast&&(vm.LiRcgnOccupText=vm.curData,vm.LiRcgnOccupCode=vm.occupationData),"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData?void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人"):"09"==vm.relation&&"recognize"==vm.whereType&&"13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData?(TipService.showMsg("投被保人关系为子女,被保人的职业只能为学生或者学龄前儿童。"),vm.LiRcgnOccupText="",void(vm.LiRcgnOccupCode="")):void(vm.careerType=!1)},vm.goNext=function(){""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode,pg){return 1===vm.throwContrast?(vm.PbHoldOccupText=curData,vm.PbHoldOccupCode=curCode):2===vm.throwContrast&&(vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode),"Y0000"==curCode||"R0047"==curCode||"R0022"==curCode?void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人"):"09"==vm.relation&&"recognize"==vm.whereType&&"13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode?void TipService.showMsg("投被保人关系为子女，被保人的职业只能为学生或者学龄前儿童。"):void(vm.careerType=!1)},$scope.blur=!1,$scope.blurClick=function(){$scope.blur=!0},$scope.focusClick=function(){$scope.blur=!1},vm.emailList=[{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function($event,value){$event.stopPropagation(),vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){$scope.blur=!1,vm.emailListShow=!0},vm.emailBlur=function(val){$scope.blur=!0,vm.emailListShow=!1},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.ifNavFloTrue=!1,vm.showBackScroll=function(){var navScrollTop=document.getElementById("ion-content95").scrollTop,h1=document.getElementById("heightBox").offsetHeight,t1=document.getElementById("tab1").offsetTop,t2=document.getElementById("tab2").offsetTop,t3=document.getElementById("tab3").offsetTop,timer=$timeout(function(){navScrollTop>=h1?(vm.ifNavFloTrue=!0,navScrollTop>=t1&&(vm.longActive=1,navScrollTop>=t2&&(vm.longActive=2,navScrollTop>=t3&&(vm.longActive=3)))):vm.ifNavFloTrue=!1,$timeout.cancel(timer)},50)},vm.goToTab=function(index){var name="tab"+index;"812"==CONFIG.SALE_CHANNEL?($anchorScroll.yOffset=140,$anchorScroll(name)):($anchorScroll.yOffset=100,$anchorScroll(name)),vm.longActive=index},vm.setExpireDate=function(key){"长期有效"===vm[key]?vm[key]="":vm[key]="长期有效"}}angular.module("app").controller("HmreController",HmreController),HmreController.$inject=["$state","$sce","VALIDATION","$document","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$ionicPopup","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicModal","COMMON","$http"]}(),function(){function HmreHealthController($rootScope,CONFIG,CommonRequest,PolicyService,TipService){var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||{},vm.planCode=[],vm.initFn=function(){var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||{},vm.CheckPolicydata=JSON.parse(sessionStorage.getItem("CheckPolicydata"))},vm.initFn(),vm.nextleftFn=function(){TipService.showMsg("尊敬的客户，您的情况不符合本产品的投保要求，暂时无法购买，感谢您的理解与支持！")},vm.nextrightFn=function(){vm.CheckPolicydata=JSON.parse(sessionStorage.getItem("CheckPolicydata")),vm.CheckPolicydata.busiList.forEach(function(element){(/HMRFc/.test(element.cvrID)||/HMRFb/.test(element.cvrID))&&vm.planCode.push(element.cvrID)}),localStorage.setItem("planCode",JSON.stringify(vm.planCode)),console.log(vm.CheckPolicydata,"vm.CheckPolicydata"),vm.arrDate={prdId:vm.CheckPolicydata.busiList[0].prdId,sex:vm.CheckPolicydata.rcgnList[0].rcgnGndCd,insurerBirthDay:vm.CheckPolicydata.rcgnList[0].rcgnBrthDt,planId:vm.CheckPolicydata.busiList[0].planId,premiumResult:vm.CheckPolicydata.allInsuExp,orderCode:""},CommonRequest.request(vm.arrDate,CONFIG.PREMIUM_RESULT_SERVICE,function(result){if(1==result.status){var orderCode=result.data.orderCode;PolicyService.setSessionData({productData:{orderCode:orderCode}}),"1"!=$rootScope.isLogin&&PolicyService.setSessionData({userData:{cretNo:vm.CheckPolicydata.plchdCrdtNo,cretType:vm.CheckPolicydata.plchdCrdtTpCd,customerName:vm.CheckPolicydata.plchdNm,inputId:"0",phoneNo:vm.CheckPolicydata.plchdMoveTelNo,sex:vm.CheckPolicydata.plchdGndCd}}),PolicyService.control({state:"product-hmrfa-hmre-calculate",control:"process"})}})}}angular.module("app").controller("HmreHealthController",HmreHealthController),HmreHealthController.$inject=["$rootScope","CONFIG","CommonRequest","PolicyService","TipService"]}(),function(){function AutomaticRefundController(PolicyService,$state,$rootScope,$scope,$ionicModal,$log,CONFIG,CommonRequest,TipService,$window){var vm=this,params=$state.params,sessionData=PolicyService.getSessionData();vm.orderCode=params.orderCode,vm.status=params.payResult,vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.getPolicy=function(){var params={orderCode:vm.orderCode};CommonRequest.request(params,CONFIG.FIND_POILCYNO_SERVICE,function(result){1==result.status?(vm.order=result.data,vm.order&&vm.order.length>0?(vm.name=vm.order[0].insureName,vm.prdName=vm.order[0].prdName,vm.orderNum=vm.order[0].orderCode):TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)):TipService.showMsg($rootScope.TIPS.PRODUCT.NO_POLICY)})},vm.getPolicy()}angular.module("app").controller("AutomaticRefundController",AutomaticRefundController),AutomaticRefundController.$inject=["PolicyService","$state","$rootScope","$scope","$ionicModal","$log","CONFIG","CommonRequest","TipService","$window"]}(),function(){function OnlineQuestionnaireController($state,$ionicModal,$scope){$scope.continueViewPolicy=function(){$ionicModal.close(!0)},$scope.submitQuestionnaire=function(){}}angular.module("app").controller("OnlineQuestionnaireController",OnlineQuestionnaireController),OnlineQuestionnaireController.$inject=["$state","$ionicModal","$scope"]}(),function(){function activitionPageController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup,$http,$log){var vm=this;vm.batchNo=$state.params.batchNo,vm.way="N",vm.newRule=!1,localStorage.removeItem("call"),localStorage.removeItem("userInfo"),"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.getBat=function(){console.info($rootScope);var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){res.status&&(vm.bgUrl=CONFIG.DOMAIN+"/statics/cardTemp/cardImg/"+res.card[vm.batchNo].src,vm.hasButton=res.card[vm.batchNo].button,vm.buttonUrl=CONFIG.DOMAIN+"/statics/cardTemp/cardImg/"+res.card[vm.batchNo].button,vm.styleText=res.card[vm.batchNo].styleText,vm.nextPage=res.card[vm.batchNo].nextPage||"",vm.newCardPage=res.card[vm.batchNo].newCardPage||"",vm.newCardPageTwo=res.card[vm.batchNo].newCardPageTwo||"",vm.ccbLink=res.ccbLink)})},vm.getBat(),vm.showPopup=function(){1==vm.nextPage?(localStorage.setItem("batchNo",vm.batchNo),vm.newCardPage?window.location.href=CONFIG.DOMAIN+"/ccblife-card/#/blankPage":vm.newCardPageTwo?$state.go("page-change",{newCardPageTwo:!0}):$state.go("page-change")):vm.newCardPage?window.location.href=CONFIG.DOMAIN+"/ccblife-card/#/activityInfo/0/0/"+vm.batchNo:$state.go("card-activation-app",{cardNo:"",cardPwd:"",batchNo:vm.batchNo})}}angular.module("app").controller("activitionPageController",activitionPageController),activitionPageController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function activitionsRuleController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup){var vm=this;vm.goAct=function(){$state.go("activitions-page")}}angular.module("app").controller("activitionsRuleController",activitionsRuleController),activitionsRuleController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function activitionsPageController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup,$http,$log){var vm=this;vm.way="N",localStorage.removeItem("call"),localStorage.removeItem("userInfo"),vm.getBat=function(){var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){if(res.status){var result=res;console.info(res.data),vm.batchList=result.data}})},vm.getBat(),vm.showPopup=function(actBatch){console.info(actBatch),localStorage.setItem("batchNo",actBatch),$state.go("page-change")},vm.rule=function(){$state.go("activitions-rule")}}angular.module("app").controller("activitionsPageController",activitionsPageController),activitionsPageController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function CalculateRiskController($state,CONFIG,CommonRequest,$document,TipService,PolicyService,$rootScope,$filter){var vm=this;vm.button=!0,vm.check=function(){vm.button=!vm.button};var sessionData=PolicyService.getSessionData(),prodata=vm.prodata=sessionData.productData;if(!prodata)return void $state.go("home");var userdata=sessionData.userData;sessionData.login;vm.getQuestions=function(){var params={prdId:prodata.prd_id};CommonRequest.request(params,CONFIG.PRODUCT_RISK_INFO_SERVICE,function(result){1==result.status&&(vm.questions=result.data.datas)})},vm.getQuestions(),vm.selecte=function(answer,code){vm.questions.forEach(function(item){if(item.subjectCode==code){var titles=item.titles;titles.forEach(function(item){item.titleCode==answer.titleCode?item.selected=!0:item.selected=!1})}})},vm.submit=function(){for(var score=($document[0].riskForm,[]),totalScore=0,i=0;i<vm.questions.length;i++)score.push(vm.questions[i].value);for(var flag=!0,i=0;i<score.length;i++)""==score[i]&&(flag=!1);if(flag){for(var j=0;j<score.length;j++)totalScore+=parseInt(score[j]);if(6>=totalScore)TipService.showMsg($rootScope.TIPS.PRODUCT.RISK_FAILED);else{var params={totalScore:totalScore,insurer_cer_type:userdata.cretType,insurer_cer_id:userdata.cretNo,customer_name:userdata.customerName,prdId:prodata.prd_id,orderCode:prodata.orderCode};CommonRequest.request(params,CONFIG.PRODUCT_RISK_SUBMIT_SERVICE,function(result){if(1==result.status){var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{enduranceTestTime:now}}),PolicyService.control({state:$state.current.name,control:"process"})}})}}else TipService.showMsg($rootScope.TIPS.PRODUCT.RISK_NOT_FINISHED)}}angular.module("app").controller("CalculateRiskController",CalculateRiskController),CalculateRiskController.$inject=["$state","CONFIG","CommonRequest","$document","TipService","PolicyService","$rootScope","$filter"]}(),function(){function blankPageController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup){function terminal(){var u=navigator.userAgent,isAndroid=u.indexOf("Android")>-1||u.indexOf("Adr")>-1,isiOS=!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);return isAndroid?"Android":isiOS?"IOS":void 0}var vm=this;console.info("getBat"),vm.getBat=function(){var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){if(res.status){var gocardpage=function(){return vm.newCardPageTwo?void(window.location.href=CONFIG.DOMAIN+"/elife-card/#/card/card-info/"+batchNo+"?userInfo="+encodeURIComponent($location.search().userInfo)):void $state.go("card-activation-app",{cardNo:"",cardPwd:"",batchNo:$location.search().batch_no||batchNo})},getUserInfo=function(){if($location.search().userInfo)localStorage.setItem("userInfo",encodeURIComponent($location.search().userInfo)),gocardpage();else if("T"==localStorage.getItem("call"))gocardpage();else{var item=card[batchNo];if(!item||!item.bill)return $ionicPopup.show({template:"授权失败，该批次未配置",buttons:[{text:"确定"}]});vm.call=function(){var url=$window.location.href,bill_item=item.bill.bill_item,bill_merchant=item.bill.bill_merchant,bran_no=item.bill.bran_no,bill_merchant_desc="建信人寿",params="url="+encodeURIComponent(url)+"&bill_item="+bill_item+"&bill_merchant="+bill_merchant+"&bran_no="+bran_no+"&bill_merchant_desc="+bill_merchant_desc+"&batch_no="+batchNo+"&",startPage="index.html#/",data={funcid:"18001008",param:"appid=app2019112000000001&app_type="+vm.app_type+"&launchFrom=web&startPage="+encodeURIComponent(startPage)
};localStorage.setItem("call","T");var platform=terminal(),jsonArgs=JSON.stringify({key:"userinfoData"});try{"Android"==platform?window.CCBBridge.ccbDeleteShareData(jsonArgs,null):window.CCBBridge.callCCBNativeMethod("ccbDeleteShareData",jsonArgs,"")}catch(error){return gocardpage()}var userinfoData=JSON.stringify({key:"userinfoData",targetType:"1",authorize:"app2019112000000001",value:params});try{"Android"==platform?window.CCBBridge.ccbInsertShareData(userinfoData,null):window.CCBBridge.callCCBNativeMethod("ccbInsertShareData",userinfoData,"")}catch(error){return gocardpage()}try{"Android"==platform?window.CCBBridge.ccbCallCenter(JSON.stringify(data),null):window.CCBBridge.callCCBNativeMethod("ccbCallCenter",JSON.stringify(data),"")}catch(e){return gocardpage()}gocardpage()},vm.call()}},card=res.card,batchNo=localStorage.getItem("batchNo");vm.app_type=res.app_type||"1",vm.newCardPageTwo=res.card[$location.search().batch_no||batchNo].newCardPageTwo,getUserInfo()}})},vm.getBat()}angular.module("app").controller("blankPageController",blankPageController),blankPageController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function CardActivationController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,TIPS,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup){var vm=this;TipService.showMsg("您即将进入投保流程，请认真阅读保险条款。为保障您的权益，您的投保操作流程将被记录，请知悉！"),vm.materialShow=!1,vm.txCode="CCBSB100";var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||"",vm.policyData=sessionData.policyData||{},vm.cardNo=$state.params.cardNo,vm.cardPwd=$state.params.cardPwd,vm.batchNo=$location.search().batchNo||"",vm.yntCode=$location.search().yntCode||"",vm.axb_area=$location.search().area||"",vm.conId=$location.search().cId||"",vm.busssIo=$location.search().busIo||"",vm.cipherText=$location.search().cipText||"",vm.isCode=!0,vm.showPin=!1,vm.toNext="",vm.isarea=!0,vm.agress=!1,vm.showPin=!0,vm.verify=!vm.policyData.verify,vm.getBat=function(){var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){vm.result1=res.cardSaleType})},vm.getBat();var fromPage="collection"===sessionStorage.getItem("fromPage");if(vm.fromPage=fromPage,!function(){if(fromPage)return!0;var getBatchCollection={url:CONFIG.DOMAIN+"/statics/json/batch-collection.json",method:"GET"};CommonRequest.request({},getBatchCollection,function(res){for(var key in res)if(Object.hasOwnProperty.call(res,key))for(var arr=res[key],i=0;i<arr.length;i++)if(arr[i]===vm.batchNo)return window.location.href=CONFIG.DOMAIN+"/elife-card/#/card/activity-collection/"+key})}(),document.onreadystatechange=function(){"complete"!=document.readyState?document.body.style.display="none":CONFIG.WECHAT&&(vm.newC||-1==url.indexOf("?"))?document.body.style.display="none":document.body.style.display="block"},CONFIG.WECHAT){var url=$location.absUrl();if(-1==url.indexOf("?"))return vm.yntCode?void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"%26yntCode="+vm.yntCode+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"):vm.axb_area?void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"%26area="+vm.axb_area+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"):void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect");var param=url.split("?")[1];if(-1!=param.indexOf("code"))var codeStr=param?param.split("&")[0]:"",code=codeStr?codeStr.split("=")[1]:"";if(code||(code=$location.search().code),!code)return vm.yntCode?void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"%26yntCode="+vm.yntCode+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"):vm.axb_area?void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"%26area="+vm.axb_area+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect"):void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect")}vm.showPintuFun=function(){vm.showDrag=!0},vm.activationDisabled=!0,vm.minDate=new Date,vm.minDateNew=new Date(vm.minDate.getTime()+864e5),vm.maxDate=new Date(vm.minDate.getTime()+2592e6),vm.relation="01",vm.policyData.plchdNm&&(vm.name=vm.policyData.plchdNm,vm.nameDisabled=!0),vm.certType="A",vm.insureDisabled=!1,vm.policyData.plchdCrdtNo&&(vm.certNo=VALIDATION.certNoFormat(vm.policyData.plchdCrdtNo),vm.certNoDisabled=!0,fromPage&&(vm.insureDisabled=!0)),vm.policyData.insureCertNo&&(vm.relation="02",vm.insureCertNo=vm.policyData.insureCertNo,vm.insuerCertNoDisabled=!0),vm.policyData.plchdMoveTelNo?(vm.phone=VALIDATION.phoneFormat(vm.policyData.plchdMoveTelNo),vm.showPin=!1):vm.phone="",vm.email=vm.policyData.plchdEmailAdr||"",vm.certExpireType=!1,vm.insureCertExpireType=!1,vm.minStartDate=new Date((new Date).getTime()+864e5),$scope.$watch("cardActivation.certNo",function(newValue,oldValue){if(newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" ")),!VALIDATION.idCheck(newValue))return;if(vm.gender=VALIDATION.getSex(newValue)+"",vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.age=VALIDATION.getAgeByBirth(vm.birthday),"0"==vm.productData.minHolderAge)return void(parseInt(((new Date).getTime()-vm.birthday.getTime())/864e5)<30||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1);vm.age<vm.productData.minHolderAge||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1}}),$scope.$watch("cardActivation.insureCertNo",function(newValue,oldValue){if(newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.insureCertNo=newValue+" ")),!VALIDATION.idCheck(newValue))return;if(vm.insureGender=VALIDATION.getSex(newValue)+"",vm.insureBirthday=new Date(VALIDATION.getBirthday(newValue)),$rootScope.nextInsureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),vm.insureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),"0"==vm.productData.minAge)return void(parseInt(((new Date).getTime()-vm.insureBirthday.getTime())/864e5)<30||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1);vm.insureAge<vm.productData.minAge||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1}});var tipStartTime,tipSecTime;vm.startTimeChange=function($invalid){tipStartTime=$filter("date")(new Date(vm.startTime).getTime(),"yyyy年M月d日"),tipSecTime=$filter("date")(vm.startTime,"yyyy年M月d日"),vm.startTimeNew=$filter("date")(new Date(new Date(vm.startTime).getTime()-864e5),"yyyy-MM-dd"),vm.startTimeT=vm.startTimeNew+"   24:00:00",vm.startTime=vm.startTime+"   0时"},fromPage&&(vm.startTime=$filter("date")(new Date(+new Date+864e5),"yyyy-MM-dd"),vm.startTimeChange()),vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"1"==gender?"04":"05":"01"},vm.healthDetail=function(){COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")},$scope.$on("notice-choice",function(event,result){1==result?(vm.agree=!1,TipService.showMsg("抱歉，您未能通过投保审核，请选择其他保险卡","errorAlert")):(vm.agree=!0,"ok"==vm.toNext&&vm.next())}),$scope.$on("notice-choice1",function(event,result){if(12==result)if(console.info("说道"),COMMON.hideModal(),"01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?(vm.draftOrderCode(),COMMON.hideModal()):COMMON.hideModal()})}else vm.draftOrderCode()}),$scope.$on("notice-choice2",function(event,result){if(12==result)if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():COMMON.hideModal()})}else vm.draftOrderCode()}),vm.notcice_confirm=function(e){vm.agree&&(COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html"),vm.agree=!vm.agree)},vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr,"M01"==vm.materialArr[0].materialType&&(vm.description="条款"),vm.materialList()})}},vm.getWhitelist=function(){CommonRequest.request({},CONFIG.GETYNT_WHITE__CODE,function(result){if(1==result.status){vm.batList=result.yntcode,vm.whitePlan=result.whitePlan;for(var i=0;i<vm.batList.length;i++)vm.batchNo!=vm.batList[i].batchNo||vm.yntCode||(TipService.showMsg("未识别身份信息"),vm.isCode=!1);if(vm.policyData.batchNo)for(var i=0;i<vm.whitePlan.length;i++)if(vm.whitePlan[i]==vm.policyData.plchdTemplateCode)return vm.axb_area=$location.search().area||"",void(vm.axb_area?vm.axb_status=!0:(vm.axb_status=!0,vm.isarea=!1))}})},vm.getWhitelist(),vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductDetail=function(id){vm.activationDisabled=!1;var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;var _result$data=result.data,prd_id=_result$data.prd_id,prd_name=_result$data.prd_name;$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope,{isCard:!0,prd_id:prd_id,prd_name:prd_name});var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),PolicyService.setSessionData({productData:result.data})}vm.getProductMaterials(id)}})},vm.activationApply=function(){if(!vm.cardNo&&!vm.cardPwd&&!vm.batchNo)return vm.activeResult=vm.policyData,vm.pic_name="../statics/cardTemp/"+vm.activeResult.prdId+".jpg",void vm.getProductDetail(vm.policyData.prdId);var param={channelCode:CONFIG.SALE_CHANNEL};vm.cardNo&&vm.cardPwd?(param.plchdCardNo=vm.cardNo,param.plchdCardPwd=vm.cardPwd):vm.batchNo&&(param.batchNo=vm.batchNo),CommonRequest.request(param,CONFIG.CARD_ACTIVATION_APPLY,function(result){result.status&&1==result.status&&vm.queuryCardActiveResult(result.data)})},vm.getDate=function(){CommonRequest.request({},{url:"http://10.100.18.156/statics/product/"+CONFIG.SALE_CHANNEL+"/"+vm.productData.prd_id+"/"+vm.productData.prd_id+".json?padId="+vm.productData.prd_id,method:"get"},function(res){})};var activationCount=0;vm.queuryCardActiveResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),activationCount>=20)return activationCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_ACTIVE_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return activationCount++,void $timeout(function(){vm.queuryCardActiveResult(flowNo)},3e3);if($ionicLoading.hide(),activationCount=0,"1"==result.data.plchdRespCode){if(vm.whitePlan)for(var i=0;i<vm.whitePlan.length;i++)if(vm.whitePlan[i]==result.data.plchdTemplateCode){vm.axb_area=$location.search().area||"",vm.axb_area?vm.axb_status=!0:(vm.axb_status=!0,vm.isarea=!1);break}if(vm.activeResult=result.data,vm.activeResult.cardSaleType)for(var item in vm.result1)vm.result1[item]==vm.activeResult.cardSaleType&&$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope);localStorage.setItem("cardSaleType",result.data.cardSaleType),"2"==result.data.cardSaleType&&$state.go("activation-success",{respCode:"0",respMsg:"请使用龙支付专属链接进行激活"}),vm.pic_name="../statics/cardTemp/"+vm.activeResult.prdId+".jpg",vm.getProductDetail(result.data.prdId),setTimeout(function(){if($rootScope.userData&&"A"==$rootScope.userData.cretType&&!fromPage){var alertPopup=$ionicPopup.confirm({cssClass:"popup-icon",template:"您已绑定建信人寿公众号，是否使用绑定信息激活保险卡",okText:"使用",cancelText:"不使用"});alertPopup.then(function(res){res&&(vm.name=$rootScope.userData.customerName,vm.certNo=VALIDATION.certNoFormat($rootScope.userData.cretNo),vm.wxSavePhone=VALIDATION.phoneFormat($rootScope.userData.phoneNo),vm.phone=VALIDATION.phoneFormat($rootScope.userData.phoneNo),vm.dragShow())})}},1500)}"2"==result.data.plchdRespCode&&$state.go("card-check-id",{batchNo:vm.batchNo}),"0"==result.data.plchdRespCode&&$state.go("activation-success",{respCode:result.data.plchdRespCode,respMsg:result.data.plchdRespDesc})}else $ionicLoading.hide(),activationCount=0},!0)},vm.querySelect=function(){if(console.info("我是天才"),vm.conId||vm.busssIo||vm.cipherText){var params={cid:vm.conId,bus:vm.busssIo,ciText:vm.cipherText};CommonRequest.request(params,CONFIG.CUSINFOEN,function(result){if(1!=result.status)return void $state.go("card-default");var data=JSON.parse(result.data);vm.name=data.recogNizee,vm.certNo=data.idEntity,vm.phone=data.Tel,vm.phone&&(vm.showPin=!1),$("#regname").attr("readonly","readonly"),$("#regcard").attr("readonly","readonly"),vm.activationApply()})}else vm.activationApply()},vm.querySelect(),vm.insuYearFlag="",vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){vm.insuYearFlag=plans[0].insuYearFlag;for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日"),vm.insuYearT=plans[i].insuYear;for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.mobileCheck=function(){var params={custName:vm.name,cretNo:vm.certNo.replace(/\s+/g,""),cretType:vm.certType,phoneNo:vm.phone.replace(/\s+/g,""),prodId:vm.activeResult.prdId};CommonRequest.request(params,CONFIG.CARD_ACTIVATION_POLICY_MOBILECHECK,function(result){"1"==result.status?vm.checkHold(result.data.orderCode):result.error.message})},vm.draftOrderCode=function(){var params={prdId:vm.activeResult.prdId,mobileNo:vm.phone.replace(/\s+/g,""),smsCode:vm.phoneCode?vm.phoneCode:"",issmsCode:vm.showPin?vm.issmsCode:"Y"};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){if(1==result.status){if($scope.traceId=window.traceId,console.log($scope.traceId+":"),$scope.traceId)try{var traceData=angular.toJson($rootScope.traceData);sessionStorage.setItem("elife-traceData",traceData),_yfx_sendorderid(vm.batchNo+result.data.orderCode,result.data.orderCode)}catch(e){console.log("finish trace error: "+e.message)}vm.verify?vm.mobileCheck():vm.checkHold(result.data.orderCode)}else COMMON.hideModal()})},vm.checkHold=function(orderCode){var rcgnCrdtExpDt,plchdCrdtExpDt=vm.certExpireType?"20991231":$filter("date")(vm.certExpireDate,"yyyyMMdd");rcgnCrdtExpDt="01"==vm.relation?plchdCrdtExpDt:vm.insureCertExpireType?"20991231":$filter("date")(vm.insureCertExpireDate,"yyyyMMdd");var insPolcyIntndEfDt=$filter("date")(vm.startTimeT.substring(0,10),"yyyyMMdd"),params={prdId:vm.activeResult.prdId,orderCode:orderCode,plchdCardNo:vm.cardNo,insPolcyIntndEfDt:insPolcyIntndEfDt,plchdBrthDt:$filter("date")(vm.birthday,"yyyyMMdd"),plchdCrdtExpDt:plchdCrdtExpDt,plchdCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,""),plchdCrdtTpCd:"A",plchdEmailAdr:vm.email,plchdGndCd:vm.gender,plchdMoveTelNo:vm.phone.replace(/\s+/g,""),plchdNatCd:"0156",plchdNm:vm.name,plchdAndRcgnReTpCd:vm.checkRelation(vm.relation,vm.gender),rcgnBrthDt:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),rcgnCrdtExpDt:rcgnCrdtExpDt,rcgnCrdtNo:"01"==vm.relation?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),rcgnCrdtTpCd:"A",rcgnEmail:vm.email,rcgnGndCd:"01"==vm.relation?vm.gender:vm.insureGender,rcgnNatCd:"0156",rcgnNm:"01"==vm.relation?vm.name:vm.insureName,channelCode:CONFIG.SALE_CHANNEL,plchdProvCd:vm.activeResult.plchdProvinceCode,plchdCityCd:vm.activeResult.plchdCityCode,plchdCntyAndDstcCd:vm.activeResult.plchdDistrictCode,rsdntTpCd:vm.activeResult.plchdCityFlag,appNoNum:vm.activeResult.plchdPrtCount,totInsPremAmt:vm.activeResult.initPyFAmt,coPyFAmt:vm.activeResult.coPyFAmt,interfaceCode:vm.activeResult.funcFlag,batchNo:vm.activeResult.batchNo||vm.batchNo||"",insurear:vm.insuYearT,insurearflag:vm.insuYearFlag,insValiDate:vm.startTimeT};if(CommonRequest.request(params,CONFIG.CARD_CHECK_HOLD,function(result){result&&1==result.status&&result.data&&""!=result.data&&vm.checkHoldResult(result.data)}),1==vm.axb_status);};var checkHoldResultCount=0;vm.checkHoldResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),checkHoldResultCount>=20)return checkHoldResultCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_CHECKHOLDRESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return checkHoldResultCount++,void $timeout(function(){vm.checkHoldResult(flowNo)},3e3);var endTime=result.data.insEndDate;if($ionicLoading.hide(),checkHoldResultCount=0,"1"==result.data.respCode){var policyData={name:vm.name,cardNo:vm.cardNo||result.data.cardNo,orderCode:result.data.orderCode,tipStartTimelhh:tipStartTime,insurYearArrlhh:vm.insurYearArr,insEndDate:endTime,batchNo:vm.batchNo,priCardNo:result.data.priCardNo};if(PolicyService.setSessionData({policyData:policyData}),"0"==result.data.personalPay){PolicyService.setSessionData({policyData:{orderCode:result.data.orderCode,itemOrderRealPayAmt:result.data.totInsPremAmt,BkBrchNo:result.data.orgCode}});var payReqData={orderCode:policyData.orderCode,pbCertNo:policyData.PbHoldId,branchCode:policyData.BkBrchNo||result.data.orgCode,payAmount:policyData.itemOrderRealPayAmt||result.data.totInsPremAmt};CommonRequest.request(payReqData,CONFIG.CHECK_PAY_CHANNEL,function(result){if("1"==result.status)if("01"==result.data.prdPayPlatFormCode){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var data=PolicyService.getSessionData().policyData,payData={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:data.BkBrchNo,orderCode:data.orderCode,payAmount:data.itemOrderRealPayAmt,platForm:platForm,browserType:CONFIG.WECHAT?"01":"02",opendId:$rootScope.openid||"blank",channelCode:CONFIG.SALE_CHANNEL,paySign:result.data.paySign};CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE_POST,function(result){if("1"==result.status){var data=result.data;"000000"==data.payStatus&&(window.location.href=data.payRedirectUrl)}})}else"00"==result.data.prdPayPlatFormCode&&$state.go("card-pay")})}"1"==result.data.personalPay&&$state.go("activation-success",{respCode:result.data.respCode,respMsg:result.data.respMsg})}"0"==result.data.respCode&&$state.go("activation-success",{respCode:"2",respMsg:result.data.respMsg})}else $ionicLoading.hide(),checkHoldResultCount=0},!0)},vm.next=function(invalid){if(!vm.productData.payType)return void TipService.showMsg("该订单没有可用的支付方式，请联系系统管理员进行维护！");if(0==vm.isCode)return void TipService.showMsg("未识别身份信息");if(invalid||vm.holdAgeError||vm.insureAgeError)if("02"==vm.relation){if(invalid||vm.holdAgeError||vm.insureAgeError)return void TipService.showMsg("请完善投保信息","errorAlert")}else if(invalid||vm.holdAgeError)return void TipService.showMsg("请完善投保信息","errorAlert");if(vm.agree){var idCard=vm.insureCertNo||vm.certNo,yntCodeStr=(idCard+"YNT"+vm.phone).toUpperCase().replace(/\s+/g,"");if(vm.yntCode&&vm.yntCode!==md5(yntCodeStr))return TipService.showMsg("未通过身份验证，无法领取本保险。<br>温馨提示：<br>1.非建行裕农通医疗合作方业主，无法免费领取；<br>2.请确认本人信息是否填写正确");if($rootScope.nextRelation=vm.relation,vm.productData.hotTip&&vm.productData.hotTip.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-ss/card-activation-notice.html");else if(vm.productData.exoneration&&vm.productData.exoneration.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-sr/card-activation-notice.html");else if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():console.info(2)})}else vm.draftOrderCode()}else vm.healthDetail(),vm.toNext="ok"},vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",$rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.issmsCode=!0,vm.dragShow=function(){if(vm.phone.replace(/\s+/g,"").length>11)return void(vm.phone=VALIDATION.phoneFormat(vm.phone.replace(/\s+/g,"").substring(0,11)));if(vm.phone&&(vm.phoneInvalid=!0),VALIDATION.phoneCheck(vm.phone)){if(vm.phoneInvalid=!1,vm.phone=VALIDATION.phoneFormat(vm.phone),vm.phone===vm.wxSavePhone)return vm.showPin=!1,void(vm.issmsCode=!1);if(vm.showDrag)return;vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg()}else vm.showPin=!1,vm.showDrag=!1,vm.doAnimate=!0},$rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||vm.getdragimg()}),vm.dragDisabled=!0,$rootScope.$on("drag-down",function(event,result){vm.showDrag=!1,vm.showPin=!0,vm.doAnimate=!0,vm.dragDisabled=!1,vm.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)}),vm.phoneAlert=function(i){};var alertMsg;vm.errorAlert=function(key,val){"name"==key&&(1==val.invalid?alertMsg=TIPS.getTips().COMMON.USER_NAME_INVALID:1==val.length&&(alertMsg=TIPS.getTips().COMMON.USER_NAME_LENGTH_ERROR)),"phone"==key&&1==val&&(alertMsg=TIPS.getTips().COMMON.PHONE_INVALID),"certNo"!=key&&"insureCertNo"!=key||(1==val.invalid2?alertMsg=TIPS.getTips().COMMON.ID_INVALID2:1==val.length?alertMsg=TIPS.getTips().COMMON.ID_LENGTH_ERROR:1==val.invalid?alertMsg=TIPS.getTips().COMMON.ID_INVALID:1==vm.holdAgeError?alertMsg=""==vm.holdAgeError?"":"投保人年龄范围不符合要求":1==vm.insureAgeError&&(alertMsg=""==vm.insureAgeError?"":"子女年龄范围不符合要求")),"email"==key&&(1==val.invalid?alertMsg=TIPS.getTips().COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符")),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,console.info(val.invalid),1==val.invalid?(alertMsg=TIPS.getTips().COMMON.EMAIL_INVALID,TipService.showMsg(alertMsg,"errorAlert"),alertMsg=""):1==val.length&&(alertMsg="您输入的邮箱长度不符")},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}}}angular.module("app").controller("CardActivationController",CardActivationController),CardActivationController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","TIPS","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function IDUploadController($rootScope,$location,Upload,CONFIG,$scope,TipService,PolicyService,COMMON,$ionicLoading,$timeout){var sessionData=PolicyService.getSessionData(),policydata=$scope.policydata=sessionData.policyData,prodata=$scope.prodata=sessionData.productData;if(!prodata.orderCode)return void $scope.close();$scope.files={},$scope.files.file1="",$scope.files.file2="",$scope.imageList=[],$scope.uploaded=0,1==sessionData.login&&PolicyService.getCustPhoto("100",function(images){for(var i=images.length-1;i>=0;i--){var image=images[i],flag=image.imageFlag;"F001"==flag?$scope.image1=$scope.files.file1=image.imagePath:"F002"==flag&&($scope.image2=$scope.files.file2=image.imagePath)}}),$scope.cancel=function(){COMMON.hideModal()};var BkBrchNo=policydata?policydata.BkBrchNo:"";BkBrchNo&&COMMON.getCommonBank(BkBrchNo,"1",function(bankList){$scope.bankList=bankList,$scope.bankList&&$scope.bankList.length>0&&($scope.newGet.newGetBk=$scope.bankList[0])}),$scope.name=policydata?policydata.PbHoldName:"",$scope.newGet={},$scope.newGet.newPayMode="7",$scope.newGet.newGetAccName=policydata?policydata.PbHoldName:"",$scope.newGet.newGetAccCode="",$scope.submit=function(){if(2==$scope.uploaded)return void $scope.process();var self=this,file1=self.files.file1,file2=self.files.file2,image1=self.image1,image2=self.image2;return $scope.imageList=[],file1&&file2&&$scope.imageList.push({F001:file1,uploadType:"1000"},{F002:file2,uploadType:"0100"}),image1&&image2&&(file1==image1&&file2!=image2||file1!=image1&&file2==image2)?void TipService.showMsg($rootScope.TIPS.PRODUCT.UPLOAD_ANOTHER_PHOTO):void PolicyService.isAllowUpload($scope.imageList.length,function(){$scope.checkUpload($scope.uploaded)})},$scope.checkUpload=function(uploaded){var data={custId:sessionData.userData?sessionData.userData.cusId:"",token:sessionData.userData?sessionData.userData.token:"",channelCode:CONFIG.SALE_CHANNEL,orderCode:prodata.orderCode,txCode:"CCBSB107",srCode:"R0017"};$scope.upload(angular.extend($scope.imageList[uploaded],data),function(){$scope.uploaded++})},$scope.process=function(){var params={};$scope.newGet.newGetAccCode?(params={NewPayMode:$scope.newGet.newPayMode||"7",NewGetAccName:$scope.newGet.newGetAccName,NewGetBkCode:$scope.newGet.newGetBk.bankCode,NewGetBkName:$scope.newGet.newGetBk.bankName,NewGetAccCode:$scope.newGet.newGetAccCode,orderCode:prodata.orderCode},params=angular.extend(policydata,params),PolicyService.control({state:"id-upload",control:"data",data:angular.extend(params,{isTransferred:!1,idUploaded:!0})})):params=policydata,PolicyService.checkPolicy(params,function(){PolicyService.control({state:"id-upload",control:"process"})})},$scope.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(result){$ionicLoading.hide(),"1"==result.data.status?($scope.uploadMsg="上传成功！",angular.isFunction(callback)&&callback()):(TipService.showMsg(result.data.error.message+result.data.error.code),$scope.uploadMsg="上传失败")},function(resp){$ionicLoading.hide(),$scope.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$scope.uploadMsg="上传进度: "+progressPercentage+"%"})},$scope.notify=function(){var params={channelCode:CONFIG.SALE_CHANNEL,orderCode:prodata.orderCode,txCode:"CCBSB107",uploadType:"100"};PolicyService.CertUploadDone(params,function(data){data&&$scope.process()})},$scope.$watch("uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&2>newValue?$scope.checkUpload(newValue):2==newValue&&$scope.notify())})}angular.module("app").controller("IDUploadController",IDUploadController),IDUploadController.$inject=["$rootScope","$location","Upload","CONFIG","$scope","TipService","PolicyService","COMMON","$ionicLoading","$timeout"]}(),function(){function ManualAuditController($rootScope,$location,Upload,CONFIG,$scope,TipService,PolicyService,COMMON,$ionicLoading,$timeout,CommonRequest,$ionicPopup,$state){var sessionData=PolicyService.getSessionData(),policydata=$scope.policydata=sessionData.policyData,prodata=$scope.prodata=sessionData.productData,uploadImgInOrder=sessionData.uploadImgInOrder;if(!prodata.orderCode)return void $scope.close();$scope.files={},$scope.files.file1="",$scope.files.file2="",$scope.files.file3="",$scope.files.file4="",$scope.imageList=[],$scope.uploaded=0,$scope.uploadNum=0;var auditParams=prodata.auditParams;if($scope.uploadStatus=auditParams.uploadStatus,auditParams&&auditParams.uploadType){var uploadType=auditParams.uploadType;$scope.uploadType=uploadType.split(""),
$scope.uploadID="1"==$scope.uploadType[0],$scope.uploadFinnace="1"==$scope.uploadType[1],$scope.uploadSeq="1"==$scope.uploadType[2],$scope.uploadID&&"1"!=auditParams.uploadStatus&&($scope.uploadNum+=2),$scope.uploadFinnace&&$scope.uploadNum++,$scope.uploadSeq&&$scope.uploadNum++}1==sessionData.login&&PolicyService.getCustPhoto(auditParams.uploadType,function(images){for(var i=images.length-1;i>=0;i--){var image=images[i],flag=image.imageFlag;"F001"==flag?$scope.image1=$scope.files.file1=image.imagePath:"F002"==flag?$scope.image2=$scope.files.file2=image.imagePath:"F003"==flag?$scope.image3=$scope.files.file3=image.imagePath:"F004"==flag&&($scope.image4=$scope.files.file4=image.imagePath)}}),$scope.cancel=function(){COMMON.hideModal()};var BkBrchNo=policydata?policydata.BkBrchNo:"";BkBrchNo&&COMMON.getCommonBank(BkBrchNo,"1",function(bankList){if($scope.bankList=bankList,$scope.bankList&&$scope.bankList.length>0&&($scope.newGet.newGetBk=$scope.bankList[0],/00051$/.test($scope.newGet.newGetBk.bankCode))){var paramsDate={bankCodeFlag:"Y"};paramsDate=angular.extend(policydata,paramsDate),PolicyService.control({state:"manual-audit",control:"data",data:angular.extend(paramsDate,{isManualAudited:!0})})}}),$scope.name=policydata?policydata.PbHoldName:"",$scope.newGet={},$scope.newGet.newPayMode="7",$scope.newGet.newGetAccName=policydata?policydata.PbHoldName:"",$scope.newGet.newGetAccCode="",$scope.submit=function(){if(0==$scope.uploadNum||$scope.uploaded==$scope.uploadNum)return void $scope.process();var self=this,file1=self.files.file1,file2=self.files.file2,file3=self.files.file3,file4=self.files.file4,image1=self.image1,image2=self.image2;self.image3,self.image4;if($scope.imageList=[],$scope.uploadID&&"1"!=auditParams.uploadStatus){if(!file1||!file2)return;$scope.imageList.push({F001:file1,uploadType:"1000"},{F002:file2,uploadType:"0100"})}if($scope.uploadFinnace){if(!file3)return;$scope.imageList.push({F003:file3,uploadType:"0010"})}if($scope.uploadSeq){if(!file4)return;$scope.imageList.push({F004:file4,uploadType:"0001"})}return $scope.uploadID&&image1&&image2&&(file1==image1&&file2!=image2||file1!=image1&&file2==image2)?void TipService.showMsg($rootScope.TIPS.PRODUCT.UPLOAD_ANOTHER_PHOTO):void PolicyService.isAllowUpload($scope.imageList.length,function(){$scope.checkUpload($scope.uploaded)})},$scope.checkUpload=function(uploaded){var data={custId:sessionData.userData?sessionData.userData.cusId:"",token:sessionData.userData?sessionData.userData.token:"",channelCode:CONFIG.SALE_CHANNEL,orderCode:prodata.orderCode,txCode:"CCBSB107",srCode:auditParams.srCode};$scope.upload(angular.extend($scope.imageList[uploaded],data),function(){$scope.uploaded++})},$scope.process=function(){var params={};$scope.newGet.newGetAccCode?(params={NewPayMode:$scope.newGet.newPayMode||"7",NewGetAccName:$scope.newGet.newGetAccName,NewGetBkCode:$scope.newGet.newGetBk.bankCode,NewGetBkName:$scope.newGet.newGetBk.bankName,NewGetAccCode:$scope.newGet.newGetAccCode,orderCode:prodata.orderCode,insureCheckFlg:"1"==auditParams.uploadStatus&&$scope.uploadType.toString()==["1","0","0"].toString()?"1":auditParams.insureCheckFlg},params=angular.extend(policydata,params),PolicyService.control({state:"manual-audit",control:"data",data:angular.extend(params,{isManualAudited:!0})})):params=policydata,uploadImgInOrder?PolicyService.checkPolicy(params,"afterupload",function(){PolicyService.removeSessionData(["uploadImgInOrder"]),$rootScope.$broadcast("img-uploadsuccess",{result:!0}),COMMON.hideModal()}):PolicyService.checkPolicy(params,"single",function(){PolicyService.control({state:"manual-audit",control:"process"})})},$scope.upload=function(data,callback){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),Upload.upload({url:CONFIG.UPLOAD_SERVICE.url,data:data}).then(function(result){$ionicLoading.hide(),"1"==result.data.status?($scope.uploadMsg="上传成功！",angular.isFunction(callback)&&callback()):(TipService.showMsg(result.data.error.message+result.data.error.code),$scope.uploadMsg="上传失败")},function(resp){$ionicLoading.hide(),$scope.uploadMsg="上传失败，错误代码: "+resp.status},function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$scope.uploadMsg="上传进度: "+progressPercentage+"%"})},$scope.notify=function(){var params={channelCode:CONFIG.SALE_CHANNEL,orderCode:prodata.orderCode,txCode:"CCBSB107",uploadType:auditParams.uploadType};PolicyService.CertUploadDone(params,function(data){data&&$scope.process()})},$scope.$watch("uploaded",function(newValue,oldValue){newValue&&(newValue!=oldValue&&newValue<$scope.uploadNum?$scope.checkUpload(newValue):newValue==$scope.uploadNum&&$scope.notify())}),$scope.$watch("newGet.newGetBk",function(newValue){if(newValue)if(/00051$/.test(newValue.bankCode)){var paramsDate={bankCodeFlag:"Y"};paramsDate=angular.extend(policydata,paramsDate),PolicyService.control({state:"manual-audit",control:"data",data:angular.extend(paramsDate,{isManualAudited:!0})})}else{var paramsDate={bankCodeFlag:"N"};paramsDate=angular.extend(policydata,paramsDate),PolicyService.control({state:"manual-audit",control:"data",data:angular.extend(paramsDate,{isManualAudited:!0})})}})}angular.module("app").controller("ManualAuditController",ManualAuditController),ManualAuditController.$inject=["$rootScope","$location","Upload","CONFIG","$scope","TipService","PolicyService","COMMON","$ionicLoading","$timeout","CommonRequest","$ionicPopup","$state"]}(),function(){function outreachActivitionPageController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup,$http,$log){var vm=this;vm.batchNo=$state.params.batchNo,vm.outreach=$state.params.outreach,vm.information=$state.params.information,localStorage.setItem("encryptionInformation",vm.information),localStorage.setItem("outreach",vm.outreach),vm.way="N",vm.newRule=!1,"830"!=CONFIG.SALE_CHANNEL&&"819"!=CONFIG.SALE_CHANNEL&&"812"!=CONFIG.SALE_CHANNEL&&"823"!=CONFIG.SALE_CHANNEL||(vm.newRule=!0),vm.getBat=function(){console.info($rootScope);var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){res.status&&(vm.bgUrl=CONFIG.DOMAIN+"/statics/cardTemp/cardImg/"+res.card[vm.batchNo].src,vm.hasButton=res.card[vm.batchNo].button,vm.buttonUrl=CONFIG.DOMAIN+"/statics/cardTemp/cardImg/"+res.card[vm.batchNo].button,vm.styleText=res.card[vm.batchNo].styleText,vm.nextPage=res.card[vm.batchNo].nextPage||"",vm.newCardPage=res.card[vm.batchNo].newCardPage||"",vm.ccbLink=res.ccbLink,vm.way=res.way)})},vm.getBat(),vm.showPopup=function(){if(1==vm.nextPage){var linkIs=CONFIG.DOMAIN+vm.ccbLink;localStorage.setItem("linkIs",linkIs),"Y"==vm.way?$window.location.href=linkIs:$state.go("page-change")}else vm.newCardPage?window.location.href=CONFIG.DOMAIN+"/ccblife-card/#/activityInfo/0/0/"+vm.batchNo:$state.go("card-activation-app",{cardNo:"",cardPwd:"",batchNo:vm.batchNo})}}angular.module("app").controller("outreachActivitionPageController",outreachActivitionPageController),outreachActivitionPageController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup"]}(),function(){function MaterialController($scope,$ionicModal,TipService,PolicyService,COMMON,$sce){var sessionData=PolicyService.getSessionData(),prodata=$scope.prodata=sessionData.productData;if(!prodata)return TipService.showMsg("非法操作！"),void $state.go("tab.mall");var materialArr=prodata.materialArr;$scope.oneDetail=!1,materialArr&&materialArr.length>0&&($scope.materialArr=materialArr,1==$scope.materialArr.length&&($scope.url=$sce.trustAsResourceUrl($scope.materialArr[0].materialPath))),$scope.cancel=function(){COMMON.hideModal()}}angular.module("app").controller("MaterialController",MaterialController),MaterialController.$inject=["$scope","$ionicModal","TipService","PolicyService","COMMON","$sce"]}(),function(){function ProPurchaseConfirmController($state,$rootScope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$filter){var vm=this;$rootScope.fromMyorder=!1;var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.policyData&&vm.policyData.PbBeginDate){var year=vm.policyData.PbBeginDate.substring(0,4),month=vm.policyData.PbBeginDate.substring(4,6),day=vm.policyData.PbBeginDate.substring(6,8);vm.PbBeginDate=year+"-"+month+"-"+day}if(!vm.productData)return $state.go("tab.mall"),void $state.go("tab.mall");vm.flag_notify=!0;var prd_id=vm.productData.prd_id,GET_TEMP_NOTICE={url:"../statics/json/notifyMessage/"+prd_id+".json",method:"GET"},params=[];CommonRequest.request(params,GET_TEMP_NOTICE,function(result){result.data?(vm.flag_notify=!1,vm.dataList=result.data):vm.flag_notify=!0}),vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==prd_id&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),"ipaha"==vm.productData.templateCode.toLowerCase()&&(vm.insureData.mainPlan.insuYear=vm.insureData.tempDays),vm.basicProfile=vm.productData.basicProfile,vm.mainPlan=vm.insureData.mainPlan,vm.addPlan=vm.policyData.AppdList,vm.mainPlan&&(vm.duty=vm.mainPlan.dutys,vm.duty&&vm.duty.length>0?(vm.showDuty=!0,vm.showPlan=!1):(vm.showDuty=!1,vm.showPlan=!0)),vm.addPlan&&vm.addPlan.length>0&&(vm.showDuty=!1,vm.showPlan=!0),vm.changeFormat=function(insuYear,insuYearFlag){if("Y"==insuYearFlag){if(insuYear)return"1000"==insuYear?"终身":insuYear+"年"}else{if("D"==insuYearFlag)return insuYear+"天";if("M"==insuYearFlag)return insuYear+"月"}},vm.back=function(){$state.go("product-purchase-base-info")},vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params)}},vm.submit=function(){var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status){var now=new Date;if(now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{insureConfirmTime:now}}),1==$rootScope.isLogin||$rootScope.HLIFE)PolicyService.control({state:"product-purchase-confirm",control:"process"});else{var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"是否需要将您的投保信息绑定至此微信账号？",okText:"需要",cancelText:"取消"});alertPopup.then(function(res){res?COMMON.showModal("app/module/mall/product/auto-bind/auto-bind-new.html"):PolicyService.control({state:"product-purchase-confirm",control:"process"})})}}else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})}}angular.module("app").controller("ProPurchaseConfirmController",ProPurchaseConfirmController),ProPurchaseConfirmController.$inject=["$state","$rootScope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$filter"]}(),function(){function productPurchaseSignController($state,$rootScope,$scope,PolicyService,CommonRequest,CONFIG,TipService,COMMON,$interval,$timeout,$filter,VALIDATION){var vm=this,sessionData=PolicyService.getSessionData();vm.policyData=sessionData.policyData,vm.productData=sessionData.productData,vm.signStart=!1,$scope.startNmae=!1,vm.signName="",$scope.showSign=!1,$scope.insureImg="",$scope.showShare=!1,vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=25);var timerScroll=null;vm.scrollControl=function(){var wrapScroll=document.querySelector(".scroll-wrap"),first=document.querySelector(".wrap-begin"),end=document.querySelector(".wrap-end");end.innerHTML=first.innerHTML,timerScroll=$interval(function(){end.offsetWidth-wrapScroll.scrollLeft<=0?wrapScroll.scrollLeft=wrapScroll.scrollLeft-first.offsetWidth:wrapScroll.scrollLeft++},40)},$timeout(function(){vm.scrollControl()},10),$scope.$on("$destroy",function(){$interval.cancel(timerScroll)}),$scope.getVerifyList=function(){$scope.allComplete=!0,$scope.insureVerify=[],$scope.insuredVerify=[];var params={orderCode:$rootScope.fromMyorder?$rootScope.fromMyorderCode:vm.policyData.orderCode,custType:""};CommonRequest.request(params,CONFIG.GET_VERIFY_LIST,function(result){"1"==result.status&&result.data.map(function(item){"0"==item.custType?($scope.insureVerify.push(item),item.filePath&&($scope.insureImg=CONFIG.SERVICE_ADDRESS+"policyVerify/imageShow?custVerifyId="+item.id+"&fileName="+item.fileName)):(item.filePath&&(item.filePath=CONFIG.SERVICE_ADDRESS+"policyVerify/imageShow?custVerifyId="+item.id+"&fileName="+item.fileName),$scope.insuredVerify.push(item),"0"==item.verifyStatus&&($scope.allComplete=!1))})})},$timeout(function(){console.info($rootScope.fromMyorder),$scope.getVerifyList()},100),$scope.qrcodes=function(id){$("#erweima1").empty(),$scope.showShare=!0,vm.vwidth=.25*window.innerWidth,vm.qrcode2=$("#erweima1").qrcode({render:"canvas",text:CONFIG.DOMAIN+"/air-sign/#/signature/mobile/"+id,width:vm.vwidth,height:vm.vwidth,correctLevel:1,background:"#ffffff",foreground:"#000000"}).hide(),vm.canvas=vm.qrcode2.find("canvas").get(0);var canvasBox=document.createElement("canvas");canvasBox.width=750,canvasBox.height=1334;var context=canvasBox.getContext("2d");context.rect(0,0,canvasBox.width,canvasBox.height),context.fillStyle="#fff",context.fill();var backImg=new Image;backImg.src="img/common/backShare.png",backImg.onload=function(){context.drawImage(backImg,0,0,750,1334);var qrImg=new Image;qrImg.src=vm.canvas.toDataURL("image/png"),qrImg.onload=function(){context.fillStyle="#fff",context.fillRect(500,1100,220,220),context.drawImage(qrImg,520,1120,180,180),$("#bigShareImg").attr("src",canvasBox.toDataURL("image/png")),CommonRequest.request({custVerifyId:id},CONFIG.UPDATE_VERIFY_TIME,function(result){})}}},$scope.closeShare=function(){$scope.showShare=!1},$scope.openSign=function(name){vm.signName=name,$scope.showSign=!0,vm.showSignBox()},$scope.next=function(){if($scope.insureVerify&&$scope.insureVerify.length>0&&!$scope.insureImg)return void TipService.showMsg("请投保人完成签名");var isChecked=$scope.insuredVerify.every(function(item){return"1"==item.verifyStatus});if($scope.insuredVerify&&$scope.insuredVerify.length>0&&!isChecked)return void TipService.showMsg("还有被保险人未完成保单确认，请提醒TA~");if($interval.cancel(timerScroll),$rootScope.fromMyorder)$rootScope.payAgain();else{var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status){COMMON.hideModal();var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{insureConfirmTime:now}}),PolicyService.control({state:"product-purchase-confirm",control:"process"})}else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})}};var screenHeight=$(window).height();vm.showSignBox=function(){$timeout(function(){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000",this.background="#ffffff";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=screenHeight-70-vm.headHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=this.linewidth,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/common/water_mark_policy.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){$scope.startNmae=!0,this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),$scope.$apply()}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){$scope.startNmae=!1,vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0),$scope.$apply()}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL();if(signBase64){vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),"insure"==vm.signName&&($scope.insureImg=signBase64);var params={bytes:signBase64,orderCode:$rootScope.fromMyorder?$rootScope.fromMyorderCode:vm.policyData.orderCode,custVerifyId:$scope.insureVerify[0].id,fileName:"F100.png",prdId:$rootScope.fromMyorder?$rootScope.fromMyorderPrdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.UPDATE_VERIFY,function(result){"1"==result.status&&($scope.showSign=!1,$scope.startNmae=!1,$scope.getVerifyList(),$scope.$apply(),$timeout(function(){vm.scrollControl()},10))})}}.bind(this),!1)}document.getElementById("product-purchasesign").addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.getElementById("product-purchasesign").addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:9,color:"black",background:"#ffffff"})},10)}}angular.module("app").controller("productPurchaseSignController",productPurchaseSignController),productPurchaseSignController.$inject=["$state","$rootScope","$scope","PolicyService","CommonRequest","CONFIG","TipService","COMMON","$interval","$timeout","$filter","VALIDATION"]}(),function(){function TransferController($rootScope,$location,CONFIG,$scope,TipService,PolicyService,COMMON){var sessionData=PolicyService.getSessionData(),policydata=sessionData.policyData;PolicyService.control({state:"transfer",control:"data",data:{transferShown:!0}}),$scope.cancel=function(){COMMON.hideModal()};var BkBrchNo=policydata.BkBrchNo;COMMON.getCommonBank(BkBrchNo,"1",function(bankList){$scope.bankList=bankList,$scope.bankList&&$scope.bankList.length>0&&($scope.newGet.newGetBk=$scope.bankList[0])}),$scope.newGet={},$scope.newGet.newPayMode="7",$scope.newGet.newGetAccName=policydata.PbHoldName,$scope.newGet.newGetAccCode="",$scope.submit=function(){var params={NewPayMode:$scope.newGet.newPayMode||"7",NewGetAccName:$scope.newGet.newGetAccName,NewGetBkCode:$scope.newGet.newGetBk.bankCode,NewGetAccCode:$scope.newGet.newGetAccCode,NewGetBkName:$scope.newGet.newGetBk.bankName};params=angular.extend(policydata,params),PolicyService.control({state:"transfer",control:"data",data:angular.extend(params,{isTransferred:!0})}),PolicyService.checkPolicy(params)}}angular.module("app").controller("TransferController",TransferController),TransferController.$inject=["$rootScope","$location","CONFIG","$scope","TipService","PolicyService","COMMON"]}(),function(){function ProPurchaseGroupConfirmController($state,$rootScope,GroupPolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$filter){var vm=this;$rootScope.fromMyorder=!1;var sessionData=GroupPolicyService.getSessionData();return vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.materials=vm.productData.materials,vm.plans=vm.insureData.plans,vm.productData?(vm.basicProfile=vm.productData.basicProfile,vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),void(vm.submit=function(){var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status)if(1!=$rootScope.isLogin&&!$rootScope.HLIFE&&CONFIG.wxSwitch){var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"是否需要将您的投保信息绑定至此微信账号？",okText:"需要",cancelText:"取消"});alertPopup.then(function(res){res&&COMMON.showModal("app/module/mall/product/auto-bind/auto-bind.html")}).then(function(res){GroupPolicyService.control({state:"product-purchase-group-confirm",control:"process"})})}else GroupPolicyService.control({state:"product-purchase-group-confirm",control:"process"});else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})})):void $state.go("tab.mall")}angular.module("app").controller("ProPurchaseGroupConfirmController",ProPurchaseGroupConfirmController),ProPurchaseGroupConfirmController.$inject=["$state","$rootScope","GroupPolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$filter"]}(),function(){function CheckIdentityController($state,CONFIG,CommonRequest,PolicyService,TipService,$rootScope,$timeout){var vm=this,sessionData=PolicyService.getSessionData(),prodata=vm.prodata=sessionData.productData;return prodata?(vm.cerType="A","TAC"==prodata.templateCode&&(vm.cerTypeDisabled=!0),vm.checkIdentitySubmit=function(){var params={customer_name:vm.name,insurer_cer_type:vm.cerType,insurer_cer_id:vm.cerNo};PolicyService.checkRisk(params,function(testStatus){PolicyService.control({state:$state.current.name,control:"data",data:{customerName:vm.name,cretType:vm.cerType,cretNo:vm.cerNo,testStatus:testStatus}}),PolicyService.control({state:$state.current.name,control:"process"})})},vm.errorAlert=function(model,invalid,key,val){$rootScope.loadingPage&&model&&invalid&&(vm.showError=!0,$timeout(function(){vm.showError=!1},1500),"name"==key?1==val.invalid?vm.errorMsg=$rootScope.TIPS.COMMON.USER_NAME_INVALID:1==val.length&&(vm.errorMsg=$rootScope.TIPS.COMMON.USER_NAME_LENGTH_ERROR):"cerNo"==key&&(1==val.length?vm.errorMsg=$rootScope.TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?vm.errorMsg=$rootScope.TIPS.COMMON.ID_INVALID:1==val.invalid2?vm.errorMsg=$rootScope.TIPS.COMMON.ID_INVALID2:1==val.rr&&(vm.errorMsg="投保人证件号码有误")))},void(vm.hide=function(){vm.showError=!1})):void $state.go("tab.mall")}angular.module("app").controller("CheckIdentityController",CheckIdentityController),CheckIdentityController.$inject=["$state","CONFIG","CommonRequest","PolicyService","TipService","$rootScope","$timeout"]}(),function(){function productPurchaseGroupSignController($state,$rootScope,$scope,GroupPolicyService,CommonRequest,CONFIG,TipService,COMMON,$interval,$timeout,$filter,VALIDATION){var vm=this,sessionData=GroupPolicyService.getSessionData();vm.policyData=sessionData.policyData,vm.productData=sessionData.productData,vm.signStart=!1,$scope.startNmae=!1,vm.signName="",$scope.showSign=!1,$scope.insureImg="",$scope.showShare=!1,vm.headHeight=0,$rootScope.TITLEBAR&&(vm.headHeight=69);var timerScroll=null;vm.scrollControl=function(){var wrapScroll=document.querySelector(".scroll-wrap"),first=document.querySelector(".wrap-begin"),end=document.querySelector(".wrap-end");end.innerHTML=first.innerHTML,timerScroll=$interval(function(){end.offsetWidth-wrapScroll.scrollLeft<=0?wrapScroll.scrollLeft=wrapScroll.scrollLeft-first.offsetWidth:wrapScroll.scrollLeft++},40)},$timeout(function(){vm.scrollControl()},10),$scope.$on("$destroy",function(){$interval.cancel(timerScroll)}),$scope.getVerifyList=function(){$scope.insureVerify=[],$scope.insuredVerify=[];var params={orderCode:vm.policyData.orderCode,custType:""};CommonRequest.request(params,CONFIG.GET_VERIFY_LIST,function(result){"1"==result.status&&result.data.map(function(item){"0"==item.custType?($scope.insureVerify.push(item),item.filePath&&($scope.insureImg=CONFIG.SERVICE_ADDRESS+"policyVerify/imageShow?custVerifyId="+item.id+"&fileName="+item.fileName)):(item.filePath&&(item.filePath=CONFIG.SERVICE_ADDRESS+"policyVerify/imageShow?custVerifyId="+item.id+"&fileName="+item.fileName),$scope.insuredVerify.push(item))})})},$scope.getVerifyList(),$scope.qrcodes=function(id){$("#erweima1").empty(),$scope.showShare=!0,vm.vwidth=.25*window.innerWidth,vm.qrcode2=$("#erweima1").qrcode({render:"canvas",text:CONFIG.DOMAIN+"/air-sign/#/signature/mobile/"+id,width:vm.vwidth,height:vm.vwidth,correctLevel:1,background:"#ffffff",foreground:"#000000"}).hide(),vm.canvas=vm.qrcode2.find("canvas").get(0);var canvasBox=document.createElement("canvas");canvasBox.width=750,canvasBox.height=1334;var context=canvasBox.getContext("2d");context.rect(0,0,canvasBox.width,canvasBox.height),context.fillStyle="#fff",context.fill();var backImg=new Image;backImg.src="img/common/backShare.png",backImg.onload=function(){context.drawImage(backImg,0,0,750,1334),context.fillStyle="#fff",context.fillRect(500,1100,220,220);var qrImg=new Image;qrImg.src=vm.canvas.toDataURL("image/png"),qrImg.onload=function(){context.drawImage(qrImg,520,1120,180,180),$("#bigShareImg").attr("src",canvasBox.toDataURL("image/png")),CommonRequest.request({custVerifyId:id},CONFIG.UPDATE_VERIFY_TIME,function(result){})}}},$scope.closeShare=function(){$scope.showShare=!1},$scope.openSign=function(name){vm.signName=name,$scope.showSign=!0,vm.showSignBox()},$scope.next=function(){if($scope.insureVerify&&$scope.insureVerify.length>0&&!$scope.insureImg)return void TipService.showMsg("请投保人完成签名");var isChecked=$scope.insuredVerify.every(function(item){return"1"==item.verifyStatus});if($scope.insuredVerify&&$scope.insuredVerify.length>0&&!isChecked)return void TipService.showMsg("还有被保险人未完成保单确认，请提醒TA~");$interval.cancel(timerScroll);var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status)GroupPolicyService.control({state:"product-purchase-group-confirm",control:"process"});else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})};var screenHeight=$(window).height();vm.showSignBox=function(){$timeout(function(){function lineCanvas(obj){var lc=this;this.linewidth=9,this.color="#000000",this.background="#ffffff";for(var i in obj)this[i]=obj[i];this.canvas=document.createElement("canvas"),this.el.appendChild(this.canvas),this.cxt=this.canvas.getContext("2d"),this.canvas.width=this.el.clientWidth,this.canvas.height=screenHeight-70-vm.headHeight,this.cxt.fillStyle=this.background,this.cxt.fillRect(0,0,this.canvas.width,this.canvas.width),this.cxt.strokeStyle=this.color,this.cxt.lineWidth=this.linewidth,this.cxt.lineCap="round";var signMark=new Image;signMark.src="img/common/water_mark_policy.png",signMark.onload=function(){lc.cxt.drawImage(signMark,0,0)},this.canvas.addEventListener("touchstart",function(e){$scope.startNmae=!0,this.cxt.beginPath(),this.cxt.moveTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),$scope.$apply()}.bind(this),!1),this.canvas.addEventListener("touchmove",function(e){this.cxt.lineTo(e.changedTouches[0].pageX,e.changedTouches[0].pageY-vm.headHeight),this.cxt.stroke()}.bind(this),!1),this.canvas.addEventListener("touchend",function(){vm.signStart=!0,this.cxt.closePath()}.bind(this),!1),this.clearEl.addEventListener("click",function(){$scope.startNmae=!1,vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),lc.cxt.drawImage(signMark,0,0),$scope.$apply()}.bind(this),!1),this.saveEl.addEventListener("click",function(){if(!vm.signStart)return void TipService.showMsg("请完成签名");var signBase64=this.canvas.toDataURL();if(signBase64){vm.signStart=!1,this.cxt.clearRect(0,0,this.canvas.width,this.canvas.height),"insure"==vm.signName&&($scope.insureImg=signBase64);var params={bytes:signBase64,orderCode:vm.policyData.orderCode,custVerifyId:$scope.insureVerify[0].id,fileName:"F100.png",prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.UPDATE_VERIFY,function(result){"1"==result.status&&($scope.showSign=!1,$scope.startNmae=!1,$scope.getVerifyList(),$scope.$apply())})}}.bind(this),!1)}document.getElementById("product-purchasesign").addEventListener("touchstart",function(e){e.preventDefault()},{passive:!1}),document.getElementById("product-purchasesign").addEventListener("touchmove",function(e){e.preventDefault()},{passive:!1}),new lineCanvas({el:document.getElementById("canvas"),clearEl:document.getElementById("clearCanvas"),saveEl:document.getElementById("saveCanvas"),linewidth:9,color:"black",background:"#ffffff"})},10)}}angular.module("app").controller("productPurchaseGroupSignController",productPurchaseGroupSignController),productPurchaseGroupSignController.$inject=["$state","$rootScope","$scope","GroupPolicyService","CommonRequest","CONFIG","TipService","COMMON","$interval","$timeout","$filter","VALIDATION"]}(),function(){function AnkangAgreementController($state,CommonRequest,GroupPolicyService,COMMON,$scope,$rootScope,$filter,CONFIG,$timeout){var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.citizeentype=COMMON.getCommonData().CITIZENTYPE,vm.taxpymtnotype=COMMON.getCommonData().TAXPYMTNOTYPE,vm.nontaxpymtcd=COMMON.getCommonData().NONTAXPYMTCD;var BkBrchNo;vm.policyData&&(BkBrchNo=vm.policyData.BkBrchNo);var policyData;policyData=!vm.productData.basicProfile||"Y"!=vm.productData.basicProfile.P023&&"GHMB"!=vm.productData.prd_code?"":sessionData.policyData||"",vm.crsData=policyData.crsData?policyData.crsData:"",vm.policyData.PbHoldName&&(vm.newGetAccountName=vm.policyData.PbHoldName,vm.authAccountName=vm.policyData.PbHoldName,vm.bonusBankAccountName=vm.policyData.PbHoldName,vm.liBonusBankAccountName=vm.policyData.PbHoldName,vm.renewalBankAccountName=vm.policyData.PbHoldName),vm.basicProfile=vm.productData.basicProfile,vm.isBatts="-1",vm.insPyfPrdNum="0"!==vm.insureData.insPyfPrdNum,vm.isTipsVisible=!1,console.log(vm.isTipsVisible),vm.showRenewal1=!1,vm.showRenewal2=!1,policyData.plchdAccNo&&(policyData.plchdAccNo=policyData.plchdAccNo.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ")),vm.renewalBankAccount=vm.renewalBankAccountConfirm=policyData.plchdAccNo||"",policyData.plchdAccNo&&(vm.agree3=!0),vm.disputeHanding=policyData.PiZyzcfs||1,vm.disputeGroupName=policyData.PiZcinst||"",$scope.$watch("ankangAgreement.renewalBankAccount",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccount=str}}),$scope.$watch("ankangAgreement.renewalBankAccountConfirm",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccountConfirm=str}}),vm.getVprdid=function(){var params={prdCode:"ALLIN"};CommonRequest.request(params,CONFIG.NEW_GETPRDID,function(result){result.data&&(vm.v_prdid=result.data)})},"Y"==vm.basicProfile.P020&&vm.getVprdid(),vm.crsData?vm.citizenType=vm.crsData.citizenType||"":"A"==policyData.PbHoldIdType?vm.citizenType="1":vm.citizenType="",vm.insuranceName=vm.policyData.PbHoldName,vm.surname=vm.crsData.surname||"",vm.secondName=vm.crsData.secondName||"",vm.crsBirthday=vm.policyData.PbHoldBirdyDate,vm.liveCountry="中国",vm.liveZone=vm.policyData.liveProvince+"-"+vm.policyData.liveDistrict+"-"+vm.policyData.liveDstc,vm.liveAdr=vm.policyData.PbHoldAddress,vm.birthCountry=vm.crsData.birthCountryCont||"中国",vm.birthCode=vm.crsData.birthCountry||"CHN",vm.province={},vm.city={},vm.district={},vm.province.areaName=vm.crsData.birthProvinceCont||"",
vm.city.areaName=vm.crsData.birthDistrictCont||"",vm.district.areaName=vm.crsData.birthDstcCont||"",vm.province.areaCode=vm.crsData.birthProvince||"",vm.city.areaCode=vm.crsData.birthDistrict||"",vm.district.areaCode=vm.crsData.birthDstc||"",$scope.$on("select-country-close",function(event,result){vm.birthCountry=result[0].countryName,vm.birthCode=result[0].countryCode}),vm.locate=vm.crsData.birthProvinceCont?vm.crsData.birthProvinceCont+"-"+vm.crsData.birthDistrictCont+"-"+vm.crsData.birthDstcCont:"",vm.birthDetailAdr=vm.crsData.birthDetailAdr||"",$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),vm.signDate=$filter("date")(new Date,"yyyy年MM月dd日"),vm.isSelf="本人",vm.crsData.taxList&&0!=vm.crsData.taxList.length?vm.crsList=vm.crsData.taxList:vm.crsList=[{seqNo:1,taxPymtNoType:""}],vm.addCrs=function(){if(!(vm.crsList.length>=3)){var seqNo=vm.crsList[vm.crsList.length-1].seqNo+1;vm.crsList.push({seqNo:seqNo,taxPymtNoType:""})}},vm.delCrs=function(seqNo){if(!(vm.crsList.length<=1))for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&vm.crsList.splice(i,1)},vm.clearInput=function(Type,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&("1"==Type?vm.crsList[i].nonTaxPymtDesc="":"2"==Type&&(vm.crsList[i].taxPymtNo=""))},vm.clearInputse=function(nonTaxPymtCd,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&"1"==nonTaxPymtCd&&(vm.crsList[i].nonTaxPymtDesc="")},vm.getBankList=function(){BkBrchNo&&COMMON.getGroupCommonBank(BkBrchNo,function(bankList){if(vm.bankList=bankList,vm.bankList&&vm.bankList.length>0&&(vm.newGetBkCode=bankList[0],vm.renewalBancCode=bankList[0]),policyData.BankCode)for(var i=0;i<vm.bankList.length;i++)if(vm.bankList[i].bankCode==policyData.BankCode)return void(vm.renewalBank=vm.bankList[i])})},vm.getBankList(),vm.next=function(){var data={PiZyzcfs:vm.disputeHanding,PiZcinst:vm.disputeGroupName},battsData={isBatts:vm.isBatts,BankName:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBankAccountName:"",BankCode:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankCode:"",plchdAccNo:vm.renewalBankAccount.replace(/\s+/g,""),plchdAccBankNm:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankName:""};if(data=angular.extend(data,battsData),vm.basicProfile.P020&&"Y"==vm.basicProfile.P020){var birthFlag,isCitizenType=!0;"2"!=vm.citizenType&&"3"!=vm.citizenType||(isCitizenType=!1),birthFlag=("2"==vm.citizenType||"3"==vm.citizenType)&&"CHN"==vm.birthCode;var crsData={citizenType:vm.citizenType,surname:isCitizenType?"":vm.surname,secondName:isCitizenType?"":vm.secondName,liveCountry:isCitizenType?"":"CHN",birthCountryCont:isCitizenType?"":vm.birthCountry,birthCountry:isCitizenType?"":vm.birthCode,birthProvinceCont:vm.province&&birthFlag?vm.province.areaName:"",birthProvince:vm.province&&birthFlag?vm.province.areaCode:"",birthDistrictCont:vm.city&&birthFlag?vm.city.areaName:"",birthDistrict:vm.city&&birthFlag?vm.city.areaCode:"",birthDstcCont:vm.district&&birthFlag?vm.district.areaName:"",birthDstc:vm.district&&birthFlag?vm.district.areaCode:"",birthDetailAdr:isCitizenType?"":vm.birthDetailAdr,taxList:isCitizenType?[]:vm.crsList,signDate:vm.signDate,isSelf:"1"};data.crsData=crsData,data=angular.extend(data,crsData)}GroupPolicyService.control({state:"product-purchase-group-policy-agreement",control:"data",data:data}),$state.go("product-ankang-notice")}}angular.module("app").controller("AnkangAgreementController",AnkangAgreementController),AnkangAgreementController.$inject=["$state","CommonRequest","GroupPolicyService","COMMON","$scope","$rootScope","$filter","CONFIG","$timeout"]}(),function(){function ankangConfirmController($state,$rootScope,GroupPolicyService,CommonRequest,CONFIG,TipService,COMMON,$ionicPopup,$filter){var vm=this;$rootScope.fromMyorder=!1;var sessionData=GroupPolicyService.getSessionData();return vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};GroupPolicyService.getMaterialDetailOpen(params)}},vm.plans=vm.insureData.plans,vm.productData?(vm.basicProfile=vm.productData.basicProfile,vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),void(vm.submit=function(){if("Y"==vm.productData.basicProfile.P029)return void COMMON.showModal("app/module/mall/product/product-purchase-group/product-purchase-group-sign/product-purchase-group-sign.html");var params={orderCode:vm.policyData.orderCode};CommonRequest.request(params,CONFIG.POLICY_INFO_CONFIRM,function(result){if(1==result.status)if(1!=$rootScope.isLogin&&!$rootScope.HLIFE&&CONFIG.wxSwitch){var alertPopup=$ionicPopup.confirm({title:'<img src="img/common/Popupalert.png">',template:"是否需要将您的投保信息绑定至此微信账号？",okText:"需要",cancelText:"取消"});alertPopup.then(function(res){res&&COMMON.showModal("app/module/mall/product/auto-bind/auto-bind.html")}).then(function(res){GroupPolicyService.control({state:"product-purchase-group-confirm",control:"process"})})}else GroupPolicyService.control({state:"product-purchase-group-confirm",control:"process"});else{var error=result.error;TipService.showMsg(error.message),$state.go("tab.mall")}})})):void $state.go("tab.mall")}angular.module("app").controller("ankangConfirmController",ankangConfirmController),ankangConfirmController.$inject=["$state","$rootScope","GroupPolicyService","CommonRequest","CONFIG","TipService","COMMON","$ionicPopup","$filter"]}(),function(){function AnkangContactController($state,CommonRequest,CONFIG,GroupPolicyService,$scope,$rootScope,$ionicLoading,$timeout,$ionicPopup,TipService){function transOrigin(data){if(console.info(data),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){console.info(data),0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var dataLocation=result.addressComponents;vm.dataLocation=result.addressComponents,vm.gudgeIsLocation=dataLocation.province,vm.gudgeCity=dataLocation.city,vm.gudgeDistrict=dataLocation.district,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.gudgeIsLocation)}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"获取位置信息失败",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.userData=sessionData.userData,vm.insureDataList=vm.policyData.LiRcgnList||"",$rootScope.prdId=vm.productData.prd_id;var policyData;policyData=sessionData.policyData||"",console.info(sessionData),vm.locate=policyData.locate||"",vm.address=policyData.PbHoldAddress||"",vm.emailCode=policyData.PbHoldZipCode||"",vm.branch=policyData.branch||"",vm.insSaleChlType=policyData.insSaleChlType||"2",vm.referrerCode=policyData.referrerCode||"",vm.referrerName=policyData.referrerName||"",vm.province=policyData.province||"",vm.city=policyData.city||"",vm.district=policyData.district||"",vm.provinceNet=policyData.provinceNet||"",vm.cityNet=policyData.cityNet||"",vm.districtNet=policyData.districtNet||"",vm.city&&("1"==vm.city.singletonFlag?vm.usCode=vm.city.areaCode:vm.usCode=vm.city.parentAreaCode),vm.staffId=policyData.agentCode||"",vm.staffName=policyData.angentName||"",vm.staffOrgCode=policyData.BkBrchNo||"",vm.isCrossArea="1"==policyData.crossAreaFlag,vm.crossAgree=policyData.crossAgree||"",vm.allWebsite=policyData.allWebsite||"",vm.discount=policyData.discount||"",vm.hasDiscount=policyData.hasDiscount||"",vm.disActivityId=policyData.disActivityId||"",vm.configType=policyData.configType||"",vm.netCode="",vm.showInsureInfo=!1;for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].locate&&vm.insureDataList[i].LiRcgnAddress&&vm.insureDataList[i].LiRcgnZipCode&&(vm.showInsureInfo=!0);if(vm.selectCity=function(index){vm.selectCityCompent=index},vm.parentName="推荐人姓名",vm.parentNum="请输入推荐人工号",vm.parentDescName="请输入推荐人姓名",vm.parentJobNum="推荐人工号",vm.referrNameFlag=0,vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.NEW_SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data){var res=result.data.filter(function(v){return v.prdId==$rootScope.prdId});vm.referrNameFlag=0!=res.length?1:0,console.info(vm.referrNameFlag+"是否显示：推荐人[是][否]"),"1"==vm.referrNameFlag?(vm.mastWirte="必填",vm.isReferShow=1,vm.requiredFlag=!0):vm.isReferShow=0}})},vm.isReferShow=0,vm.mastWirte="必填",vm.referrerCodeChecked=!1,vm.requiredFlag=!0,vm.changeRefer=function(){console.info("渠道"+CONFIG.NEW_SALE_CHANNEL),vm.getSaleChannelPort()},vm.changeRefer(),vm.selectCode=function(val){val&&(vm.referrerCode=val.agentNumber,vm.referrerName=val.name,vm.referrerOrg=val.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0)},vm.productData.salesId&&"827"==vm.productData.newSaleChnl&&(vm.referrNameFlag=1,vm.isReferShow=1,vm.getAgentInformation=function(){var params={salerId:vm.productData.salesId};CommonRequest.request(params,CONFIG.CHANNEL_PERFOR_ASCRIPTION,function(result){1==result.status&&(vm.referrerCode=result.data.salerNum,vm.referrerName=result.data.name,vm.referrerOrg=result.data.managecom,vm.referrerButton=!0)})},vm.getAgentInformation()),$scope.$watch("ankangContact.isCrossArea",function(newValue,oldValue){newValue!==oldValue&&(vm.netCode="")},!0),$scope.$watch("ankangContact.isReferShow",function(newValue){0==newValue&&(vm.referrerCode="",vm.referrerName="",vm.showCodeList=!1,vm.referrerCodeChecked=!1)},!0),$scope.$watch("ankangContact.referrerCode",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$watch("ankangContact.referrerName",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$on("selectAreaName",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status&&0==vm.selectCityCompent){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode.substring(0,4),vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}}),$scope.$on("select-branch-group-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),vm.errorAlert=function(key,val){if("address"==key)1==val.invalid?(vm.addressInvalid=!0,$timeout(function(){vm.addressInvalid=!1},1500)):1==val.length?(vm.addressLen=!0,$timeout(function(){vm.addressLen=!1},1500)):1==val.number&&(vm.addressNum=!0,$timeout(function(){vm.addressNum=!1},1500));else if("zipCode"==key)1==val.invalid&&(vm.zipCodeErr=!0,$timeout(function(){vm.zipCodeErr=!1},1500));else if("yearIncome"==key)1==val.invalid?(vm.yearIncomeErr=!0,$timeout(function(){vm.yearIncomeErr=!1},1500)):1==val.min&&(vm.yearIncomeMin=!0,$timeout(function(){vm.yearIncomeMin=!1},1500));else if("referrerCode"==key)1==val.invalid?(vm.referrerCodeErr=!0,$timeout(function(){vm.referrerCodeErr=!1},1500)):1==val.length&&(vm.referrerCodeLen=!0,$timeout(function(){vm.referrerCodeLen=!1},1500)),console.info("点击了"),1==vm.referrNameFlag&&vm.referrerCode&&CommonRequest.request({agentNo:vm.referrerCode},CONFIG.SELECT_AgentInfo,function(res){if(1==res.status){if("C99"==res.data.agentgrade||!res.data.agentgrade)return void TipService.showMsg("推荐人填写有误，请确认");vm.referrerCodeChecked=!0,vm.referrerName=res.data.name,vm.referrerOrg=res.data.managecom,vm.showCodeList=!1}else vm.referrerCodeChecked=!0,vm.referrerName="",vm.referrerOrg="",vm.showCodeList=!1});else if("referrerName"==key){if(1==val.invalid?(vm.referrerNameErr=!0,$timeout(function(){vm.referrerNameErr=!1},1500)):1==val.length&&(vm.referrerNameLen=!0,$timeout(function(){vm.referrerNameLen=!1},1500)),console.info("referrerName",len),vm.referrerName&&vm.referrerName.length>0){for(var len=0,i=0;i<vm.referrerName.length;i++)vm.referrerName.charCodeAt(i)>255?len+=2:len++;console.info("referrerName",len),len>3?"1"==vm.referrNameFlag&&CommonRequest.request({agentName:vm.referrerName},CONFIG.SELECT_AgentInfoByname,function(res){1==res.status&&res.data&&res.data.length?(vm.showCodeList=!0,vm.referrerCodeList=res.data):(vm.showCodeList=!1,vm.referrerCodeList=[])}):vm.showCodeList=!1}}else"atSchool"==key?1==val.invalid&&(vm.atSchoolError=!0,$timeout(function(){vm.atSchoolError=!1},1500)):"atClass"==key&&1==val.invalid&&(vm.atClassError=!0,$timeout(function(){vm.atClassError=!1},1500))},vm.districtLevel1=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.provinces=result,vm.provinceList=[],vm.gudgeIsLocation){for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaName.indexOf(vm.gudgeIsLocation)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return void positionError()}else{for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaCode.indexOf(vm.provinceCode)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return}vm.districtLevel2(vm.provinceList)})},vm.districtLevel2=function(area){var config={url:"../statics/product/areas/"+vm.prdId+"/"+area[0].areaCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:area[0].areaCode,areaLevel:2};CommonRequest.request(paramsl,config,function(result){if(vm.cities=result,vm.cityList=[],vm.gudgeCity){if(vm.cityList=vm.cities,""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.cities.length;i++)-1!=vm.cities[i].areaCode.indexOf(vm.cityCode)&&vm.cityList.push(vm.cities[i]);if(""==vm.cityList)return}vm.districtLevel3(vm.provinceList,vm.cityList)})},vm.districtLevel3=function(area1,area2){var params={prdId:vm.prdId,parentAreaCode:area2[0].areaCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+area1[0].areaCode+"/"+area2[0].areaCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.areass=result,vm.districtList=[],vm.gudgeDistrict){for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaName.indexOf(vm.gudgeDistrict)&&vm.districtList.push(vm.areass[i]);if(""==vm.districtList)return void positionError();if(!vm.districtList[0].parentAreaCode)return void positionError();vm.cityListLast=[];for(var i=0;i<vm.cityList.length;i++)-1!=vm.cityList[i].areaCode.indexOf(vm.districtList[0].parentAreaCode)&&vm.cityListLast.push(vm.cityList[i]);if(vm.cityList=vm.cityListLast[0],""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaCode.indexOf(vm.districtCode)&&vm.districtList.push(vm.areass[i]);if(vm.cityList=vm.cityList[0],""==vm.districtList)return}if(vm.provinceList=vm.provinceList[0],vm.districtList=vm.districtList[0],vm.locate=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.province=vm.provinceList,vm.city=vm.cityList,vm.district=vm.districtList,vm.gudgeDistrict?vm.address=vm.dataLocation.street+vm.dataLocation.streetNumber:vm.address=vm.locationNew,vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status&&0==vm.selectCityCompent){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode.substring(0,4),vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}})},vm.queryPolicyAddress=function(){var addressParam={cusId:vm.userData.cusId,role:"1",contType:"0",queryType:"0"};CommonRequest.request(addressParam,CONFIG.QUERY_POLICY_ADDRESS,function(result){result&&"1"==result.status&&"您暂时没有保单"!=result.data&&(vm.areaNew=result.data.appProvince+result.data.appCity+result.data.appCounty,vm.locationNew=result.data.appPostalAddress,vm.provinceCode=result.data.insuredHomeProvinceCode,vm.cityCode=result.data.insuredHomeCityCode,vm.districtCode=result.data.insuredHomeAreaCode,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.provinceCode))})},vm.userData.cusId){var ocrConfig={url:"../statics/json/ocrSwitchBusinessOptimizer.json",method:"GET"};CommonRequest.request({},ocrConfig,function(result){vm.base64imgSwitch=result["static"],"Y"==vm.base64imgSwitch&&vm.queryPolicyAddress()})}vm.getPosition=function(){vm.selectCityCompent=0;var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){}})}),wx.error(function(res){positionError()})}})},$scope.$watch("{locate:ankangContact.locate,address:ankangContact.address,emailCode:ankangContact.emailCode}",function(newValue,oldValue){newValue!=oldValue&&angular.forEach(newValue,function(value,key){if(""!=value)for(var i=vm.insureDataList.length-1;i>=0;i--)"address"==key&&(vm.insureDataList[i].LiRcgnAddress=value),"locate"==key&&(vm.insureDataList[i].locate=value),"emailCode"==key&&(vm.insureDataList[i].LiRcgnZipCode=value);newValue.locate&&newValue.address&&newValue.emailCode&&(vm.showInsureInfo=!0)})},!0),vm.next=function(invalid){if(vm.referrerCodeChecked||1!=vm.isReferShow)vm.operation(invalid);else var timer=$timeout(function(){vm.operation(invalid),$timeout.cancel(timer)},800)},vm.operation=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(0==vm.isReferShow&&(vm.referrerCode="",vm.referrerName=""),!(1!=vm.isReferShow||vm.referrerName&&vm.referrerCode))return void TipService.showMsg("请填写推荐人工号或推荐人姓名");if(vm.referrerCode&&"1"==vm.referrNameFlag){if(vm.isCrossArea)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！");if(vm.staffOrgCode!=vm.referrerOrg)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！")}if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.provinceNet&&vm.cityNet&&vm.districtNet){var provinceName=vm.provinceNet.netName?vm.provinceNet.netName:"",cityName=vm.cityNet.netName?"-"+vm.cityNet.netName:"",districtName=vm.districtNet.netName?"-"+vm.districtNet.netName:"";vm.allWebsite=provinceName+cityName+districtName}vm.checkNetcode=function(){$timeout(function(){if(vm.provinceNet.netCode){$ionicLoading.hide();var data={agentCode:vm.staffId,angentName:vm.staffName,BkBrchNo:vm.staffOrgCode,PbHoldAddr:vm.province.areaCode+","+vm.city.areaCode,PbHoldAddress:vm.address,PbHoldZipCode:vm.emailCode,PbWebsiteCode:vm.netCode||"",PbWebsiteName:vm.districtNet.netName||"",PbOtherProvinceCode:vm.isCrossArea?vm.province.areaCode:"",bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||"",districtCode:vm.province?vm.province.areaCode:"",liveProvince:vm.province?vm.province.areaName:"",liveDistrict:vm.city?vm.city.areaName:"",allWebsite:vm.allWebsite,referrerCode:vm.referrerCode,referrerName:vm.referrerName,PlchdProvCd:vm.province.areaCode,PlchdCityCd:vm.city.areaCode,PlchdDstcCd:vm.district.areaCode,liveDstc:vm.district.areaName||"",crossAreaFlag:vm.isCrossArea?"1":"0",locate:vm.locate,branch:vm.branch,crossAgree:vm.crossAgree,province:vm.province||"",city:vm.city||"",district:vm.district||"",provinceNet:vm.provinceNet||"",cityNet:vm.cityNet||"",districtNet:vm.districtNet||"",insSaleChlType:vm.insSaleChlType};"Y"!=vm.productData.basicProfile.P021&&(data=angular.extend(data,{PbWebsiteCode:vm.districtNet.netCode||"",PbWebsiteName:vm.districtNet.netName||"",bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||""})),GroupPolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),GroupPolicyService.control({state:"product-purchase-group-policy-contact",control:"data",data:data}),$state.go("product-ankang-agreement")}else vm.checkNetcode()},100)},vm.checkNetcode()}}angular.module("app").controller("AnkangContactController",AnkangContactController),AnkangContactController.$inject=["$state","CommonRequest","CONFIG","GroupPolicyService","$scope","$rootScope","$ionicLoading","$timeout","$ionicPopup","TipService"]}(),function(){function JiankangController($state,$sce,VALIDATION,$document,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,$ionicPopup,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicModal,COMMON,$http){var vm=this;vm.close=function(){history.go(-1)},vm.leftClick=function(){$state.go("product-ankang-yewuyuan")},vm.rightClick=function(){$state.go("product-purchase-ankang-optimze")}}angular.module("app").controller("JiankangController",JiankangController),JiankangController.$inject=["$state","$sce","VALIDATION","$document","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$ionicPopup","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicModal","COMMON","$http"]}(),function(){function AnkangNoticeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,GroupPolicyService,CommonRequest,$ionicPopup,$timeout,PolicyService,$ionicModal,$ionicLoading){var vm=this,sessionData=GroupPolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.noticeChecked=!0,!vm.productData)return void $state.go("tab.mall");if(vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.provinceCode=vm.policyData.PlchdProvCd||"",vm.showAgree=!1,vm.policyData.LiRcgnList.forEach(function(item){var birthday=VALIDATION.getBirthday(item.LiRcgnId),age=VALIDATION.getAgeByBirth(birthday);age>=18&&(vm.showAgree=!0)}),vm.PbInsuExp=vm.insureData.PbInsuExp,vm.healthTag=vm.policyData.healthTag||"",vm.agree=vm.policyData.agree||"",vm.materials=[],vm.allRead=!0,vm.productData.materials&&vm.productData.materials.length>0)for(var i=0;i<vm.productData.materials.length;i++){var ma=vm.productData.materials[i];if(ma&&"M6"!=ma.materialType){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc},material=[];CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status&&(material=result.data,material&&material.length>0)){for(var j=0;j<material.length;j++)material[j].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[j].materialPath,material[j].isRead=!1,vm.materials.push(material[j]);if(vm.materials&&vm.materials.length>0){var arr=vm.materials.filter(function(item){return item.areaCode&&item.areaCode==vm.provinceCode});arr.length>0?vm.materials=vm.materials.filter(function(item){return!item.areaCode||item.areaCode==vm.provinceCode}):vm.materials=vm.materials.filter(function(item){return!item.areaCode||"all"==item.areaCode})}vm.allRead=!1}})}}vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};GroupPolicyService.getMaterialDetailOpen(params)}},vm.tabList=["相关条款"],vm.productData.hotTip&&vm.productData.hotTip.length>0&&vm.tabList.push("特别提示"),vm.productData.exoneration&&vm.productData.exoneration.length>0&&vm.tabList.push("责任免除"),vm.submitIdx=0,vm.goRead=function(ma,index){vm.MaterialIndex=index,vm.showMaterialModal()},vm.showMaterialModal=function(ma,index){var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/product-purchase/product-purchase-info/policy-notice/popup/material.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.nowRead=vm.MaterialIndex+1,self.allNeadRead=vm.materials.length,self.activeMaterial=vm.materials[vm.MaterialIndex],self.materialUrl=vm.materials[vm.MaterialIndex].materialPath,self.hasMaterialCanvans=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(console.info(65465456465),self.hasMaterialCanvans=!0,$ionicLoading.hide(),vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){console.info(e),self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){vm.materials[vm.MaterialIndex].isRead=!0,vm.allRead=vm.materials.every(function(arr){return arr.isRead}),self.modal.remove(),vm.allRead||(vm.MaterialIndex++,vm.MaterialIndex>vm.materials.length-1&&(vm.MaterialIndex=0),vm.showMaterialModal())}})},vm.dataCheck=function(){return"0"!=vm.healthTag?(TipService.showMsg($rootScope.TIPS.PRODUCT.HEALTHY_INVALID),!1):!0},vm.getPolicyData=function(){var autoRnwCvInd;autoRnwCvInd="Y"==vm.productData.basicProfile.P021?vm.policyData.isBatts:"Y"==vm.productData.basicProfile.P010?"1":"0";for(var insuredLsit=[{rcgnNm:vm.policyData.PbHoldName,rcgnGndCd:vm.policyData.PbHoldSex,rcgnBrthDt:vm.policyData.PbHoldBirdy,rcgnCrdtTpCd:vm.policyData.PbHoldIdType,rcgnCrdtNo:vm.policyData.PbHoldId,rcgnExpirationType:vm.policyData.PbHoldExpireType,rcgnCrdtExpDt:vm.policyData.PbIdEndDate||"20991231",rcgnNatCd:vm.policyData.PbNationality,rcgnCommAdr:vm.policyData.PbHoldAddress,rcgnZipECD:vm.policyData.PbHoldZipCode,rcgnMoveTelNo:vm.policyData.PbHoldMobl,rcgnOcpCd:vm.policyData.PbHoldOccupCode,insuredSSflag:vm.policyData.PbHoldMedic,insuredAppntRela:"01",cvrNum:"1",busiList:vm.insureData.insuredList[0].busiList}],i=0;i<vm.policyData.LiRcgnList.length;i++)insuredLsit.push({rcgnNm:vm.policyData.LiRcgnList[i].LiRcgnName,rcgnGndCd:vm.policyData.LiRcgnList[i].LiRcgnSex,rcgnBrthDt:vm.policyData.LiRcgnList[i].LiRcgnBirdy,rcgnCrdtTpCd:vm.policyData.LiRcgnList[i].LiRcgnIdType,rcgnCrdtNo:vm.policyData.LiRcgnList[i].LiRcgnId,rcgnExpirationType:vm.policyData.LiRcgnList[i].LiRcgnExpireType,rcgnCrdtExpDt:vm.policyData.LiRcgnList[i].LiIdEndDate||"20991231",rcgnNatCd:vm.policyData.LiRcgnList[i].LiNationality,rcgnCommAdr:vm.policyData.LiRcgnList[i].LiRcgnAddress,rcgnZipECD:vm.policyData.LiRcgnList[i].LiRcgnZipCode,rcgnMoveTelNo:vm.policyData.LiRcgnList[i].LiRcgnMobl,rcgnOcpCd:vm.policyData.LiRcgnList[i].LiRcgnOccupCode,insuredSSflag:vm.policyData.LiRcgnList[i].LiRcgnMedic,insuredAppntRela:vm.policyData.LiRcgnList[i].confirmRela,cvrNum:"1",busiList:vm.insureData.insuredList[i+1].busiList});var params={realTotalPremium:vm.policyData.totalInsCvr,paymentCode:vm.productData.payment_type,payAge:vm.policyData.insPyfPrdNum,payAgeUnit:vm.productData.payTypeConfigs.payAgeUnit,insuredNum:vm.insureData.insuredList.length,insBlPrtNo:vm.PbApplNo[0],sellTypeDetail:CONFIG.SALE_CHANNEL,CCBInsID:vm.policyData.BkBrchNo,lv1BrNo:vm.policyData.bankCodeLV1,orderCode:vm.productData.orderCode,channelCode:CONFIG.SALE_CHANNEL,orgCode:vm.policyData.BkBrchNo,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P007?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.prdSaleCode,prdId:vm.productData.prd_id,planId:vm.insureData.plans.planId,planCode:vm.insureData.plans.planCode,planName:vm.insureData.plans.planName,districtCodeP:vm.policyData.PlchdProvCd,districtCode:vm.policyData.PlchdCityCd,districtCodeD:vm.policyData.PlchdDstcCd},checkPolicyGroupApp={insFuncFlag:"GDDC",upgradeFlag:vm.policyData.isGhmbUpdate?"1":"0",plchdNm:vm.policyData.PbHoldName,plchdGndCd:vm.policyData.PbHoldSex,plchdBrthDt:vm.policyData.PbHoldBirdy,plchdCrdtTpCd:vm.policyData.PbHoldIdType,plchdCrdtNo:vm.policyData.PbHoldId,expirationType:vm.policyData.PbHoldExpireType,plchdCrdtExpDt:vm.policyData.PbIdEndDate||"20991231",plchdNatCd:vm.policyData.PbNationality,plchdCommAdr:vm.policyData.PbHoldAddress,plchdZipECD:vm.policyData.PbHoldZipCode,plchdMoveTelNo:vm.policyData.PbHoldMobl,plchdEmailAdr:vm.policyData.PbHoldEmail,plchdOcpCd:vm.policyData.PbHoldOccupCode,plchdYrIncmAm:vm.policyData.PbHoldAmount,rsdntTpCd:vm.policyData.PbHoldDistrict,appntSsflag:vm.policyData.PbHoldMedic,insuredNum:vm.insureData.insuredList.length,insBlPrtNo:vm.PbApplNo[0],ntfItmInd:"0",dsptPcsgMtdCd:vm.policyData.PiZyzcfs,dsptArbtrInstNm:vm.policyData.PiZcinst,cCBInsID:vm.policyData.BkBrchNo,lv1BrNo:vm.policyData.bankCodeLV1,bONm:vm.policyData.allWebsite,bOSaleStffNm:vm.policyData.angentName,bOSaleStffID:vm.policyData.agentCode,plchdProvCd:vm.policyData.districtCode,plchdCityCd:vm.policyData.PlchdCityCd,plchdCntyAndDstcCd:vm.policyData.PlchdDstcCd,specAuditFlag:"Y"==vm.productData.basicProfile.P004?"1":"0",
insRecommendId:vm.policyData.referrerCode,insRecommendNm:vm.policyData.referrerName,insSaleId:vm.policyData.agentCode,insSaleNm:vm.policyData.angentName,insSaleGrp:vm.policyData.BkBrchNo,insuredList:insuredLsit,insPyfPrdNum:vm.policyData.insPyfPrdNum,crsPolicyType:vm.policyData.crsData.citizenType,crsPolicyFstNm:vm.policyData.crsData.surname,crsPolicySecNm:vm.policyData.crsData.secondName,crsPolicyBirth:vm.policyData.PbHoldBirdyDate,crsPolicyCoun:"CHN",crsPolicyProv:vm.policyData.crsData.liveProvince,crsPolicyCity:vm.policyData.crsData.liveDistrict,crsPolicyAddr:vm.policyData.PbHoldAddress,crsPolicyBirCoun:"CHN",crsPolicyBirProv:vm.policyData.crsData.birthProvinceCont,crsPolicyBirCity:vm.policyData.crsData.birthDistrictCont,crsPolicyBirAddr:vm.policyData.crsData.birthDetailAdr,taxList:vm.policyData.crsData.taxList};return params.accBankCode=vm.policyData.BankCode,checkPolicyGroupApp=angular.extend(checkPolicyGroupApp,{plchdAccID:vm.policyData.BankCode,plchdAccNm:vm.policyData.PbHoldName,insSaleChlType:vm.policyData.insSaleChlType,plchdAccNo:vm.policyData.plchdAccNo,plchdAccBankNm:vm.policyData.plchdAccBankNm}),params.checkPolicyGroupApp=checkPolicyGroupApp,vm.policyData.crsData&&(params=angular.extend(params,vm.policyData.crsData)),params},vm.checkPolicy=function(){var policyData=vm.getPolicyData();policyData&&(GroupPolicyService.setSessionData({policyData:{healthTag:vm.healthTag,agree:vm.agree}}),GroupPolicyService.control({state:"product-ankang-notice",control:"data",data:policyData}),GroupPolicyService.control({state:"product-ankang-notice",control:"process"}))},vm.submit=function(){return vm.submitIdx<vm.tabList.length-1?void vm.submitIdx++:(vm.healthTag="0",void("Y"!=vm.productData.basicProfile.P028?vm.process():vm.showAgree?($rootScope.showAgreeModal=!0,$ionicPopup.show({template:"<p>被保险人已同意本次投保，并已认可本次投保的保险金额</p>",buttons:[{text:"否",onTap:function(e){$rootScope.showAgreeModal=!1}},{text:"是",type:"button-positive",onTap:function(e){$rootScope.showAgreeModal=!1,vm.process()}}]})):vm.process()))},vm.process=function(){return vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout?(TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall")):void GroupPolicyService.createPbApplNo(vm.policyData.BkBrchNo,function(pbApplNoList){vm.PbApplNo=pbApplNoList,vm.checkPolicy()})}}angular.module("app").controller("AnkangNoticeController",AnkangNoticeController),AnkangNoticeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","GroupPolicyService","CommonRequest","$ionicPopup","$timeout","PolicyService","$ionicModal","$ionicLoading"]}(),function(){function OtherinfoController($scope,$state){var vm=this;vm.kid=$state.params.kid,vm.prdid=$state.params.prdid,vm.close=function(){$state.go("product-ankang-info",{id:vm.prdid})}}angular.module("app").controller("OtherinfoController",OtherinfoController),OtherinfoController.$inject=["$scope","$state"]}(),function(){function YewuyuanController($state,$sce,VALIDATION,$document,$ionicLoading,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,$ionicPopup,PolicyService,TipService,$timeout,$filter,$ionicScrollDelegate,$anchorScroll,$interval,$ionicModal,COMMON,$http){var vm=this,sessionData=PolicyService.getSessionData(),userData=sessionData.userData,productData=sessionData.productData;$scope.prdId=productData.prd_id,vm.userName=userData.customerName||"",vm.userId="A"==userData.cretType?userData.cretNo:"",vm.userPhone=userData.phoneNo||"",vm.name=userData.customerName||"",vm.phone=userData.phoneNo||"",vm.Id="A"==userData.cretType?userData.cretNo:"",vm.area="",vm.close=function(){history.go(-1)},vm.submit=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);var params={plchdNm:vm.name,plArea:vm.area,plPhone:vm.phone,flag:"0",plcretNo:vm.Id,errorMessage:"健康告知不通过"};CommonRequest.request(params,CONFIG.SEND_JK_EMAIL,function(result){1==result.status&&$state.go("product-ankang-info",{id:$scope.prdId})})}}angular.module("app").controller("YewuyuanController",YewuyuanController),YewuyuanController.$inject=["$state","$sce","VALIDATION","$document","$ionicLoading","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$ionicPopup","PolicyService","TipService","$timeout","$filter","$ionicScrollDelegate","$anchorScroll","$interval","$ionicModal","COMMON","$http"]}(),function(){function AnkangOptimzeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,CommonRequest,$ionicPopup,$timeout,GroupPolicyService,$ionicLoading){var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.a=[["99","请选择","请选择"],[0,"趸缴",65],[3,"3年交",60],[5,"5年交",60],[10,"10年交",55],[20,"20年交",45]],vm.ls=[];var tt=0;vm.newTotalInsCvr=0,vm.insPyfPrdNum=99,vm.insureData&&(vm.insPyfPrdNum=vm.insureData.insPyfPrdNum||"99"),$scope.$watch("ankangOptimze.insPyfPrdNum",function(newValue){vm.secList.forEach(function(item){item.insCvr=0}),vm.newTotalInsCvr=0,tt=0,GroupPolicyService.setSessionData({insureData:{insPyfPrdNum:newValue}})}),$timeout(function(){if(sessionData.policyData&&sessionData.policyData.LiRcgnList)for(var i=0;i<sessionData.policyData.LiRcgnList.length;i++)vm.ls.push(sessionData.policyData.LiRcgnList[i].be)},0),vm.planType="1",vm.insureData&&(vm.planType=vm.insureData.planType||""),$rootScope.policyholderInfoList=!1,vm.priChecked=vm.policyData.priChecked||!1;var jobcodes=COMMON.getCommonData().OCCUPATION_CODE;if(vm.checkLiRcgnOccupCode=function(data){for(var j=0;j<jobcodes.length;j++)if(data==jobcodes[j].value)return!0},vm.priChecked)vm.showHolderMsg=1;else if($rootScope.isLogin){vm.policyData.PbHoldBirdy&&vm.policyData.PbHoldEmail&&vm.policyData.PbHoldId&&vm.policyData.PbHoldMedic&&vm.policyData.PbHoldMobl&&vm.policyData.PbHoldName&&vm.policyData.PbHoldOccupCode&&vm.policyData.PbHoldSex&&vm.policyData.PbIdEndDate&&vm.policyData.yearIncome&&vm.policyData.livePlace?vm.checkLiRcgnOccupCode(vm.policyData.PbHoldOccupCode)?(vm.showHolderMsg=1,vm.priChecked=!0):(vm.showHolderMsg=2,GroupPolicyService.setSessionData({policyData:{PbHoldOccupCode:""}})):vm.showHolderMsg=2;var certExpireType="2";"20991231"==vm.policyData.PbIdEndDate&&(certExpireType="1"),GroupPolicyService.setSessionData({policyData:{certExpireType:certExpireType}})}else vm.showHolderMsg=3;vm.userData=sessionData.userData||{},vm.policyData.PbHoldName||vm.policyData.PbHoldId?($rootScope.policyholderInfoList=!0,vm.PbHoldIdShow=!0,vm.customerName=vm.policyData.PbHoldName,vm.cretNo=vm.policyData.PbHoldId,vm.policyData.firstbe&&(vm.firstbe=vm.policyData.firstbe)):$rootScope.isLogin&&(""==vm.userData.customerName&&""==vm.userData.cretNo||($rootScope.policyholderInfoList=!0,vm.PbHoldIdShow=!0,vm.customerName=vm.userData.customerName,vm.cretNo="A"==vm.userData.cretType?vm.userData.cretNo:"",vm.userData.firstbe&&(vm.firstbe=vm.userData.firstbe))),vm.insureDataList=vm.policyData.LiRcgnList||"",vm.canNext=!1,$scope.$watch("ankangOptimze.insureDataList",function(newValue){for(var count=0,j=0;j<=vm.insureDataList.length-1;j++)vm.insureDataList[j].insureChecked&&count++;count>1?vm.canNext=!0:vm.canNext=!1}),""==vm.insureDataList&&(vm.insureDataList=[{id:1,confirmRela:"",LiNationality:"0156",LiRcgnName:"",trashShow:!1,LiRcgnMedic:"",LiRcgnIdType:"",LiRcgnId:"",LiRcgnBirdy:"",LiRcgnMobl:"",LiRcgnSex:"",LiRcgnOccupCode:"",LiRcgnExpireType:"",insureIsLong:"",LiIdEndDate:"",insureChecked:!1},{id:2,confirmRela:"",LiNationality:"0156",LiRcgnName:"",trashShow:!1,LiRcgnMedic:"",LiRcgnIdType:"",LiRcgnId:"",LiRcgnBirdy:"",LiRcgnMobl:"",LiRcgnSex:"",LiRcgnOccupCode:"",LiRcgnExpireType:"",insureIsLong:"",LiIdEndDate:"",insureChecked:!1}]);for(var i=vm.insureDataList.length-1;i>=0;i--){var tempPolicyUser=vm.insureDataList[i];""==tempPolicyUser.confirmRela&&""==tempPolicyUser.LiRcgnMedic&&""==tempPolicyUser.LiRcgnId?tempPolicyUser.insureInfoList=!1:tempPolicyUser.insureInfoList=!0}if(vm.hide=function(){vm.insureAmountErr=!1},vm.getQuestionMore=function(){vm.proFotterShow=!0},vm.getQuestionMoreClose=function(){vm.proFotterShow=!1},vm.choosePlan=function(plan){vm.planType=plan,"1"==plan?(vm.planOneImg=!0,vm.planTwoImg=!1):(vm.planOneImg=!1,vm.planTwoImg=!0)},vm.priInfo={isMedic:"",securityAge:""},vm.secList=[{id:1,trashShow:!1,secIsShow:!1,securityAge:"",isMedic:"",disabled:null},{id:2,trashShow:!1,secIsShow:!1,securityAge:"",isMedic:"",disabled:null}],vm.insureDataList.length>2)for(var i=0;i<vm.insureDataList.length-2;i++)vm.secList.push({id:i+3,trashShow:!1,secIsShow:!1,securityAge:"",isMedic:"",disabled:null});vm.secInfo=[{id:1,securityAge:"",isMedic:""},{id:2,securityAge:"",isMedic:""}],$scope.$watch("ankangOptimze.insureDataList.length",function(newValue){if(newValue>2)for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].trashShow=!0;else for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].trashShow=!1},!0),vm.jumpToHolderPage=function(){$state.go("product-purchase-ankang-policyholder")},vm.jumpOptimzeRecognizee=function(LiRcgnCode){GroupPolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList,selectedInsure:LiRcgnCode}}),$state.go("product-purchase-ankang-recognizee")},vm.add=function(){var id=vm.insureDataList.length;GroupPolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList,selectedInsure:id}}),$state.go("product-purchase-ankang-recognizee")},vm.dataCheck=function(){var age=VALIDATION.getAgeByBirth(vm.birthday);if(age>vm.maxHolderAge||age<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+vm.maxHolderAge+"周岁"),!1;var insureAge="01"==vm.confirmRela?age:VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);return insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1):vm.insureGenderChanged||vm.insureBirthdayChanged?(vm.calc&&vm.calcCtrl?("HMRA"==vm.productData.templateCode||"TLD"==vm.productData.templateCode||"BANO"==vm.productData.templateCode?angular.extend(vm.calcCtrl.user,{sex:vm.LiRcgnSex,birthday:vm.LiRcgnBirdy,birthdayfm:$filter("date")(vm.LiRcgnBirdy,"yyyyMMdd"),payendyear:vm.insureData.payendyear}):angular.extend(vm.calcCtrl.user,{sex:vm.LiRcgnSex,birthday:vm.LiRcgnBirdy,payendyear:vm.insureData.payendyear}),angular.extend(vm.calcCtrl.mainPlan,{amount:vm.insureData.mainPlan.amount}),vm.calc(vm.calcCtrl,function(recalcData){recalcData&&(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,recalcData.exp&&(vm.insureData.PbInsuExp!=recalcData.exp?(vm.insureData.PbInsuExp=recalcData.exp,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+recalcData.exp+"</span>元")):vm.insureData.PbInsuAmt!=recalcData.mainPlan.amount?(vm.insureData.PbInsuAmt=recalcData.mainPlan.amount,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED_AMOUNT+'<span class="fs20 orange">'+recalcData.mainPlan.amount+"</span>元")):vm.next()),recalcData.amount&&(vm.insureData.PbInsuAmt=recalcData.amount),recalcData.mainPlan&&(vm.insureData.mainPlan=recalcData.mainPlan),recalcData.addPlan&&(vm.insureData.addPlan=recalcData.addPlan))})):(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,vm.next()),!1):!0},vm.getPremiumRateGroupCoreResultTimes=0,vm.getPremiumRateGroupCoreResult=function(flowNo,callback){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremiumRateGroupCoreResultTimes++,vm.getPremiumRateGroupCoreResultTimes>CONFIG.GROUP_CORE_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg("系统繁忙,请稍后重试"),void(vm.getPremiumRateGroupCoreResultTimes=0);var params={flowNo4Trial:flowNo};CommonRequest.request(params,CONFIG.GHMB_GET_PREMIUM_RATE_GROUP_CORE_RESULT,function(result){if(1==result.status){var data=result.data||"";if(""==data)return void $timeout(function(){vm.getPremiumRateGroupCoreResult(flowNo,callback)},CONFIG.GROUP_CORE_DECOUPLING_DURATION);if($ionicLoading.hide(),"保费测算成功"==data.respDesc)for(var i=0;i<data.rcgnList.length;i++)tt+=Number(data.rcgnList[i].insPrem);vm.newTotalInsCvr=tt.toFixed(2),vm.totalInsCvr=tt.toFixed(2);var a=JSON.parse(window.sessionStorage.getItem("elife-policyData"));if(a.totalInsCvr=tt.toFixed(2),console.table(a),a=JSON.stringify(a),$timeout(function(){window.sessionStorage.removeItem("elife-policyData"),window.sessionStorage.setItem("elife-policyData",a),console.table(JSON.parse(window.sessionStorage.getItem("elife-policyData")))},0),vm.getPremiumRateGroupCoreResultTimes=0,"00000"!=data.respCode)return void TipService.showMsg(data.respDesc);var orderCode=data.orderCode;orderCode&&GroupPolicyService.setSessionData({productData:{orderCode:orderCode}}),GroupPolicyService.setSessionData({policyData:{totalPolicyMount:data.totalInsCvr}}),vm.insCvr=data.rcgnList[0].insPrem;for(var i=1;i<data.rcgnList.length;i++)vm.secList[i-1].insCvr=data.rcgnList[i].insPrem;vm.totalInsCvr=data.totalInsCvr,vm.nextStep=!0,callback()}else $ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0},!0)};var params,insuredCalcList=[],plans=[];vm.submitAccount=function(callback){plans=vm.productData.plans[0],insuredCalcList=[{rcgnNm:"0",rcgnBrthDt:vm.policyData.PbHoldBirdy,insuredSSflag:vm.policyData.PbHoldMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode,cvrNm:vm.productData.prd_title}]}];for(var i=0;i<vm.insureDataList.length;i++)vm.insureDataList[i].insureChecked&&(insuredCalcList.push({rcgnNm:vm.insureDataList[i].id.toString(),rcgnBrthDt:vm.insureDataList[i].LiRcgnBirdy,insuredSSflag:vm.insureDataList[i].LiRcgnMedic,insuredAppntRela:vm.insureDataList[i].confirmRela,cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode,cvrNm:vm.productData.prd_title}]}),insuredCalcList[i+1].busiList[0].cvrID="GDDC11",insuredCalcList[i+1].rcgnGndCd=Number(sessionData.policyData.LiRcgnList[i].LiRcgnSex)-1+"",insuredCalcList[i+1].busiList[0].insCvr=sessionData.policyData.LiRcgnList[i].be+"",window.localStorage.setItem("be"+i,sessionData.policyData.LiRcgnList[i].be+""));insuredCalcList[0].busiList[0].cvrID="GDDC11",insuredCalcList[0].rcgnGndCd=Number(sessionData.policyData.PbHoldSex)-1+"",insuredCalcList[0].busiList[0].insCvr=vm.firstbe+"",window.localStorage.setItem("firstbe",vm.firstbe),params={premiumAppEntity:{plchdBrthDt:vm.policyData.PbHoldBirdy,appntSsflag:"1",insuredNum:insuredCalcList.length,insuredList:insuredCalcList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL};var y;y="1"===vm.insPyfPrdNum?"0":vm.insPyfPrdNum;var insPyfPrdNum={insPyfPrdNum:y};angular.merge(params.premiumAppEntity,insPyfPrdNum),angular.merge(params.premiumAppEntity,{insFuncFlag:"GDDC"}),GroupPolicyService.setSessionData({insureData:{insuredList:insuredCalcList}}),CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(result.data,callback)})},vm.next=function(){if(vm.dataCheck()){for(var insureCompleteNumber=0,i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked&&insureCompleteNumber++}if(vm.insureDataList.length<2){vm.insureAmountErr||(vm.insureAmountErr=!0);var timer=$timeout(function(){vm.insureAmountErr&&(vm.insureAmountErr=!1),$timeout.cancel(timer)},3e3)}else{if(2>insureCompleteNumber)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(!vm.priChecked)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.insureDataList.length<2)return void(vm.insureAmountErr=!0);for(var i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked||vm.insureDataList.splice(i,1)}GroupPolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),vm.choosePlanObj={insuredAmount:vm.newTotalInsCvr,planCode:"GDDC11"},GroupPolicyService.setSessionData({insureData:{plans:vm.choosePlanObj}}),GroupPolicyService.setSessionData({policyData:{totalInsCvr:vm.totalInsCvr||tt,PbHoldDistrict:vm.policyData.livePlace,PbHoldExpireType:vm.policyData.certExpireType,insPyfPrdNum:vm.insPyfPrdNum}}),$state.go("product-ankang-contact")}}},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if("99"===vm.insPyfPrdNum)return void TipService.showMsg("缴费方式不能为空");if(vm.priChecked){vm.insCompleNum=0;for(var i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked&&vm.insCompleNum++}vm.insCompleNum<2||vm.submitAccount(function(){if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";"01"==vm.confirmRela&&"0156"==vm.nationality?(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")},GroupPolicyService.setSessionData({userData:{customerName:vm.name}})):"01"!=vm.confirmRela&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}:"01"!=vm.confirmRela&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.LiRcgnIdType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.LiRcgnName}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}:"01"!=vm.confirmRela&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.LiRcgnIdType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.LiRcgnName}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}),(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002&&CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1):TipService.showMsg(result.data.checkDescription))})})}},vm.checkLimit=function(){return 10*Number(vm.policyData.yearIncome)<vm.insureData.PbInsuAmt?(TipService.showMsg("累计保额不得查过保费的10倍","errorAlert",3e3),!1):!0}}angular.module("app").controller("AnkangOptimzeController",AnkangOptimzeController),AnkangOptimzeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","CommonRequest","$ionicPopup","$timeout","GroupPolicyService","$ionicLoading"]}(),function(){function AnkangPolicyholderController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout){function getIndex(arr,str){for(var index=-1,i=0;i<arr.length;i++)arr[i].value===str&&(index=i);return index}var vm=this,x1=/^\+?[1-9][0-9]*$/;vm.flag=!0,vm.zd=!0,vm.errorMsg="输入的金额必须大于等于10000并且是1000的整数倍",vm.ischeckAge="";var sessionData=PolicyService.getSessionData();vm.insPyfPrdNum=sessionData.insureData.insPyfPrdNum,vm.ionicGoBack=$scope.$ionicGoBack,$scope.$ionicGoBack=function(){$state.params.arg.flag&&window.localStorage.setItem("huifu",$state.params.arg.flag),vm.ionicGoBack()},window.sessionStorage.getItem("elife-policyData")?(vm.be=JSON.parse(window.sessionStorage.getItem("elife-policyData")).firstbe,vm.be||(vm.zd=!1)):vm.be=1e4,vm.reduce=function(e){return vm.be<=1e4?void(vm.be=1e4):void(vm.be=Number($.trim(vm.be))-1e3)},vm.add2=function(e){vm.be=Number($.trim(vm.be))+1e3},vm.timer=null,$scope.$watch("ankangPolicyholder.be",function(n){vm.timer&&(vm.showError=!1,$timeout.cancel(vm.timer)),vm.zd?n>=1e4&&x1.test(n/1e3)||(vm.showError=!0,vm.timer=$timeout(function(){vm.showError=!1,vm.be=1e4},3e3)):(vm.zd=!0,vm.be=1e4)}),vm.checkMoney=function(money){1e6>money?(vm.age&&vm.age<18&&vm.be>5e5&&TipService.showMsg("未成年人最高保额为50万"),vm.be>5e5&&vm.occupationData&&("R0052"==vm.occupationData||"R0053"==vm.occupationData||"R0054"==vm.occupationData||"R0055"==vm.occupationData)&&TipService.showMsg("学龄前儿童、学生、离退休人员及无业人员，最高保额为50万。")):TipService.showMsg("最高保额为100万")},vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.isGhmbUpdate=vm.policyData.isGhmbUpdate||!1,vm.certType="A",vm.PbHoldMedic=vm.policyData.PbHoldMedic||"",vm.livePlace=vm.policyData.livePlace||"",vm.yearIncome=vm.policyData.yearIncome||"",vm.yearIncomeShow=!0,vm.checkCusId=!0,vm.checkInCusld=!1,vm.calc=vm.insureData.calc?eval("("+vm.insureData.calc+")"):null,vm.calcCtrl=vm.insureData.calcCtrl||null,vm.userData=sessionData.userData||{},vm.minHolderAge=vm.insureData.minHolderAge,vm.maxHolderAge=vm.insureData.maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.minAge=vm.insureData.minAge,vm.maxAge=vm.insureData.maxAge,vm.insureStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.insureEndDate=VALIDATION.getDateByAge(vm.minAge),vm.init=function(){if(vm.relationDisabled=!1,vm.PbInsuExp=vm.insureData.PbInsuExp,vm.nationality="0156",vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certType="A",vm.certTypeDisabled=!1,vm.nationalityDisabled=!1,vm.certTypes=[],vm.userData.cretNo){if("A"==vm.userData.cretType){vm.certNo=vm.userData.cretNo,vm.certTypeDisabled=!0;var str=vm.userData.cretNo.toUpperCase().replace(/\s+/g,"");vm.certNo=str.substr(0,6)+" "+str.substr(6,8)+" "+str.substr(14,str.length),vm.certNoDisabled=!0}}else vm.certNo=vm.policyData.PbHoldId||"";if(vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=COMMON.getCommonData().NATIONALITIES,vm.nationalities=vm.insureNationalities=vm.commonNationalities,vm.commonoCcupations=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations,vm.commonoCcupations=vm.commonoCcupations.map(function(val){return val})):vm.getCommonData()},200)},vm.getCommonData(),vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.userData.cretType?(vm.nationalities=COMMON.getNationalitiesByCertType(vm.userData.cretType),vm.nationality=vm.nationalities[0].value):vm.nationality=vm.policyData.PbNationality,vm.userData.customerName?(vm.name=vm.userData.customerName,vm.nameDisabled=!0):vm.name=vm.policyData.PbHoldName||"",vm.certStartDate=vm.policyData.PbIdStartDate||"",vm.gender="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender=VALIDATION.getSex(vm.certNo)+"",vm.genderDisabled=!0):vm.userData.sex?(vm.gender=vm.userData.sex+"",vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender=vm.policyData.PbHoldSex),vm.birthday="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.birthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.birthdayDisabled=!0):vm.userData.birthday&&10==vm.userData.birthday.length?(vm.birthday=new Date(vm.userData.birthday),vm.birthdayDisabled=!0):vm.policyData.PbHoldBirdy&&8==vm.policyData.PbHoldBirdy.length&&(vm.birthday=new Date(VALIDATION.dateFormat(vm.policyData.PbHoldBirdy))),vm.userData.phoneNo){var str=vm.userData.phoneNo;vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.phone=vm.policyData.PbHoldMobl||"";vm.email=vm.policyData.PbHoldEmail||"",vm.occupation=vm.policyData.PbHoldOccupCode||"C0000",vm.occupationText=vm.policyData.PbHoldOccupText||"",vm.occupationData=vm.policyData.PbHoldOccupCode||"C0000",vm.occupationDisable=!1,"TAC"==vm.productData.templateCode&&(vm.occupation="13020",vm.relationDisabled=!0),"TLD"==vm.productData.templateCode&&(vm.relationDisabled=!0),"IPAHK"==vm.productData.templateCode&&(vm.relationDisabled=!0),vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.homeTel=vm.policyData.PbHoldHomeTele||"",vm.officeAddress=vm.policyData.PbHoldAddr||"",vm.officeZipCode=vm.policyData.PbHoldPost||"",vm.officeTel=vm.policyData.PbHoldOfficTele||"",vm.isLong=!1,vm.insureIsLong=!1,vm.certExpireType=vm.policyData.certExpireType||"2",vm.isLong="1"==vm.certExpireType,vm.relation=vm.policyData.confirmRela||"01",vm.relationDisabled?vm.chlidren=!1:vm.chlidren=!0,vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"03":"03"==relation?"02":"04"==relation||"05"==relation?"1"==gender?"06":"07":"06"==relation||"07"==relation?"1"==gender?"04":"05":"01"},vm.insureName=vm.policyData.LiRcgnName||"",vm.insureNationality=vm.policyData.LiNationality||"0156",vm.insureCertType=vm.policyData.LiRcgnIdType||"",vm.insureCertTypes=[],vm.insureCertNo=vm.policyData.LiRcgnId||"",vm.insureCertExpireType=vm.policyData.insureCertExpireType||"2",vm.insureIsLong="1"==vm.insureCertExpireType,vm.insureGender=vm.policyData.LiRcgnSex||vm.insureData.sex||"1",vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureBirthday=vm.insureData.birthday||new Date,vm.insureOccupation="C0000",vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.insureBirthday=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value;var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310)},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310);1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.certType&&(vm.userData.cretType?(vm.sign=!1,vm.certTypeDisabled=!0,vm.nationalityDisabled=!0,"A"==vm.userData.cretType?(vm.sign=!0,vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certNoDisabled=!0):vm.certNoDisabled=!1):(vm.sign=!1,vm.certTypeDisabled=!1,vm.nationalityDisabled=!1));var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0;var insure_id="";vm.skipCareerType=function(contrast,id){vm.careerType=!0,throwContrast=contrast,insure_id=id,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.throwContrastData=function(){if(1==throwContrast){if(vm.occupationText=vm.curData,vm.occupation=vm.occupationData,"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("投保人职业为拒保职业，请选择其他职业类型")}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].occupation=vm.occupationData),vm.careerType=!1}vm.careerType=!1,console.info(vm.careerType),console.info(throwContrast)},vm.goNext=function(){console.info(vm.curData),""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){
for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode){if(1==throwContrast)vm.occupationText=curData,vm.occupation=curCode,vm.careerType=!1;else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].occupation=curCode),vm.careerType=!1}}},vm.watch=function(){$scope.$watch("ankangPolicyholder.occupation",function(newValue,oldValue){}),$scope.$watch("ankangPolicyholder.nationality",function(newValue){vm.certTypes=COMMON.getCertTypesByNationality("0156"),vm.certType="A"}),$scope.$watch("ankangPolicyholder.name",function(newValue){newValue&&(vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("ankangPolicyholder.certNo",function(newValue,oldValue){if(newValue){if(vm.certType&&"A"==vm.certType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.certNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.certNo=str}if(newValue.length<18)return;if(!VALIDATION.idCheck(newValue))return vm.gender="",void(vm.birthday="");vm.gender=VALIDATION.getSex(newValue)+"",vm.sex="1"==vm.gender?"男":"女";var age=VALIDATION.getAgeByBirth(vm.insureBirthday);vm.genderDisabled=!0,vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.birthdayDisabled=!0,vm.ischeckAge=vm.checkAge(age)}}else vm.genderDisabled=!1,vm.birthdayDisabled=!1}),$scope.$watch("ankangPolicyholder.phone",function(newValue,oldValue){if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("ankangPolicyholder.insureCertNo",function(newValue,oldValue){if(newValue){if("01"!=vm.relation&&vm.insureCertType&&"A"==vm.insureCertType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.insureCertNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.insureCertNo=str}if(!VALIDATION.idCheck(newValue))return;var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.insureGender=newGender,vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureGenderDisabled=!0,vm.insureBirthday=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.insureBirthday);vm.ischeckAge=vm.checkAge(age)}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),vm.checkAge=function(age){var maxage=0;if(age){switch(vm.insPyfPrdNum){case"0":maxage=65;break;case"3":maxage=60;break;case"5":maxage=60;break;case"10":maxage=55;break;case"20":maxage=45;break;default:maxage=65}return 18>age||age>maxage?(vm.ischeckAge||TipService.showMsg("投保人年龄不在投保范围之内，请重新填写投保人证件号"),"投保人年龄不在投保范围之内，请重新填写投保人证件号"):""}return""},$scope.$watch("ankangPolicyholder.certExpireType",function(newValue,oldValue){1==newValue?vm.certExpireDate=new Date("2099-12-31"):2==newValue&&(vm.certExpireDate=vm.policyData.PbIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.PbIdEndDate)):"")}),$scope.$watch("ankangPolicyholder.isLong",function(newValue){newValue?vm.certExpireType="1":vm.certExpireType="2"}),$scope.$watch("ankangPolicyholder.gender",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureGender=newValue,vm.insureSex="1"==vm.insureGender?"男":"女")}),$scope.$watch("ankangPolicyholder.insureGender",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("ankangPolicyholder.birthday",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureBirthday=newValue)}),$scope.$watch("ankangPolicyholder.insureBirthday",function(newValue,oldValue){"01"!=vm.relation?$filter("date")(vm.insureData.birthday)!=$filter("date")(vm.insureBirthday)&&(vm.insureBirthdayChanged=!0):$filter("date")(vm.birthday)!=$filter("date")(vm.insureData.birthday)&&(vm.insureBirthdayChanged=!0)}),$scope.$watch("ankangPolicyholder.relation",function(newValue,oldValue){newValue&&("01"==newValue?(vm.insureCertType=vm.certType,vm.insureCertTypes=vm.certTypes,vm.insureCertNo=vm.certNo,vm.insureNationality=vm.nationality,vm.insureNationalities=vm.nationalities,vm.insureName=vm.name,vm.insureCertExpireType=vm.certExpireType,vm.insureCertExpireDate=vm.certExpireDate,vm.insureGender=vm.gender,vm.insureGenderDisabled=!1,vm.insureBirthday=vm.birthday,vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.occupation):("06"==newValue?(vm.insureGender="1",vm.insureSex="1"==vm.insureGender?"男":"女"):"07"==newValue&&(vm.insureGender="2",vm.insureSex="1"==vm.insureGender?"男":"女"),vm.checkRelation(newValue,vm.gender)==vm.policyData.PbHoldRcgnRela?(vm.insureCertType=vm.policyData.LiRcgnIdType,vm.insureCertTypes=COMMON.getCertTypesByCode(vm.insureCertType),vm.insureCertNo=vm.policyData.LiRcgnId,vm.insureNationality=vm.policyData.LiNationality,vm.insureNationalities=vm.commonNationalities,vm.insureName=vm.policyData.LiRcgnName,vm.insureCertExpireType=vm.policyData.insureCertExpireType,vm.insureCertExpireDate=new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)),vm.insureGenderDisabled=!0,vm.insureBirthday=new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy)),vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.policyData.LiRcgnOccupCode):(vm.insureData&&vm.insureData.birthday&&(vm.insureBirthday=new Date(vm.insureData.birthday)||""),vm.insureCertNo="",vm.insureName="",vm.insureCertExpireType="2",vm.insureCertExpireDate=""),"06"!=vm.relation&&"07"!=vm.relation||(vm.isStudent=!0,vm.isStudent?vm.insureOccupation="13020":vm.insureOccupation="C0000"))),"01"==vm.relation?vm.checkInCusld=!1:vm.insureNationality&&"0156"==vm.insureNationality?vm.checkInCusld=!0:vm.checkInCusld=!1})},vm.dataCheck=function(){if("Y0000"==vm.occupation)return TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。"),!1;var age=VALIDATION.getAgeByBirth(vm.birthday);if(vm.age=age,age>vm.maxHolderAge||age<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+vm.maxHolderAge+"周岁"),!1;var insureAge="01"==vm.relation?age:VALIDATION.getAgeByBirth(vm.insureBirthday);return insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1):vm.insureGenderChanged||vm.insureBirthdayChanged?(vm.calc&&vm.calcCtrl?("HMRA"==vm.productData.templateCode||"TLD"==vm.productData.templateCode||"BANO"==vm.productData.templateCode?angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,birthdayfm:$filter("date")(vm.insureBirthday,"yyyyMMdd"),payendyear:vm.insureData.payendyear}):angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,payendyear:vm.insureData.payendyear}),angular.extend(vm.calcCtrl.mainPlan,{amount:vm.insureData.mainPlan.amount}),vm.calc(vm.calcCtrl,function(recalcData){recalcData&&(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,recalcData.exp&&(vm.insureData.PbInsuExp!=recalcData.exp?(vm.insureData.PbInsuExp=recalcData.exp,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+recalcData.exp+"</span>元")):vm.insureData.PbInsuAmt!=recalcData.mainPlan.amount?(vm.insureData.PbInsuAmt=recalcData.mainPlan.amount,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED_AMOUNT+'<span class="fs20 orange">'+recalcData.mainPlan.amount+"</span>元")):vm.next()),recalcData.amount&&(vm.insureData.PbInsuAmt=recalcData.amount),recalcData.mainPlan&&(vm.insureData.mainPlan=recalcData.mainPlan),recalcData.addPlan&&(vm.insureData.addPlan=recalcData.addPlan))})):(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,vm.next()),!1):!0},vm.next=function(){vm.dataCheck()&&(PolicyService.control({state:"product-purchase-policy-info",control:"data",data:{PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldBirdyDate:$filter("date")(vm.birthday,"yyyy-MM-dd"),PbHoldIdType:vm.certType,PbHoldAmount:vm.yearIncome,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""),PbIdStartDate:vm.certStartDate,PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbNationality:"0156",PbHoldOfficTele:"",PbHoldHomeTele:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldMobl:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation||"",PbHoldOccupText:vm.occupationText,confirmRela:vm.relation,PbHoldRcgnRela:vm.checkRelation(vm.relation,vm.gender),LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:$filter("date")(vm.insureBirthday,"yyyyMMdd"),LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""):"A"==vm.insureCertType?vm.insureCertNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),LiIdStartDate:"",LiIdEndDate:$filter("date")("01"==vm.relation?vm.certExpireDate:vm.insureCertExpireDate,"yyyyMMdd"),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationality,LiRcgnTele:"",LiRcgnMobl:vm.phone.toUpperCase().replace(/\s+/g,""),LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.occupation:vm.insureOccupation,BankName:vm.name,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,certExpireType:vm.certExpireType,insureCertExpireType:"01"==vm.relation?vm.certExpireType:vm.insureCertExpireType,PbHoldMedic:vm.PbHoldMedic||"",livePlace:vm.livePlace||"",yearIncome:vm.yearIncome||"",priChecked:!0,firstbe:vm.be}}),PolicyService.setSessionData({insureData:{PbInsuExp:vm.insureData.PbInsuExp,PbInsuAmt:vm.insureData.PbInsuAmt,mainPlan:vm.insureData.mainPlan,addPlan:vm.insureData.addPlan,birthday:vm.insureBirthday,sex:vm.insureGender}}),PolicyService.setSessionData({productData:{insureName:vm.insureName}}),PolicyService.setSessionData({userData:{tbName:vm.name,firstbe:vm.be}}),$state.go("product-purchase-ankang-optimze"))},vm.checkCretNo=function(invalid){if("flag"in $state.params.arg&&window.localStorage.setItem("huifu",$state.params.arg.flag),invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.ischeckAge)return void TipService.showMsg(vm.ischeckAge);if(vm.be>1e6)return void TipService.showMsg("最高保额为100万");if(vm.age&&vm.age<18&&vm.be>5e5)return void TipService.showMsg("未成年人最高保额为50万");if(vm.be>5e5&&vm.occupationData&&("R0052"==vm.occupationData||"R0053"==vm.occupationData||"R0054"==vm.occupationData||"R0055"==vm.occupationData))return void TipService.showMsg("学龄前儿童、学生、离退休人员及无业人员，最高保额为50万。");if("Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("投保人职业为拒保职业，请选择其他职业类型");if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params={};vm.nationality||(vm.nationality="0156"),"01"==vm.relation&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}),vm.checkCusId&&vm.checkInCusld&&"Y"==vm.productData.basicProfile.P002?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next(),""!=vm.policyData.PbHoldName&&"undefined"!=vm.policyData.PbHoldName||""!=vm.policyData.PbHoldMedic&&"undefined"!=vm.policyData.PbHoldMedic||""!=vm.policyData.PbHoldId&&"undefined"!=vm.policyData.PbHoldId?$rootScope.policyholderInfoList=!0:$rootScope.policyholderInfoList=!1},vm.changeDataType=function(){vm.isLong=!vm.isLong,vm.isLong?vm.certExpireType="1":vm.certExpireType="2"},vm.longInputClick=function(){vm.isLong=!1,$("#policyholderIdentityDate").trigger("click")},$scope.$on("occupationCallback",function(event,result){}),vm.watch(),vm.init(),vm.sex="1"==vm.gender?"男":"女"}angular.module("app").controller("AnkangPolicyholderController",AnkangPolicyholderController),AnkangPolicyholderController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout"]}(),function(){function AnkangRecognizeeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout,$log){var vm=this;vm.reallist=[["99","请选择"],["03","配偶"],["06","儿子"],["07","女儿"],["08","父母"],["09","公公"],["10","婆婆"],["11","岳父"],["12","岳母"]],vm.ischeckAge="";var x1=/^\+?[1-9][0-9]*$/;vm.ls=[],vm.zd2=!0,vm.errorMsg="输入的金额必须大于等于10000并且是1000的整数倍";var sessionData=PolicyService.getSessionData();if(vm.policyData=sessionData.policyData,vm.insPyfPrdNum=sessionData.insureData.insPyfPrdNum,vm.policyData.PbHoldBirdy&&(vm.PbHoldage=VALIDATION.getAgeByBirth(vm.policyData.PbHoldBirdy)),vm.ionicGoBack=$scope.$ionicGoBack,$scope.$ionicGoBack=function(){$state.params.arg.flag?(window.localStorage.setItem("huifu",$state.params.arg.flag),vm.ionicGoBack()):vm.ionicGoBack()},vm.be=1e4,vm.reduce=function(e){1e4!=vm.be&&(vm.be=Number($.trim(vm.be))-1e3)},vm.add2=function(e){vm.be=Number($.trim(vm.be))+1e3},vm.timer=null,$scope.$watch("ankangRecognizee.be",function(n){vm.timer&&(vm.showError=!1,$timeout.cancel(vm.timer)),vm.zd2?n>=1e4&&x1.test(n/1e3)||(vm.showError=!0,vm.timer=$timeout(function(){vm.showError=!1,vm.be=1e4},3e3)):vm.zd2=!0}),vm.productData=sessionData.productData,vm.policyData=sessionData.policyData,vm.insureDataList=sessionData.policyData.LiRcgnList,vm.isGhmbUpdate=vm.policyData.isGhmbUpdate||!1,vm.selectedInsure=sessionData.policyData.selectedInsure,vm.policyUser=vm.insureDataList[vm.selectedInsure]||"",vm.policyUser?vm.be=vm.policyUser.be||1e4:vm.zd2=!1,vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=COMMON.getCommonData().NATIONALITIES,vm.nationalities=vm.insureNationalities=vm.commonNationalities,vm.commonoCcupations=COMMON.getCommonData().OCCUPATION_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations):vm.getCommonData()},200)},vm.getCommonData(),vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.insureNationality="0156",vm.LiRcgnName=vm.policyUser.LiRcgnName||"",vm.insureCertTypes=COMMON.getCertTypesByNationality("0156"),vm.LiRcgnIdType=vm.insureCertTypes[0].value||"A",vm.LiRcgnId=vm.policyUser.LiRcgnId||"",vm.certStartDate=vm.policyUser.LiIdEndDate||"",vm.LiRcgnExpireType=vm.policyUser.LiRcgnExpireType||"2",vm.insureIsLong="1"==vm.LiRcgnExpireType,"2"==vm.LiRcgnExpireType&&(vm.insureCertExpireDate=vm.policyUser.LiIdEndDate?new Date(VALIDATION.dateFormat(vm.policyUser.LiIdEndDate)):""),vm.LiRcgnSex="",vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType&&vm.LiRcgnId?(vm.LiRcgnSex=VALIDATION.getSex(vm.LiRcgnId)+"",vm.genderDisabled=!0):vm.policyUser.LiRcgnSex?(vm.LiRcgnSex=vm.policyUser.LiRcgnSex+"",vm.genderDisabled=!0):vm.policyUser.policyUser&&(vm.LiRcgnSex=vm.policyUser.LiRcgnSex),vm.LiRcgnBirdy="",vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType&&vm.LiRcgnId?(vm.LiRcgnBirdy=new Date(VALIDATION.getBirthday(vm.LiRcgnId)),vm.birthdayDisabled=!0):vm.policyUser.LiRcgnBirdy&&10==vm.policyUser.LiRcgnBirdy.length?(vm.LiRcgnBirdy=new Date(vm.policyUser.LiRcgnBirdy),vm.birthdayDisabled=!0):vm.policyUser.LiRcgnBirdy&&8==vm.policyUser.LiRcgnBirdy.length&&(vm.LiRcgnBirdy=new Date(VALIDATION.dateFormat(vm.policyUser.LiRcgnBirdy))),vm.policyUser.LiRcgnMobl){var str=vm.policyUser.LiRcgnMobl;vm.LiRcgnPhone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.LiRcgnMobl=vm.policyUser.LiRcgnMobl||"";if(vm.selectPhone=!0,vm.email=vm.policyUser.email||"",vm.isGhmbUpdate){var age=VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);18>age?vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_CHILD_CODE:vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.LiRcgnOccupCode=vm.policyUser.LiRcgnOccupCode||"",vm.LiRcgnOccupText=vm.policyUser.LiRcgnOccupText||""}else vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.LiRcgnOccupCode=vm.policyUser.LiRcgnOccupCode||"C0000",vm.LiRcgnOccupText=vm.policyUser.LiRcgnOccupText||"";vm.occupationData=vm.policyUser.LiRcgnOccupCode||"C0000",vm.occupations=COMMON.getCommonData().OCCUPATION_CODE,vm.occupationDisable=!1,vm.confirmRela=vm.policyUser.confirmRela||"99",vm.LiRcgnMedic=vm.policyUser.LiRcgnMedic||"",vm.isLong=!1,vm.trashShow=vm.policyUser.trashShow,vm.checkRelation=function(confirmRela,gender){return"01"==confirmRela?"01":"02"==confirmRela?"03":"03"==confirmRela?"02":"04"==confirmRela||"05"==confirmRela?"1"==gender?"06":"07":"06"==confirmRela||"07"==confirmRela?"1"==gender?"04":"05":"01"},vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.LiRcgnBirdy=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"LiRcgnId"==key||"LiRcgnId"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"LiRcgnMobl"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"LiRcgnName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}};var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0;var insure_id="";vm.skipCareerType=function(contrast,id){vm.careerType=!0,throwContrast=contrast,insure_id=id,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.agecheck=function(birthday){if(birthday){var b=new Date(birthday),d=new Date,age=d.getFullYear()-b.getFullYear()-(d.getMonth()<b.getMonth()||d.getMonth()==b.getMonth()&&d.getDate()<b.getDate()?1:0);return $log.info(age),age}return!1},vm.throwContrastData=function(){if(1==throwContrast){if(vm.LiRcgnOccupText=vm.curData,vm.LiRcgnOccupCode=vm.occupationData,"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}vm.careerType=!1}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].LiRcgnOccupCode=vm.occupationData),vm.careerType=!1}vm.careerType=!1},vm.goNext=function(){console.info("vm.curData"+vm.curData),""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode,pg){if("03"==pg)vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode,vm.careerType=!1;else if(1==throwContrast){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode,vm.careerType=!1}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].LiRcgnOccupCode=curCode),vm.careerType=!1}},vm.watch=function(){$scope.$watch("ankangRecognizee.name",function(newValue){newValue&&(vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("ankangRecognizee.LiRcgnPhone",function(newValue,oldValue){if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.LiRcgnPhone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("ankangRecognizee.LiRcgnId",function(newValue,oldValue){if(newValue){if("01"!=vm.confirmRela&&vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.LiRcgnId=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.LiRcgnId=str}if(newValue.length<18)return;if(!VALIDATION.idCheck(newValue))return vm.LiRcgnSex="",void(vm.LiRcgnBirdy="");var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.LiRcgnSex=newGender,vm.insureSex="1"==vm.LiRcgnSex?"男":"女",vm.insureGenderDisabled=!0,vm.LiRcgnBirdy=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);vm.age=age,vm.ischeckAge=vm.checkAge(age),18>age?(vm.isStudent=!0,vm.selectPhone=!1):(vm.isStudent=!1,vm.selectPhone=!0),vm.isStudent?vm.isGhmbUpdate||(vm.LiRcgnOccupCode="R0053"):vm.isGhmbUpdate||"13020"==vm.LiRcgnOccupCode&&(vm.LiRcgnOccupCode="C0000")}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),vm.checkAge=function(age){var day=0;if(0==age&&(day=(Date.parse(new Date)-Date.parse(new Date(vm.LiRcgnBirdy)))/864e5,30>day))return vm.ischeckAge||TipService.showMsg("被保人年龄不在投保范围之内，请重新填写被保人证件号"),"被保人年龄不在投保范围之内，请重新填写被保人证件号";var maxage,minage=0;switch(vm.insPyfPrdNum){case"0":maxage=65;break;case"3":maxage=60;break;case"5":maxage=60;break;case"10":maxage=55;break;case"20":maxage=45;break;default:maxage=65}return vm.PbHoldage&&("06"==vm.confirmRela||"0"==vm.confirmRela?maxage=vm.PbHoldage-18:"08"==vm.confirmRela&&(minage=vm.PbHoldage+18)),age>maxage||minage>age?(vm.ischeckAge||TipService.showMsg("被保人年龄不在投保范围之内，请重新填写被保人证件号"),"被保人年龄不在投保范围之内，请重新填写被保人证件号"):""},$scope.$watch("ankangRecognizee.LiRcgnExpireType",function(newValue,oldValue){1==newValue?vm.insureCertExpireDate=new Date("2099-12-31"):1==oldValue&&(vm.insureCertExpireDate="")}),$scope.$watch("ankangRecognizee.insureIsLong",function(newValue){newValue?vm.LiRcgnExpireType="1":vm.LiRcgnExpireType="2"}),$scope.$watch("ankangRecognizee.LiRcgnSex",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("ankangRecognizee.confirmRela",function(newValue,oldValue){"03"==newValue&&(vm.selectPhone=!0),"06"==newValue||"07"==newValue?vm.selectPhone=!1:vm.selectPhone=!0,vm.ischeckAge=vm.checkAge(age)}),vm.del=function(){vm.insureDataList.splice(vm.selectedInsure,1),PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),$state.go("product-purchase-ankang-optimze")},$scope.$watch("ankangRecognizee.LiRcgnOccupCode",function(newValue,oldValue){})},vm.next=function(){if("Y0000"==vm.LiRcgnOccupCode)return void TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。");var tempPhone="";if(vm.LiRcgnPhone&&(tempPhone=vm.LiRcgnPhone.toUpperCase().replace(/\s+/g,"")),vm.submitData={id:vm.selectedInsure,confirmRela:vm.confirmRela,LiRcgnName:vm.LiRcgnName,LiRcgnMedic:vm.LiRcgnMedic,LiRcgnIdType:vm.LiRcgnIdType,LiRcgnId:"A"==vm.LiRcgnIdType?vm.LiRcgnId.toUpperCase().replace(/\s+/g,""):vm.LiRcgnId.toUpperCase().replace(/\s+/g,""),LiRcgnBirdy:$filter("date")(vm.LiRcgnBirdy,"yyyyMMdd"),LiRcgnMobl:tempPhone,LiRcgnSex:vm.LiRcgnSex,LiRcgnOccupCode:vm.LiRcgnOccupCode,LiRcgnOccupText:vm.LiRcgnOccupText,LiRcgnExpireType:vm.LiRcgnExpireType,insureIsLong:vm.insureIsLong,LiIdEndDate:$filter("date")(vm.insureCertExpireDate,"yyyyMMdd"),insureChecked:!0,LiNationality:"0156"},angular.merge(vm.submitData,{be:vm.be}),vm.selectedInsure>vm.insureDataList.length-1)vm.insureDataList[vm.selectedInsure]=vm.submitData,vm.policyData.locate&&(vm.insureDataList[vm.selectedInsure].locate=vm.policyData.locate,vm.insureDataList[vm.selectedInsure].LiRcgnZipCode=vm.policyData.PbHoldZipCode,vm.insureDataList[vm.selectedInsure].LiRcgnAddress=vm.policyData.PbHoldAddress);else{var oldVal=JSON.parse(JSON.stringify(vm.insureDataList[vm.selectedInsure]));oldVal.locate&&(vm.submitData.LiRcgnZipCode=oldVal.LiRcgnZipCode,vm.submitData.LiRcgnAddress=oldVal.LiRcgnAddress),vm.insureDataList[vm.selectedInsure]=vm.submitData}PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),$state.go("product-purchase-ankang-optimze")},vm.checkCretNo=function(invalid){if("flag"in $state.params.arg&&window.localStorage.setItem("huifu",$state.params.arg.flag),invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.ischeckAge)return void TipService.showMsg(vm.ischeckAge);if("99"==vm.confirmRela)return void TipService.showMsg("请选择与当前被保人与投保人的关系");if(vm.be>1e6)return void TipService.showMsg("最高保额为100万");if(vm.age&&vm.age<18&&vm.be>5e5)return void TipService.showMsg("未成年人最高保额为50万");if(vm.be>5e5&&vm.occupationData&&("R0052"==vm.occupationData||"R0053"==vm.occupationData||"R0054"==vm.occupationData||"R0055"==vm.occupationData))return void TipService.showMsg("学龄前儿童、学生、离退休人员及无业人员，最高保额为50万。");if("Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");
if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age&&($log.info("年龄"+age),$log.info(vm.LiRcgnOccupCode),"学生"!=vm.LiRcgnOccupText&&"学龄前儿童"!=vm.LiRcgnOccupText))return void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}if("Y0000"==vm.LiRcgnOccupCode)return void TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。");if(vm.reallist=[["99","请选择"],["03","配偶"],["06","儿子"],["07","女儿"],["08","父母"],["09","公公"],["10","婆婆"],["11","岳父"],["12","岳母"]],"06"==vm.confirmRela&&"2"==vm.LiRcgnSex||"07"==vm.confirmRela&&"1"==vm.LiRcgnSex||"09"==vm.confirmRela&&"2"==vm.LiRcgnSex||"10"==vm.confirmRela&&"1"==vm.LiRcgnSex||"11"==vm.confirmRela&&"2"==vm.LiRcgnSex||"12"==vm.confirmRela&&"1"==vm.LiRcgnSex)return void TipService.showMsg("投被保人关系与被保险人的性别不符，请重新填写！");if(""!=vm.policyData.PbHoldSex&&void 0!=vm.policyData.PbHoldSex&&"03"==vm.confirmRela&&("1"==vm.policyData.PbHoldSex&&"1"==vm.LiRcgnSex||"2"==vm.policyData.PbHoldSex&&"2"==vm.LiRcgnSex))return void TipService.showMsg($rootScope.TIPS.PRODUCT.MATE_SEX_ERROR);if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next()},vm.watch(),vm.identityDateLongClick=function(){vm.insureIsLong=!1,$("#recognizeeIdentityDate").trigger("click")},console.info(vm)}angular.module("app").controller("AnkangRecognizeeController",AnkangRecognizeeController),AnkangRecognizeeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout","$log"]}(),function(){function ActivationPerformCollectionController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$ionicLoading,$window,$sce,$scope,$ionicPopup){var vm=this;vm.getQueryStringRegExp=function(name){var reg=new RegExp("(^|\\?|&)"+name+"=([^&]*)(\\s|&|$)","i");return reg.test(decodeURI(window.location.href))?unescape(RegExp.$2.replace(/\+/g," ")):""};var sessionData=PolicyService.getSessionData();vm.prd_id=vm.getQueryStringRegExp("pid")||"10024",vm.openid=$rootScope.openid||"12233211265151212",vm.name=vm.getQueryStringRegExp("name"),vm.cardNo=vm.getQueryStringRegExp("cdn")||"123456",vm.batchNo=vm.getQueryStringRegExp("btn"),vm.referrerName="",vm.referrerCode="",vm.PbWebsiteCode="",vm.PbWebsiteName="",$scope.$watch("activationPerformCollection.PbWebsiteCode",function(newValue){if(vm.PbWebsiteCode&&vm.getTextLength(vm.PbWebsiteCode)){var s=vm.getTextLength(vm.PbWebsiteCode);console.info(s),vm.PbWebsiteCode=vm.PbWebsiteCode.substring(0,s)}}),$scope.$watch("activationPerformCollection.PbWebsiteName",function(newValue){if(vm.PbWebsiteName&&vm.getTextLength1(vm.PbWebsiteName)){var s=vm.getTextLength1(vm.PbWebsiteName);vm.PbWebsiteName=vm.PbWebsiteName.substring(0,s)}}),$scope.$watch("activationPerformCollection.referrerName",function(newValue){if(vm.referrerName&&vm.getTextLength(vm.referrerName)){var s=vm.getTextLength(vm.referrerName);vm.referrerName=vm.referrerName.substring(0,s)}}),$scope.$watch("activationPerformCollection.referrerCode",function(newValue){if(vm.referrerCode&&vm.getTextLength(vm.referrerCode)){var s=vm.getTextLength(vm.referrerCode);vm.referrerCode=vm.referrerCode.substring(0,s)}}),vm.getTextLength=function(text){for(var length=0,i=0;i<text.length;i++){if(text.charCodeAt(i)>255?length+=3:++length,50==length)return i+=1;if(length>50)return i}},vm.getTextLength1=function(text){for(var length=0,i=0;i<text.length;i++){if(text.charCodeAt(i)>255?length+=3:++length,60==length)return i+=1;if(length>60)return i}},vm.show="0",vm.getIdTime=1,vm.butShow=!1,"1"==vm.show?document.title="登录":"2"==vm.show&&(document.title="业绩领取"),vm.getDate=function(){console.info("我"),CommonRequest.request({},{url:CONFIG.DOMAIN+"/statics/product/"+CONFIG.SALE_CHANNEL+"/"+vm.prd_id+"/"+vm.prd_id+".json?prdId="+vm.prd_id,method:"get"},function(res){vm.prd_name=res.data.prd_name||"龙支付"})},vm.getDate(),vm.showLoading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.hideLoading=function(){$ionicLoading.hide()},vm.getId=function(){if(1===vm.getIdTime&&vm.showLoading(),vm.getIdTime>10)return vm.hideLoading(),void vm.showMessage("暂未获取到微信号，请重新扫描");if($rootScope.openid)vm.hideLoading(),vm.getIdTime=1,vm.openid=$rootScope.openid,vm.collectFind(),console.info(vm.openid);else var timer=$timeout(function(){vm.getId(),vm.getIdTime++,$timeout.cancel(timer)},500)},vm.getId(),vm.showMessage=function(msg,flag){var ionicMsg=$ionicPopup.alert({cssClass:"popup-icon",template:msg,okText:"我知道了"});ionicMsg.then(function(){flag||vm.back()})},vm.back=function(){sessionData.wxClose?history.go(-2):WeixinJSBridge.call("closeWindow")},vm.errorAlert=function(key,val){"referrerCode"==key?1==val.invalid?(vm.referrerCodeErr=!0,$timeout(function(){vm.referrerCodeErr=!1},1500)):1==val.length&&(vm.referrerCodeLen=!0,$timeout(function(){vm.referrerCodeLen=!1},1500)):"referrerName"==key&&(1==val.invalid?(vm.referrerNameErr=!0,$timeout(function(){vm.referrerNameErr=!1},1500)):1==val.length&&(vm.referrerNameLen=!0,$timeout(function(){vm.referrerNameLen=!1},1500)))},vm.hide=function(){vm.referrerCodeErr=!1,vm.referrerCodeLen=!1,vm.referrerNameErr=!1,vm.referrerNameLen=!1},vm.toList=function(){$state.go("perform-list",{openid:vm.openid,cardNo:vm.cardNo,name:vm.referrerName,referrercode:vm.referrerCode})},vm.submit=function(){if(!vm.referrerName)return void TipService.showMsg("请输入推荐人姓名","errorAlert",1e3);if(!vm.referrerCode)return void TipService.showMsg("请输入推荐人工号","errorAlert",1e3);if(!vm.PbWebsiteCode)return void TipService.showMsg("请输入网点代码","errorAlert",1e3);if(!vm.PbWebsiteName)return void TipService.showMsg("请输入网点名称","errorAlert",1e3);var params={openid:vm.openid,referrercode:vm.referrerCode,referrername:vm.referrerName,netcode:vm.PbWebsiteCode,netname:vm.PbWebsiteName};CommonRequest.request(params,CONFIG.REFERREE_BINDING,function(result){if(1==result.status)if("S0001"==result.data.code){vm.show="2";var myPopup=$ionicPopup.show({template:result.data.message,buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){console.info(11)}}]});myPopup.then(function(res){console.log("tapped!",res)})}else"F0001"==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):"901000124"==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):"S330000141"==result.data.code&&(vm.show="1",TipService.showMsg(result.data.message))}),"1"==vm.show?document.title="登录":"2"==vm.show&&(document.title="业绩领取")},vm.init=function(){var params1={openid:vm.openid};CommonRequest.request(params1,CONFIG.REFERREE_BINDING_STATE,function(result){1==result.status&&(0==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):1==result.data.code&&(vm.referrerCode=result.data.list.referrerCode,vm.referrerName=result.data.list.referrerName,vm.PbWebsiteCode=result.data.list.netCode,vm.PbWebsiteName=result.data.list.netName,vm.show="2"))})},vm.collectFind=function(){var params={openid:vm.openid,cardno:vm.cardNo};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){if(console.info(22),1==result.status)if(1==result.data.code){vm.init();var myPopup=$ionicPopup.show({template:result.data.message,buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){vm.butShow=!0}}]});myPopup.then(function(res){console.log("tapped!",res)})}else vm.init()})},vm.submits=function(){if(!vm.butShow){var params={openid:vm.openid,cardno:vm.cardNo,appntname:vm.name,prdname:vm.prd_name,batchno:vm.batchNo,referrername:vm.referrerName,referrercode:vm.referrerCode,netcode:vm.PbWebsiteCode,netname:vm.PbWebsiteName};CommonRequest.request(params,CONFIG.RECEIVE_ACHIEVEMENT,function(result){1==result.status&&("S0002"==result.data.code?(TipService.showMsg(result.data.message),vm.butShow=!0):"F0002"==result.data.code&&TipService.showMsg(result.data.message))})}}}angular.module("app").controller("ActivationPerformCollectionController",ActivationPerformCollectionController),ActivationPerformCollectionController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$ionicLoading","$window","$sce","$scope","$ionicPopup"]}(),function(){function ActivationSuccessController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,$filter,$window,$location){var vm=this,params=$state.params;vm.respCode=params.respCode,vm.respMsg=params.respMsg;var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.showImgCode=!1,vm.policyData=sessionData.policyData||"",vm.name1=encodeURI(vm.policyData.name)||encodeURI("张三丰"),vm.cardNo1=encodeURIComponent(vm.policyData.priCardNo)||"1231135464879",vm.cardNo2=vm.policyData.cardNo||"",vm.batchno=vm.policyData.batchNo||"23234324",vm.productData?vm.prd_id=vm.productData.prd_id:vm.prd_id="10205",vm.cardSaleType=localStorage.getItem("cardSaleType"),vm.qrcode="",vm.url1=CONFIG.DOMAIN+window.location.pathname+"#/card-activation-select",vm.url=(vm.url1+"?pid="+vm.prd_id+"&name="+vm.name1+"&cdn="+vm.cardNo1+"&btn="+vm.batchno+"&cds="+vm.cardNo2).toString(),$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"perform-list"==toState.name&&PolicyService.setSessionData({wxClose:!0})}),vm.qrcodes=function(){vm.vwidth=.25*window.innerWidth,vm.qrcode2=$("#qrcode1").qrcode({render:"canvas",text:vm.url,width:vm.vwidth,height:vm.vwidth,correctLevel:1,background:"#ffffff",foreground:"#000000"}).hide(),vm.canvas=vm.qrcode2.find("canvas").get(0),$("#qrcode3").attr("src",vm.canvas.toDataURL("image/png"))},1==vm.respCode&&"2"==vm.cardSaleType&&vm.qrcodes(),vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.policyData=sessionData.policyData||"",vm.policyData){vm.name=vm.policyData.name,vm.activationTime=$filter("date")(new Date,"yyyy-MM-dd HH:mm"),vm.cardNo=vm.policyData.cardNo,vm.orderCode=vm.policyData.orderCode,vm.tipStartTimelhh=vm.policyData.tipStartTimelhh?vm.policyData.tipStartTimelhh.replace("年","/").replace("月","/").replace("日",""):"";var getDate=new Date(vm.tipStartTimelhh);vm.tipStartTimelhh="Invalid Date"==$filter("date")(getDate,"yyyy-MM-dd")?!1:$filter("date")(getDate,"yyyy-MM-dd"),console.info(vm.tipStartTimelhh),vm.insurYearArrlhh=vm.policyData.insurYearArrlhh,vm.insEndDate=vm.policyData.insEndDate;var endDate=vm.policyData.insEndDate?vm.policyData.insEndDate.substring(0,10).replace("-","/").replace("-","/"):"";vm.insEndDate=$filter("date")(new Date(endDate)-1,"yyyy-MM-dd")}"1"==vm.respCode?(vm.title="激活成功",vm.productData&&vm.productData.plans&&vm.changeInsurYear(vm.productData.plans)):"5"==vm.respCode?vm.title="领取失败":("2"==vm.respCode,vm.title="激活失败"),vm.getBasicInfo=function(){var openid=sessionStorage.getItem("elife-openid");null==openid&&(openid="12233211265151212");var params={openId:openid};CommonRequest.request(params,CONFIG.GET_BASIC_INFO,function(result){"1"===result.status&&result.data.subscribe&&"0"==result.data.subscribe&&(vm.showImgCode=!0)})},vm.getBasicInfo(),vm.next=function(){$window.location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MjM5MjA2NzQ5NA==&scene=110#wechat_redirect"}}angular.module("app").controller("ActivationSuccessController",ActivationSuccessController),ActivationSuccessController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","$filter","$window","$location"]}(),function(){function ActivationSuccessBackController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,$filter,$window){var vm=this,params=$state.params;vm.respCode=params.respCode,vm.respMsg=params.respMsg;var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.policyData=sessionData.policyData||"",vm.name1=encodeURI(vm.policyData.name)||"张三丰",vm.cardNo1=encodeURIComponent(vm.policyData.priCardNo)||"1231135464879",vm.cardNo2=vm.policyData.cardNo||"",vm.batchno=vm.policyData.batchNo||"23234324",vm.productData?vm.prd_id=vm.productData.prd_id:vm.prd_id="10205",vm.cardSaleType=localStorage.getItem("cardSaleType"),vm.qrcode="",vm.url1=CONFIG.DOMAIN+window.location.pathname+"#/card-activation-select",vm.url=(vm.url1+"?pid="+vm.prd_id+"&name="+vm.name1+"&cdn="+vm.cardNo1+"&btn="+vm.batchno+"&cds="+vm.cardNo2).toString(),$scope.$on("$stateChangeSuccess",function(event,toState,toParams,fromState,fromParams){"perform-list"==toState.name&&PolicyService.setSessionData({wxClose:!0})}),vm.qrcodes=function(){vm.vwidth=.25*window.innerWidth,vm.qrcode2=$("#qrcode1").qrcode({render:"canvas",text:vm.url,width:vm.vwidth,height:vm.vwidth,correctLevel:1,background:"#ffffff",foreground:"#000000"}).hide(),vm.canvas=vm.qrcode2.find("canvas").get(0),$("#qrcode3").attr("src",vm.canvas.toDataURL("image/png"))},2==vm.respCode&&"2"==vm.cardSaleType&&vm.qrcodes(),vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.policyData=sessionData.policyData||"",vm.policyData&&(vm.name=vm.policyData.name,vm.activationTime=$filter("date")(new Date,"yyyy-MM-dd HH:mm"),vm.cardNo=vm.policyData.cardNo,vm.orderCode=vm.policyData.orderCode),"2"==vm.respCode?(vm.title="支付成功",vm.changeInsurYear(vm.productData.plans)):"3"==vm.respCode?vm.title="支付失败":vm.title="支付失败",vm.next=function(){$window.location.href="https://mp.weixin.qq.com/mp/profile_ext?action=home&__biz=MjM5MjA2NzQ5NA==&scene=110#wechat_redirect"}}angular.module("app").controller("ActivationSuccessBackController",ActivationSuccessBackController),ActivationSuccessBackController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","$filter","$window"]}(),function(){function CardNoticessController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,$ionicPopup){$scope.flag=2;var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.exoneration,productData.hotTip&&productData.hotTip.length>0&&($scope.flag1=!0),$scope.noticeTag=function(healthTag){if("01"!==$rootScope.nextRelation&&$rootScope.nextInsureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res&&$rootScope.$broadcast("notice-choice2",healthTag)})}else $rootScope.$broadcast("notice-choice2",healthTag)}}angular.module("app").controller("CardNoticessController",CardNoticessController),CardNoticessController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","$ionicPopup"]}(),function(){function CardNoticesController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.hotTip,productData.exoneration&&productData.exoneration.length>0&&($scope.flag1=!0),$scope.noticeTag=function(healthTag){if($scope.flag1)return COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-sr/card-activation-notice.html"),void COMMON.hideModal();if("01"!==$rootScope.nextRelation&&$rootScope.nextInsureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res&&$rootScope.$broadcast("notice-choice1",healthTag)})}else $rootScope.$broadcast("notice-choice1",healthTag)}}angular.module("app").controller("CardNoticesController",CardNoticesController),CardNoticesController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService"]}(),function(){function CardNoticeController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.noticeTag=function(healthTag){$rootScope.$broadcast("notice-choice",healthTag),COMMON.hideModal()}}angular.module("app").controller("CardNoticeController",CardNoticeController),CardNoticeController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService"]}(),function(){function CardActivationSelectController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$ionicLoading,$window,$sce,$scope,$ionicPopup,$location){var vm=this;console.info($location.search()),vm.getQueryStringRegExp=function(name){var reg=new RegExp("(^|\\?|&)"+name+"=([^&]*)(\\s|&|$)","i");return reg.test(decodeURI(window.location.href))?unescape(RegExp.$2.replace(/\+/g," ")):""};var sessionData=PolicyService.getSessionData();vm.prd_id=vm.getQueryStringRegExp("pid")||"",vm.openid=$rootScope.openid||"1231356464564",vm.name=vm.getQueryStringRegExp("name")||"",vm.cardNo=vm.getQueryStringRegExp("cdn")||"",vm.cardNo1=vm.getQueryStringRegExp("cds")||"",vm.batchNo=vm.getQueryStringRegExp("btn")||"",vm.referrerName="",vm.referrerCode="",vm.PbWebsiteCode="",vm.PbWebsiteName="",vm.prd_name="",vm.maShow=!1,vm.appntName="",vm.appntidno="",vm.perListShow=!1,vm.loadmore=!0,vm.scrollShow=!1,vm.page=1,vm.size="10",vm.flag1=!0,vm.flag=!1,vm.perList=[],$scope.$watch("cardActivationSelect.PbWebsiteCode",function(newValue){if(vm.PbWebsiteCode&&vm.getTextLength(vm.PbWebsiteCode)){var s=vm.getTextLength(vm.PbWebsiteCode);console.info(s),vm.PbWebsiteCode=vm.PbWebsiteCode.substring(0,s)}}),$scope.$watch("cardActivationSelect.PbWebsiteName",function(newValue){if(vm.PbWebsiteName&&vm.getTextLength1(vm.PbWebsiteName)){var s=vm.getTextLength1(vm.PbWebsiteName);vm.PbWebsiteName=vm.PbWebsiteName.substring(0,s)}}),$scope.$watch("cardActivationSelect.referrerCode",function(newValue){if(vm.referrerCode&&vm.getTextLength(vm.referrerCode)){var s=vm.getTextLength(vm.referrerCode);vm.referrerCode=vm.referrerCode.substring(0,s)}}),vm.goList=function(){$state.go("card-perform-list",{name:vm.referrerName,openid:vm.openid,cardNo:vm.cardNo,referrercode:vm.referrerCode})},vm.getTextLength=function(text){for(var length=0,i=0;i<text.length;i++){if(text.charCodeAt(i)>255?length+=3:++length,50==length)return i+=1;if(length>50)return i}},vm.getTextLength1=function(text){for(var length=0,i=0;i<text.length;i++){if(text.charCodeAt(i)>255?length+=3:++length,60==length)return i+=1;if(length>60)return i}},vm.show="0",vm.getIdTime=1,"1"==vm.show?document.title="登录":"2"==vm.show&&(document.title="业绩领取"),vm.getDate=function(){console.info("我"),vm.prd_id&&CommonRequest.request({},{url:CONFIG.DOMAIN+"/statics/product/"+CONFIG.SALE_CHANNEL+"/"+vm.prd_id+"/"+vm.prd_id+".json?prdId="+vm.prd_id,method:"get"},function(res){res&&(vm.prd_name=res.data.prd_name||"龙支付")})},vm.getDate(),vm.showLoading=function(){$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'})},vm.init=function(){var params1={openid:vm.openid};CommonRequest.request(params1,CONFIG.REFERREE_BINDING_STATE,function(result){1==result.status&&(0==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):1==result.data.code&&(vm.referrerCode=result.data.list.referrerCode,vm.referrerName=result.data.list.referrerName,vm.PbWebsiteCode=result.data.list.netCode,vm.PbWebsiteName=result.data.list.netName,vm.show="2",vm.cardNo&&(vm.maShow=!0,vm.collectFind())),"1"==vm.show?(vm.cardNo&&(vm.maShow=!0,vm.collectFind()),document.title="登录"):"2"==vm.show&&(document.title="业绩领取",$timeout(function(){vm.scollBottom()},500)))})},vm.hideLoading=function(){$ionicLoading.hide()},vm.getId=function(){if(1===vm.getIdTime&&vm.showLoading(),vm.getIdTime>10)return vm.hideLoading(),void vm.showMessage("暂未获取到微信号，请重新扫描");if($rootScope.openid)vm.hideLoading(),vm.getIdTime=1,vm.openid=$rootScope.openid,vm.init(),console.info(vm.openid);else var timer=$timeout(function(){vm.getId(),vm.getIdTime++,$timeout.cancel(timer)},500)},vm.getId(),vm.showMessage=function(msg,flag){var ionicMsg=$ionicPopup.alert({cssClass:"popup-icon",template:msg,okText:"我知道了"});ionicMsg.then(function(){flag||vm.back()})},vm.back=function(){sessionData.wxClose?history.go(-2):WeixinJSBridge.call("closeWindow")},vm.errorAlert=function(key,val){"referrerCode"==key?1==val.invalid?(vm.referrerCodeErr=!0,$timeout(function(){vm.referrerCodeErr=!1},1500)):1==val.length&&(vm.referrerCodeLen=!0,$timeout(function(){vm.referrerCodeLen=!1},1500)):"referrerName"==key&&(1==val.invalid?(vm.referrerNameErr=!0,$timeout(function(){vm.referrerNameErr=!1},1500)):1==val.length&&(vm.referrerNameLen=!0,$timeout(function(){vm.referrerNameLen=!1},1500)))},vm.hide=function(){vm.referrerCodeErr=!1,vm.referrerCodeLen=!1,vm.referrerNameErr=!1,vm.referrerNameLen=!1},vm.toList=function(){$state.go("perform-list",{openid:vm.openid,cardNo:vm.cardNo,name:vm.referrerName,referrercode:vm.referrerCode})},vm.submit=function(key,val){if(!vm.referrerName)return vm.referrerName1=!0,void $timeout(function(){vm.referrerName1=!1},1500);if("referrerCode"==key){if(1==val.invalid)return vm.referrerCodeErr=!0,void $timeout(function(){vm.referrerCodeErr=!1},1500);if(1==val.length)return vm.referrerCodeLen=!0,void $timeout(function(){vm.referrerCodeLen=!1},1500)}else if("referrerName"==key){if(1==val.invalid)return vm.referrerNameErr=!0,void $timeout(function(){vm.referrerNameErr=!1},1500);if(1==val.length)return vm.referrerNameLen=!0,void $timeout(function(){vm.referrerNameLen=!1},1500)}if(!vm.referrerCode)return vm.referrerCode1=!0,void $timeout(function(){vm.referrerCode1=!1},1500);if(!vm.PbWebsiteCode)return vm.PbWebsiteCode1=!0,void $timeout(function(){vm.PbWebsiteCode1=!1},1500);if(!vm.PbWebsiteName)return vm.PbWebsiteName1=!0,void $timeout(function(){vm.PbWebsiteName1=!1},1500);var params={openid:vm.openid,referrercode:vm.referrerCode,referrername:vm.referrerName,netcode:vm.PbWebsiteCode,netname:vm.PbWebsiteName};CommonRequest.request(params,CONFIG.REFERREE_BINDING,function(result){if(1==result.status)if("S0001"==result.data.code){vm.show="2";var myPopup=$ionicPopup.show({template:result.data.message,buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){console.info(11)}}]});myPopup.then(function(res){console.log("tapped!",res)})}else"F0001"==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):"901000124"==result.data.code?(vm.show="1",TipService.showMsg(result.data.message)):"S330000141"==result.data.code&&(vm.show="1",TipService.showMsg(result.data.message))}),"1"==vm.show?document.title="登录":"2"==vm.show&&(document.title="业绩领取",$timeout(function(){vm.scollBottom()},500))},vm.search=function(){if(vm.appntidno="",vm.appntName="",!vm.keyword)return void TipService.showMsg("请输入请输入客户姓名或证件号码","errorAlert",1e3);/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(vm.keyword)?vm.appntidno=vm.keyword:vm.appntName=vm.keyword,vm.page=1;var params={openid:vm.openid,encryptedcardno:vm.cardNo,appntidno:vm.appntidno,appntName:vm.appntName,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_CARD_BYAPP,function(result){1==result.status&&(result.data.list.dataList&&result.data.list.dataList.length>0?(vm.perListShow=!1,vm.perList=result.data.list.dataList,vm.totalPages=result.data.list.totalPages,vm.scrollShow=!0,vm.maShow=!1):(vm.perList=[],vm.perListShow=!0,vm.maShow=!1))})},vm.pageloading=function(){if(vm.scrollShow){var pagenow=vm.page+1;if(pagenow<=vm.totalPages){if(vm.page=pagenow,vm.appntidno="",vm.appntName="",!vm.keyword)return void TipService.showMsg("请输入推荐人工号","errorAlert",1e3);/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(vm.keyword)?vm.appntidno=vm.keyword:vm.appntName=vm.keyword;var params={openid:vm.openid,cardno:vm.cardNo,appntidno:vm.appntidno,appntName:vm.appntName,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_CARD_BYAPP,function(result){1==result.status&&(0==result.data.list.length?TipService.showMsg("没有更多了",2e3):(vm.perList=vm.perList.concat(result.data.list.dataList),vm.totalPages=result.data.list.totalPages))})}else if(vm.flag1){vm.flag1=!1;var myPopup=$ionicPopup.show({template:"没有更多了",buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){vm.flag1=!0}}]});myPopup.then(function(res){console.log("tapped!",res)})}}},vm.scollBottom=function(){$("#abc").scroll(function(){var c=$("#abc")[0].scrollHeight,a=$("#abc").scrollTop(),b=$("#abc").innerHeight();if(console.info("1:"+a+":2:"+b+":3:"+c),(a+b==c||b+2==c)&&vm.loadmore){vm.loadmore=!1;var timer=$timeout(function(){vm.pageloading(),vm.loadmore=!0,$timeout.cancel(timer)},500)}})},2==vm.show&&$timeout(function(){console.info(1),vm.scollBottom()},500),vm.collectFind=function(){var params={openid:vm.openid,encryptedcardno:vm.cardNo,appntName:vm.appntName,appntidno:vm.appntidno};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){console.info(22),1==result.status&&(1==result.data.code?(vm.encryptedcardno=result.data.cardno,vm.butShow=!1):vm.butShow=!0)})},vm.submits=function(item){var params={openid:vm.openid,encryptedcardno:item.encryptedcardno,appntName:item.appntName,prdName:item.prdName,batchno:item.batchno,referrerName:vm.referrerName,referrerCode:vm.referrerCode,netCode:vm.PbWebsiteCode,netName:vm.PbWebsiteName};CommonRequest.request(params,CONFIG.RECEIVE_ACHIEVEMENT,function(result){if(1==result.status)if("S0002"==result.data.code){TipService.showMsg(result.data.message);for(var i=0;i<vm.perList.length;i++)if(vm.perList[i].cardno==item.cardno)return void(vm.perList[i].drawachievementflag="1")}else"F0002"==result.data.code&&TipService.showMsg(result.data.message)})},vm.submits1=function(item){var params={openid:vm.openid,encryptedcardno:item,appntName:vm.name,prdName:vm.prd_name,batchno:vm.batchNo,referrerName:vm.referrerName,referrerCode:vm.referrerCode,netCode:vm.PbWebsiteCode,netName:vm.PbWebsiteName};CommonRequest.request(params,CONFIG.RECEIVE_ACHIEVEMENT,function(result){1==result.status&&("S0002"==result.data.code?(TipService.showMsg(result.data.message),vm.butShow=!1):"F0002"==result.data.code&&TipService.showMsg(result.data.message))})}}angular.module("app").controller("CardActivationSelectController",CardActivationSelectController),CardActivationSelectController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$ionicLoading","$window","$sce","$scope","$ionicPopup","$location"]}(),function(){function CardCheckIdController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,$timeout,CommonRequest,$ionicLoading){var vm=this;vm.batchNo=$state.params.batchNo,vm.certType="A",$scope.$watch("cardCheckId.certNo",function(newValue,oldValue){newValue&&oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" "))}),vm.next=function(){var param={batchNo:vm.batchNo,plchdCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,""),channelCode:CONFIG.WECHAT?CONFIG.SALE_CHANNEL:"828"};CommonRequest.request(param,CONFIG.CARD_CARD_VALIDATION_CRETNO,function(result){result.status&&1==result.status&&vm.queryCretNoValidationResult(result.data)})};var queryCount=0;vm.queryCretNoValidationResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),queryCount>=20)return queryCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUERY_CRETNO_VALIDATION_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return queryCount++,void $timeout(function(){vm.queryCretNoValidationResult(flowNo)},3e3);if($ionicLoading.hide(),queryCount=0,"1"==result.data.plchdRespCode){var policyData=result.data;policyData.batchNo=vm.batchNo,policyData.verify=!0,PolicyService.setSessionData({policyData:policyData}),$state.go("card-activation")}"0"==result.data.plchdRespCode&&$state.go("activation-success",{respCode:result.data.plchdRespCode,respMsg:result.data.plchdRespDesc})}else $ionicLoading.hide(),queryCount=0},!0)},vm.errorAlert=function(key,val){"certNo"==key&&(1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)))},vm.hide=function(){vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1}}angular.module("app").controller("CardCheckIdController",CardCheckIdController),CardCheckIdController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","$timeout","CommonRequest","$ionicLoading"]}(),function(){function CardDefaultController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService){}angular.module("app").controller("CardDefaultController",CardDefaultController),CardDefaultController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService"]}(),function(){function CardPayController($rootScope,$scope,$state,CONFIG,CommonRequest,$log,PolicyService,TipService,$window,COMMON,$ionicPopup){var vm=this,sessionData=PolicyService.getSessionData();return vm.productData=sessionData.productData,vm.policyData=sessionData.policyData,vm.userData=sessionData.userData,vm.productData&&vm.policyData&&vm.policyData.orderCode?(vm.orderCode=vm.policyData.orderCode,vm.payways=vm.productData.payType,vm.hasDiscount=vm.productData.hasDiscount,-1!=vm.payways.indexOf("109")&&(vm.newPayMode="7"),vm.payAmount=vm.policyData.itemOrderRealPayAmt,vm.BkBrchNo=vm.policyData.BkBrchNo,vm.showModal=function(){var modalInstance=$uibModal.open({templateUrl:"app/module/product/product-pay/pay-modal/pay-modal.html",controller:"PayModalController",controllerAs:"payModal",size:"md",scope:$scope});modalInstance.result.then(function(check){vm.checkContract=check},function(){$log.info("Modal dismissed at: "+new Date)})},vm.pay=function(){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var params={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:vm.BkBrchNo,orderCode:vm.orderCode,payAmount:vm.payAmount,payType:vm.payment,platForm:platForm,payChannel:CONFIG.SALE_CHANNEL};CommonRequest.request(params,CONFIG.PAY_SERVICE,function(result){1==result.status&&($window.location.href=CONFIG.PAY_SERVICE_ADDRESS+result.data.payUrl+"?tokenId="+result.data.tokenId+"&platForm="+params.platForm+"&payChannel="+params.payChannel+"&orderCode="+vm.orderCode+"&payAmount="+vm.payAmount+"&payType="+vm.payment+"&branchCode="+vm.BkBrchNo+"&openid="+$rootScope.openid)})},COMMON.getCommonBank(vm.BkBrchNo,"1",function(bankList){
vm.bankList=bankList,vm.newGetBk=vm.bankList[0]}),vm.paytra=function(){var params={accountName:vm.newGetAccName,bankCode:vm.newGetBk.bankCode,bankName:vm.newGetBk.bankName,accountNumber:vm.newGetAccCode,orderCode:vm.orderCode,payType:vm.newPayMode,pbApplName:vm.newGetAccName};CommonRequest.request(params,CONFIG.ACCREDIT_TRANSFER_SERVICE,function(result){1==result.status?(vm.holdStatus=result.data.holdStatus,vm.downBankcount(function(objBankcount){var bankdata={OppAct:vm.newGetAccCode};CommonRequest.request(bankdata,CONFIG.GYL_CONTRACT_QRY,function(result){if(-1==vm.newGetBk.bankCode.indexOf("00051")){2!=result.data.SignState&&(objBankcount[0]=vm.newGetAccCode);var data={objBankcount:objBankcount};PolicyService.control({state:"product-purchase-policy-agreement",control:"data",data:data})}"1"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"5"}):"2"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"4"}):"3"==vm.holdStatus?$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"5"}):"0"==vm.holdStatus&&$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"6"})})})):0==result.status&&"Y1200044014"==result.error.code&&$state.go("product-pay-success",{orderCode:vm.orderCode,payResult:"8"})})},void(vm.ensurePay=function(payment){"109"==payment?vm.paytra():vm.pay()})):void $state.go("tab.mall")}angular.module("app").controller("CardPayController",CardPayController),CardPayController.$inject=["$rootScope","$scope","$state","CONFIG","CommonRequest","$log","PolicyService","TipService","$window","COMMON","$ionicPopup"]}(),function(){function CardPerformListController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$ionicLoading,$window,$sce,$ionicPopup){var vm=this;vm.show="2",vm.name=$state.params.name||"",vm.openid=$state.params.openid||"",vm.cardNo=$state.params.cardNo||"",vm.referrercode=$state.params.referrercode||"",vm.perListShow=!1,vm.appntName="",vm.appntidno="",vm.loadmore=!0,vm.flag=!1,vm.flag1=!0,vm.perList=[],vm.page=1,vm.size="10",vm.init=function(){var params={openid:vm.openid,encryptedcardno:vm.cardNo,appntName:vm.appntName,appntidno:vm.appntidno,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){1==result.status&&(0==result.data.list.dataList.length?TipService.showMsg("暂无历史业绩",2e3):(vm.perList=result.data.list.dataList,vm.totalPages=result.data.list.totalPages,vm.scrollShow=!0))})},vm.init(),vm.search=function(){if(vm.appntidno="",vm.appntName="",!vm.keyword)return void TipService.showMsg("请输入客户姓名或证件号码","errorAlert",1e3);/(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/.test(vm.keyword)?vm.appntidno=vm.keyword:vm.appntName=vm.keyword,vm.keyword,vm.page=1;var params={openid:vm.openid,encryptedcardno:vm.cardNo,appntidno:vm.appntidno,appntName:vm.appntName,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){1==result.status&&(result.data.list.dataList.length>0?(vm.perListShow=!1,vm.perList=result.data.list.dataList,vm.totalPages=result.data.list.totalPages,vm.scrollShow=!0):(vm.perList=result.data.list.dataList,vm.perListShow=!0))})},vm.pageloading=function(){if(vm.scrollShow){var pagenow=vm.page+1;if(pagenow<=vm.totalPages){vm.page=pagenow;var params={openid:vm.openid,encryptedcardno:vm.cardNo,appntidno:vm.appntidno,appntName:vm.appntName,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){1==result.status&&(0==result.data.list.length?TipService.showMsg("没有更多了",2e3):(vm.perList=vm.perList.concat(result.data.list.dataList),vm.totalPages=result.data.list.totalPages))})}else if(vm.flag1){vm.flag1=!1;var myPopup=$ionicPopup.show({template:"没有更多了",buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){vm.flag1=!0}}]});myPopup.then(function(res){console.log("tapped!",res)})}}},vm.scollBottom=function(){$("#abcd").scroll(function(){var c=$("#abcd")[0].scrollHeight,a=$("#abcd").scrollTop(),b=$("#abcd").innerHeight();if(console.info("1:"+a+":2:"+b+":3:"+c),(a+b==c||b+2==c)&&vm.loadmore){vm.loadmore=!1;var timer=$timeout(function(){vm.pageloading(),vm.loadmore=!0,$timeout.cancel(timer)},500)}})},vm.scollBottom(),vm.back=function(){history.go(-1)}}angular.module("app").controller("CardPerformListController",CardPerformListController),CardPerformListController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$ionicLoading","$window","$sce","$ionicPopup"]}(),function(){function CardSelectionController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location){var vm=this;vm.txCode="CCBSB100";var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||"",vm.policyData=sessionData.policyData||{},vm.cardNo=$state.params.cardNo,vm.cardPwd=$state.params.cardPwd,vm.batchNo=$location.search().batchNo||"",vm.activationDisabled=!1,vm.minDate=new Date,vm.maxDate=new Date(vm.minDate.getTime()+2592e6),vm.relation="01",vm.policyData.plchdNm&&(vm.name=vm.policyData.plchdNm,vm.nameDisabled=!0),vm.certType="A",vm.policyData.plchdCrdtNo&&(vm.certNo=VALIDATION.certNoFormat(vm.policyData.plchdCrdtNo),vm.certNoDisabled=!0),vm.policyData.plchdMoveTelNo?vm.phone=VALIDATION.phoneFormat(vm.policyData.plchdMoveTelNo):vm.phone="",vm.email=vm.policyData.plchdEmailAdr||"",vm.certExpireType=!1,vm.insureCertExpireType=!1,vm.minStartDate=new Date((new Date).getTime()+864e5),$scope.$watch("cardSelection.phone",function(newValue,oldValue){newValue&&oldValue&&newValue.length>oldValue.length&&(3!=newValue.length&&8!=newValue.length||(vm.phone=newValue+" "))}),$scope.$watch("cardSelection.certNo",function(newValue,oldValue){if(newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" ")),!VALIDATION.idCheck(newValue))return;if(vm.gender=VALIDATION.getSex(newValue)+"",vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.age=VALIDATION.getAgeByBirth(vm.birthday),"0"==vm.productData.minHolderAge)return void(parseInt(((new Date).getTime()-vm.birthday.getTime())/864e5)<30?vm.holdAgeError=!0:vm.holdAgeError=!1);vm.age<vm.productData.minHolderAge||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1}}),$scope.$watch("cardSelection.certNo",function(newValue,oldValue){if(newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" ")),!VALIDATION.idCheck(newValue))return;if(vm.insureGender=VALIDATION.getSex(newValue)+"",vm.insureBirthday=new Date(VALIDATION.getBirthday(newValue)),vm.insureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),"0"==vm.productData.minAge)return void(parseInt(((new Date).getTime()-vm.insureBirthday.getTime())/864e5)<30?vm.insureAgeError=!0:vm.insureAgeError=!1);vm.insureAge<vm.productData.minAge||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1}}),$scope.$watch("cardSelection.phoneCode",function(newValue,oldValue){newValue.length<6?vm.phoneCodeError=!0:vm.phoneCodeError=!1});var tipStartTime,tipSecTime;vm.startTimeChange=function($invalid){tipStartTime=$filter("date")(new Date(vm.startTime).getTime()+864e5,"yyyy年M月d日"),tipSecTime=$filter("date")(vm.startTime,"yyyy年M月d日"),TipService.showMsg('保单将于<span class="fb"> '+tipStartTime+"0时 </span>生效<br/>若非您期望日期，请重新选择","cardSelection"),vm.startTime=vm.startTime+"   24时"},vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"1"==gender?"04":"05":"01"},vm.closeAndDel=function(closeData){"name"==closeData?vm.name="":"certNo"==closeData?vm.certNo="":"email"==closeData?vm.email="":"phone"==closeData&&(vm.phone="")},vm.healthDetail=function(){COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")},$scope.$on("notice-choice",function(event,result){1==result?(vm.agree=!1,TipService.showMsg("抱歉，您未能通过投保审核，请选择其他保险卡","errorAlert")):0==result&&(vm.agree=!0)}),vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr,"M01"==vm.materialArr[0].materialType&&(vm.description="条款"),vm.materialList()})}},vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductDetail=function(id){vm.activationDisabled=!1;var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),PolicyService.setSessionData({productData:result.data})}vm.getProductMaterials(id)}})},vm.activationApply=function(){if(!vm.cardNo&&!vm.cardPwd&&!vm.batchNo)return vm.activeResult=vm.policyData,vm.pic_name="../statics/cardTemp/"+vm.activeResult.prdId+".jpg",void vm.getProductDetail(vm.policyData.prdId);var param={channelCode:CONFIG.SALE_CHANNEL};vm.cardNo&&vm.cardPwd?(param.plchdCardNo=vm.cardNo,param.plchdCardPwd=vm.cardPwd):vm.batchNo&&(param.batchNo=vm.batchNo),CommonRequest.request(param,CONFIG.CARD_SELECTION_APPLY,function(result){result.status&&1==result.status?4==result.data.respCode?vm.queuryCardActiveResult(result.data.flowNo):$state.go("activation-success",{respCode:"0",respMsg:result.data.respDesc}):$state.go("activation-success",{respCode:"0",respMsg:"系统繁忙，请稍后！"})})};var activationCount=0;vm.queuryCardActiveResult=function(data){var flowNo=data;if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),activationCount>=20)return activationCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_ACTIVE_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return activationCount++,void $timeout(function(){vm.queuryCardActiveResult(flowNo)},3e3);$ionicLoading.hide(),activationCount=0,"1"==result.data.plchdRespCode&&(vm.activeResult=result.data,vm.pic_name="../statics/cardTemp/"+vm.activeResult.prdId+".jpg",vm.getProductDetail(result.data.prdId)),"2"==result.data.plchdRespCode&&$state.go("card-check-id",{batchNo:vm.batchNo}),"0"==result.data.plchdRespCode&&$state.go("activation-success",{respCode:result.data.plchdRespCode,respMsg:result.data.plchdRespDesc})}else $ionicLoading.hide(),activationCount=0},!0)},vm.activationApply(),vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.draftOrderCode=function(){var params={prdId:vm.activeResult.prdId,mobileNo:vm.phone.replace(/\s+/g,""),smsCode:vm.phoneCode};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){1==result.status&&vm.checkHold(result.data.orderCode)})},vm.checkHold=function(orderCode){var rcgnCrdtExpDt,plchdCrdtExpDt=vm.certExpireType?"20991231":$filter("date")(vm.certExpireDate,"yyyyMMdd");rcgnCrdtExpDt="01"==vm.relation?plchdCrdtExpDt:vm.insureCertExpireType?"20991231":$filter("date")(vm.insureCertExpireDate,"yyyyMMdd");var insPolcyIntndEfDt=$filter("date")((new Date).toLocaleDateString(),"yyyyMMdd"),params={prdId:vm.activeResult.prdId,orderCode:orderCode,plchdCardNo:vm.cardNo,insPolcyIntndEfDt:insPolcyIntndEfDt,plchdBrthDt:$filter("date")(vm.birthday,"yyyyMMdd"),plchdCrdtExpDt:plchdCrdtExpDt,plchdCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,""),plchdCrdtTpCd:"A",plchdEmailAdr:vm.email,plchdGndCd:vm.gender,plchdMoveTelNo:vm.phone.replace(/\s+/g,""),plchdNatCd:"0156",plchdNm:vm.name,plchdAndRcgnReTpCd:vm.checkRelation(vm.relation,vm.gender),rcgnBrthDt:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),rcgnCrdtExpDt:rcgnCrdtExpDt,rcgnCrdtNo:"01"==vm.relation?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),rcgnCrdtTpCd:"A",rcgnEmail:vm.email,rcgnGndCd:"01"==vm.relation?vm.gender:vm.insureGender,rcgnNatCd:"0156",rcgnNm:"01"==vm.relation?vm.name:vm.insureName,channelCode:CONFIG.SALE_CHANNEL,plchdProvCd:vm.activeResult.plchdProvinceCode,plchdCityCd:vm.activeResult.plchdCityCode,plchdCntyAndDstcCd:vm.activeResult.plchdDistrictCode,rsdntTpCd:vm.activeResult.plchdCityFlag,appNoNum:vm.activeResult.plchdPrtCount,totInsPremAmt:vm.activeResult.initPyFAmt,coPyFAmt:vm.activeResult.coPyFAmt,interfaceCode:vm.activeResult.funcFlag,batchNo:vm.activeResult.batchNo||vm.batchNo||""};CommonRequest.request(params,CONFIG.CARD_SELECT_HOLD,function(result){if(result&&1==result.status){var json=JSON.parse(result.data);if(1==json.respCode||"1"==json.respCode)$state.go("card-select-sucess",{});else{if(2==json.respCode||"2"==json.respCode)return void TipService.showMsg(json.respDesc,"useElse");$state.go("activation-success",{respCode:"5",respMsg:json.respDesc})}}})};var checkHoldResultCount=0;vm.checkHoldResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),checkHoldResultCount>=20)return checkHoldResultCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_CHECKHOLDRESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return checkHoldResultCount++,void $timeout(function(){vm.checkHoldResult(flowNo)},3e3);if($ionicLoading.hide(),checkHoldResultCount=0,"1"==result.data.respCode){var policyData={name:vm.name,cardNo:vm.cardNo||result.data.cardNo,orderCode:result.data.orderCode,batchNo:vm.batchNo};PolicyService.setSessionData({policyData:policyData}),"0"==result.data.personalPay&&(PolicyService.setSessionData({policyData:{orderCode:result.data.orderCode,itemOrderRealPayAmt:result.data.totInsPremAmt,BkBrchNo:result.data.orgCode}}),$state.go("card-pay")),"1"==result.data.personalPay&&$state.go("activation-success",{respCode:result.data.respCode,respMsg:result.data.respMsg})}"0"==result.data.respCode&&$state.go("activation-success",{respCode:"2",respMsg:result.data.respMsg})}else $ionicLoading.hide(),checkHoldResultCount=0},!0)},vm.next=function(invalid){return invalid||vm.holdAgeError||vm.insureAgeError?void TipService.showMsg("请完善客户信息","errorAlert"):vm.agree?void vm.draftOrderCode():void TipService.showMsg("请先阅读并同意《告知事项》《产品条款》《保障须知》","errorAlert")},vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",$rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.dragShow=function(){if(vm.phone){if(vm.showDrag)return;vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg()}else vm.showDrag=!1,vm.doAnimate=!0},vm.dragShow(),$rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||vm.getdragimg()}),vm.dragDisabled=!0,$rootScope.$on("drag-down",function(event,result){vm.dragDisabled=!1,vm.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)});var alertMsg,TIPS=$rootScope.TIPS;vm.errorAlert=function(key,val){"name"==key&&(1==val.invalid?alertMsg="您输入的真实姓名格式不正确":1==val.length&&(alertMsg="您输入的真实姓名过长（最多支持30个汉字）")),"phone"==key&&1==val&&(alertMsg="您输入的手机号码格式不正确"),"certNo"!=key&&"insureCertNo"!=key||(1==val.invalid2?alertMsg="请输入正确的证件号码":1==val.length?alertMsg="您输入的证件号码过长":1==val.invalid?alertMsg="您输入的证件号码格式不正确":1==vm.holdAgeError?alertMsg="被保险人年龄范围不符合要求":1==vm.insureAgeError&&(alertMsg="子女年龄范围不符合要求")),"email"==key&&(1==val.invalid?alertMsg="您输入的电子邮箱格式不正确":1==val.length&&(alertMsg="您输入的邮箱长度不符")),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符"),TipService.showMsg(alertMsg,"errorAlert")},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}}}angular.module("app").controller("CardSelectionController",CardSelectionController),CardSelectionController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location"]}(),function(){function newCardActivationController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup,$http,$log){var vm=this;vm.txCode="CCBSB100",TipService.showMsg("您即将进入投保流程，请认真阅读保险条款。为保障您的权益，您的投保操作流程将被记录，请知悉！");var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||"",vm.policyData=sessionData.policyData||{},vm.cardNo=$state.params.cardNo,vm.cardPwd=$state.params.cardPwd,vm.batchNo=$state.params.batchNo,vm.conId=$location.search().cId||"",vm.busssIo=$location.search().busIo||"",vm.cipherText=$location.search().cipText||"",vm.yzshow="",CONFIG.WECHAT?vm.yzshow=!1:vm.yzshow=!0,vm.getBat=function(){var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){vm.result1=res.cardSaleType})},vm.getBat();var fromPage="collection"===sessionStorage.getItem("fromPage");if(vm.fromPage=fromPage,!function(){if(fromPage)return!0;var getBatchCollection={url:CONFIG.DOMAIN+"/statics/json/batch-collection.json",method:"GET"};CommonRequest.request({},getBatchCollection,function(res){for(var key in res)if(Object.hasOwnProperty.call(res,key))for(var arr=res[key],i=0;i<arr.length;i++)if(arr[i]===vm.batchNo)return window.location.href=CONFIG.DOMAIN+"/elife-card/#/card/activity-collection/"+key})}(),document.onreadystatechange=function(){console.info(document.readyState),"complete"!=document.readyState?document.body.style.display="none":CONFIG.WECHAT?document.body.style.display="none":document.body.style.display="block"},CONFIG.WECHAT)return void($window.location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+CONFIG.app_id+"&redirect_uri="+CONFIG.redirect_uri+"%2Felife-wechat%2F%23%2Fproduct%2Fproduct-purchase%2Fcard-activation%2FcardNo="+vm.cardNo+"%2FcardPwd="+vm.cardPwd+"?batchNo="+vm.batchNo+"&response_type=code&scope=snsapi_base&state=test#wechat_redirect");vm.activationDisabled=!0,vm.minDate=new Date,vm.maxDate=new Date(vm.minDate.getTime()+2592e6),vm.relation="01",vm.policyData.plchdNm&&(vm.name=vm.policyData.plchdNm,vm.nameDisabled=!0),vm.certType="A",vm.insureDisabled=!1,vm.policyData.plchdCrdtNo&&(vm.certNo=VALIDATION.certNoFormat(vm.policyData.plchdCrdtNo),vm.certNoDisabled=!0,fromPage&&(vm.insureDisabled=!0)),vm.policyData.insureCertNo&&(vm.relation="02",vm.insureCertNo=vm.policyData.insureCertNo,vm.insuerCertNoDisabled=!0),vm.policyData.plchdMoveTelNo?vm.phone=VALIDATION.phoneFormat(vm.policyData.plchdMoveTelNo):vm.phone="",vm.email=vm.policyData.plchdEmailAdr||"",vm.certExpireType=!1,vm.insureCertExpireType=!1,vm.minStartDate=new Date((new Date).getTime()+864e5),$scope.$watch("newcardActivation.phone",function(newValue,oldValue){newValue&&oldValue&&newValue.length>oldValue.length&&(3!=newValue.length&&8!=newValue.length||(vm.phone=newValue+" "))}),$scope.$watch("newcardActivation.certNo",function(newValue,oldValue){if($log.info("newValue gender",newValue),newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" ")),!VALIDATION.idCheck(newValue))return void $log.info("newValue gender return");if(vm.gender=VALIDATION.getSex(newValue)+"",$log.info("gender",vm.gender),vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.age=VALIDATION.getAgeByBirth(vm.birthday),"0"==vm.productData.minHolderAge)return void(parseInt(((new Date).getTime()-vm.birthday.getTime())/864e5)<30||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1);vm.age<vm.productData.minHolderAge||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1}}),$scope.$watch("newcardActivation.insureCertNo",function(newValue,oldValue){if($log.info("newValue insureGender",newValue),newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.insureCertNo=newValue+" ")),!VALIDATION.idCheck(newValue))return void $log.info("newValue insureGender return");if(vm.insureGender=VALIDATION.getSex(newValue)+"",$log.info("insureGender",vm.insureGender),vm.insureBirthday=new Date(VALIDATION.getBirthday(newValue)),$rootScope.nextInsureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),vm.insureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),"0"==vm.productData.minAge)return void(parseInt(((new Date).getTime()-vm.insureBirthday.getTime())/864e5)<30||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1);vm.insureAge<vm.productData.minAge||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1}});var tipStartTime,tipSecTime;vm.startTimeChange=function($invalid){tipStartTime=$filter("date")(new Date(vm.startTime).getTime()+864e5,"yyyy年M月d日"),tipSecTime=$filter("date")(vm.startTime,"yyyy年M月d日"),fromPage||TipService.showMsg('保单将于<span class="fb"> '+tipStartTime+"0时 </span>生效<br/>若非您期望日期，请重新选择","newcardActivation"),vm.startTimeNew=$filter("date")(new Date(new Date(vm.startTime).getTime()-864e5),"yyyy-MM-dd"),vm.startTimeT=vm.startTimeNew+"   24:00:00",vm.startTime=vm.startTime+"   0时"},fromPage&&(vm.startTime=$filter("date")(new Date(+new Date+864e5),"yyyy-MM-dd"),vm.startTimeChange()),vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"1"==gender?"04":"05":"01"},vm.healthDetail=function(open){vm.healthDetail=function(open){var flag=1;vm.agree&&(flag=0,COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")),open&&flag&&COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")}},$scope.$on("notice-choice",function(event,result){1==result?(vm.agree=!1,TipService.showMsg("抱歉，您未能通过投保审核，请选择其他保险卡","errorAlert")):0==result&&(vm.agree=!0)}),$scope.$on("notice-choice1",function(event,result){if(12==result)if(console.info("说道"),COMMON.hideModal(),"01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?(vm.draftOrderCode(),COMMON.hideModal()):COMMON.hideModal()})}else vm.draftOrderCode()}),$scope.$on("notice-choice2",function(event,result){if(12==result)if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():COMMON.hideModal()})}else vm.draftOrderCode()}),vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr,"M01"==vm.materialArr[0].materialType&&(vm.description="条款"),vm.materialList()})}},vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductDetail=function(id){vm.activationDisabled=!1;var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data,console.log(vm.productData),console.log(result.data);var _vm$productData=vm.productData,prd_id=_vm$productData.prd_id,prd_name=_vm$productData.prd_name;$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope,{isCard:!0,prd_id:prd_id,prd_name:prd_name});var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),PolicyService.setSessionData({productData:result.data})}vm.getProductMaterials(id)}})},vm.activationApply=function(){if(!vm.cardNo&&!vm.cardPwd&&!vm.batchNo)return vm.activeResult=vm.policyData,vm.pic_name="../../statics/cardTemp/"+vm.activeResult.prdId+".jpg",void vm.getProductDetail(vm.policyData.prdId);var param={channelCode:CONFIG.WECHAT?CONFIG.SALE_CHANNEL:"828"};vm.cardNo&&vm.cardPwd?(param.plchdCardNo=vm.cardNo,param.plchdCardPwd=vm.cardPwd):vm.batchNo&&(param.batchNo=vm.batchNo),CommonRequest.request(param,CONFIG.CARD_ACTIVATION_APPLY,function(result){result.status&&1==result.status&&vm.queuryCardActiveResult(result.data)})};var activationCount=0;vm.queuryCardActiveResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),activationCount>=20)return activationCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_ACTIVE_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return activationCount++,void $timeout(function(){vm.queuryCardActiveResult(flowNo)},3e3);if($ionicLoading.hide(),activationCount=0,vm.activeResult=result.data,vm.activeResult.cardSaleType)for(var item in vm.result1)vm.result1[item]==vm.activeResult.cardSaleType&&$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope);if("2"==result.data.cardSaleType&&$state.go("activation-success",{respCode:"0",respMsg:"请使用龙支付专属链接进行激活"}),"1"==result.data.plchdRespCode&&(localStorage.setItem("cardSaleType",result.data.cardSaleType),vm.activeResult=result.data,vm.pic_name="../../statics/cardTemp/"+vm.activeResult.prdId+".jpg",vm.getProductDetail(result.data.prdId),$rootScope.userData&&"A"==$rootScope.userData.cretType)){var alertPopup=$ionicPopup.confirm({cssClass:"popup-icon",template:"您已绑定建信人寿公众号，是否使用“"+$rootScope.userData.customerName+"”绑定信息激活保险卡",okText:"使用",cancelText:"不使用"});alertPopup.then(function(res){res&&(vm.name=$rootScope.userData.customerName,vm.certNo=VALIDATION.certNoFormat($rootScope.userData.cretNo),vm.phone=VALIDATION.phoneFormat($rootScope.userData.phoneNo),vm.dragShow())})}"2"==result.data.plchdRespCode&&$state.go("card-check-id",{batchNo:vm.batchNo}),"0"==result.data.plchdRespCode&&$state.go("activation-success",{respCode:result.data.plchdRespCode,respMsg:result.data.plchdRespDesc})}else $ionicLoading.hide(),activationCount=0},!0)},vm.querySelect=function(){if(console.info("我是天才1"),vm.conId||vm.busssIo||vm.cipherText){var params={cid:vm.conId,bus:vm.busssIo,ciText:vm.cipherText};CommonRequest.request(params,CONFIG.CUSINFOEN,function(result){if(1!=result.status)return void $state.go("card-default");var data=JSON.parse(result.data);vm.name=data.recogNizee,vm.certNo=data.idEntity,vm.phone=data.Tel,vm.phone&&(vm.showDrag=!1),$("#regname").attr("readonly","readonly"),$("#regcard").attr("readonly","readonly"),vm.activationApply()})}else vm.activationApply()},vm.querySelect(),vm.insuYearFlag="",vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){vm.insuYearFlag=plans[0].insuYearFlag;for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日"),
vm.insuYearFlag=plans[0].insuYearFlag;for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.mobileCheck=function(){var params={custName:vm.name,cretNo:vm.certNo.replace(/\s+/g,""),cretType:vm.certType,phoneNo:vm.phone.replace(/\s+/g,""),prodId:vm.activeResult.prdId};CommonRequest.request(params,CONFIG.CARD_ACTIVATION_POLICY_MOBILECHECK,function(result){"1"==result.status?vm.checkHold(result.data.orderCode):result.error.message})},vm.draftOrderCode=function(){var params={prdId:vm.activeResult.prdId,mobileNo:vm.phone.replace(/\s+/g,""),smsCode:vm.phoneCode};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){if(1==result.status){if($scope.traceId=window.traceId,console.log($scope.traceId+":"),$scope.traceId)try{var traceData=angular.toJson($rootScope.traceData);sessionStorage.setItem("elife-traceData",traceData),_yfx_sendorderid(vm.batchNo+result.data.orderCode,result.data.orderCode)}catch(e){console.log("finish trace error: "+e.message)}vm.mobileCheck()}else COMMON.hideModal()})},vm.checkHold=function(orderCode){var rcgnCrdtExpDt,plchdCrdtExpDt=vm.certExpireType?"20991231":$filter("date")(vm.certExpireDate,"yyyyMMdd");rcgnCrdtExpDt="01"==vm.relation?plchdCrdtExpDt:vm.insureCertExpireType?"20991231":$filter("date")(vm.insureCertExpireDate,"yyyyMMdd");var insPolcyIntndEfDt=$filter("date")(vm.startTime.substring(0,10),"yyyyMMdd"),params={prdId:vm.activeResult.prdId,orderCode:orderCode,plchdCardNo:vm.cardNo,insPolcyIntndEfDt:insPolcyIntndEfDt,plchdBrthDt:$filter("date")(vm.birthday,"yyyyMMdd"),plchdCrdtExpDt:plchdCrdtExpDt,plchdCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,""),plchdCrdtTpCd:"A",plchdEmailAdr:vm.email,plchdGndCd:vm.gender,plchdMoveTelNo:vm.phone.replace(/\s+/g,""),plchdNatCd:"0156",plchdNm:vm.name,plchdAndRcgnReTpCd:vm.checkRelation(vm.relation,vm.gender),rcgnBrthDt:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),rcgnCrdtExpDt:rcgnCrdtExpDt,rcgnCrdtNo:"01"==vm.relation?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),rcgnCrdtTpCd:"A",rcgnEmail:vm.email,rcgnGndCd:"01"==vm.relation?vm.gender:vm.insureGender,rcgnNatCd:"0156",rcgnNm:"01"==vm.relation?vm.name:vm.insureName,channelCode:CONFIG.WECHAT?CONFIG.SALE_CHANNEL:"828",plchdProvCd:vm.activeResult.plchdProvinceCode,plchdCityCd:vm.activeResult.plchdCityCode,plchdCntyAndDstcCd:vm.activeResult.plchdDistrictCode,rsdntTpCd:vm.activeResult.plchdCityFlag,appNoNum:vm.activeResult.plchdPrtCount,totInsPremAmt:vm.activeResult.initPyFAmt,coPyFAmt:vm.activeResult.coPyFAmt,interfaceCode:vm.activeResult.funcFlag,batchNo:vm.activeResult.batchNo||vm.batchNo||"",insurear:vm.insuYearT,insurearflag:vm.insuYearFlag,insValiDate:vm.startTimeT};$log.info(params),CommonRequest.request(params,CONFIG.CARD_CHECK_HOLD,function(result){result&&1==result.status&&result.data&&""!=result.data&&vm.checkHoldResult(result.data)})};var checkHoldResultCount=0;vm.checkHoldResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),checkHoldResultCount>=20)return checkHoldResultCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_CHECKHOLDRESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return checkHoldResultCount++,void $timeout(function(){vm.checkHoldResult(flowNo)},3e3);var endTime=result.data.insEndDate;if($ionicLoading.hide(),checkHoldResultCount=0,"1"==result.data.respCode){var policyData={name:vm.name,cardNo:vm.cardNo||result.data.cardNo,orderCode:result.data.orderCode,tipStartTimelhh:tipStartTime,insurYearArrlhh:vm.insurYearArr,insEndDate:endTime,batchNo:vm.batchNo,priCardNo:result.data.priCardNo};if(PolicyService.setSessionData({policyData:policyData}),"0"==result.data.personalPay){PolicyService.setSessionData({policyData:{orderCode:result.data.orderCode,itemOrderRealPayAmt:result.data.totInsPremAmt,BkBrchNo:result.data.orgCode}});var payReqData={orderCode:policyData.orderCode,pbCertNo:policyData.PbHoldId,branchCode:policyData.BkBrchNo||result.data.orgCode,payAmount:policyData.itemOrderRealPayAmt||result.data.totInsPremAmt};CommonRequest.request(payReqData,CONFIG.CHECK_PAY_CHANNEL,function(result){if("1"==result.status)if("01"==result.data.prdPayPlatFormCode){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var data=PolicyService.getSessionData().policyData,payData={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:data.BkBrchNo,orderCode:data.orderCode,payAmount:data.itemOrderRealPayAmt,platForm:platForm,browserType:CONFIG.WECHAT?"01":"02",opendId:$rootScope.openid||"blank",channelCode:CONFIG.SALE_CHANNEL,paySign:result.data.paySign};CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE_POST,function(result){if("1"==result.status){var data=result.data;"000000"==data.payStatus&&(window.location.href=data.payRedirectUrl)}})}else"00"==result.data.prdPayPlatFormCode&&$state.go("card-pay")})}"1"==result.data.personalPay&&$state.go("activation-success",{respCode:result.data.respCode,respMsg:result.data.respMsg})}"0"==result.data.respCode&&$state.go("activation-success",{respCode:"2",respMsg:result.data.respMsg})}else $ionicLoading.hide(),checkHoldResultCount=0},!0)},vm.next=function(invalid){if(!vm.productData.payType)return void TipService.showMsg("该订单没有可用的支付方式，请联系系统管理员进行维护！");if(invalid||vm.holdAgeError||vm.insureAgeError)return void TipService.showMsg("请完善投保信息","errorAlert");if(!vm.agree)return void TipService.showMsg("请先阅读并同意《告知事项》《产品条款》《投保声明书》《投保须知》","errorAlert");if($rootScope.nextRelation=vm.relation,vm.productData.hotTip&&vm.productData.hotTip.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-ss/card-activation-notice.html");else if(vm.productData.exoneration&&vm.productData.exoneration.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-sr/card-activation-notice.html");else if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():console.info(2)})}else vm.draftOrderCode()},vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",$rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.dragShow=function(){if(vm.phone){if(vm.showDrag)return;vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg()}else vm.showDrag=!1,vm.doAnimate=!0},vm.dragShow(),$rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||vm.getdragimg()}),vm.dragDisabled=!0,$rootScope.$on("drag-down",function(event,result){vm.dragDisabled=!1,vm.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)});var alertMsg,TIPS=$rootScope.TIPS;vm.errorAlert=function(key,val){"name"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.USER_NAME_INVALID:1==val.length&&(alertMsg=TIPS.COMMON.USER_NAME_LENGTH_ERROR)),"phone"==key&&1==val&&(alertMsg=TIPS.COMMON.PHONE_INVALID),"certNo"!=key&&"insureCertNo"!=key||(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID2:1==val.length?alertMsg=TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?alertMsg=TIPS.COMMON.ID_INVALID:1==vm.holdAgeError?alertMsg="投保人年龄范围不符合要求":1==vm.insureAgeError&&(alertMsg="子女年龄范围不符合要求")),"email"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符")),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符"),TipService.showMsg(alertMsg,"errorAlert")},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}}}angular.module("app").controller("newCardActivationController",newCardActivationController),newCardActivationController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup","$http","$log"]}(),function(){function newAppCardActivationController($scope,PolicyService,$state,$rootScope,CommonRequest,CONFIG,COMMON,TipService,$timeout,VALIDATION,$ionicLoading,$filter,$location,$window,$ionicPopup,$http,$log){var vm=this;TipService.showMsg("您即将进入投保流程，请认真阅读保险条款。为保障您的权益，您的投保操作流程将被记录，请知悉！"),vm.showBack="page-change"==$rootScope.from_name,console.info(localStorage.getItem("userInfo")),vm.goAct=function(){console.info($rootScope.from_name),console.info($rootScope.from_param),$state.go($rootScope.from_name,$rootScope.from_param)},vm.getBat=function(){var getBatUrl={url:CONFIG.DOMAIN+"/statics/json/ActBat.json",method:"GET"};CommonRequest.request({},getBatUrl,function(res){var result=res;vm.payWay=result.payWay,vm.result1=res.cardSaleType})},vm.getBat(),vm.verify=!0,vm.tbWho=localStorage.getItem("card-tbWho"),vm.tbName=localStorage.getItem("card-tbName"),vm.tbCard=localStorage.getItem("card-tbCard"),vm.tbCardDataLong=localStorage.getItem("card-tbCardDataLong"),vm.tbCardData=localStorage.getItem("card-tbCardData"),vm.tbEmail=localStorage.getItem("card-tbEmail"),vm.tbPhone=localStorage.getItem("card-tbPhone"),vm.bbName=localStorage.getItem("card-bbName"),vm.bbCard=localStorage.getItem("card-bbCard"),vm.bbCardDataLong=localStorage.getItem("card-bbCardDataLong"),vm.bbCardData=localStorage.getItem("card-bbCardData"),vm.tbAgree=localStorage.getItem("card-agree"),vm.conId=$location.search().cId||"",vm.busssIo=$location.search().busIo||"",vm.cipherText=$location.search().cipText||"",localStorage.getItem("card-tbPhone")&&"y"==localStorage.getItem("userInfoGet")?(vm.fanxian="y",vm.showDrag=!1,vm.verify=!1):vm.showDrag=!0,vm.agree=eval(vm.tbAgree),vm.startTime=localStorage.getItem("card-startTime")?localStorage.getItem("card-startTime"):"",vm.startTimeNew=localStorage.getItem("card-startTimeNew")?localStorage.getItem("card-startTimeNew"):"",vm.relation=vm.tbWho?vm.tbWho:"",vm.name=vm.tbName||"",vm.certNo=vm.tbCard?vm.tbCard:"",vm.certExpireType=vm.tbCardDataLong?vm.tbCardDataLong:"",vm.certExpireDate=vm.tbCardData?new Date(vm.tbCardData):"",vm.email=vm.tbEmail?vm.tbEmail:"",vm.insureName=vm.bbName?vm.bbName:"",vm.insureCertNo=vm.bbCard?vm.bbCard:"",vm.insureCertExpireType=vm.bbCardDataLong?vm.bbCardDataLong:"",vm.insureCertExpireDate=vm.bbCardData?new Date(vm.bbCardData):"",localStorage.setItem("card-tbWho",""),localStorage.setItem("card-tbName",""),localStorage.setItem("card-tbCard",""),localStorage.setItem("card-tbCardDataLong",""),localStorage.setItem("card-tbCardData",""),localStorage.setItem("card-tbEmail",""),localStorage.setItem("card-tbPhone",""),localStorage.setItem("card-bbName",""),localStorage.setItem("card-bbCard",""),localStorage.setItem("card-bbCardDataLong",""),localStorage.setItem("card-bbCardData",""),localStorage.setItem("card-agree",""),localStorage.setItem("card-startTime",""),localStorage.setItem("card-startTimeNew",""),localStorage.setItem("userInfoGet",""),vm.txCode="CCBSB100";var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData||"",vm.policyData=sessionData.policyData||{},vm.cardNo=$state.params.cardNo,vm.cardPwd=$state.params.cardPwd,vm.batchNo=$state.params.batchNo,vm.userInfo=$state.params.userInfo||"",vm.isreturnMob=!1,vm.isShowCode=!0,vm.userInfoPhone="",vm.nameDisable=!1,vm.cardDisable=!1,vm.mobDisable=!1,vm.letFocus=!1,vm.userDev=navigator.userAgent,vm.yzshow=!CONFIG.WECHAT;var fromPage="collection"===sessionStorage.getItem("fromPage");vm.fromPage=fromPage,!function(){if(fromPage)return localStorage.removeItem("userInfo");var getBatchCollection={url:CONFIG.DOMAIN+"/statics/json/batch-collection.json",method:"GET"};CommonRequest.request({},getBatchCollection,function(res){for(var key in res)if(Object.hasOwnProperty.call(res,key))for(var arr=res[key],i=0;i<arr.length;i++)if(arr[i]===vm.batchNo)return window.location.href=CONFIG.DOMAIN+"/elife-card/#/card/activity-collection/"+key})}(),document.onreadystatechange=function(){"complete"!=document.readyState?document.body.style.display="none":CONFIG.WECHAT?document.body.style.display="block":document.body.style.display="block"},vm.activationDisabled=!0,vm.minDate=new Date,vm.minDateNew=new Date(vm.minDate.getTime()+864e5),vm.maxDate=new Date(vm.minDate.getTime()+2592e6),vm.relation=vm.tbWho?vm.tbWho:"01",vm.policyData.plchdNm&&(vm.name=vm.policyData.plchdNm,vm.nameDisabled=!0),vm.certType="A",vm.insureDisabled=!1,vm.policyData.plchdCrdtNo&&(vm.certNo=VALIDATION.certNoFormat(vm.policyData.plchdCrdtNo),vm.cardDisable=!0,fromPage&&(vm.insureDisabled=!0)),vm.policyData.insureCertNo&&(vm.relation="02",vm.insureCertNo=vm.policyData.insureCertNo,vm.insuerCertNoDisabled=!0),vm.ifnull=function(word){return word?word:""},vm.policyData.plchdMoveTelNo?vm.phone=VALIDATION.phoneFormat(vm.policyData.plchdMoveTelNo):vm.phone=vm.userInfoPhone?vm.userInfoPhone:vm.ifnull(vm.tbPhone),vm.minStartDate=new Date((new Date).getTime()+864e5),$scope.$watch("newappcardActivation.phone",function(newValue,oldValue){newValue&&oldValue&&(newValue.length>oldValue.length&&(3!=newValue.length&&8!=newValue.length||(vm.phone=newValue+" ")),vm.isShowCode=!0)}),$scope.$watch("newappcardActivation.certNo",function(newValue,oldValue){if($log.info("newValue gender",newValue),newValue){if(0==newValue.length&&(vm.holdAgeError=!1),oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.certNo=newValue+" ")),!VALIDATION.idCheck(newValue))return void $log.info("newValue gender return");if(vm.gender=VALIDATION.getSex(newValue)+"",$log.info("gender",vm.gender),vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.age=VALIDATION.getAgeByBirth(vm.birthday),"0"==vm.productData.minHolderAge)return void(parseInt(((new Date).getTime()-vm.birthday.getTime())/864e5)<30||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1);vm.age<vm.productData.minHolderAge||vm.age>vm.productData.maxHolderAge?vm.holdAgeError=!0:vm.holdAgeError=!1,0==newValue.length&&(vm.holdAgeError=!1),console.info(vm.holdAgeError)}}),$scope.$watch("newappcardActivation.insureCertNo",function(newValue,oldValue){if(newValue||(vm.insureAgeError=!1),newValue){if(oldValue&&newValue.length>oldValue.length&&(6!=newValue.length&&15!=newValue.length||(vm.insureCertNo=newValue+" ")),!VALIDATION.idCheck(newValue))return void $log.info("newValue insureGender return");if(vm.insureGender=VALIDATION.getSex(newValue)+"",$log.info("insureGender",vm.insureGender),vm.insureBirthday=new Date(VALIDATION.getBirthday(newValue)),$rootScope.nextInsureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),vm.insureAge=VALIDATION.getAgeByBirth(vm.insureBirthday),"0"==vm.productData.minAge)return void(parseInt(((new Date).getTime()-vm.insureBirthday.getTime())/864e5)<30||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1);vm.insureAge<vm.productData.minAge||vm.insureAge>vm.productData.maxAge?vm.insureAgeError=!0:vm.insureAgeError=!1}});var tipStartTime,tipSecTime;vm.startTimeChange=function($invalid){tipStartTime=$filter("date")(new Date(vm.startTime).getTime(),"yyyy年M月d日"),tipSecTime=$filter("date")(vm.startTime,"yyyy年M月d日"),vm.startTimeNew=$filter("date")(new Date(new Date(vm.startTime).getTime()-864e5),"yyyy-MM-dd"),vm.startTimeT=vm.startTimeNew+"   24:00:00",vm.startTime=vm.startTime+"   0时"},fromPage&&(vm.startTime=$filter("date")(new Date(+new Date+864e5),"yyyy-MM-dd"),vm.startTimeChange()),vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"1"==gender?"04":"05":"01"},vm.healthDetail=function(open){var flag=1;vm.agree&&(flag=0,COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")),open&&flag&&COMMON.showModal("app/module/mall/product/product-purchase/card-activation/card-activation-notice/card-activation-notice.html")},$scope.$on("notice-choice",function(event,result){1==result?(vm.agree=!1,TipService.showMsg("抱歉，您未能通过投保审核，请选择其他保险卡","errorAlert")):0==result&&(vm.agree=!0)}),$scope.$on("notice-choice1",function(event,result){if(12==result)if(console.info("说道"),COMMON.hideModal(),"01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?(vm.draftOrderCode(),COMMON.hideModal()):COMMON.hideModal()})}else vm.draftOrderCode()}),$scope.$on("notice-choice2",function(event,result){if(12==result)if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():COMMON.hideModal()})}else vm.draftOrderCode()}),vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.materials=vm.productData.materials,vm.materialDetailapp=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){var material=result.data,urlpdf="";if(material&&1===material.length){for(var i=0;i<material.length;i++)material[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[i].materialPath;urlpdf=material[0].materialPath+"",vm.putLocalStr(),$window.location.href=CONFIG.DOMAIN+"/elife-wechat/lib/pdf/web/viewer.html?file="+urlpdf}else PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr,"M01"==vm.materialArr[0].materialType&&(vm.description="条款"),vm.materialList()})})}},vm.getaPdf=function(urlapdf){vm.putLocalStr(),$window.location.href=CONFIG.DOMAIN+"/elife-wechat/lib/pdf/web/viewer.html?file="+urlapdf},vm.putLocalStr=function(){localStorage.setItem("card-startTime",vm.startTime),localStorage.setItem("card-startTimeNew",vm.startTimeNew),localStorage.setItem("card-tbWho",vm.relation),localStorage.setItem("card-tbName",vm.name),localStorage.setItem("card-tbCard",vm.certNo),localStorage.setItem("card-tbCardDataLong",vm.certExpireType),localStorage.setItem("card-tbCardData",vm.certExpireDate),localStorage.setItem("card-tbEmail",vm.email),localStorage.setItem("card-tbPhone",vm.phone),localStorage.setItem("card-bbName",vm.insureName),localStorage.setItem("card-bbCard",vm.insureCertNo),localStorage.setItem("card-bbCardDataLong",vm.insureCertExpireType),localStorage.setItem("card-bbCardData",vm.insureCertExpireDate),localStorage.setItem("card-agree",vm.agree)},vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductDetail=function(id){vm.activationDisabled=!1;var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data,console.log(vm.productData),console.log(result.data);var _vm$productData2=vm.productData,prd_id=_vm$productData2.prd_id,prd_name=_vm$productData2.prd_name;$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope,{isCard:!0,prd_id:prd_id,prd_name:prd_name});var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),PolicyService.setSessionData({productData:result.data})}vm.getProductMaterials(id)}})},vm.activationApply=function(){if(!vm.cardNo&&!vm.cardPwd&&!vm.batchNo)return vm.activeResult=vm.policyData,vm.pic_name=CONFIG.DOMAIN+"/statics/cardTemp/"+vm.activeResult.prdId+".jpg",void vm.getProductDetail(vm.policyData.prdId);var param={channelCode:CONFIG.WECHAT?CONFIG.SALE_CHANNEL:"828"};vm.cardNo&&vm.cardPwd?(param.plchdCardNo=vm.cardNo,param.plchdCardPwd=vm.cardPwd):vm.batchNo&&(param.batchNo=vm.batchNo),CommonRequest.request(param,CONFIG.CARD_ACTIVATION_APPLY,function(result){result.status&&1==result.status&&vm.queuryCardActiveResult(result.data)})};var activationCount=0;vm.queuryCardActiveResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),activationCount>=20)return activationCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_ACTIVE_RESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return activationCount++,void $timeout(function(){vm.queuryCardActiveResult(flowNo)},3e3);if($ionicLoading.hide(),activationCount=0,vm.activeResult=result.data,vm.activeResult.cardSaleType)for(var item in vm.result1)vm.result1[item]==vm.activeResult.cardSaleType&&$filter("prodJsonFilter")(vm.activeResult.prdId,CommonRequest.request,$rootScope);if("1"==result.data.plchdRespCode&&(vm.activeResult=result.data,($location.search().userInfo||localStorage.getItem("userInfo"))&&vm.decryptUserInfo(),vm.pic_name=CONFIG.DOMAIN+"/statics/cardTemp/"+vm.activeResult.prdId+".jpg",vm.getProductDetail(result.data.prdId),$rootScope.userData&&"A"==$rootScope.userData.cretType)){var alertPopup=$ionicPopup.confirm({cssClass:"popup-icon",template:"您已绑定建信人寿公众号，是否使用“"+$rootScope.userData.customerName+"”绑定信息激活保险卡",okText:"使用",cancelText:"不使用"});alertPopup.then(function(res){res&&(vm.name=$rootScope.userData.customerName,vm.certNo=VALIDATION.certNoFormat($rootScope.userData.cretNo),vm.phone=VALIDATION.phoneFormat($rootScope.userData.phoneNo),vm.dragShow())})}if("2"==result.data.plchdRespCode&&$state.go("card-check-id",{batchNo:vm.batchNo}),"0"==result.data.plchdRespCode&&$state.go("activation-success",{respCode:result.data.plchdRespCode,respMsg:result.data.plchdRespDesc}),localStorage.setItem("cardSaleType",result.data.cardSaleType),"2"==result.data.cardSaleType){vm.showPopup=function(){var myPopup=$ionicPopup.show({template:"请使用建行APP打开",buttons:[{text:"确定",onTap:function(){WeixinJSBridge.call("closeWindow")}}]});myPopup.then(function(res){console.log("tapped!",res)})},CONFIG.WECHAT&&vm.showPopup();var ua=navigator.userAgent.toLowerCase();"weibo"==ua.match(/WeiBo/i)&&vm.showPopup()}else if("1"==result.data.cardSaleType)$state.go("card-activation-w100",{batchNo:vm.batchNo});else{CONFIG.WECHAT&&vm.showPopup();var ua=navigator.userAgent.toLowerCase();"weibo"==ua.match(/WeiBo/i)&&vm.showPopup()}}else $ionicLoading.hide(),activationCount=0},!0)},vm.querySelect=function(){if(vm.conId||vm.busssIo||vm.cipherText){var params={cid:vm.conId,bus:vm.busssIo,ciText:vm.cipherText};CommonRequest.request(params,CONFIG.CUSINFOEN,function(result){if(1!=result.status)return void $state.go("card-default");var data=JSON.parse(result.data);vm.name=data.recogNizee,vm.certNo=data.idEntity,vm.phone=data.Tel,vm.phone&&(vm.isShowCode=!1),$("#tabName").attr("readonly","readonly"),$("#regcard").attr("readonly","readonly"),vm.activationApply()})}else vm.activationApply()},vm.querySelect(),vm.insuYearFlag="",vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){vm.insuYearFlag=plans[0].insuYearFlag;for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日"),vm.insuYearT=plans[i].insuYear;for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.mobileCheck=function(){var params={custName:vm.name,cretNo:vm.certNo.replace(/\s+/g,""),cretType:vm.certType,phoneNo:vm.phone.replace(/\s+/g,""),prodId:vm.activeResult.prdId};CommonRequest.request(params,CONFIG.CARD_ACTIVATION_POLICY_MOBILECHECK,function(result){"1"==result.status?vm.checkHold(result.data.orderCode):result.error.message})},vm.draftOrderCode=function(){var params={prdId:vm.activeResult.prdId,mobileNo:vm.phone.replace(/\s+/g,""),smsCode:vm.phoneCode?vm.phoneCode:"",IssmsCode:vm.isShowCode?"":"Y"};CommonRequest.request(params,CONFIG.VALIDATE_CPHONE_SERVICE,function(result){if(1==result.status){if($scope.traceId=window.traceId,console.log($scope.traceId+":"),$scope.traceId)try{var traceData=angular.toJson($rootScope.traceData);sessionStorage.setItem("elife-traceData",traceData),_yfx_sendorderid(vm.batchNo+result.data.orderCode,result.data.orderCode)}catch(e){console.log("finish trace error: "+e.message)}vm.verify?vm.mobileCheck():vm.checkHold(result.data.orderCode)}else COMMON.hideModal()})},vm.checkHold=function(orderCode){var rcgnCrdtExpDt,plchdCrdtExpDt=vm.certExpireType?"20991231":$filter("date")(vm.certExpireDate,"yyyyMMdd");rcgnCrdtExpDt="01"==vm.relation?plchdCrdtExpDt:vm.insureCertExpireType?"20991231":$filter("date")(vm.insureCertExpireDate,"yyyyMMdd");var insPolcyIntndEfDt=$filter("date")(vm.startTimeNew.substring(0,10),"yyyyMMdd"),params={prdId:vm.activeResult.prdId,orderCode:orderCode,plchdCardNo:vm.cardNo,insPolcyIntndEfDt:insPolcyIntndEfDt,plchdBrthDt:$filter("date")(vm.birthday,"yyyyMMdd"),plchdCrdtExpDt:plchdCrdtExpDt,plchdCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,""),plchdCrdtTpCd:"A",plchdEmailAdr:vm.email,plchdGndCd:vm.gender,plchdMoveTelNo:vm.phone.replace(/\s+/g,""),plchdNatCd:"0156",plchdNm:vm.name,plchdAndRcgnReTpCd:vm.checkRelation(vm.relation,vm.gender),rcgnBrthDt:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),rcgnCrdtExpDt:rcgnCrdtExpDt,rcgnCrdtNo:"01"==vm.relation?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),rcgnCrdtTpCd:"A",rcgnEmail:vm.email,rcgnGndCd:"01"==vm.relation?vm.gender:vm.insureGender,rcgnNatCd:"0156",rcgnNm:"01"==vm.relation?vm.name:vm.insureName,channelCode:CONFIG.WECHAT?CONFIG.SALE_CHANNEL:"828",plchdProvCd:vm.activeResult.plchdProvinceCode,plchdCityCd:vm.activeResult.plchdCityCode,plchdCntyAndDstcCd:vm.activeResult.plchdDistrictCode,rsdntTpCd:vm.activeResult.plchdCityFlag,appNoNum:vm.activeResult.plchdPrtCount,totInsPremAmt:vm.activeResult.initPyFAmt,coPyFAmt:vm.activeResult.coPyFAmt,interfaceCode:vm.activeResult.funcFlag,batchNo:vm.activeResult.batchNo||vm.batchNo||"",insurear:vm.insuYearT,insurearflag:vm.insuYearFlag,insValiDate:vm.startTimeT};$log.info(params),CommonRequest.request(params,CONFIG.CARD_CHECK_HOLD,function(result){result&&1==result.status&&result.data&&""!=result.data&&vm.checkHoldResult(result.data)})};var checkHoldResultCount=0;vm.checkHoldResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),checkHoldResultCount>=20)return checkHoldResultCount=0,$ionicLoading.hide(),void TipService.showMsg("卡单服务忙，请稍后再试");var params={flowNo:flowNo};CommonRequest.request(params,CONFIG.CARD_QUEURY_CARD_CHECKHOLDRESULT,function(result){if(result.status&&1==result.status){if(!result.data||""==result.data)return checkHoldResultCount++,void $timeout(function(){vm.checkHoldResult(flowNo)},3e3);if($ionicLoading.hide(),checkHoldResultCount=0,"1"==result.data.respCode){var policyData={name:vm.name,cardNo:vm.cardNo||result.data.cardNo,orderCode:result.data.orderCode,batchNo:vm.batchNo,priCardNo:result.data.priCardNo};if(PolicyService.setSessionData({policyData:policyData}),"0"==result.data.personalPay){PolicyService.setSessionData({policyData:{orderCode:result.data.orderCode,itemOrderRealPayAmt:result.data.totInsPremAmt,BkBrchNo:result.data.orgCode}});var policyDatapay=PolicyService.getSessionData().policyData,payReqData={orderCode:policyData.orderCode,cardSaleType:vm.activeResult.cardSaleType,ccbMerchantId:vm.activeResult.ccbMerchantId,ccbPosId:vm.activeResult.ccbPosId,branchCode:policyDatapay.BkBrchNo||result.data.orgCode,payAmount:policyDatapay.itemOrderRealPayAmt||result.data.totInsPremAmt};CommonRequest.request(payReqData,CONFIG.CHECK_PAY_CHANNEL,function(result){if("1"==result.status)if("01"==result.data.prdPayPlatFormCode){var platForm,ua=navigator.userAgent.toLowerCase();platForm=-1!=ua.indexOf("android")?"android":-1!=ua.indexOf("iphone")?"iPhone":"pc";var data=PolicyService.getSessionData().policyData,payData={customerId:$rootScope.isLogin?$rootScope.userData.cusId:"",branchCode:data.BkBrchNo,orderCode:data.orderCode,payAmount:data.itemOrderRealPayAmt,platForm:platForm,browserType:CONFIG.WECHAT?"01":"02",opendId:$rootScope.openid||"blank",channelCode:CONFIG.SALE_CHANNEL,cardSaleType:vm.activeResult.cardSaleType,ccbMerchantId:vm.activeResult.ccbMerchantId,ccbPosId:vm.activeResult.ccbPosId,paySign:result.data.paySign},time=0,payCheck=function payCheck(){CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE,function(result){if(!result&&5>time)return time++,payCheck();if(!result)return!1;if("1"==result.status){var data=result.data;"000000"==data.payStatus&&(vm.userDev.match("iPhone")?window.location.href=data.payRedirectUrl+"&CCBWebView-User-Agent=CCBWebView/*/iPhone/*/iPhoneOS5.0/*/2.12/*/640*960&timestamp="+((new Date).getTime()+Math.random()):vm.userDev.match("Android")&&(window.location.href=data.payRedirectUrl+"&CCBWebView-User-Agent=CCBWebView/*/Android/*/Android7.0/*/4.00/*/640*960&timestamp="+((new Date).getTime()+Math.random())));
}})},payCheckPost=function(){CommonRequest.request(payData,CONFIG.CHECK_PAY_NEW_SERVICE_POST,function(result){if(!result&&5>time)return time++,payCheck();if(!result)return!1;if("1"==result.status){var data=result.data;"000000"==data.payStatus&&(vm.userDev.match("iPhone")?window.location.href=data.payRedirectUrl+"&CCBWebView-User-Agent=CCBWebView/*/iPhone/*/iPhoneOS5.0/*/2.12/*/640*960&timestamp="+((new Date).getTime()+Math.random()):vm.userDev.match("Android")&&(window.location.href=data.payRedirectUrl+"&CCBWebView-User-Agent=CCBWebView/*/Android/*/Android7.0/*/4.00/*/640*960&timestamp="+((new Date).getTime()+Math.random())))}})};vm.payWay&&"POST"==vm.payWay?payCheckPost():payCheck()}else $state.go("card-pay")})}"1"==result.data.personalPay&&$state.go("activation-success",{respCode:result.data.respCode,respMsg:result.data.respMsg})}"0"==result.data.respCode&&$state.go("activation-success",{respCode:"2",respMsg:result.data.respMsg})}else $ionicLoading.hide(),checkHoldResultCount=0},!0)},vm.decryptUserInfo=function(){if($location.search().userInfo)var userInfo=$location.search().userInfo;else var userInfo=localStorage.getItem("userInfo");if(userInfo){var userInfoTo=decodeURIComponent(userInfo),params={batchNo:$state.params.batchNo||"",ccbMerchantId:vm.activeResult.ccbMerchantId,ccbPosId:vm.activeResult.ccbPosId,userInfo:userInfoTo};CommonRequest.request(params,CONFIG.DECRYPT_USER_INFO,function(result){vm.certNo="01"==result.IDTYPE?result.ID:"",vm.phone=result.PHONE,vm.name=result.NAME,vm.userInfoPhone=result.PHONE,11==result.PHONE.length?(vm.isShowCode=!1,vm.isreturnMob=!0,vm.mobDisable=!0,localStorage.setItem("userInfoGet","y"),vm.verify=!1):vm.isreturnMob=!0,VALIDATION.invalidStringCheck(result.NAME)&&(vm.nameDisable=!0),18==result.ID.length&&(vm.cardDisable=!0)})}},vm.next=function(invalid){if(window.event.stopPropagation(),window.event.preventDefault(),invalid||vm.holdAgeError||vm.insureAgeError)if("02"==vm.relation){if(invalid||vm.holdAgeError||vm.insureAgeError)return void TipService.showMsg("请完善投保信息","errorAlert")}else if(invalid||vm.holdAgeError)return void TipService.showMsg("请完善投保信息","errorAlert");if(!vm.agree)return void TipService.showMsg("请先阅读并同意《告知事项》《产品条款》《投保声明书》《投保须知》","errorAlert");if($rootScope.nextRelation=vm.relation,vm.productData.hotTip&&vm.productData.hotTip.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-ss/card-activation-notice.html");else if(vm.productData.exoneration&&vm.productData.exoneration.length>0)COMMON.showModal("app/module/mall/product/product-purchase/card-activation/apply-sr/card-activation-notice.html");else if("01"!==vm.checkRelation(vm.relation,vm.gender)&&vm.insureAge>18){var alertPopup=$ionicPopup.confirm({title:"",template:"被保险人已同意本次投保，并已认可本次投保的保险金额。",okText:"是",cancelText:"否"});alertPopup.then(function(res){res?vm.draftOrderCode():console.info(2)})}else vm.draftOrderCode()},vm.getdragimg=function(){vm.random=Date.parse(new Date)+Math.random(8);var params={randomId:vm.random};CommonRequest.request(params,CONFIG.GENERATE_IMG_DRAG_VERIFY,function(result){if(result&&1==result.status){var data=result.data;vm.upFilePath=CONFIG.DOMAIN+"/images"+data.upFilePath+".jpg",vm.backFilePath=CONFIG.DOMAIN+"/images"+data.backFilePath+".png",$rootScope.$broadcast("drag-start",{dragWidth:data.dragWidth,distance2Top:data.distance2Top,imgDragVerifyDeviation:data.imgDragVerifyDeviation})}})},vm.dragShow=function(){if(vm.phone){if(!vm.isreturnMob&&vm.showDrag)return;"y"==vm.fanxian?vm.showDrag=!1:vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg()}else 1==vm.isreturnMob?("y"==vm.fanxian?vm.showDrag=!1:vm.showDrag=!0,vm.doAnimate=!0,vm.getdragimg()):(vm.showDrag=!1,vm.doAnimate=!0)},vm.dragShow(),$rootScope.$on("send-drag-result",function(erent,data){var flag=data.result;flag||vm.getdragimg()}),vm.dragDisabled=!0,$rootScope.$on("drag-down",function(event,result){vm.dragDisabled=!1,vm.isShowCode=!0,vm.code=result.position,$timeout(function(){$("#phoneCode").focus()},500)});var TIPS=$rootScope.TIPS,alertMsg;vm.errorAlert=function(key,val){"name"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.USER_NAME_INVALID:1==val.length&&(alertMsg=TIPS.COMMON.USER_NAME_LENGTH_ERROR)),"phone"==key&&1==val&&(alertMsg=TIPS.COMMON.PHONE_INVALID),"certNo"==key&&(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID2:1==val.length?alertMsg=TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?alertMsg=TIPS.COMMON.ID_INVALID:1==vm.holdAgeError?alertMsg=""==vm.holdAgeError?"":"投保人年龄范围不符合要求":1==vm.insureAgeError&&(""==vm.insureAgeError?alertMsg="":"02"==vm.relation&&(alertMsg="子女年龄范围不符合要求"))),"insureCertNo"==key&&(1==val.invalid2?alertMsg=TIPS.COMMON.ID_INVALID2:1==val.length?alertMsg=TIPS.COMMON.ID_LENGTH_ERROR:1==val.invalid?alertMsg=TIPS.COMMON.ID_INVALID:1==vm.holdAgeError?alertMsg=""==vm.holdAgeError?"":"投保人年龄范围不符合要求":1==vm.insureAgeError&&(alertMsg=""==vm.insureAgeError?"":"子女年龄范围不符合要求")),"email"==key&&(1==val.invalid?alertMsg=TIPS.COMMON.EMAIL_INVALID:1==val.length&&(alertMsg="您输入的邮箱长度不符")),alertMsg&&(TipService.showMsg(alertMsg,"errorAlert",1e3),alertMsg="")},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(e){vm.emailListShow=!0,e.target.parentNode.parentNode.scrollIntoView()},vm.emailBlur=function(val){vm.emailListShow=!1,1==val.invalid?(alertMsg=TIPS.COMMON.EMAIL_INVALID,TipService.showMsg(alertMsg,"errorAlert"),alertMsg=""):1==val.length&&(alertMsg="您输入的邮箱长度不符"),TipService.showMsg(alertMsg,"errorAlert")},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}}}angular.module("app").controller("newAppCardActivationController",newAppCardActivationController),newAppCardActivationController.$inject=["$scope","PolicyService","$state","$rootScope","CommonRequest","CONFIG","COMMON","TipService","$timeout","VALIDATION","$ionicLoading","$filter","$location","$window","$ionicPopup","$http","$log"]}(),function(){function PerformListController($state,$log,$rootScope,CONFIG,CommonRequest,TipService,$timeout,PolicyService,$ionicLoading,$window,$sce,$ionicPopup){var vm=this;vm.show="2",vm.name=$state.params.name,vm.openid=$state.params.openid,vm.cardNo=$state.params.cardNo,vm.referrercode=$state.params.referrercode,vm.loadmore=!0,vm.flag=!1,vm.flag1=!0,vm.perList=[],vm.page=1,vm.size="10",vm.init=function(){var params={openid:vm.openid,cardno:vm.cardNo,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){1==result.status&&(0==result.data.list.dataList.length?TipService.showMsg("暂无历史业绩",2e3):(vm.perList=result.data.list.dataList,vm.totalPages=result.data.list.totalPages))})},vm.init(),vm.pageloading=function(){var pagenow=vm.page+1;if(pagenow<=vm.totalPages){vm.page=pagenow;var params={openid:vm.openid,cardno:vm.cardNo,beginPage:vm.page,pageSize:vm.size};CommonRequest.request(params,CONFIG.QUERY_ACHIEVEMENT,function(result){1==result.status&&(0==result.data.list.length?TipService.showMsg("没有更多了",2e3):(vm.perList=vm.perList.concat(result.data.list.dataList),vm.totalPages=result.data.list.totalPages))})}else if(vm.flag1){vm.flag1=!1;var myPopup=$ionicPopup.show({template:"没有更多了",buttons:[{text:'<p class="blue m0">我知道了</p>',onTap:function(){vm.flag1=!0}}]});myPopup.then(function(res){console.log("tapped!",res)})}},vm.scollBottom=function(){$("#abcd").scroll(function(){var c=$("#abcd")[0].scrollHeight,a=$("#abcd").scrollTop(),b=$("#abcd").innerHeight();if(console.info("1:"+a+":2:"+b+":3:"+c),(a+b==c||b+2==c)&&vm.loadmore){vm.loadmore=!1;var timer=$timeout(function(){vm.pageloading(),vm.loadmore=!0,$timeout.cancel(timer)},500)}})},vm.scollBottom(),vm.back=function(){history.go(-1)}}angular.module("app").controller("PerformListController",PerformListController),PerformListController.$inject=["$state","$log","$rootScope","CONFIG","CommonRequest","TipService","$timeout","PolicyService","$ionicLoading","$window","$sce","$ionicPopup"]}(),function(){function ProductNoticeController($scope,$state,$rootScope,CONFIG,COMMON,PolicyService,CommonRequest){var sessionData=PolicyService.getSessionData(),productData=sessionData.productData||"";$scope.notifyList=productData.notifyList,$scope.templateCode=productData.templateCode,$scope.flag_notify=!0;var prd_id=productData.prd_id;$scope.getTempNotice=function(){var a={url:"../statics/json/notifyMessage/"+prd_id+".json",method:"GET"};CommonRequest.request({},a,function(result){result&&result.data&&($scope.flag_notify=!1,$scope.dataList=result.data)})},$scope.getTempNotice(),$scope.noticeTag=function(healthTag){COMMON.hideModal()}}angular.module("app").controller("ProductNoticeController",ProductNoticeController),ProductNoticeController.$inject=["$scope","$state","$rootScope","CONFIG","COMMON","PolicyService","CommonRequest"]}(),function(){function BandController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,TipService,PolicyService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var min_age,max_age,min_hoider_age,max_hoider_age,payTypeConfigs=vm.productData.payTypeConfigs;payTypeConfigs&&payTypeConfigs.length>0&&(min_age=payTypeConfigs[0].min_app_age,max_age=payTypeConfigs[0].max_app_age,min_hoider_age=payTypeConfigs[0].minHolderAge,max_hoider_age=payTypeConfigs[0].maxHolderAge,vm.minAge=min_age,vm.maxAge=max_age,vm.minHolderAge=min_hoider_age,vm.maxHolderAge=max_hoider_age,vm.minStartDate=VALIDATION.getDateByAge(max_age),vm.maxEndDate=VALIDATION.getDateByAge(min_age),vm.hoiderStartDate=VALIDATION.getDateByAge(max_hoider_age),vm.hoiderEndDate=VALIDATION.getDateByAge(min_hoider_age),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))),vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={},vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("band.user",function(){$scope.bandForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},!0),$scope.$watch("band.mainPlan.exp",function(){$timeout(function(){$scope.bandForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.payAge};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&mainRate.push(rateTable[i]);mainRate&&mainRate.length>0&&(vm.mainPlan.rate=mainRate[0].rate,vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan}))}}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.mainPlan.exp=vm.mainPlan.exp.toString(),vm.mainPlan.amount=vm.mainPlan.amount.toString();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BandController",BandController),BandController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","TipService","PolicyService","$filter","$timeout"]}(),function(){function BaneController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,TipService,PolicyService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},angular.extend(vm.mainPlan,vm.productData.plans[0]),vm.user.insuredAmount=vm.mainPlan.insuredAmount,vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("bane.user",function(){$timeout(function(){$scope.baneForm.$valid?vm.calc(vm):vm.mainPlan.exp=""},100)},!0),$scope.$watch("bane.mainPlan.amount",function(){$timeout(function(){$scope.baneForm.$valid?vm.calc(vm):vm.mainPlan.exp=""},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status&&1==result.data.length){var rate=result.data[0].rate,exp=10*rate/10*(vm.mainPlan.amount/vm.mainPlan.insuredAmount);vm.mainPlan.exp=exp,callback&&callback({exp:exp,mainPlan:vm.mainPlan})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BaneController",BaneController),BaneController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","TipService","PolicyService","$filter","$timeout"]}(),function(){function BanfController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={sex:"1",birthday:null},vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}var setMinAndMaxAges=function(obj){vm.maxAge=obj.max_app_age,vm.minAge=obj.min_app_age,vm.minHolderAge=obj.minHolderAge,vm.maxHolderAge=obj.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)};vm.totalExp="",vm.totalAmount="",vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={BULLPlan:{planId:"",planCode:"BULL",label:"",rate:0,amount:0,exp:0,selectedPlan:!1},BTLAPlan:{planId:"",planCode:"BTLA",label:"",rate:0,amount:"",exp:"",selectedPlan:!1},BDDHPlan:{planId:"",planCode:"BDDH",label:"",rate:0,amount:"",exp:"",selectedPlan:!1}},vm.getPlan=function(){var plan=vm.productData.plans;vm.mainPlanObjs={},vm.securityAgeObjs=[];for(var insuYearLable={Y:"年",M:"月",D:"天",A:"年龄"},i=0;i<plan.length;i++){var item=plan[i];"1"==item.planType?(vm.mainPlanObjs[item.insuYear]={insuYear:item.insuYear,planObj:item},vm.securityAgeObjs.push({insuYear:item.insuYear,label:item.insuYear+insuYearLable[item.insuYearFlag]})):"2"==item.planType&&("BULL"==item.planCode?(angular.extend(vm.addPlan.BULLPlan,item),vm.addPlan.BULLPlan.label=item.planName,vm.addPlan.BULLPlan.planId=item.planId):"BTLA"==item.planCode?(angular.extend(vm.addPlan.BTLAPlan,item),vm.addPlan.BTLAPlan.label=item.planName,vm.addPlan.BTLAPlan.planId=item.planId):"BDDH"==item.planCode&&(angular.extend(vm.addPlan.BDDHPlan,item),vm.addPlan.BDDHPlan.label=item.planName,vm.addPlan.BDDHPlan.planId=item.planId))}},vm.getPlan(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}if(vm.payWayObjs={},payTypeConfigs&&payTypeConfigs.length>0)for(var i=0;i<payTypeConfigs.length;i++)vm.payWayObjs[payTypeConfigs[i].pay_age]={pay_age:payTypeConfigs[i].pay_age,map:{maxHolderAge:payTypeConfigs[i].maxHolderAge,max_app_age:payTypeConfigs[i].max_app_age,minHolderAge:payTypeConfigs[i].minHolderAge,min_app_age:payTypeConfigs[i].min_app_age,payment_type:payTypeConfigs[i].payment_type}}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value;var getSecurityAgesByPayAges=function(payendyear){var securityArr=[];if("3"==payendyear)for(var i=0;i<vm.securityAgeObjs.length;i++)"10"==vm.securityAgeObjs[i].insuYear&&securityArr.push(vm.securityAgeObjs[i]);else if("5"==payendyear)for(var i=0;i<vm.securityAgeObjs.length;i++)"18"==vm.securityAgeObjs[i].insuYear&&securityArr.push(vm.securityAgeObjs[i]);else if("10"==payendyear)for(var i=0;i<vm.securityAgeObjs.length;i++)"20"!=vm.securityAgeObjs[i].insuYear&&"30"!=vm.securityAgeObjs[i].insuYear||securityArr.push(vm.securityAgeObjs[i]);securityArr&&securityArr.length>0&&(vm.user.securityAges=securityArr,vm.user.securityAge=securityArr[0].insuYear)};getSecurityAgesByPayAges(vm.user.payendyear),vm.mainPlan=vm.mainPlanObjs[vm.user.securityAge].planObj;var getMinAndMax=function(){var user=vm.user;if(user.sex&&user.birthday){var age=VALIDATION.getAgeByBirth(user.birthday);if(vm.mainPlan.exp)if(age>=0&&18>age){var maxNum=50*vm.mainPlan.exp<=5e5?50*vm.mainPlan.exp/1e3:"500";vm.addPlan.BDDHPlan.maxBuyQautity=maxNum,vm.addPlan.BTLAPlan.selectedPlan=!1,vm.addPlan.BTLAPlan.isDisabled=!0,vm.addPlan.BULLPlan.isDisabled=!1,vm.addPlan.BDDHPlan.isDisabled=!1}else if(age>=18&&40>=age){var maxNum1=30*vm.mainPlan.exp<=4e5?30*vm.mainPlan.exp/1e3:"400",maxNum2=50*vm.mainPlan.exp<=5e5?50*vm.mainPlan.exp/1e3:"500";vm.addPlan.BTLAPlan.maxBuyQautity=maxNum1,vm.addPlan.BDDHPlan.maxBuyQautity=maxNum2,vm.addPlan.BTLAPlan.isDisabled=!1,vm.addPlan.BULLPlan.isDisabled=!1,vm.addPlan.BDDHPlan.isDisabled=!1}else if(age>=41&&50>=age){var maxNum1=30*vm.mainPlan.exp<=3e5?30*vm.mainPlan.exp/1e3:"300",maxNum2=50*vm.mainPlan.exp<=3e5?50*vm.mainPlan.exp/1e3:"300";vm.addPlan.BTLAPlan.maxBuyQautity=maxNum1,vm.addPlan.BDDHPlan.maxBuyQautity=maxNum2,vm.addPlan.BTLAPlan.isDisabled=!1,vm.addPlan.BULLPlan.isDisabled=!1,vm.addPlan.BDDHPlan.isDisabled=!1}else if(age>=51&&60>=age){var maxNum1=30*vm.mainPlan.exp<=2e5?30*vm.mainPlan.exp/1e3:"200",maxNum2=50*vm.mainPlan.exp<=2e5?50*vm.mainPlan.exp/1e3:"200";vm.addPlan.BTLAPlan.maxBuyQautity=maxNum1,vm.addPlan.BDDHPlan.maxBuyQautity=maxNum2,vm.addPlan.BTLAPlan.isDisabled=!1,vm.addPlan.BULLPlan.isDisabled=!1,vm.addPlan.BDDHPlan.isDisabled=!1}else vm.addPlan.BULLPlan.selectedPlan=!1,vm.addPlan.BULLPlan.isDisabled=!0,vm.addPlan.BTLAPlan.selectedPlan=!1,vm.addPlan.BTLAPlan.isDisabled=!0,vm.addPlan.BDDHPlan.selectedPlan=!1,vm.addPlan.BDDHPlan.isDisabled=!0;else vm.addPlan.BULLPlan.selectedPlan=!1,vm.addPlan.BULLPlan.isDisabled=!0,vm.addPlan.BTLAPlan.selectedPlan=!1,vm.addPlan.BTLAPlan.isDisabled=!0,vm.addPlan.BDDHPlan.selectedPlan=!1,vm.addPlan.BDDHPlan.isDisabled=!0}else vm.addPlan.BULLPlan.selectedPlan=!1,vm.addPlan.BULLPlan.isDisabled=!0,vm.addPlan.BTLAPlan.selectedPlan=!1,vm.addPlan.BTLAPlan.isDisabled=!0,vm.addPlan.BDDHPlan.selectedPlan=!1,vm.addPlan.BDDHPlan.isDisabled=!0};getMinAndMax();var validateBirthday=function(){if(!vm.user.birthday||!vm.user.payendyear)return!1;var age=VALIDATION.getAgeByBirth(vm.user.birthday);return"10"==vm.user.payendyear?age>=0&&50>=age:"5"==vm.user.payendyear?age>=0&&60>=age:"3"==vm.user.payendyear?vm.addPlan.BTLAPlan.selectedPlan||vm.addPlan.BDDHPlan.selectedPlan?age>=0&&60>=age:age>=0&&65>=age:void 0},validateMoney=function(){var moneyFlag=!1,user=vm.user;if(user.sex&&user.birthday)if(vm.mainPlan.exp&&vm.mainPlan.exp>=vm.mainPlan.normalPrice*vm.mainPlan.minBuyQautity){moneyFlag=!0;var age=VALIDATION.getAgeByBirth(user.birthday),maxNumBTLA=0,maxNumBDDH=0;age>=0&&18>age?(maxNumBDDH=50*vm.mainPlan.exp<=5e5?50*vm.mainPlan.exp:5e5,vm.addPlan.BDDHPlan.maxBuyQautity=maxNumBDDH/1e3):age>=18&&40>=age?(maxNumBTLA=30*vm.mainPlan.exp<=4e5?30*vm.mainPlan.exp:4e5,maxNumBDDH=50*vm.mainPlan.exp<=5e5?50*vm.mainPlan.exp:5e5,vm.addPlan.BTLAPlan.maxBuyQautity=maxNumBTLA/1e3,vm.addPlan.BDDHPlan.maxBuyQautity=maxNumBDDH/1e3):age>=41&&50>=age?(maxNumBTLA=30*vm.mainPlan.exp<=3e5?30*vm.mainPlan.exp:3e5,maxNumBDDH=50*vm.mainPlan.exp<=3e5?50*vm.mainPlan.exp:3e5,vm.addPlan.BTLAPlan.maxBuyQautity=maxNumBTLA/1e3,vm.addPlan.BDDHPlan.maxBuyQautity=maxNumBDDH/1e3):age>=51&&60>=age&&(maxNumBTLA=30*vm.mainPlan.exp<=2e5?30*vm.mainPlan.exp:2e5,maxNumBDDH=50*vm.mainPlan.exp<=2e5?50*vm.mainPlan.exp:2e5,vm.addPlan.BTLAPlan.maxBuyQautity=maxNumBTLA/1e3,vm.addPlan.BDDHPlan.maxBuyQautity=maxNumBDDH/1e3);var amountBTLA=Number(vm.addPlan.BTLAPlan.amount),amountBDDH=Number(vm.addPlan.BDDHPlan.amount);vm.addPlan.BTLAPlan.selectedPlan&&(moneyFlag=!!(amountBTLA&&amountBTLA>=vm.addPlan.BTLAPlan.insuredAmount*vm.addPlan.BTLAPlan.minBuyQautity&&maxNumBTLA>=amountBTLA)),vm.addPlan.BDDHPlan.selectedPlan&&(moneyFlag=!!(amountBDDH&&amountBDDH>=vm.addPlan.BDDHPlan.insuredAmount*vm.addPlan.BDDHPlan.minBuyQautity&&maxNumBDDH>=amountBDDH))}else moneyFlag=!1;else moneyFlag=!1;return moneyFlag};vm.nextStepValide=!0;var isNextStepValide=function(){vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.nextStepValide=!1:vm.nextStepValide=!0,vm.addPlan.BTLAPlan.selectedPlan&&(vm.addPlan.BTLAPlan.amount&&VALIDATION.getAgeByBirth(vm.user.birthday)>=18&&validateMoney()?vm.nextStepValide=!1:vm.nextStepValide=!0),vm.addPlan.BDDHPlan.selectedPlan&&(vm.addPlan.BDDHPlan.amount&&validateMoney()?vm.nextStepValide=!1:vm.nextStepValide=!0)};$scope.$watch("banf.user.payendyear",function(newValue){if(newValue){setMinAndMaxAges(vm.payWayObjs[newValue].map),getSecurityAgesByPayAges(newValue);var expTemp=vm.mainPlan?vm.mainPlan.exp:"";vm.mainPlan=vm.mainPlanObjs[vm.user.securityAge].planObj,vm.mainPlan.exp=expTemp,vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp=""}},!0),$scope.$watch("banf.user.securityAge",function(newValue){if(newValue&&"10"==vm.user.payendyear){var expTemp=vm.mainPlan?vm.mainPlan.exp:"";vm.mainPlan=vm.mainPlanObjs[vm.user.securityAge].planObj,vm.mainPlan.exp=expTemp,vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp=""}},!0),$scope.$watch("banf.user",function(newValue){var user=newValue;if(user.sex&&user.birthday){var age=VALIDATION.getAgeByBirth(user.birthday);if(getMinAndMax(),age>=0&&50>=age)vm.getPayWay();else if(age>=51&&60>=age){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payment_value&&payment_value.length>0){for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]&&10!=payage[i]&&(label=payage[i]+"年交"),10!=payage[i]&&vm.payWays.push({label:label,value:payage[i]})}"10"==vm.user.payendyear&&(vm.user.payendyear=vm.payWays[0].value,setMinAndMaxAges(vm.payWayObjs[vm.payWays[0].value].map),getSecurityAgesByPayAges(vm.user.payendyear),vm.mainPlan=vm.mainPlanObjs[vm.user.securityAge].planObj)}}vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp=""}},!0),$scope.$watch("banf.mainPlan.exp",function(newValue){newValue&&(getMinAndMax(),vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp="",isNextStepValide())},!0),$scope.$watch("banf.addPlan.BTLAPlan.selectedPlan",function(newValue){vm.addPlan.BTLAPlan.selectedPlan||(vm.addPlan.BTLAPlan.amount="",vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp=""),isNextStepValide()},!0),$scope.$watch("banf.addPlan.BTLAPlan.amount",function(newValue){newValue&&(vm.addPlan.BTLAPlan.selectedPlan||(vm.addPlan.BTLAPlan.amount=""),vm.addPlan.BTLAPlan.selectedPlan&&vm.addPlan.BTLAPlan.amount&&vm.calcAll(vm)),isNextStepValide()},!0),$scope.$watch("banf.addPlan.BDDHPlan.selectedPlan",function(newValue){vm.addPlan.BDDHPlan.selectedPlan||(vm.addPlan.BDDHPlan.amount="",vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()?vm.calcAll(vm):vm.totalExp=""),isNextStepValide()},!0),$scope.$watch("banf.addPlan.BDDHPlan.amount",function(newValue){newValue&&(vm.addPlan.BDDHPlan.selectedPlan||(vm.addPlan.BDDHPlan.amount=""),vm.addPlan.BDDHPlan.selectedPlan&&vm.addPlan.BDDHPlan.amount&&vm.calcAll(vm)),isNextStepValide()},!0),vm.calcAll=function(vm){isNextStepValide();var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[],BTLAAddRate=[],BDDHAddRate=[];if(vm.totalAmount="",vm.totalExp="",rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge?mainRate.push(rateTable[i]):"2"==rateTable[i].planType&&("BTLA"==rateTable[i].planCode&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge?BTLAAddRate.push(rateTable[i]):"BDDH"==rateTable[i].planCode&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge&&BDDHAddRate.push(rateTable[i]));if(mainRate&&mainRate.length>0){for(var isRisk=!1,i=0;i<mainRate.length;i++)"A"==mainRate[i].suppriskscore&&(vm.mainPlan.rate=mainRate[i].rate,isRisk=!0);isRisk||(vm.mainPlan.rate=mainRate[0].rate),vm.mainPlan&&vm.user.birthday&&validateBirthday()&&vm.user.sex&&vm.mainPlan.exp&&validateMoney()&&(vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate)}if(BTLAAddRate&&BTLAAddRate.length>0){for(var isRisk=!1,i=0;i<BTLAAddRate.length;i++)"A"==BTLAAddRate[i].suppriskscore&&(vm.addPlan.BTLAPlan.rate=BTLAAddRate[i].rate,isRisk=!0);isRisk||(vm.addPlan.BTLAPlan.rate=BTLAAddRate[0].rate),vm.addPlan.BTLAPlan.selectedPlan&&vm.addPlan.BTLAPlan.amount?vm.addPlan.BTLAPlan.exp=(parseInt(10*vm.addPlan.BTLAPlan.rate*1+.5)/10*(vm.addPlan.BTLAPlan.amount/vm.addPlan.BTLAPlan.insuredAmount)).toFixed(2):vm.addPlan.BTLAPlan.exp=0}else vm.addPlan.BTLAPlan.amount&&TipService.showMsg("附加龙行富贵定期寿险费率为空！");if(BDDHAddRate&&BDDHAddRate.length>0){for(var isRisk=!1,i=0;i<BDDHAddRate.length;i++)"A"==BDDHAddRate[i].suppriskscore&&(vm.addPlan.BDDHPlan.rate=BDDHAddRate[i].rate,isRisk=!0);isRisk||(vm.addPlan.BDDHPlan.rate=BDDHAddRate[0].rate),vm.addPlan.BDDHPlan.selectedPlan&&vm.addPlan.BDDHPlan.amount?vm.addPlan.BDDHPlan.exp=(parseInt(10*vm.addPlan.BDDHPlan.rate*1+.5)/10*(vm.addPlan.BDDHPlan.amount/vm.addPlan.BDDHPlan.insuredAmount)).toFixed(2):vm.addPlan.BDDHPlan.exp=0}else vm.addPlan.BDDHPlan.amount&&TipService.showMsg("附加龙行富贵重大疾病保险条款费率为空！")}vm.totalAmount=Number(vm.mainPlan.amount)+Number(vm.addPlan.BTLAPlan.amount)+Number(vm.addPlan.BDDHPlan.amount),vm.totalExp=Number(vm.mainPlan.exp)+Number(vm.addPlan.BTLAPlan.exp)+Number(vm.addPlan.BDDHPlan.exp)}})},vm.goPolicy=function(){if(vm.effectiveDate){
var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var extraPlanIdArr=[],isSelectAddPlan=!1,selectAddPlanObjs=[];vm.addPlan.BULLPlan.selectedPlan||vm.addPlan.BTLAPlan.selectedPlan||vm.addPlan.BDDHPlan.selectedPlan?(vm.addPlan.BULLPlan.selectedPlan&&(isSelectAddPlan=!0,extraPlanIdArr.push(vm.addPlan.BULLPlan.planId),selectAddPlanObjs.push(vm.addPlan.BULLPlan)),vm.addPlan.BTLAPlan.selectedPlan&&(isSelectAddPlan=!0,extraPlanIdArr.push(vm.addPlan.BTLAPlan.planId),selectAddPlanObjs.push(vm.addPlan.BTLAPlan)),vm.addPlan.BDDHPlan.selectedPlan&&(isSelectAddPlan=!0,extraPlanIdArr.push(vm.addPlan.BDDHPlan.planId),selectAddPlanObjs.push(vm.addPlan.BDDHPlan))):isSelectAddPlan=!1,vm.mainPlan.exp=vm.mainPlan.exp.toString(),vm.mainPlan.amount=vm.mainPlan.amount.toString();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,extraPlanId:extraPlanIdArr?extraPlanIdArr:0,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,selectedPlan:isSelectAddPlan,mainPlan:vm.mainPlan,addPlan:selectAddPlanObjs,payendyear:vm.user.payendyear,paymentType:"12",PbInsuAmt:vm.totalAmount,PbInsuExp:vm.totalExp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calcForInfo.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})},vm.calcForInfo=function(vm,callback){vm.mainPlan.rate=0,vm.addPlan.BTLAPlan.rate=0,vm.addPlan.BDDHPlan.rate=0;var validateMinAndMaxAmount=function(){var user=vm.user;if(user.sex&&user.birthday){var age=VALIDATION.getAgeByBirth(user.birthday),maxNumBTLA="",maxNumBDDH="";age>=0&&18>age?maxNumBDDH=50*vm.mainPlan.exp<=5e5?50*vm.mainPlan.exp:"500000":age>=18&&40>=age?(maxNumBTLA=30*vm.mainPlan.exp<=4e5?30*vm.mainPlan.exp:"400000",maxNumBDDH=50*vm.mainPlan.exp<=5e5?30*vm.mainPlan.exp:"500000"):age>=41&&50>=age?(maxNumBTLA=30*vm.mainPlan.exp<=3e5?30*vm.mainPlan.exp:"300000",maxNumBDDH=50*vm.mainPlan.exp<=3e5?30*vm.mainPlan.exp:"300000"):age>=51&&60>=age&&(maxNumBTLA=30*vm.mainPlan.exp<=2e5?30*vm.mainPlan.exp:"200000",maxNumBDDH=50*vm.mainPlan.exp<=2e5?30*vm.mainPlan.exp:"200000");vm.addPlan.BTLAPlan.amount,vm.addPlan.BDDHPlan.amount;return vm.addPlan.BTLAPlan.selectedPlan&&age>0&&18>age?($ionicPopup.alert({title:"温馨提示",template:"投保附加龙行富贵定期寿险时，投保人最小年龄为18岁！",okText:"我知道了"}),!1):!0}};if(!validateMinAndMaxAmount())return!1;var selectAddPlanObjs=[];vm.addPlan.BULLPlan.selectedPlan&&selectAddPlanObjs.push(vm.addPlan.BULLPlan),vm.addPlan.BTLAPlan.selectedPlan&&selectAddPlanObjs.push(vm.addPlan.BTLAPlan),vm.addPlan.BDDHPlan.selectedPlan&&selectAddPlanObjs.push(vm.addPlan.BDDHPlan);var calcAll=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[],BTLAAddRate=[],BDDHAddRate=[];if(vm.totalAmount="",vm.totalExp="",rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge?mainRate.push(rateTable[i]):"2"==rateTable[i].planType&&("BTLA"==rateTable[i].planCode&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge?BTLAAddRate.push(rateTable[i]):"BDDH"==rateTable[i].planCode&&rateTable[i].payendyear==vm.user.payendyear&&rateTable[i].insuyear==vm.user.securityAge&&BDDHAddRate.push(rateTable[i]));if(mainRate&&mainRate.length>0){for(var isRisk=!1,i=0;i<mainRate.length;i++)"A"==mainRate[i].suppriskscore&&(vm.mainPlan.rate=mainRate[i].rate,isRisk=!0);isRisk||(vm.mainPlan.rate=mainRate[0].rate),vm.mainPlan&&vm.user.birthday&&vm.user.sex&&vm.mainPlan.exp&&(vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate)}if(BTLAAddRate&&BTLAAddRate.length>0){for(var isRisk=!1,i=0;i<BTLAAddRate.length;i++)"A"==BTLAAddRate[i].suppriskscore&&(vm.addPlan.BTLAPlan.rate=BTLAAddRate[i].rate,isRisk=!0);isRisk||(vm.addPlan.BTLAPlan.rate=BTLAAddRate[0].rate),vm.addPlan.BTLAPlan.selectedPlan&&vm.addPlan.BTLAPlan.amount?vm.addPlan.BTLAPlan.exp=(parseInt(10*vm.addPlan.BTLAPlan.rate*1+.5)/10*(vm.addPlan.BTLAPlan.amount/vm.addPlan.BTLAPlan.insuredAmount)).toFixed(2):vm.addPlan.BTLAPlan.exp=0}else vm.addPlan.BTLAPlan.amount&&TipService.showMsg("附加龙行富贵定期寿险费率为空！");if(BDDHAddRate&&BDDHAddRate.length>0){for(var isRisk=!1,i=0;i<BDDHAddRate.length;i++)"A"==BDDHAddRate[i].suppriskscore&&(vm.addPlan.BDDHPlan.rate=BDDHAddRate[i].rate,isRisk=!0);isRisk||(vm.addPlan.BDDHPlan.rate=BDDHAddRate[0].rate),vm.addPlan.BDDHPlan.selectedPlan&&vm.addPlan.BDDHPlan.amount?vm.addPlan.BDDHPlan.exp=(parseInt(10*vm.addPlan.BDDHPlan.rate*1+.5)/10*(vm.addPlan.BDDHPlan.amount/vm.addPlan.BDDHPlan.insuredAmount)).toFixed(2):vm.addPlan.BDDHPlan.exp=0}else vm.addPlan.BDDHPlan.amount&&TipService.showMsg("附加龙行富贵重大疾病保险条款费率为空！")}vm.totalAmount=Number(vm.mainPlan.amount)+Number(vm.addPlan.BTLAPlan.amount)+Number(vm.addPlan.BDDHPlan.amount),vm.totalExp=Number(vm.mainPlan.exp)+Number(vm.addPlan.BTLAPlan.exp)+Number(vm.addPlan.BDDHPlan.exp),callback(vm.totalAmount,vm.totalExp)}})};calcAll(vm,function(totalAmount,totalExp){callback({exp:totalExp,amount:totalAmount,mainPlan:vm.mainPlan,addPlan:selectAddPlanObjs})})}}angular.module("app").controller("BanfController",BanfController),BanfController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BanoController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("home");vm.user={},vm.user.sex="1",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.nextStep=!0,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.payendyearForShow=function(){var payendyearStr=vm.productData.payment_type;"0"==payendyearStr?vm.payendYearForShow="趸交":"1"==payendyearStr?vm.payendYearForShow="月交":"3"==payendyearStr?vm.payendYearForShow="季交":"6"==payendyearStr?vm.payendYearForShow="半年交":"12"==payendyearStr&&(vm.payendYearForShow="年交")},vm.payendyearForShow(),vm.insuYearForShow=function(){var insuYearUnitStr,insuYearUnit=vm.mainPlan.insuYearFlag;"Y"==insuYearUnit?insuYearUnitStr="年":"M"==insuYearUnit?insuYearUnitStr="月":"D"==insuYearUnit&&(insuYearUnitStr="天"),vm.insuYearForShow=vm.mainPlan.insuYear+insuYearUnitStr},vm.insuYearForShow(),$scope.$watch("bano.user.birthday",function(newValue){newValue&&(vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex&&vm.mainPlan.getExp&&(vm.mainPlan.exp="",vm.mainPlan.amount="",vm.nextStep=!0,vm.calc(vm)))}),$scope.$watch("bano.user.sex",function(newValue){newValue&&vm.user.birthdayfm&&vm.mainPlan.getExp&&(vm.mainPlan.exp="",vm.mainPlan.amount="",vm.nextStep=!0,vm.calc(vm))}),$scope.$watch("bano.mainPlan.getExp",function(newValue){newValue&&$timeout(function(){return $scope.banoForm.$valid?void(vm.user.sex&&vm.user.birthday?(vm.mainPlan.exp="",vm.mainPlan.amount="",vm.nextStep=!0,vm.calc(vm)):vm.mainPlan.amount=""):(vm.nextStep=!0,vm.mainPlan.exp="",void(vm.mainPlan.amount=""))},100)}),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),config={url:"../statics/json/prdRate/"+vm.productData.prd_id+"/"+vm.productData.prd_id+"_"+user.sex+"_"+age+"_"+vm.productData.pay_age+".json",method:"GET"};CommonRequest.request({},config,function(data){if(data&&data.status)1==data.status?(vm.mainPlan.rate=data.data[0].rate,vm.mainPlan.amount=vm.mainPlan.getExp/1e3*vm.mainPlan.rate,vm.mainPlan.exp=vm.mainPlan.getExp,vm.nextStep=!1,vm.amountForShow=!0,callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})):(vm.mainPlan.amount="",vm.nextStep=!0,vm.amountForShow=!1);else{vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),vm.nextStep=!0,void(vm.amountForShow=!1);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],vm.nextStep=!1,vm.amountForShow=!0,callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuExp:vm.mainPlan.getExp,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return vm.amountForShow=!1,void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],vm.nextStep=!1,vm.amountForShow=!0}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BanoController",BanoController),BanoController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BanqController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return TipService.showMsg("非法操作！"),void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.payendyear="1",vm.addif="1",vm.socif="Y",vm.accRisk=!0,"811"==CONFIG.SALE_CHANNEL&&(vm.addif="0"),vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={rate:0,amount:1e6,exp:"",planName:"建信附加爱康医疗保险",planType:"2",planCode:"BMRB"},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.productData.prd_id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val}));for(var i=0;i<vm.maDetail.length;i++)"建信附加爱康医疗保险条款"==vm.maDetail[i].materialName&&(vm.addPath=vm.maDetail[i].materialPath)}})}})},vm.getProductMaterials(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,"812"==CONFIG.SALE_CHANNEL?vm.mainPlan.exp=15e3:vm.mainPlan.exp=5e3,vm.payendyearChange=function(val){"812"==CONFIG.SALE_CHANNEL?3==val?vm.mainPlan.exp=15e3:5==val?vm.mainPlan.exp=1e4:vm.mainPlan.exp=6e3:20==val?vm.mainPlan.exp=3e3:vm.mainPlan.exp=5e3},vm.bulrExp=function(val){vm.mainPlan.exp=val},vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("banq.user",function(){var aged=VALIDATION.getAgeByBirth(vm.user.birthday);$timeout(function(){aged>59?(vm.accRisk=!1,vm.addif="0"):vm.accRisk=!0,$scope.banqForm.exp.$valid&&vm.user.birthday&&vm.calc(vm)},100)},!0),$scope.$watch("banq.user.payendyear",function(newValue){newValue&&("1"==vm.user.payendyear?vm.paymentType="0":vm.paymentType="12")},!0),$scope.$watch("banq.mainPlan.exp",function(){$timeout(function(){$scope.banqForm.exp.$valid&&vm.user.birthday?vm.calc(vm):$scope.banqForm.exp.$valid?vm.mainPlan.amount=" ":(vm.mainPlan.amount=" ",vm.expplus="",vm.addPlan.exp="")},100)},!0),$scope.$watch("banq.addif + banq.mainPlan.exp + banq.socif + banq.user.birthday",function(){$timeout(function(){if("1"==vm.addif&&vm.mainPlan.exp&&vm.user.birthday&&$scope.banqForm.exp.$valid){var calcParams={prdCode:"BMRB",prdName:"建信附加爱康医疗保险",insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),insuredDays:"1",insuYearFlag:"Y",planCode:"BMRB_01",channel:CONFIG.SALE_CHANNEL,sex:vm.user.sex,paymentType:"12",PbInsuAmt:1e6,payendyear:"1",socialSecurity:vm.socif};vm.calcAdd(calcParams,function(){})}else vm.expplus="",vm.addPlan.exp=""},100)},!0),vm.calcAdd=function(params,callback){CommonRequest.request(params,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&$scope.banqForm.exp.$valid&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&$scope.banqForm.exp.$valid&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),checkPremiumNum=0,angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}},vm.calc=function(vm,callback){var user=vm.user,calcParams=(VALIDATION.getAgeByBirth(user.birthday),{prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:$filter("date")(user.birthday,"yyyyMMdd"),sex:user.sex,PbInsuExp:vm.mainPlan.exp,planCode:vm.mainPlan.planCode,insuredDays:user.payendyear,paymentType:vm.paymentType,insuYearFlag:vm.mainPlan.insuYearFlag,payendyear:vm.user.payendyear,channel:CONFIG.SALE_CHANNEL});CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.amount=amountExp[1],vm.nextStep=!1,vm.mainPlan.dutys[0].insuredAmount=vm.mainPlan.amount/1e4}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.checkExp=function(){var exp=vm.mainPlan.exp;if(exp){if("812"!=CONFIG.SALE_CHANNEL)return parseInt(exp)<5e3&&("3"==vm.user.payendyear||"5"==vm.user.payendyear||"10"==vm.user.payendyear||"15"==vm.user.payendyear)?(TipService.showMsg("该产品3年、5年、10年、15年交保费不得低于5000元人民币"),!1):parseInt(exp)<3e3&&"20"==vm.user.payendyear?(TipService.showMsg("该产品20年交保费不得低于3000元人民币"),!1):!0;if(parseInt(exp)<15e3&&"3"==vm.user.payendyear)return TipService.showMsg("该产品3年交保费不得低于15000元人民币"),!1;if(!(parseInt(exp)<1e4&&"5"==vm.user.payendyear))return parseInt(exp)<6e3&&("10"==vm.user.payendyear||"15"==vm.user.payendyear||"20"==vm.user.payendyear)?(TipService.showMsg("10年、15年、20年交保费不得低于6000元人民币"),!1):!0;TipService.showMsg("该产品3年交保费不得低于10000元人民币")}},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.changeConfig()&&vm.checkExp()){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:"1"==vm.addif,loveheaPlan:"1"==vm.addif,mainPlan:vm.mainPlan,addPlan:"1"==vm.addif?vm.addPlan:null,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:"1"==vm.addif?parseInt(vm.mainPlan.amount)+1e6:vm.mainPlan.amount,PbInsuExp:vm.expplus||vm.mainPlan.exp,socialSecurity:vm.socif,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcAdd:vm.calcAdd.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("BanqController",BanqController),BanqController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BanrController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return TipService.showMsg("非法操作！"),void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.payendyear="1",vm.addif="1",vm.socif="Y",vm.accRisk=!0,"811"==CONFIG.SALE_CHANNEL&&(vm.addif="0"),vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={rate:0,amount:1e6,exp:"",planName:"建信附加爱康医疗保险",planType:"2",planCode:"BMRB"},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.productData.prd_id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val}));for(var i=0;i<vm.maDetail.length;i++)"建信附加爱康医疗保险条款"==vm.maDetail[i].materialName&&(vm.addPath=vm.maDetail[i].materialPath)}})}})},vm.getProductMaterials(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,"812"==CONFIG.SALE_CHANNEL?vm.mainPlan.exp=1e4:vm.mainPlan.exp=5e3,vm.payendyearChange=function(val){20==val?vm.mainPlan.exp=3e3:"812"==CONFIG.SALE_CHANNEL?3==val?vm.mainPlan.exp=1e4:5==val?vm.mainPlan.exp=7e3:vm.mainPlan.exp=5e3:vm.mainPlan.exp=5e3},vm.bulrExp=function(val){vm.mainPlan.exp=val},vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("banr.user",function(){var aged=VALIDATION.getAgeByBirth(vm.user.birthday);$timeout(function(){aged>59?(vm.accRisk=!1,vm.addif="0"):vm.accRisk=!0,$scope.banrForm.exp.$valid&&vm.user.birthday&&vm.calc(vm)},100)},!0),$scope.$watch("banr.user.payendyear",function(newValue){newValue&&("3"==vm.user.payendyear?(vm.paymentType="12",vm.insuredPeriod=10,vm.mainPlan.insuYear=10):(vm.paymentType="12",vm.insuredPeriod=15,vm.mainPlan.insuYear=15))},!0),$scope.$watch("banr.mainPlan.exp",function(){$timeout(function(){$scope.banrForm.exp.$valid&&vm.user.birthday?vm.calc(vm):$scope.banrForm.exp.$valid?vm.mainPlan.amount=" ":(vm.mainPlan.amount=" ",vm.expplus="",vm.addPlan.exp="")},100)},!0),$scope.$watch("banr.addif + banr.mainPlan.exp + banr.socif + banr.user.birthday",function(){$timeout(function(){if("1"==vm.addif&&vm.mainPlan.exp&&vm.user.birthday&&$scope.banrForm.exp.$valid){var calcParams={prdCode:"BMRB",prdName:"建信附加爱康医疗保险",insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),insuredDays:"1",insuYearFlag:"Y",planCode:"BMRB_01",channel:CONFIG.SALE_CHANNEL,sex:vm.user.sex,paymentType:"12",PbInsuAmt:1e6,payendyear:"1",socialSecurity:vm.socif};vm.calcAdd(calcParams,function(){})}else vm.expplus="",vm.addPlan.exp=""},100)},!0),vm.calcAdd=function(params,callback){CommonRequest.request(params,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&$scope.banrForm.exp.$valid&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&$scope.banrForm.exp.$valid&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),checkPremiumNum=0,angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}},vm.calc=function(vm,callback){var user=vm.user,calcParams=(VALIDATION.getAgeByBirth(user.birthday),{prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:$filter("date")(user.birthday,"yyyyMMdd"),sex:user.sex,PbInsuExp:vm.mainPlan.exp,
planCode:vm.mainPlan.planCode,insuredDays:vm.insuredPeriod,paymentType:vm.paymentType,insuYearFlag:vm.mainPlan.insuYearFlag,payendyear:vm.user.payendyear,channel:CONFIG.SALE_CHANNEL});CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.amount=amountExp[1],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.checkExp=function(){var exp=vm.mainPlan.exp;return exp?"812"==CONFIG.SALE_CHANNEL?parseInt(exp)<1e4&&"3"==vm.user.payendyear?(TipService.showMsg("该产品3年交保费不得低于10000元人民币"),!1):parseInt(exp)<7e3&&"5"==vm.user.payendyear?(TipService.showMsg("该产品5年交保费不得低于7000元人民币"),!1):parseInt(exp)<3e3&&"20"==vm.user.payendyear?(TipService.showMsg("该产品20年交保费不得低于3000元人民币"),!1):!0:5e3>exp&&("3"==vm.user.payendyear||"5"==vm.user.payendyear)&&"banr"==vm.productData.prd_code?(TipService.showMsg("该产品3年、5年交保费不得低于5000元人民币"),!1):3e3>exp&&"20"==vm.user.payendyear?(TipService.showMsg("该产品20年交保费不得低于3000元人民币"),!1):!0:void 0},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.changeConfig()&&vm.checkExp()){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:"1"==vm.addif,loveheaPlan:"1"==vm.addif,mainPlan:vm.mainPlan,addPlan:"1"==vm.addif?vm.addPlan:null,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:"1"==vm.addif?parseInt(vm.mainPlan.amount)+1e6:vm.mainPlan.amount,PbInsuExp:vm.expplus||vm.mainPlan.exp,PbBeginDate:effecDate,socialSecurity:vm.socif,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcAdd:vm.calcAdd.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("BanrController",BanrController),BanrController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BddgController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge="0",vm.maxAge="50",vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}var setMinAndMaxAges=function(obj){vm.minHolderAge=obj.minHolderAge,vm.maxHolderAge=obj.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)};vm.getPayWay=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payment_value[i]})}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push({label:payage_value[i]+"年",value:payage_value[i]});var pay_age=[];if(vm.payWayObjs={},payTypeConfigs&&payTypeConfigs.length>0)for(var i=0;i<payTypeConfigs.length;i++)if(-1===pay_age.join(",").indexOf(payTypeConfigs[i].pay_age))pay_age.push(payTypeConfigs[i].pay_age),vm.payWayObjs[payTypeConfigs[i].pay_age]={pay_age:payTypeConfigs[i].pay_age,map:[{maxHolderAge:payTypeConfigs[i].maxHolderAge,max_app_age:payTypeConfigs[i].max_app_age,minHolderAge:payTypeConfigs[i].minHolderAge,min_app_age:payTypeConfigs[i].min_app_age,payment_type:payTypeConfigs[i].payment_type}]};else{for(var flag=!1,j=0;j<vm.payWayObjs[payTypeConfigs[i].pay_age].map.length;j++)payTypeConfigs[i].payment_type===vm.payWayObjs[payTypeConfigs[i].pay_age].map[j].payment_type&&(flag=!0);flag||vm.payWayObjs[payTypeConfigs[i].pay_age].map.push({maxHolderAge:payTypeConfigs[i].maxHolderAge,max_app_age:payTypeConfigs[i].max_app_age,minHolderAge:payTypeConfigs[i].minHolderAge,min_app_age:payTypeConfigs[i].min_app_age,payment_type:payTypeConfigs[i].payment_type})}},vm.getPayWay(),payTypeConfigs&&payTypeConfigs.length>0?(vm.payWay=payTypeConfigs[0].payment_type,vm.payAge=payTypeConfigs[0].pay_age):(vm.payWay=vm.payWays[0].value,vm.payAge=vm.payAges[0].value),$scope.$watch("bddg.payAge",function(newValue){var payAgeNow=newValue;vm.user.payendyear=vm.payWayObjs[payAgeNow].pay_age;for(var map=vm.payWayObjs[payAgeNow].map,i=0;i<map.length;i++)if(map[i].payment_type===vm.payWay){setMinAndMaxAges(map[i]);break}},!0),$scope.$watch("bddg.payWay",function(newValue){for(var paymentType=newValue,map=vm.payWayObjs[vm.payAge].map,i=0;i<map.length;i++)if(map[i].payment_type===paymentType){setMinAndMaxAges(map[i]);break}if(newValue){var user=vm.user;user.sex&&user.birthday&&vm.calc(vm)}},!0),vm.mainPlan={rate:0,amount:"",exp:""},vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType}},vm.getPlan(),$scope.$watch("bddg.user",function(newValue){var user=newValue;if(user.sex&&user.birthday){var birthday=new Date(user.birthday),now=new Date,age=VALIDATION.getAgeByBirth(user.birthday),mouth=now.getMonth()-birthday.getMonth();0==age&&0>mouth&&(mouth=now.getMonth()+12-birthday.getMonth()),(0==age&&mouth>=1||age>=1)&&17>=age||age>=41&&50>=age?vm.mainPlan.amount="200000":age>=18&&40>=age?vm.mainPlan.amount="300000":vm.mainPlan.amount="",vm.calc(vm)}},!0),$scope.$watch("bddg.mainPlan.amount",function(newValue){if(newValue){var user=vm.user;user.sex&&user.birthday&&vm.mainPlan.amount&&vm.calc(vm)}}),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday);if(age>=0&&17>=age||age>=41&&50>=age){if(vm.mainPlan.amount&&2e5!=vm.mainPlan.amount)return $ionicPopup.alert({title:"温馨提示",template:"当被保人为0-17周岁或41到50周岁时，龙行康佑2号恶性肿瘤疾病保险保额只能为200 000！",okText:"我知道了"}),!1}else{if(!(age>=18&&40>=age))return $ionicPopup.alert({title:"温馨提示",template:"当被保人大于等于51周岁时，不能购买龙行康佑2号恶性肿瘤疾病保险！",okText:"我知道了"}),!1;if(vm.mainPlan.amount&&3e5!=vm.mainPlan.amount)return $ionicPopup.alert({title:"温馨提示",template:"当被保人为18到40周岁时，龙行康佑2号恶性肿瘤疾病保险保额只能为300 000！",okText:"我知道了"}),!1}var getKRateByPaytype=function(value){var KRate=0;return 0==value||12==value?KRate=1:6==value?KRate=.52:3==value?KRate=.262:1==value&&(KRate=.09),KRate},params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[],addRate=[];if(vm.mainPlan.exp=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType?mainRate.push(rateTable[i]):"2"==rateTable[i].planType&&addRate.push(rateTable[i]);if(mainRate&&mainRate.length>0){for(var flag=!1,i=0;i<mainRate.length;i++)"A"==mainRate[i].suppriskscore&&(vm.mainPlan.rate=mainRate[i].rate,flag=!0);flag||(vm.mainPlan.rate=mainRate[0].rate),vm.mainPlan.exp=(parseInt(10*vm.mainPlan.rate*getKRateByPaytype(vm.payWay)+.5)/10*(vm.mainPlan.amount/vm.mainPlan.insuredAmount)).toFixed(2),callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan})}}else vm.mainPlan.exp=vm.mainPlan.amount,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.mainPlan.exp=vm.mainPlan.exp.toString(),vm.mainPlan.amount=vm.mainPlan.amount.toString();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.user.payendyear,paymentType:vm.payWay,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BddgController",BddgController),BddgController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BeddController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("bedd.user",function(){$scope.beddForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},!0),$scope.$watch("bedd.mainPlan.exp",function(){$timeout(function(){$scope.beddForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear},config={url:"../statics/json/prdRate/"+vm.productData.prd_id+"/"+vm.productData.prd_id+"_"+user.sex+"_"+age+"_"+vm.productData.pay_age+".json",method:"GET"};CommonRequest.request({},config,function(data){if(data&&data.status){var rateTable=data.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}}else CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}}})})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BeddController",BeddController),BeddController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BenxController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("benx.user",function(){$scope.benxForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},!0),$scope.$watch("benx.mainPlan.exp",function(){$timeout(function(){$scope.benxForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BenxController",BenxController),BenxController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BenyController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.selectedPlan=!1,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:5e4,exp:0},vm.addPlan={rate:0,amount:"100",exp:0},vm.totalAmount=vm.mainPlan.amount+vm.addPlan.amount,vm.totalExp=vm.mainPlan.exp+vm.addPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.selectAddtionalPlan=function(){vm.user.selectedPlan=!vm.user.selectedPlan},vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("beny.user",function(newValue){var user=newValue;$scope.benyForm.$valid&&(vm.age=VALIDATION.getAgeByBirth(user.birthday),vm.ageflag=[],vm.age>=18&&vm.age<=40?vm.ageflag=[{label:"100",value:"100"},{label:"200",value:"200"},{label:"300",value:"300"}]:vm.age>=41&&vm.age<=50?vm.ageflag=[{label:"100",value:"100"},{label:"200",value:"200"}]:vm.ageflag=[{label:"100",value:"100"}])},!0),$scope.$watch("beny.user",function(){$timeout(function(){$scope.benyForm.$valid?vm.calc(vm):vm.totalExp=0},100)},!0),$scope.$watch("beny.mainPlan.amount",function(){$timeout(function(){$scope.benyForm.$valid?vm.calc(vm):vm.totalExp=0},100)},!0),$scope.$watch("beny.addPlan",function(newValue){if(newValue){var user=vm.user;user.sex&&user.birthday&&vm.calc(vm)}},!0),$scope.$watch("beny.user.payendyear",function(){1==vm.user.payendyear?vm.paymentType="0":vm.paymentType="12"},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),selectedPlan=user.selectedPlan,params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[],addRate1=[],addRate2=[];if(vm.mainPlan.exp=0,vm.addPlan.exp=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)if("1"==rateTable[i].planType)"A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]);else if("2"==rateTable[i].planType){if("A"==rateTable[i].suppriskscore){addRate1.push(rateTable[i]);break}addRate2.push(rateTable[i])}mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),addRate1&&addRate1.length>0?vm.addPlan.arate=addRate1[0].rate:addRate2&&addRate2.length>0&&(vm.addPlan.arate=addRate2[0].rate),vm.mainPlan.exp=vm.mainPlan.amount/vm.mainPlan.insuredAmount*vm.mainPlan.rate,"1"==selectedPlan&&(vm.addPlan.exp=vm.addPlan.amount/vm.addPlan.insuredAmount*vm.addPlan.arate)}vm.totalExp=vm.mainPlan.exp+vm.addPlan.exp,callback&&callback({exp:vm.totalExp,mainPlan:vm.mainPlan,addPlan:1==vm.user.selectedPlan?vm.addPlan:null})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.changeConfig()){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,extraPlanId:1==vm.user.selectedPlan?vm.addPlan.planId:0,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:vm.user.selectedPlan,mainPlan:vm.mainPlan,addPlan:1==vm.user.selectedPlan?vm.addPlan:null,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:"0"==vm.user.plan?parseInt(vm.mainPlan.amount)+parseInt(vm.addPlan.amount):parseInt(vm.mainPlan.amount),PbInsuExp:vm.totalExp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("BenyController",BenyController),BenyController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BulsController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("buls.user",function(){$scope.bulsForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},!0),$scope.$watch("buls.mainPlan.exp",function(){$timeout(function(){$scope.bulsForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BulsController",BulsController),BulsController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"];
}(),function(){function BuluController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("bulu.mainPlan.exp",function(val){vm.mainPlan.amount=val},!0),vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("BuluController",BuluController),BuluController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BwlcController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return TipService.showMsg("非法操作！"),void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.payendyear="1",vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("bwlc.user",function(){$timeout(function(){$scope.bwlcForm.$valid?vm.calc(vm):vm.mainPlan.exp=0},100)},!0),$scope.$watch("bwlc.user.payendyear",function(newValue){newValue&&("1"==vm.user.payendyear?vm.paymentType="0":vm.paymentType="12")},!0),$scope.$watch("bwlc.mainPlan.amount",function(){$timeout(function(){$scope.bwlcForm.$valid?vm.calc(vm):vm.mainPlan.exp=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.exp=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.exp=(vm.mainPlan.amount/vm.mainPlan.insuredAmount*vm.mainPlan.rate*100/100).toFixed(2),callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})}}})},vm.checkExp=function(){var exp=vm.mainPlan.exp;return exp?1e4>exp&&"1"==vm.user.payendyear?(TipService.showMsg("该产品趸交保费不得低于10000元人民币"),!1):5e3>exp&&"3"==vm.user.payendyear&&"CWLA"==vm.productData.prd_code?(TipService.showMsg("该产品3年交保费不得低于5000元人民币"),!1):5e3>exp&&"5"==vm.user.payendyear?(TipService.showMsg("该产品5年交保费不得低于5000元人民币"),!1):3e3>exp&&("10"==vm.user.payendyear||"15"==vm.user.payendyear||"20"==vm.user.payendyear)?(TipService.showMsg("该产品10年、15年、20年交保费不得低于3000元人民币"),!1):!0:void 0},vm.goPolicy=function(){if(vm.changeConfig()&&vm.checkExp()){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("BwlcController",BwlcController),BwlcController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function BwldController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.selectedPlan="0",vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}if(vm.mainPlan={rate:0,amount:0,exp:0},vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},vm.plans=vm.productData.plans,vm.mainArr=[],vm.plans&&vm.plans.length>0)for(var i=0;i<vm.plans.length;i++)"1"==vm.plans[i].planType?(vm.mainPlan=vm.plans[i],vm.mainArr.push(vm.mainPlan),vm.mainRisks=vm.mainPlan.insuredAmount,vm.mid=vm.mainPlan.planId):"2"==vm.plans[i].planType&&(vm.addPlan=vm.plans[i],vm.additionaRisk=vm.addPlan.insuredAmount);$scope.$watch("bwld.user",function(){$timeout(function(){$scope.bwldForm.$valid?vm.calc(vm):vm.mainPlan.exp=0},100)},!0),$scope.$watch("bwld.mainPlan.amount",function(){$timeout(function(){if($scope.bwldForm.$valid){var user=vm.user;user.sex&&user.birthday&&vm.calc(vm)}else vm.mainPlan.exp=0},100)},!0),$scope.$watch("bwld.user.payendyear",function(){1==vm.user.payendyear?vm.paymentType="0":vm.paymentType="12"},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status&&(vm.rateTable=result.data,vm.mainRate1=[],vm.mainRate2=[],vm.additionalRate1=[],vm.additionalRate2=[],vm.mainPlan.exp=0,vm.rateTable&&vm.rateTable.length>0)){for(var i=0;i<vm.rateTable.length;i++)"1"==vm.rateTable[i].planType?"A"==vm.rateTable[i].suppriskscore?vm.mainRate1.push(vm.rateTable[i]):vm.mainRate2.push(vm.rateTable[i]):"2"==vm.rateTable[i].planType&&("A"==vm.rateTable[i].suppriskscore?vm.additionalRate1.push(vm.rateTable[i]):vm.additionalRate2.push(vm.rateTable[i]));vm.mainRate1&&vm.mainRate1.length>0?vm.mainPlan.rate=vm.mainRate1[0].rate:vm.mainRate2&&vm.mainRate2.length>0&&(vm.mainPlan.rate=vm.mainRate2[0].rate);var mrate=vm.mainPlan.rate;vm.mainPlan.exp=vm.mainPlan.amount/vm.mainRisks*mrate,callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})}})},vm.checkExp=function(){var exp=vm.mainPlan.exp;return exp?1e4>exp&&"1"==vm.user.payendyear?(TipService.showMsg("该产品趸交保费不得低于10000元人民币"),!1):5e3>exp&&"5"==vm.user.payendyear?(TipService.showMsg("该产品5年交保费不得低于5000元人民币"),!1):3e3>exp&&("10"==vm.user.payendyear||"15"==vm.user.payendyear||"20"==vm.user.payendyear)?(TipService.showMsg("该产品10年、15年、20年交保费不得低于3000元人民币"),!1):!0:void 0},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.changeConfig()&&vm.checkExp()){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:vm.user.selectedPlan,mainPlan:vm.mainPlan,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:parseInt(vm.mainPlan.amount),PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("BwldController",BwldController),BwldController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function CenaController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={sex:"1",birthday:null},vm.nextStepValide=!1,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var setMinAndMaxAges=function(obj){vm.maxAge=obj.max_app_age,vm.minAge=obj.min_app_age,vm.minHolderAge=obj.minHolderAge,vm.maxHolderAge=obj.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))},payTypeConfigs=vm.productData.payTypeConfigs;payTypeConfigs&&payTypeConfigs.length>0&&setMinAndMaxAges(payTypeConfigs[0]),vm.mainPlan={rate:0,amount:5e4,exp:""},vm.addPlan={rate:0,amount:"",exp:"",selectedPlan:!1},vm.addAmountList=[{value:100,label:100},{value:200,label:200},{value:300,label:300}],vm.totalAmount=vm.mainPlan.amount+vm.addPlan.amount,vm.totalExp=vm.mainPlan.exp+vm.addPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0){for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}vm.paymentType=payment_value[0]}if(vm.payWaysShow=vm.payWays,vm.payWayObjs={},payTypeConfigs&&payTypeConfigs.length>0)for(var i=0;i<payTypeConfigs.length;i++)vm.payWayObjs[payTypeConfigs[i].pay_age]={pay_age:payTypeConfigs[i].pay_age,map:{maxHolderAge:payTypeConfigs[i].maxHolderAge,max_app_age:payTypeConfigs[i].max_app_age,minHolderAge:payTypeConfigs[i].minHolderAge,min_app_age:payTypeConfigs[i].min_app_age,payment_type:payTypeConfigs[i].payment_type}}},vm.getPayWay(),vm.payendyear=vm.payWays[0].value;var validateAmount=function(){var validateFlag=!0;return vm.addPlan.selectedPlan&&(validateFlag=!!vm.addPlan.amount),validateFlag},validateInfoAndCalc=function(){vm.user.birthday&&vm.user.sex&&vm.payendyear&&validateAmount()?(vm.nextStepValide=!0,vm.calc(vm)):vm.nextStepValide=!1};$scope.$watch("cena.user",function(newValue){if(newValue){var user=newValue;if(user.sex&&user.birthday){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),payAgeNow=[],payAgeNowStr=[],i=0;i<vm.payWays.length;i++){var mapNow=vm.payWayObjs[vm.payWays[i].value];mapNow.map.min_app_age<=age&&mapNow.map.max_app_age>=age&&(payAgeNow.push(vm.payWays[i]),payAgeNowStr.push(vm.payWays[i].value))}vm.payWaysShow=payAgeNow,vm.payendyear&&payAgeNowStr&&-1==payAgeNowStr.indexOf(vm.payendyear)&&(vm.payendyear=payAgeNowStr[0]),age>=18&&40>=age?vm.addAmountList=[{value:100,label:100},{value:200,label:200},{value:300,label:300}]:age>=41&&50>=age?vm.addAmountList=[{value:100,label:100},{value:200,label:200}]:age>=51&&60>=age&&(vm.addAmountList=[{value:100,label:100}]);for(var addAmountListArr=[],i=0;i<vm.addAmountList.length;i++)addAmountListArr.push(vm.addAmountList[i].value);vm.addPlan.amount&&-1==addAmountListArr.indexOf(vm.addPlan.amount)&&(vm.addPlan.amount="",vm.nextStepValide=!1,vm.calc(vm)),validateInfoAndCalc()}}},!0),$scope.$watch("cena.payendyear",function(newValue){newValue&&(vm.payendyear&&vm.payWayObjs[vm.payendyear]&&setMinAndMaxAges(vm.payWayObjs[vm.payendyear].map),validateInfoAndCalc())},!0),$scope.$watch("cena.mainPlan.amount",function(newValue){newValue?validateInfoAndCalc():(vm.totalExp=0,vm.nextStepValide=!1)},!0),$scope.$watch("cena.addPlan.selectedPlan",function(newValue){newValue||(vm.addPlan.amount=""),validateInfoAndCalc()},!0),$scope.$watch("cena.addPlan.amount",function(){validateInfoAndCalc()},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params=(vm.addPlan.selectedPlan,{prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.payendyear});CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[],addRate=[];if(vm.mainPlan.exp=0,vm.addPlan.exp=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType?mainRate.push(rateTable[i]):"2"==rateTable[i].planType&&addRate.push(rateTable[i]);if(mainRate&&mainRate.length>0){for(var isRisk=!1,i=0;i<mainRate.length;i++)"A"==mainRate[i].suppriskscore&&(vm.mainPlan.rate=mainRate[i].rate,isRisk=!0);isRisk||(vm.mainPlan.rate=mainRate[0].rate),vm.mainPlan.rate?vm.mainPlan.exp=vm.mainPlan.amount/vm.mainPlan.insuredAmount*vm.mainPlan.rate:TipService.showMsg(vm.mainPlan.planName+"费率为空！")}if(vm.addPlan.selectedPlan&&addRate&&addRate.length>0){for(var isRisk=!1,i=0;i<addRate.length;i++)"A"==addRate[i].suppriskscore&&(vm.addPlan.rate=addRate[i].rate,isRisk=!0);isRisk||(vm.addPlan.rate=addRate[0].rate),vm.addPlan.rate?vm.addPlan.exp=vm.addPlan.amount/vm.addPlan.insuredAmount*(10*vm.addPlan.rate)/10:TipService.showMsg(vm.addPlan.planName+"费率为空！")}}else TipService.showMsg("费率为空！");vm.totalAmount=Number(vm.mainPlan.amount)+Number(vm.addPlan.amount),vm.totalExp=Number(vm.mainPlan.exp)+Number(vm.addPlan.exp),callback&&callback({exp:vm.totalExp,mainPlan:vm.mainPlan,addPlan:1==vm.addPlan.selectedPlan?vm.addPlan:null})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,extraPlanId:vm.addPlan.selectedPlan?vm.addPlan.planId:0,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:vm.addPlan.selectedPlan,mainPlan:vm.mainPlan,addPlan:vm.addPlan.selectedPlan?vm.addPlan:null,payendyear:vm.payendyear,paymentType:vm.paymentType,PbInsuAmt:vm.totalAmount,PbInsuExp:vm.totalExp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("CenaController",CenaController),CenaController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter"]}(),function(){function CwlaController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return TipService.showMsg("非法操作！"),void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.payendyear="1",vm.addif="1",vm.socif="Y",vm.accRisk=!0,"811"!=CONFIG.SALE_CHANNEL&&"CWLB"!=vm.productData.prd_code||(vm.addif="0"),vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={rate:0,amount:1e6,exp:"",planName:"建信附加爱康医疗保险",planType:"2",planCode:"BMRB"},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getProductMaterials=function(){PolicyService.getMaterials({prdId:vm.productData.prd_id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data,"[object Array]"===Object.prototype.toString.call(vm.maDetail)&&(vm.maDetail=vm.maDetail.map(function(val){return-1!=val.materialName.indexOf(".pdf")&&(val.materialName=val.materialName.split(".")[0]),val.materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+val.materialPath,val}));for(var i=0;i<vm.maDetail.length;i++)"建信附加爱康医疗保险条款"==vm.maDetail[i].materialName&&(vm.addPath=vm.maDetail[i].materialPath)}})}})},vm.getProductMaterials(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("cwla.user",function(){var aged=VALIDATION.getAgeByBirth(vm.user.birthday);$timeout(function(){aged>59?(vm.accRisk=!1,vm.addif="0"):vm.accRisk=!0,$scope.cwlaForm.amount.$valid&&vm.user.birthday?vm.calc(vm):vm.mainPlan.exp=0},100)},!0),$scope.$watch("cwla.user.payendyear",function(newValue){newValue&&("1"==vm.user.payendyear?vm.paymentType="0":vm.paymentType="12")},!0),$scope.$watch("cwla.mainPlan.amount",function(){$timeout(function(){vm.user.birthday&&$scope.cwlaForm.amount.$valid?vm.calc(vm):vm.mainPlan.exp=0},100)},!0),$scope.$watch("cwla.addif + cwla.mainPlan.exp + cwla.socif",function(){$timeout(function(){if("1"==vm.addif&&vm.mainPlan.exp&&vm.user.birthday){var calcParams={prdCode:"BMRB",prdName:"建信附加爱康医疗保险",insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),insuredDays:"1",insuYearFlag:"Y",planCode:"BMRB_01",channel:CONFIG.SALE_CHANNEL,sex:vm.user.sex,paymentType:"1"==vm.user.payendyear?"0":"12",PbInsuAmt:1e6,payendyear:vm.user.payendyear,socialSecurity:vm.socif};vm.calcAdd(calcParams,function(){})}else vm.expplus="",vm.addPlan.exp=""},100)},!0),vm.calcAdd=function(params,callback){CommonRequest.request(params,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan&&(vm.expplus=(Number(vm.mainPlan.exp)+Number(amountExp[0])).toFixed(2)),vm.addPlan&&(vm.addPlan.exp=amountExp[0]),checkPremiumNum=0,angular.isFunction(callback)&&callback(amountExp[0])}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}},vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.exp=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));
mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.exp=parseInt(vm.mainPlan.amount/vm.mainPlan.insuredAmount*Math.round(100*vm.mainPlan.rate))/100,callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})}}})},vm.checkExp=function(){var exp=vm.mainPlan.exp;return exp?1e4>exp&&"1"==vm.user.payendyear?(TipService.showMsg("该产品趸交的主险保费不得低于10000元人民币"),!1):5e3>exp&&"3"==vm.user.payendyear&&"CWLA"==vm.productData.prd_code?(TipService.showMsg("该产品3年交的主险保费不得低于5000元人民币"),!1):5e3>exp&&"5"==vm.user.payendyear?(TipService.showMsg("该产品5年交的主险保费不得低于5000元人民币"),!1):3e3>exp&&("10"==vm.user.payendyear||"15"==vm.user.payendyear||"20"==vm.user.payendyear)?(TipService.showMsg("该产品10年、15年、20年交的主险保费不得低于3000元人民币"),!1):!0:void 0},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.changeConfig()&&vm.checkExp()){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,selectedPlan:"1"==vm.addif,loveheaPlan:"1"==vm.addif,mainPlan:vm.mainPlan,addPlan:"1"==vm.addif?vm.addPlan:null,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:"1"==vm.addif?parseInt(vm.mainPlan.amount)+1e6:vm.mainPlan.amount,PbInsuExp:vm.expplus||vm.mainPlan.exp,PbBeginDate:effecDate,socialSecurity:vm.socif,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcAdd:vm.calcAdd.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}}angular.module("app").controller("CwlaController",CwlaController),CwlaController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function EnjlController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount+vm.addPlan.amount,vm.totalExp=vm.mainPlan.exp+vm.addPlan.exp,vm.paymentType=vm.productData.payment_type.split(",")[0],vm.payAge=vm.productData.pay_age.split(",")[0],vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),$scope.$watch("enjl.user",function(){$timeout(function(){$scope.enjlForm.$valid?vm.calc(vm):(vm.moneyFirst="",vm.totalExp="")},100)},!0),$scope.$watch("enjl.mainPlan.amount",function(){$timeout(function(){$scope.enjlForm.$valid?vm.calc(vm):(vm.moneyFirst="",vm.totalExp="")},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[],addRate1=[],addRate2=[];if(vm.mainPlan.exp="",vm.addPlan.exp="",rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType?"A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]):"2"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?addRate1.push(rateTable[i]):addRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),addRate1&&addRate1.length>0?vm.addPlan.rate=addRate1[0].rate:addRate2&&addRate2.length>0&&(vm.addPlan.rate=addRate2[0].rate),vm.mainPlan.exp=parseInt(vm.mainPlan.amount/vm.mainPlan.insuredAmount*vm.mainPlan.rate*10*85)/1e4,vm.addPlan.amount=vm.mainPlan.amount,vm.addPlan.exp=parseInt(vm.addPlan.amount/vm.addPlan.insuredAmount*vm.addPlan.rate*10*85)/1e4}vm.totalExp=Math.round(1e4*vm.mainPlan.exp+1e4*vm.addPlan.exp)/1e4,vm.totalExp=vm.totalExp.toFixed(2),vm.moneyFirst=2*vm.totalExp,vm.moneyFirst=vm.moneyFirst.toFixed(2),vm.mainPlan.exp=2*vm.mainPlan.exp,vm.addPlan.exp=2*vm.addPlan.exp,callback&&callback({exp:vm.moneyFirst,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,extraPlanId:vm.addPlan.planId,premiumResult:vm.moneyFirst,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,addPlan:vm.addPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:parseInt(vm.mainPlan.amount)+parseInt(vm.addPlan.amount),PbInsuExp:vm.moneyFirst,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("EnjlController",EnjlController),EnjlController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function EnjpController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("enjp.user",function(){$scope.enjpForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},!0),$scope.$watch("enjp.mainPlan.exp",function(){$timeout(function(){$scope.enjpForm.$valid?vm.calc(vm):vm.mainPlan.amount=0},100)},!0),vm.calc=function(vm,callback){var user=vm.user,age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate1=[],mainRate2=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&("A"==rateTable[i].suppriskscore?mainRate1.push(rateTable[i]):mainRate2.push(rateTable[i]));mainRate1&&mainRate1.length>0?vm.mainPlan.rate=mainRate1[0].rate:mainRate2&&mainRate2.length>0&&(vm.mainPlan.rate=mainRate2[0].rate),vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}}})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("EnjpController",EnjpController),EnjpController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function EnllController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout){function createComparisonFunction(propertyName){return function(obj1,obj2){var value1=obj1[propertyName],value2=obj2[propertyName];return value2>value1?-1:value1>value2?1:0}}function reSort(sortObj,sortName){var array=[],obj=null;for(obj in sortObj)array.push(sortObj[obj]);array.sort(createComparisonFunction(sortName));var i,newObj={};for(i=0;i<array.length;i++){var label=array[i].label;newObj[label]=array[i]}return{array:array,newObj:newObj}}var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.params=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){for(var minAge="",maxAge="",i=0;i<payTypeConfigs.length;i++){var payTypeConfig=payTypeConfigs[i];0==i?(minAge=payTypeConfig.min_app_age,maxAge=payTypeConfig.max_app_age):(minAge>payTypeConfig.min_app_age&&(minAge=payTypeConfig.min_app_age),maxAge<payTypeConfig.max_app_age&&(maxAge=payTypeConfig.max_app_age))}vm.defMinAge=vm.minAge=minAge,vm.defMaxAge=vm.maxAge=maxAge,vm.minHolderAge=payTypeConfigs[0].minHolderAge,vm.maxHolderAge=payTypeConfigs[0].maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.productData.prdSubscribe&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={rate:0,amount:"",exp:""},vm.totalExp=0,vm.totalAmount=0,vm.KObj={"-1":{value:1,label:"不定期交"},0:{value:1,label:"趸交"},1:{value:.08333333,label:"月交"},3:{value:1,label:"季交"},6:{value:1,label:"半年交"},12:{value:1,label:"年交"},98:{value:1,label:"交至某确定年龄"},99:{value:1,label:"终生交费"}},vm.getPlan=function(){var insuYearUnitObj={Y:"年",M:"月",D:"天",A:"周岁"},plan=vm.productData.plans,len=plan.length;vm.securityObj={};for(var flgStr=[],i=len-1;i>=0;i--){var item=plan[i];if("1"==item.planType){var label=item.insuYear+insuYearUnitObj[item.insuYearFlag];"A"==item.insuYearFlag&&(label="至"+label),-1===flgStr.join(",").indexOf(label)&&(flgStr.push(label),angular.extend(item,{label:label}),vm.securityObj[label]=item)}else"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan();var reSetAmountMax=function(plan){var age=VALIDATION.getAgeByBirth(vm.user.birthday),newPlan=plan,maxBuyQautity="",insuredAmount=newPlan.insuredAmount;return 9>=age?maxBuyQautity=2e5/insuredAmount:age>=10&&17>=age?maxBuyQautity=3e5/insuredAmount:age>=18&&40>=age?maxBuyQautity=3e5/insuredAmount:age>=41&&45>=age?maxBuyQautity=2e5/insuredAmount:age>=46&&50>=age&&(maxBuyQautity=1e5/insuredAmount),maxBuyQautity=maxBuyQautity.toString(),angular.extend(newPlan,{maxBuyQautity:maxBuyQautity}),angular.extend(vm.addPlan,{insuYear:newPlan.insuYear,insuYearFlag:newPlan.insuYearFlag,maxBuyQautity:maxBuyQautity}),newPlan},getPaymentType=function(paymentTypeStr){paymentTypeStr=paymentTypeStr||vm.paymentTypeStr;var obj=vm.payWaySObjs[paymentTypeStr][vm.payAgeStr][vm.securityStr];vm.paymentType=obj.payment_type},getPayAge=function(payAgeStr){payAgeStr=payAgeStr||vm.payAgeStr;var obj=vm.payWaySObjs[vm.paymentTypeStr][payAgeStr][vm.securityStr];vm.user.payendyear=obj.pay_age},getPlan=function(securityStr){securityStr=securityStr||vm.securityStr;var obj=vm.payWaySObjs[vm.paymentTypeStr][vm.payAgeStr][securityStr],plan=obj.plan;vm.user.birthday&&(plan=reSetAmountMax(plan)),angular.extend(vm.mainPlan,plan),angular.extend(vm.mainPlan,{insuredAmount_e:(10*plan.insuredAmount).toString(),minBuyQautity_e:(plan.minBuyQautity/10).toString(),maxBuyQautity_e:(plan.maxBuyQautity/10).toString()}),vm.security=obj.plan.insuYear};vm.getPayWayAndSecurity=function(){var payAgeUnitObj={Y:"年",M:"月",D:"天",A:"年龄"},payAgeSecurity_MaxAge={"10年":{"20年":{min:18,max:45},"30年":{min:18,max:50},"至70周岁":{min:0,max:45},"至80周岁":{min:0,max:50}},"15年":{"20年":{min:18,max:45},"30年":{min:18,max:45},"至70周岁":{min:0,max:45},"至80周岁":{min:0,max:50}},"20年":{"30年":{min:18,max:45},"至70周岁":{min:0,max:40},"至80周岁":{min:0,max:45}}},setPayAgeSecuritys=function(config,paymentStr,payAgeStr,flag){var securityS={},obj=null,payObj={};for(obj in vm.securityObj){var label=vm.securityObj[obj].label,age_Obj=payAgeSecurity_MaxAge[payAgeStr][label];if(age_Obj){var minApp_age=age_Obj.min,maxApp_age=age_Obj.max;payObj[label]={maxHolderAge:config.maxHolderAge,max_app_age:maxApp_age.toString(),minHolderAge:config.minHolderAge,min_app_age:minApp_age.toString(),payment_type:config.payment_type,pay_age:config.pay_age,payAgeUnit:config.payAgeUnit,plan:vm.securityObj[obj]}}}flag?vm.payWaySObjs[paymentStr][payAgeStr]=payObj:(securityS[payAgeStr]=payObj,vm.payWaySObjs[paymentStr]=securityS)};vm.payWays=[],vm.payAgeObj={},vm.payAges={},vm.securityObjs={},vm.payWaySObjs={};var payment_type=[];if(payTypeConfigs&&payTypeConfigs.length>0)for(i=0;i<payTypeConfigs.length;i++){var payTypeConfig=payTypeConfigs[i],payAgeUnitFlag=payTypeConfig.payAgeUnit||"Y",payAgeUnit=payAgeUnitObj[payAgeUnitFlag]||"年",payAge_Str=payTypeConfig.pay_age+payAgeUnit;vm.payAgeObj[payAge_Str]={pay_age:payTypeConfig.pay_age,label:payAge_Str};var payment_Str=vm.KObj[payTypeConfig.payment_type+""].label;if(-1===payment_type.join(",").indexOf(payment_Str))payment_type.push(payment_Str),setPayAgeSecuritys(payTypeConfig,payment_Str,payAge_Str,!1);else{var flag=!1,payAge_obj=null;for(payAge_obj in vm.payWaySObjs[payment_Str])payAge_obj.pay_age===payTypeConfig.pay_age&&(flag=!0);flag||setPayAgeSecuritys(payTypeConfig,payment_Str,payAge_Str,!0)}}var obj=null,payAges=[],securityObjs=[];for(obj in vm.payWaySObjs)vm.payWays.push(obj);console.log(vm.payWays),vm.paymentTypeStr=vm.payWays[0];var payAgeObj=vm.payWaySObjs[vm.paymentTypeStr];for(obj in payAgeObj)payAges.push(obj),vm.payAges[obj]=vm.payAgeObj[obj];vm.payAgeObjForShow=[];for(var i=0;i<payAges.length;i++)vm.payAgeObjForShow.push({label:payAges[i]});vm.payAgeStr=payAges[0];var securityObj=vm.payWaySObjs[vm.paymentTypeStr][vm.payAgeStr];for(obj in securityObj)securityObjs.push(obj),vm.securityObjs[obj]=vm.securityObj[obj];vm.securityObjForShow=[];for(var i=0;i<securityObjs.length;i++)vm.securityObjForShow.push({label:securityObjs[i]});vm.securityStr=securityObjs[0],getPaymentType(vm.paymentTypeStr),getPayAge(vm.payAgeStr),getPlan(vm.securityStr)},vm.getPayWayAndSecurity();var setMinAndMaxAges=function(paymentTypeStr,payAgeStr,securityStr){var obj=vm.payWaySObjs[paymentTypeStr][payAgeStr][securityStr];vm.maxAge=obj.max_app_age,vm.minAge=obj.min_app_age,vm.minHolderAge=obj.minHolderAge,vm.maxHolderAge=obj.maxHolderAge},isEqualed=function(oldValue,objForShow){for(var flag=!1,i=0;i<objForShow.length;i++)oldValue==objForShow[i].label&&(flag=!0);return flag},setPayAges=function(age,paymentTypeStr){var Objs=vm.payWaySObjs[paymentTypeStr],obj=null;vm.payAgeObjForShow=[],vm.payAges={};for(obj in Objs)age>45&&50>=age?"10年"!=obj&&"15年"!=obj||(vm.payAges[obj]=vm.payAgeObj[obj],vm.payAgeObjForShow.push({label:vm.payAgeObj[obj].label})):(vm.payAges[obj]=vm.payAgeObj[obj],vm.payAgeObjForShow.push({label:vm.payAgeObj[obj].label}));var newSortObj=reSort(vm.payAges,"pay_age");vm.payAges=newSortObj.newObj,isEqualed(vm.securityStr,vm.payAgeObjForShow)||(vm.payAgeStr=vm.payAgeObjForShow[0].label)},setSecuritys=function(age,paymentTypeStr,payAgeStr){var Objs=vm.payWaySObjs[paymentTypeStr][payAgeStr],obj=null;vm.securityObjForShow=[],vm.securityObjs={};for(obj in Objs)age>=46&&50>=age?"30年"!=obj&&"至80周岁"!=obj||age<=Objs[obj].max_app_age&&(vm.securityObjs[obj]=vm.securityObj[obj],vm.securityObjForShow.push({label:vm.securityObj[obj].label})):"20年"==obj||"30年"==obj?age>=18&&age<=Objs[obj].max_app_age&&(vm.securityObjs[obj]=vm.securityObj[obj],vm.securityObjForShow.push({label:vm.securityObj[obj].label})):age<=Objs[obj].max_app_age&&(vm.securityObjs[obj]=vm.securityObj[obj],vm.securityObjForShow.push({label:vm.securityObj[obj].label}));var newSortObj=reSort(vm.securityObjs,"insuYear");vm.securityObjs=newSortObj.newObj,isEqualed(vm.securityStr,vm.securityObjForShow)||(vm.securityStr=vm.securityObjForShow[0].label)},ageChange=function(birthday){var age=VALIDATION.getAgeByBirth(birthday);return age>=51?void TipService.showMsg("最高投保年龄50周岁！"):(setPayAges(age,vm.paymentTypeStr),setSecuritys(age,vm.paymentTypeStr,vm.payAgeStr),getPaymentType(vm.paymentTypeStr),getPayAge(vm.payAgeStr),getPlan(vm.securityStr),void setMinAndMaxAges(vm.paymentTypeStr,vm.payAgeStr,vm.securityStr))};$scope.$watch("enll.user.birthday",function(newValue){var birthday=newValue;birthday&&ageChange(birthday)},!0),$scope.$watch("enll.paymentTypeStr",function(newValue){var paymentTypeStr=newValue;if(paymentTypeStr){if(vm.user.birthday){var age=VALIDATION.getAgeByBirth(vm.user.birthday);setPayAges(age,paymentTypeStr),setSecuritys(age,paymentTypeStr,vm.payAgeStr)}getPaymentType(paymentTypeStr),getPayAge(vm.payAgeStr),getPlan(vm.securityStr),setMinAndMaxAges(paymentTypeStr,vm.payAgeStr,vm.securityStr),vm.user.birthday&&vm.mainPlan.amount&&vm.calc(vm)}},!0),$scope.$watch("enll.payAgeStr",function(newValue){var payAgeStr=newValue;if(payAgeStr){if(vm.user.birthday){var age=VALIDATION.getAgeByBirth(vm.user.birthday);setSecuritys(age,vm.paymentTypeStr,payAgeStr)}getPayAge(payAgeStr),getPlan(vm.securityStr),setMinAndMaxAges(vm.paymentTypeStr,payAgeStr,vm.securityStr),vm.user.birthday&&vm.mainPlan.amount&&vm.calc(vm)}},!0),$scope.$watch("enll.securityStr",function(newValue){var securityStr=newValue;securityStr&&(getPlan(securityStr),setMinAndMaxAges(vm.paymentTypeStr,vm.payAgeStr,securityStr),vm.user.birthday&&vm.mainPlan.amount&&vm.calc(vm))},!0),$scope.$watch("enll.user",function(newValue){var user=newValue;user.sex&&user.birthday&&$timeout(function(){vm.mainPlan.amount&&vm.calc(vm)},300)},!0),$scope.$watch("enll.mainPlan.amount",function(newValue){newValue?$timeout(function(){$scope.enllForm.$valid?vm.calc(vm):(vm.totalExp=0,vm.totalAmount=0)},100):(vm.totalExp=0,vm.totalAmount=0)},!0),vm.calc=function(vm,callback){var user=vm.user,tipMaxAge="",tipMinAge="",mainPlan=vm.mainPlan,age=VALIDATION.getAgeByBirth(user.birthday);if(age>mainPlan.max_app_age)return void TipService.showMsg("最高投保年龄"+mainPlan.max_app_age+"周岁！");if(9>=age){if(tipMaxAge=9,tipMinAge=0,vm.mainPlan.amount>2e5)return void TipService.showMsg("被保人年龄"+tipMinAge+"到"+tipMaxAge+"周岁，龙佑安康智尊版限额20万元，您的投保保额不在限额内！")}else if(age>=10&&40>=age){if(tipMinAge=10,tipMaxAge=40,vm.mainPlan.amount>3e5)return void TipService.showMsg("被保人年龄"+tipMinAge+"到"+tipMaxAge+"周岁，龙佑安康智尊版限额20万元，您的投保保额不在限额内！")}else if(age>=41&&45>=age){if(tipMinAge=41,tipMaxAge=45,vm.mainPlan.amount>2e5)return void TipService.showMsg("被保人年龄"+tipMinAge+"到"+tipMaxAge+"周岁，龙佑安康智尊版限额20万元，您的投保保额不在限额内！")}else if(age>=46&&50>=age&&(tipMinAge=46,tipMaxAge=50,vm.mainPlan.amount>1e5))return void TipService.showMsg("被保人年龄"+tipMinAge+"到"+tipMaxAge+"周岁，龙佑安康智尊版限额20万元，您的投保保额不在限额内！");var getRate=function(rateObj){return rateObj.A.rate||rateObj.B.rate||rateObj.C.rate||rateObj.D.rate||rateObj.Ary[0].rate||null},isPramsEqual=function(vm,params){if(vm.params){var paramsOld=vm.params.prdId+vm.params.age+vm.params.sex+vm.params.payEndYear+"",paramsNew=params.prdId+params.age+params.sex+params.payEndYear+"";return vm.params=params,paramsOld===paramsNew}return vm.params=params,!1},toDoCalc=function(vm){var mainRateObj={Ary:[]},addRateObj={Ary:[]};vm.mainPlan.exp=0,vm.addPlan.exp=0,vm.totalExp=0,vm.totalAmount=0;for(var i=0;i<vm.rateTable.length;i++){var rateItem=vm.rateTable[i];"1"==rateItem.planType&&rateItem.planCode==vm.mainPlan.planCode&&rateItem.insuyear==vm.security&&(mainRateObj.Ary.push(rateItem),mainRateObj[rateItem.suppriskscore]=rateItem),"2"==rateItem.planType&&rateItem.insuyear==vm.security&&(addRateObj.Ary.push(rateItem),addRateObj[rateItem.suppriskscore]=rateItem)}var K=vm.KObj[vm.paymentType+""].value;if(mainRateObj&&mainRateObj.Ary.length>0&&(vm.mainPlan.rate=getRate(mainRateObj),vm.mainPlan.exp=Math.round(10*vm.mainPlan.rate*K*1e8*(vm.mainPlan.amount/vm.mainPlan.insuredAmount)/1e9,0),"1"==vm.paymentType&&(vm.mainPlan.exp=2*parseInt(vm.mainPlan.exp)),addRateObj&&addRateObj.Ary.length>0&&(vm.addPlan.amount=vm.mainPlan.amount,vm.addPlan.rate=getRate(addRateObj),vm.addPlan.exp=Math.round(10*vm.addPlan.rate*K*1e8*(vm.addPlan.amount/vm.addPlan.insuredAmount)/1e9,0),"1"==vm.paymentType&&(vm.addPlan.exp=2*parseInt(vm.addPlan.exp)),vm.totalExp=parseInt(vm.mainPlan.exp)+parseInt(vm.addPlan.exp),vm.totalAmount=2*parseInt(vm.mainPlan.amount),"1"==vm.paymentType?vm.expByYear=6*vm.totalExp:"12"==vm.paymentType&&(vm.expByYear=vm.totalExp),callback))){if(vm.expByYear<1e3)return void TipService.showMsg('由于您的被保人信息进行了变更，保费变化为：<span class="fs20 orange">'+vm.totalExp+"</span>元，但ENLL最低年化保费不得低于1000元！");callback&&callback({exp:vm.totalExp,amount:vm.totalAmount,mainPlan:vm.mainPlan,addPlan:vm.addPlan})}},params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:user.payendyear},paramsFalg=isPramsEqual(vm,params);paramsFalg?toDoCalc(vm):CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){1==result.status&&(vm.rateTable=result.data,vm.rateTable&&vm.rateTable.length>0&&toDoCalc(vm))})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}if(PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.totalExp=vm.totalExp.toString(),vm.totalAmount=vm.totalAmount.toString(),vm.user.selectedPlan="1",vm.expByYear<1e3)return void TipService.showMsg("最低年化保费不得低于1000元！");var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,extraPlanId:"1"==vm.user.selectedPlan?vm.addPlan.planId:0,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,selectedPlan:vm.user.selectedPlan,mainPlan:vm.mainPlan,addPlan:vm.addPlan,payendyear:vm.user.payendyear,paymentType:vm.paymentType,PbInsuAmt:vm.totalAmount,PbInsuExp:vm.totalExp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("EnllController",EnllController),EnllController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function FsbController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:0,exp:0},vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.startTime=new Date;var nowDate=new Date;if(vm.minDate=nowDate,2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime,vm.startTime=planSaleTime)}vm.maxDate=new Date(vm.minDate.getTime()+314496e5),vm.startTime=vm.minDate,vm.startCallback=function(val){val&&(vm.startTime=val)},vm.getEndTime=function(plan){if(plan){var temp,insuYear=plan.insuYear,insuYearFlag=plan.insuYearFlag;if(insuYear&&insuYearFlag){switch(insuYearFlag){case"Y":temp=365*parseInt(insuYear)*24*60*60*1e3;break;case"M":temp=30*parseInt(insuYear)*24*60*60*1e3;break;case"D":temp=24*parseInt(insuYear)*60*60*1e3;break;case"A":temp=365*parseInt(insuYear)*24*60*60*1e3}vm.endTime=new Date(vm.startTime.getTime()+temp)}}},vm.selectPlan=function(planId){if(vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId&&(vm.selectedPlans=vm.productData.plans[i],vm.getEndTime());vm.mainPlan.exp=vm.selectedPlans.normalPrice,vm.mainPlan.amount=vm.selectedPlans.insuredAmount,vm.user.selectedPlan=vm.selectedPlans.planId},vm.productData.token?PolicyService.getCardInfo(vm.productData.token,function(data){var plId,duties=data.prmLotDutySetModels;if(duties&&duties.length>0&&(plId=duties[0].planId),vm.productData.plans&&vm.productData.plans.length>0){for(var k=0;k<vm.productData.plans.length;k++){var plan=vm.productData.plans[k];if(plId==plan.planId){var l1=duties.length,l2=plan.dutys.length;if(l1!=l2)for(var ilId=duties[0].ilId,m=0;m<plan.dutys.length;m++)ilId==plan.dutys[m].dutyId&&(plan.dutys=[plan.dutys[m]]);vm.productData.plans=vm.productData.plans=[plan];break}}vm.user.selectedPlan=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlan)}}):(vm.user.selectedPlan=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlan)),$scope.$watch("fsb.startTime",function(newValue){newValue&&vm.getEndTime(vm.selectedPlans)}),$scope.$watch("fsb.user.selectedPlan",function(newValue){if(newValue&&(vm.plans=[],vm.productData.plans&&vm.productData.plans.length>0))for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==newValue&&(vm.selectedPlans=vm.productData.plans[i],angular.extend(vm.mainPlan,vm.selectedPlans),vm.getEndTime())}),vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){var _data;PolicyService.control({state:"product-purchase-calculate",control:"data",data:(_data={selectedPlan:vm.user.selectedPlan,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startTime,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp},_defineProperty(_data,"PbBeginDate",effecDate),_defineProperty(_data,"pbApplNoNum",1),_defineProperty(_data,"isWholeSale","0"==vm.paymentType),_defineProperty(_data,"minAge",vm.minAge),_defineProperty(_data,"maxAge",vm.maxAge),_defineProperty(_data,"minHolderAge",vm.minHolderAge),_defineProperty(_data,"maxHolderAge",vm.maxHolderAge),_defineProperty(_data,"oldPrice",vm.mainPlan.exp),
_data)});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("FsbController",FsbController),FsbController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope"]}(),function(){function HmraController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.mainPlan={rate:0,amount:0,exp:0},vm.user={},vm.user.birthday=null,vm.nextStep=!0,vm.mainPlan.amount=1e6,vm.mainPlan.socialSecurity="Y",vm.nextStep=!0,vm.ifShowInfo0=!1,vm.ifShowInfo1=!1,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)},vm.navActiveCss=function(index,amount,socialSecurity){for(var normalNav=document.getElementsByName("nav"),i=0;i<normalNav.length;i++)normalNav[i].className="normal-nav",normalNav[0].style.marginLeft="0px",i==index&&(normalNav[i].className="active-nav");vm.mainPlan.amount=amount,vm.mainPlan.socialSecurity=socialSecurity,vm.showInfoStr(amount,socialSecurity),vm.setPlan()},vm.showInfoContent=function(index){0==index?vm.ifShowInfo0?vm.ifShowInfo0=!1:vm.ifShowInfo0=!0:1==index&&(vm.ifShowInfo1?vm.ifShowInfo1=!1:vm.ifShowInfo1=!0)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.setPlan=function(){if(vm.chosePlanFlag=vm.mainPlan.amount/1e6-1,vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.chosePlanFlag==i&&(vm.selectedPlans=vm.productData.plans[i],angular.extend(vm.mainPlan,vm.selectedPlans));vm.user.birthdayfm&&vm.user.sex&&vm.calc(vm)},vm.setPlan(),vm.showInfoStr=function(amount,socialSecurity){vm.amountStr=amount/1e4+"万",vm.doubleAmountStr=amount/1e4*2+"万"},vm.showInfoStr(vm.mainPlan.amount,vm.mainPlan.socialSecurity),$scope.$watch("hmra.user.birthday",function(newValue){newValue&&(vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex&&vm.mainPlan.amount&&vm.calc(vm))}),$scope.$watch("hmra.user.sex",function(newValue){newValue&&vm.user.birthdayfm&&vm.mainPlan.amount&&vm.calc(vm)}),vm.calc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:vm.mainPlan.socialSecurity,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.productData.token,vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:vm.mainPlan.socialSecurity,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("HmraController",HmraController),HmraController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function IlclController($state,VALIDATION,$scope,$document,CommonRequest,CONFIG,TipService,PolicyService,$filter,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:0},vm.getPlan=function(){var plan=vm.productData.plans;plan&&plan.length>=1&&(vm.mainPlan=plan[0])},vm.getPlan(),vm.account=vm.productData.prdAccount;var type1=[],type2=[];angular.forEach(vm.account,function(data){1==data.currentAcountFlg?type1.push(data):type2.push(data)}),vm.accountStar=type1,vm.account=type2,vm.paymentType=vm.productData.payment_type.split(",")[0],vm.payAge=vm.productData.pay_age,vm.onlyOne=function(){var ilclForm=$document[0].ilclForm;1==type1.length?vm.mainPlan.amount>=1e3&&(ilclForm.type0.value=vm.mainPlan.amount):ilclForm.type0.value=vm.mainPlan.amount},vm.button=!1,vm.add=function(){vm.button=!vm.button},vm.submitAccount=function(){vm.totalScore=0;for(var ilclForm=$document[0].ilclForm,score=[],accountScore=[],i=0;i<type1.length;i++)score.push(ilclForm["type"+i].value);accountScore=score;for(var k=0;k<vm.productData.prdAccount.length;k++)if(1==vm.productData.prdAccount[k].currentAcountFlg)for(var l=0;l<accountScore.length;l++){vm.productData.prdAccount[k].PbInsuExp=accountScore[l],accountScore=accountScore.slice(1);break}else vm.productData.prdAccount[k].PbInsuExp="0.0";for(var j=0;j<score.length;j++)vm.totalScore+=parseInt(score[j]),vm.mainPlan.exp=vm.totalScore;parseInt(vm.mainPlan.amount)!=vm.totalScore?TipService.showMsg($rootScope.TIPS.PRODUCT.ILCL_TOTAL_ERROR):vm.goPolicy()},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.productData.plans[0].planId,premiumResult:vm.totalScore,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:parseInt(vm.mainPlan.amount),PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,prdAccount:vm.productData.prdAccount}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IlclController",IlclController),IlclController.$inject=["$state","VALIDATION","$scope","$document","CommonRequest","CONFIG","TipService","PolicyService","$filter","$rootScope"]}(),function(){function IpahController($state,$scope,CONFIG,CommonRequest,VALIDATION,PolicyService,TipService,$filter,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.planTypes=[{key:"B",value:"不含意外医疗"}],vm.paymentWay=vm.planTypes[0].key,vm.planSelect=[{key:"1",value:"标准版"},{key:"2",value:"精英版"},{key:"3",value:"尊贵版"},{key:"4",value:"至尊版"}],vm.planCode=vm.planSelect[0].key,vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.mainPlan={rate:0,amount:0,exp:0},vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.startTime=new Date;var nowDate=new Date;if(vm.minDate=nowDate,2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime,vm.startTime=planSaleTime)}vm.maxDate=new Date(vm.minDate.getTime()+314496e5),vm.startTime=vm.minDate,vm.startCallback=function(val){val&&(vm.startTime=val)},vm.getEndTime=function(plan){if(plan){var temp,insuYear=plan.insuYear,insuYearFlag=plan.insuYearFlag;if(insuYear&&insuYearFlag){switch(insuYearFlag){case"Y":temp=365*parseInt(insuYear)*24*60*60*1e3;break;case"M":temp=30*parseInt(insuYear)*24*60*60*1e3;break;case"D":temp=24*parseInt(insuYear)*60*60*1e3;break;case"A":temp=365*parseInt(insuYear)*24*60*60*1e3}vm.endTime=new Date(vm.startTime.getTime()+temp)}}},$scope.$watch("ipah.startTime",function(newValue){newValue&&vm.getEndTime(vm.selectedPlan)}),vm.plans=vm.productData.plans,vm.checkType=function(paymentWay,planCode){if(vm.plans&&vm.plans.length>0)for(var i=0;i<vm.plans.length;i++)vm.plans[i].planCode==paymentWay+planCode&&(vm.selectedPlan=vm.plans[i],angular.extend(vm.mainPlan,vm.selectedPlan),vm.getEndTime(vm.selectedPlan),vm.mainPlan.exp=vm.productData.token?0:vm.selectedPlan.normalPrice,vm.mainPlan.amount=vm.selectedPlan.insuredAmount)},vm.productData.token?PolicyService.getCardInfo(vm.productData.token,function(data){var plId,duties=data.prmLotDutySetModels;if(vm.newduty=[],duties&&duties.length>0&&(plId=duties[0].planId),vm.productData.plans&&vm.productData.plans.length>0){for(var k=0;k<vm.productData.plans.length;k++){var plan=vm.productData.plans[k];if(plId==plan.planId){var l1=duties.length,l2=plan.dutys.length;if(l1!=l2){for(var m=0;m<plan.dutys.length;m++)for(var dutyId=plan.dutys[m].dutyId,j=0;j<duties.length;j++)if(dutyId==duties[j].ilId){vm.newduty.push(plan.dutys[m]);break}}else vm.newduty=plan.dutys;plan.dutys=vm.newduty,vm.productData.plans=vm.productData.plans=[plan];break}}for(var m=0;m<vm.planTypes.length;m++)if(-1!=vm.productData.plans[0].planCode.substr(0,1).indexOf(vm.planTypes[m].key)){vm.planTypes=[vm.planTypes[m]];break}for(var n=0;n<vm.planSelect.length;n++)if(-1!=vm.productData.plans[0].planName.indexOf(vm.planSelect[n].value)){vm.planSelect=[vm.planSelect[n]];break}vm.paymentWay=vm.planTypes[0].key,vm.planCode=vm.planSelect[0].key,vm.checkType(vm.paymentWay,vm.planCode)}}):vm.checkType(vm.paymentWay,vm.planCode),vm.goPolicy=function(){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startTime,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.selectedPlan.normalPrice}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpahController",IpahController),IpahController.$inject=["$state","$scope","CONFIG","CommonRequest","VALIDATION","PolicyService","TipService","$filter","$rootScope"]}(),function(){function IpahaActivityController($state,CONFIG,CommonRequest,TipService,PolicyService,$filter,VALIDATION,$rootScope,$scope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.start="",vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}if(vm.mainPlan={rate:0,amount:0,exp:0},vm.codeArr=[],angular.extend(vm.mainPlan,vm.productData.plans[0]),vm.paymentType=vm.productData.payment_type.split(",")[0],vm.payAge=vm.productData.pay_age,vm.getRate=function(callback){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){1==result.status&&(vm.rateTable=result.data,angular.isFunction(callback)&&callback())})},vm.newDuties=[],vm.getDutyList=function(cardDuties){if(vm.productData&&(vm.plans=vm.productData.plans,vm.plans&&1==vm.plans.length&&(vm.duties=vm.plans[0].dutys,vm.duties&&vm.duties.length>0)))for(var duties=vm.duties,i=0;i<duties.length-1;i++)for(var duty1=duties[i],j=i+1;j<duties.length;j++){var duty2=duties[j],code1=duty1.ilCode.substr(0,6).toLowerCase(),code2=duty2.ilCode.substr(0,6).toLowerCase(),amount1=parseInt(duty1.insuredAmount),amount2=parseInt(duty2.insuredAmount),minSaleQuantity=parseInt(duty1.minSaleQuantity),maxSaleQuantity=parseInt(duty1.maxSaleQuantity),amountArr=[];if(code1==code2)if(amount1!=amount2){for(var k=minSaleQuantity;maxSaleQuantity>=k;k++)amountArr.push({key:k,value:amount1*k+"/"+amount2*k+"万"});vm.newDuties.push({ilName:duty1.ilName+"/"+duty2.ilName.substr(duty2.ilName.length-2,2),insuredAmount:amountArr,dutyId:duty1.ilCode.indexOf("01")>0?duty1.dutyId:duty2.dutyId,num:minSaleQuantity,amount:amount1+amount2,minSaleQuantity:minSaleQuantity,rates:[],ilCode:code1.substr(code1.length-1,1)})}else{for(var l=minSaleQuantity;maxSaleQuantity>=l;l++)amountArr.push({key:l,value:amount2*l+"万"});vm.newDuties.push({ilName:vm.duties[i].ilName+"/"+vm.duties[j].ilName.substr(vm.duties[j].ilName.length-2,2),insuredAmount:amountArr,dutyId:duty1.ilCode.indexOf("01")>0?duty1.dutyId:duty2.dutyId,num:minSaleQuantity,amount:amount1,minSaleQuantity:minSaleQuantity,rates:[],ilCode:code1.substr(code1.length-1,1)})}}},vm.getDutyList(),vm.initDuties=function(){for(var i=0;i<vm.newDuties.length;i++)vm.newDuties[i].checked=!0,vm.newDuties[i].exp=0},vm.initDuties(),vm.totalExp=0,vm.calc=function(){var duties=vm.newDuties;vm.totalExp=0,vm.totalAmount=0;for(var i=duties.length-1;i>=0;i--){var duty=duties[i],checked=duty.checked,rates=duty.rates,num=duty.num,exp=0,amount=duty.amount*num;if(checked){for(var j=rates.length-1;j>=0;j--){var rate=rates[j];exp+=100*rate*num}vm.newDuties[i].exp=exp/100}vm.totalExp+=exp,vm.totalAmount+=amount}vm.codeArr=[],vm.duties=[];for(var m=0;m<duties.length;m++)1==duties[m].checked&&(vm.codeArr.push(duties[m].ilCode.toUpperCase()+";"+duties[m].num),vm.duties.push({dutyId:duties[m].dutyId,ilCode:duties[m].ilCode,ilName:duties[m].ilName,insuredAmount:duties[m].amount*duties[m].num,num:duties[m].num,exp:duties[m].exp}));vm.totalExp=vm.totalExp/100},vm.dates=[],vm.plusOneDay=function(date){return date?new Date(date.getTime()+864e5):void 0},vm.minusOneDay=function(date){return date?new Date(date.getTime()-864e5):void 0},vm.nowDate=new Date("2016-12-31"),2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>vm.nowDate.getTime()&&(vm.nowDate=planSaleTime)}vm.maxDate=new Date(vm.nowDate.getTime()+1728e5),vm.getRateByTime=function(){for(var dates=vm.dates,rates=vm.rateTable,duties=vm.newDuties,i=duties.length-1;i>=0;i--){var duty=duties[i];vm.newDuties[i].rates=[];for(var j=dates.length-1;j>=0;j--)for(var date=dates[j],k=rates.length-1;k>=0;k--){var rate=rates[k];duty.dutyId==rate.ilId&&date.temp==rate.insuyear&&date.tempFlag==rate.insuyearflag&&vm.newDuties[i].rates.push(rate.rate)}}vm.calc()},vm.getTempDays=function(date){var temp,tempDay,tempFlag,start=date.start,end=date.end;start=$filter("date")(start,"yyyy-MM-dd"),start=new Date(start),end=$filter("date")(end,"yyyy-MM-dd"),end=new Date(end),tempDay=parseInt((end.getTime()-start.getTime())/864e5),tempDay>28?(temp=31>tempDay?1:parseInt(tempDay/31)+1,tempFlag="M"):(temp=tempDay,tempFlag="D"),date.temp=temp,date.tempDay=tempDay,date.tempFlag=tempFlag},vm.addTime=function(){var start=vm.nowDate,end=vm.maxDate,minStart=start,maxStart=start,minEnd=end,maxEnd=end,date={start:start,end:end,minStart:minStart,maxStart:maxStart,minEnd:minEnd,maxEnd:maxEnd};vm.getTempDays(date),vm.dates.push(date),vm.getRateByTime(),date.startCallback=function(val){val&&(date.start=val,vm.refreshDate(date))},date.endCallback=function(val){val&&(date.end=val,vm.refreshDate(date))}},vm.getRate(function(){vm.addTime()}),vm.deleteTime=function(n){vm.dates.length>1&&(vm.dates.pop(),vm.getRateByTime())},vm.checkTime=function(date){for(var i=0;i<vm.dates.length;i++){var num=(vm.dates[i].start.getTime()-date.start.getTime())/864e5;if(0==num){if(i+1<vm.dates.length){var time=(vm.dates[i+1].start.getTime()-date.end.getTime())/864e5;0>time&&(TipService.showMsg($rootScope.TIPS.PRODUCT.IPAHA_SELECTED_REPEAT),vm.dates[i].end=vm.dates[i+1].start)}if(0!=i){var t=(vm.dates[i].start.getTime()-vm.dates[i-1].end.getTime())/864e5;0>t&&(vm.dates[i].start=vm.dates[i-1].end)}if(vm.dates.length==i+1){var m=(vm.dates[i].end.getTime()-vm.dates[i].start.getTime())/864e5;0>=m&&(vm.dates[i].end=vm.plusOneDay(vm.dates[i].start))}else{var n=(vm.dates[i].end.getTime()-vm.dates[i].start.getTime())/864e5;0>=n&&(vm.dates[i].start=vm.minusOneDay(vm.dates[i].end))}}}},vm.refreshDate=function(date){vm.checkTime(date),vm.getTempDays(date),vm.getRateByTime()},vm.dutyCheck=function(duty){duty.checked?duty.num=duty.minSaleQuantity:(duty.num=duty.insuredAmount[0].key,duty.amount=0,duty.exp=0),vm.calc()},vm.selectAll=function(){if(vm.allChecked=!vm.allChecked,vm.allChecked)for(var i=0;i<vm.newDuties.length;i++)vm.newDuties[i].checked=!0,vm.dutyCheck(vm.newDuties[i]);else for(var j=0;j<vm.newDuties.length;j++)vm.newDuties[j].checked=!1,vm.dutyCheck(vm.newDuties[j]);vm.calc()},vm.goPolicy=function(){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){vm.mainPlan.exp=vm.totalExp,vm.mainPlan.amount=vm.totalAmount,vm.mainPlan.dutys=vm.duties,PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:vm.dates,pbApplNoNum:vm.dates.length,codeArr:vm.codeArr,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.totalExp}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpahaActivityController",IpahaActivityController),IpahaActivityController.$inject=["$state","CONFIG","CommonRequest","TipService","PolicyService","$filter","VALIDATION","$rootScope","$scope"]}(),function(){function IpahaController($state,CONFIG,CommonRequest,TipService,PolicyService,$filter,VALIDATION,$rootScope,$scope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}if(vm.mainPlan={rate:0,amount:0,exp:0},vm.codeArr=[],angular.extend(vm.mainPlan,vm.productData.plans[0]),vm.paymentType=vm.productData.payment_type.split(",")[0],vm.payAge=vm.productData.pay_age,vm.getRate=function(callback){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){1==result.status&&(vm.rateTable=result.data,angular.isFunction(callback)&&callback())})},vm.newDuties=[],vm.getDutyList=function(cardDuties){if(vm.productData&&(vm.plans=vm.productData.plans,vm.plans&&1==vm.plans.length)){if(cardDuties){for(var allDuties=vm.plans[0].dutys,temp=[],m=0;m<allDuties.length;m++)for(var duty=allDuties[m],l=0;l<cardDuties.length;l++)duty.dutyId==cardDuties[l].ilId&&temp.push(duty);vm.duties=temp}else vm.duties=vm.plans[0].dutys;if(vm.dealDuties(vm.duties),vm.duties&&vm.duties.length>0)for(var duties=vm.duties,i=0;i<duties.length-1;i++)for(var duty1=duties[i],j=i+1;j<duties.length;j++){var duty2=duties[j],code1=duty1.ilCode.substr(0,6).toLowerCase(),code2=duty2.ilCode.substr(0,6).toLowerCase(),amount1=parseInt(duty1.insuredAmount),amount2=parseInt(duty2.insuredAmount),minSaleQuantity=parseInt(duty1.minSaleQuantity),maxSaleQuantity=parseInt(duty1.maxSaleQuantity),amountArr=[{key:0,value:"请选择保险金额"}];if(code1==code2)if(amount1!=amount2){for(var k=minSaleQuantity;maxSaleQuantity>=k;k++)amountArr.push({key:k,value:amount1*k+"/"+amount2*k+"万"});vm.newDuties.push({ilName:duty1.ilName+"/"+duty2.ilName.substr(duty2.ilName.length-2,2),insuredAmount:amountArr,dutyId:duty1.ilCode.indexOf("01")>0?duty1.dutyId:duty2.dutyId,num:vm.productData.token?minSaleQuantity:0,amount:amount1+amount2,minSaleQuantity:minSaleQuantity,rates:[],ilCode:code1.substr(code1.length-1,1),checked:duty1.checked})}else{for(var l=minSaleQuantity;maxSaleQuantity>=l;l++)amountArr.push({key:l,value:amount2*l+"万"});vm.newDuties.push({ilName:vm.duties[i].ilName+"/"+vm.duties[j].ilName.substr(vm.duties[j].ilName.length-2,2),insuredAmount:amountArr,dutyId:duty1.ilCode.indexOf("01")>0?duty1.dutyId:duty2.dutyId,num:vm.productData.token?minSaleQuantity:0,amount:amount1,minSaleQuantity:minSaleQuantity,rates:[],ilCode:code1.substr(code1.length-1,1),checked:duty1.checked})}}}},vm.dealDuties=function(duties){if(vm.productData.token)for(var i=0;i<duties.length;i++)duties[i].minSaleQuantity=duties[i].maxSaleQuantity=vm.cardDuties[i].giveNumber,duties[i].checked=!0;else for(var i=0;i<duties.length;i++)duties[i].checked=!1;return duties},vm.productData.token?(vm.isGift=!0,PolicyService.getCardInfo(vm.productData.token,function(data){data&&(vm.sendingProData=data,vm.sendingProData&&(vm.cardDuties=vm.sendingProData.prmLotDutySetModels,vm.getDutyList(vm.cardDuties)))})):vm.getDutyList(),vm.initDuties=function(){for(var i=0;i<vm.newDuties.length;i++)vm.newDuties[i].checked=!1,vm.newDuties[i].exp=0},vm.initDuties(),vm.totalExp=0,vm.calc=function(){var duties=vm.newDuties;vm.totalExp=0,vm.totalAmount=0;for(var i=duties.length-1;i>=0;i--){var duty=duties[i],checked=duty.checked,rates=duty.rates,num=duty.num,exp=0,amount=duty.amount*num;if(checked){for(var j=rates.length-1;j>=0;j--){var rate=rates[j];exp+=100*rate*num}vm.newDuties[i].exp=exp/100}vm.totalExp+=exp,vm.totalAmount+=amount}vm.codeArr=[],vm.duties=[];for(var m=0;m<duties.length;m++)1==duties[m].checked&&(vm.codeArr.push(duties[m].ilCode.toUpperCase()+";"+duties[m].num),vm.duties.push({dutyId:duties[m].dutyId,ilCode:duties[m].ilCode,ilName:duties[m].ilName,insuredAmount:duties[m].amount*duties[m].num,num:duties[m].num,exp:duties[m].exp}));vm.totalExp=vm.totalExp/100},vm.dates=[],vm.plusOneDay=function(date){return date?new Date(date.getTime()+864e5):void 0},vm.minusOneDay=function(date){return date?new Date(date.getTime()-864e5):void 0},vm.nowDate=new Date,2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>vm.nowDate.getTime()&&(vm.nowDate=planSaleTime)}vm.maxDate=new Date(vm.nowDate.getTime()+31536e6),vm.getRateByTime=function(){for(var dates=vm.dates,rates=vm.rateTable,duties=vm.newDuties,i=duties.length-1;i>=0;i--){var duty=duties[i];vm.newDuties[i].rates=[];for(var j=dates.length-1;j>=0;j--)for(var date=dates[j],k=rates.length-1;k>=0;k--){var rate=rates[k];duty.dutyId==rate.ilId&&date.temp==rate.insuyear&&date.tempFlag==rate.insuyearflag&&vm.newDuties[i].rates.push(rate.rate)}}vm.calc()},vm.getTempDays=function(date){var temp,tempDay,tempFlag,start=date.start,end=date.end;start=$filter("date")(start,"yyyy-MM-dd"),start=new Date(start),end=$filter("date")(end,"yyyy-MM-dd"),end=new Date(end),tempDay=parseInt((end.getTime()-start.getTime())/864e5),tempDay>28?(temp=31>tempDay?1:parseInt(tempDay/31)+1,tempFlag="M"):(temp=tempDay,tempFlag="D"),date.temp=temp,date.tempDay=tempDay,date.tempFlag=tempFlag},vm.addTime=function(){var startDate,len=vm.dates.length;if(5==len)return void TipService.showMsg($rootScope.TIPS.PRODUCT.IPAHA_SELECTED_LIMIT);if(startDate=0==len?vm.nowDate:new Date(vm.dates[len-1].end.getTime()+864e5),startDate&&startDate.getTime()<vm.maxDate.getTime()){var start,end,minStart,maxStart,minEnd,maxEnd;vm.sendingProData?(vm.giveDay=vm.sendingProData.giveDay,vm.giveStartTime=vm.sendingProData.giveStartTime,vm.giveEndTime=vm.sendingProData.giveEndTime,vm.giveStartTime&&vm.giveEndTime?(start=new Date(vm.giveStartTime),end=new Date(vm.giveEndTime),vm.startDisabled=!0,vm.endDisabled=!0):vm.giveDay&&(start=startDate,minStart=start,maxStart=vm.minusOneDay(vm.maxDate),end=new Date(start.getTime()+24*vm.giveDay*60*60*1e3),vm.startDisabled=!1,vm.endDisabled=!0)):(start=startDate,end=vm.plusOneDay(start),minStart=start,maxStart=vm.minusOneDay(vm.maxDate),minEnd=end,maxEnd=vm.maxDate,vm.startDisabled=!1,vm.endDisabled=!1);var date={start:start,end:end,minStart:minStart,maxStart:maxStart,minEnd:minEnd,maxEnd:maxEnd};vm.getTempDays(date),vm.dates.push(date),vm.getRateByTime(),date.startCallback=function(val){val&&(date.start=val,vm.refreshDate(date))},date.endCallback=function(val){val&&(date.end=val,vm.refreshDate(date))}}},vm.getRate(function(){vm.addTime()}),vm.deleteTime=function(n){vm.dates.length>1&&(vm.dates.pop(),vm.getRateByTime())},vm.checkTime=function(date){vm.giveDay&&(date.end=new Date(date.start.getTime()+24*vm.giveDay*60*60*1e3));for(var i=0;i<vm.dates.length;i++){var num=(vm.dates[i].start.getTime()-date.start.getTime())/864e5;if(0==num){if(i+1<vm.dates.length){var time=(vm.dates[i+1].start.getTime()-date.end.getTime())/864e5;0>time&&(TipService.showMsg($rootScope.TIPS.PRODUCT.IPAHA_SELECTED_REPEAT),vm.dates[i].end=vm.dates[i+1].start)}if(0!=i){var t=(vm.dates[i].start.getTime()-vm.dates[i-1].end.getTime())/864e5;0>t&&(vm.dates[i].start=vm.dates[i-1].end)}if(vm.dates.length==i+1){var m=(vm.dates[i].end.getTime()-vm.dates[i].start.getTime())/864e5;0>=m&&(vm.dates[i].end=vm.plusOneDay(vm.dates[i].start))}else{var n=(vm.dates[i].end.getTime()-vm.dates[i].start.getTime())/864e5;0>=n&&(vm.dates[i].start=vm.minusOneDay(vm.dates[i].end))}}}},vm.refreshDate=function(date){vm.checkTime(date),vm.getTempDays(date),vm.getRateByTime()},vm.dutyCheck=function(duty){duty.checked?duty.num=duty.minSaleQuantity:(duty.num=duty.insuredAmount[0].key,duty.amount=0,duty.exp=0),vm.calc()},vm.selectAll=function(){if(vm.allChecked=!vm.allChecked,vm.allChecked)for(var i=0;i<vm.newDuties.length;i++)vm.newDuties[i].checked=!0,
vm.dutyCheck(vm.newDuties[i]);else for(var j=0;j<vm.newDuties.length;j++)vm.newDuties[j].checked=!1,vm.dutyCheck(vm.newDuties[j]);vm.calc()},vm.goPolicy=function(){for(var tempDays=0,i=0;i<vm.dates.length;i++)tempDays+=vm.dates[i].tempDay;var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.totalExp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){vm.mainPlan.exp=vm.totalExp,vm.mainPlan.amount=vm.totalAmount,vm.mainPlan.dutys=vm.duties,PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.isGift?0:vm.mainPlan.exp,PbBeginDate:vm.dates,pbApplNoNum:vm.dates.length,codeArr:vm.codeArr,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.totalExp,tempDays:tempDays}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpahaController",IpahaController),IpahaController.$inject=["$state","CONFIG","CommonRequest","TipService","PolicyService","$filter","VALIDATION","$rootScope","$scope"]}(),function(){function IpahjController($state,$scope,CONFIG,CommonRequest,PolicyService,TipService,$filter,VALIDATION,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.mainPlan={rate:0,amount:0,exp:0},vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.paymentType=vm.productData.payment_type,$scope.$watch("ipahj.selectedPlan.insuredAmount",function(){vm.selectedPlan&&(vm.mainPlan.amount=vm.selectedPlan.insuredAmount)},!0),vm.types=[{key:"B",value:"航空"},{key:"C",value:"高铁"},{key:"A",value:"私家车"}],vm.type=vm.types[0].key,vm.getPlansByType=function(type){if(type){vm.showPlans=[],vm.planOptions=[],vm.selectedPlanCode=null,vm.selectedPlan=null;for(var plans=vm.productData.plans,i=plans.length-1;i>=0;i--){var plan=plans[i];-1!=plan.planCode.indexOf(type)&&(vm.showPlans.push(plan),vm.planOptions.push({label:plan.planName,value:plan.planCode}))}vm.planOptions&&vm.planOptions.length>0&&(vm.selectedPlan=vm.showPlans[0],vm.selectedPlanCode=vm.planOptions[0].value)}},vm.checkType=function(){vm.getPlansByType(vm.type)},vm.productData.token?PolicyService.getCardInfo(vm.productData.token,function(data){var plId,duties=data.prmLotDutySetModels;if(duties&&duties.length>0&&(plId=duties[0].planId),vm.productData.plans&&vm.productData.plans.length>0){for(var k=0;k<vm.productData.plans.length;k++){var plan=vm.productData.plans[k];if(plId==plan.planId){var l1=duties.length,l2=plan.dutys.length;if(l1!=l2)for(var ilId=duties[0].ilId,m=0;m<plan.dutys.length;m++)ilId==plan.dutys[m].dutyId&&(plan.dutys=[plan.dutys[m]]);vm.productData.plans=vm.productData.plans=[plan];break}}for(var m=0;m<vm.types.length;m++)if(-1!=vm.productData.plans[0].planCode.indexOf(vm.types[m].key)){vm.types=[vm.types[m]];break}vm.type=vm.types[0].key,vm.checkType()}}):vm.checkType(),vm.changePlan=function(){vm.selectedPlanCode;for(var i=vm.showPlans.length-1;i>=0;i--){var plan=vm.showPlans[i];if(plan.planCode==vm.selectedPlanCode){vm.selectedPlan=plan;break}}};var nowDate=new Date;if(vm.minDate=nowDate,2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime)}vm.maxDate=new Date(vm.minDate.getTime()+314496e5),vm.startTime=vm.minDate,vm.startCallback=function(val){val&&(vm.startTime=val)},vm.goPolicy=function(){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlan.planId,premiumResult:vm.selectedPlan.normalPrice,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){vm.mainPlan.exp=vm.selectedPlan.normalPrice,vm.mainPlan.amount=vm.selectedPlan.insuredAmount,PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:angular.extend(vm.mainPlan,vm.selectedPlan),payendyear:1,paymentType:vm.paymentType,PbBeginDate:vm.startTime,PbInsuAmt:vm.mainPlan.insuredAmount,PbInsuExp:vm.productData.token?0:vm.mainPlan.normalPrice,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.selectedPlan.normalPrice}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpahjController",IpahjController),IpahjController.$inject=["$state","$scope","CONFIG","CommonRequest","PolicyService","TipService","$filter","VALIDATION","$rootScope"]}(),function(){function IpahkController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.mainPlan={rate:0,amount:0,exp:0};var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate)))),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var nowDate=new Date;if(vm.minDate=nowDate,2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime,vm.startTime=planSaleTime)}vm.startTime=vm.minDate,vm.startCallback=function(val){val&&(vm.startTime=val)},vm.getEndTime=function(plan){if(plan){var temp,insuYear=plan.insuYear,insuYearFlag=plan.insuYearFlag;if(insuYear&&insuYearFlag){switch(insuYearFlag){case"Y":temp=365*parseInt(insuYear)*24*60*60*1e3;break;case"M":temp=30*parseInt(insuYear)*24*60*60*1e3;break;case"D":temp=24*parseInt(insuYear)*60*60*1e3;break;case"A":temp=365*parseInt(insuYear)*24*60*60*1e3}vm.endTime=new Date(vm.startTime.getTime()+temp)}}};var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0},getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};vm.selectPlan=function(planId){if(vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId&&(vm.selectedPlans=vm.productData.plans[i],vm.getEndTime(),watchSelectedPlans(),angular.extend(vm.mainPlan,vm.productData.plans[i]));vm.mainPlan.exp=vm.selectedPlans.normalPrice,vm.mainPlan.amount=vm.selectedPlans.insuredAmount,vm.mainPlan.planId=vm.selectedPlans.planId,vm.user.selectedPlan=vm.selectedPlans.planId,vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag)},vm.productData.token?PolicyService.getCardInfo(vm.productData.token,function(data){var plId,duties=data.prmLotDutySetModels;if(duties&&duties.length>0&&(plId=duties[0].planId),vm.productData.plans&&vm.productData.plans.length>0){for(var k=0;k<vm.productData.plans.length;k++){var plan=vm.productData.plans[k];if(plId==plan.planId){var l1=duties.length,l2=plan.dutys.length;if(l1!=l2)for(var ilId=duties[0].ilId,m=0;m<plan.dutys.length;m++)ilId==plan.dutys[m].dutyId&&(plan.dutys=[plan.dutys[m]]);vm.productData.plans=vm.productData.plans=[plan];break}}vm.user.selectedPlan=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlan)}}):(vm.user.selectedPlan=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlan)),vm.goPolicy=function(){var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{selectedPlan:vm.user.selectedPlan,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startTime,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpahkController",IpahkController),IpahkController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope"]}(),function(){function IpamController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.securityDays=1,vm.startDate=new Date,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHavePlan=!1,vm.ifGiveToken=!1,vm.plans=vm.productData.plans[0];var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.startCallback=function(val){val&&(vm.startDate=val)};var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate)))),vm.startDate=vm.minDate,vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0};vm.mainPlan={rate:0,amount:0,exp:0};var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.choseSecurityDays=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1;$scope.$watch("ipam.startDate",function(newValue){newValue&&vm.calc(vm)},!0),vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insuredDays:vm.plans.insuYear,insuYearFlag:vm.plans.insuYearFlag,planCode:vm.plans.planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}};var calcDate=function(){if(vm.startDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endTime=new Date(vm.startDate);return"M"==vm.selectedPlans.insuYearFlag?endTime.setMonth(vm.startDate.getMonth()+Number(vm.selectedPlans.insuYear)):"D"==vm.selectedPlans.insuYearFlag?endTime.setDate(vm.startDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endTime.setFullYear(vm.startDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endTime,"yyyyMMdd")}};vm.goPolicy=function(){vm.cvrInsDt=calcDate();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startDate,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpamController",IpamController),IpamController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicLoading","$timeout"]}(),function(){function IpamaController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.securityDays=1,vm.startInDate=new Date,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHavePlan=!1,vm.ifGiveToken=!1,vm.plans=vm.productData.plans[0];var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.getMyCardToken=function(lotCode){if(lotCode){var params={lotCode:lotCode,channelCode:CONFIG.SALE_CHANNEL,custWXId:("812"==CONFIG.SALE_CHANNEL?"812":$rootScope.openid)||"811",prdId:vm.productData.prd_id};PolicyService.getCardToken(params,function(token){token&&PolicyService.setSessionData({productData:{token:token,lotCode:lotCode}})})}},vm.getMyToken=function(){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status&&(vm.lotCode=result.data)})},vm.getMyToken(),$scope.$watch("ipama.lotCode",function(newValue,oldValue){newValue!=oldValue&&vm.getMyCardToken(newValue)});var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nowDate)))),vm.startInDate=vm.minDate,vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0};vm.mainPlan={rate:0,amount:0,exp:0};var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"};vm.giveInsur=function(){$timeout(function(){var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.choseSecurityDays=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.giveInsur()},500)},vm.giveInsur(),$scope.$watch("ipama.startDate",function(newValue){},!0);var calcDate=function(){if(vm.startInDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endTime=new Date(vm.startInDate);return"M"==vm.selectedPlans.insuYearFlag?endTime.setMonth(vm.startInDate.getMonth()+Number(vm.selectedPlans.insuYear)):"D"==vm.selectedPlans.insuYearFlag?endTime.setDate(vm.startInDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endTime.setFullYear(vm.startInDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endTime,"yyyyMMdd")}};vm.goPolicy=function(){vm.cvrInsDt=calcDate();var data={mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startInDate,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt};PolicyService.setSessionData({insureData:data}),PolicyService.removeSessionData(["policyData"]);var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),$state.go("product-purchase-policy-ipama")}}angular.module("app").controller("IpamaController",IpamaController),IpamaController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicLoading","$timeout"]}(),function(){function IpambController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.securityDays=1,vm.startInDate=new Date,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHavePlan=!1,vm.ifGiveToken=!1,vm.plans=vm.productData.plans[0],vm.planChecked=1;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nowDate)))),vm.startInDate=vm.minDate,vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0};vm.mainPlan={rate:0,amount:0,exp:1};var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.choseSecurityDays=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1;var calcDate=function(){if(vm.startInDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endTime=new Date(vm.startInDate);return"M"==vm.selectedPlans.insuYearFlag?endTime.setMonth(vm.startInDate.getMonth()+Number(vm.selectedPlans.insuYear)):"D"==vm.selectedPlans.insuYearFlag?endTime.setDate(vm.startInDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endTime.setFullYear(vm.startInDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endTime,"yyyyMMdd")}};vm.planOneCheck=function(){vm.planChecked=1},vm.planTwoCheck=function(){vm.planChecked=5},vm.planThreeCheck=function(){vm.planChecked=10},vm.planFourCheck=function(){vm.planChecked=20},vm.planFiveCheck=function(){vm.planChecked=30},vm.planSixCheck=function(){vm.planChecked=50},$scope.$watch("ipamb.planChecked",function(){var regu=/^[1-9]\d*$/;0!=vm.planChecked&&vm.planChecked<=50&&regu.test(vm.planChecked)?vm.mainPlan.exp=vm.planChecked:vm.mainPlan.exp=1,vm.selectedPlansForShow.dutys[0].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[1].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[2].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[3].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[4].insuredAmount=1e4*vm.mainPlan.exp+"元"},!0),vm.goPolicy=function(){vm.cvrInsDt=calcDate();
var regu=/^[1-9]\d*$/;0!=vm.planChecked&&vm.planChecked<=50&&regu.test(vm.planChecked)&&(vm.mainPlan.amount=1e4*vm.planChecked,vm.mainPlan.exp=vm.planChecked);var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startDate,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("IpambController",IpambController),IpambController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicLoading","$timeout"]}(),function(){function JipaaController($state,$log,$location,$rootScope,CONFIG,CommonRequest,$scope,rootScope,PolicyService,TipService,$timeout,$filter,VALIDATION,$ionicScrollDelegate,$anchorScroll,MallCommonService,$ionicPopup,$window){var vm=this;vm.butml=.16*document.body.offsetWidth+"px",vm.butwidthx=.17*document.body.offsetWidth+2+"px",vm.butwidths=.17*document.body.offsetWidth+6+"px",vm.navChecked=1,vm.navCheck=function(tab,tabid){vm.navChecked=tab,vm.slideTo(tabid)},vm.slideTo=function(location){var location=$location.hash(location);$ionicScrollDelegate.$getByHandle("dashboard").anchorScroll("#"+location)};var nav=document.getElementById("nav"),lisLen=nav.getElementsByTagName("li").length-1;vm.ulWidth=88*lisLen+"px",vm.id=$state.params.id,vm.user={},vm.socif=1,vm.user.sex="",vm.user.birthday=null,vm.securityDays=1,vm.startInDate=new Date,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHavePlan=!1,vm.ifGiveToken=!1,vm.timeKey=!1,vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}};var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0};vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()},vm.getProductDetail=function(id){var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data;if(vm.productData){var payTypeConfigs=(vm.productData.prdDetails,vm.productData.prdPayments,vm.productData.payTypeConfigs);if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],vm.changeInsurYear(vm.productData.plans),vm.changePayAge()}PolicyService.setSessionData({productData:result.data}),$timeout(function(){$rootScope.showProductDialog=!0},100)}}if(vm.productData){var second=vm.productData.tag_name[0],secondLink=vm.productData.tag_code[0],third=vm.productData.prd_title;$rootScope.$broadcast("refresh-location",{second:second,secondLink:"product-list({tag:"+secondLink.substr(secondLink.length-1,1)+"})",third:third})}$rootScope.$broadcast("scroll.refreshComplete")})};var times=0;vm.loadingPage=function(callback){var sessionData=PolicyService.getSessionData();return vm.productData=sessionData.productData,times>=10?void(times=0):(times++,vm.getProductDetail(vm.id),void $timeout(function(){return vm.productData?void(angular.isFunction(callback)&&callback()):void vm.loadingPage(callback)},500))},vm.getLotCode=function(callback){if("Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:"product-detail",control:"data",data:{token:"",lotCode:""}})})},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):(vm.productData.token=token,vm.productData.lotCode=data.lotCode,void PolicyService.control({state:"product-detail",control:"data",data:{token:token,lotCode:data.lotCode}}))}))})},vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType;vm.ma.description="条款";var params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.loadingPage(function(){vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.mainPlan={rate:0,amount:0,exp:0},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan();var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.timeKey=!0,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院补贴保险金")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:vm.selectedPlansForMarge.dutys[i].insuredAmount>=1e4?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};$scope.$watch("jipaa.productData.token",function(newValue){if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}if("固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3),vm.choseSecurityDays=!1,vm.choseEndTime=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.productData.plans&&vm.productData.plans.length>0){for(var i=0;i<vm.productData.plans.length;i++){var productPlan=vm.productData.plans[i],tempDuties=[];if(planId==productPlan.planId){for(var dutiesLength=duties.length,productDutiesLength=productPlan.dutys.length,m=0;dutiesLength>m;m++)for(var ilId=duties[m].ilId,n=0;productDutiesLength>n;n++)ilId!=productPlan.dutys[n].dutyId||tempDuties.push(productPlan.dutys[m]);vm.productData.plans[i].dutys=tempDuties;break}}data.giveStartTime&&(vm.startDate=new Date(data.giveStartTime),vm.startDateDisabled=!0),data.giveEndTime&&(vm.endDate=new Date(data.giveEndTime),vm.endDateDisabled=!0),data.giveDay&&(vm.securityDays=data.giveDay,vm.insuredDaysDisabled=!0),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.planCode=vm.selectedPlans.planCode}}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.planCode=vm.selectedPlans.planCode,vm.giveCanNotChoseTime=!1}),$scope.$watch("jipaa.user.birthday",function(newValue,oldValue){newValue!=oldValue&&vm.getPremium()}),vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.planCode=vm.selectedPlans.planCode,vm.giveCanNotChoseTime=!1,vm.selectSoc=function(socif){vm.socif=socif,vm.getPremium()},vm.selectPlan=function(plan){var planId=plan.planId;if(vm.planCode=plan.planCode,vm.getPremium(),vm.productData.plans=PolicyService.getSessionData().productData.plans,vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId&&(vm.selectedPlans=vm.productData.plans[i],watchSelectedPlans(),angular.extend(vm.mainPlan,PolicyService.getSessionData().productData.plans[i]));vm.mainPlan.exp=vm.selectedPlans.normalPrice,vm.mainPlan.amount=vm.selectedPlans.insuredAmount,vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.planCode=vm.selectedPlans.planCode};var calcDate=function(){if(vm.startDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endDate=new Date(vm.startDate);return"M"==vm.selectedPlans.insuYearFlag?endDate=new Date(VALIDATION.addMounth(Number(vm.selectedPlans.insuYear),new Date(vm.startDate))):"D"==vm.selectedPlans.insuYearFlag?endDate.setDate(vm.startDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endDate.setFullYear(vm.startDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endDate,"yyyyMMdd")}};vm.getPremium=function(){var INSURANCE_PLAN_JSON={url:"../statics/json/insurancePlanJson.json",method:"GET"};CommonRequest.request({},INSURANCE_PLAN_JSON,function(result){if(result&&result.data)for(var premium=result.data,i=0;i<premium.length;i++)"1"==vm.socif&&vm.planCode==premium[i].planCode?vm.user.birthday&&(vm.mainPlan.exp=premium[i].social):"2"==vm.socif&&vm.planCode==premium[i].planCode&&vm.user.birthday&&(vm.mainPlan.exp=premium[i].notSocual)})},vm.getPremium(),vm.getProductMaterials(vm.id),vm.goPolicy=function(){vm.cvrInsDt=calcDate();({prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""});PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,socialSecurity:vm.socif,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}}),PolicyService.setSessionData({productData:{jipaaDate:"Y"}});var sessionData=PolicyService.getSessionData(),basicProfile=vm.productData.basicProfile,login=sessionData.login,loginStatus=sessionData.loginStatus;"Y"!=basicProfile.P005||"1"==login&&"2"==loginStatus?$state.go("product-purchase-policy-info"):PolicyService.showMobileModal()}})}angular.module("app").controller("JipaaController",JipaaController),JipaaController.$inject=["$state","$log","$location","$rootScope","CONFIG","CommonRequest","$scope","$rootScope","PolicyService","TipService","$timeout","$filter","VALIDATION","$ionicScrollDelegate","$anchorScroll","MallCommonService","$ionicPopup","$window"]}(),function(){function TacaController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicPopup,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.startDateDisabled=!1,vm.endDateDisabled=!1,vm.insuredDaysDisabled=!1,vm.giveCanNotChoseTime=!1,vm.securityDays=1,vm.ifGiveToken=!1,vm.choseEndTime=!0,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveGivedaysAndStartTime=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHaveStartTimeAndEndTime=!1,vm.giveTokenHavePlan=!1;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}if(vm.startCallback=function(val){val&&(vm.startDate=val)},vm.endCallback=function(val){val&&(vm.endDate=val)},2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>(new Date).getTime()&&(vm.minDate=planSaleTime,vm.startDate=planSaleTime)}var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate)))),vm.startDate=vm.minDate,vm.getStartTimeList=function(){var createList=function(startHour){for(var tempList=[],i=startHour;24>=i;i++)tempList.push(i+"");return tempList},nowDateStr=$filter("date")(nowDate,"yyyy-MM-dd"),nowHour=nowDate.getHours(),nextDateStr=$filter("date")(new Date(nextDay),"yyyy-MM-dd"),startDateStr=$filter("date")(vm.startDate,"yyyy-MM-dd");vm.startHourList=[],nowDateStr==startDateStr&&nextDayFlag>nowHour?vm.startHourList=createList(nowHour+4):nextDateStr==startDateStr&&nowHour>=nextDayFlag?vm.startHourList=createList(nowHour+4-24):vm.startHourList=createList(1);for(var i=1;24>=i;i++)$("#isShow"+i).show();for(var i=1;24>=i&&i<vm.startHourList[0];i++)$("#isShow"+i).hide();vm.startTime="24:00"},vm.showTimeSelect=function(){vm.timeSelectShow=!0},vm.setStartTime=function(value){vm.timeSelectShow=!1,vm.startTime=value+":00"},vm.mainPlan={rate:0,amount:0,exp:0},vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0},getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3),vm.choseSecurityDays=!1,vm.choseEndTime=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1;$scope.$watch("taca.startDate",function(newValue){newValue&&(vm.getStartTimeList(),vm.choseEndTime&&(vm.minEndDate=new Date(vm.startDate.getTime()+864e5),vm.maxEndDate=new Date(vm.startDate.getTime()+31536e6),vm.endDate=vm.minEndDate),vm.choseEndTime||vm.giveTokenInfo.giveDay&&(vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3)),vm.endDate&&vm.startDate.getTime()>vm.endDate.getTime()&&(vm.endDate=null,vm.securityDays=null,vm.securityDaysForShow=null),vm.calc(vm))},!0),$scope.$watch("taca.endDate",function(newValue){newValue&&(vm.securityDays=parseInt((vm.endDate.getTime()-vm.startDate.getTime()-100)/864e5)+1,vm.mainPlan.insuYear=vm.securityDays,vm.securityDaysForShow=vm.securityDays+" 天",vm.calc(vm))},!0),vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,PbBeginDate:$filter("date")(vm.startDate,"yyyyMMdd"),insuredDays:vm.securityDays,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.productData.plans[0].planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}};var calcDate=function(){if(vm.startDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endDate=new Date(vm.startDate);return"M"==vm.selectedPlans.insuYearFlag?endDate=new Date(VALIDATION.addMounth(Number(vm.selectedPlans.insuYear),new Date(vm.startDate))):"D"==vm.selectedPlans.insuYearFlag?endDate.setDate(vm.startDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endDate.setFullYear(vm.startDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endDate,"yyyyMMdd")}};vm.goPolicy=function(){vm.cvrInsDt=calcDate();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startDate,beginTime:vm.startTime+":00",PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("TacaController",TacaController),TacaController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicPopup","$ionicLoading","$timeout"]}(),function(){function TacController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.choseStartTime=!0;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.startCallback=function(val){val&&(vm.startTime=val)};var nowDate=new Date;if(2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime,vm.startTime=planSaleTime)}vm.minDate=nowDate,vm.startTime=vm.minDate,vm.maxDate=new Date((new Date).setMonth((new Date).getMonth()+3)),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0};vm.mainPlan={rate:0,amount:0,exp:0};var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("补贴")?"元/日":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){vm.selectedPlansForMarge=vm.selectedPlans,vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare);for(var dutysCodeArr=[],i=0;i<vm.selectedPlansForMarge.dutys.length;i++)dutysCodeArr.push(vm.selectedPlansForMarge.dutys[i].ilCode.substr(0,6).toLowerCase());for(var margeDutys=[],unmargeDutys=[],i=0;i<dutysCodeArr.length;i++){for(var nowDutyCode1=dutysCodeArr[i],margeFlag=!1,j=i+1;j<dutysCodeArr.length;j++){var nowDutyCode2=dutysCodeArr[j];if(nowDutyCode1==nowDutyCode2){var duty1=vm.selectedPlansForMarge.dutys[i],duty2=vm.selectedPlansForMarge.dutys[j];margeDutys.push({ilCode:duty1.ilCode+"/"+duty2.ilCode,ilName:duty1.ilName+"/"+duty2.ilName.substr(duty2.ilName.length-2,2),insuredAmount:1e4==duty1.insuredAmount?duty1.insuredAmount/1e4*duty1.maxSaleQuantity+"万"+getMoneyUnit(duty1.ilName):duty1.insuredAmount*duty1.maxSaleQuantity+getMoneyUnit(duty1.ilName)}),dutysCodeArr.splice(j,1),vm.selectedPlansForMarge.dutys.splice(j,1),margeFlag=!0;break}}margeFlag||unmargeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow.dutys=margeDutys.concat(unmargeDutys),vm.selectedPlansForShow.dutys.sort(compare),vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.selectPlan=function(planId){if(vm.productData.plans=PolicyService.getSessionData().productData.plans,vm.productData.plans.sort(function(obj1,obj2){var val1=obj1.planCode,val2=obj2.planCode;return val2>val1?-1:val1>val2?1:0}),vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId&&(vm.selectedPlans=vm.productData.plans[i],watchSelectedPlans(),angular.extend(vm.mainPlan,PolicyService.getSessionData().productData.plans[i]));vm.mainPlan.exp=vm.selectedPlans.normalPrice,vm.mainPlan.amount=vm.selectedPlans.insuredAmount,vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId},vm.user.selectedPlanId=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlanId),
vm.productData.token){vm.ifGiveToken=!0;vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(console.log(data),data){vm.giveTokenInfo=data;var newPlanId,newGivenDutys=vm.giveTokenInfo.prmLotDutySetModels;vm.newDutysArr=[],newGivenDutys&&newGivenDutys.length>0&&(newPlanId=newGivenDutys[0].planId),vm.user.selectedPlanId=newPlanId,vm.selectPlan(vm.user.selectedPlanId),"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.selectedPlans.securityAge=vm.giveTokenInfo.giveDay,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startTime=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startTime=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startTime=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0))}})}else vm.ifGiveToken=!1;var calcDate=function(){if(vm.startTime&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endTime=new Date(vm.startTime);return"M"==vm.selectedPlans.insuYearFlag?endTime.setMonth(vm.startTime.getMonth()+Number(vm.selectedPlans.insuYear)):"D"==vm.selectedPlans.insuYearFlag&&endTime.setDate(vm.startTime.getDate()+Number(vm.selectedPlans.insuYear)),$filter("date")(endTime,"yyyyMMdd")}};vm.goPolicy=function(){vm.cvrInsDt=calcDate();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startTime,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("TacController",TacController),TacController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope"]}(),function(){function TacbController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicPopup,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="",vm.user.birthday=null,vm.startDateDisabled=!1,vm.endDateDisabled=!1,vm.insuredDaysDisabled=!1,vm.giveCanNotChoseTime=!1,vm.securityDays=1,vm.ifGiveToken=!1,vm.choseEndTime=!0,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveGivedaysAndStartTime=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHaveStartTimeAndEndTime=!1,vm.giveTokenHavePlan=!1;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}if(vm.startCallback=function(val){val&&(vm.startDate=val)},vm.endCallback=function(val){val&&(vm.endDate=val)},2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>(new Date).getTime()&&(vm.minDate=planSaleTime,vm.startDate=planSaleTime)}var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(2,new Date(nowDate)))),vm.startDate=vm.minDate,vm.getStartTimeList=function(){var createList=function(startHour){for(var tempList=[],i=startHour;24>=i;i++)tempList.push(i+"");return tempList},nowDateStr=$filter("date")(nowDate,"yyyy-MM-dd"),nowHour=nowDate.getHours(),nextDateStr=$filter("date")(new Date(nextDay),"yyyy-MM-dd"),startDateStr=$filter("date")(vm.startDate,"yyyy-MM-dd");vm.startHourList=[],nowDateStr==startDateStr&&nextDayFlag>nowHour?vm.startHourList=createList(nowHour+4):nextDateStr==startDateStr&&nowHour>=nextDayFlag?vm.startHourList=createList(nowHour+4-24):vm.startHourList=createList(1);for(var i=1;24>=i;i++)$("#isShow"+i).show();for(var i=1;24>=i&&i<vm.startHourList[0];i++)$("#isShow"+i).hide();vm.startTime="24:00"},vm.showTimeSelect=function(){vm.timeSelectShow=!0},vm.setStartTime=function(value){vm.timeSelectShow=!1,vm.startTime=value+":00"},vm.mainPlan={rate:0,amount:0,exp:0},vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0},getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3),vm.choseSecurityDays=!1,vm.choseEndTime=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):vm.giveTokenHaveGivedays=!0),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?vm.giveTokenHaveStartTime=!0:vm.giveTokenHavePlan=!0),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1;$scope.$watch("tacb.startDate",function(newValue){newValue&&(vm.getStartTimeList(),vm.choseEndTime&&(vm.minEndDate=new Date(vm.startDate.getTime()+864e5),vm.maxEndDate=new Date(vm.startDate.getTime()+31536e6),vm.endDate=vm.minEndDate),vm.choseEndTime||vm.giveTokenInfo.giveDay&&(vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3)),vm.endDate&&vm.startDate.getTime()>vm.endDate.getTime()&&(vm.endDate=null,vm.securityDays=null,vm.securityDaysForShow=null),vm.calc(vm))},!0),vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,PbBeginDate:$filter("date")(vm.startDate,"yyyyMMdd"),insuredDays:vm.securityDays,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.productData.plans[0].planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}};var calcDate=function(){if(vm.startDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endDate=new Date(vm.startDate);return"M"==vm.selectedPlans.insuYearFlag?endDate=new Date(VALIDATION.addMounth(Number(vm.selectedPlans.insuYear),new Date(vm.startDate))):"D"==vm.selectedPlans.insuYearFlag?endDate.setDate(vm.startDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endDate.setFullYear(vm.startDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endDate,"yyyyMMdd")}};vm.next=function(){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.NEW_PRD_CHECK_LIMIT,function(result){if(1==result.status)if(result.data)vm.goPolicy();else{var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"暂无领取名额，请返回首页购买其他产品。",okText:"确认",cancelText:"取消"});alertPopup.then(function(res){res&&$state.go("tab.mall")})}})},vm.goPolicy=function(){vm.cvrInsDt=calcDate();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startDate,beginTime:vm.startTime+":00",PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.productData.token?0:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("TacbController",TacbController),TacbController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicPopup","$ionicLoading","$timeout"]}(),function(){function TaccController($state,CONFIG,CommonRequest,VALIDATION,$scope,PolicyService,TipService,$filter,$rootScope,$ionicPopup,$ionicLoading,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.plans=vm.productData.plans,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");if(vm.user={},vm.user.sex="",vm.user.birthday=null,vm.startDateDisabled=!1,vm.endDateDisabled=!1,vm.insuredDaysDisabled=!1,vm.giveCanNotChoseTime=!1,vm.securityDays=1,vm.ifGiveToken=!1,vm.choseEndTime=!0,vm.giveTokenHaveGivedays=!1,vm.giveTokenHaveGivedaysAndStartTime=!1,vm.giveTokenHaveStartTime=!1,vm.giveTokenHaveStartTimeAndEndTime=!1,vm.giveTokenHavePlan=!1,vm.insuYear="1",vm.productData.plans){vm.color="#b2ceff";for(var i=0;i<vm.productData.plans.length;i++)$("#plan-select div").eq(i).css({background:vm.color}),"#b2ceff"==vm.color?vm.color="#a3d5ff":vm.color="#b2ceff"}var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}if(vm.startCallback=function(val){val&&(vm.startDate=val)},vm.endCallback=function(val){val&&(vm.endDate=val)},2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>(new Date).getTime()&&(vm.minDate=planSaleTime,vm.startDate=planSaleTime)}var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;nowDate.getHours()>=nextDayFlag?(vm.minDate=new Date(nextDay),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nextDay)))):(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate)))),vm.startDate=vm.minDate,vm.getStartTimeList=function(){var createList=function(startHour){for(var tempList=[],i=startHour;24>=i;i++)tempList.push(i+"");return tempList},nowDateStr=$filter("date")(nowDate,"yyyy-MM-dd"),nowHour=nowDate.getHours(),nextDateStr=$filter("date")(new Date(nextDay),"yyyy-MM-dd"),startDateStr=$filter("date")(vm.startDate,"yyyy-MM-dd");vm.startHourList=[],nowDateStr==startDateStr&&nextDayFlag>nowHour?vm.startHourList=createList(nowHour+4):nextDateStr==startDateStr&&nowHour>=nextDayFlag?vm.startHourList=createList(nowHour+4-24):vm.startHourList=createList(1);for(var i=1;24>=i;i++)$("#isShow"+i).show();for(var i=1;24>=i&&i<vm.startHourList[0];i++)$("#isShow"+i).hide();vm.startTime="24:00"},vm.getStartTimeList(),vm.showTimeSelect=function(){vm.timeSelectShow=!0},vm.setStartTime=function(value){vm.timeSelectShow=!1,vm.startTime=value+":00"},vm.mainPlan={rate:0,amount:0,exp:0},vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age;var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3),vm.choseSecurityDays=!1,vm.choseEndTime=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],console.log(vm.selectedPlans),vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1;$scope.$watch("tacc.insuYear",function(newValue){newValue&&("30"==newValue?(vm.selectedPlans.insuYear="1",vm.selectedPlans.insuYearFlag="M",vm.mainPlan.insuYearFlag="M",vm.mainPlan.insuYear="1",vm.securityDays="1"):(vm.selectedPlans.insuYear=newValue,vm.selectedPlans.insuYearFlag="D",vm.mainPlan.insuYearFlag="D",vm.securityDays=newValue,vm.mainPlan.insuYear=newValue),vm.calc(vm))},!0),$scope.$watch("tacc.startDate",function(newValue){newValue&&(vm.getStartTimeList(),vm.choseEndTime&&(vm.minEndDate=new Date(vm.startDate.getTime()+864e5),vm.maxEndDate=new Date(vm.startDate.getTime()+31536e6),vm.endDate=vm.minEndDate),vm.choseEndTime||vm.giveTokenInfo.giveDay&&(vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3)),vm.endDate&&vm.startDate.getTime()>vm.endDate.getTime()&&(vm.endDate=null,vm.securityDays=null,vm.securityDaysForShow=null),vm.calc(vm))},!0),vm.selectPlan=function(planId){if(vm.productData.plans=PolicyService.getSessionData().productData.plans,vm.productData.plans.sort(function(obj1,obj2){var val1=obj1.planCode,val2=obj2.planCode;return val2>val1?-1:val1>val2?1:0}),vm.color="#b2ceff",vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId?($("#plan-select div").eq(0).css({background:"#b2ceff"}),vm.productData.plans[i].insuYear=vm.mainPlan.insuYear,vm.productData.plans[i].insuYearFlag=vm.mainPlan.insuYearFlag,vm.selectedPlans=vm.productData.plans[i],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.productData.plans[i])):($("#plan-select div").eq(i).css({background:vm.color}),"#b2ceff"==vm.color?vm.color="#a3d5ff":vm.color="#b2ceff");vm.user.selectedPlanId=vm.selectedPlans.planId,vm.calc(vm)},vm.selectOne=function(){vm.insuYear="1",console.log("selectOne")},vm.selectThree=function(){vm.insuYear="3",console.log(vm.insuYear)},vm.selectFive=function(){vm.insuYear="5",console.log(vm.insuYear)},vm.selectSeven=function(){vm.insuYear="7"},vm.selectTen=function(){vm.insuYear="10"},vm.selectFifteen=function(){vm.insuYear="15"},vm.selectMonth=function(){vm.insuYear="30"},vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,PbBeginDate:$filter("date")(vm.startDate,"yyyyMMdd"),insuredDays:vm.securityDays,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.selectedPlans.planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}};var calcDate=function(){if(vm.startDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endDate=new Date(vm.startDate);return"M"==vm.selectedPlans.insuYearFlag?endDate=new Date(VALIDATION.addMounth(Number(vm.selectedPlans.insuYear),new Date(vm.startDate))):"D"==vm.selectedPlans.insuYearFlag?endDate.setDate(vm.startDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endDate.setFullYear(vm.startDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endDate,"yyyyMMdd")}};vm.goPolicy=function(){vm.cvrInsDt=calcDate();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.selectedPlans.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbBeginDate:vm.startDate,beginTime:vm.startTime+":00",PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,cvrInsDt:vm.cvrInsDt}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("TaccController",TaccController),TaccController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","PolicyService","TipService","$filter","$rootScope","$ionicPopup","$ionicLoading","$timeout"]}(),function(){function TldController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.birthday=null,vm.nextStep=!0,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))}vm.mainPlan={rate:0,amount:"",exp:""},vm.totalAmount=vm.mainPlan.amount,vm.totalExp=vm.mainPlan.exp,vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("tld.user.birthday",function(newvalue){newvalue&&(vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.mainPlan.amount&&vm.user.sex&&vm.calc(vm))},!0),$scope.$watch("tld.user.sex",function(newvalue){newvalue&&vm.mainPlan.amount&&vm.user.birthday&&vm.calc(vm)},!0),$scope.$watch("tld.insuredAmount",function(newvalue){newvalue&&(vm.amountStr=newvalue,vm.newAmount=vm.amountStr.substring(0,2),vm.mainPlan.amount=1e4*vm.newAmount),vm.user.birthday&&vm.user.sex&&vm.calc(vm)},!0),vm.calc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}});var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:vm.user.birthday,sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("TldController",TldController),TldController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function UlnlController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var min_age,max_age,min_hoider_age,max_hoider_age,payTypeConfigs=vm.productData.payTypeConfigs;payTypeConfigs&&payTypeConfigs.length>0&&(min_age=payTypeConfigs[0].min_app_age,max_age=payTypeConfigs[0].max_app_age,min_hoider_age=payTypeConfigs[0].minHolderAge,max_hoider_age=payTypeConfigs[0].maxHolderAge,vm.minAge=min_age,vm.maxAge=max_age,vm.minHolderAge=min_hoider_age,vm.maxHolderAge=max_hoider_age,vm.minStartDate=VALIDATION.getDateByAge(max_age),vm.maxEndDate=VALIDATION.getDateByAge(min_age),vm.hoiderStartDate=VALIDATION.getDateByAge(max_hoider_age),vm.hoiderEndDate=VALIDATION.getDateByAge(min_hoider_age),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))),vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={},vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,
vm.payAge=vm.productData.pay_age,$scope.$watch("ulnl.user",function(){$scope.ulnlForm.$valid?vm.calc(vm):vm.mainPlan.amount=""},!0),$scope.$watch("ulnl.mainPlan.exp",function(){$timeout(function(){$scope.ulnlForm.$valid?vm.calc(vm):vm.mainPlan.amount=""},100)}),vm.calc=function(vm,callback){var user=vm.user;if("3"!==vm.productData.feeSetType)vm.mainPlan.amount=vm.mainPlan.exp,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan});else{var age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.payAge};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&mainRate.push(rateTable[i]);mainRate&&mainRate.length>0&&(vm.mainPlan.rate=mainRate[0].rate,vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan}))}else TipService.showMsg("费率为空！")}})}},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.mainPlan.exp=vm.mainPlan.exp.toString(),vm.mainPlan.amount=vm.mainPlan.amount.toString();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("UlnlController",UlnlController),UlnlController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function UlplController($state,CONFIG,CommonRequest,VALIDATION,$scope,$rootScope,PolicyService,TipService,$filter,$timeout){var vm=this,sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.birthdayCallback=function(val){val&&(vm.user.birthday=val)};var min_age,max_age,min_hoider_age,max_hoider_age,payTypeConfigs=vm.productData.payTypeConfigs;payTypeConfigs&&payTypeConfigs.length>0&&(min_age=payTypeConfigs[0].min_app_age,max_age=payTypeConfigs[0].max_app_age,min_hoider_age=payTypeConfigs[0].minHolderAge,max_hoider_age=payTypeConfigs[0].maxHolderAge,vm.minAge=min_age,vm.maxAge=max_age,vm.minHolderAge=min_hoider_age,vm.maxHolderAge=max_hoider_age,vm.minStartDate=VALIDATION.getDateByAge(max_age),vm.maxEndDate=VALIDATION.getDateByAge(min_age),vm.hoiderStartDate=VALIDATION.getDateByAge(max_hoider_age),vm.hoiderEndDate=VALIDATION.getDateByAge(min_hoider_age),vm.productData.prdSubscribe&&vm.productData.prdSubscribe.length>0&&(vm.effectiveStartDate=new Date(vm.productData.prdSubscribe[0].effectStartDate),vm.effectiveEndDate=new Date(vm.productData.prdSubscribe[0].effectEndDate))),vm.mainPlan={rate:0,amount:"",exp:""},vm.addPlan={},vm.getPlan=function(){for(var plan=vm.productData.plans,len=plan.length,i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,$scope.$watch("ulpl.user",function(){$scope.ulplForm.$valid?vm.calc(vm):vm.mainPlan.amount=""},!0),$scope.$watch("ulpl.mainPlan.exp",function(){$timeout(function(){$scope.ulplForm.$valid?vm.calc(vm):vm.mainPlan.amount=""},100)}),vm.calc=function(vm,callback){var user=vm.user;if("3"!==vm.productData.feeSetType)vm.mainPlan.amount=vm.mainPlan.exp,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan});else{var age=VALIDATION.getAgeByBirth(user.birthday),params={prdId:vm.productData.prd_id,age:age,sex:user.sex,payEndYear:vm.payAge};CommonRequest.request(params,CONFIG.PRODUCT_PURCHASE_CALCULATE_SERVICE,function(result){if(1==result.status){var rateTable=result.data,mainRate=[];if(vm.mainPlan.amount=0,rateTable&&rateTable.length>0){for(var i=0;i<rateTable.length;i++)"1"==rateTable[i].planType&&mainRate.push(rateTable[i]);mainRate&&mainRate.length>0&&(vm.mainPlan.rate=mainRate[0].rate,vm.mainPlan.amount=vm.mainPlan.exp/vm.mainPlan.normalPrice*vm.mainPlan.rate,callback&&callback({exp:vm.mainPlan.exp,amount:vm.mainPlan.amount,mainPlan:vm.mainPlan}))}else TipService.showMsg("费率为空！")}})}},vm.goPolicy=function(){if(vm.effectiveDate){var effectiveDate=new Date(vm.effectiveDate),year=effectiveDate.getFullYear(),month=effectiveDate.getMonth()+1,Day=effectiveDate.getDate();month>=1&&9>=month&&(month="0"+month),Day>=1&&9>=Day&&(Day="0"+Day);var effecDate=year+"-"+month+"-"+Day}PolicyService.setSessionData({productData:{PbBeginDate:effecDate}}),vm.mainPlan.exp=vm.mainPlan.exp.toString(),vm.mainPlan.amount=vm.mainPlan.amount.toString();var params={prdId:vm.productData.prd_id,sex:vm.user.sex,insurerBirthDay:$filter("date")(vm.user.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.control({state:"product-purchase-calculate",control:"data",data:{birthday:$filter("date")(vm.user.birthday,"yyyy-MM-dd"),sex:vm.user.sex,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,PbBeginDate:effecDate,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,calc:vm.calc.toString(),calcCtrl:vm}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{premiumCalculateTime:now}}),PolicyService.control({state:"product-purchase-calculate",control:"process"})})}}angular.module("app").controller("UlplController",UlplController),UlplController.$inject=["$state","CONFIG","CommonRequest","VALIDATION","$scope","$rootScope","PolicyService","TipService","$filter","$timeout"]}(),function(){function PolicyActivityController($state,CONFIG,CommonRequest,$scope,VALIDATION,$rootScope,PolicyService,TipService,$filter,$timeout,COMMON,$location){var vm=this;vm.iscrossArea=!1,vm.newRule=!CONFIG.WECHAT,PolicyService.setSessionData({policyData:{}}),1==$rootScope.nowStatus?vm.nowStatus=1:vm.nowStatus=0;var sessionPicuterData=sessionStorage.getItem("elife-overPicuter")||{};sessionPicuterData?"[object Object]"===Object.prototype.toString.call(sessionPicuterData)?vm.picuter={}:vm.picuter=JSON.parse(sessionPicuterData).picuter:vm.picuter={};var sessionData=PolicyService.getSessionData();vm.productData="",vm.policyData=sessionData.policyData,vm.id=$state.params.id,vm.livePlace="0",vm.securityDays=1,vm.relation="01",vm.timeKing=!1,vm.email="",vm.discount=1;var $search=$location.search(),newSaleChnl=$search.newSaleChnl;newSaleChnl&&(vm.newSaleChnl=newSaleChnl,PolicyService.control({state:"product-detail",control:"data",data:{newSaleChnl:newSaleChnl}})),vm.newSaleChnl&&vm.newSaleChnl.length>0&&(CONFIG.NEW_SALE_CHANNEL=vm.newSaleChnl),vm.WxChanelShow=!0;var timeIsMarke=$timeout(function(){console.info(vm.productData),console.info($rootScope.WECHAT);var isMarkeFlg="isMarketingStatus"in vm.productData;isMarkeFlg&&"1"==vm.productData.isMarketingStatus&&$rootScope.WECHAT&&(vm.WxChanelShow=!0,$timeout.cancel(timeIsMarke))},100);vm.getProductDetail=function(id){var params={prdId:id};CommonRequest.request(params,{url:$filter("jsonFilter")(id),method:"GET"},function(result){if(1==result.status){vm.productData=result.data,1==$rootScope.nowStatus&&"[object Array]"===Object.prototype.toString.call(vm.picuter)&&vm.picuter[0]&&vm.picuter.forEach(function(item,index){if(item.prdCode==vm.productData.prd_code)for(var i=0;i<item.picInfo.length;i++)"3"==item.picInfo[i].picLocation&&(vm.productData.prd_pic1=item.picInfo[i].prdPic)});var payTypeConfigs=vm.productData.payTypeConfigs;if(vm.minAge=[],vm.maxAge=[],payTypeConfigs&&payTypeConfigs.length>0){for(var l=0;l<payTypeConfigs.length;l++)vm.minAge.push(payTypeConfigs[l].min_app_age),vm.maxAge.push(payTypeConfigs[l].max_app_age);for(var m=0;m<vm.minAge.length-1;m++)for(var n=m+1;n<vm.minAge.length;n++){var temp1,temp2;vm.minAge[m]>vm.minAge[n]&&(temp1=vm.minAge[m],vm.minAge[m]=vm.minAge[n],vm.minAge[n]=temp1),vm.maxAge[m]<vm.maxAge[n]&&(temp2=vm.maxAge[m],vm.maxAge[m]=vm.maxAge[n],vm.maxAge[n]=temp2)}vm.productData.minAge=vm.minAge[0],vm.productData.maxAge=vm.maxAge[0],PolicyService.setSessionData({productData:result.data})}vm.getProductToken()}})};var times=0;vm.loadingPage=function(callback){return times>=10?void(times=0):(times++,vm.getProductDetail(vm.id),void $timeout(function(){return vm.productData?void(angular.isFunction(callback)&&callback()):void vm.loadingPage(callback)},500))},vm.getLotCode=function(callback){if("Y"==vm.productData.basicProfile.P022){var params={prdId:vm.productData.prd_id};CommonRequest.request(params,CONFIG.GET_LOTCODE_SERVCIE,function(result){"1"==result.status?(vm.lotCode=result.data,angular.isFunction(callback)&&callback()):angular.isFunction(callback)&&callback()})}else angular.isFunction(callback)&&callback()},vm.getcardToken=function(callback){var $search=$location.search(),lotCode=$search.lotCode;vm.getLotCode(function(){if(vm.lotCode&&(lotCode=vm.lotCode),lotCode){var params={lotCode:lotCode,channelCode:vm.newSaleChnl||CONFIG.SALE_CHANNEL,custWXId:$rootScope.openid,prdId:vm.id};PolicyService.getCardToken(params,function(token){token&&angular.isFunction(callback)&&callback(token)})}else PolicyService.control({state:"product-detail",control:"data",data:{token:"",lotCode:""}})})},vm.getProductToken=function(){vm.getcardToken(function(token){token&&(vm.token=token,PolicyService.getCardInfo(token,function(data){return data.prdId!=vm.productData.prd_id?(TipService.showMsg("该活动不适用于产品“"+productData.prd_title+"”，请核实！"),void $state.go("tab.mall")):(vm.productData.token=token,vm.productData.lotCode=data.lotCode,void PolicyService.control({state:"product-detail",control:"data",data:{token:token,lotCode:data.lotCode}}))}))})},vm.loadingPage(function(){vm.timeKing=!0,vm.isBatts=vm.productData.isBatts||"1",vm.isWholeSale="0"==vm.productData.payment_type,vm.showRenewal1=!1,vm.showRenewal2=!1,"Y"==vm.productData.basicProfile.P010&&("1"==vm.isBatts&&$scope.$watch("policyActivity.checked",function(newValue){1==newValue?(vm.showRenewal1=!0,vm.isBatts1="1"):(vm.showRenewal1=!1,vm.renewalBankAccount="",vm.renewalBankAccountConfirm="",vm.isBatts1="0",vm.renewalBank="")}),vm.isWholeSale?vm.showRenewal2=!1:"ipah"==vm.productData.templateCode.toLowerCase()||"tld"==vm.productData.templateCode.toLowerCase()||"hmra"==vm.productData.templateCode.toLowerCase()?vm.showRenewal2=!1:vm.showRenewal2=!0),vm.changeInsurYear=function(plans){var hash=[],arr=[];if(vm.insurYearArr=[],plans&&plans.length>0){for(var i=0;i<plans.length;i++)"Y"==plans[i].insuYearFlag?"1000"==plans[i].insuYear?arr.push("终身"):arr.push(plans[i].insuYear+"年"):"D"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"天"):"M"==plans[i].insuYearFlag?arr.push(plans[i].insuYear+"月"):"A"==plans[i].insuYearFlag&&arr.push("至被保险人年满"+plans[i].insuYear+"周岁后首个保单周年日");for(var i=0;i<arr.length;i++)null!=hash[arr[i]],hash[arr[i]]||(vm.insurYearArr.push(arr[i]),hash[arr[i]]=!0);vm.insurYearArr.length>1?vm.insurYearArr="可选"+vm.insurYearArr.toString().replace(/,/g,"、"):vm.insurYearArr=vm.insurYearArr.toString()}},vm.changeInsurYear(vm.productData.plans),vm.changePayAge=function(){var payment_value=[],payage_value=[];vm.payWays=[],vm.payAges=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage_value=vm.productData.pay_age.split(","));for(var temp=[],i=0;i<payment_value.length;i++)-1==temp.indexOf(payment_value[i])&&temp.push(payment_value[i]);payment_value=temp,payment_value.sort(),temp=[];for(var i=0;i<payage_value.length;i++)-1==temp.indexOf(payage_value[i])&&temp.push(payage_value[i]);if(payage_value=temp,payage_value.sort(),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label="年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push(label)}if(payage_value&&payage_value.length>0)for(var i=0;i<payage_value.length;i++)vm.payAges.push(payage_value[i]+"年");vm.payWays.length>1?vm.payMentTypeArr="可选"+vm.payWays.toString().replace(/,/g,"、"):vm.payMentTypeArr=vm.payWays.toString(),vm.payAges.length>1?vm.payAgeArr="可选"+vm.payAges.toString().replace(/,/g,"、"):vm.payAgeArr=vm.payAges.toString()};var sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.user={},vm.user.sex="1",vm.user.birthday=null,vm.user.payendyear="1",vm.birthdayCallback=function(val){val&&(vm.user.birthday=val,vm.changeConfig())};var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.min_app_age,vm.maxAge=payTypeConfig.max_app_age,vm.minHolderAge=payTypeConfig.minHolderAge,vm.maxHolderAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge),vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge)}vm.mainPlan={rate:0,amount:"",exp:""},vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan(),vm.getPayWay=function(){var payment_value=[],payage=[];if(vm.payWays=[],vm.productData.payment_type&&(payment_value=vm.productData.payment_type.split(",")),vm.productData.pay_age&&(payage=vm.productData.pay_age.split(",")),payage.sort(function(a,b){return a-b}),payment_value&&payment_value.length>0)for(var i=0;i<payment_value.length;i++){var label;12==payment_value[i]?label=payage[i]+"年交":0==payment_value[i]?label="趸交":1==payment_value[i]?label="月交":3==payment_value[i]?label="季交":6==payment_value[i]&&(label="半年交"),vm.payWays.push({label:label,value:payage[i]})}},vm.getPayWay(),vm.user.payendyear=vm.payWays[0].value,vm.mainPlan.exp="",vm.payendyearChange=function(val){20==val?vm.mainPlan.exp=3e3:vm.mainPlan.exp=5e3},vm.bulrExp=function(val){vm.mainPlan.exp=val},vm.changeConfig=function(){for(var age=VALIDATION.getAgeByBirth(vm.user.birthday),paymentValue=vm.user.payendyear,i=payTypeConfigs.length-1;i>=0;i--)if(payTypeConfigs[i].pay_age==paymentValue){if(vm.minStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].max_app_age),vm.maxEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].min_app_age),payTypeConfigs[i].min_app_age>age||age>payTypeConfigs[i].max_app_age){var checkMinAge=0==payTypeConfigs[i].min_app_age?"30天":payTypeConfigs[i].min_app_age+"周岁",checkMaxAge=0==payTypeConfigs[i].max_app_age?"30天":payTypeConfigs[i].max_app_age+"周岁（包含）";return"1"==paymentValue&&"0"==payTypeConfigs[i].payment_type?(TipService.showMsg("趸交：出生满"+checkMinAge+" -"+checkMaxAge),!1):(TipService.showMsg(paymentValue+"年交：出生满"+checkMinAge+" -"+checkMaxAge),!1)}return vm.minAge=payTypeConfigs[i].min_app_age,vm.maxAge=payTypeConfigs[i].max_app_age,vm.minHolderAge=payTypeConfigs[i].minHolderAge,vm.maxHolderAge=payTypeConfigs[i].maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(payTypeConfigs[i].maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(payTypeConfigs[i].minHolderAge),!0}},$scope.$watch("policyActivity.certNo",function(newValue,oldValue){if(newValue){if(!VALIDATION.idCheck(newValue))return 0!=vm.beiErrorFlag&&(vm.beiErrorFlag=!1),void(0!=vm.holdAgeError&&(vm.holdAgeError=!1));if(vm.beigender=VALIDATION.getSex(newValue)+"",vm.beibirthday=new Date(VALIDATION.getBirthday(newValue)),vm.beiage=VALIDATION.getAgeByBirth(vm.beibirthday),"0"==vm.productData.minAge)return void(parseInt(((new Date).getTime()-vm.beibirthday.getTime())/864e5)<30||vm.beiage>vm.productData.maxAge?(vm.holdAgeError=!0,vm.beiErrorFlag=!0,$timeout(function(){vm.beiErrorFlag=!1},1500)):(vm.holdAgeError=!1,"TLD"==vm.productData.templateCode&&(vm.user.birthday=vm.beibirthday,vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex=vm.beigender,vm.mainPlan.amount&&vm.tldCalc(vm))));vm.beiage<vm.productData.minAge||vm.beiage>vm.productData.maxAge?(vm.holdAgeError=!0,vm.beiErrorFlag=!0,$timeout(function(){vm.beiErrorFlag=!1},1500)):(vm.holdAgeError=!1,"TLD"==vm.productData.templateCode&&(vm.user.birthday=vm.beibirthday,vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex=vm.beigender,vm.mainPlan.amount&&vm.tldCalc(vm)))}}),$scope.$watch("policyActivity.insureCertNo",function(newValue,oldValue){if(newValue){if(!VALIDATION.idCheck(newValue))return 0!=vm.touErrorFlag&&(vm.touErrorFlag=!1),void(0!=vm.touholdAgeError&&(vm.touholdAgeError=!1));if(vm.tougender=VALIDATION.getSex(newValue)+"",vm.toubirthday=new Date(VALIDATION.getBirthday(newValue)),vm.touage=VALIDATION.getAgeByBirth(vm.toubirthday),"0"==vm.productData.minHolderAge)return void(parseInt(((new Date).getTime()-vm.toubirthday.getTime())/864e5)<30||vm.touage>vm.productData.maxHolderAge?(vm.touholdAgeError=!0,vm.touErrorFlag=!0,$timeout(function(){vm.touErrorFlag=!1},1500)):(vm.touholdAgeError=!1,"01"==vm.relation&&"TLD"==vm.productData.templateCode&&(vm.user.birthday=vm.toubirthday,vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex=vm.tougender,vm.mainPlan.amount&&vm.tldCalc(vm))));vm.touage<vm.productData.minHolderAge||vm.touage>vm.productData.maxHolderAge?(vm.touholdAgeError=!0,vm.touErrorFlag=!0,$timeout(function(){vm.touErrorFlag=!1},1500)):(vm.touholdAgeError=!1,"01"==vm.relation&&"TLD"==vm.productData.templateCode&&(vm.user.birthday=vm.toubirthday,vm.user.birthdayfm=$filter("date")(vm.user.birthday,"yyyyMMdd"),vm.user.sex=vm.tougender,vm.mainPlan.amount&&vm.tldCalc(vm)))}}),vm.errorAlert=function(key,val,rel){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid?(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):1==vm.touholdAgeError&&1==rel?(vm.touErrorFlag=!0,$timeout(function(){vm.touErrorFlag=!1},1500)):1==vm.holdAgeError&&(vm.beiErrorFlag=!0,$timeout(function(){vm.beiErrorFlag=!1},1500)):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hideError=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.beiErrorFlag=!1,vm.touErrorFlag=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.relationDisabled=!1,"TAC"==vm.productData.templateCode&&(vm.occupation="13020",vm.relationDisabled=!0),"TLD"==vm.productData.templateCode&&(vm.relationDisabled=!0),vm.checkDiscount=function(orgCode){var params={prdId:vm.productData.prd_id,planId:vm.mainPlan.planId,channelCode:CONFIG.SALE_CHANNEL,orgCode:orgCode||""};PolicyService.getProductDiscount(params,function(result){vm.discount=result.discount,vm.discount||(vm.discount=1),vm.disActivityId=result.disActivityId,vm.configType=result.configType,vm.hasDiscount=result.hasDiscount,vm.hasDiscount||(vm.discount="0"),sessionData.productData=result.hasDiscount})},vm.checkDiscount(),vm.getBankList1=function(){vm.BkBrchNo&&COMMON.getCommonBank(vm.BkBrchNo,"2",function(bankList){vm.bankList2=bankList,vm.bankList2&&vm.bankList2.length>0&&(vm.authBank=bankList[0],vm.bonusBank=bankList[0],vm.yearMoneyBank=bankList[0])})},vm.getBankList2=function(){vm.BkBrchNo&&COMMON.getCommonBank(vm.BkBrchNo,"1",function(bankList){vm.bankList1=bankList,vm.bankList&&vm.bankList.length>0&&(vm.newGetBkCode=bankList[0],vm.renewalBancCode=bankList[0])})},$scope.$on("select-prdarea-close",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.provinceAreaName=vm.province.areaName,vm.cityAreaName=vm.city.areaName,vm.districtAreaName=vm.district.areaName,vm.provinceCode=vm.province.areaCode,vm.cityCode=vm.city.areaCode,vm.districtCode=vm.district.areaCode,vm.province.areaCode){var code;code="1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code;var config={url:"../statics/product/netpoints/0/netpoint.json",method:"GET"};CommonRequest.request({},config,function(result){var provinceNetList=result;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode},config={url:"../statics/product/proxys/"+vm.district.areaCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.BkBrchNo=data.staffOrgCode,vm.checkDiscount(vm.staffOrgCode),vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty),vm.getBankList2(),vm.getBankList1()})}}),vm.getPlan=function(){var plan=vm.productData.plans,len=plan.length;if(plan&&plan.length>0)for(var i=len-1;i>=0;i--){var item=plan[i];"1"==item.planType?angular.extend(vm.mainPlan,item):"2"==item.planType&&angular.extend(vm.addPlan,item)}},vm.getPlan();var getMoneyUnit=function(ilName){return-1!=ilName.indexOf("住院")?"元/天":"元"},compare=function(obj1,obj2){var val1=obj1.ilCode,val2=obj2.ilCode;return val2>val1?-1:val1>val2?1:0},getInsuYearLable=function(insuYear,insuYearFlag){return"Y"==insuYearFlag?insuYear+"年":"M"==insuYearFlag?insuYear+"个月":"D"==insuYearFlag?insuYear+"天":"A"==insuYearFlag?"至"+insuYear+"周岁":void 0},watchSelectedPlans=function(){var margeDutys=[];vm.selectedPlansForMarge=vm.selectedPlans;for(var i=0;i<vm.selectedPlansForMarge.dutys.length;i++){vm.selectedPlansForMarge.dutys[i];margeDutys.push({ilCode:vm.selectedPlansForMarge.dutys[i].ilCode,ilName:vm.selectedPlansForMarge.dutys[i].ilName,insuredAmount:1e4==vm.selectedPlansForMarge.dutys[i].insuredAmount?vm.selectedPlansForMarge.dutys[i].insuredAmount/1e4*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+"万"+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName):vm.selectedPlansForMarge.dutys[i].insuredAmount*vm.selectedPlansForMarge.dutys[i].maxSaleQuantity+getMoneyUnit(vm.selectedPlansForMarge.dutys[i].ilName)})}vm.selectedPlansForShow=[],vm.selectedPlansForMarge.dutys.sort(compare),vm.selectedPlansForShow.dutys=margeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys};if($scope.$watch("policyActivity.productData.token",function(newValue){if(vm.productData.token){vm.ifGiveToken=!0;var giveMargeDutys=[];vm.giveCanNotChoseTime=!0,PolicyService.getCardInfo(vm.productData.token,function(data){if(data){vm.giveTokenInfo=data;for(var i=0;i<vm.giveTokenInfo.prmLotDutySetModels.length;i++)for(var newDuty=vm.giveTokenInfo.prmLotDutySetModels[i],j=0;j<vm.productData.plans[0].dutys.length;j++){var oldDuty=vm.productData.plans[0].dutys[j];newDuty.ilCode==oldDuty.ilCode&&giveMargeDutys.push({ilCode:oldDuty.ilCode,ilName:oldDuty.ilName,insuredAmount:1e4==oldDuty.insuredAmount?oldDuty.insuredAmount/1e4*oldDuty.maxSaleQuantity+"万"+getMoneyUnit(oldDuty.ilName):oldDuty.insuredAmount*oldDuty.maxSaleQuantity+getMoneyUnit(oldDuty.ilName)})}"固定保障期间"==vm.giveTokenInfo.donationMethodName&&(vm.securityDays=vm.giveTokenInfo.giveDay,vm.endDate=new Date(vm.startDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3),vm.choseSecurityDays=!1,vm.choseEndTime=!1,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveGivedaysAndStartTime=!0,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime)):(vm.giveTokenHaveGivedays=!0,vm.choseStartTime=!0)),"指定保障生效和终止日期"==vm.giveTokenInfo.donationMethodName&&(vm.giveTokenHaveStartTimeAndEndTime=!0,vm.choseEndTime=!1,vm.choseSecurityDays=!1,vm.choseStartTime=!1,vm.startDate=new Date(vm.giveTokenInfo.giveStartTime),vm.endDate=new Date(vm.giveTokenInfo.giveEndTime)),"按保障计划赠送"==vm.giveTokenInfo.donationMethodName&&(vm.choseEndTime=!0,vm.choseEndTime=!0,vm.giveTokenInfo.giveStartTime?(vm.giveTokenHaveStartTime=!0,vm.choseStartTime=!1):(vm.giveTokenHavePlan=!0,vm.choseStartTime=!0)),vm.selectedPlans=vm.productData.plans[0],vm.selectedPlansForShow=[],vm.selectedPlansForShow.dutys=giveMargeDutys,vm.mainPlan.dutysForShow=vm.selectedPlansForShow.dutys,angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId}})}else vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1}),vm.ifGiveToken=!1,vm.selectedPlans=vm.productData.plans[0],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.selectedPlans),vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),vm.user.selectedPlanId=vm.selectedPlans.planId,vm.giveCanNotChoseTime=!1,vm.gainInsure=function(callback){if(vm.productData&&vm.productData.orderCode)return void(angular.isFunction(callback)&&callback());var params={insurerBirthDay:VALIDATION.getBirthday(vm.insureCertNo),orderCode:"",planId:vm.mainPlan.planId,prdId:vm.productData.prd_id,premiumResult:"0",sex:VALIDATION.getSex(vm.insureCertNo)};CommonRequest.request(params,CONFIG.PREMIUM_RESULT_SERVICE,function(result){PolicyService.setSessionData({productData:{orderCode:result.data.orderCode}}),sessionData=PolicyService.getSessionData(),vm.productData=sessionData.productData,angular.isFunction(callback)&&callback()})},vm.changeRelation=function(type){1==type?(vm.relation="01",vm.certNo="",vm.relationDisabled=!1):(vm.relation="06",vm.relationDisabled=!0)},console.log(vm.productData.templateCode),vm.submit=function(){PolicyService.setSessionData({insureData:{pbApplNoNum:1}}),vm.insureCertNo&&vm.gainInsure(function(){PolicyService.createPbApplNo(vm.BkBrchNo,function(pbApplNoList){vm.PbApplNo=pbApplNoList,vm.checkPolicy()})})},vm.checkPolicy=function(){$timeout(function(){if(vm.PbApplNo){var doCheck=function(params,index){$timeout(function(){PolicyService.setSessionData({policyData:policyData}),PolicyService.checkPolicy(policyData,"single",function(itemOrderRealPayAmt){var data={itemOrderRealPayAmt:itemOrderRealPayAmt||0};PolicyService.setSessionData({policyData:data}),PolicyService.control({state:"product-purchase-confirm",control:"process"})})},500*index)},policyData=vm.getPolicyData();if(!policyData)return;if(angular.isArray(policyData)&&policyData.length>0)for(var i=0;i<policyData.length;i++)doCheck(policyData[i],i);else doCheck(policyData,0)}else vm.checkPolicy()},500)},vm.certType="A",vm.nationality="0156",vm.insureCertNo="",vm.zipCode="000000",vm.insureOccupation="C0000",vm.address="DEFAULT",vm.indate="20991231",vm.provinceNetCode=vm.provinceCode,vm.allWebsite="甘肃分行-甘肃省分行营业部-营业部秦安路营业室",vm.disputeHanding="1",vm.renteDrawMode="1",vm.PbInsuExp1="",vm.PbInsuExp2="",vm.bonusGetMode="2",vm.disputeGroupName="",vm.combineCheck="10",vm.healthTag="0",vm.certExpireType="1",vm.insureCertExpireType="1",vm.getPolicyData=function(){var _params;"TAC"==vm.productData.templateCode&&(vm.insureOccupation="13020"),vm.insureCertNo&&(vm.touGender=VALIDATION.getSex(vm.insureCertNo)+"",vm.touBirthday=new Date(VALIDATION.getBirthday(vm.insureCertNo)),vm.touAge=VALIDATION.getAgeByBirth(vm.touBirthday),vm.touAge<=19?(vm.indate=parseInt($filter("date")(vm.touBirthday,"yyyyMMdd").substring(0,4))+30,vm.indate=vm.indate+$filter("date")(vm.touBirthday,"yyyyMMdd").substring(4,8)):vm.touAge>19&&vm.touAge<=29?(vm.indate=parseInt($filter("date")(vm.touBirthday,"yyyyMMdd").substring(0,4))+40,vm.indate=vm.indate+$filter("date")(vm.touBirthday,"yyyyMMdd").substring(4,8)):vm.touAge>29&&vm.touAge<=49?(vm.indate=parseInt($filter("date")(vm.touBirthday,"yyyyMMdd").substring(0,4))+50,vm.indate=vm.indate+$filter("date")(vm.touBirthday,"yyyyMMdd").substring(4,8)):(vm.indate="20991231",vm.certExpireType="2")),vm.certNo&&(vm.beiGender=VALIDATION.getSex(vm.certNo)+"",vm.beiBirthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.beiAge=VALIDATION.getAgeByBirth(vm.beiBirthday),vm.beiAge<=19?(vm.beiIndate=parseInt($filter("date")(vm.beiBirthday,"yyyyMMdd").substring(0,4))+30,vm.beiIndate=vm.beiIndate+$filter("date")(vm.beiBirthday,"yyyyMMdd").substring(4,8)):vm.beiAge>19&&vm.beiAge<=29?(vm.beiIndate=parseInt($filter("date")(vm.beiBirthday,"yyyyMMdd").substring(0,4))+40,vm.beiIndate=vm.beiIndate+$filter("date")(vm.beiBirthday,"yyyyMMdd").substring(4,8)):vm.beiAge>29&&vm.beiAge<=49?(vm.beiIndate=parseInt($filter("date")(vm.beiBirthday,"yyyyMMdd").substring(0,4))+50,vm.beiIndate=vm.beiIndate+$filter("date")(vm.beiBirthday,"yyyyMMdd").substring(4,8)):(vm.beiIndate="20991231",vm.insureCertExpireType="2")),"01"!=vm.relation&&1==vm.touGender?vm.relation="04":"01"!=vm.relation&&2==vm.touGender?vm.relation="05":"01"==vm.relation&&(vm.certNo=vm.insureCertNo),0!=vm.yearIncome&&""!=vm.yearIncome||(vm.yearIncome=1e5);var params=(_params={orderCode:vm.productData.orderCode,PbBenfNum:"0",PbInsuType:vm.productData.prd_code,PbInsuName:vm.productData.prd_title,mainAndAdlInsInd:"1",PbSlipNumb:1,PbInsuExp:vm.mainPlan.exp,PbInsuAmt:vm.mainPlan.amount,PbMainInsuExp:0,PbInsuExpAppd:0,PbSendMode:"2",PbBeginDate:vm.startInDate,LiSpec:"",LiExpireInsuDrawMode:"",LiPayOffTag:"",LiHealthTag:vm.healthTag,PbPayPeriod:vm.productData.payment_type,PbPayAgeTag:"1",PbInsuYearFlag:vm.PbInsuYearFlag,LiInsuPeriod:vm.mainPlan.insuYear,PbInsuYear:0,PbPayAge:0,PbDrawAgeTag:"",PbDrawAge:0,LiImpawnTag:vm.LiImpawnTag||"",BkNum1:vm.BkNum1||0,AppdList:vm.AppdList||[],BkNum2:0,PbApplNo:vm.PbApplNo||"",BkVchNo:"",LiInsuSlipPWD:"",PiTrfVchNo:"",BkRckrNo:"",PiZxbe20:0,BkAreaNo:"",PiManBankNo:"",insScmInf:vm.mainPlan.planCode,SellTypeDetail:CONFIG.SALE_CHANNEL,PbInsuExp1:vm.PbInsuExp1,PbInsuExp2:vm.PbInsuExp2,allInsuExp:vm.mainPlan.exp,materials:vm.materials,
dutys:vm.mainPlan.dutys,prdId:vm.productData.prd_id,planId:vm.mainPlan.planId,PbHoldName:vm.name,PbHoldSex:VALIDATION.getSex(vm.insureCertNo),PbHoldBirdy:$filter("date")(VALIDATION.getBirthday(vm.insureCertNo),"yyyyMMdd"),PbHoldIdType:vm.certType,PbHoldId:vm.insureCertNo,PbIdStartDate:"",PbIdEndDate:vm.indate,PbNationality:vm.nationality,PbHoldOfficTele:vm.phone,PbHoldHomeTele:vm.phone,PbHoldMobl:vm.phone,PbHoldEmail:vm.email||"DEFAULT",PbHoldOccupCode:vm.insureOccupation||"",confirmRela:vm.relation,PbHoldRcgnRela:vm.relation,LiRcgnName:"01"==vm.relation?vm.name:vm.passiveName,LiRcgnSex:"01"==vm.relation?VALIDATION.getSex(vm.insureCertNo):VALIDATION.getSex(vm.certNo),LiRcgnBirdy:"01"==vm.relation?$filter("date")(VALIDATION.getBirthday(vm.insureCertNo),"yyyyMMdd"):$filter("date")(VALIDATION.getBirthday(vm.certNo),"yyyyMMdd"),LiRcgnIdType:vm.certType,LiRcgnId:"01"==vm.relation?vm.insureCertNo:vm.certNo,LiIdStartDate:"",LiIdEndDate:vm.beiIndate||vm.indate,LiNationality:vm.nationality,LiRcgnTele:vm.phone,LiRcgnMobl:vm.phone,LiRcgnEmail:vm.email||"DEFAULT",LiRcgnOccupCode:"01"==vm.relation?vm.insureOccupation:"13020",BankName:vm.name,minAge:vm.productData.minAge,maxAge:vm.productData.maxAge,minHolderAge:vm.productData.minHolderAge,maxHolderAge:vm.productData.maxHolderAge,certExpireType:vm.certExpireType,insureCertExpireType:vm.insureCertExpireType,agentCode:vm.staffId,BkBrchNo:vm.BkBrchNo,PbHoldAddr:vm.provinceCode+","+vm.cityCode,PbHoldPost:vm.zipCode},_defineProperty(_params,"PbHoldOfficTele",vm.phone),_defineProperty(_params,"PbHoldHomeAddr",vm.address),_defineProperty(_params,"PbHoldHomePost",vm.zipCode),_defineProperty(_params,"PbLivePlace",vm.livePlace),_defineProperty(_params,"PbYearIncome",vm.yearIncome),_defineProperty(_params,"PbWebsiteCode",""),_defineProperty(_params,"PbWebsiteName",""),_defineProperty(_params,"PbOtherProvinceCode",vm.isCrossArea?vm.provinceCode:""),_defineProperty(_params,"LiRcgnAddr",vm.address),_defineProperty(_params,"LiRcgnPost",vm.zipCode),_defineProperty(_params,"bankCodeLV1",vm.provinceCode||""),_defineProperty(_params,"bankCodeLV2",vm.cityNetCode||""),_defineProperty(_params,"bankCodeLV3",vm.districtNetCode||""),_defineProperty(_params,"districtCode",vm.provinceCode),_defineProperty(_params,"liveProvince",vm.provinceAreaName),_defineProperty(_params,"liveDistrict",vm.cityAreaName),_defineProperty(_params,"allWebsite",vm.allWebsite),_defineProperty(_params,"referrerCode",vm.referrerCode||""),_defineProperty(_params,"referrerName",vm.referrerName||""),_defineProperty(_params,"PlchdProvCd",vm.provinceCode),_defineProperty(_params,"PlchdCityCd",vm.cityCode),_defineProperty(_params,"PlchdDstcCd",vm.districtCode),_defineProperty(_params,"liveDstc",vm.districtAreaName||""),_defineProperty(_params,"crossAreaFlag",vm.isCrossArea?"1":"0"),_defineProperty(_params,"discount",vm.discount||1),_defineProperty(_params,"disActivityId",vm.disActivityId||""),_defineProperty(_params,"configType",vm.configType||""),_defineProperty(_params,"hasDiscount",vm.hasDiscount||"0"),_defineProperty(_params,"PbInsuPayMode",vm.renewalBankAccount&&vm.renewalBank?"0":""),_defineProperty(_params,"LiSpec",""),_defineProperty(_params,"LiExpireInsuDrawMode",""),_defineProperty(_params,"LiRenteDrawMode",vm.renteDrawMode),_defineProperty(_params,"AnutyPcsgMtdCd",vm.renteDrawMode),_defineProperty(_params,"PbAutoPayTag","0"),_defineProperty(_params,"LiBonusDistbTag",""),_defineProperty(_params,"LiBonusGetMode",vm.bonusGetMode),_defineProperty(_params,"PiZyzcfs",vm.disputeHanding),_defineProperty(_params,"PiZcinst",vm.disputeGroupName),_defineProperty(_params,"BkAcctNo3",vm.renewalBankAccount||""),_defineProperty(_params,"BankCode",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankCode:""),_defineProperty(_params,"BankName",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBankAccountName:""),_defineProperty(_params,"renewalBankName",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankName:""),_defineProperty(_params,"SpecFlag",vm.combineCheck),_defineProperty(_params,"NewPayMode",vm.newGetBk&&vm.newGetAccount?vm.newPayMode:""),_defineProperty(_params,"NewGetAccName",vm.newGetBk&&vm.newGetAccount?vm.newGetAccountName:""),_defineProperty(_params,"NewGetBkCode",vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankCode:""),_defineProperty(_params,"NewGetAccCode",vm.newGetAccount||""),_defineProperty(_params,"newGetBkName",vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankName:""),_defineProperty(_params,"benfSetType","1"),_defineProperty(_params,"isBatts",vm.isBatts1),_defineProperty(_params,"bonusBankCode",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankCode:""),_defineProperty(_params,"bonusBankName",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankName:""),_defineProperty(_params,"bonusBankAccountName",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBankAccountName:""),_defineProperty(_params,"bonusBankAccount",vm.bonusBankAccount||""),_defineProperty(_params,"liBonusBankCode",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankCode:""),_defineProperty(_params,"LiBonusBankName",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankName:""),_defineProperty(_params,"liBonusBankAccountName",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBankAccountName:""),_defineProperty(_params,"liBonusBankAccount",vm.liBonusBankAccount||""),_defineProperty(_params,"payBankCode",vm.authBank&&vm.authBankAccount?vm.authBank.bankCode:""),_defineProperty(_params,"authBankName",vm.authBank&&vm.authBankAccount?vm.authBank.bankName:""),_defineProperty(_params,"payBankNo",vm.authBankAccount||""),_defineProperty(_params,"payBankName",vm.authBank&&vm.authBankAccount?vm.authAccountName:""),_defineProperty(_params,"pbApplNoList",vm.PbApplNo),_defineProperty(_params,"PbInsuYearFlag",vm.PbInsuYearFlag),_defineProperty(_params,"PbRemark1",vm.productData.token||"1"==vm.hasDiscount?"0":"1"),_defineProperty(_params,"PbRemark2",vm.productData.token?2:"1"==vm.hasDiscount?"1":"0"),_defineProperty(_params,"PbRemark3",vm.productData.token?"0.00000000":vm.discount||""),_defineProperty(_params,"PbRemark4",vm.productData.lotCode?vm.productData.lotCode:vm.disActivityId||""),_defineProperty(_params,"PbRemark5",""),_defineProperty(_params,"PbRemark6",""),_defineProperty(_params,"disActId",vm.productData.token||"1"==vm.configType||"4"==vm.configType?"0000":vm.BkBrchNo.substr(0,4)),_defineProperty(_params,"saleChnl","2"==vm.configType||"4"==vm.configType?"000":CONFIG.SALE_CHANNEL),_defineProperty(_params,"cardToken",vm.productData.token),_defineProperty(_params,"beginTime",vm.startTime||""),_params);return vm.checkImgCodeForShow?(params.cpRandom=vm.cpRandom,params.cpImageCode=vm.cpImageCode):(params.cpRandom="",params.cpImageCode=""),vm.newSaleChnl&&(params.sellTypeDetail=vm.newSaleChnl,params.saleChnl=vm.newSaleChnl,params.salesId=vm.productData.salesId,params.parentSalesId=vm.productData.parentSalesId,params.salesLevel=vm.productData.salesLevel),"TAC"!=vm.productData.templateCode&&"TACA"!=vm.productData.templateCode&&"IPAM"!=vm.productData.templateCode||(params.cvrInsDt=vm.cvrInsDt,params.PbRemark6=vm.cvrInsDt),params.PbBeginDate=$filter("date")(params.PbBeginDate,"yyyyMMdd"),params.PbApplNo=vm.PbApplNo[0],params.insScmInf=vm.mainPlan.planCode,params.PbInsuExp=vm.mainPlan.exp+"",params},"IPAMB"==vm.productData.templateCode){var nowDate=new Date;vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate))),vm.startInDate=vm.minDate,vm.PbInsuYearFlag="2",vm.planChecked=1,vm.planOneCheck=function(){vm.planChecked=1},vm.planTwoCheck=function(){vm.planChecked=5},vm.planThreeCheck=function(){vm.planChecked=10},vm.planFourCheck=function(){vm.planChecked=20},vm.planFiveCheck=function(){vm.planChecked=30},vm.planSixCheck=function(){vm.planChecked=50},$scope.$watch("policyActivity.planChecked",function(){var regu=/^[1-9]\d*$/;0!=vm.planChecked&&vm.planChecked<=50&&regu.test(vm.planChecked)?(vm.mainPlan.exp=vm.planChecked,vm.mainPlan.amount=1e4*vm.mainPlan.exp):vm.mainPlan.exp=1,vm.selectedPlansForShow.dutys[0].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[1].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[2].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[3].insuredAmount=1e4*vm.mainPlan.exp+"元",vm.selectedPlansForShow.dutys[4].insuredAmount=1e4*vm.mainPlan.exp+"元"},!0)}if("TACB"==vm.productData.templateCode){if(2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>(new Date).getTime()&&(vm.minDate=planSaleTime,vm.startInDate=planSaleTime)}var nowDate=new Date;vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate))),vm.startInDate=vm.minDate,vm.startTime="24:00:00",vm.PbInsuYearFlag="5",$scope.$watch("policyActivity.startInDate",function(newValue){newValue&&("TACC"==vm.productData.templateCode&&vm.getStartTimeList(),vm.calc(vm))},!0),vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,PbBeginDate:$filter("date")(vm.startInDate,"yyyyMMdd"),insuredDays:vm.productData.plans[0]?vm.productData.plans[0].insuYear:7,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.productData.plans[0].planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],console.log(vm.mainPlan.amount)}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}}}if("TAC"==vm.productData.templateCode){vm.choseStartTime=!0;var nowDate=new Date;if(2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>nowDate.getTime()&&(vm.minDate=planSaleTime,vm.startInDate=planSaleTime)}vm.minDate=nowDate,vm.startInDate=vm.minDate,vm.maxDate=new Date((new Date).setMonth((new Date).getMonth()+3));var calcDate=function(){if(vm.startInDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endTime=new Date(vm.startInDate);return"M"==vm.selectedPlans.insuYearFlag?endTime.setMonth(vm.startInDate.getMonth()+Number(vm.selectedPlans.insuYear)):"D"==vm.selectedPlans.insuYearFlag&&endTime.setDate(vm.startInDate.getDate()+Number(vm.selectedPlans.insuYear)),$filter("date")(endTime,"yyyyMMdd")}};vm.cvrInsDt=calcDate(),vm.selectPlan=function(planId){if(vm.productData.plans=PolicyService.getSessionData().productData.plans,vm.productData.plans.sort(function(obj1,obj2){var val1=obj1.planCode,val2=obj2.planCode;return val2>val1?-1:val1>val2?1:0}),vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId&&(vm.selectedPlans=vm.productData.plans[i],watchSelectedPlans(),angular.extend(vm.mainPlan,PolicyService.getSessionData().productData.plans[i]));vm.mainPlan.exp=vm.selectedPlans.normalPrice,vm.mainPlan.amount=vm.selectedPlans.insuredAmount,vm.selectedPlans.securityAge=getInsuYearLable(vm.selectedPlans.insuYear,vm.selectedPlans.insuYearFlag),"2个月"==vm.selectedPlans.securityAge?vm.PbInsuYearFlag="4":vm.PbInsuYearFlag="5",vm.user.selectedPlanId=vm.selectedPlans.planId},vm.user.selectedPlanId=vm.productData.plans[0].planId,vm.selectPlan(vm.user.selectedPlanId)}if("TACC"==vm.productData.templateCode){if(vm.taccFlag=!1,vm.getStartTimeList=function(){vm.taccFlag=!0;var createList=function(startHour){for(var tempList=[],i=startHour;24>=i;i++)tempList.push(i+"");return tempList},nowDate=new Date,nowDateStr=$filter("date")(nowDate,"yyyy-MM-dd"),nowHour=nowDate.getHours(),startDateStr=($filter("date")(new Date(nextDay),"yyyy-MM-dd"),$filter("date")(vm.startInDate,"yyyy-MM-dd"));vm.startHourList=[],nowDateStr==startDateStr&&nextDayFlag>nowHour?(vm.productData.token||(vm.giveCanNotChoseTime=!1),vm.startHourList=createList(nowHour+4)):nowDateStr==startDateStr&&nowHour>=nextDayFlag?(vm.giveCanNotChoseTime=!0,vm.startTime="24:00"):(vm.productData.token||(vm.giveCanNotChoseTime=!1),vm.startHourList=createList(1));for(var i=1;24>=i;i++)$("#isShow"+i).show();for(var i=1;24>=i&&i<vm.startHourList[0];i++)$("#isShow"+i).hide();vm.startTime="24:00"},vm.showTimeSelect=function(){vm.timeSelectShow=!0},vm.setStartTime=function(value){vm.timeSelectShow=!1,vm.startTime=value+":00"},2==vm.productData.prdSaleCode&&vm.productData.planSaleTime){var planSaleTime=vm.productData.planSaleTime;planSaleTime=planSaleTime.substr(0,4)+"-"+planSaleTime.substr(4,2)+"-"+planSaleTime.substr(6,2),planSaleTime=new Date(planSaleTime),planSaleTime.getTime()>(new Date).getTime()&&(vm.minDate=planSaleTime,vm.startInDate=planSaleTime)}var nowDate=new Date,nextDayFlag=21,nextDay=nowDate.getTime()+864e5;if(vm.minDate=new Date(nowDate),vm.maxDate=new Date(VALIDATION.addMounth(3,new Date(nowDate))),vm.startInDate=vm.minDate,vm.insuYear="1",vm.plans=vm.productData.plans,vm.startTime="24:00:00",vm.PbInsuYearFlag="5",vm.paymentType=vm.productData.payment_type,vm.payAge=vm.productData.pay_age,vm.productData.plans){vm.color="#b2ceff";for(var i=0;i<vm.productData.plans.length;i++)$("#plan-select div").eq(i).css({background:vm.color}),"#b2ceff"==vm.color?vm.color="#a3d5ff":vm.color="#b2ceff"}$scope.$watch("policyActivity.insuYear",function(newValue){newValue&&("30"==newValue?(vm.selectedPlans.insuYear="1",vm.selectedPlans.insuYearFlag="M",vm.mainPlan.insuYearFlag="M",vm.mainPlan.insuYear="1",vm.securityDays="1",vm.PbInsuYearFlag="4"):(vm.selectedPlans.insuYear=newValue,vm.selectedPlans.insuYearFlag="D",vm.mainPlan.insuYearFlag="D",vm.securityDays=newValue,vm.mainPlan.insuYear=newValue,vm.PbInsuYearFlag="5"),vm.calc(vm))},!0),$scope.$watch("policyActivity.startInDate",function(newValue){newValue&&(vm.getStartTimeList(),vm.choseEndTime&&(vm.minEndDate=new Date(vm.startInDate.getTime()+864e5),vm.maxEndDate=new Date(vm.startInDate.getTime()+31536e6),vm.endDate=vm.minEndDate),vm.choseEndTime||vm.giveTokenInfo&&vm.giveTokenInfo.giveDay&&(vm.endDate=new Date(vm.startInDate.getTime()+24*vm.giveTokenInfo.giveDay*60*60*1e3)),vm.endDate&&vm.startInDate.getTime()>vm.endDate.getTime()&&(vm.endDate=null,vm.securityDays=null,vm.securityDaysForShow=null),vm.calc(vm))},!0),vm.selectPlan=function(planId){if(vm.productData.plans=PolicyService.getSessionData().productData.plans,vm.productData.plans.sort(function(obj1,obj2){var val1=obj1.planCode,val2=obj2.planCode;return val2>val1?-1:val1>val2?1:0}),vm.color="#b2ceff",vm.productData.plans&&vm.productData.plans.length>0)for(var i=0;i<vm.productData.plans.length;i++)vm.productData.plans[i].planId==planId?($("#plan-select div").eq(0).css({background:"#b2ceff"}),vm.productData.plans[i].insuYear=vm.mainPlan.insuYear,vm.productData.plans[i].insuYearFlag=vm.mainPlan.insuYearFlag,vm.selectedPlans=vm.productData.plans[i],watchSelectedPlans(),angular.extend(vm.mainPlan,vm.productData.plans[i])):($("#plan-select div").eq(i).css({background:vm.color}),"#b2ceff"==vm.color?vm.color="#a3d5ff":vm.color="#b2ceff");vm.user.selectedPlanId=vm.selectedPlans.planId,vm.calc(vm)},vm.selectOne=function(){vm.insuYear="1"},vm.selectThree=function(){vm.insuYear="3"},vm.selectFive=function(){vm.insuYear="5"},vm.selectSeven=function(){vm.insuYear="7"},vm.selectTen=function(){vm.insuYear="10"},vm.selectFifteen=function(){vm.insuYear="15"},vm.selectMonth=function(){vm.insuYear="30"},vm.calc=function(vm){var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,PbBeginDate:$filter("date")(vm.startInDate,"yyyyMMdd"),insuredDays:vm.securityDays,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.selectedPlans.planCode,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){if(result.data.premiumResult){var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1]}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))}});var checkPremiumNum=0,checkPremium=function checkPremium(){if(checkPremiumNum++,checkPremiumNum>CONFIG.CALCEXP_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(checkPremiumNum=0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1!=result.status)return $ionicLoading.hide(),checkPremiumNum=0,void TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED);if(result.data.premiumResult){$ionicLoading.hide();var data=result.data,amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],checkPremiumNum=0}result.data.redisKey&&(vm.redisKey=result.data.redisKey,$timeout(function(){checkPremium()},CONFIG.CALCEXP_DECOUPLING_DURATION))})}};var calcDate=function(){if(vm.startInDate&&vm.selectedPlans.insuYear&&vm.selectedPlans.insuYearFlag){var endDate=new Date(vm.startInDate);return"M"==vm.selectedPlans.insuYearFlag?endDate=new Date(VALIDATION.addMounth(Number(vm.selectedPlans.insuYear),new Date(vm.startInDate))):"D"==vm.selectedPlans.insuYearFlag?endDate.setDate(vm.startInDate.getDate()+Number(vm.selectedPlans.insuYear)):"Y"==vm.selectedPlans.insuYearFlag&&endDate.setFullYear(vm.startInDate.getFullYear()+Number(vm.selectedPlans.insuYear)),$filter("date")(endDate,"yyyyMMdd")}}}"TLD"==vm.productData.templateCode&&(vm.payAge="1",vm.paymentType="12",vm.insuredAmount="10万元",vm.PbInsuYearFlag="2",vm.insuredAmountOne=function(){vm.insuredAmount="10万元"},vm.insuredAmountTwo=function(){vm.insuredAmount="20万元"},vm.insuredAmountThree=function(){vm.insuredAmount="50万元"},$scope.$watch("policyActivity.insuredAmount",function(newvalue){newvalue&&(vm.amountStr=newvalue+"",vm.newAmount=vm.amountStr.substring(0,2),vm.insuredAmount=vm.newAmount+"万元",vm.mainPlan.amount=1e4*vm.newAmount),vm.insureCertNo&&!vm.touholdAgeError&&vm.tldCalc(vm)},!0),vm.tldCalc=function(vm,callback){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return vm.mainPlan.exp="",void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.mainPlan.exp=amountExp[0],vm.nextStep=!1,void(callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan}))}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:vm.user.birthdayfm,sex:vm.user.sex,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.nextStep=!1}callback&&callback({exp:vm.mainPlan.exp,mainPlan:vm.mainPlan})})}),vm.healthDetail=function(){COMMON.showModal("app/module/mall/product/product-purchase/product-info-lite/product-activation-notice/product-activation-notice.html")},vm.materialList=function(){vm.materialShow?$timeout(function(){vm.materialShow=!vm.materialShow},100):vm.materialShow=!vm.materialShow,vm.materialAni=!vm.materialAni},vm.toggle=!1,vm.account=function(){vm.checked&&(vm.toggle=!0,$("#hidden").css({display:"block"}))},vm.hidden=function(){$("#hidden").css({display:"none"})},vm.materialDetail=function(ma){if(console.log(ma),ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params,function(materialArr){vm.materialArr=materialArr;for(var i=0;i<vm.materialArr.length;i++)"M01"==materialType&&(vm.materialArr[i].description="条款");vm.materialList()})}},vm.getProductMaterials=function(id){PolicyService.getMaterials({prdId:id,saleChannel:CONFIG.SALE_CHANNEL},function(materials){vm.materials=materials;for(var i=0;i<vm.materials.length;i++)if("M01"==vm.materials[i].materialType&&(vm.ma=vm.materials[i],vm.ma)){var materialTypeDesc=vm.ma.materialTypeDesc,materialType=vm.ma.materialType;vm.ma.description="条款";var params={prdId:id,materialType:materialType,materialTypeDesc:materialTypeDesc};CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status){vm.maDetail=result.data;for(var i=0;i<vm.maDetail.length;i++)vm.maDetail[i].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+vm.maDetail[i].materialPath}})}PolicyService.setSessionData({productData:{materials:materials}})})},vm.getProductMaterials(vm.productData.prd_id),vm.productData&&vm.productData.materials&&(vm.materials=vm.productData.materials),vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){vm.email&&-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val.invalid?(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500)):1==val.length&&(vm.emailLen=!0,$timeout(function(){vm.emailLen=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}}})}angular.module("app").controller("PolicyActivityController",PolicyActivityController),PolicyActivityController.$inject=["$state","CONFIG","CommonRequest","$scope","VALIDATION","$rootScope","PolicyService","TipService","$filter","$timeout","COMMON","$location"]}(),function(){function PolicyAgreementController($state,PolicyService,COMMON,$scope,$rootScope,$filter,CommonRequest,CONFIG,$timeout,TipService){var vm=this;vm.isTipsVisible=!1;var sessionData=PolicyService.getSessionData();if(vm.prodata=vm.productData=sessionData.productData,!vm.productData)return void $state.go("tab.mall");vm.cutizentype=COMMON.getCommonData().CITIZENTYPE,vm.taxpymtnotype=COMMON.getCommonData().TAXPYMTNOTYPE,vm.nontaxpymtcd=COMMON.getCommonData().NONTAXPYMTCD;vm.userdata=sessionData.userData,vm.insuredata=sessionData.insureData;vm.basicProfile=vm.productData.basicProfile,vm.policydata=sessionData.policyData,console.info(sessionData.policyData),vm.totalPolicyMount=sessionData.policyData.totalPolicyMount;var policydata;policydata=!vm.prodata.basicProfile||"Y"!=vm.prodata.basicProfile.P023&&"HMRA"!=vm.prodata.prd_code?"":sessionData.policyData||"",vm.crsData=policydata.crsData?policydata.crsData:"";var BkBrchNo;vm.policydata&&(BkBrchNo=vm.policydata.BkBrchNo),vm.policydata.PbHoldName&&(vm.newGetAccountName=vm.policydata.PbHoldName,vm.authAccountName=vm.policydata.PbHoldName,vm.bonusBankAccountName=vm.policydata.PbHoldName,vm.liBonusBankAccountName=vm.policydata.PbHoldName,vm.renewalBankAccountName=vm.policydata.PbHoldName),vm.bonusGetMode=policydata.LiBonusGetMode||"2",vm.liBonusBankAccount=vm.liBonusBankAccountConfirm=policydata.liBonusBankAccount||"",policydata.liBonusBankAccount&&(vm.agree1=!0),vm.renteDrawMode=policydata.LiRenteDrawMode||"1",vm.bonusBankAccount=vm.bonusbankAccountConfirm=policydata.bonusBankAccount||"",policydata.bonusBankAccount&&(vm.agree2=!0),vm.isBatts=policydata.isBatts||vm.productData.isBatts||"1",vm.showRenewal1=!1,vm.showRenewal2=!1,"Y"==vm.productData.basicProfile.P010&&("1"==vm.productData.isBatts&&$scope.$watch("policyAgreement.isBatts",function(newValue){"1"==newValue?vm.showRenewal1=!0:vm.showRenewal1=!1}),vm.insuredata.isWholeSale?vm.showRenewal2=!1:"ipah"==vm.productData.templateCode.toLowerCase()||"tld"==vm.productData.templateCode.toLowerCase()||"hmra"==vm.productData.templateCode.toLowerCase()||"hmrb"==vm.productData.templateCode.toLowerCase()?vm.showRenewal2=!1:vm.showRenewal2=!0),vm.renewalBankAccount=vm.renewalBankAccountConfirm=policydata.BkAcctNo3||"",policydata.BkAcctNo3&&(vm.agree3=!0),vm.authBankAccount=vm.authBankAccountConfirm=policydata.BkAcctNo1||"",policydata.BkAcctNo1&&(vm.agree4=!0),vm.newPayMode="7",vm.newGetAccount=vm.newGetAccountConfirm=policydata.NewGetAccCode||"",policydata.NewGetAccCode&&(vm.agree5=!0),$scope.$watch("policyAgreement.renewalBankAccount",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccount=str}}),$scope.$watch("policyAgreement.renewalBankAccountConfirm",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccountConfirm=str}}),vm.disputeHanding=policydata.PiZyzcfs||1,vm.disputeGroupName=policydata.PiZcinst||"",vm.getVprdid=function(){var params={prdCode:"ALLIN"};CommonRequest.request(params,CONFIG.NEW_GETPRDID,function(result){result.data&&(vm.v_prdid=result.data)})},vm.clearInput=function(Type,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&("1"==Type?vm.crsList[i].nonTaxPymtDesc="":"2"==Type&&(vm.crsList[i].taxPymtNo=""))},vm.clearInputse=function(nonTaxPymtCd,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&"1"==nonTaxPymtCd&&(vm.crsList[i].nonTaxPymtDesc="")},vm.getVprdid(),vm.crsData?vm.citizenType=vm.crsData.citizenType||"":"A"==policydata.PbHoldIdType?vm.citizenType="1":vm.citizenType="",vm.insuranceName=vm.policydata.PbHoldName,vm.surname=vm.crsData.surname||"",vm.secondName=vm.crsData.secondName||"",vm.crsBirthday=$filter("date")(vm.policydata.PbHoldBirdyDate,"yyyy-MM-dd"),vm.liveCountry="中国",vm.liveZone=vm.policydata.liveProvince+"-"+vm.policydata.liveDistrict+"-"+vm.policydata.liveDstc,vm.liveAdr=vm.policydata.PbHoldHomeAddr,vm.birthCountry=vm.crsData.birthCountryCont||"中国",vm.birthCode=vm.crsData.birthCountry||"CHN",vm.province={},vm.city={},vm.district={},vm.province.areaName=vm.crsData.birthProvinceCont||"",vm.city.areaName=vm.crsData.birthDistrictCont||"",vm.district.areaName=vm.crsData.birthDstcCont||"",vm.province.areaCode=vm.crsData.birthProvince||"",vm.city.areaCode=vm.crsData.birthDistrict||"",vm.district.areaCode=vm.crsData.birthDstc||"",$scope.$on("select-country-close",function(event,result){vm.birthCountry=result[0].countryName,vm.birthCode=result[0].countryCode}),vm.locate=vm.crsData.birthProvinceCont?vm.crsData.birthProvinceCont+"-"+vm.crsData.birthDistrictCont+"-"+vm.crsData.birthDstcCont:"",vm.birthDetailAdr=vm.crsData.birthDetailAdr||"",$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),vm.signDate=$filter("date")(new Date,"yyyy年MM月dd日"),vm.isSelf="本人",vm.crsData.taxList&&0!=vm.crsData.taxList.length?vm.crsList=vm.crsData.taxList:vm.crsList=[{seqNo:1,taxPymtNoType:""}],vm.addCrs=function(){if(!(vm.crsList.length>=3)){var seqNo=vm.crsList[vm.crsList.length-1].seqNo+1;vm.crsList.push({seqNo:seqNo,taxPymtNoType:""})}},vm.delCrs=function(seqNo){if(!(vm.crsList.length<=1))for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&vm.crsList.splice(i,1)},vm.getBankList1=function(){BkBrchNo&&COMMON.getCommonBank(BkBrchNo,"2",function(bankList){if(vm.bankList2=bankList,vm.bankList2&&vm.bankList2.length>0){if(vm.authBank=bankList[0],vm.bonusBank=bankList[0],vm.yearMoneyBank=bankList[0],policydata.liBonusBankCode)for(var i=0;i<vm.bankList2.length;i++)if(vm.bankList2[i].bankCode==policydata.liBonusBankCode)return void(vm.liBonusBank=vm.bankList2[i]);if(policydata.bonusBankCode)for(var i=0;i<vm.bankList2.length;i++)if(vm.bankList2[i].bankCode==policydata.bonusBankCode)return void(vm.bonusBank=vm.bankList2[i]);if(policydata.payBankCode)for(var i=0;i<vm.bankList2.length;i++)if(vm.bankList2[i].bankCode==policydata.payBankCode)return void(vm.authBank=vm.bankList2[i])}})},vm.getBankList1(),vm.getBankList2=function(){BkBrchNo&&COMMON.getCommonBank(BkBrchNo,"1",function(bankList){if(vm.bankList1=bankList,vm.bankList1&&vm.bankList1.length>0&&(vm.newGetBk=bankList[0]),policydata.BankCode)for(var i=0;i<vm.bankList1.length;i++)if(vm.bankList1[i].bankCode==policydata.BankCode)return void(vm.renewalBank=vm.bankList1[i]);if(policydata.NewGetBkCode)for(var i=0;i<vm.bankList1.length;i++)if(vm.bankList1[i].bankCode==policydata.NewGetBkCode)return void(vm.newGetBk=vm.bankList1[i])})},vm.getBankList2(),vm.errorAlert=function(key,val){"disputeGroupName"==key?1==val.invalid?(vm.disputeGroupNameErr=!0,$timeout(function(){vm.disputeGroupNameErr=!1},1500)):1==val.length&&(vm.disputeGroupNameLen=!0,$timeout(function(){vm.disputeGroupNameLen=!1},1500)):"liBonusBankAccountName"==key||"bonusBankAccountName"==key||"renewalBankAccountName"==key||"authAccountName"==key||"newGetAccountName"==key||"liBonusBankAccountName"==key||"surname"==key||"secondName"==key||"insuranceName"==key?("surname"!=key&&"secondName"!=key||(vm.surNameErr=!0),1==val.invalid?(vm.liBonusErr=!0,$timeout(function(){vm.liBonusErr=!1,vm.surNameErr=!1},1500)):1==val.length&&(vm.liBonusLen=!0,$timeout(function(){vm.liBonusLen=!1,vm.surNameErr=!1},1500))):"liBonusBankAccount"==key||"bonusBankAccount"==key||"renewalBankAccount"==key||"authBankAccount"==key||"newGetAccount"==key?("newGetAccount"==key&&(vm.newAccount=!0),
1==val.invalid?(vm.liAccountErr=!0,$timeout(function(){vm.liAccountErr=!1},1500)):1==val.length&&(vm.liAccountLen=!0,$timeout(function(){vm.liAccountLen=!1},1500))):"liBonusBankAccountConfirm"!=key&&"bonusbankAccountConfirm"!=key&&"renewalBankAccountConfirm"!=key&&"authBankAccountConfirm"!=key&&"newGetAccountConfirm"!=key||(1==val.invalid?(vm.liAccountConfirmErr=!0,$timeout(function(){vm.liAccountConfirmErr=!1},1500)):1==val.same?(vm.liAccountConfirmSame=!0,$timeout(function(){vm.liAccountConfirmSame=!1},1500)):1==val.banknoFirst?(vm.liAccountConfirmFir=!0,$timeout(function(){vm.liAccountConfirmFir=!1},1500)):1==val.length&&(vm.liAccountConfirmLen=!0,$timeout(function(){vm.liAccountConfirmLen=!1},1500)))},vm.birthDetailAdrAlert=function(val){1==val.invalid?(vm.birthDetailAdrErr=!0,$timeout(function(){vm.birthDetailAdrErr=!1},1500)):1==val.length?(vm.birthDetailAdrLen=!0,$timeout(function(){vm.birthDetailAdrLen=!1},1500)):1==val.number&&(vm.birthDetailAdrNum=!0,$timeout(function(){vm.birthDetailAdrNum=!1},1500))},vm.hide=function(){vm.liBonusErr=!1,vm.liBonusLen=!1,vm.liAccountLen=!1,vm.liAccountErr=!1,vm.liAccountConfirmErr=!1,vm.liAccountConfirmSame=!1,vm.liAccountConfirmFir=!1,vm.authBankAccountErr=!1,vm.liConfirmErr=!1,vm.birthDetailAdrNum=!1,vm.disputeGroupNameLen=!1,vm.disputeGroupNameErr=!1,vm.surNameErr=!1,vm.surNameLen=!1,vm.birthDetailAdrErr=!1,vm.birthDetailAdrLen=!1,vm.birthDetailAdrNum=!1},vm.transferCheck=function(){var specialCheck="Y"==vm.productData.basicProfile.P004?"1":"0",payWay=vm.productData.payType.split(","),payFlag="0";if(payWay&&payWay.length>0)for(var i=0;i<payWay.length;i++)if("109"==payWay[i]){payFlag="1";break}vm.combineCheck=specialCheck+payFlag},vm.transferCheck(),vm.showDisName=function(){$document[0].policyInfoForm.disputeGroupName.focus()},vm.changeDisputeHanding=function(e,id){e.preventDefault(),vm.disputeHanding!=id&&(vm.disputeHanding=id)},vm.next=function(){if(("1"==vm.isBatts||vm.showRenewal1||vm.showRenewal2||vm.insuredata.loveheaPlan)&&!vm.renewalBank.bankCode)return void TipService.showMsg("请选择银行储蓄卡");var data={PbInsuPayMode:vm.renewalBankAccount&&vm.renewalBank?"0":"",LiSpec:"",LiExpireInsuDrawMode:"0",LiRenteDrawMode:vm.renteDrawMode,AnutyPcsgMtdCd:vm.renteDrawMode,PbAutoPayTag:"0",LiBonusDistbTag:"",LiBonusGetMode:vm.bonusGetMode,BkAcctNo1:vm.authBankAccount,BkAcctNo2:vm.bonusBankAccount,PiZyzcfs:vm.disputeHanding,PiZcinst:vm.disputeGroupName,BkAcctNo3:vm.renewalBankAccount.replace(/\s+/g,"")||"",BankCode:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankCode:"",BankName:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBankAccountName:"",renewalBankName:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankName:"",SpecFlag:vm.combineCheck,NewPayMode:vm.newGetBk&&vm.newGetAccount?vm.newPayMode:"",NewGetAccName:vm.newGetBk&&vm.newGetAccount?vm.newGetAccountName:"",NewGetBkCode:vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankCode:"",NewGetAccCode:vm.newGetAccount||"",newGetBkName:vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankName:"",benfSetType:"1",isBatts:vm.isBatts,bonusBankCode:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankCode:"",bonusBankName:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankName:"",bonusBankAccountName:vm.bonusBank&&vm.bonusBankAccount?vm.bonusBankAccountName:"",bonusBankAccount:vm.bonusBankAccount||"",liBonusBankCode:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankCode:"",LiBonusBankName:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankName:"",liBonusBankAccountName:vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBankAccountName:"",liBonusBankAccount:vm.liBonusBankAccount||"",payBankCode:vm.authBank&&vm.authBankAccount?vm.authBank.bankCode:"",authBankName:vm.authBank&&vm.authBankAccount?vm.authBank.bankName:"",payBankNo:vm.authBankAccount||"",payBankName:vm.authBank&&vm.authBankAccount?vm.authAccountName:""};if(vm.basicProfile.P020&&"Y"==vm.basicProfile.P020){var birthFlag,isCitizenType=!0;"2"!=vm.citizenType&&"3"!=vm.citizenType||(isCitizenType=!1),birthFlag=("2"==vm.citizenType||"3"==vm.citizenType)&&"CHN"==vm.birthCode;var crsData={citizenType:vm.citizenType,surname:isCitizenType?"":vm.surname,secondName:isCitizenType?"":vm.secondName,liveCountry:isCitizenType?"":"CHN",birthCountryCont:isCitizenType?"":vm.birthCountry,birthCountry:isCitizenType?"":vm.birthCode,birthProvinceCont:vm.province&&birthFlag?vm.province.areaName:"",birthProvince:vm.province&&birthFlag?vm.province.areaCode:"",birthDistrictCont:vm.city&&birthFlag?vm.city.areaName:"",birthDistrict:vm.city&&birthFlag?vm.city.areaCode:"",birthDstcCont:vm.district&&birthFlag?vm.district.areaName:"",birthDstc:vm.district&&birthFlag?vm.district.areaCode:"",birthDetailAdr:isCitizenType?"":vm.birthDetailAdr,taxList:isCitizenType?[]:vm.crsList,signDate:vm.signDate,isSelf:"1"};data.crsData=crsData,data=angular.extend(data,crsData)}var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{policyAgreementTime:now}}),PolicyService.control({state:"product-purchase-policy-agreement",control:"data",data:data}),PolicyService.control({state:"product-purchase-policy-agreement",control:"process"})}}angular.module("app").controller("PolicyAgreementController",PolicyAgreementController),PolicyAgreementController.$inject=["$state","PolicyService","COMMON","$scope","$rootScope","$filter","CommonRequest","CONFIG","$timeout","TipService"]}(),function(){function PolicyContactController($state,CommonRequest,CONFIG,PolicyService,$scope,$rootScope,TipService,$timeout,$filter,$ionicPopup){function transOrigin(data){if(console.info(data),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){console.info(data),0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){console.info(obj);var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var dataLocation=result.addressComponents;vm.dataLocation=result.addressComponents,vm.gudgeIsLocation=dataLocation.province,vm.gudgeCity=dataLocation.city,vm.gudgeDistrict=dataLocation.district,vm.prdId=prodata.prd_id,vm.districtLevel1(vm.gudgeIsLocation)}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"获取位置信息失败",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var vm=this;vm.iscrossArea=!1;var sessionData=PolicyService.getSessionData();vm.addressFlag=!1;var prodata=vm.prodata=sessionData.productData,insuredata=vm.insureData=sessionData.insureData;vm.userData=sessionData.userData,vm.totalPolicyMount=sessionData.policyData.totalPolicyMount,console.info("产品",sessionData),vm.parentName="推荐人姓名",vm.parentNum="请输入推荐人工号",vm.parentDescName="请输入推荐人姓名",vm.parentJobNum="推荐人工号","Y"==vm.prodata.prelnsureFlag?vm.prodataFlag=vm.prodata.prd_id+vm.prodata.prelnsureFlag:vm.prodataFlag=vm.prodata.prd_id;var policyData;if(policyData=!prodata.basicProfile||"Y"!=prodata.basicProfile.P023&&"HMRA"!=prodata.prd_code?"":sessionData.policyData||"",vm.flag=!0,"IPAHK"==prodata.templateCode&&(vm.flag=!1),!prodata)return void $state.go("tab.mall");if(vm.isWechat="811"==CONFIG.NEW_SALE_CHANNEL,vm.referrNameFlag=0,vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.NEW_SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data){var res=result.data.filter(function(v){return v.prdId==prodata.prd_id});vm.referrNameFlag=0!=res.length?1:0,console.info(vm.referrNameFlag+"是否显示：推荐人[是][否]"),"1"==vm.referrNameFlag?(vm.mastWirte="必填",vm.isReferShow=1,vm.requiredFlag=!0):vm.isReferShow=0}})},vm.isReferShow=0,vm.mastWirte="必填",vm.requiredFlag=!0,vm.referrerCodeChecked=!1,vm.changeRefer=function(){console.info("渠道"+CONFIG.NEW_SALE_CHANNEL),vm.getSaleChannelPort(),console.info(vm.requiredFlag)},vm.changeRefer(),vm.selectCode=function(val){val&&(vm.referrerCode=val.agentNumber,vm.referrerName=val.name,vm.referrerOrg=val.managecom,vm.showCodeList=!1,vm.referrerCodeChecked=!0)},prodata.salesId&&"827"==prodata.newSaleChnl&&(vm.referrNameFlag=1,vm.isReferShow=1,vm.getAgentInformation=function(){var params={salerId:prodata.salesId};CommonRequest.request(params,CONFIG.CHANNEL_PERFOR_ASCRIPTION,function(result){1==result.status&&(vm.referrerCode=result.data.salerNum,vm.referrerName=result.data.name,vm.referrerOrg=result.data.managecom,vm.referrerButton=!0)})},vm.getAgentInformation()),$scope.$watch("policyContact.isCrossArea",function(newValue,oldValue){newValue!==oldValue&&(vm.netCode="")},!0),$scope.$watch("policyContact.isReferShow",function(newValue){0==newValue&&(vm.referrerCode="",vm.referrerName="",vm.showCodeList=!1,vm.referrerCodeChecked=!1)},!0),$scope.$watch("policyContact.referrerCode",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),$scope.$watch("policyContact.referrerName",function(newValue,oldValue){newValue!=oldValue&&(vm.showCodeList=!1)}),vm.errorAlert=function(key,val){if("address"==key)1==val.invalid?(vm.addressInvalid=!0,$timeout(function(){vm.addressInvalid=!1},1500)):1==val.length?(vm.addressLen=!0,$timeout(function(){vm.addressLen=!1},1500)):1==val.number?(vm.addressNum=!0,$timeout(function(){vm.addressNum=!1},1500)):1==val.addressA?(vm.addressAFlag=!0,$timeout(function(){vm.addressAFlag=!1},2e3)):1==val.addressB?(vm.addressBFlag=!0,$timeout(function(){vm.addressBFlag=!1},2e3)):1==val.addressC?(vm.addressCFlag=!0,$timeout(function(){vm.addressCFlag=!1},2e3)):1==val.addressD&&(vm.addressDFlag=!0,$timeout(function(){vm.addressDFlag=!1},2e3));else if("zipCode"==key)1==val.invalid&&(vm.zipCodeErr=!0,$timeout(function(){vm.zipCodeErr=!1},1500));else if("yearIncome"==key)1==val.invalid?(vm.yearIncomeErr=!0,$timeout(function(){vm.yearIncomeErr=!1},1500)):1==val.min&&(vm.yearIncomeMin=!0,$timeout(function(){vm.yearIncomeMin=!1},1500));else if("referrerCode"==key)1==val.invalid?(vm.referrerCodeErr=!0,$timeout(function(){vm.referrerCodeErr=!1},1500)):1==val.length&&(vm.referrerCodeLen=!0,$timeout(function(){vm.referrerCodeLen=!1},1500)),1==vm.referrNameFlag&&vm.referrerCode&&CommonRequest.request({agentNo:vm.referrerCode},CONFIG.SELECT_AgentInfo,function(res){if(1==res.status){if("C99"==res.data.agentgrade||!res.data.agentgrade)return void TipService.showMsg("推荐人填写有误，请确认");vm.referrerCodeChecked=!0,vm.referrerName=res.data.name,vm.referrerOrg=res.data.managecom,vm.showCodeList=!1}else vm.referrerCodeChecked=!0,vm.referrerName="",vm.referrerOrg="",vm.showCodeList=!1});else if("referrerName"==key){if(1==val.invalid?(vm.referrerNameErr=!0,$timeout(function(){vm.referrerNameErr=!1},1500)):1==val.length&&(vm.referrerNameLen=!0,$timeout(function(){vm.referrerNameLen=!1},1500)),vm.referrerName&&vm.referrerName.length>0){for(var len=0,i=0;i<vm.referrerName.length;i++)vm.referrerName.charCodeAt(i)>255?len+=2:len++;console.info("referrerName",len),len>3?"1"==vm.referrNameFlag&&CommonRequest.request({agentName:vm.referrerName},CONFIG.SELECT_AgentInfoByname,function(res){1==res.status&&res.data&&res.data.length?(vm.showCodeList=!0,vm.referrerCodeList=res.data):(vm.showCodeList=!1,vm.referrerCodeList=[])}):vm.showCodeList=!1}}else"atSchool"==key?1==val.invalid&&(vm.atSchoolError=!0,$timeout(function(){vm.atSchoolError=!1},1500)):"atClass"==key&&1==val.invalid&&(vm.atClassError=!0,$timeout(function(){vm.atClassError=!1},1500))},vm.hide=function(){vm.addressInvalid=!1,vm.addressLen=!1,vm.addressNum=!1,vm.zipCodeErr=!1,vm.yearIncomeErr=!1,vm.yearIncomeMin=!1,vm.referrerCodeErr=!1,vm.referrerCodeLen=!1,vm.referrerNameErr=!1,vm.referrerNameLen=!1},vm.locate=policyData.locate||"",vm.branch=policyData.branch||"",vm.address=policyData.LiRcgnAddr||"",vm.zipCode=policyData.LiRcgnPost||"",vm.livePlace=policyData.PbLivePlace||"0",vm.yearIncome=policyData.PbYearIncome||"",vm.referrerCode=policyData.referrerCode||"",vm.referrerName=policyData.referrerName||"",vm.referrerOrg=policyData.referrerOrg||"",vm.province=policyData.province||"",vm.city=policyData.city||"",vm.district=policyData.district||"",vm.provinceNet=policyData.provinceNet||{},vm.cityNet=policyData.cityNet||{},vm.districtNet=policyData.districtNet||{},vm.netCode="",vm.city&&("1"==vm.city.singletonFlag?vm.usCode=vm.city.areaCode:vm.usCode=vm.city.parentAreaCode),vm.staffId=policyData.agentCode||"",vm.staffOrgCode=policyData.BkBrchNo||"",vm.isCrossArea="1"==policyData.crossAreaFlag,vm.crossAgree=policyData.crossAgree||"",vm.allWebsite=policyData.allWebsite||"",vm.discount=policyData.discount||"",vm.hasDiscount=policyData.hasDiscount||"",vm.disActivityId=policyData.disActivityId||"",vm.configType=policyData.configType||"",vm.yearIncomeShow=!0,vm.referrerButton=!1,vm.saleNetAdress=!1,"TAC"==prodata.templateCode&&(vm.yearIncomeShow=!1),vm.getSalerName=function(salesId){var params={salerId:salesId};CommonRequest.request(params,CONFIG.GET_SALER_NAME,function(result){if(1==result.status){vm.provinceNet.netCode=vm.netPointCode1=result.data.netPointCode1,vm.cityNet.netCode=vm.netPointCode2=result.data.netPointCode2,vm.districtNet.netCode=vm.netPointCode3=result.data.netPointCode3,vm.netPointName1=result.data.netPointName1,vm.netPointName2=result.data.netPointName2,vm.netPointName3=result.data.netPointName3,vm.districtNet.netName=result.data.netPointName3;var provinceName=vm.netPointName1?vm.netPointName1:"",cityName=vm.netPointName2?"-"+vm.netPointName2:"",districtName=vm.netPointName3?"-"+vm.netPointName3:"";vm.allWebsite=provinceName+cityName+districtName}})},prodata.newSaleChnl&&prodata.salesId&&"821"==prodata.newSaleChnl?(vm.salerInfoChanged=!1,vm.getSalerName(prodata.salesId)):vm.salerInfoChanged=!0,vm.checkDiscount=function(orgCode){var params={prdId:prodata.prd_id,planId:insuredata.mainPlan.planId,channelCode:CONFIG.NEW_SALE_CHANNEL,orgCode:orgCode||""};PolicyService.getProductDiscount(params,function(result){vm.discount=result.discount,vm.disActivityId=result.disActivityId,vm.configType=result.configType,vm.hasDiscount=result.hasDiscount,sessionData.productData=result.hasDiscount})},vm.districtLevel1=function(){var params={prdId:vm.prdId};"Y"==vm.prodata.prelnsureFlag?vm.config1={url:"../statics/product/preArea/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"}:vm.config1={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"},CommonRequest.request(params,vm.config1,function(result){if(vm.provinces=result,vm.provinceList=[],vm.gudgeIsLocation){for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaName.indexOf(vm.gudgeIsLocation)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return void positionError()}else{for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaCode.indexOf(vm.provinceCode)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return}vm.districtLevel2(vm.provinceList)})},vm.districtLevel2=function(area){var config={url:"../statics/product/areas/"+vm.prdId+"/"+area[0].areaCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:area[0].areaCode,areaLevel:2};CommonRequest.request(paramsl,config,function(result){if(vm.cities=result,vm.cityList=[],vm.gudgeCity){if(vm.cityList=vm.cities,""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.cities.length;i++)-1!=vm.cities[i].areaCode.indexOf(vm.cityCode)&&vm.cityList.push(vm.cities[i]);if(""==vm.cityList)return}vm.districtLevel3(vm.provinceList,vm.cityList)})},vm.districtLevel3=function(area1,area2){var params={prdId:vm.prdId,parentAreaCode:area2[0].areaCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+area1[0].areaCode+"/"+area2[0].areaCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.areass=result,vm.districtList=[],vm.gudgeDistrict){for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaName.indexOf(vm.gudgeDistrict)&&vm.districtList.push(vm.areass[i]);if(""==vm.districtList)return void positionError();if(!vm.districtList[0].parentAreaCode)return void positionError();vm.cityListLast=[];for(var i=0;i<vm.cityList.length;i++)-1!=vm.cityList[i].areaCode.indexOf(vm.districtList[0].parentAreaCode)&&vm.cityListLast.push(vm.cityList[i]);if(vm.cityList=vm.cityListLast[0],""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaCode.indexOf(vm.districtCode)&&vm.districtList.push(vm.areass[i]);if(vm.cityList=vm.cityList[0],""==vm.districtList)return}if(vm.provinceList=vm.provinceList[0],vm.districtList=vm.districtList[0],vm.locate=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.province=vm.provinceList,vm.city=vm.cityList,vm.district=vm.districtList,vm.gudgeDistrict?vm.address=vm.dataLocation.street+vm.dataLocation.streetNumber:vm.address=vm.locationNew,vm.branch="",vm.province.areaCode){var code;code="1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code;var config={url:"../statics/product/netpoints/0/netpoint.json",method:"GET"};CommonRequest.request({},config,function(result){var provinceNetList=result;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode},config={url:"../statics/product/proxys/"+vm.district.areaCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode.substring(0,4),vm.checkDiscount(vm.staffOrgCode),vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}})},vm.queryPolicyAddress=function(){var addressParam={cusId:vm.userData.cusId,role:"1",contType:"0",queryType:"0"};CommonRequest.request(addressParam,CONFIG.QUERY_POLICY_ADDRESS,function(result){result&&"1"==result.status&&"您暂时没有保单"!=result.data&&(vm.areaNew=result.data.appProvince+result.data.appCity+result.data.appCounty,vm.locationNew=result.data.appPostalAddress,vm.provinceCode=result.data.insuredHomeProvinceCode,vm.cityCode=result.data.insuredHomeCityCode,vm.districtCode=result.data.insuredHomeAreaCode,vm.prdId=prodata.prd_id,vm.districtLevel1(vm.provinceCode))})},vm.userData.cusId){var ocrConfig={url:"../static/json/ocrSwitchBusinessOptimizer.json",method:"GET"};CommonRequest.request({},ocrConfig,function(result){vm.base64imgSwitch=result["static"],"Y"==vm.base64imgSwitch&&vm.queryPolicyAddress()})}$scope.$on("selectCityName",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code="1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code;var config={url:"../statics/product/netpoints/0/netpoint.json",method:"GET"};CommonRequest.request({},config,function(result){var provinceNetList=result;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode},config={url:"../statics/product/proxys/"+vm.district.areaCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode.substring(0,4),vm.checkDiscount(vm.staffOrgCode),vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})}}),$scope.$on("select-branch-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),$scope.$watch("policyContact.livePlace",function(newValue){"0"==newValue?vm.averageIncome&&(vm.yearIncome=vm.averageIncome):vm.averageIncomeCounty&&(vm.yearIncome=vm.averageIncomeCounty)},!0),vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){}})}),wx.error(function(res){positionError()})}})},vm.next=function(){if(vm.referrerCodeChecked||1!=vm.isReferShow)vm.operation();else var timer=$timeout(function(){vm.operation(),$timeout.cancel(timer)},800)},vm.operation=function(){if(!prodata.payType)return void TipService.showMsg("该订单没有可用的支付方式，请联系系统管理员进行维护！");if("0"==vm.isReferShow&&(vm.referrerCode="",vm.referrerName=""),vm.provinceNet&&vm.provinceNet.netName&&vm.cityNet&&vm.districtNet&&!vm.referrerButton){var provinceName=vm.provinceNet.netName?vm.provinceNet.netName:"",cityName=vm.cityNet.netName?"-"+vm.cityNet.netName:"",districtName=vm.districtNet.netName?"-"+vm.districtNet.netName:"";vm.allWebsite=provinceName+cityName+districtName}if("TAC"==prodata.templateCode&&(vm.yearIncome=5e5),vm.insureData.isWholeSale){if(vm.insureData.PbInsuExp>4*vm.yearIncome)return void TipService.showMsg("趸交保费超过投保人个人年收入的4倍")}else if(vm.insureData.PbInsuExp>vm.yearIncome/5)return void TipService.showMsg("年期交保费超过投保人个人年收入的20%");if(vm.referrerCode||"822"!=prodata.newSaleChnl||(vm.referrerCode="00000000"),vm.referrerCode&&"1"==vm.referrNameFlag){if(vm.isCrossArea)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！");if(vm.staffOrgCode!=vm.referrerOrg)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！")}PolicyService.control({state:"product-purchase-policy-contact",control:"data",data:{agentCode:vm.staffId,BkBrchNo:vm.staffOrgCode,PbHoldAddr:vm.province.areaCode+","+vm.city.areaCode,PbHoldPost:vm.zipCode,PbHoldOfficTele:"",PbHoldHomeAddr:vm.address,PbHoldHomePost:vm.zipCode,PbLivePlace:vm.livePlace,PbYearIncome:vm.yearIncome,PbWebsiteCode:vm.netCode||"",PbWebsiteName:vm.districtNet.netName||"",PbOtherProvinceCode:vm.isCrossArea?vm.province.areaCode:"",LiRcgnAddr:vm.address,LiRcgnPost:vm.zipCode,bankCodeLV1:vm.netPointCode1||vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||"",districtCode:vm.province?vm.province.areaCode:"",liveProvince:vm.province?vm.province.areaName:"",liveDistrict:vm.city?vm.city.areaName:"",allWebsite:vm.allWebsite,referrerCode:vm.referrerCode,referrerName:vm.referrerName,PlchdProvCd:vm.province.areaCode,PlchdCityCd:vm.city.areaCode,PlchdDstcCd:vm.district.areaCode,liveDstc:vm.district.areaName||"",crossAreaFlag:vm.isCrossArea?"1":"0",discount:vm.discount||1,disActivityId:vm.disActivityId||"",configType:vm.configType||"",hasDiscount:vm.hasDiscount||"0",referrerFlag:vm.referrerButton,locate:vm.locate,branch:vm.branch,crossAgree:vm.crossAgree,province:vm.province||"",city:vm.city||"",district:vm.district||"",provinceNet:vm.provinceNet||"",cityNet:vm.cityNet||"",districtNet:vm.districtNet||"",atSchool:vm.atSchool||"",atClass:vm.atClass||"",referrerOrg:vm.referrerOrg||""}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{contactInfoTime:now,orderCode:prodata.orderCode}}),PolicyService.setSessionData({productData:{prd_id:prodata.prd_id,cityCode:vm.city.areaCode}}),PolicyService.control({state:"product-purchase-policy-contact",control:"process"})},vm.addressFlagFn=function(){vm.addressFlag=!vm.addressFlag}}angular.module("app").controller("PolicyContactController",PolicyContactController),PolicyContactController.$inject=["$state","CommonRequest","CONFIG","PolicyService","$scope","$rootScope","TipService","$timeout","$filter","$ionicPopup"]}(),function(){function PolicyContactGhmbController($state,CommonRequest,CONFIG,GroupPolicyService,$scope,$rootScope,$ionicLoading,$timeout,$ionicPopup){function transOrigin(data){if(console.info(data),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){console.info(data),0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var dataLocation=result.addressComponents;vm.dataLocation=result.addressComponents,vm.gudgeIsLocation=dataLocation.province,vm.gudgeCity=dataLocation.city,vm.gudgeDistrict=dataLocation.district,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.gudgeIsLocation)}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"获取位置信息失败",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.userData=sessionData.userData,vm.insureDataList=vm.policyData.LiRcgnList||"",$rootScope.prdId=vm.productData.prd_id;var policyData;policyData=sessionData.policyData||"",console.info(sessionData),vm.locate=policyData.locate||"",vm.address=policyData.PbHoldAddress||"",vm.emailCode=policyData.PbHoldZipCode||"",vm.branch=policyData.branch||"",vm.insSaleChlType=policyData.insSaleChlType||"2",vm.referrerCode=policyData.referrerCode||"",vm.referrerName=policyData.referrerName||"",vm.province=policyData.province||"",vm.city=policyData.city||"",vm.district=policyData.district||"",vm.provinceNet=policyData.provinceNet||"",vm.cityNet=policyData.cityNet||"",vm.districtNet=policyData.districtNet||"",vm.city&&("1"==vm.city.singletonFlag?vm.usCode=vm.city.areaCode:vm.usCode=vm.city.parentAreaCode),vm.staffId=policyData.agentCode||"",vm.staffName=policyData.angentName||"",vm.staffOrgCode=policyData.BkBrchNo||"",vm.isCrossArea="1"==policyData.crossAreaFlag,vm.crossAgree=policyData.crossAgree||"",vm.allWebsite=policyData.allWebsite||"",vm.discount=policyData.discount||"",vm.hasDiscount=policyData.hasDiscount||"",vm.disActivityId=policyData.disActivityId||"",vm.configType=policyData.configType||"",vm.showInsureInfo=!1;for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].locate&&vm.insureDataList[i].LiRcgnAddress&&vm.insureDataList[i].LiRcgnZipCode&&(vm.showInsureInfo=!0);if(vm.selectCity=function(index){vm.selectCityCompent=index},vm.parentName="推荐人姓名",vm.parentNum="请输入推荐人工号",vm.parentDescName="请输入推荐人姓名",vm.parentJobNum="推荐人工号",vm.referrNameFlag=0,vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.NEW_SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data){var res=result.data.filter(function(v){return v.prdId==vm.productData.prd_id});vm.referrNameFlag=0!=res.length?1:0,console.info(vm.referrNameFlag+"是否显示：推荐人[是][否]"),"1"==vm.referrNameFlag?(vm.mastWirte="必填",vm.isReferShow=1,vm.requiredFlag=!0):vm.isReferShow=0}})},vm.isReferShow=0,vm.mastWirte="必填",vm.requiredFlag=!0,vm.changeRefer=function(){console.info("渠道"+CONFIG.NEW_SALE_CHANNEL),vm.getSaleChannelPort()},vm.changeRefer(),vm.productData.prd_id&&"827"==vm.productData.newSaleChnl&&(vm.referrNameFlag=1,vm.isReferShow=1,vm.getAgentInformation=function(){var params={salerId:prodata.salesId};CommonRequest.request(params,CONFIG.CHANNEL_PERFOR_ASCRIPTION,function(result){1==result.status&&(vm.referrerCode=result.data.salerNum,vm.referrerName=result.data.name,vm.referrerOrg=result.data.managecom,vm.referrerButton=!0)})},vm.getAgentInformation()),$scope.$on("selectAreaName",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status&&0==vm.selectCityCompent){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}}),$scope.$on("select-branch-group-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),vm.errorAlert=function(key,val){"address"==key?1==val.invalid?(vm.addressInvalid=!0,$timeout(function(){vm.addressInvalid=!1},1500)):1==val.length?(vm.addressLen=!0,$timeout(function(){vm.addressLen=!1},1500)):1==val.number&&(vm.addressNum=!0,$timeout(function(){vm.addressNum=!1},1500)):"zipCode"==key?1==val.invalid&&(vm.zipCodeErr=!0,$timeout(function(){vm.zipCodeErr=!1},1500)):"yearIncome"==key?1==val.invalid?(vm.yearIncomeErr=!0,$timeout(function(){vm.yearIncomeErr=!1},1500)):1==val.min&&(vm.yearIncomeMin=!0,$timeout(function(){vm.yearIncomeMin=!1},1500)):"referrerCode"==key?(1==val.invalid?(vm.referrerCodeErr=!0,$timeout(function(){vm.referrerCodeErr=!1},1500)):1==val.length&&(vm.referrerCodeLen=!0,$timeout(function(){vm.referrerCodeLen=!1},1500)),console.info("点击了"),1==vm.referrNameFlag&&CommonRequest.request({agentNo:vm.referrerCode},CONFIG.SELECT_AgentInfo,function(res){if(1==res.status){if("C99"==res.data.agentgrade||!res.data.agentgrade)return void TipService.showMsg("推荐人填写有误，请确认");vm.referrerOrg=res.data.managecom,vm.referrerName=res.data.name}else vm.referrerName="",vm.referrerOrg="";vm.refeFlag=!0})):"referrerName"==key?1==val.invalid?(vm.referrerNameErr=!0,$timeout(function(){vm.referrerNameErr=!1},1500)):1==val.length&&(vm.referrerNameLen=!0,$timeout(function(){vm.referrerNameLen=!1},1500)):"atSchool"==key?1==val.invalid&&(vm.atSchoolError=!0,$timeout(function(){vm.atSchoolError=!1},1500)):"atClass"==key&&1==val.invalid&&(vm.atClassError=!0,$timeout(function(){vm.atClassError=!1},1500))},vm.districtLevel1=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.provinces=result,vm.provinceList=[],vm.gudgeIsLocation){for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaName.indexOf(vm.gudgeIsLocation)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return void positionError()}else{for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaCode.indexOf(vm.provinceCode)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return}vm.districtLevel2(vm.provinceList)})},vm.districtLevel2=function(area){var config={url:"../statics/product/areas/"+vm.prdId+"/"+area[0].areaCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:area[0].areaCode,areaLevel:2};CommonRequest.request(paramsl,config,function(result){if(vm.cities=result,
vm.cityList=[],vm.gudgeCity){if(vm.cityList=vm.cities,""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.cities.length;i++)-1!=vm.cities[i].areaCode.indexOf(vm.cityCode)&&vm.cityList.push(vm.cities[i]);if(""==vm.cityList)return}vm.districtLevel3(vm.provinceList,vm.cityList)})},vm.districtLevel3=function(area1,area2){var params={prdId:vm.prdId,parentAreaCode:area2[0].areaCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+area1[0].areaCode+"/"+area2[0].areaCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.areass=result,vm.districtList=[],vm.gudgeDistrict){for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaName.indexOf(vm.gudgeDistrict)&&vm.districtList.push(vm.areass[i]);if(""==vm.districtList)return void positionError();if(!vm.districtList[0].parentAreaCode)return void positionError();vm.cityListLast=[];for(var i=0;i<vm.cityList.length;i++)-1!=vm.cityList[i].areaCode.indexOf(vm.districtList[0].parentAreaCode)&&vm.cityListLast.push(vm.cityList[i]);if(vm.cityList=vm.cityListLast[0],""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaCode.indexOf(vm.districtCode)&&vm.districtList.push(vm.areass[i]);if(vm.cityList=vm.cityList[0],""==vm.districtList)return}if(vm.provinceList=vm.provinceList[0],vm.districtList=vm.districtList[0],vm.locate=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.province=vm.provinceList,vm.city=vm.cityList,vm.district=vm.districtList,vm.gudgeDistrict?vm.address=vm.dataLocation.street+vm.dataLocation.streetNumber:vm.address=vm.locationNew,vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status&&0==vm.selectCityCompent){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}})},vm.queryPolicyAddress=function(){var addressParam={cusId:vm.userData.cusId,role:"1",contType:"0",queryType:"0"};CommonRequest.request(addressParam,CONFIG.QUERY_POLICY_ADDRESS,function(result){result&&"1"==result.status&&"您暂时没有保单"!=result.data&&(vm.areaNew=result.data.appProvince+result.data.appCity+result.data.appCounty,vm.locationNew=result.data.appPostalAddress,vm.provinceCode=result.data.insuredHomeProvinceCode,vm.cityCode=result.data.insuredHomeCityCode,vm.districtCode=result.data.insuredHomeAreaCode,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.provinceCode))})},vm.userData.cusId){var ocrConfig={url:"../statics/json/ocrSwitchBusinessOptimizer.json",method:"GET"};CommonRequest.request({},ocrConfig,function(result){vm.base64imgSwitch=result["static"],"Y"==vm.base64imgSwitch&&vm.queryPolicyAddress()})}vm.getPosition=function(){vm.selectCityCompent=0;var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){}})}),wx.error(function(res){positionError()})}})},$scope.$watch("{locate:policyContactGhmb.locate,address:policyContactGhmb.address,emailCode:policyContactGhmb.emailCode}",function(newValue,oldValue){newValue!=oldValue&&angular.forEach(newValue,function(value,key){if(""!=value)for(var i=vm.insureDataList.length-1;i>=0;i--)"address"==key&&(vm.insureDataList[i].LiRcgnAddress=value),"locate"==key&&(vm.insureDataList[i].locate=value),"emailCode"==key&&(vm.insureDataList[i].LiRcgnZipCode=value);newValue.locate&&newValue.address&&newValue.emailCode&&(vm.showInsureInfo=!0)})},!0),vm.next=function(invalid){if((vm.isReferShow="0")&&(vm.referrerCode="",vm.referrerName=""),invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(!(1!=vm.isReferShow||vm.referrerCode&&vm.referrerName))return void TipService.showMsg("请填写推荐人工号！");if(vm.referrerCode&&"1"==vm.referrNameFlag){if(vm.isCrossArea)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！");if(vm.staffOrgCode!=vm.referrerOrg)return void TipService.showMsg("推荐人归属机构与投保地区对应机构不一致，不支持投保，请联系推荐人指导填写！")}if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.provinceNet&&vm.cityNet&&vm.districtNet){var provinceName=vm.provinceNet.netName?vm.provinceNet.netName:"",cityName=vm.cityNet.netName?"-"+vm.cityNet.netName:"",districtName=vm.districtNet.netName?"-"+vm.districtNet.netName:"";vm.allWebsite=provinceName+cityName+districtName}vm.checkNetcode=function(){$timeout(function(){if(vm.provinceNet.netCode){$ionicLoading.hide();var data={agentCode:vm.staffId,angentName:vm.staffName,BkBrchNo:vm.staffOrgCode,PbHoldAddr:vm.province.areaCode+","+vm.city.areaCode,PbHoldAddress:vm.address,PbHoldZipCode:vm.emailCode,PbWebsiteCode:vm.districtNet.netCode||"",PbWebsiteName:vm.districtNet.netName||"",PbOtherProvinceCode:vm.isCrossArea?vm.province.areaCode:"",bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||"",districtCode:vm.province?vm.province.areaCode:"",liveProvince:vm.province?vm.province.areaName:"",liveDistrict:vm.city?vm.city.areaName:"",allWebsite:vm.allWebsite,referrerCode:vm.referrerCode,referrerName:vm.referrerName,PlchdProvCd:vm.province.areaCode,PlchdCityCd:vm.city.areaCode,PlchdDstcCd:vm.district.areaCode,liveDstc:vm.district.areaName||"",crossAreaFlag:vm.isCrossArea?"1":"0",locate:vm.locate,branch:vm.branch,crossAgree:vm.crossAgree,province:vm.province||"",city:vm.city||"",district:vm.district||"",provinceNet:vm.provinceNet||"",cityNet:vm.cityNet||"",districtNet:vm.districtNet||""};"Y"!=vm.productData.basicProfile.P021&&(data=angular.extend(data,{PbWebsiteCode:vm.districtNet.netCode||"",PbWebsiteName:vm.districtNet.netName||"",bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||""})),"Y"==vm.productData.basicProfile.P021&&(data=angular.extend(data,{insSaleChlType:vm.insSaleChlType})),GroupPolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),GroupPolicyService.control({state:"product-purchase-group-policy-contact",control:"data",data:data}),GroupPolicyService.control({state:"product-purchase-group-policy-contact",control:"process"})}else vm.checkNetcode()},100)},vm.checkNetcode()}}angular.module("app").controller("PolicyContactGhmbController",PolicyContactGhmbController),PolicyContactGhmbController.$inject=["$state","CommonRequest","CONFIG","GroupPolicyService","$scope","$rootScope","$ionicLoading","$timeout","$ionicPopup"]}(),function(){function PolicyInfoController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout){var vm=this;console.info($state.current.name);var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,!vm.productData||!vm.insureData)return void $state.go("tab.mall");vm.curProId=vm.productData.prd_id,vm.checkCusId=!0,vm.checkInCusld=!1,vm.calc=vm.insureData.calc?eval("("+vm.insureData.calc+")"):null,vm.calcAdd=vm.insureData.calcAdd?eval("("+vm.insureData.calcAdd+")"):null,vm.addplanFlag=!1,vm.calcCtrl=vm.insureData.calcCtrl||null,vm.userData=sessionData.userData||{},vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023?vm.policyData=sessionData.policyData||"":vm.policyData="",vm.minHolderAge=vm.insureData.minHolderAge,vm.maxHolderAge=vm.insureData.maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.minAge=vm.insureData.minAge,vm.maxAge=vm.insureData.maxAge,vm.insureStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.insureEndDate=VALIDATION.getDateByAge(vm.minAge);var sonStartDate=VALIDATION.getDateByAge("18");vm.sonStartDate=sonStartDate.getTime()+1728e5,vm.nationalities=[],vm.insureNationalities=[],vm.init=function(){if(vm.relationDisabled=!1,vm.PbInsuExp=vm.insureData.PbInsuExp,"TAC"==vm.productData.templateCode&&("A"!=vm.userData.cretType&&(vm.userData.cretType="A",vm.userData.cretNo=""),vm.nationality="0156",vm.nationalityDisabled=!0,vm.certTypeDisabled=!0),vm.userData.cretType?(vm.certType=vm.userData.cretType,vm.certTypes=COMMON.getCertTypesByCode(vm.userData.cretType)):(vm.certType=vm.policyData.PbHoldIdType||"",vm.certTypeDisabled=!1,vm.nationalityDisabled=!1,vm.certTypes=[]),vm.userData.cretNo){if(vm.certNo=vm.userData.cretNo,"A"==vm.userData.cretType){vm.certTypeDisabled=!0;var str=vm.userData.cretNo.toUpperCase().replace(/\s+/g,"");vm.certNo=str.substr(0,6)+" "+str.substr(6,8)+" "+str.substr(14,str.length),vm.certNoDisabled=!0}}else vm.certNo=vm.policyData.PbHoldId||"";if(vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=$rootScope.COMMON_DATA.NATIONALITIES,vm.insureNationalities=vm.commonNationalities,0==vm.nationalities.length&&(vm.nationalities=vm.commonNationalities),0==vm.insureNationalities.length&&(vm.insureNationalities=vm.commonNationalities),vm.commonoCcupations=$rootScope.COMMON_DATA.OCCUPATION_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations):vm.getCommonData()},200)},vm.getCommonData(),vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.userData.cretType?(vm.nationalities=COMMON.getNationalitiesByCertType(vm.userData.cretType),vm.nationality=vm.nationalities[0].value):vm.nationality=vm.policyData.PbNationality,vm.userData.customerName?(vm.name=vm.userData.customerName,vm.nameDisabled=!0):vm.name=vm.policyData.PbHoldName||"",vm.certStartDate=vm.policyData.PbIdStartDate||"",vm.certExpireType=vm.policyData.certExpireType||"2",vm.isLong="1"==vm.certExpireType,vm.gender="",vm.sexFlag=!0,$scope.$watch("policyInfo.gender",function(newValue){""!=newValue&&(vm.sexFlag=!1)}),vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender=VALIDATION.getSex(vm.certNo)+"",vm.genderDisabled=!0):vm.userData.sex?(vm.gender=vm.userData.sex+"",vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender=vm.policyData.PbHoldSex),vm.birthday="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.birthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.birthdayDisabled=!0):vm.userData.birthday&&10==vm.userData.birthday.length?(vm.birthday=new Date(vm.userData.birthday),vm.birthdayDisabled=!0):vm.policyData.PbHoldBirdy&&8==vm.policyData.PbHoldBirdy.length&&(vm.birthday=new Date(VALIDATION.dateFormat(vm.policyData.PbHoldBirdy))),vm.userData.phoneNo){var str=vm.userData.phoneNo;vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.phone=vm.policyData.PbHoldMobl||"";vm.email=vm.policyData.PbHoldEmail||"",vm.occupation=vm.policyData.PbHoldOccupCode||"C0000",vm.occupationDisable=!1,"TAC"==vm.productData.templateCode&&(vm.occupSwitch?vm.occupation="":vm.occupation="13020",vm.relationDisabled=!0),"TLD"==vm.productData.templateCode&&(vm.relationDisabled=!0),"IPAHK"==vm.productData.templateCode&&(vm.relationDisabled=!0),vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.homeTel=vm.policyData.PbHoldHomeTele||"",vm.officeAddress=vm.policyData.PbHoldAddr||"",vm.officeZipCode=vm.policyData.PbHoldPost||"",vm.officeTel=vm.policyData.PbHoldOfficTele||"",vm.isLong=!1,vm.insureIsLong=!1,vm.relation=vm.policyData.confirmRela||"01",vm.relationDisabled?vm.chlidren=!1:vm.chlidren=!0,vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"03":"03"==relation?"02":"04"==relation||"05"==relation?"1"==gender?"06":"07":"06"==relation||"07"==relation?"1"==gender?"04":"05":"01"},vm.insureName=vm.policyData.LiRcgnName||"",vm.insureNationality=vm.policyData.LiNationality||"0156",vm.insureCertType=vm.policyData.LiRcgnIdType||"",vm.insureCertTypes=[],vm.insureCertNo=vm.policyData.LiRcgnId||"",vm.insureCertExpireType=vm.policyData.insureCertExpireType||"2",vm.insureIsLong="1"==vm.insureCertExpireType,vm.insureGender=vm.policyData.LiRcgnSex||vm.insureData.sex||"1",vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureBirthday=vm.insureData.birthday||new Date,vm.insureOccupation="C0000",vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.insureBirthday=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid?(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):1==val.rr&&("certNo"==key?(vm.rr=!0,$timeout(function(){vm.rr=!1},1500)):(vm.RR=!0,$timeout(function(){vm.RR=!1},1500))):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.certType&&(vm.userData.cretType&&vm.certNo?(vm.sign=!1,vm.certTypeDisabled=!0,vm.nationalityDisabled=!0,vm.certNoDisabled=!0,"A"==vm.userData.cretType&&(vm.sign=!0,vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certNoDisabled=!0)):(vm.sign=!1,vm.certTypeDisabled=!1,vm.nationalityDisabled=!1));var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0,vm.skipCareerType=function(contrast){vm.careerType=!0,throwContrast=contrast,vm.occupationData="",vm.curData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.throwContrastData=function(){if(1==throwContrast)if("TAC"==vm.productData.templateCode){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return void TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。")}else{if("Y0000"==vm.occupationData)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");vm.occupationText=vm.curData,vm.occupation=vm.occupationData,vm.careerType=!1}else if(2==throwContrast&&("06"==vm.relation||"07"==vm.relation)){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),!1;vm.insureOccupationText=vm.curData,vm.insureOccupation=vm.occupationData,vm.careerType=!1}},vm.goNext=function(){""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode){if(1==throwContrast)if("TAC"==vm.productData.templateCode){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return void TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。")}else vm.occupationText=curData,vm.occupation=curCode,vm.searchResultDiv=!1,vm.careerType=!1;else if(2==throwContrast&&("06"==vm.relation||"07"==vm.relation)){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),!1;vm.insureOccupationText=curData,vm.insureOccupation=curCode,vm.searchResultDiv=!1,vm.careerType=!1}}},vm.watch=function(){$scope.$watch("policyInfo.nationality",function(newValue){console.info("newValue"+newValue),newValue&&(vm.userData.cretType||(vm.certTypes=COMMON.getCertTypesByNationality(newValue),vm.certType=vm.certTypes[0].value)),newValue||(vm.certType="",vm.certTypeDisabled=!0),"0156"==vm.nationality?vm.checkCusId=!0:(vm.checkCusId=!1,"01"==vm.relation?(vm.checkInCusld=!1,vm.userData.cretType&&(vm.certTypeDisabled=!0),vm.certTypeDisabled=!1):(vm.checkInCusld=!0,vm.certTypeDisabled=!1))}),$scope.$watch("policyInfo.insureNationality",function(newValue){newValue&&(vm.insureCertTypes=COMMON.getCertTypesByNationality(newValue),vm.insureCertType=vm.insureCertTypes[0].value),newValue||(vm.insureCertType=""),"0156"==vm.insureNationality?vm.checkInCusld=!0:"01"!=vm.relation&&(vm.checkInCusld=!1,vm.insureCertTypeDisabled=!1)}),$scope.$watch("policyInfo.name",function(newValue){newValue&&(vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("policyInfo.certType",function(newValue){newValue&&(vm.userData.cretNo||vm.policyData.PbHoldId||(vm.certNo=""))}),$scope.$watch("policyInfo.insureCertType",function(newValue){newValue&&(vm.insureCertNo="")}),$scope.$watch("policyInfo.certNo",function(newValue,oldValue){if(newValue){if(vm.certType&&"A"==vm.certType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.certNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.certNo=str}if(!VALIDATION.idCheck(newValue))return;vm.gender=VALIDATION.getSex(newValue)+"",vm.sex="1"==vm.gender?"男":"女",vm.genderDisabled=!0,vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.birthdayDisabled=!0}}else vm.genderDisabled=!1,vm.birthdayDisabled=!1}),$scope.$watch("policyInfo.phone",function(newValue,oldValue){if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("policyInfo.insureCertNo",function(newValue,oldValue){if(newValue){if("01"!=vm.relation&&vm.insureCertType&&"A"==vm.insureCertType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.insureCertNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.insureCertNo=str}if(!VALIDATION.idCheck(newValue))return;var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.insureGender=newGender,vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureGenderDisabled=!0,vm.insureBirthday=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.insureBirthday);18>age?vm.isStudent=!0:vm.isStudent=!1,vm.isStudent?vm.occupSwitch?vm.insureOccupation="":vm.insureOccupation="13020":vm.insureOccupation="C0000"}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),$scope.$watch("policyInfo.certExpireType",function(newValue,oldValue){1==newValue?vm.certExpireDate="2099-12-31":2==newValue&&(vm.certExpireDate=vm.policyData.PbIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.PbIdEndDate)):"")}),$scope.$watch("policyInfo.isLong",function(newValue){newValue?vm.certExpireType="1":vm.certExpireType="2"}),$scope.$watch("policyInfo.insureCertExpireType",function(newValue){1==newValue?vm.insureCertExpireDate="2099-12-31":2==newValue&&(vm.insureCertExpireDate=vm.policyData.LiIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)):"")}),$scope.$watch("policyInfo.insureIsLong",function(newValue){newValue?vm.insureCertExpireType="1":vm.insureCertExpireType="2"}),$scope.$watch("policyInfo.gender",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureGender=newValue,vm.insureSex="1"==vm.insureGender?"男":"女")}),$scope.$watch("policyInfo.insureGender",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("policyInfo.birthday",function(newValue,oldValue){if(newValue&&"01"==vm.relation){vm.insureBirthday=newValue;var aged=VALIDATION.getAgeByBirth(newValue);aged>59&&vm.insureData.loveheaPlan?vm.certType&&"A"==vm.certType?(TipService.showMsg("附加险“建信附加爱康医疗保险”年龄不可超过59周岁，请删除附加险，重新进行投保"),vm.addplanFlag=!0):vm.certType&&"A"!=vm.certType&&(TipService.showMsg("附加险“建信附加爱康医疗保险”年龄不可超过59周岁，请重新选择出生日期"),vm.insureBirthday="",vm.birthday=""):vm.addplanFlag=!1}}),$scope.$watch("policyInfo.insureBirthday",function(newValue,oldValue){"01"!=vm.relation?$filter("date")(vm.insureData.birthday)!=$filter("date")(vm.insureBirthday)&&(vm.insureBirthdayChanged=!0):$filter("date")(vm.birthday)!=$filter("date")(vm.insureData.birthday)&&(vm.insureBirthdayChanged=!0)}),$scope.$watch("policyInfo.relation",function(newValue,oldValue){newValue&&("01"==newValue?(vm.insureCertType=vm.certType,vm.insureCertTypes=vm.certTypes,vm.insureCertNo=vm.certNo,vm.insureNationality=vm.nationality,vm.insureNationalities=vm.nationalities,vm.insureName=vm.name,vm.insureCertExpireType=vm.certExpireType,vm.insureCertExpireDate=vm.certExpireDate,vm.insureGender=vm.gender,vm.insureGenderDisabled=!1,vm.insureBirthday=vm.birthday,vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.occupation):("06"==newValue?(vm.insureGender="1",vm.insureSex="1"==vm.insureGender?"男":"女"):"07"==newValue&&(vm.insureGender="2",vm.insureSex="1"==vm.insureGender?"男":"女"),vm.checkRelation(newValue,vm.gender)==vm.policyData.PbHoldRcgnRela?(vm.insureCertType=vm.policyData.LiRcgnIdType,vm.insureCertTypes=COMMON.getCertTypesByCode(vm.insureCertType),vm.insureCertNo=vm.policyData.LiRcgnId,vm.insureNationality=vm.policyData.LiNationality,vm.insureNationalities=vm.commonNationalities,vm.insureName=vm.policyData.LiRcgnName,vm.insureCertExpireType=vm.policyData.insureCertExpireType,vm.insureCertExpireDate=new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)),vm.insureGenderDisabled=!0,vm.insureBirthday=new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy)),vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.policyData.LiRcgnOccupCode):(vm.insureData&&vm.insureData.birthday&&(vm.insureBirthday=new Date(vm.insureData.birthday)||""),vm.insureCertNo="",vm.insureName="",vm.insureCertExpireType="2",vm.insureCertExpireDate=""),"06"!=vm.relation&&"07"!=vm.relation||(vm.isStudent=!0,vm.isStudent?vm.occupSwitch?vm.insureOccupation="":vm.insureOccupation="13020":vm.insureOccupation="C0000"))),"01"==vm.relation?vm.checkInCusld=!1:vm.insureNationality&&"0156"==vm.insureNationality?vm.checkInCusld=!0:vm.checkInCusld=!1}),$scope.$watch("policyInfo.occupation",function(newValue,oldValue){"Y0000"==newValue&&TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。")})},vm.showModel=function(){PolicyService.control({state:"product-purchase-policy-info",control:"data",data:{PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldBirdyDate:vm.birthday,PbHoldIdType:vm.certType,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""),PbIdStartDate:vm.certStartDate,PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbNationality:vm.nationality,PbHoldOfficTele:"",PbHoldHomeTele:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldMobl:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation||"",PbHoldOccupText:vm.occupationText||"",confirmRela:vm.relation,PbHoldRcgnRela:vm.checkRelation(vm.relation,vm.gender),LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""):"A"==vm.insureCertType?vm.insureCertNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),LiIdStartDate:"",LiIdEndDate:$filter("date")("01"==vm.relation?vm.certExpireDate:vm.insureCertExpireDate,"yyyyMMdd"),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationality,LiRcgnTele:"",LiRcgnMobl:vm.phone.toUpperCase().replace(/\s+/g,""),LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.occupation:vm.insureOccupation,LiRcgnOccupText:"01"==vm.relation?vm.occupationText:vm.insureOccupationText,BankName:vm.name,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,totalPolicyMount:vm.insureData.PbInsuExp,certExpireType:vm.certExpireType,insureCertExpireType:"01"==vm.relation?vm.certExpireType:vm.insureCertExpireType}});var now=new Date;now=$filter("date")(now,"yyyy-MM-dd HH:mm:ss"),PolicyService.setSessionData({insureData:{insureInfoTime:now}}),PolicyService.setSessionData({insureData:{PbInsuExp:vm.insureData.PbInsuExp,PbInsuAmt:vm.insureData.PbInsuAmt,mainPlan:vm.insureData.mainPlan,addPlan:vm.insureData.addPlan,birthday:vm.insureBirthday,sex:vm.insureGender}}),PolicyService.setSessionData({productData:{insureName:vm.insureName}}),PolicyService.setSessionData({userData:{tbName:vm.name}}),PolicyService.control({state:"product-purchase-policy-info",control:"process"})};var age=VALIDATION.getAgeByBirth(vm.birthday);vm.checkAge=function(){VALIDATION.getAgeByBirth(vm.birthday);if("0"!=vm.insureData.paymentType&&vm.insureData.payendyear>1){if(console.info("期交"+vm.maxHolderAge+"投保人年龄"+VALIDATION.getAgeByBirth(vm.birthday)),vm.maxHolderAge>=60){if(VALIDATION.getAgeByBirth(vm.birthday)>=60){$ionicPopup.confirm({title:"客户自主投保承诺书",template:"<div><p>1.该投保是本人真实意愿选择</p><p>2.该投保的信息填写是由本人独立自主完成</p><p>3.未经过银行代理或者第三方代理渠道的销售人员的指导下进行投保</p><p>4.未在商业银行所在的区域进行投保操作</p><p>本人承诺以上内容真实有效，并具备法律效益</p></div>",cssClass:"distingguishPopupSuccess pretDialog",buttons:[{text:"确认",type:"button-positive",onTap:function(){vm.showModel()}},{text:"取消",type:"button-positive",onTap:function(){return!1}}]});return!1}}else if(VALIDATION.getAgeByBirth(vm.birthday)>=60)return TipService.showMsg("投保人年龄应该小于"+vm.maxHolderAge+"周岁"),!1;return!0}return"0"==vm.insureData.paymentType||1==vm.insureData.payendyear?(console.info("趸交"+vm.maxHolderAge),VALIDATION.getAgeByBirth(vm.birthday)>vm.maxHolderAge?(TipService.showMsg("投保人年龄应该小于"+vm.maxHolderAge+"周岁"),!1):!0):void 0},vm.yueCheckAge=function(){var yueAge=VALIDATION.getAgeByBirth(vm.birthday);console.info(vm.maxHolderAge),vm.prdFlag="0"!=vm.insureData.paymentType&&vm.insureData.payendyear>1?60:65,vm.ageFlag=vm.maxHolderAge>=vm.prdFlag?vm.prdFlag:vm.maxHolderAge;var ageFlagInc=vm.ageFlag-1;if("0"!=vm.insureData.paymentType&&vm.insureData.payendyear<=1){if(yueAge>=vm.ageFlag||yueAge<vm.minHolderAge)return console.info("投保人"+vm.prdFlag),TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+ageFlagInc+"周岁"),!1}else if(yueAge>=vm.ageFlag||yueAge<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+ageFlagInc+"周岁"),console.info("投保人222"+vm.prdFlag),!1;return!0},vm.dataCheck=function(){var age=VALIDATION.getAgeByBirth(vm.birthday),insureAge="01"==vm.relation?age:VALIDATION.getAgeByBirth(vm.insureBirthday);return console.info(insureAge+"被保人年龄"+vm.maxAge+"被保人最大年龄"+vm.minAge),insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),
!1):vm.insureGenderChanged||vm.insureBirthdayChanged?(vm.calc&&vm.calcCtrl?("HMRA"==vm.productData.templateCode||"TLD"==vm.productData.templateCode||"BANO"==vm.productData.templateCode||"HMRB"==vm.productData.templateCode?angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,birthdayfm:$filter("date")(vm.insureBirthday,"yyyyMMdd"),payendyear:vm.insureData.payendyear}):angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,payendyear:vm.insureData.payendyear}),angular.extend(vm.calcCtrl.mainPlan,{amount:vm.insureData.mainPlan.amount}),vm.calc(vm.calcCtrl,function(recalcData){if(recalcData){if(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,recalcData.exp&&!vm.insureData.loveheaPlan&&(vm.insureData.PbInsuExp!=recalcData.exp?(vm.insureData.PbInsuExp=recalcData.exp,PolicyService.setSessionData({insureData:{PbInsuExp:vm.insureData.PbInsuExp}}),PolicyService.setSessionData({policyData:{totalPolicyMount:vm.insureData.PbInsuExp}}),TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+recalcData.exp+"</span>元")):vm.insureData.PbInsuAmt!=recalcData.mainPlan.amount?(vm.insureData.PbInsuAmt=recalcData.mainPlan.amount,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED_AMOUNT+'<span class="fs20 orange">'+recalcData.mainPlan.amount+"</span>元")):vm.next()),recalcData.amount&&(vm.insureData.PbInsuAmt=recalcData.amount),recalcData.exp&&vm.insureData.loveheaPlan){var addParams={prdCode:"BMRB",prdName:"建信附加爱康医疗保险",insurerBirthDay:$filter("date")(vm.insureBirthday,"yyyyMMdd"),insuredDays:"1",insuYearFlag:"Y",planCode:"BMRB_01",channel:CONFIG.SALE_CHANNEL,sex:vm.insureGender,paymentType:"1"==vm.calcCtrl.user.payendyear?"0":"12",PbInsuAmt:1e6,payendyear:"1",socialSecurity:vm.calcCtrl.socif};vm.calcAdd(addParams,function(addexp){recalcData.exp&&(vm.insureData.PbInsuExp=(Number(addexp)+Number(recalcData.exp)).toFixed(2));var allAmount=(Number(recalcData.mainPlan.amount)+Number("1000000")).toFixed(1),reAmount=Number(recalcData.mainPlan.amount);vm.calcCtrl.mainPlan.exp==recalcData.exp&&vm.calcCtrl.addPlan.exp==addexp||vm.insureData.PbInsuAmt!=allAmount?vm.insureData.PbInsuAmt!=allAmount?TipService.showMsg('由于您的被保人信息进行了变更，主险的基本保额变化为：<span class="fs20 orange">'+reAmount+'</span>元，保费变化为:<span class="fs20 orange">'+vm.insureData.PbInsuExp+"</span>元"):vm.next():TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+vm.insureData.PbInsuExp+"</span>元"),recalcData.mainPlan.amount&&(vm.insureData.PbInsuAmt=parseInt(recalcData.mainPlan.amount)+1e6)})}recalcData.mainPlan&&(vm.insureData.mainPlan=recalcData.mainPlan),recalcData.addPlan&&(vm.insureData.addPlan=recalcData.addPlan)}})):(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,vm.next()),!1):!0},vm.next=function(){var age=VALIDATION.getAgeByBirth(vm.birthday);console.info(age+"年龄",vm.birthday+"生日"),("811"!=CONFIG.SALE_CHANNEL||vm.checkAge())&&("812"!=CONFIG.SALE_CHANNEL||vm.checkAge())&&(console.info("不应该打印"),"BEDH"==vm.productData.prd_code?(vm.newBirthday="01"==vm.relation?vm.birthday:vm.insureBirthday,vm.newSex="01"==vm.relation?vm.gender:vm.insureGender,vm.newBirthday!=vm.insureData.birthday||vm.newSex!=vm.insureData.sex?vm.computeFun():vm.showModel()):vm.showModel())},vm.computeFun=function(){vm.askPractise=0;var askPractise=function askPractise(){if(vm.askPractise++,vm.askPractise>CONFIG.CALCEXP_DECOUPLING_TIMES)return vm.askPractise=0,TipService.showMsg($rootScope.TIPS.PRODUCT.GETEXPFROMCORE_CALCULATE_FAILED),void(vm.nextStep=!0);var checkPremiumParams={redisKey:vm.redisKey};CommonRequest.request(checkPremiumParams,CONFIG.PRODUCT_GETEXPFROMREDIS_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.redisKey)return void $timeout(function(){askPractise()},CONFIG.CALCEXP_DECOUPLING_DURATION);if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");return vm.askPractise=0,vm.insureData.mainPlan.amount=new Number(amountExp[1]).toFixed(2),vm.insureData.PbInsuAmt=new Number(amountExp[1]).toFixed(2),vm.nextStep=!1,void vm.showModel()}}})},calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:$filter("date")(vm.newBirthday,"yyyy-MM-dd"),sex:vm.newSex,PbInsuExp:vm.insureData.PbInsuExp,insuredDays:"5",insuYearFlag:"Y",planCode:"BEDH11",payendyear:vm.productData.pay_age,paymentType:vm.productData.payment_type,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1!=result.status)return void(vm.nextStep=!0);var data=result.data;if(data.redisKey)return vm.redisKey=data.redisKey,void askPractise();if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.insureData.mainPlan.amount=new Number(amountExp[1]).toFixed(2),vm.insureData.PbInsuAmt=new Number(amountExp[1]).toFixed(2),vm.nextStep=!1,vm.showModel()}})},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";if("01"==vm.relation&&"0156"==vm.nationality?(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")},PolicyService.setSessionData({userData:{customerName:vm.name}})):"01"!=vm.relation&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}),(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002){if(""==params)return void vm.next();"A"==vm.certType?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next()}else vm.next()},vm.watch(),vm.init(),vm.sex="1"==vm.gender?"男":"女",$timeout(function(){"R"!=vm.userData.cretType&&"N"!=vm.userData.cretType||(vm.nationalityDisabled=!1,vm.certTypeDisabled=!0)},0)}angular.module("app").controller("PolicyInfoController",PolicyInfoController),PolicyInfoController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout"]}(),function(){function PolicyInfoHmraController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout){var vm=this;vm.totalPolicyMount=0;var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.occupation_code=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.nationalities1=COMMON.getCommonData().NATIONALITIES,!vm.productData||!vm.insureData)return void $state.go("tab.mall");vm.curProId=vm.productData.prd_id,vm.relationChange=!1,vm.checkCusId=!0,vm.checkInCusld=!1,vm.calc=vm.insureData.calc?eval("("+vm.insureData.calc+")"):null,vm.calcCtrl=vm.insureData.calcCtrl||null,vm.userData=sessionData.userData||{},vm.productData.basicProfile?vm.policyData=sessionData.policyData||"":vm.policyData="",vm.minHolderAge=vm.insureData.minHolderAge,vm.maxHolderAge=vm.insureData.maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.HoldRcgnMedic=vm.policyData.HoldRcgnMedic||"Y",vm.minAge=vm.insureData.minAge,vm.maxAge=vm.insureData.maxAge,vm.insureStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.insureEndDate=VALIDATION.getDateByAge(vm.minAge),vm.paymentType=vm.insureData.paymentType,vm.nationalities=[],vm.insureNationalities=[],vm.init=function(){if(vm.relationDisabled=!1,vm.PbInsuExp=vm.insureData.PbInsuExp,vm.getJson=function(){var getRateList={url:"../statics/json/rate_hmra.json",method:"GET"};CommonRequest.request({},getRateList,function(result){vm.rateList=result})},vm.getJson(),vm.userData.cretType?(vm.nationality="",vm.certType=vm.userData.cretType,vm.certTypes=COMMON.getCommonData().ID_TYPES):vm.policyData.PbNationality?(vm.nationality=vm.policyData.PbNationality,vm.certType=vm.policyData.PbHoldIdType,vm.certTypes=COMMON.getCertTypesByNationality(vm.nationality)):(vm.nationality="0156",vm.certType="A",vm.certTypeDisabled=!0,vm.certTypes=COMMON.getCertTypesByNationality("0156")),vm.userData.cretNo){if(vm.certNo=vm.userData.cretNo,"A"==vm.userData.cretType){vm.certTypeDisabled=!0;var str=vm.userData.cretNo.toUpperCase().replace(/\s+/g,"");vm.certNo=str.substr(0,6)+" "+str.substr(6,8)+" "+str.substr(14,str.length),vm.certNoDisabled=!0}}else vm.certNo=vm.policyData.PbHoldId||"";if(vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=vm.nationalities1,vm.insureNationalities=vm.commonNationalities,0==vm.nationalities.length&&(vm.nationalities=vm.commonNationalities),0==vm.insureNationalities.length&&(vm.insureNationalities=vm.commonNationalities),vm.commonoCcupations=COMMON.getCommonData().OCCUPATION_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations):vm.getCommonData()},200)},vm.getCommonData(),vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.userData.cretType&&(vm.nationalities=COMMON.getNationalitiesByCertType(vm.userData.cretType)),vm.userData.customerName?(vm.name=vm.userData.customerName,vm.nameDisabled=!0):vm.name=vm.policyData.PbHoldName||"",vm.certStartDate=vm.policyData.PbIdStartDate||"",vm.certExpireType=vm.policyData.certExpireType||"2",vm.isLong="1"==vm.certExpireType,vm.insureIsLong="1"==vm.certType,vm.gender="",vm.ladyIsShow=!0,vm.manIsShow=!0,vm.btnborder=!1,vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender=VALIDATION.getSex(vm.certNo)+"",vm.genderDisabled=!0,vm.gender&&(vm.btnborder=!0),"1"==vm.gender?(vm.ladyIsShow=!1,vm.manIsShow=!0):"2"==vm.gender&&(vm.ladyIsShow=!0,vm.manIsShow=!1)):vm.userData.sex?(vm.gender=vm.userData.sex+"",vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender=vm.policyData.PbHoldSex),vm.birthday="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.birthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.birthdayDisabled=!0):vm.userData.birthday&&10==vm.userData.birthday.length?(vm.birthday=new Date(vm.userData.birthday),vm.birthdayDisabled=!0):vm.policyData.PbHoldBirdy&&8==vm.policyData.PbHoldBirdy.length&&(vm.birthday=new Date(VALIDATION.dateFormat(vm.policyData.PbHoldBirdy))),vm.userData.phoneNo){var str=vm.userData.phoneNo;vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.phone=vm.policyData.PbHoldMobl||"";vm.email=vm.policyData.PbHoldEmail||"",vm.occupation=vm.policyData.PbHoldOccupCode||"C0000",vm.policyData.LiRcgnOccupText&&(vm.occupationText=vm.policyData.LiRcgnOccupText),vm.policyData.PbHoldOccupText&&vm.policyData.LiRcgnOccupText&&(vm.occupationText=vm.policyData.PbHoldOccupText,vm.insureOccupationText=vm.policyData.LiRcgnOccupText),vm.occupationDisable=!1,"TAC"==vm.productData.templateCode&&(vm.occupation="13020",vm.relationDisabled=!0),"TLD"==vm.productData.templateCode&&(vm.relationDisabled=!0),"IPAHK"==vm.productData.templateCode&&(vm.relationDisabled=!0),vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.homeTel=vm.policyData.PbHoldHomeTele||"",vm.officeAddress=vm.policyData.PbHoldAddr||"",vm.officeZipCode=vm.policyData.PbHoldPost||"",vm.officeTel=vm.policyData.PbHoldOfficTele||"",vm.insureIsLong=!1,vm.relation=vm.policyData.confirmRela||"01",vm.relationDisabled?vm.chlidren=!1:vm.chlidren=!0,"01"==vm.relation?vm.LiRcgnMedic="":vm.LiRcgnMedic=vm.policyData.HoldRcgnMedic||"",vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"03":"03"==relation?"02":"04"==relation||"05"==relation?"1"==gender?"06":"07":"06"==relation||"07"==relation?"1"==gender?"04":"05":"01"},vm.insureName=vm.policyData.LiRcgnName||"",vm.policyData.LiNationality?(vm.insureNationality=vm.policyData.LiNationality,vm.insureCertTypes=COMMON.getCertTypesByNationality(vm.insureNationality),vm.insureCertType=vm.policyData.LiRcgnIdType):(vm.insureNationality="0156",vm.insureCertTypes=COMMON.getCertTypesByNationality(vm.insureNationality),vm.insureCertType="A"),vm.LiRcgnId=vm.policyData.LiRcgnId||"",vm.insureCertExpireType=vm.policyData.insureCertExpireType||"2",vm.insureIsLong="1"==vm.insureCertExpireType,vm.insureGender=vm.policyData.LiRcgnSex||vm.insureData.sex||"1",vm.insureSex="1"==vm.insureGender?"男":"女",vm.policyData.LiRcgnBirdy&&(vm.insureBirthday=new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy))),vm.insureOccupations=COMMON.getCommonData().OCCUPATION_CODE,vm.insureOccupation="C0000",vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.insureBirthday=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"LiRcgnId"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid?(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):1==val.rr&&("certNo"==key?(vm.rr=!0,$timeout(function(){vm.rr=!1},1500)):(vm.RR=!0,$timeout(function(){vm.RR=!1},1500))):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value;var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310)},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310);1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.certType&&(vm.userData.cretType?(vm.sign=!1,vm.certTypeDisabled=!0,vm.certNoDisabled=!0,"A"==vm.userData.cretType?(vm.sign=!0,vm.nationality="0156",vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certNoDisabled=!0):vm.nationalityDisabled=!1):(vm.sign=!1,vm.certTypeDisabled=!1,vm.nationalityDisabled=!1))};var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0,vm.skipCareerType=function(contrast){vm.careerType=!0,throwContrast=contrast,vm.occupationData="",vm.curData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.throwContrastData=function(){if(1==throwContrast)if("TAC"==vm.productData.templateCode){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData||"R0053"!=vm.occupationData)return void TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。")}else{if("Y0000"==vm.occupationData)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");vm.occupationText=vm.curData,vm.occupation=vm.occupationData,vm.careerType=!1}else if(2==throwContrast&&("06"==vm.relation||"07"==vm.relation)){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),!1;vm.insureOccupationText=vm.curData,vm.insureOccupation=vm.occupationData,vm.careerType=!1}},vm.goNext=function(){""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode){if(1==throwContrast)if("TAC"==vm.productData.templateCode){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return void TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。")}else vm.occupationText=curData,vm.occupation=curCode,vm.searchResultDiv=!1,vm.careerType=!1;else if(2==throwContrast&&("06"==vm.relation||"07"==vm.relation)){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),!1;vm.insureOccupationText=curData,vm.insureOccupation=curCode,vm.searchResultDiv=!1,vm.careerType=!1}},vm.watch=function(){$scope.$watch("PolicyInfoHmra.occupation",function(newValue,oldValue){"Y0000"==newValue&&TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。")}),$scope.$watch("PolicyInfoHmra.nationality",function(newValue,oldValue){vm.userData.cretType||(newValue&&(vm.certTypes=COMMON.getCertTypesByNationality(newValue),vm.certType=vm.certTypes[0].value),newValue||(vm.certType=""),"0156"==newValue?(vm.checkCusId=!0,vm.certTypeDisabled=!0,vm.certNo&&newValue!=oldValue&&VALIDATION.idCheck(vm.certNo)&&(vm.gender=VALIDATION.getSex(vm.certNo)+"",vm.sex="1"==vm.gender?"男":"女",vm.genderDisabled=!0,vm.birthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.birthdayDisabled=!0)):(vm.checkCusId=!1,vm.certTypeDisabled=!1))}),$scope.$watch("PolicyInfoHmra.insureNationality",function(newValue,oldValue){if(newValue&&(vm.insureCertTypes=COMMON.getCertTypesByNationality(newValue),vm.insureCertType=vm.insureCertTypes[0].value),newValue||(vm.insureCertType=""),"0156"==vm.insureNationality){if(vm.checkInCusld=!0,vm.insureCertTypeDisabled=!0,vm.LiRcgnId&&VALIDATION.idCheck(vm.LiRcgnId)&&newValue!=oldValue){var newGender=VALIDATION.getSex(vm.LiRcgnId)+"",newBirthday=new Date(VALIDATION.getBirthday(vm.LiRcgnId));vm.insureCertTypeDisabled=!0,vm.insureGender=newGender,vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureGenderDisabled=!0,vm.insureBirthday=newBirthday,vm.insureBirthdayDisabled=!0}}else"01"!=vm.relation&&(vm.checkInCusld=!1,vm.insureCertTypeDisabled=!1),newValue&&("06"==vm.relation&&(vm.insureGender="1"),"07"==vm.relation&&(vm.insureGender="2"))}),$scope.$watch("PolicyInfoHmra.name",function(newValue){newValue&&(vm.checkCusId=!0,vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("PolicyInfoHmra.certType",function(newValue){newValue&&(vm.btnborder=!1,"A"!=newValue&&(vm.ladyIsShow=!0,vm.manIsShow=!0),vm.checkCusId=!0,vm.userData.cretNo||vm.policyData.PbHoldId||(vm.certNo=""))}),$scope.$watch("PolicyInfoHmra.certNo",function(newValue,oldValue){if(newValue){if(vm.certType&&"A"==vm.certType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.certNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.certNo=str}if(!VALIDATION.idCheck(newValue))return vm.gender="",vm.birthday="",vm.ladyIsShow=!0,vm.manIsShow=!0,void(vm.btnborder=!1);vm.gender=VALIDATION.getSex(newValue)+"",vm.sex="1"==vm.gender?"男":"女",vm.genderDisabled=!0,vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.birthdayDisabled=!0,vm.gender?vm.btnborder=!0:vm.btnborder=!1,"1"==vm.gender?(vm.ladyIsShow=!1,vm.manIsShow=!0):"2"==vm.gender&&(vm.ladyIsShow=!0,vm.manIsShow=!1)}}else vm.genderDisabled=!1,vm.birthdayDisabled=!1}),$scope.$watch("PolicyInfoHmra.phone",function(newValue,oldValue){if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(vm.checkCusId=!0,!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("{birthday:PolicyInfoHmra.birthday,relation:PolicyInfoHmra.relation,insureBirthday:PolicyInfoHmra.insureBirthday,HoldRcgnMedic:PolicyInfoHmra.HoldRcgnMedic}",function(newValue,oldValue){if(newValue)if("01"==newValue.relation&&newValue.birthday&&newValue.HoldRcgnMedic){vm.mainPlan=vm.insureData.mainPlan;var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:$filter("date")(newValue.birthday,"yyyyMMdd"),sex:vm.gender,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:newValue.HoldRcgnMedic,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.premiumResult){vm.totalPolicyMount="";var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1],vm.totalPolicyMount=amountExp[0];var timeout=$timeout(function(){vm.totalPolicyMount=amountExp[0],$timeout.cancel(timeout)},100);vm.mainPlan.socialSecurity=newValue.HoldRcgnMedic}PolicyService.setSessionData({insureData:{mainPlan:vm.mainPlan,PbInsuExp:vm.mainPlan.exp}})}});var params={prdId:vm.productData.prd_id,sex:vm.gender,insurerBirthDay:$filter("date")(vm.birthday,"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.setSessionData({insureData:{birthday:vm.birthday,sex:vm.gender,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:newValue.HoldRcgnMedic}})})}else if(("06"==newValue.relation||"07"==newValue.relation)&&newValue.HoldRcgnMedic&&newValue.insureBirthday)if(VALIDATION.getAgeByBirth(newValue.insureBirthday)<18){vm.mainPlan=vm.insureData.mainPlan;var calcParams={prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,insurerBirthDay:$filter("date")(newValue.insureBirthday,"yyyyMMdd"),sex:vm.insureGender,PbInsuAmt:vm.mainPlan.amount,insuredDays:vm.mainPlan.insuYear,insuYearFlag:vm.mainPlan.insuYearFlag,planCode:vm.mainPlan.planCode,payendyear:vm.payAge,paymentType:vm.paymentType,socialSecurity:newValue.HoldRcgnMedic,channel:CONFIG.SALE_CHANNEL};CommonRequest.request(calcParams,CONFIG.PRODUCT_GETEXPFROMCORE_CALCULATE_SERVICE,function(result){if(1==result.status){var data=result.data;if(data.premiumResult){var amountExpStr=data.premiumResult,amountExp=amountExpStr.split(":");vm.mainPlan.exp=amountExp[0],vm.mainPlan.amount=amountExp[1];var timeout=$timeout(function(){vm.totalPolicyMount=amountExp[0],$timeout.cancel(timeout)},100);vm.mainPlan.socialSecurity=newValue.HoldRcgnMedic}PolicyService.setSessionData({insureData:{mainPlan:vm.mainPlan,PbInsuExp:vm.mainPlan.exp}})}});var params={prdId:vm.productData.prd_id,sex:vm.insureGender,insurerBirthDay:$filter("date")(new Date(VALIDATION.getBirthday(vm.LiRcgnId)),"yyyyMMdd"),planId:vm.mainPlan.planId,premiumResult:vm.mainPlan.exp,orderCode:vm.productData.orderCode||""};PolicyService.doCalc(params,function(){PolicyService.setSessionData({insureData:{birthday:vm.insureBirthday,sex:vm.insureGender,mainPlan:vm.mainPlan,payendyear:vm.payAge,paymentType:vm.paymentType,PbInsuAmt:vm.mainPlan.amount,PbInsuExp:vm.mainPlan.exp,pbApplNoNum:1,isWholeSale:"0"==vm.paymentType,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,oldPrice:vm.mainPlan.exp,socialSecurity:newValue.HoldRcgnMedic}})})}else vm.timer=$timeout(function(){vm.totalPolicyMount=0},100);else vm.timer=$timeout(function(){vm.totalPolicyMount=0},100)}),vm.calculate=function(isMedic,certNo){if(!VALIDATION.idCheck(certNo))return 0;var tempRateList,newBirthday=new Date(VALIDATION.getBirthday(certNo)),tempAge=VALIDATION.getAgeByBirth(newBirthday);tempRateList="Y"==isMedic?vm.rateList.data.rateList_100_Y:vm.rateList.data.rateList_100_N;for(var i=0;i<tempRateList.length;i++){var ageRange=tempRateList[i].age.split("-"),minage=parseInt(ageRange[0]),maxage=parseInt(ageRange[1]);if(tempAge>=minage&&maxage>=tempAge)return parseInt(tempRateList[i].charge)}},$scope.$watch("PolicyInfoHmra.LiRcgnId",function(newValue,oldValue){if(newValue){if("01"!=vm.relation&&vm.insureCertType&&"A"==vm.insureCertType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.LiRcgnId=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.LiRcgnId=str}var trimValue=newValue.replace(/\s/g,"");if(!VALIDATION.idCheck(newValue)||trimValue.length<18)return vm.insureBirthday="",void(vm.insureGender="");var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.insureGender=newGender,vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureGenderDisabled=!0,vm.insureBirthday=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.insureBirthday);if(18>age)vm.isStudent=!0;else if(vm.isStudent=!1,18==newValue.length)return void(vm.LiRcgnId="");vm.isStudent?vm.insureOccupation="13020":vm.insureOccupation="C0000"}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),$scope.$watch("PolicyInfoHmra.insureBirthday",function(newValue){newValue&&VALIDATION.getAgeByBirth(newValue)>=18&&"01"!=vm.relation&&(vm.insureBirthday="",$ionicPopup.alert({title:'<img src="img/common/Popupalert.png">',template:"仅支持子女18周岁之前投保",okText:"我知道了"}))}),$scope.$watch("PolicyInfoHmra.certExpireType",function(newValue,oldValue){1==newValue?vm.certExpireDate=new Date("2099-12-31"):2==newValue&&(vm.certExpireDate=vm.policyData.PbIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.PbIdEndDate)):"")}),$scope.$watch("PolicyInfoHmra.isLong",function(newValue){newValue?vm.certExpireType="1":vm.certExpireType="2"}),$scope.$watch("PolicyInfoHmra.insureCertExpireType",function(newValue){1==newValue?vm.insureCertExpireDate=new Date("2099-12-31"):2==newValue&&(vm.relationChange?vm.insureCertExpireDate="":vm.insureCertExpireDate=vm.policyData.LiIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)):"")}),$scope.$watch("PolicyInfoHmra.insureIsLong",function(newValue){newValue?vm.insureCertExpireType="1":vm.insureCertExpireType="2"}),$scope.$watch("PolicyInfoHmra.gender",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureGender=newValue,vm.insureSex="1"==vm.insureGender?"男":"女")}),$scope.$watch("PolicyInfoHmra.insureGender",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("PolicyInfoHmra.birthday",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureBirthday=newValue)}),$scope.$watch("PolicyInfoHmra.insureBirthday",function(newValue,oldValue){"01"!=vm.relation?$filter("date")(vm.insureData.birthday)!=$filter("date")(vm.insureBirthday)&&(vm.insureBirthdayChanged=!0):$filter("date")(vm.birthday)!=$filter("date")(vm.insureData.birthday)&&(vm.insureBirthdayChanged=!0)}),$scope.$watch("PolicyInfoHmra.relation",function(newValue,oldValue){if(newValue)if("01"==newValue)vm.insureCertType=vm.certType,vm.insureCertTypes=vm.certTypes,vm.insureCertNo=vm.certNo,vm.insureNationality=vm.nationality,vm.insureNationalities=vm.nationalities,vm.insureName=vm.name,vm.insureCertExpireType=vm.certExpireType,vm.insureCertExpireDate=vm.certExpireDate,vm.insureGender=vm.gender,vm.insureGenderDisabled=!1,vm.insureBirthday=vm.birthday,vm.insureBirthdayDisabled=!1,
vm.insureOccupation=vm.occupation;else{var gender;"06"==newValue&&(gender="1"),"07"==newValue&&(gender="2"),vm.checkRelation(newValue,gender)==vm.policyData.PbHoldRcgnRela&&(vm.insureCertType=vm.policyData.LiRcgnIdType,vm.insureCertTypes=COMMON.getCertTypesByCode(vm.insureCertType),vm.LiRcgnId=vm.policyData.LiRcgnId,vm.insureCertNo=vm.LiRcgnId,vm.insureNationality=vm.policyData.LiNationality,vm.insureNationalities=vm.commonNationalities,vm.insureName=vm.policyData.LiRcgnName,vm.insureCertExpireType=vm.policyData.insureCertExpireType,"1"==vm.insureCertExpireType?vm.insureIsLong=!0:"2"==vm.insureCertExpireType&&(vm.insureIsLong=!1),vm.insureCertExpireDate=new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)),vm.insureGender=vm.policyData.LiRcgnSex,vm.insureBirthday=new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy))),"06"!=vm.relation&&"07"!=vm.relation||(vm.isStudent=!0,vm.isStudent?vm.insureOccupation="13020":vm.insureOccupation="C0000")}"01"==vm.relation?vm.checkInCusld=!1:vm.insureNationality&&"0156"==vm.insureNationality?vm.checkInCusld=!0:vm.checkInCusld=!1,newValue!=oldValue&&""!=oldValue&&void 0!=oldValue&&(vm.relationChange=!0)})},vm.dataCheck=function(){var age=VALIDATION.getAgeByBirth(vm.birthday);if(age>vm.maxHolderAge||age<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+vm.maxHolderAge+"周岁"),!1;var insureAge="01"==vm.relation?age:VALIDATION.getAgeByBirth(vm.insureBirthday);return insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1):"06"==vm.relation&&"2"==vm.insureGender||"07"==vm.relation&&"1"==vm.insureGender?(TipService.showMsg("被保人与保人关系和被保人的性别不符"),!1):!0},vm.next=function(){if(vm.dataCheck()){({PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldBirdyDate:vm.birthday,PbHoldIdType:vm.certType,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""),PbIdStartDate:vm.certStartDate,PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbNationality:vm.nationality,PbHoldOfficTele:"",PbHoldHomeTele:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldMobl:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation||"",confirmRela:vm.relation,PbHoldRcgnRela:vm.checkRelation(vm.relation,vm.gender),LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:"01"==vm.relation?vm.birthday:vm.insureBirthday,LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""):"A"==vm.insureCertType?vm.LiRcgnId.toUpperCase().replace(/\s+/g,""):vm.LiRcgnId.toUpperCase().replace(/\s+/g,""),LiIdStartDate:"",LiIdEndDate:$filter("date")("01"==vm.relation?vm.certExpireDate:vm.insureCertExpireDate,"yyyyMMdd"),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationality,LiRcgnTele:"",LiRcgnMobl:vm.phone.toUpperCase().replace(/\s+/g,""),LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.occupation:vm.insureOccupation,LiRcgnOccupText:"01"==vm.relation?vm.occupationText:vm.insureOccupationText,BankName:vm.name,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,totalPolicyMount:vm.totalPolicyMount,HoldRcgnMedic:vm.HoldRcgnMedic,LiRcgnMedic:vm.HoldRcgnMedic,certExpireType:vm.certExpireType,insureCertExpireType:"01"==vm.relation?vm.certExpireType:vm.insureCertExpireType});PolicyService.setSessionData({insureData:{PbInsuExp:vm.totalPolicyMount,PbInsuAmt:vm.insureData.PbInsuAmt,mainPlan:vm.insureData.mainPlan,addPlan:vm.insureData.addPlan,birthday:vm.insureBirthday,sex:vm.insureGender}}),PolicyService.setSessionData({productData:{insureName:vm.insureName}}),PolicyService.setSessionData({userData:{tbName:vm.name}}),PolicyService.control({state:"product-purchase-policy-info-hmra",control:"data",data:{PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldBirdyDate:vm.birthday,PbHoldIdType:vm.certType,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""),PbIdStartDate:vm.certStartDate,PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbNationality:vm.nationality,PbHoldOfficTele:"",PbHoldHomeTele:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldMobl:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation||"",PbHoldOccupText:vm.occupationText||"",confirmRela:vm.relation,PbHoldRcgnRela:vm.checkRelation(vm.relation,vm.gender),LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:$filter("date")("01"==vm.relation?vm.birthday:vm.insureBirthday,"yyyyMMdd"),LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""):"A"==vm.insureCertType?vm.LiRcgnId.toUpperCase().replace(/\s+/g,""):vm.LiRcgnId.toUpperCase().replace(/\s+/g,""),LiIdStartDate:"",LiIdEndDate:$filter("date")("01"==vm.relation?vm.certExpireDate:vm.insureCertExpireDate,"yyyyMMdd"),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationality,LiRcgnTele:"",LiRcgnMobl:vm.phone.toUpperCase().replace(/\s+/g,""),LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.occupation:vm.insureOccupation,LiRcgnOccupText:"01"==vm.relation?vm.occupationText:vm.insureOccupationText,BankName:vm.name,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,totalPolicyMount:vm.totalPolicyMount,HoldRcgnMedic:vm.HoldRcgnMedic,LiRcgnMedic:vm.HoldRcgnMedic,certExpireType:vm.certExpireType,insureCertExpireType:"01"==vm.relation?vm.certExpireType:vm.insureCertExpireType}}),PolicyService.control({state:"product-purchase-policy-info-hmra",control:"process"})}},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if("Y0000"==vm.occupation&&"01"==vm.relation)return void TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。");if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";if("01"==vm.relation&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.insureCertType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.insureCertType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}),(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002){if(""==params)return void vm.next();"A"==vm.certType?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next()}else vm.next()},vm.identityDateLongClick=function(){vm.isLong=!1,$("#hmraIdentityDate").trigger("click")},vm.otherIdentityDateLongClick=function(){vm.insureIsLong=!1,$("#hmraOtherIdentityDate").trigger("click")},vm.genderChange=function(id){vm.genderDisabled||vm.gender!=id&&(vm.gender=id)},$scope.$on("$destroy",function(){vm.timer&&$timeout.cancel(vm.timer)}),vm.romoveLiPoliconData=function(){},vm.watch(),vm.init(),vm.sex="1"==vm.gender?"男":"女",vm.relationClickChange=function(id){if(vm.relation!=id){if("01"!=id){vm.insureOccupationText=vm.policyData.LiRcgnOccupText;var gender;"06"==id&&(gender="1"),"07"==id&&(gender="2"),vm.checkRelation(id,gender)!=vm.policyData.PbHoldRcgnRela&&(vm.insureName="",vm.LiRcgnMedic="",vm.LiRcgnId="",vm.insureIsLong=!1,vm.insureBirthday="",vm.insureCertNo="",vm.insureGender="",vm.insureCertExpireDate="",vm.insureOccupationText=""),"0156"!=vm.insureNationality&&(vm.insureGender=gender)}vm.relation=id}},vm.selectbyCerType=function(){vm.LiRcgnId=""},vm.getQuestionMore=function(){vm.proFotterShow=!0},vm.getQuestionMoreClose=function(){vm.proFotterShow=!1},vm.laysBzxqwhp1=!1,vm.laysBzxqwhp2=!1,$timeout(function(){"R"!=vm.userData.cretType&&"N"!=vm.userData.cretType||(vm.nationalityDisabled=!1,vm.certTypeDisabled=!0)},0)}angular.module("app").controller("PolicyInfoHmraController",PolicyInfoHmraController),PolicyInfoHmraController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout"]}(),function(){function PolicyInfoOptimzeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout,GroupPolicyService,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.isGhmbUpdate=vm.policyData.isGhmbUpdate||!1,vm.insureData&&(vm.planType=vm.insureData.planType||""),$rootScope.policyholderInfoList=!1,vm.priChecked=vm.policyData.priChecked||!1;var jobcodes=COMMON.getCommonData().OCCUPATION_CODE;if(vm.checkLiRcgnOccupCode=function(data){for(var j=0;j<jobcodes.length;j++)if(data==jobcodes[j].value)return!0},vm.priChecked)vm.showHolderMsg=1;else if($rootScope.isLogin||vm.policyData.isGhmbUpdate){vm.policyData.PbHoldBirdy&&vm.policyData.PbHoldEmail&&vm.policyData.PbHoldId&&vm.policyData.PbHoldMedic&&vm.policyData.PbHoldMobl&&vm.policyData.PbHoldName&&vm.policyData.PbHoldOccupCode&&vm.policyData.PbHoldSex&&vm.policyData.PbIdEndDate&&vm.policyData.yearIncome&&vm.policyData.livePlace?vm.checkLiRcgnOccupCode(vm.policyData.PbHoldOccupCode)?(vm.showHolderMsg=1,vm.priChecked=!0):(vm.showHolderMsg=2,PolicyService.setSessionData({policyData:{PbHoldOccupCode:""}})):vm.showHolderMsg=2;var certExpireType="2";"20991231"==vm.policyData.PbIdEndDate&&(certExpireType="1"),PolicyService.setSessionData({policyData:{certExpireType:certExpireType}})}else vm.showHolderMsg=3;vm.userData=sessionData.userData||{},$rootScope.isLogin?""==vm.userData.customerName&&""==vm.userData.cretNo||($rootScope.policyholderInfoList=!0,vm.PbHoldIdShow=!0,vm.customerName=vm.userData.customerName,vm.cretNo=vm.userData.cretNo):(vm.policyData.PbHoldName||vm.policyData.PbHoldId)&&($rootScope.policyholderInfoList=!0,vm.PbHoldIdShow=!0,vm.customerName=vm.policyData.PbHoldName,vm.cretNo=vm.policyData.PbHoldId),vm.insureDataList=vm.policyData.LiRcgnList||"",vm.canNext=!1,$scope.$watch("policyInfoOptimze.insureDataList",function(newValue){var count=0;if(vm.policyData.isGhmbUpdate){count=0;for(var i=0;i<=vm.insureDataList.length-1;i++)"2"==vm.insureDataList[i].isShowHolderMsg&&count++}else{count=0;for(var j=0;j<=vm.insureDataList.length-1;j++)vm.insureDataList[j].insureChecked&&count++}count>1?vm.canNext=!0:vm.canNext=!1}),""==vm.insureDataList&&(vm.insureDataList=[{id:1,confirmRela:"",LiNationality:"0156",LiRcgnName:"",trashShow:!1,LiRcgnMedic:"",LiRcgnIdType:"",LiRcgnId:"",LiRcgnBirdy:"",LiRcgnMobl:"",LiRcgnSex:"",LiRcgnOccupCode:"",LiRcgnExpireType:"",insureIsLong:"",LiIdEndDate:"",insureChecked:!1},{id:2,confirmRela:"",LiNationality:"0156",LiRcgnName:"",trashShow:!1,LiRcgnMedic:"",LiRcgnIdType:"",LiRcgnId:"",LiRcgnBirdy:"",LiRcgnMobl:"",LiRcgnSex:"",LiRcgnOccupCode:"",LiRcgnExpireType:"",insureIsLong:"",LiIdEndDate:"",insureChecked:!1}]),vm.checkIsGhmbUpdateList=function(){for(var i=0;i<vm.insureDataList.length;i++)vm.insureDataList[i].LiRcgnName&&vm.insureDataList[i].LiRcgnMedic&&vm.insureDataList[i].LiRcgnId&&vm.insureDataList[i].LiIdEndDate&&vm.insureDataList[i].LiRcgnBirdy&&vm.insureDataList[i].LiRcgnSex&&vm.insureDataList[i].LiRcgnMobl&&vm.insureDataList[i].LiRcgnOccupCode?vm.checkLiRcgnOccupCode(vm.insureDataList[i].LiRcgnOccupCode)?vm.insureDataList[i].isShowHolderMsg="2":(vm.insureDataList[i].LiRcgnOccupCode="",vm.insureDataList[i].isShowHolderMsg="1"):vm.insureDataList[i].isShowHolderMsg="1","20991231"==vm.insureDataList[i].LiIdEndDate?vm.insureDataList[i].LiRcgnExpireType="1":vm.insureDataList[i].LiRcgnExpireType="2";PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}})},vm.policyData.isGhmbUpdate&&vm.insureDataList&&"[object Array]"===Object.prototype.toString.call(vm.insureDataList)&&vm.checkIsGhmbUpdateList();for(var i=vm.insureDataList.length-1;i>=0;i--){var tempPolicyUser=vm.insureDataList[i];""==tempPolicyUser.confirmRela&&""==tempPolicyUser.LiRcgnMedic&&""==tempPolicyUser.LiRcgnId?tempPolicyUser.insureInfoList=!1:tempPolicyUser.insureInfoList=!0}vm.hide=function(){vm.insureAmountErr=!1},vm.jumpOptimzeRecognizee=function(LiRcgnCode){PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList,selectedInsure:LiRcgnCode}}),$state.go("product-purchase-policy-info-optimze-recognizee")},vm.getQuestionMore=function(){vm.proFotterShow=!0},vm.getQuestionMoreClose=function(){vm.proFotterShow=!1},vm.choosePlan=function(plan){vm.planType=plan,"1"==plan?(vm.planOneImg=!0,vm.planTwoImg=!1):(vm.planOneImg=!1,vm.planTwoImg=!0)},vm.priInfo={isMedic:"",securityAge:""},vm.secList=[{id:1,trashShow:!1,secIsShow:!1,securityAge:"",isMedic:"",disabled:null},{id:2,trashShow:!1,secIsShow:!1,securityAge:"",isMedic:"",disabled:null}],vm.secInfo=[{id:1,securityAge:"",isMedic:""},{id:2,securityAge:"",isMedic:""}],vm.secShow=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secIsShow=!vm.secList[i].secIsShow;break}},vm.addPic=!0,$scope.$watch("policyInfoOptimze.insureDataList.length",function(newValue){if(vm.isGhmbUpdate)vm.addPic=!1;else if(newValue>=4?vm.addPic=!1:vm.addPic=!0,newValue>2)for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].trashShow=!0;else for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].trashShow=!1},!0),vm.add=function(){var id=vm.insureDataList[vm.insureDataList.length-1].id+1;PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList,selectedInsure:id}}),$state.go("product-purchase-policy-info-optimze-recognizee")},vm.del=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList.splice(i,1),vm.secInfo.splice(i,1),3==vm.secList.length&&(vm.secList[i].secIsShow=!vm.secList[i].secIsShow);break}},vm.secMate=function(id,confirmRela){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].securityAge="";break}},vm.secMedic=function(id,medic){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].isMedic=medic,vm.secInfo[i].isMedic=medic,vm.secList[i].id==id&&"1"==medic?(vm.secmedicOneImg=!0,vm.secmedicTwoImg=!1):(vm.secmedicTwoImg=!0,vm.secmedicOneImg=!1);break}},$scope.$watch("policyInfoOptimze.planType",function(newValue){if(vm.planType=newValue,PolicyService.setSessionData({insureData:{planType:vm.planType}}),""!=newValue){if(!vm.priChecked)return;vm.submitAccount111(newValue)}else vm.totalInsCvr=0},!0),vm.newTotalInsCvr=0,vm.submitAccount111=function(planType){if(vm.newTotalInsCvr=0,vm.policyHolderAmount=vm.calculateFee(vm.policyData.PbHoldMedic,vm.policyData.PbHoldId,planType),vm.newTotalInsCvr=vm.newTotalInsCvr+parseInt(vm.policyHolderAmount),vm.policyData.LiRcgnList)for(var i=vm.policyData.LiRcgnList.length-1;i>=0;i--){var policyUser=vm.policyData.LiRcgnList[i];vm.policyData.LiRcgnList[i].insureAmount=vm.calculateFee(policyUser.LiRcgnMedic,policyUser.LiRcgnId,planType),vm.newTotalInsCvr=vm.newTotalInsCvr+parseInt(vm.policyData.LiRcgnList[i].insureAmount)}},vm.calculateFee=function(isMedic,certNo,planType){if(!VALIDATION.idCheck(certNo))return 0;var tempRateList,newBirthday=new Date(VALIDATION.getBirthday(certNo)),tempAge=VALIDATION.getAgeByBirth(newBirthday);tempRateList=vm.getRateList(planType,isMedic);for(var i=0;i<tempRateList.length;i++){var ageRange=tempRateList[i].age.split("-"),minage=parseInt(ageRange[0]),maxage=parseInt(ageRange[1]);if(tempAge>=minage&&maxage>=tempAge)return parseInt(tempRateList[i].charge)}},vm.getRateList=function(planType,isMedic){return"1"==planType&&"1"==isMedic?vm.insureData.rateList.data.rateList_50_Y:"1"==planType&&"2"==isMedic?vm.insureData.rateList.data.rateList_50_N:"2"==planType&&"1"==isMedic?vm.insureData.rateList.data.rateList_100_Y:"2"==planType&&"2"==isMedic?vm.insureData.rateList.data.rateList_100_N:void 0},vm.jumpToHolderPage=function(){$state.go("product-purchase-policy-info-optimze-policyholder")},vm.dataCheck=function(){var age=VALIDATION.getAgeByBirth(vm.birthday);if(age>vm.maxHolderAge||age<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+vm.maxHolderAge+"周岁"),!1;var insureAge="01"==vm.confirmRela?age:VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);return insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1):vm.insureGenderChanged||vm.insureBirthdayChanged?(vm.calc&&vm.calcCtrl?("HMRA"==vm.productData.templateCode||"TLD"==vm.productData.templateCode||"BANO"==vm.productData.templateCode?angular.extend(vm.calcCtrl.user,{sex:vm.LiRcgnSex,birthday:vm.LiRcgnBirdy,birthdayfm:$filter("date")(vm.LiRcgnBirdy,"yyyyMMdd"),payendyear:vm.insureData.payendyear}):angular.extend(vm.calcCtrl.user,{sex:vm.LiRcgnSex,birthday:vm.LiRcgnBirdy,payendyear:vm.insureData.payendyear}),angular.extend(vm.calcCtrl.mainPlan,{amount:vm.insureData.mainPlan.amount}),vm.calc(vm.calcCtrl,function(recalcData){recalcData&&(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,recalcData.exp&&(vm.insureData.PbInsuExp!=recalcData.exp?(vm.insureData.PbInsuExp=recalcData.exp,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+recalcData.exp+"</span>元")):vm.insureData.PbInsuAmt!=recalcData.mainPlan.amount?(vm.insureData.PbInsuAmt=recalcData.mainPlan.amount,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED_AMOUNT+'<span class="fs20 orange">'+recalcData.mainPlan.amount+"</span>元")):vm.next()),recalcData.amount&&(vm.insureData.PbInsuAmt=recalcData.amount),recalcData.mainPlan&&(vm.insureData.mainPlan=recalcData.mainPlan),recalcData.addPlan&&(vm.insureData.addPlan=recalcData.addPlan))})):(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,vm.next()),!1):!0},vm.getPremiumRateGroupCoreResultTimes=0,vm.getPremiumRateGroupCoreResult=function(flowNo,callback){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremiumRateGroupCoreResultTimes++,vm.getPremiumRateGroupCoreResultTimes>CONFIG.GROUP_CORE_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg("系统繁忙,请稍后重试"),void(vm.getPremiumRateGroupCoreResultTimes=0);var params={flowNo4Trial:flowNo};CommonRequest.request(params,CONFIG.GHMB_GET_PREMIUM_RATE_GROUP_CORE_RESULT,function(result){if(1==result.status){var data=result.data||"";if(""==data)return void $timeout(function(){vm.getPremiumRateGroupCoreResult(flowNo,callback)},CONFIG.GROUP_CORE_DECOUPLING_DURATION);if($ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0,"00000"!=data.respCode)return void TipService.showMsg(data.respDesc);var orderCode=data.orderCode;orderCode&&GroupPolicyService.setSessionData({productData:{orderCode:orderCode}}),GroupPolicyService.setSessionData({policyData:{totalPolicyMount:data.totalInsCvr}});for(var i=0;i<data.rcgnList.length;i++)for(var j=0;j<vm.secList.length;j++)"0"==data.rcgnList[i].rcgnNm?vm.insCvr=data.rcgnList[i].insPrem:data.rcgnList[i].rcgnNm==vm.secList[j].id&&(vm.secList[j].insCvr=data.rcgnList[i].insPrem);vm.totalInsCvr=data.totalInsCvr,vm.nextStep=!0,callback()}else $ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0},!0)};var params,insuredCalcList=[],plans=[];vm.submitAccount=function(callback){plans=1==vm.planType?vm.productData.plans[0]:vm.productData.plans[1],insuredCalcList=[{rcgnNm:"0",rcgnBrthDt:vm.policyData.PbHoldBirdy,insuredSSflag:vm.policyData.PbHoldMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]}];for(var i=0;i<vm.insureDataList.length;i++)vm.insureDataList[i].insureChecked&&insuredCalcList.push({rcgnNm:vm.insureDataList[i].id.toString(),rcgnBrthDt:vm.insureDataList[i].LiRcgnBirdy,insuredSSflag:vm.insureDataList[i].LiRcgnMedic,insuredAppntRela:vm.insureDataList[i].confirmRela,cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]});params=vm.isGhmbUpdate?{premiumAppEntity:{plchdBrthDt:vm.policyData.PbHoldBirdy,appntSsflag:"1",plchdNm:"Y",insuredNum:insuredCalcList.length,insuredList:insuredCalcList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL}:{premiumAppEntity:{plchdBrthDt:vm.policyData.PbHoldBirdy,appntSsflag:"1",insuredNum:insuredCalcList.length,insuredList:insuredCalcList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL},CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(result.data,callback)})},vm.next=function(){if(vm.dataCheck()){for(var insureCompleteNumber=0,i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked&&insureCompleteNumber++}if(vm.insureDataList.length<2){vm.insureAmountErr||(vm.insureAmountErr=!0);var timer=$timeout(function(){vm.insureAmountErr&&(vm.insureAmountErr=!1),$timeout.cancel(timer)},3e3)}else{if(2>insureCompleteNumber)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(!vm.priChecked)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.insureDataList.length<2)return void(vm.insureAmountErr=!0);vm.choosePlanObj="",vm.plansGhmb=[{benefitId:null,dutys:[],insuYear:"1",insuYearFlag:"Y",insuredAmount:"1000",maxBuyQautity:"0",minBuyQautity:"1",normalPrice:"0",planCode:"GHMB511",planId:"10108",planName:"计划一（50万）",planType:"1"},{benefitId:null,dutys:[],insuYear:"1",insuYearFlag:"Y",insuredAmount:"1000",maxBuyQautity:"0",minBuyQautity:"1",normalPrice:"0",planCode:"GHMB611",planId:"10109",planName:"计划二（100万）",planType:"2"}];for(var plans=vm.plansGhmb,i=plans.length-1;i>=0;i--)plans[i].planType==vm.planType&&(vm.choosePlanObj=plans[i]);for(var i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked||vm.insureDataList.splice(i,1)}PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),PolicyService.setSessionData({insureData:{plans:vm.choosePlanObj}}),vm.insuredList=[{rcgnNm:0,rcgnBrthDt:vm.policyData.PbHoldBirdy,insuredSSflag:vm.policyData.PbHoldMedic,insuredAppntRela:vm.policyData.PbHoldRcgnRela,cvrNum:"1",busiList:[{cvrID:vm.choosePlanObj.planCode,insCps:"1",insCvr:vm.choosePlanObj.insuredAmount,insScmInf:vm.choosePlanObj.planCode,mainAndAdlInsInd:"1"}]}],PolicyService.setSessionData({policyData:{totalInsCvr:vm.totalInsCvr,PbHoldDistrict:"0",PbHoldExpireType:vm.policyData.certExpireType}});for(var i=vm.insureDataList.length-1;i>=0;i--){var tempinsure={rcgnNm:vm.insureDataList[i].id,rcgnBrthDt:vm.insureDataList[i].LiRcgnBirdy,insuredSSflag:vm.insureDataList[i].LiRcgnMedic,insuredAppntRela:vm.insureDataList[i].confirmRela,rcgnNatCd:"0156",rcgnCommAdr:"",rcgnZipECD:"",cvrNum:"1",busiList:[{cvrID:vm.choosePlanObj.planCode,insCps:"1",insCvr:vm.choosePlanObj.insuredAmount,insScmInf:vm.choosePlanObj.planCode,mainAndAdlInsInd:"1"}]};vm.insuredList.push(tempinsure)}PolicyService.setSessionData({insureData:{insuredList:vm.insuredList}}),$state.go("product-purchase-policy-ghmb-contact")}}},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if(vm.priChecked){vm.insCompleNum=0;for(var i=vm.insureDataList.length-1;i>=0;i--){var insureUser=vm.insureDataList[i];insureUser.insureChecked&&vm.insCompleNum++}vm.insCompleNum<2||vm.submitAccount(function(){if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";"01"==vm.confirmRela&&"0156"==vm.nationality?(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")},PolicyService.setSessionData({userData:{customerName:vm.name}})):"01"!=vm.confirmRela&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}:"01"!=vm.confirmRela&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.LiRcgnIdType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.LiRcgnName}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}:"01"!=vm.confirmRela&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.LiRcgnIdType,cretNo:vm.LiRcgnId.replace(/\s+/g,""),name:vm.LiRcgnName}],mobileNo:vm.LiRcgnMobl.replace(/\s+/g,"")}),(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next()})}}}angular.module("app").controller("PolicyInfoOptimzeController",PolicyInfoOptimzeController),PolicyInfoOptimzeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout","GroupPolicyService","$ionicLoading"]}(),function(){function PolicyInfoOptimzePolicyholderController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout){function getIndex(arr,str){for(var index=-1,i=0;i<arr.length;i++)arr[i].value===str&&(index=i);return index}var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",vm.isGhmbUpdate=vm.policyData.isGhmbUpdate||!1,vm.certType="A",vm.PbHoldMedic=vm.policyData.PbHoldMedic||"",vm.livePlace=vm.policyData.livePlace||"",vm.yearIncome=vm.policyData.yearIncome||"",vm.yearIncomeShow=!0,vm.checkCusId=!0,vm.checkInCusld=!1,vm.calc=vm.insureData.calc?eval("("+vm.insureData.calc+")"):null,vm.calcCtrl=vm.insureData.calcCtrl||null,vm.userData=sessionData.userData||{},vm.minHolderAge=vm.insureData.minHolderAge,vm.maxHolderAge=vm.insureData.maxHolderAge,vm.holderStartDate=VALIDATION.getDateByAge(vm.maxHolderAge),vm.holderEndDate=VALIDATION.getDateByAge(vm.minHolderAge),vm.minAge=vm.insureData.minAge,vm.maxAge=vm.insureData.maxAge,vm.insureStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.insureEndDate=VALIDATION.getDateByAge(vm.minAge),vm.init=function(){if(vm.relationDisabled=!1,vm.PbInsuExp=vm.insureData.PbInsuExp,vm.nationality="0156",vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certType="A",vm.certTypeDisabled=!1,vm.nationalityDisabled=!1,vm.certTypes=[],vm.userData.cretNo){if("A"==vm.userData.cretType){vm.certNo=vm.userData.cretNo,vm.certTypeDisabled=!0;var str=vm.userData.cretNo.toUpperCase().replace(/\s+/g,"");vm.certNo=str.substr(0,6)+" "+str.substr(6,8)+" "+str.substr(14,str.length),vm.certNoDisabled=!0}}else vm.certNo=vm.policyData.PbHoldId||"";if(vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=COMMON.getCommonData().NATIONALITIES,vm.nationalities=vm.insureNationalities=vm.commonNationalities,vm.commonoCcupations=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations,vm.commonoCcupations=vm.commonoCcupations.map(function(val){return val})):vm.getCommonData()},200)},vm.getCommonData(),vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.userData.cretType?(vm.nationalities=COMMON.getNationalitiesByCertType(vm.userData.cretType),vm.nationality=vm.nationalities[0].value):vm.nationality=vm.policyData.PbNationality,vm.userData.customerName?(vm.name=vm.userData.customerName,vm.nameDisabled=!0):vm.name=vm.policyData.PbHoldName||"",vm.certStartDate=vm.policyData.PbIdStartDate||"",vm.gender="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender=VALIDATION.getSex(vm.certNo)+"",vm.genderDisabled=!0):vm.userData.sex?(vm.gender=vm.userData.sex+"",vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender=vm.policyData.PbHoldSex),vm.birthday="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.birthday=new Date(VALIDATION.getBirthday(vm.certNo)),vm.birthdayDisabled=!0):vm.userData.birthday&&10==vm.userData.birthday.length?(vm.birthday=new Date(vm.userData.birthday),vm.birthdayDisabled=!0):vm.policyData.PbHoldBirdy&&8==vm.policyData.PbHoldBirdy.length&&(vm.birthday=new Date(VALIDATION.dateFormat(vm.policyData.PbHoldBirdy))),vm.userData.phoneNo){var str=vm.userData.phoneNo;vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.phone=vm.policyData.PbHoldMobl||"";vm.email=vm.policyData.PbHoldEmail||"",vm.occupation=vm.policyData.PbHoldOccupCode||"C0000",vm.occupationText=vm.policyData.PbHoldOccupText||"",vm.occupationDisable=!1,"TAC"==vm.productData.templateCode&&(vm.occupation="13020",vm.relationDisabled=!0),"TLD"==vm.productData.templateCode&&(vm.relationDisabled=!0),"IPAHK"==vm.productData.templateCode&&(vm.relationDisabled=!0),vm.address=vm.policyData.PbHoldHomeAddr||"",vm.zipCode=vm.policyData.PbHoldHomePost||"",vm.homeTel=vm.policyData.PbHoldHomeTele||"",vm.officeAddress=vm.policyData.PbHoldAddr||"",vm.officeZipCode=vm.policyData.PbHoldPost||"",vm.officeTel=vm.policyData.PbHoldOfficTele||"",vm.isLong=!1,vm.insureIsLong=!1,vm.certExpireType=vm.policyData.certExpireType||"2",vm.isLong="1"==vm.certExpireType,vm.relation=vm.policyData.confirmRela||"01",vm.relationDisabled?vm.chlidren=!1:vm.chlidren=!0,
vm.checkRelation=function(relation,gender){return"01"==relation?"01":"02"==relation?"03":"03"==relation?"02":"04"==relation||"05"==relation?"1"==gender?"06":"07":"06"==relation||"07"==relation?"1"==gender?"04":"05":"01"},vm.insureName=vm.policyData.LiRcgnName||"",vm.insureNationality=vm.policyData.LiNationality||"0156",vm.insureCertType=vm.policyData.LiRcgnIdType||"",vm.insureCertTypes=[],vm.insureCertNo=vm.policyData.LiRcgnId||"",vm.insureCertExpireType=vm.policyData.insureCertExpireType||"2",vm.insureIsLong="1"==vm.insureCertExpireType,vm.insureGender=vm.policyData.LiRcgnSex||vm.insureData.sex||"1",vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureBirthday=vm.insureData.birthday||new Date,vm.insureOccupation="C0000",vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.insureBirthday=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value;var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310)},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){var timer=$timeout(function(){vm.emailListShow=!1,$timeout.cancel(timer)},310);1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.certType&&(vm.userData.cretType?(vm.sign=!1,vm.certTypeDisabled=!0,vm.nationalityDisabled=!0,"A"==vm.userData.cretType?(vm.sign=!0,vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certNoDisabled=!0):vm.certNoDisabled=!1):(vm.sign=!1,vm.certTypeDisabled=!1,vm.nationalityDisabled=!1));var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0;var insure_id="";vm.skipCareerType=function(contrast,id){vm.careerType=!0,throwContrast=contrast,insure_id=id,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.throwContrastData=function(){if(console.info(vm.careerType),console.info(),1==throwContrast){if(vm.occupationText=vm.curData,vm.occupation=vm.occupationData,"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("投保人职业为拒保职业，请选择其他职业类型")}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].occupation=vm.occupationData),vm.careerType=!1}vm.careerType=!1,console.info(vm.careerType),console.info(throwContrast)},vm.goNext=function(){console.info(vm.curData),""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode){if(1==throwContrast)vm.occupationText=curData,vm.occupation=curCode,vm.careerType=!1;else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].occupation=curCode),vm.careerType=!1}}},vm.watch=function(){$scope.$watch("policyInfoOptimzePolicyholder.occupation",function(newValue,oldValue){}),$scope.$watch("policyInfoOptimzePolicyholder.nationality",function(newValue){vm.certTypes=COMMON.getCertTypesByNationality("0156"),vm.certType="A"}),$scope.$watch("policyInfoOptimzePolicyholder.name",function(newValue){newValue&&(vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("policyInfoOptimzePolicyholder.certNo",function(newValue,oldValue){if(newValue){if(vm.certType&&"A"==vm.certType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.certNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.certNo=str}if(!VALIDATION.idCheck(newValue))return vm.gender="",void(vm.birthday="");vm.gender=VALIDATION.getSex(newValue)+"",vm.sex="1"==vm.gender?"男":"女",vm.genderDisabled=!0,vm.birthday=new Date(VALIDATION.getBirthday(newValue)),vm.birthdayDisabled=!0}}else vm.genderDisabled=!1,vm.birthdayDisabled=!1}),$scope.$watch("policyInfoOptimzePolicyholder.phone",function(newValue,oldValue){if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("policyInfoOptimzePolicyholder.insureCertNo",function(newValue,oldValue){if(newValue){if("01"!=vm.relation&&vm.insureCertType&&"A"==vm.insureCertType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.insureCertNo=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.insureCertNo=str}if(!VALIDATION.idCheck(newValue))return;var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.insureGender=newGender,vm.insureSex="1"==vm.insureGender?"男":"女",vm.insureGenderDisabled=!0,vm.insureBirthday=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.insureBirthday);18>age?vm.isStudent=!0:vm.isStudent=!1,vm.isStudent?vm.insureOccupation="13020":vm.insureOccupation="C0000"}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),$scope.$watch("policyInfoOptimzePolicyholder.certExpireType",function(newValue,oldValue){1==newValue?vm.certExpireDate=new Date("2099-12-31"):2==newValue&&(vm.certExpireDate=vm.policyData.PbIdEndDate?new Date(VALIDATION.dateFormat(vm.policyData.PbIdEndDate)):"")}),$scope.$watch("policyInfoOptimzePolicyholder.isLong",function(newValue){newValue?vm.certExpireType="1":vm.certExpireType="2"}),$scope.$watch("policyInfoOptimzePolicyholder.gender",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureGender=newValue,vm.insureSex="1"==vm.insureGender?"男":"女")}),$scope.$watch("policyInfoOptimzePolicyholder.insureGender",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("policyInfoOptimzePolicyholder.birthday",function(newValue,oldValue){newValue&&newValue!=oldValue&&"01"==vm.relation&&(vm.insureBirthday=newValue)}),$scope.$watch("policyInfoOptimzePolicyholder.insureBirthday",function(newValue,oldValue){"01"!=vm.relation?$filter("date")(vm.insureData.birthday)!=$filter("date")(vm.insureBirthday)&&(vm.insureBirthdayChanged=!0):$filter("date")(vm.birthday)!=$filter("date")(vm.insureData.birthday)&&(vm.insureBirthdayChanged=!0)}),$scope.$watch("policyInfoOptimzePolicyholder.relation",function(newValue,oldValue){newValue&&("01"==newValue?(vm.insureCertType=vm.certType,vm.insureCertTypes=vm.certTypes,vm.insureCertNo=vm.certNo,vm.insureNationality=vm.nationality,vm.insureNationalities=vm.nationalities,vm.insureName=vm.name,vm.insureCertExpireType=vm.certExpireType,vm.insureCertExpireDate=vm.certExpireDate,vm.insureGender=vm.gender,vm.insureGenderDisabled=!1,vm.insureBirthday=vm.birthday,vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.occupation):("06"==newValue?(vm.insureGender="1",vm.insureSex="1"==vm.insureGender?"男":"女"):"07"==newValue&&(vm.insureGender="2",vm.insureSex="1"==vm.insureGender?"男":"女"),vm.checkRelation(newValue,vm.gender)==vm.policyData.PbHoldRcgnRela?(vm.insureCertType=vm.policyData.LiRcgnIdType,vm.insureCertTypes=COMMON.getCertTypesByCode(vm.insureCertType),vm.insureCertNo=vm.policyData.LiRcgnId,vm.insureNationality=vm.policyData.LiNationality,vm.insureNationalities=vm.commonNationalities,vm.insureName=vm.policyData.LiRcgnName,vm.insureCertExpireType=vm.policyData.insureCertExpireType,vm.insureCertExpireDate=new Date(VALIDATION.dateFormat(vm.policyData.LiIdEndDate)),vm.insureGenderDisabled=!0,vm.insureBirthday=new Date(VALIDATION.dateFormat(vm.policyData.LiRcgnBirdy)),vm.insureBirthdayDisabled=!1,vm.insureOccupation=vm.policyData.LiRcgnOccupCode):(vm.insureData&&vm.insureData.birthday&&(vm.insureBirthday=new Date(vm.insureData.birthday)||""),vm.insureCertNo="",vm.insureName="",vm.insureCertExpireType="2",vm.insureCertExpireDate=""),"06"!=vm.relation&&"07"!=vm.relation||(vm.isStudent=!0,vm.isStudent?vm.insureOccupation="13020":vm.insureOccupation="C0000"))),"01"==vm.relation?vm.checkInCusld=!1:vm.insureNationality&&"0156"==vm.insureNationality?vm.checkInCusld=!0:vm.checkInCusld=!1})},vm.dataCheck=function(){if("Y0000"==vm.occupation)return TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。"),!1;var age=VALIDATION.getAgeByBirth(vm.birthday);if(age>vm.maxHolderAge||age<vm.minHolderAge)return TipService.showMsg("投保人年龄应该在"+vm.minHolderAge+"-"+vm.maxHolderAge+"周岁"),!1;var insureAge="01"==vm.relation?age:VALIDATION.getAgeByBirth(vm.insureBirthday);return insureAge>vm.maxAge||insureAge<vm.minAge?(TipService.showMsg("被投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1):vm.insureGenderChanged||vm.insureBirthdayChanged?(vm.calc&&vm.calcCtrl?("HMRA"==vm.productData.templateCode||"TLD"==vm.productData.templateCode||"BANO"==vm.productData.templateCode?angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,birthdayfm:$filter("date")(vm.insureBirthday,"yyyyMMdd"),payendyear:vm.insureData.payendyear}):angular.extend(vm.calcCtrl.user,{sex:vm.insureGender,birthday:vm.insureBirthday,payendyear:vm.insureData.payendyear}),angular.extend(vm.calcCtrl.mainPlan,{amount:vm.insureData.mainPlan.amount}),vm.calc(vm.calcCtrl,function(recalcData){recalcData&&(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,recalcData.exp&&(vm.insureData.PbInsuExp!=recalcData.exp?(vm.insureData.PbInsuExp=recalcData.exp,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+recalcData.exp+"</span>元")):vm.insureData.PbInsuAmt!=recalcData.mainPlan.amount?(vm.insureData.PbInsuAmt=recalcData.mainPlan.amount,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED_AMOUNT+'<span class="fs20 orange">'+recalcData.mainPlan.amount+"</span>元")):vm.next()),recalcData.amount&&(vm.insureData.PbInsuAmt=recalcData.amount),recalcData.mainPlan&&(vm.insureData.mainPlan=recalcData.mainPlan),recalcData.addPlan&&(vm.insureData.addPlan=recalcData.addPlan))})):(vm.insureGenderChanged=!1,vm.insureBirthdayChanged=!1,vm.next()),!1):!0},vm.next=function(){vm.dataCheck()&&(PolicyService.control({state:"product-purchase-policy-info",control:"data",data:{PbHoldName:vm.name,PbHoldSex:vm.gender,PbHoldBirdy:$filter("date")(vm.birthday,"yyyyMMdd"),PbHoldBirdyDate:$filter("date")(vm.birthday,"yyyy-MM-dd"),PbHoldIdType:vm.certType,PbHoldAmount:vm.yearIncome,PbHoldId:"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""),PbIdStartDate:vm.certStartDate,PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbNationality:"0156",PbHoldOfficTele:"",PbHoldHomeTele:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldMobl:vm.phone.toUpperCase().replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation||"",PbHoldOccupText:vm.occupationText,confirmRela:vm.relation,PbHoldRcgnRela:vm.checkRelation(vm.relation,vm.gender),LiRcgnName:"01"==vm.relation?vm.name:vm.insureName,LiRcgnSex:"01"==vm.relation?vm.gender:vm.insureGender,LiRcgnBirdy:$filter("date")(vm.insureBirthday,"yyyyMMdd"),LiRcgnIdType:"01"==vm.relation?vm.certType:vm.insureCertType,LiRcgnId:"01"==vm.relation?"A"==vm.certType?vm.certNo.toUpperCase().replace(/\s+/g,""):vm.certNo.toUpperCase().replace(/\s+/g,""):"A"==vm.insureCertType?vm.insureCertNo.toUpperCase().replace(/\s+/g,""):vm.insureCertNo.toUpperCase().replace(/\s+/g,""),LiIdStartDate:"",LiIdEndDate:$filter("date")("01"==vm.relation?vm.certExpireDate:vm.insureCertExpireDate,"yyyyMMdd"),LiNationality:"01"==vm.relation?vm.nationality:vm.insureNationality,LiRcgnTele:"",LiRcgnMobl:vm.phone.toUpperCase().replace(/\s+/g,""),LiRcgnEmail:vm.email,LiRcgnOccupCode:"01"==vm.relation?vm.occupation:vm.insureOccupation,BankName:vm.name,minAge:vm.minAge,maxAge:vm.maxAge,minHolderAge:vm.minHolderAge,maxHolderAge:vm.maxHolderAge,certExpireType:vm.certExpireType,insureCertExpireType:"01"==vm.relation?vm.certExpireType:vm.insureCertExpireType,PbHoldMedic:vm.PbHoldMedic||"",livePlace:vm.livePlace||"",yearIncome:vm.yearIncome||"",priChecked:!0}}),PolicyService.setSessionData({insureData:{PbInsuExp:vm.insureData.PbInsuExp,PbInsuAmt:vm.insureData.PbInsuAmt,mainPlan:vm.insureData.mainPlan,addPlan:vm.insureData.addPlan,birthday:vm.insureBirthday,sex:vm.insureGender}}),PolicyService.setSessionData({productData:{insureName:vm.insureName}}),PolicyService.setSessionData({userData:{tbName:vm.name}}),PolicyService.control({state:$state.current.name,control:"process"}))},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if("Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("投保人职业为拒保职业，请选择其他职业类型");if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params={};vm.nationality||(vm.nationality="0156"),"01"==vm.relation&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"!=vm.insureNationality&&"0156"==vm.nationality?params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"!=vm.nationality?params={cusInfoList:[{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}:"01"!=vm.relation&&"0156"==vm.insureNationality&&"0156"==vm.nationality&&(params={cusInfoList:[{insureType:vm.certType,cretNo:vm.certNo.replace(/\s+/g,""),name:vm.name},{insureType:vm.insureCertType,cretNo:vm.insureCertNo.replace(/\s+/g,""),name:vm.insureName}],mobileNo:vm.phone.replace(/\s+/g,"")}),vm.checkCusId&&vm.checkInCusld&&"Y"==vm.productData.basicProfile.P002?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next(),""!=vm.policyData.PbHoldName&&"undefined"!=vm.policyData.PbHoldName||""!=vm.policyData.PbHoldMedic&&"undefined"!=vm.policyData.PbHoldMedic||""!=vm.policyData.PbHoldId&&"undefined"!=vm.policyData.PbHoldId?$rootScope.policyholderInfoList=!0:$rootScope.policyholderInfoList=!1},vm.changeDataType=function(){vm.isLong=!vm.isLong,vm.isLong?vm.certExpireType="1":vm.certExpireType="2"},vm.longInputClick=function(){vm.isLong=!1,$("#policyholderIdentityDate").trigger("click")},$scope.$on("occupationCallback",function(event,result){}),vm.watch(),vm.init(),vm.sex="1"==vm.gender?"男":"女"}angular.module("app").controller("PolicyInfoOptimzePolicyholderController",PolicyInfoOptimzePolicyholderController),PolicyInfoOptimzePolicyholderController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout"]}(),function(){function PolicyInfoOptimzeRecognizeeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,$document,PolicyService,CommonRequest,$ionicPopup,$timeout,$log){var vm=this,sessionData=PolicyService.getSessionData();vm.productData=sessionData.productData,vm.policyData=sessionData.policyData,vm.insureDataList=sessionData.policyData.LiRcgnList,vm.isGhmbUpdate=vm.policyData.isGhmbUpdate||!1,vm.selectedInsure=sessionData.policyData.selectedInsure,vm.policyUser="";for(var i=vm.insureDataList.length-1;i>=0;i--)vm.insureDataList[i].id==vm.selectedInsure&&(vm.policyUser=vm.insureDataList[i]);if(vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.commonNationalities=COMMON.getCommonData().NATIONALITIES,vm.nationalities=vm.insureNationalities=vm.commonNationalities,vm.commonoCcupations=COMMON.getCommonData().OCCUPATION_CODE,vm.occupations=vm.insureOccupations=vm.commonoCcupations):vm.getCommonData()},200)},vm.getCommonData(),vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.insureNationality="0156",vm.LiRcgnName=vm.policyUser.LiRcgnName||"",vm.insureCertTypes=COMMON.getCertTypesByNationality("0156"),vm.LiRcgnIdType=vm.insureCertTypes[0].value||"A",vm.LiRcgnId=vm.policyUser.LiRcgnId||"",vm.certStartDate=vm.policyUser.LiIdEndDate||"",vm.LiRcgnExpireType=vm.policyUser.LiRcgnExpireType||"2",vm.insureIsLong="1"==vm.LiRcgnExpireType,"2"==vm.LiRcgnExpireType&&(vm.insureCertExpireDate=vm.policyUser.LiIdEndDate?new Date(VALIDATION.dateFormat(vm.policyUser.LiIdEndDate)):""),vm.LiRcgnSex="",vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType&&vm.LiRcgnId?(vm.LiRcgnSex=VALIDATION.getSex(vm.LiRcgnId)+"",vm.genderDisabled=!0):vm.policyUser.LiRcgnSex?(vm.LiRcgnSex=vm.policyUser.LiRcgnSex+"",vm.genderDisabled=!0):vm.policyUser.policyUser&&(vm.LiRcgnSex=vm.policyUser.LiRcgnSex),vm.LiRcgnBirdy="",vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType&&vm.LiRcgnId?(vm.LiRcgnBirdy=new Date(VALIDATION.getBirthday(vm.LiRcgnId)),vm.birthdayDisabled=!0):vm.policyUser.LiRcgnBirdy&&10==vm.policyUser.LiRcgnBirdy.length?(vm.LiRcgnBirdy=new Date(vm.policyUser.LiRcgnBirdy),vm.birthdayDisabled=!0):vm.policyUser.LiRcgnBirdy&&8==vm.policyUser.LiRcgnBirdy.length&&(vm.LiRcgnBirdy=new Date(VALIDATION.dateFormat(vm.policyUser.LiRcgnBirdy))),vm.policyUser.LiRcgnMobl){var str=vm.policyUser.LiRcgnMobl;vm.LiRcgnPhone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.LiRcgnMobl=vm.policyUser.LiRcgnMobl||"";if(vm.selectPhone=!0,vm.email=vm.policyUser.email||"",vm.isGhmbUpdate){var age=VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);18>age?vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_CHILD_CODE:vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.LiRcgnOccupCode=vm.policyUser.LiRcgnOccupCode||"",vm.LiRcgnOccupText=vm.policyUser.LiRcgnOccupText||""}else vm.OccupCodeList=COMMON.getCommonData().OCCUPATION_NOCHILD_CODE,vm.LiRcgnOccupCode=vm.policyUser.LiRcgnOccupCode||"C0000",vm.LiRcgnOccupText=vm.policyUser.LiRcgnOccupText||"";vm.occupations=COMMON.getCommonData().OCCUPATION_CODE,vm.occupationDisable=!1,vm.confirmRela=vm.policyUser.confirmRela||"",vm.LiRcgnMedic=vm.policyUser.LiRcgnMedic||"",vm.isLong=!1,vm.trashShow=vm.policyUser.trashShow,vm.checkRelation=function(confirmRela,gender){return"01"==confirmRela?"01":"02"==confirmRela?"03":"03"==confirmRela?"02":"04"==confirmRela||"05"==confirmRela?"1"==gender?"06":"07":"06"==confirmRela||"07"==confirmRela?"1"==gender?"04":"05":"01"},vm.minStart=vm.minStartDate=new Date((new Date).getTime()+864e5),vm.certExpireDateCallback=function(val){val&&(vm.certExpireDate=val)},vm.insureCertExpireDateCallback=function(val){val&&(vm.insureCertExpireDate=val)},vm.birthdayCallback=function(val){val&&(vm.birthday=val)},vm.insureBirthdayCallback=function(val){val&&(vm.LiRcgnBirdy=val)},vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"LiRcgnId"==key||"LiRcgnId"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"LiRcgnMobl"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"LiRcgnName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key&&1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}};var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0;var insure_id="";vm.skipCareerType=function(contrast,id){vm.careerType=!0,throwContrast=contrast,insure_id=id,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.LiRcgnOccupCode};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.agecheck=function(birthday){if(birthday){var b=new Date(birthday),d=new Date,age=d.getFullYear()-b.getFullYear()-(d.getMonth()<b.getMonth()||d.getMonth()==b.getMonth()&&d.getDate()<b.getDate()?1:0);return $log.info(age),age}return!1},vm.throwContrastData=function(){if(1==throwContrast){if(vm.LiRcgnOccupText=vm.curData,vm.LiRcgnOccupCode=vm.occupationData,"Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}vm.careerType=!1}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].LiRcgnOccupCode=vm.occupationData),vm.careerType=!1}vm.careerType=!1,console.info(vm.careerType),console.info(throwContrast)},vm.goNext=function(){console.info("vm.curData"+vm.curData),""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode,pg){if("03"==pg)vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode,vm.careerType=!1;else if(1==throwContrast){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.LiRcgnOccupText=curData,vm.LiRcgnOccupCode=curCode,vm.careerType=!1}else if(2==throwContrast)for(var i=0;i<vm.secList.length;i++){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age)return $log.info("年龄"+age),void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。");return vm.careerType=!0,!1}vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].LiRcgnOccupCode=curCode),vm.careerType=!1}},vm.watch=function(){$scope.$watch("policyInfoOptimzeRecognizee.name",function(newValue){newValue&&(vm.newGetAccountName=newValue,vm.authAccountName=newValue,vm.bonusBankAccountName=newValue,vm.liBonusBankAccountName=newValue,vm.renewalBankAccountName=newValue,"0156"==vm.nationality&&(vm.checkCusId=!0))}),$scope.$watch("policyInfoOptimzeRecognizee.LiRcgnPhone",function(newValue,oldValue){
if(newValue){if(11==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.LiRcgnPhone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}if(!VALIDATION.phoneCheck(newValue))return}else vm.phoneDisabled=!1}),$scope.$watch("policyInfoOptimzeRecognizee.LiRcgnId",function(newValue,oldValue){if(newValue){if("01"!=vm.confirmRela&&vm.LiRcgnIdType&&"A"==vm.LiRcgnIdType){if(15==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.LiRcgnId=str}if(18==newValue.length){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.LiRcgnId=str}if(!VALIDATION.idCheck(newValue))return vm.LiRcgnSex="",void(vm.LiRcgnBirdy="");var newGender=VALIDATION.getSex(newValue)+"",newBirthday=new Date(VALIDATION.getBirthday(newValue));vm.insureCertTypeDisabled=!0,vm.LiRcgnSex=newGender,vm.insureSex="1"==vm.LiRcgnSex?"男":"女",vm.insureGenderDisabled=!0,vm.LiRcgnBirdy=newBirthday,vm.insureBirthdayDisabled=!0;var age=VALIDATION.getAgeByBirth(vm.LiRcgnBirdy);18>age?(vm.isStudent=!0,vm.selectPhone=!1):(vm.isStudent=!1,vm.selectPhone=!0),vm.isStudent?vm.isGhmbUpdate||(vm.LiRcgnOccupCode="13020"):vm.isGhmbUpdate||"13020"==vm.LiRcgnOccupCode&&(vm.LiRcgnOccupCode="C0000")}}else vm.insureGenderDisabled=!1,vm.insureBirthdayDisabled=!1}),$scope.$watch("policyInfoOptimzeRecognizee.LiRcgnExpireType",function(newValue,oldValue){1==newValue?vm.insureCertExpireDate=new Date("2099-12-31"):1==oldValue&&(vm.insureCertExpireDate="")}),$scope.$watch("policyInfoOptimzeRecognizee.insureIsLong",function(newValue){newValue?vm.LiRcgnExpireType="1":vm.LiRcgnExpireType="2"}),$scope.$watch("policyInfoOptimzeRecognizee.LiRcgnSex",function(newValue,oldValue){newValue!=oldValue&&(vm.insureGenderChanged=!0)}),$scope.$watch("policyInfoOptimzeRecognizee.confirmRela",function(newValue,oldValue){"03"==newValue&&(vm.selectPhone=!0),"06"!=newValue&&"07"!=newValue||(vm.selectPhone=!1)}),vm.del=function(){for(var id=vm.policyUser.id,i=0;i<vm.insureDataList.length;i++)if(vm.insureDataList[i].id==id){vm.insureDataList.splice(i,1);break}PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),$state.go("product-purchase-policy-info-optimze")},$scope.$watch("policyInfoOptimzeRecognizee.LiRcgnOccupCode",function(newValue,oldValue){})},vm.next=function(){if("Y0000"==vm.LiRcgnOccupCode)return void TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。");var tempPhone="";if(vm.LiRcgnPhone&&(tempPhone=vm.LiRcgnPhone.toUpperCase().replace(/\s+/g,"")),vm.submitData={id:vm.selectedInsure,confirmRela:vm.confirmRela,LiRcgnName:vm.LiRcgnName,LiRcgnMedic:vm.LiRcgnMedic,LiRcgnIdType:vm.LiRcgnIdType,LiRcgnId:"A"==vm.LiRcgnIdType?vm.LiRcgnId.toUpperCase().replace(/\s+/g,""):vm.LiRcgnId.toUpperCase().replace(/\s+/g,""),LiRcgnBirdy:$filter("date")(vm.LiRcgnBirdy,"yyyyMMdd"),LiRcgnMobl:tempPhone,LiRcgnSex:vm.LiRcgnSex,LiRcgnOccupCode:vm.LiRcgnOccupCode,LiRcgnOccupText:vm.LiRcgnOccupText,LiRcgnExpireType:vm.LiRcgnExpireType,insureIsLong:vm.insureIsLong,LiIdEndDate:$filter("date")(vm.insureCertExpireDate,"yyyyMMdd"),insureChecked:!0,LiNationality:"0156"},vm.selectedInsure>vm.insureDataList.length)vm.insureDataList[vm.selectedInsure-1]=vm.submitData,vm.policyData.locate&&(vm.insureDataList[vm.selectedInsure-1].locate=vm.policyData.locate,vm.insureDataList[vm.selectedInsure-1].LiRcgnZipCode=vm.policyData.PbHoldZipCode,vm.insureDataList[vm.selectedInsure-1].LiRcgnAddress=vm.policyData.PbHoldAddress);else for(var i=vm.insureDataList.length-1;i>=0;i--)if(vm.insureDataList[i].id==vm.selectedInsure){var oldVal=JSON.parse(JSON.stringify(vm.insureDataList[i]));vm.insureDataList[i]=vm.submitData,oldVal.locate&&(vm.insureDataList[i].locate=oldVal.locate,vm.insureDataList[i].LiRcgnZipCode=oldVal.LiRcgnZipCode,vm.insureDataList[i].LiRcgnAddress=oldVal.LiRcgnAddress);break}PolicyService.setSessionData({policyData:{LiRcgnList:vm.insureDataList}}),$state.go("product-purchase-policy-info-optimze")},vm.checkCretNo=function(invalid){if(invalid)return void TipService.showMsg($rootScope.TIPS.COMMON.REQUIRED);if("Y0000"==vm.occupationData||"R0047"==vm.occupationData||"R0022"==vm.occupationData)return void TipService.showMsg("被保险人职业为拒保职业，请选择其他职业类型或更换被保险人");if(("06"==vm.confirmRela||"07"==vm.confirmRela)&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData){var age=vm.agecheck(vm.LiRcgnBirdy);if(age>=16&&23>=age);else if(16>age&&($log.info("年龄"+age),$log.info(vm.LiRcgnOccupCode),"学生"!=vm.LiRcgnOccupText&&"学龄前儿童"!=vm.LiRcgnOccupText))return void TipService.showMsg("被保人的职业只能为学生或者学龄前儿童。")}if("Y0000"==vm.LiRcgnOccupCode)return void TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。");if("06"==vm.confirmRela&&"2"==vm.LiRcgnSex||"07"==vm.confirmRela&&"1"==vm.LiRcgnSex)return void TipService.showMsg("投被保人关系与被保险人的性别不符，请重新填写！");if(""!=vm.policyData.PbHoldSex&&void 0!=vm.policyData.PbHoldSex&&"03"==vm.confirmRela&&("1"==vm.policyData.PbHoldSex&&"1"==vm.LiRcgnSex||"2"==vm.policyData.PbHoldSex&&"2"==vm.LiRcgnSex))return void TipService.showMsg($rootScope.TIPS.PRODUCT.MATE_SEX_ERROR);if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var params="";(vm.checkCusId||vm.checkInCusld)&&"Y"==vm.productData.basicProfile.P002?CommonRequest.request(params,CONFIG.CHECK_CUSIDENTITY_SERVICE,function(result){"1"==result.status&&("1"==result.data.checkStatus?(vm.checkCusId=!1,vm.checkInCusId=!1,vm.next()):TipService.showMsg(result.data.checkDescription))}):vm.next()},vm.watch(),vm.identityDateLongClick=function(){vm.insureIsLong=!1,$("#recognizeeIdentityDate").trigger("click")},console.info(vm)}angular.module("app").controller("PolicyInfoOptimzeRecognizeeController",PolicyInfoOptimzeRecognizeeController),PolicyInfoOptimzeRecognizeeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","$document","PolicyService","CommonRequest","$ionicPopup","$timeout","$log"]}(),function(){function PolicyIpamaController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,PolicyService,CommonRequest,$ionicPopup,$timeout){var vm=this,sessionData=PolicyService.getSessionData();window.history.forward(1),vm.districtCode="620102",vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.certType="A",vm.nationality="0156",vm.relation="01",vm.insureCertNo="",vm.provinceCode="620000",vm.cityCode="620100",vm.zipCode="730030",vm.insureOccupation="A0000",vm.address="DEFAULT",vm.livePlace="0",vm.districtNetCode="620400001",vm.districtNetName="营业部秦安路营业室",vm.provinceNetCode="620000",vm.cityNetCode="620014",vm.provinceAreaName="甘肃省",vm.cityAreaName="兰州市",vm.allWebsite="甘肃分行-甘肃省分行营业部-营业部秦安路营业室",vm.districtAreaName="城关区",vm.disputeHanding="1",vm.renteDrawMode="1",vm.PbInsuExp1="",vm.PbInsuExp2="",vm.bonusGetMode="2",vm.disputeGroupName="",vm.combineCheck="10",vm.isBatts="0",vm.PbInsuYearFlag="2",vm.certExpireType="2",vm.insureCertExpireType="2",vm.healthTag="",vm.materials=vm.productData.materials,vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params)}},vm.dataCheck=function(){return"0"!=vm.healthTag?(TipService.showMsg($rootScope.TIPS.PRODUCT.HEALTHY_INVALID),!1):!0},vm.updateUser=function(){var params={cerId:vm.insureCertNo};CommonRequest.request(params,CONFIG.UPDATE_CUS_UNION_STATE_IPAMA_SERVICE,function(result){})},vm.queryData=function(invalid){if(!invalid){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"是否确定为此身份证号："+vm.insureCertNo+" ？",okText:"确定",cancelText:"取消"});alertPopup.then(function(res){if(res){var params={cerId:vm.insureCertNo};CommonRequest.request(params,CONFIG.QUERY_IPAMACUS_SERVCIE,function(result){result.status&&"1"==result.status&&(vm.PbHoldData=result.data,vm.cerName=vm.PbHoldData.cerName,vm.unionCode=vm.PbHoldData.unionCode,vm.email=vm.PbHoldData.email);var nowDay=$filter("date")(new Date,"yyyyMMdd");vm.indate=nowDay-$filter("date")(vm.PbHoldData.expirationDate,"yyyyMMdd")<0?$filter("date")(vm.PbHoldData.expirationDate,"yyyyMMdd"):"20991231"})}})}},vm.getStaffId=function(){var params={areaCode:vm.districtCode},config={url:"../statics/product/proxys/"+vm.districtCode+".json",method:"GET"};CommonRequest.request(params,config,function(result){var data=result;vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.BkBrchNo=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)})},vm.getStaffId(),vm.checkPolicy=function(){$timeout(function(){if(vm.PbApplNo){var doCheck=function(params,index){$timeout(function(){PolicyService.setSessionData({policyData:policyData}),PolicyService.checkPolicy(policyData,"single",function(itemOrderRealPayAmt){vm.updateUser();var data={itemOrderRealPayAmt:itemOrderRealPayAmt||0};PolicyService.setSessionData({policyData:data}),vm.holdPolicyWithIpamaToken({orderCode:vm.productData.orderCode,cardToken:vm.productData.token},function(){$state.go("product-pay-success",{orderCode:vm.productData.orderCode,payResult:"2"})})})},500*index)},policyData=vm.getPolicyData();if(!policyData)return;if(angular.isArray(policyData)&&policyData.length>0)for(var i=0;i<policyData.length;i++)doCheck(policyData[i],i);else doCheck(policyData,0)}else vm.checkPolicy()},500)},vm.gainInsure=function(callback){if(vm.productData&&vm.productData.orderCode)return void(angular.isFunction(callback)&&callback());var params={insurerBirthDay:VALIDATION.getBirthday(vm.insureCertNo),orderCode:"",planId:vm.insureData.mainPlan.planId,prdId:vm.productData.prd_id,premiumResult:"0",sex:VALIDATION.getSex(vm.insureCertNo)};CommonRequest.request(params,CONFIG.PREMIUM_RESULT_SERVICE,function(result){PolicyService.setSessionData({productData:{orderCode:result.data.orderCode}}),sessionData=PolicyService.getSessionData(),vm.productData=sessionData.productData,angular.isFunction(callback)&&callback()})},vm.submit=function(){vm.dataCheck()&&vm.insureCertNo&&vm.gainInsure(function(){PolicyService.createPbApplNo(vm.BkBrchNo,function(pbApplNoList){vm.PbApplNo=pbApplNoList,vm.againInsure(vm.insureCertNo,function(){vm.checkPolicy()})})})},vm.againInsure=function(insureCertNo,callback){var params={cerId:insureCertNo};CommonRequest.request(params,CONFIG.QUERY_IPAMACUS_SERVCIE,function(result){result.data&&angular.isFunction(callback)&&callback()})},vm.holdPolicyWithIpamaToken=function(params,callback){CommonRequest.request(params,CONFIG.HOLD_POLICY_WITH_TOKEN_IPAMA_SERVICE,function(result){var data=result.data,bkOthRetMsg="";data&&(bkOthRetMsg=data.bkOthRetMsg),1==result.status?(TipService.showMsg("承保成功！","success"),angular.isFunction(callback)&&callback()):TipService.showMsg(bkOthRetMsg)})},vm.getPolicyData=function(){var _params2,params=(_params2={orderCode:vm.productData.orderCode,PbBenfNum:"0",PbInsuType:vm.productData.prd_code,PbInsuName:vm.productData.prd_title,mainAndAdlInsInd:"1",PbSlipNumb:1,PbInsuExp:vm.insureData.mainPlan.exp,PbInsuAmt:vm.insureData.mainPlan.amount,PbMainInsuExp:0,PbInsuExpAppd:0,PbSendMode:"2",PbBeginDate:vm.insureData.PbBeginDate,LiSpec:"",LiExpireInsuDrawMode:"",LiPayOffTag:"",LiHealthTag:vm.healthTag,PbPayPeriod:vm.insureData.paymentType,PbPayAgeTag:vm.insureData.payendyear||"1",PbInsuYearFlag:vm.PbInsuYearFlag,LiInsuPeriod:vm.insureData.mainPlan.insuYear,PbInsuYear:0,PbPayAge:0,PbDrawAgeTag:"",PbDrawAge:0,LiImpawnTag:vm.LiImpawnTag||"",BkNum1:vm.BkNum1||0,AppdList:vm.AppdList||[],BkNum2:0,PbApplNo:vm.PbApplNo||"",BkVchNo:"",LiInsuSlipPWD:"",PiTrfVchNo:"",BkRckrNo:"",PiZxbe20:0,BkAreaNo:"",PiManBankNo:"",insScmInf:vm.insureData.mainPlan.planCode,SellTypeDetail:CONFIG.SALE_CHANNEL,PbInsuExp1:vm.PbInsuExp1,PbInsuExp2:vm.PbInsuExp2,allInsuExp:vm.insureData.PbInsuExp,materials:vm.materials,dutys:vm.insureData.mainPlan.dutys,prdId:vm.productData.prd_id,planId:vm.insureData.mainPlan.planId,PbHoldName:vm.PbHoldData.cerName,PbHoldSex:VALIDATION.getSex(vm.insureCertNo),PbHoldBirdy:$filter("date")(VALIDATION.getBirthday(vm.insureCertNo),"yyyyMMdd"),PbHoldIdType:vm.certType,PbHoldId:vm.insureCertNo,PbIdStartDate:"",PbIdEndDate:vm.indate,PbNationality:vm.nationality,PbHoldOfficTele:vm.PbHoldData.phone,PbHoldHomeTele:vm.PbHoldData.phone,PbHoldMobl:vm.PbHoldData.phone,PbHoldEmail:vm.email||"DEFAULT",PbHoldOccupCode:vm.insureOccupation||"",confirmRela:vm.relation,PbHoldRcgnRela:vm.relation,LiRcgnName:vm.PbHoldData.cerName,LiRcgnSex:VALIDATION.getSex(vm.insureCertNo),LiRcgnBirdy:$filter("date")(VALIDATION.getBirthday(vm.insureCertNo),"yyyyMMdd"),LiRcgnIdType:vm.certType,LiRcgnId:vm.insureCertNo,LiIdStartDate:"",LiIdEndDate:vm.indate,LiNationality:vm.nationality,LiRcgnTele:vm.PbHoldData.phone,LiRcgnMobl:vm.PbHoldData.phone,LiRcgnEmail:vm.email||"DEFAULT",LiRcgnOccupCode:vm.insureOccupation||"",BankName:vm.PbHoldData.cerName,minAge:vm.productData.minAge,maxAge:vm.productData.maxAge,minHolderAge:vm.productData.minHolderAge,maxHolderAge:vm.productData.maxHolderAge,certExpireType:vm.certExpireType,insureCertExpireType:vm.insureCertExpireType,agentCode:vm.staffId,BkBrchNo:vm.BkBrchNo,PbHoldAddr:vm.provinceCode+","+vm.cityCode,PbHoldPost:vm.zipCode},_defineProperty(_params2,"PbHoldOfficTele",vm.PbHoldData.phone),_defineProperty(_params2,"PbHoldHomeAddr",vm.address),_defineProperty(_params2,"PbHoldHomePost",vm.zipCode),_defineProperty(_params2,"PbLivePlace",vm.livePlace),_defineProperty(_params2,"PbYearIncome",vm.averageIncome),_defineProperty(_params2,"PbWebsiteCode",vm.districtNetCode||""),_defineProperty(_params2,"PbWebsiteName",vm.districtNetName||""),_defineProperty(_params2,"PbOtherProvinceCode",vm.provinceCode),_defineProperty(_params2,"LiRcgnAddr",vm.address),_defineProperty(_params2,"LiRcgnPost",vm.zipCode),_defineProperty(_params2,"bankCodeLV1",vm.provinceNetCode||""),_defineProperty(_params2,"bankCodeLV2",vm.cityNetCode||""),_defineProperty(_params2,"bankCodeLV3",vm.districtNetCode||""),_defineProperty(_params2,"districtCode",vm.provinceCode),_defineProperty(_params2,"liveProvince",vm.provinceAreaName),_defineProperty(_params2,"liveDistrict",vm.cityAreaName),_defineProperty(_params2,"allWebsite",vm.allWebsite),_defineProperty(_params2,"referrerCode",vm.referrerCode||""),_defineProperty(_params2,"referrerName",vm.referrerName||""),_defineProperty(_params2,"PlchdProvCd",vm.provinceCode),_defineProperty(_params2,"PlchdCityCd",vm.cityCode),_defineProperty(_params2,"PlchdDstcCd",vm.districtCode),_defineProperty(_params2,"liveDstc",vm.districtAreaName||""),_defineProperty(_params2,"crossAreaFlag",vm.isCrossArea?"1":"0"),_defineProperty(_params2,"discount",vm.discount||1),_defineProperty(_params2,"disActivityId",vm.disActivityId||""),_defineProperty(_params2,"configType",vm.configType||""),_defineProperty(_params2,"hasDiscount",vm.hasDiscount||"0"),_defineProperty(_params2,"PbInsuPayMode",vm.renewalBankAccount&&vm.renewalBank?"0":""),_defineProperty(_params2,"LiSpec",""),_defineProperty(_params2,"LiExpireInsuDrawMode","0"),_defineProperty(_params2,"LiRenteDrawMode",vm.renteDrawMode),_defineProperty(_params2,"AnutyPcsgMtdCd",vm.renteDrawMode),_defineProperty(_params2,"PbAutoPayTag","0"),_defineProperty(_params2,"LiBonusDistbTag",""),_defineProperty(_params2,"LiBonusGetMode",vm.bonusGetMode),_defineProperty(_params2,"PiZyzcfs",vm.disputeHanding),_defineProperty(_params2,"PiZcinst",vm.disputeGroupName),_defineProperty(_params2,"BkAcctNo3",vm.renewalBankAccount||""),_defineProperty(_params2,"BankCode",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankCode:""),_defineProperty(_params2,"BankName",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBankAccountName:""),_defineProperty(_params2,"renewalBankName",vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankName:""),_defineProperty(_params2,"SpecFlag",vm.combineCheck),_defineProperty(_params2,"NewPayMode",vm.newGetBk&&vm.newGetAccount?vm.newPayMode:""),_defineProperty(_params2,"NewGetAccName",vm.newGetBk&&vm.newGetAccount?vm.newGetAccountName:""),_defineProperty(_params2,"NewGetBkCode",vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankCode:""),_defineProperty(_params2,"NewGetAccCode",vm.newGetAccount||""),_defineProperty(_params2,"newGetBkName",vm.newGetBk&&vm.newGetAccount?vm.newGetBk.bankName:""),_defineProperty(_params2,"benfSetType","1"),_defineProperty(_params2,"isBatts",vm.isBatts),_defineProperty(_params2,"bonusBankCode",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankCode:""),_defineProperty(_params2,"bonusBankName",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBank.bankName:""),_defineProperty(_params2,"bonusBankAccountName",vm.bonusBank&&vm.bonusBankAccount?vm.bonusBankAccountName:""),_defineProperty(_params2,"bonusBankAccount",vm.bonusBankAccount||""),_defineProperty(_params2,"liBonusBankCode",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankCode:""),_defineProperty(_params2,"LiBonusBankName",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBank.bankName:""),_defineProperty(_params2,"liBonusBankAccountName",vm.liBonusBank&&vm.liBonusBankAccount?vm.liBonusBankAccountName:""),_defineProperty(_params2,"liBonusBankAccount",vm.liBonusBankAccount||""),_defineProperty(_params2,"payBankCode",vm.authBank&&vm.authBankAccount?vm.authBank.bankCode:""),_defineProperty(_params2,"authBankName",vm.authBank&&vm.authBankAccount?vm.authBank.bankName:""),_defineProperty(_params2,"payBankNo",vm.authBankAccount||""),_defineProperty(_params2,"payBankName",vm.authBank&&vm.authBankAccount?vm.authAccountName:""),_defineProperty(_params2,"pbApplNoList",vm.PbApplNo),_defineProperty(_params2,"PbInsuYearFlag",vm.PbInsuYearFlag),_defineProperty(_params2,"PbRemark1",vm.productData.token||"1"==vm.policyData.hasDiscount?"0":"1"),_defineProperty(_params2,"PbRemark2",vm.productData.token?2:"1"==vm.policyData.hasDiscount?"1":"0"),_defineProperty(_params2,"PbRemark3",vm.productData.token?"0.00000000":vm.policyData.discount||""),_defineProperty(_params2,"PbRemark4",vm.productData.lotCode?vm.productData.lotCode:vm.policyData.disActivityId||""),_defineProperty(_params2,"PbRemark5",""),_defineProperty(_params2,"PbRemark6",""),_defineProperty(_params2,"disActId",vm.productData.token?"0000":vm.policyData.BkBrchNo.substr(0,4)),_defineProperty(_params2,"saleChnl",vm.productData.token?CONFIG.SALE_CHANNEL:"000"),_defineProperty(_params2,"cardToken",vm.productData.token),_params2);return vm.checkImgCodeForShow?(params.cpRandom=vm.cpRandom,params.cpImageCode=vm.cpImageCode):(params.cpRandom="",params.cpImageCode=""),vm.productData.newSaleChnl&&(params.sellTypeDetail=vm.productData.newSaleChnl,params.saleChnl=vm.productData.newSaleChnl,params.salesId=vm.productData.salesId,params.parentSalesId=vm.productData.parentSalesId,params.salesLevel=vm.productData.salesLevel),params.PbBeginDate=$filter("date")(params.PbBeginDate,"yyyyMMdd"),params.PbApplNo=vm.PbApplNo[0],params.insScmInf=vm.insureData.mainPlan.planCode,params.PbInsuExp=vm.insureData.mainPlan.exp+"",params}}angular.module("app").controller("PolicyIpamaController",PolicyIpamaController),PolicyIpamaController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","PolicyService","CommonRequest","$ionicPopup","$timeout"]}(),function(){function PolicyNoticeController($state,CommonRequest,CONFIG,VALIDATION,PolicyService,$filter,TipService,$rootScope,$timeout,$scope,$ionicModal,$ionicPopup,$ionicLoading){var vm=this,sessionData=PolicyService.getSessionData();if(vm.checkImgCodeForShow=!1,vm.productData=sessionData.productData,!vm.productData)return void $state.go("tab.mall");if(vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.totalPolicyMount=sessionData.policyData.totalPolicyMount,vm.totalPolicyMount=sessionData.policyData.totalPolicyMount,vm.PbInsuExp=vm.insureData.PbInsuExp,vm.healthTag=vm.policyData.healthTag||"",vm.materials=[],vm.allRead=!0,vm.agree=vm.policyData.agree||"",vm.provinceCode=vm.policyData.PlchdProvCd||"",vm.productData.materials&&vm.productData.materials.length>0)for(var i=0;i<vm.productData.materials.length;i++){var ma=vm.productData.materials[i];if(ma&&"M6"!=ma.materialType){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc},material=[];CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status&&(material=result.data,material&&material.length>0)){for(var j=0;j<material.length;j++)material[j].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[j].materialPath,material[j].isRead=!1,vm.materials.push(material[j]);if(vm.materials&&vm.materials.length>0){var arr=vm.materials.filter(function(item){return item.areaCode&&item.areaCode==vm.provinceCode});arr.length>0?vm.materials=vm.materials.filter(function(item){return!item.areaCode||item.areaCode==vm.provinceCode}):vm.materials=vm.materials.filter(function(item){return!item.areaCode||"all"==item.areaCode})}vm.allRead=!1}})}}vm.tabList=["相关条款"],vm.productData.hotTip&&vm.productData.hotTip.length>0&&vm.tabList.push("特别提示"),vm.productData.exoneration&&vm.productData.exoneration.length>0&&vm.tabList.push("责任免除"),vm.submitIdx=0,vm.flag_notify=!0;var prd_id=vm.productData.prd_id;vm.getTempNotice=function(){var GET_TEMP_NOTICE={url:"../statics/json/notifyMessage/"+prd_id+".json",method:"GET"};CommonRequest.request({},GET_TEMP_NOTICE,function(result){result&&result.data&&(vm.flag_notify=!1,vm.dataList=result.data)})},vm.getTempNotice();var ageAll=$filter("date")(vm.insureData.birthday,"yyyy-MM-dd"),ageYear=VALIDATION.getAgeByBirth(ageAll);switch(ageYear>=18?vm.ageYearFlag=!1:vm.ageYearFlag=!0,$scope.$watch("policyNotice.moneyTotal",function(newValue){newValue&&(vm.moneyTotalError="",10>ageYear?newValue>15e4&&(vm.moneyTotalError="您不具备投保资格"):ageYear>=10&&18>ageYear&&newValue>45e4&&(vm.moneyTotalError="您不具备投保资格"))},!0),vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};PolicyService.getMaterialDetail(params)}},vm.goRead=function(ma,index){vm.MaterialIndex=index,vm.showMaterialModal()},vm.showMaterialModal=function(){var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/product-purchase/product-purchase-info/policy-notice/popup/material.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.nowRead=vm.MaterialIndex+1,self.allNeadRead=vm.materials.length,self.activeMaterial=vm.materials[vm.MaterialIndex],self.materialUrl=vm.materials[vm.MaterialIndex].materialPath,self.hasMaterialCanvans=!1,self.noMaterialPDF=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(console.info(65465456465),self.hasMaterialCanvans=!0,self.noMaterialPDF=!1,$ionicLoading.hide(),vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){console.info(e),self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){PolicyService.recordOperLog(vm.productData.orderCode,"12"),vm.materials[vm.MaterialIndex].isRead=!0,vm.allRead=vm.materials.every(function(arr){return arr.isRead}),self.modal.remove(),vm.allRead||(vm.MaterialIndex++,vm.MaterialIndex>vm.materials.length-1&&(vm.MaterialIndex=0),vm.showMaterialModal())}})},vm.insuYearFlag=vm.insureData.mainPlan.insuYearFlag,vm.insuYearFlag){case"D":vm.PbInsuYearFlag="5";break;case"M":vm.PbInsuYearFlag="4";break;case"Y":vm.PbInsuYearFlag="2";break;case"A":vm.PbInsuYearFlag="6"}if(vm.prdAccount=vm.insureData.prdAccount,vm.PbInsuExp1="",vm.PbInsuExp2="",vm.LiImpawnTag="",vm.prdAccount&&vm.prdAccount.length>0){for(var j=0;j<vm.prdAccount.length;j++)vm.PbInsuExp2=vm.PbInsuExp2+vm.prdAccount[j].PbInsuExp+";",vm.PbInsuExp1=vm.PbInsuExp1+vm.prdAccount[j].accountCode+";";vm.PbInsuExp2=vm.PbInsuExp2.substr(0,vm.PbInsuExp2.length-1),vm.PbInsuExp1=vm.PbInsuExp1.substr(0,vm.PbInsuExp1.length-1),vm.LiImpawnTag="2"}vm.dataCheck=function(){return"0"!=vm.healthTag?(TipService.showMsg($rootScope.TIPS.PRODUCT.HEALTHY_INVALID),!1):!0},vm.getPolicyData=function(){var sessionData=PolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.addPlan=vm.insureData.addPlan,vm.addPlan)if(angular.isArray(vm.addPlan)||(vm.addPlan=[vm.addPlan]),vm.BkNum1=0,vm.AppdList=[],vm.insureData.loveheaPlan)for(var i=0;i<vm.addPlan.length;i++)vm.BkNum1++,vm.AppdList.push({cvrID:vm.addPlan[i].planCode,cvrNm:vm.addPlan[i].planName,insCps:1,insPremAmt:vm.addPlan[i].exp,insCvr:vm.addPlan[i].amount,insDdln:vm.insureData.addPlan.insuYear,insPremPyFMtdCd:"0"==vm.insureData.paymentType?"0":"12",insPremPyFPrdNum:"1",LiBackTag:vm.policyData.isBatts,mainAndAdlInsInd:"0",prdId:vm.productData.prd_id,planId:vm.addPlan[i].planId,socialSecurity:vm.insureData.socialSecurity});else for(var i=0;i<vm.addPlan.length;i++)vm.BkNum1++,vm.AppdList.push({cvrID:vm.addPlan[i].planCode,cvrNm:vm.addPlan[i].planName,insCps:1,insPremAmt:vm.addPlan[i].exp,insCvr:vm.addPlan[i].amount,insDdln:vm.insureData.mainPlan.insuYear,insPremPyFPrdNum:vm.insureData.payendyear,LiBackTag:vm.policyData.isBatts,mainAndAdlInsInd:"0",prdId:vm.productData.prd_id,planId:vm.addPlan[i].planId});var params={orderCode:vm.productData.orderCode,PbBenfNum:"0",PbInsuType:vm.productData.prd_code,PbInsuName:vm.productData.prd_title,mainAndAdlInsInd:"1",PbSlipNumb:1,PbInsuExp:vm.insureData.mainPlan.exp,PbInsuAmt:vm.insureData.mainPlan.amount,PbMainInsuExp:0,PbInsuExpAppd:0,PbSendMode:"2",PbBeginDate:vm.insureData.PbBeginDate,LiSpec:"",LiExpireInsuDrawMode:"",LiPayOffTag:"",LiHealthTag:vm.healthTag,PbPayPeriod:vm.insureData.paymentType,PbPayAgeTag:vm.insureData.payendyear||"1",PbInsuYearFlag:vm.PbInsuYearFlag,LiInsuPeriod:vm.insureData.mainPlan.insuYear,PbInsuYear:0,PbPayAge:0,PbDrawAgeTag:"",PbDrawAge:0,LiImpawnTag:vm.LiImpawnTag||"",BkNum1:vm.BkNum1||0,AppdList:vm.AppdList||[],BkNum2:0,PbApplNo:vm.PbApplNo||"",BkVchNo:"",LiInsuSlipPWD:"",PiTrfVchNo:"",BkRckrNo:"",PiZxbe20:0,BkAreaNo:"",PiManBankNo:"",PbRemark1:vm.productData.token||"1"==vm.policyData.hasDiscount?"0":"1",PbRemark2:vm.productData.token?2:"1"==vm.policyData.hasDiscount?"1":"0",PbRemark3:vm.productData.token?"0.00000000":vm.policyData.discount||"",PbRemark4:vm.productData.lotCode?vm.productData.lotCode:vm.policyData.disActivityId||"",PbRemark5:"",PbRemark6:"",insScmInf:vm.insureData.mainPlan.planCode,disActId:vm.productData.token||"1"==vm.policyData.configType||"4"==vm.policyData.configType?"0000":vm.policyData.BkBrchNo.substr(0,4),saleChnl:"2"==vm.policyData.configType||"4"==vm.policyData.configType?"000":CONFIG.SALE_CHANNEL,SellTypeDetail:CONFIG.SALE_CHANNEL,PbInsuExp1:vm.PbInsuExp1,PbInsuExp2:vm.PbInsuExp2,allInsuExp:vm.insureData.PbInsuExp,materials:vm.productData.materials,cardToken:vm.productData.token,dutys:vm.insureData.mainPlan.dutys,prdId:vm.productData.prd_id,planId:vm.insureData.mainPlan.planId,preInsureFlag:vm.productData.prelnsureFlag,insPolcyEfDt:vm.productData.insPolcyEfDt};(vm.productData.prd_code="BEDH")&&(params.benfSetType="1"),vm.policyData.crsData&&(params=angular.extend(params,vm.policyData.crsData)),vm.checkImgCodeForShow?(params.cpRandom=vm.cpRandom,params.cpImageCode=vm.cpImageCode):(params.cpRandom="",params.cpImageCode=""),vm.productData.newSaleChnl&&(params.sellTypeDetail=vm.productData.newSaleChnl,params.saleChnl=vm.productData.newSaleChnl,params.salesId=vm.productData.salesId,params.parentSalesId=vm.productData.parentSalesId,params.salesLevel=vm.productData.salesLevel,params.activityId=vm.productData.activityId);var dates=params.PbBeginDate;if(angular.isArray(dates)&&dates.length>=1){var codeArr=vm.insureData.codeArr,code="";if(codeArr&&codeArr.length>0){for(var m=0;m<codeArr.length;m++)code=code+codeArr[m]+";";code=code.substr(0,code.length-1)}for(var newParams=[],j=0;j<dates.length;j++){var startTime=dates[j].start,endTime=dates[j].end,tempDay=dates[j].tempDay,temp={};angular.extend(temp,params),temp.PbBeginDate=$filter("date")(startTime,"yyyyMMdd"),temp.LiInsuPeriod=tempDay,temp.cvrInsDt=$filter("date")(endTime,"yyyyMMdd"),temp.PbRemark6=$filter("date")(endTime,"yyyyMMdd"),temp.PbApplNo=vm.PbApplNo[j],temp.insScmInf=code,temp.allInsuExp=vm.insureData.PbInsuExp/dates.length,temp.PbInsuExp="0.0",temp.PbInsuAmt="0.0",newParams.push(temp)}return newParams}return"JIPAA"!=vm.productData.templateCode&&(params.PbApplNo=vm.PbApplNo[0]),params.PbBeginDate=$filter("date")(params.PbBeginDate,"yyyyMMdd"),params.insScmInf=vm.insureData.mainPlan.planCode,params.PbInsuExp=vm.insureData.mainPlan.exp,"TAC"!=vm.productData.templateCode&&"TACA"!=vm.productData.templateCode&&"IPAM"!=vm.productData.templateCode||(params.cvrInsDt=vm.insureData.cvrInsDt,params.PbRemark6=vm.insureData.cvrInsDt),"TACA"!=vm.productData.templateCode&&"TACB"!=vm.productData.templateCode&&"TACC"!=vm.productData.templateCode||(params.beginTime=vm.insureData.beginTime),"HMRA"!=vm.productData.templateCode&&"HMRB"!=vm.productData.templateCode||(params.socialSecurity=vm.insureData.socialSecurity,params.insScmInf=""),params},vm.checkPolicy=function(){function doCheck(params,index){$timeout(function(){PolicyService.setSessionData({policyData:{healthTag:vm.healthTag,agree:vm.allRead}}),PolicyService.control({state:$state.current.name,control:"data",data:params}),PolicyService.control({state:$state.current.name,control:"process"})},500*index)}var policyData=vm.getPolicyData();if(policyData)if(angular.isArray(policyData)&&policyData.length>0)for(var i=0;i<policyData.length;i++)doCheck(policyData[i],i);else doCheck(policyData,0)},vm.cpRandom=Date.parse(new Date)+Math.random(8),vm.cpImgpath=CONFIG.SERVICE_ADDRESS+"new/ImgVerifyCode?random="+vm.cpRandom,$rootScope.$on("get-newimgCode",function(erent,data){"true"==data.result&&(vm.cpRandom=Date.parse(new Date)+Math.random(8),vm.cpImgpath=CONFIG.SERVICE_ADDRESS+"new/ImgVerifyCode?random="+vm.cpRandom)}),vm.checkImgCode=function(){var rootScope=$rootScope;rootScope.$on("send-imgCode",function(erent,data){"Y"==data.isCheckImgFlag?vm.checkImgCodeForShow=!0:vm.checkImgCodeForShow=!1})},vm.getCpimg=function(){vm.cpImageCode="",vm.cpRandom=Date.parse(new Date)+Math.random(8),vm.cpImgpath=CONFIG.SERVICE_ADDRESS+"new/ImgVerifyCode?random="+vm.cpRandom},vm.submit=function(){var self=$rootScope;return vm.submitIdx<vm.tabList.length-1?void vm.submitIdx++:void $ionicModal.fromTemplateUrl("app/module/mall/product/health-modal/health-modal.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!1}).then(function(modal){self.modal=modal,self.modal.show(),self.close=function(){self.modal.remove()},self.rightButten=function(){PolicyService.recordOperLog(vm.productData.orderCode,"13"),vm.healthTag="0","01"==vm.policyData.confirmRela||"Y"!=vm.productData.basicProfile.P028?vm.process():ageYear>=18?($rootScope.showAgreeModal=!0,
$ionicPopup.show({template:"<p>被保险人已同意本次投保，并已认可本次投保的保险金额</p>",buttons:[{text:"否",onTap:function(e){$rootScope.showAgreeModal=!1}},{text:"是",type:"button-positive",onTap:function(e){$rootScope.showAgreeModal=!1,vm.process()}}]})):vm.process()}})},vm.process=function(){if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");if(vm.dataCheck()){if(vm.checkImgCode(vm),"JIPAA"==vm.productData.templateCode){if("01"==vm.jipaaTag&&(vm.moneyTotalError="",vm.moneyTotal=""),vm.moneyTotalError)return void TipService.showMsg("尊敬的客户您好，您选择的告知事项内容，不符合我们的投保要求，请采用其他渠道购买本产品，谢谢您对我们的支持");var schoolClass={atSchool:vm.policyData.atSchool,atClass:vm.policyData.atClass,moneyTotal:vm.moneyTotal,ageYearFlag:vm.ageYearFlag},policyDataJipaa=vm.getPolicyData();if(angular.extend(policyDataJipaa,schoolClass),angular.extend(vm.policyData,policyDataJipaa),!policyDataJipaa)return;return PolicyService.setSessionData({policyData:policyDataJipaa}),void CommonRequest.request(vm.policyData,CONFIG.CHECK_CUSTOMER,function(result){1==result.status&&$state.go("product-purchase-confirm")})}PolicyService.createPbApplNo(vm.policyData.BkBrchNo,function(pbApplNoList){vm.PbApplNo=pbApplNoList,$rootScope.modal.remove(),vm.checkPolicy()})}}}angular.module("app").controller("PolicyNoticeController",PolicyNoticeController),PolicyNoticeController.$inject=["$state","CommonRequest","CONFIG","VALIDATION","PolicyService","$filter","TipService","$rootScope","$timeout","$scope","$ionicModal","$ionicPopup","$ionicLoading"]}(),function(){function GhmbController($state,VALIDATION,$scope,$document,CommonRequest,CONFIG,TipService,GroupPolicyService,$filter,$rootScope,$ionicLoading,$timeout){var vm=this,sessionData=GroupPolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.userData=sessionData.userData,!vm.productData||2!=sessionData.loginStatus&&"Y"==vm.productData.basicProfile.P005&&!vm.productData.phoneValid)return void $state.go("tab.mall");vm.hasSpecial=!0;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.minHolderAge,vm.maxAge=payTypeConfig.maxHolderAge,vm.minStartDate=VALIDATION.getDateByAge(vm.maxAge),vm.maxEndDate=VALIDATION.getDateByAge(vm.minAge)}var minDate=VALIDATION.getDateByAge("23"),maxDate=VALIDATION.getDateByAge("0");vm.planChecked="",vm.planDet=!1,vm.planMoney="50万元",vm.nextStep=!1,vm.planOneCheck=function(){vm.planChecked="1",vm.planDet=!0,vm.planMoney="50万元"},vm.planTwoCheck=function(){vm.planChecked="2",vm.planDet=!0,vm.planMoney="100万元"},vm.slideUp=function(){vm.planDet=!1},vm.priChecked=!1,vm.priInfo={isMedic:"",birthday:""},vm.priMedic=function(medic){vm.priInfo.isMedic=medic},vm.secList=[{id:1,trashShow:!1,secIsShow:!1,birthday:"",isMate:"",isMedic:"",minStartDate:minDate,maxEndDate:maxDate,disabled:null},{id:2,trashShow:!1,secIsShow:!1,birthday:"",isMate:"",isMedic:"",minStartDate:minDate,maxEndDate:maxDate,disabled:null}],vm.secInfo=[{id:1,birthday:"",isMate:"",isMedic:""},{id:2,birthday:"",isMate:"",isMedic:""}],vm.secShow=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secIsShow=!vm.secList[i].secIsShow;break}},vm.add=function(){var id=vm.secList[vm.secList.length-1].id+1;vm.secList.push({id:id,trashShow:!0,secIsShow:!1,birthday:"",isMate:"",isMedic:"",minStartDate:minDate,maxEndDate:maxDate,disabled:null}),vm.secInfo.push({id:id,birthday:"",isMate:"",isMedic:""}),vm.checkRelations()},vm.del=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList.splice(i,1),vm.secInfo.splice(i,1),3==vm.secList.length&&(vm.secList[i].secIsShow=!vm.secList[i].secIsShow);break}vm.checkRelations()},vm.secMate=function(id,relation){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].isMate=relation,vm.secInfo[i].isMate=relation,vm.secList[i].birthday="";break}vm.checkRelations()},vm.checkRelations=function(){for(var flag=!0,m=0;m<vm.secList.length;m++)if("03"==vm.secList[m].isMate){flag=!1;for(var n=0;n<vm.secList.length;n++)vm.secList[n].disabled=!0;vm.secList[m].disabled=!1}if(flag)for(var m=0;m<vm.secList.length;m++)vm.secList[m].disabled=!1},vm.checkRelation=function(id,relation){for(var m=0;m<vm.secList.length;m++){if("03"==vm.secList[m].isMate){vm.hasSpecial=!0;break}vm.hasSpecial=!1}if(vm.hasSpecial)for(var k=0;k<vm.secList.length;k++)id?"03"!=relation&&vm.secList[k].id!=id&&(vm.secList[k].disabled=!1):"03"!=vm.secList[k].isMate?vm.secList[k].disabled=!0:vm.secList[k].disabled=!1;else for(var j=0;j<vm.secList.length;j++)"03"==relation?vm.secList[j].id==id?vm.secList[j].disabled=!1:vm.secList[j].disabled=!0:vm.secList[j].disabled=!1},vm.secMedic=function(id,medic){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].isMedic=medic,vm.secInfo[i].isMedic=medic;break}},$scope.$watch("ghmb.planChecked",function(newValue){vm.nextStep=!1},!0),$scope.$watch("ghmb.priInfo",function(newValue){vm.nextStep=!1},!0),$scope.$watch("ghmb.secInfo",function(newValue){vm.nextStep=!1},!0),vm.dateChange=function(){vm.nextStep=!1},vm.addPic=!0,$scope.$watch("ghmb.secList.length",function(newValue){newValue>=4?vm.addPic=!1:vm.addPic=!0},!0),vm.getPremiumRateGroupCoreResultTimes=0,vm.getPremiumRateGroupCoreResult=function(flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremiumRateGroupCoreResultTimes++,vm.getPremiumRateGroupCoreResultTimes>CONFIG.GROUP_CORE_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg("系统繁忙,请稍后重试"),void(vm.getPremiumRateGroupCoreResultTimes=0);var params={flowNo4Trial:flowNo};CommonRequest.request(params,CONFIG.GHMB_GET_PREMIUM_RATE_GROUP_CORE_RESULT,function(result){if(1==result.status){var data=result.data||"";if(""==data)return void $timeout(function(){vm.getPremiumRateGroupCoreResult(flowNo)},CONFIG.GROUP_CORE_DECOUPLING_DURATION);if($ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0,"00000"!=data.respCode)return void TipService.showMsg(data.respDesc);var orderCode=data.orderCode;orderCode&&GroupPolicyService.setSessionData({productData:{orderCode:orderCode}});for(var i=0;i<data.rcgnList.length;i++)for(var j=0;j<vm.secList.length;j++)"0"==data.rcgnList[i].rcgnNm?vm.insCvr=data.rcgnList[i].insPrem:data.rcgnList[i].rcgnNm==vm.secList[j].id&&(vm.secList[j].insCvr=data.rcgnList[i].insPrem);vm.totalInsCvr=data.totalInsCvr,vm.nextStep=!0}else $ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0},!0)};var params,insuredList=[],plans=[];vm.submitAccount=function(){plans=1==vm.planChecked?vm.productData.plans[0]:vm.productData.plans[1],insuredList=[{rcgnNm:"0",rcgnBrthDt:$filter("date")(vm.priInfo.birthday,"yyyyMMdd"),insuredSSflag:vm.priInfo.isMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]}];for(var i=0;i<vm.secList.length;i++)insuredList.push({rcgnNm:vm.secList[i].id.toString(),rcgnBrthDt:$filter("date")(vm.secList[i].birthday,"yyyyMMdd"),insuredSSflag:vm.secList[i].isMedic,insuredAppntRela:vm.secList[i].isMate,cvrNum:"1",busiList:[{cvrID:plans.planCode,mainAndAdlInsInd:"1",insCps:"1",insCvr:plans.insuredAmount,insScmInf:plans.planCode}]});params={premiumAppEntity:{plchdBrthDt:$filter("date")(vm.priInfo.birthday,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredNum:insuredList.length,insuredList:insuredList},orderCode:vm.productData.orderCode||"",channelCode:CONFIG.SALE_CHANNEL,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P006?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.saleAvailFlag,planId:plans.planId,planCode:plans.planCode,planName:plans.planName,prdId:vm.productData.prd_id,prdCode:vm.productData.prd_code,prdName:vm.productData.prd_title,sellTypeDetail:CONFIG.SALE_CHANNEL},CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(result.data)})},vm.next=function(){GroupPolicyService.control({state:"product-purchase-group-calculate",control:"data",data:{plchdBrthDt:$filter("date")(vm.priInfo.birthday,"yyyyMMdd"),appntSsflag:vm.priInfo.isMedic,insuredList:insuredList,totalInsCvr:vm.totalInsCvr,insCvr:vm.insCvr,plans:plans,groupProName:vm.productData.prd_title,pbApplNoNum:"1",params:params}}),GroupPolicyService.control({state:"product-purchase-group-calculate",control:"process"})}}angular.module("app").controller("GhmbController",GhmbController),GhmbController.$inject=["$state","VALIDATION","$scope","$document","CommonRequest","CONFIG","TipService","GroupPolicyService","$filter","$rootScope","$ionicLoading","$timeout"]}(),function(){function GroupPolicyAgreementController($state,CommonRequest,GroupPolicyService,COMMON,$scope,$rootScope,$filter,CONFIG,$timeout){var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.citizeentype=COMMON.getCommonData().CITIZENTYPE,vm.taxpymtnotype=COMMON.getCommonData().TAXPYMTNOTYPE,vm.nontaxpymtcd=COMMON.getCommonData().NONTAXPYMTCD;var BkBrchNo;vm.policyData&&(BkBrchNo=vm.policyData.BkBrchNo);var policyData;policyData=!vm.productData.basicProfile||"Y"!=vm.productData.basicProfile.P023&&"GHMB"!=vm.productData.prd_code?"":sessionData.policyData||"",vm.crsData=policyData.crsData?policyData.crsData:"",vm.policyData.PbHoldName&&(vm.newGetAccountName=vm.policyData.PbHoldName,vm.authAccountName=vm.policyData.PbHoldName,vm.bonusBankAccountName=vm.policyData.PbHoldName,vm.liBonusBankAccountName=vm.policyData.PbHoldName,vm.renewalBankAccountName=vm.policyData.PbHoldName),vm.basicProfile=vm.productData.basicProfile,vm.isBatts=policyData.isBatts||"-1",vm.isTipsVisible=!1,console.log(vm.isTipsVisible),vm.showRenewal1=!1,vm.showRenewal2=!1,policyData.plchdAccNo&&(policyData.plchdAccNo=policyData.plchdAccNo.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ")),vm.renewalBankAccount=vm.renewalBankAccountConfirm=policyData.plchdAccNo||"",policyData.plchdAccNo&&(vm.agree3=!0),vm.disputeHanding=policyData.PiZyzcfs||1,vm.disputeGroupName=policyData.PiZcinst||"",$scope.$watch("groupPolicyAgreement.renewalBankAccount",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccount=str}}),$scope.$watch("groupPolicyAgreement.renewalBankAccountConfirm",function(newValue,oldValue){if(newValue&&(12==newValue.length||15==newValue.length||20==newValue.length||25==newValue.length)){var str=newValue.toUpperCase().replace(/\s/g,"").replace(/(.{4})/g,"$1 ");vm.renewalBankAccountConfirm=str}}),vm.getVprdid=function(){var params={prdCode:"ALLIN"};CommonRequest.request(params,CONFIG.NEW_GETPRDID,function(result){result.data&&(vm.v_prdid=result.data)})},"Y"==vm.basicProfile.P020&&vm.getVprdid(),vm.crsData?vm.citizenType=vm.crsData.citizenType||"":"A"==policyData.PbHoldIdType?vm.citizenType="1":vm.citizenType="",vm.insuranceName=vm.policyData.PbHoldName,vm.surname=vm.crsData.surname||"",vm.secondName=vm.crsData.secondName||"",vm.crsBirthday=vm.policyData.PbHoldBirdyDate,vm.liveCountry="中国",vm.liveZone=vm.policyData.liveProvince+"-"+vm.policyData.liveDistrict+"-"+vm.policyData.liveDstc,vm.liveAdr=vm.policyData.PbHoldAddress,vm.birthCountry=vm.crsData.birthCountryCont||"中国",vm.birthCode=vm.crsData.birthCountry||"CHN",vm.province={},vm.city={},vm.district={},vm.province.areaName=vm.crsData.birthProvinceCont||"",vm.city.areaName=vm.crsData.birthDistrictCont||"",vm.district.areaName=vm.crsData.birthDstcCont||"",vm.province.areaCode=vm.crsData.birthProvince||"",vm.city.areaCode=vm.crsData.birthDistrict||"",vm.district.areaCode=vm.crsData.birthDstc||"",$scope.$on("select-country-close",function(event,result){vm.birthCountry=result[0].countryName,vm.birthCode=result[0].countryCode}),vm.locate=vm.crsData.birthProvinceCont?vm.crsData.birthProvinceCont+"-"+vm.crsData.birthDistrictCont+"-"+vm.crsData.birthDstcCont:"",vm.birthDetailAdr=vm.crsData.birthDetailAdr||"",$scope.$on("select-prdarea-close",function(event,result){vm.province=result[0],vm.city=result[1],vm.district=result[2]}),vm.signDate=$filter("date")(new Date,"yyyy年MM月dd日"),vm.isSelf="本人",vm.crsData.taxList&&0!=vm.crsData.taxList.length?vm.crsList=vm.crsData.taxList:vm.crsList=[{seqNo:1,taxPymtNoType:""}],vm.addCrs=function(){if(!(vm.crsList.length>=3)){var seqNo=vm.crsList[vm.crsList.length-1].seqNo+1;vm.crsList.push({seqNo:seqNo,taxPymtNoType:""})}},vm.delCrs=function(seqNo){if(!(vm.crsList.length<=1))for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&vm.crsList.splice(i,1)},vm.clearInput=function(Type,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&("1"==Type?vm.crsList[i].nonTaxPymtDesc="":"2"==Type&&(vm.crsList[i].taxPymtNo=""))},vm.clearInputse=function(nonTaxPymtCd,seqNo){for(var i=0;i<vm.crsList.length;i++)vm.crsList[i].seqNo==seqNo&&"1"==nonTaxPymtCd&&(vm.crsList[i].nonTaxPymtDesc="")},vm.getBankList=function(){BkBrchNo&&COMMON.getGroupCommonBank(BkBrchNo,function(bankList){if(vm.bankList=bankList,vm.bankList&&vm.bankList.length>0&&(vm.newGetBkCode=bankList[0],vm.renewalBancCode=bankList[0]),policyData.BankCode)for(var i=0;i<vm.bankList.length;i++)if(vm.bankList[i].bankCode==policyData.BankCode)return void(vm.renewalBank=vm.bankList[i])})},vm.getBankList(),vm.next=function(){if("-1"==vm.isBatts&&!vm.renewalBank.bankCode)return void TipService.showMsg("请选择银行储蓄卡");var data={PiZyzcfs:vm.disputeHanding,PiZcinst:vm.disputeGroupName};if(vm.basicProfile.P021&&"Y"==vm.basicProfile.P021){var battsData={isBatts:vm.isBatts,BankName:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBankAccountName:"",BankCode:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankCode:"",plchdAccNo:vm.renewalBankAccount.replace(/\s+/g,""),plchdAccBankNm:vm.renewalBankAccount&&vm.renewalBank?vm.renewalBank.bankName:""};data=angular.extend(data,battsData)}if(vm.basicProfile.P020&&"Y"==vm.basicProfile.P020){var birthFlag,isCitizenType=!0;"2"!=vm.citizenType&&"3"!=vm.citizenType||(isCitizenType=!1),birthFlag=("2"==vm.citizenType||"3"==vm.citizenType)&&"CHN"==vm.birthCode;var crsData={citizenType:vm.citizenType,surname:isCitizenType?"":vm.surname,secondName:isCitizenType?"":vm.secondName,liveCountry:isCitizenType?"":"CHN",birthCountryCont:isCitizenType?"":vm.birthCountry,birthCountry:isCitizenType?"":vm.birthCode,birthProvinceCont:vm.province&&birthFlag?vm.province.areaName:"",birthProvince:vm.province&&birthFlag?vm.province.areaCode:"",birthDistrictCont:vm.city&&birthFlag?vm.city.areaName:"",birthDistrict:vm.city&&birthFlag?vm.city.areaCode:"",birthDstcCont:vm.district&&birthFlag?vm.district.areaName:"",birthDstc:vm.district&&birthFlag?vm.district.areaCode:"",birthDetailAdr:isCitizenType?"":vm.birthDetailAdr,taxList:isCitizenType?[]:vm.crsList,signDate:vm.signDate,isSelf:"1"};data.crsData=crsData,data=angular.extend(data,crsData)}GroupPolicyService.control({state:"product-purchase-group-policy-agreement",control:"data",data:data}),GroupPolicyService.control({state:"product-purchase-group-policy-agreement",control:"process"})}}angular.module("app").controller("GroupPolicyAgreementController",GroupPolicyAgreementController),GroupPolicyAgreementController.$inject=["$state","CommonRequest","GroupPolicyService","COMMON","$scope","$rootScope","$filter","CONFIG","$timeout"]}(),function(){function GroupPolicyInfoController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,GroupPolicyService,CommonRequest,$ionicPopup,$timeout,$ionicLoading){var vm=this;vm.getCommonData=function(){$timeout(function(){$rootScope.loadingCommonData?(vm.occjoins=vm.commonoCcupations=$rootScope.COMMON_DATA.OCCUPATION_CODE,vm.occjoins.push({label:"学龄前儿童或在校学生",value:"13020"}),vm.idTypes=$rootScope.COMMON_DATA.ID_TYPES):vm.getCommonData()},200)},vm.getCommonData();var sessionData=GroupPolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.userData=sessionData.userData||{},vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023?vm.policyData=sessionData.policyData||"":vm.policyData="",vm.LiRcgnList=vm.policyData.LiRcgnList||"",!vm.productData||!vm.insureData)return void $state.go("tab.mall");vm.insureData.params.orderCode=vm.productData.orderCode;var payTypeConfigs=vm.productData.payTypeConfigs;if(payTypeConfigs&&payTypeConfigs.length>0){var payTypeConfig=payTypeConfigs[0];vm.minAge=payTypeConfig.minHolderAge,vm.maxAge=payTypeConfig.maxHolderAge}vm.childMinAge="0",vm.childMaxAge="23",vm.secList=[];for(var i=1;i<vm.insureData.params.premiumAppEntity.insuredList.length;i++)vm.secList.push({id:vm.insureData.params.premiumAppEntity.insuredList[i].rcgnNm,secIsShow:!!vm.LiRcgnList,birth:vm.LiRcgnList?vm.LiRcgnList[i-1].LiRcgnBirdy:vm.insureData.params.premiumAppEntity.insuredList[i].rcgnBrthDt,isMate:vm.LiRcgnList?vm.LiRcgnList[i-1].confirmRela:vm.insureData.params.premiumAppEntity.insuredList[i].insuredAppntRela,isMedic:vm.LiRcgnList?vm.LiRcgnList[i-1].LiRcgnMedic:vm.insureData.params.premiumAppEntity.insuredList[i].insuredSSflag});vm.curProId=vm.productData.prd_id,vm.getOccupSwitch=function(){var configSwitch={url:"../statics/json/occupSwitch.json",method:"GET"};CommonRequest.request({},configSwitch,function(result){if(1==result.status){vm.occupSwitchData=result.data;for(var i=0;i<vm.occupSwitchData.length;i++)vm.occupSwitchData[i].prdId==vm.curProId&&("N"==vm.occupSwitchData[i].occupSwitch?vm.occupSwitch=!1:vm.occupSwitch=!0)}})},vm.getOccupSwitch(),vm.secShow=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){vm.secList[i].secIsShow=!vm.secList[i].secIsShow;break}},vm.priChecked=!0,vm.priCheck=function(){vm.priChecked=!vm.priChecked},vm.checkMateSex=function(){"03"==vm.secList[i].isMate&&vm.gender==vm.secList[i].gender&&TipService.showMsg($rootScope.TIPS.PRODUCT.MATE_SEX_ERROR)},vm.init=function(){if(vm.userData.customerName?(vm.insureName=vm.userData.customerName,vm.nameDisabled=!0):vm.insureName=vm.policyData.PbHoldName||"",vm.medic=vm.policyData.PbHoldMedic||vm.insureData.appntSsflag,vm.nationalities=[{label:"中国",value:"0156"}],vm.nationality=vm.policyData.PbNationality||"0156",vm.certTypes=[vm.idTypes[0]],vm.certType="A",vm.userData.cretNo&&"A"==vm.userData.cretType?(vm.certNo=vm.userData.cretNo.replace(/\s+/g,""),vm.certNoDisabled=!0,vm.certTypeDisabled=!0):vm.certNo=vm.policyData.PbHoldId||"",vm.certExpireDate=vm.policyData.PbIdEndDate?VALIDATION.dateFormat(vm.policyData.PbIdEndDate):"",vm.policyData.PbHoldExpireType?vm.certExpireType="1"==vm.policyData.PbHoldExpireType:vm.certExpireType=!0,vm.gender="",vm.certType&&"A"==vm.certType&&vm.certNo?(vm.gender="1"==VALIDATION.getSex(vm.certNo)?"男":"女",vm.genderDisabled=!0):vm.userData.sex?(vm.gender="1"==vm.userData.sex?"男":"女",vm.genderDisabled=!0):vm.policyData.PbHoldSex&&(vm.gender="1"==vm.policyData.PbHoldSex?"男":"女"),vm.birthday=vm.policyData.PbHoldBirdyDate||VALIDATION.dateFormat(vm.insureData.plchdBrthDt),vm.userData.phoneNo){var str=vm.userData.phoneNo;vm.phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length),vm.phoneDisabled=!0}else vm.phone=vm.policyData.PbHoldMobl||"";vm.occupation=vm.policyData.PbHoldOccupCode||"C0000",vm.email=vm.policyData.PbHoldEmail||"",vm.address=vm.policyData.PbHoldAddress||"",vm.zipCode=vm.policyData.PbHoldZipCode||"",vm.district=vm.policyData.PbHoldDistrict||"0",vm.amount=vm.policyData.PbHoldAmount||"",vm.minStartDate=new Date((new Date).getTime()+864e5);for(var i=0;i<vm.secList.length;i++)vm.secList[i].name=vm.LiRcgnList?vm.LiRcgnList[i].LiRcgnName:"",vm.secList[i].nationalities=[{label:"中国",value:"0156"}],vm.secList[i].nationality="0156",vm.secList[i].gender=vm.LiRcgnList?"1"==vm.LiRcgnList[i].LiRcgnSex?"男":"女":"",vm.secList[i].certTypes=[vm.idTypes[0]],vm.secList[i].certType="A",vm.secList[i].birthday=vm.LiRcgnList?VALIDATION.dateFormat(vm.LiRcgnList[i].LiRcgnBirdy):VALIDATION.dateFormat(vm.secList[i].birth),vm.secList[i].certNo=vm.LiRcgnList?vm.LiRcgnList[i].LiRcgnId:"",vm.secList[i].isAdult=!1,vm.secList[i].isStudent=!0,"03"!=vm.secList[i].isMate?(vm.secList[i].occupations=vm.commonoCcupations,vm.secList[i].needPhone=!1):vm.secList[i].needPhone=!0,vm.secList[i].phone=vm.LiRcgnList?vm.LiRcgnList[i].LiRcgnMobl:"",vm.secList[i].certExpireDate=vm.LiRcgnList&&vm.LiRcgnList[i].LiIdEndDate?VALIDATION.dateFormat(vm.LiRcgnList[i].LiIdEndDate):"",vm.LiRcgnList?vm.secList[i].certExpireType="1"==vm.LiRcgnList[i].LiRcgnExpireType:vm.secList[i].certExpireType=!0,vm.secList[i].minStartDate=new Date((new Date).getTime()+864e5),vm.secList[i].address=vm.LiRcgnList?vm.LiRcgnList[i].LiRcgnAddress:"",vm.secList[i].zipCode=vm.LiRcgnList?vm.LiRcgnList[i].LiRcgnZipCode:"","03"!=vm.secList[i].isMate&&(VALIDATION.getAgeByBirth(vm.secList[i].birthday)<18?(vm.secList[i].isAdult=!1,vm.occupSwitch?vm.secList[i].occupation="":vm.secList[i].occupation="13020"):vm.secList[i].occupation="C0000"),vm.LiRcgnList&&(vm.secList[i].occupation=vm.LiRcgnList[i].LiRcgnOccupCode);vm.errorAlert=function(key,val){"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key?1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500)):"zipCode"==key&&1==val&&(vm.zipCodeI=!0,$setTimeout(function(){vm.zipCodeI=!1},1500))},vm.hide=function(){vm.lengthShow=!1,vm.formShow=!1,vm.userFormShow=!1,vm.cretNoOdd=!1,vm.tostCretShow=!1,vm.tostCretErrShow=!1,vm.userCertInvShow=!1,vm.phoneErr=!1,vm.emailErr=!1},vm.emailList=[{emailEnd:"",emailEndShow:!1},{emailEnd:"@qq.com",emailEndShow:!0},{emailEnd:"@163.com",emailEndShow:!0},{emailEnd:"@126.com",emailEndShow:!0},{emailEnd:"@sina.com",emailEndShow:!0},{emailEnd:"@139.com",emailEndShow:!0},{emailEnd:"@gmail.com",emailEndShow:!0}],vm.emailListClick=function(value){-1!=vm.email.indexOf("@")&&(vm.email=vm.email.substring(0,vm.email.indexOf("@"))),vm.email=vm.email+value,vm.emailListShow=!1},vm.emailFocus=function(){vm.emailListShow=!0},vm.emailBlur=function(val){vm.emailListShow=!1,1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500))},vm.emailChange=function(value){if(vm.email){-1!=value.indexOf("@")?vm.hideEmail=value.substring(0,value.indexOf("@")):(vm.hideEmail=value,value.length>11&&(vm.hideEmail=value.substring(0,11)));var txt=vm.email,flag="";if(txt.indexOf("@")>0?(flag=txt.substring(txt.indexOf("@")-1),txt=txt.substring(0,txt.indexOf("@"))):flag="",""!=flag)for(var reg=new RegExp(flag,"i"),i=1;i<vm.emailList.length;i++){var textContent=vm.email.substring(0,vm.email.indexOf("@"))+vm.emailList[i].emailEnd;reg.test(textContent)?vm.emailList[i].emailEndShow=!0:vm.emailList[i].emailEndShow=!1}}},vm.userData.cretType?(vm.sign=!1,vm.certTypeDisabled=!0,vm.nationalityDisabled=!0,vm.certNoDisabled=!0,"A"==vm.userData.cretType&&(vm.sign=!0,vm.nationalityDisabled=!0,vm.certTypeDisabled=!0,vm.certNoDisabled=!0)):(vm.sign=!1,vm.certTypeDisabled=!1,vm.nationalityDisabled=!1)},vm.watch=function(){$scope.$watch("groupPolicyInfo.occupation",function(newValue,oldValue){"Y0000"==newValue&&TipService.showMsg("尊敬的客户，您的职业不符合该款产品的投保要求，请投保我司其他产品。")}),$scope.$watch("groupPolicyInfo.certNo",function(newValue,oldValue){if(newValue){if(vm.certType&&"A"==vm.certType){if(newValue==oldValue&&(vm.certNo=newValue.substr(0,6)+" "+newValue.substr(6,8)+" "+newValue.substr(14,newValue.length)+" ",vm.gender=VALIDATION.getSex(newValue)+""=="1"?"男":"女"),18==newValue.length){var str=newValue.toUpperCase().replace(/\s+/g,"");vm.certNo=str.substr(0,6)+" "+str.substr(6,8)+" "+str.substr(14,str.length)}if(!VALIDATION.idCheck(vm.certNo))return;vm.gender=VALIDATION.getSex(newValue)+""=="1"?"男":"女",vm.genderDisabled=!0,vm.birthday=VALIDATION.getBirthday(newValue)}}else vm.genderDisabled=!1}),$scope.$watch("groupPolicyInfo.gender",function(newValue,oldValue){newValue&&newValue!=oldValue&&(vm.sex=newValue)}),vm.phoneChange=function(id){for(var i=0;i<vm.secList.length;i++)if(vm.secList[i].id==id){if(11==vm.secList[i].phone.length){var str=vm.secList[i].phone.toUpperCase().replace(/\s+/g,"");vm.secList[i].phone=str.substr(0,3)+" "+str.substr(3,4)+" "+str.substr(7,str.length)}VALIDATION.phoneCheck(vm.secList[i].phone)?vm.secList[i].phoneOk=!0:vm.secList[i].phoneOk=!1}},vm.idChange=function(id){for(var i=0;i<vm.secList.length;i++){if(vm.secList[i].certNo=vm.secList[i].certNo||"",15==vm.secList[i].certNo.length){var str=vm.secList[i].certNo.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{1})/g,"$1 $2 $3");vm.secList[i].certNo=str}if(18==vm.secList[i].certNo.length){var str=vm.secList[i].certNo.toUpperCase().replace(/\s/g,"").replace(/(\d{6})(\d{8})(.{4})/g,"$1 $2 $3");vm.secList[i].certNo=str}if(0==vm.secList[i].certNo.length&&(vm.secList[i].gender=""),vm.secList[i].id==id&&vm.secList[i].certType&&"A"==vm.secList[i].certType){if(!VALIDATION.idCheck(vm.secList[i].certNo))return;vm.secList[i].gender=VALIDATION.getSex(vm.secList[i].certNo)+""=="1"?"男":"女","03"!=vm.secList[i].isMate&&(vm.secList[i].isMate=VALIDATION.getSex(vm.secList[i].certNo)+""=="1"?"06":"07"),vm.secList[i].birthday=VALIDATION.getBirthday(vm.secList[i].certNo),"03"!=vm.secList[i].isMate?VALIDATION.getAgeByBirth(vm.secList[i].birthday)<18?(vm.secList[i].isAdult=!1,vm.secList[i].isStudent=!0,vm.occupSwitch?vm.secList[i].occupation="":vm.secList[i].occupation="13020"):(vm.secList[i].isAdult=!0,vm.secList[i].isStudent=!1,vm.secList[i].occupation="C0000"):(vm.secList[i].occupation="C0000",vm.secList[i].isStudent=!1,vm.secList[i].isAdult=!0)}vm.secList[i].errorAlert=function(key,val){console.log(key,val),"name"==key?1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1},1500)):"certNo"==key||"insureCertNo"==key?1==val.invalid2?(vm.cretNoOdd=!0,$timeout(function(){vm.cretNoOdd=!1},1500)):1==val.length?(vm.tostCretShow=!0,$timeout(function(){vm.tostCretShow=!1},1500)):1==val.invalid&&(vm.tostCretErrShow=!0,$timeout(function(){vm.tostCretErrShow=!1},1500)):"phone"==key?1==val&&(vm.phoneErr=!0,$timeout(function(){vm.phoneErr=!1},1500)):"insureName"==key?(vm.userLengthShow=!0,1==val.invalid?(vm.lengthShow=!0,$timeout(function(){vm.lengthShow=!1,vm.userLengthShow=!1},1500)):1==val.length&&(vm.formShow=!0,$timeout(function(){vm.formShow=!1,vm.userLengthShow=!1},1500))):"email"==key?1==val&&(vm.emailErr=!0,$timeout(function(){vm.emailErr=!1},1500)):"zipCode"==key?1==val&&(vm.zipCodeI=!0,$timeout(function(){vm.zipCodeI=!1},1500)):"address"==key&&(console.log("e"),1==val.number&&(vm.addressE=!0,$timeout(function(){vm.addressE=!1},1500)),1==val.length&&(console.log("l"),vm.addressL=!0,$timeout(function(){vm.addressL=!1},1500)))}}},vm.occupationChange=function(id){for(var i=0;i<vm.secList.length;i++)vm.secList[i].id==id&&"Y0000"==vm.secList[i].occupation&&(TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人"),vm.secList[i].occupation="")},$scope.$watch("groupPolicyInfo.birthday",function(newValue,oldValue){newValue!=oldValue&&(vm.pbHoldChanged=!0)}),$scope.$watch("groupPolicyInfo.medic",function(newValue,oldValue){newValue!=oldValue&&(vm.pbHoldChanged=!0)})},vm.insuredChangedData=function(){vm.insuredChangedCache=[];for(var i=0;i<vm.secList.length;i++){var birth,isMedic,isMate;birth=vm.secList[i].birthday.substring(0,4)+vm.secList[i].birthday.substring(5,7)+vm.secList[i].birthday.substring(8,10),isMedic=vm.secList[i].isMedic,isMate=vm.secList[i].isMate,vm.insuredChangedCache.push({birth:birth,isMedic:isMedic,isMate:isMate}),birth==vm.insureData.params.premiumAppEntity.insuredList[i+1].rcgnBrthDt&&isMate==vm.insureData.params.premiumAppEntity.insuredList[i+1].insuredAppntRela&&isMedic==vm.insureData.params.premiumAppEntity.insuredList[i+1].insuredSSflag||(vm.insuredChanged=!0)}},vm.getPremiumRateGroupCoreResultTimes=0,vm.getPremiumRateGroupCoreResult=function(cacheData,flowNo){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.getPremiumRateGroupCoreResultTimes++,vm.getPremiumRateGroupCoreResultTimes>CONFIG.GROUP_CORE_DECOUPLING_TIMES)return $ionicLoading.hide(),TipService.showMsg("系统繁忙,请稍后重试"),void(vm.getPremiumRateGroupCoreResultTimes=0);var params={flowNo4Trial:flowNo};CommonRequest.request(params,CONFIG.GHMB_GET_PREMIUM_RATE_GROUP_CORE_RESULT,function(result){if(1==result.status){var data=result.data||"";if(""==data)return void $timeout(function(){vm.getPremiumRateGroupCoreResult(cacheData,flowNo)},CONFIG.GROUP_CORE_DECOUPLING_DURATION);if($ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0,"00000"!=data.respCode)return void TipService.showMsg(data.respDesc);var orderCode=data.orderCode;orderCode&&GroupPolicyService.setSessionData({productData:{orderCode:orderCode}}),vm.insureData.totalInsCvr=data.totalInsCvr,TipService.showMsg($rootScope.TIPS.PRODUCT.RECACULATED+'<span class="fs20 orange">'+vm.insureData.totalInsCvr+"</span>元"),vm.pbHoldChanged=vm.insuredChanged=!1,vm.insureData.params=cacheData}else $ionicLoading.hide(),vm.getPremiumRateGroupCoreResultTimes=0},!0)};var searchResultList="",throwContrast="";vm.careerType=!1,vm.searchResultDiv=!1,vm.tag=$state.params.tag||0;var insure_id="",insure_sp="";vm.skipCareerType=function(contrast,id,sp){vm.careerType=!0,throwContrast=contrast,insure_id=id,insure_sp=sp,vm.curData="",vm.occupationData="";for(var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div"),j=0;j<secDiv.length;j++)secDiv[j].className="";for(var i=0;i<hotA.length;i++)hotA[i].className=""},vm.tabList=function(tag,str){vm.tag=tag,vm.resultList=[],vm.secondResultList=[];var config={url:"../statics/json/SecondOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){searchResultList=vm.secondCareer=result.data;for(var i=0;i<vm.secondCareer.length;i++)vm.secondCareer[i].parentOccupCode==str&&vm.secondResultList.push(vm.secondCareer[i])}})},vm.getHotList=function(){var config={url:"../statics/json/SysHotOccup.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){1==result.status&&(vm.hotList=result.data)})},vm.getHotList(),vm.getFirstCareerList=function(){var config={url:"../statics/json/FirstOccups.json",method:"GET"},params={occupCode:vm.occupation};CommonRequest.request(params,config,function(result){if(result&&1==result.status){vm.firstCareer=result.data;for(var i=0;i<vm.firstCareer.length;i++)vm.firstCareerOccupCode=vm.firstCareer[0].occupCode;vm.tabList(0,vm.firstCareerOccupCode)}})},vm.getFirstCareerList(),vm.getCareerData=function(cur,curData,curCodeData,status){var nav=document.getElementById("careerHot"),hotA=nav.getElementsByTagName("a"),nav=document.getElementById("secData"),secDiv=nav.getElementsByTagName("div");if(0==status){for(var j=0;j<secDiv.length;j++)secDiv[j].className="";
for(var i=0;i<hotA.length;i++)cur==i?hotA[i].className="career-hot-active":hotA[i].className=""}if(2==status){for(var i=0;i<hotA.length;i++)hotA[i].className="";for(var j=0;j<secDiv.length;j++)cur==j?secDiv[j].className=" career-hb-active ":secDiv[j].className=""}vm.curData=curData,vm.occupationData=curCodeData,vm.goNext()},vm.throwContrastData=function(){if(1==throwContrast){if("Y0000"==vm.occupationData||"R0022"==vm.occupationData||"R0047"==vm.occupationData)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");vm.occupationText=vm.curData,vm.occupation=vm.occupationData,vm.careerType=!1}else if(2==throwContrast)if("03"==insure_sp){if("Y0000"==vm.occupationData||"R0022"==vm.occupationData||"R0047"==vm.occupationData)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");for(var i=0;i<vm.secList.length;i++)vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].occupation=vm.occupationData),vm.careerType=!1}else for(var i=0;i<vm.secList.length;i++){if("13020"!=vm.occupationData&&"R0052"!=vm.occupationData&&"R0053"!=vm.occupationData)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=vm.curData,vm.secList[i].occupation=vm.occupationData),vm.careerType=!1}},vm.goNext=function(){""==vm.curData?TipService.showMsg("请选择职业"):vm.throwContrastData()},vm.goBack=function(){vm.searchResultDiv?(vm.searchResultDiv=!1,vm.keyword=""):vm.careerType=!1},vm.searchCareer=function(){if(vm.searchResultDiv=!0,vm.resultList=[],VALIDATION.chineseCheck(vm.keyword)){for(var i=0;i<searchResultList.length;i++)-1!=searchResultList[i].occupName.indexOf(vm.keyword)&&vm.resultList.push(searchResultList[i]);""==vm.resultList?vm.resultNoData=!0:vm.resultNoData=!1}""==vm.keyword&&(vm.searchResultDiv=!1)},vm.searchCareerBlur=function(){vm.searchResultDiv=!1,vm.keyword=""},vm.searchResultGo=function(curData,curCode){if(1==throwContrast){if("Y0000"==curCode)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");vm.occupationText=curData,vm.occupation=curCode,vm.careerType=!1}else if(2==throwContrast)if("03"==insure_sp){if("Y0000"==curCode)return void TipService.showMsg("被保人职业为拒保职业，请选择其他职业类型或更换被保人");for(var i=0;i<vm.secList.length;i++)vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].occupation=curCode),vm.careerType=!1}else for(var i=0;i<vm.secList.length;i++){if("13020"!=curCode&&"R0052"!=curCode&&"R0053"!=curCode)return TipService.showMsg("尊敬的客户，被保人的职业只能为学生或者学龄前儿童。"),vm.careerType=!0,!1;vm.secList[i].id==insure_id&&(vm.secList[i].insureOccupationText=curData,vm.secList[i].occupation=curCode),vm.careerType=!1}},vm.validatePremiumRateParam=function(){for(var insuredList=[{rcgnGndCd:"男"==vm.gender?"1":"2",rcgnOcpCd:vm.occupation,insuredAppntRela:"01",rcgnNm:vm.insureName,rcgnMoveTelNo:vm.phone.toUpperCase().replace(/\s+/g,""),rcgnCrdtNo:vm.certNo.toUpperCase().replace(/\s+/g,"")}],i=0;i<vm.secList.length;i++)insuredList.push({rcgnGndCd:"男"==vm.secList[i].gender?"1":"2",rcgnOcpCd:vm.secList[i].occupation,insuredAppntRela:vm.secList[i].isMate,rcgnNm:vm.secList[i].name,rcgnMoveTelNo:vm.secList[i].phone.toUpperCase().replace(/\s+/g,"")||null,rcgnCrdtNo:vm.secList[i].certNo.toUpperCase().replace(/\s+/g,"")});var params={checkPolicyGroupApp:{plchdOcpCd:vm.occupation,plchdGndCd:"男"==vm.gender?"1":"2",plchdNm:vm.insureName,plchdMoveTelNo:vm.phone.toUpperCase().replace(/\s+/g,""),insuredList:insuredList}};CommonRequest.request(params,CONFIG.GHMB_VALIDATE_PREMIUMRATE_PARAM,function(result){if(result){if(1!=result.status)return!1;if(vm.insuredChangedData(),vm.pbHoldChanged||vm.insuredChanged){var params=vm.insureData.params;params.premiumAppEntity.insuredList[0].rcgnBrthDt=params.premiumAppEntity.plchdBrthDt=vm.birthday.substring(0,4)+vm.birthday.substring(5,7)+vm.birthday.substring(8,10),params.premiumAppEntity.insuredList[0].insuredSSflag=params.premiumAppEntity.appntSsflag=vm.medic;for(var i=0;i<vm.insuredChangedCache.length;i++)params.premiumAppEntity.insuredList[i+1].rcgnBrthDt=vm.insuredChangedCache[i].birth,params.premiumAppEntity.insuredList[i+1].insuredSSflag=vm.insuredChangedCache[i].isMedic,params.premiumAppEntity.insuredList[i+1].insuredAppntRela=vm.insuredChangedCache[i].isMate;return CommonRequest.request(params,CONFIG.PREMIUM_RATE_FROM_GROUP_CORE,function(result){1==result.status&&vm.getPremiumRateGroupCoreResult(params,result.data)}),!1}for(var i=0;i<vm.secList.length;i++){for(var LiRcgnList=[],i=0;i<vm.secList.length;i++)LiRcgnList.push({confirmRela:vm.secList[i].isMate,LiRcgnName:vm.secList[i].name,LiRcgnMedic:vm.secList[i].isMedic,LiNationality:vm.secList[i].nationality,LiRcgnIdType:vm.secList[i].certType,LiRcgnId:vm.secList[i].certNo.toUpperCase().replace(/\s+/g,""),LiRcgnExpireType:1==vm.secList[i].certExpireType?"1":"2",LiIdEndDate:$filter("date")(vm.secList[i].certExpireDate,"yyyyMMdd"),LiRcgnSex:"男"==vm.secList[i].gender?"1":"2",LiRcgnBirdy:vm.insureData.params.premiumAppEntity.insuredList[i+1].rcgnBrthDt,LiRcgnMobl:vm.secList[i].phone?vm.secList[i].phone.replace(/\s+/g,""):"",LiRcgnOccupCode:vm.secList[i].occupation,LiRcgnOccupText:vm.secList[i].insureOccupationText,LiRcgnAddress:vm.secList[i].address,LiRcgnZipCode:vm.secList[i].zipCode});GroupPolicyService.control({state:"product-purchase-group-policy-info",control:"data",data:{PbHoldName:vm.insureName,PbHoldMedic:vm.medic,PbNationality:vm.nationality,PbHoldIdType:vm.certType,PbHoldId:vm.certNo.toUpperCase().replace(/\s+/g,""),PbHoldExpireType:1==vm.certExpireType?"1":"2",PbIdEndDate:$filter("date")(vm.certExpireDate,"yyyyMMdd"),PbHoldSex:"男"==vm.gender?"1":"2",PbHoldBirdy:vm.insureData.params.premiumAppEntity.insuredList[0].rcgnBrthDt,PbHoldBirdyDate:vm.birthday,PbHoldMobl:vm.phone.replace(/\s+/g,""),PbHoldEmail:vm.email,PbHoldOccupCode:vm.occupation,PbHoldOccupText:vm.occupationText,PbHoldAmount:vm.amount,PbHoldDistrict:vm.district,PbHoldAddress:vm.address,PbHoldZipCode:vm.zipCode,totalInsCvr:vm.insureData.totalInsCvr,LiRcgnList:LiRcgnList}}),GroupPolicyService.control({state:"product-purchase-group-policy-info",control:"process"})}}})},$timeout(function(){vm.init(),vm.watch()},500),vm.next=function(){if(vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout)return TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall");var age=VALIDATION.getAgeByBirth(vm.birthday);if(age>vm.maxAge||age<vm.minAge)return TipService.showMsg("投保人年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1;for(var i=0;i<vm.secList.length;i++){var insuredAge=VALIDATION.getAgeByBirth(vm.secList[i].birthday),birthDate=vm.secList[i].certNo.replace(/\s+/g,"").substring(6,14),nowDate=$filter("date")(new Date,"yyyyMMdd"),d1=new Date(birthDate.substring(0,4),birthDate.substring(4,6)-1,birthDate.substring(6,8)).getTime(),d2=new Date(nowDate.substring(0,4),nowDate.substring(4,6)-1,nowDate.substring(6,8)).getTime(),insuredDate=(d2-d1)/864e5;if("03"==vm.secList[i].isMate){if(insuredAge>vm.maxAge||insuredAge<vm.minAge)return TipService.showMsg("配偶年龄应该在"+vm.minAge+"-"+vm.maxAge+"周岁"),!1}else if(insuredAge>vm.childMaxAge||"30">insuredDate)return TipService.showMsg("子女年龄应该在"+vm.childMinAge+"-"+vm.childMaxAge+"周岁"),!1}vm.validatePremiumRateParam()}}angular.module("app").controller("GroupPolicyInfoController",GroupPolicyInfoController),GroupPolicyInfoController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","GroupPolicyService","CommonRequest","$ionicPopup","$timeout","$ionicLoading"]}(),function(){function GroupPolicyContactController($state,CommonRequest,CONFIG,GroupPolicyService,$scope,$rootScope,$ionicLoading,$timeout,$ionicPopup){function transOrigin(data){if(console.info(data),BMap){var x=data.longitude,y=data.latitude,ggPoint=new BMap.Point(x,y),convertor=new BMap.Convertor,pointArr=[];pointArr.push(ggPoint),convertor.translate(pointArr,1,5,translateCallback)}else var timer=$timeout(function(){transOrigin(data),$timeout.cancel(timer)},200)}function translateCallback(data){console.info(data),0===data.status?getAddress(data.points[0]):positionError()}function getAddress(obj){console.info(obj);var myGeo=new BMap.Geocoder;myGeo.getLocation(new BMap.Point(obj.lng,obj.lat),function(result){if(result){var dataLocation=result.addressComponents;vm.dataLocation=result.addressComponents,vm.gudgeIsLocation=dataLocation.province,vm.gudgeCity=dataLocation.city,vm.gudgeDistrict=dataLocation.district,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.gudgeIsLocation)}else positionError()})}function positionError(){var alertPopup=$ionicPopup.confirm({title:"温馨提示",template:"获取位置信息失败",okText:"重试",cancelText:"取消"});alertPopup.then(function(res){res&&vm.getPosition()})}var vm=this,sessionData=GroupPolicyService.getSessionData();vm.productData=sessionData.productData,vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData||"",$rootScope.prdId=vm.productData.prd_id,vm.userData=sessionData.userData;var policyData;if(policyData=vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023?sessionData.policyData||"":"",vm.parentName="推荐人姓名",vm.parentNum="请输入推荐人工号",vm.parentDescName="请输入推荐人姓名",vm.parentJobNum="推荐人工号",vm.productData.salesId&&"827"==vm.productData.newSaleChnl&&(vm.getAgentInformation=function(){var params={salerId:vm.productData.salesId};CommonRequest.request(params,CONFIG.CHANNEL_PERFOR_ASCRIPTION,function(result){1==result.status&&(vm.referrerCode=result.data.salerNum,vm.referrerName=result.data.name,vm.referrerOrg=result.data.managecom,vm.referrerButton=!0)})},vm.getAgentInformation()),vm.locate=policyData.locate||"",vm.branch=policyData.branch||"",vm.insSaleChlType=policyData.insSaleChlType||"2",vm.referrerCode=policyData.referrerCode||"",vm.referrerName=policyData.referrerName||"",vm.referrerOrg=policyData.referrerOrg||"",vm.province=policyData.province||"",vm.city=policyData.city||"",vm.district=policyData.district||"",vm.provinceNet=policyData.provinceNet||"",vm.cityNet=policyData.cityNet||"",vm.districtNet=policyData.districtNet||"",vm.city&&("1"==vm.city.singletonFlag?vm.usCode=vm.city.areaCode:vm.usCode=vm.city.parentAreaCode),vm.staffId=policyData.agentCode||"",vm.staffName=policyData.angentName||"",vm.staffOrgCode=policyData.BkBrchNo||"",vm.isCrossArea="1"==policyData.crossAreaFlag,vm.crossAgree=policyData.crossAgree||"",vm.allWebsite=policyData.allWebsite||"",vm.discount=policyData.discount||"",vm.hasDiscount=policyData.hasDiscount||"",vm.disActivityId=policyData.disActivityId||"",vm.configType=policyData.configType||"",$scope.$on("select-area-group-close",function(event,result){if(vm.province=result[0],vm.city=result[1],vm.district=result[2],vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}}),$scope.$on("select-branch-group-close",function(event,result){vm.provinceNet=result[0],vm.cityNet=result[1],vm.districtNet=result[2]}),vm.districtLevel1=function(){var params={prdId:vm.prdId},config={url:"../statics/product/areas/"+vm.prdId+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.provinces=result,vm.provinceList=[],vm.gudgeIsLocation){for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaName.indexOf(vm.gudgeIsLocation)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return void positionError()}else{for(var i=0;i<vm.provinces.length;i++)-1!=vm.provinces[i].areaCode.indexOf(vm.provinceCode)&&vm.provinceList.push(vm.provinces[i]);if(""==vm.provinceList)return}vm.districtLevel2(vm.provinceList)})},vm.districtLevel2=function(area){var config={url:"../statics/product/areas/"+vm.prdId+"/"+area[0].areaCode+"/"+vm.prdId+".json",method:"GET"},paramsl={prdId:vm.prdId,parentAreaCode:area[0].areaCode,areaLevel:2};CommonRequest.request(paramsl,config,function(result){if(vm.cities=result,vm.cityList=[],vm.gudgeCity){if(vm.cityList=vm.cities,""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.cities.length;i++)-1!=vm.cities[i].areaCode.indexOf(vm.cityCode)&&vm.cityList.push(vm.cities[i]);if(""==vm.cityList)return}vm.districtLevel3(vm.provinceList,vm.cityList)})},vm.districtLevel3=function(area1,area2){var params={prdId:vm.prdId,parentAreaCode:area2[0].areaCode,areaLevel:3},config={url:"../statics/product/areas/"+vm.prdId+"/"+area1[0].areaCode+"/"+area2[0].areaCode+"/"+vm.prdId+".json",method:"GET"};CommonRequest.request(params,config,function(result){if(vm.areass=result,vm.districtList=[],vm.gudgeDistrict){for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaName.indexOf(vm.gudgeDistrict)&&vm.districtList.push(vm.areass[i]);if(""==vm.districtList)return void positionError();if(!vm.districtList[0].parentAreaCode)return void positionError();vm.cityListLast=[];for(var i=0;i<vm.cityList.length;i++)-1!=vm.cityList[i].areaCode.indexOf(vm.districtList[0].parentAreaCode)&&vm.cityListLast.push(vm.cityList[i]);if(vm.cityList=vm.cityListLast[0],""==vm.cityList)return void positionError()}else{for(var i=0;i<vm.areass.length;i++)-1!=vm.areass[i].areaCode.indexOf(vm.districtCode)&&vm.districtList.push(vm.areass[i]);if(vm.cityList=vm.cityList[0],""==vm.districtList)return}if(vm.provinceList=vm.provinceList[0],vm.districtList=vm.districtList[0],vm.locate=vm.provinceList.areaName+"-"+vm.cityList.areaName+"-"+vm.districtList.areaName,vm.province=vm.provinceList,vm.city=vm.cityList,vm.district=vm.districtList,vm.gudgeDistrict?vm.address=vm.dataLocation.street+vm.dataLocation.streetNumber:vm.address=vm.locationNew,vm.branch="",vm.province.areaCode){var code;code=vm.city&&"1"==vm.city.singletonFlag?vm.city.areaCode:vm.city.parentAreaCode,vm.usCode=code,CommonRequest.request({},CONFIG.GET_NETPOINTLIST_SERVCIE,function(result){if(1==result.status){var provinceNetList=result.data;if(provinceNetList&&provinceNetList.length>0)for(var i=0;i<provinceNetList.length;i++)provinceNetList[i].netCode==code&&(vm.branch=provinceNetList[i].netName,vm.provinceNet=provinceNetList[i])}}),"1"==vm.district.crossAreaFlag?vm.isCrossArea=!0:vm.isCrossArea=!1;var params={areaCode:vm.district.areaCode};CommonRequest.request(params,CONFIG.SYSAREA_GROUP_PROXY_INFO,function(result){if(1==result.status){var data=result.data;vm.staffName=data.staffName,vm.staffId=data.staffId,vm.averageIncome=data.averageIncome,vm.averageIncomeCounty=data.averageIncomeCounty,vm.staffOrgCode=data.staffOrgCode,vm.yearIncome=vm.averageIncome,0==vm.livePlace?vm.yearIncome=vm.averageIncome:1==vm.livePlace&&(vm.yearIncome=vm.averageIncomeCounty)}})}})},vm.queryPolicyAddress=function(){var addressParam={cusId:vm.userData.cusId,role:"1",contType:"0",queryType:"0"};CommonRequest.request(addressParam,CONFIG.QUERY_POLICY_ADDRESS,function(result){result&&"1"==result.status&&"您暂时没有保单"!=result.data&&(vm.areaNew=result.data.appProvince+result.data.appCity+result.data.appCounty,vm.locationNew=result.data.appPostalAddress,vm.provinceCode=result.data.insuredHomeProvinceCode,vm.cityCode=result.data.insuredHomeCityCode,vm.districtCode=result.data.insuredHomeAreaCode,vm.prdId=vm.productData.prd_id,vm.districtLevel1(vm.provinceCode))})},vm.userData.cusId){var ocrConfig={url:"../statics/json/ocrSwitchBusinessOptimizer.json",method:"GET"};CommonRequest.request({},ocrConfig,function(result){vm.base64imgSwitch=result["static"],"Y"==vm.base64imgSwitch&&vm.queryPolicyAddress()})}vm.getPosition=function(){var pageURL=window.location.href.split("#")[0],params={currentUrl:pageURL};CommonRequest.request(params,CONFIG.SIGNATURE,function(result){if(1==result.status){var data=result.data;wx.config({debug:!1,appId:data.appId,timestamp:data.timeStamp,nonceStr:data.nonceStr,signature:data.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",success:function(res){res&&transOrigin(res)},fail:function(eror){positionError()},cancel:function(){}})}),wx.error(function(res){positionError()})}})},"811"==CONFIG.NEW_SALE_CHANNEL||"819"==CONFIG.NEW_SALE_CHANNEL||"824"==CONFIG.NEW_SALE_CHANNEL?(vm.recommendFlag=!0,vm.recommend="01"):vm.recommendFlag=!1,vm.getSaleChannelPort=function(){var GET_SALE_CHANNEL={url:"../statics/json/"+CONFIG.NEW_SALE_CHANNEL+"AgentSwitch.json",method:"GET"};CommonRequest.request({},GET_SALE_CHANNEL,function(result){if(result&&result.data)for(var i=0;i<result.data.length;i++)vm.productData.prd_id==result.data[i].prdId?(vm.backstage=!0,console.info(123)):vm.backstage=!1})},vm.getSaleChannelPort(),vm.next=function(){if($ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),vm.provinceNet&&vm.cityNet&&vm.districtNet){var provinceName=vm.provinceNet.netName?vm.provinceNet.netName:"",cityName=vm.cityNet.netName?"-"+vm.cityNet.netName:"",districtName=vm.districtNet.netName?"-"+vm.districtNet.netName:"";vm.allWebsite=provinceName+cityName+districtName}vm.checkNetcode=function(){$timeout(function(){if(vm.provinceNet.netCode){$ionicLoading.hide();var data={agentCode:vm.staffId,angentName:vm.staffName,BkBrchNo:vm.staffOrgCode,PbHoldAddr:vm.province.areaCode+","+vm.city.areaCode,PbOtherProvinceCode:vm.isCrossArea?vm.province.areaCode:"",bankCodeLV1:vm.usCode||"",districtCode:vm.province?vm.province.areaCode:"",liveProvince:vm.province?vm.province.areaName:"",liveDistrict:vm.city?vm.city.areaName:"",allWebsite:vm.allWebsite,referrerCode:vm.referrerCode,referrerName:vm.referrerName,PlchdProvCd:vm.province.areaCode,PlchdCityCd:vm.city.areaCode,PlchdDstcCd:vm.district.areaCode,liveDstc:vm.district.areaName||"",crossAreaFlag:vm.isCrossArea?"1":"0",locate:vm.locate,branch:vm.branch,crossAgree:vm.crossAgree,province:vm.province||"",city:vm.city||"",district:vm.district||"",provinceNet:vm.provinceNet||"",cityNet:vm.cityNet||"",districtNet:vm.districtNet||"",referrerOrg:vm.referrerOrg||""};"Y"!=vm.productData.basicProfile.P021&&(data=angular.extend(data,{PbWebsiteCode:vm.districtNet.netCode||"",PbWebsiteName:vm.districtNet.netName||"",bankCodeLV1:vm.provinceNet.netCode||"",bankCodeLV2:vm.cityNet.netCode||"",bankCodeLV3:vm.districtNet.netCode||""})),"Y"==vm.productData.basicProfile.P021&&(data=angular.extend(data,{insSaleChlType:vm.insSaleChlType})),GroupPolicyService.control({state:"product-purchase-group-policy-contact",control:"data",data:data}),GroupPolicyService.control({state:"product-purchase-group-policy-contact",control:"process"})}else vm.checkNetcode()},100)},vm.checkNetcode()}}angular.module("app").controller("GroupPolicyContactController",GroupPolicyContactController),GroupPolicyContactController.$inject=["$state","CommonRequest","CONFIG","GroupPolicyService","$scope","$rootScope","$ionicLoading","$timeout","$ionicPopup"]}(),function(){function GroupPolicyNoticeController($state,CONFIG,$rootScope,VALIDATION,$scope,COMMON,$filter,TipService,GroupPolicyService,CommonRequest,$ionicPopup,$timeout,$ionicLoading,$ionicModal){var vm=this,sessionData=GroupPolicyService.getSessionData();if(vm.productData=sessionData.productData,vm.noticeChecked=!0,!vm.productData)return void $state.go("tab.mall");if(vm.insureData=sessionData.insureData,vm.policyData=sessionData.policyData,vm.showAgree=!1,vm.policyData.LiRcgnList.forEach(function(item){var birthday=VALIDATION.getBirthday(item.LiRcgnId),age=VALIDATION.getAgeByBirth(birthday);age>=18&&(vm.showAgree=!0)}),vm.provinceCode=vm.policyData.PlchdProvCd||"",vm.PbInsuExp=vm.insureData.PbInsuExp,vm.healthTag=vm.policyData.healthTag||"",vm.agree=vm.policyData.agree||"",vm.materials=[],vm.allRead=!0,vm.productData.materials&&vm.productData.materials.length>0)for(var i=0;i<vm.productData.materials.length;i++){var ma=vm.productData.materials[i];if(ma&&"M6"!=ma.materialType){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc},material=[];CommonRequest.request(params,CONFIG.GET_MATRRIAL_DETAIL_SERVICE,function(result){if(1==result.status&&(material=result.data,material&&material.length>0)){for(var j=0;j<material.length;j++)material[j].materialPath=CONFIG.IMAGE_SERVICE_ADDRESS+material[j].materialPath,material[j].isRead=!1,vm.materials.push(material[j]);if(vm.materials&&vm.materials.length>0){var arr=vm.materials.filter(function(item){return item.areaCode&&item.areaCode==vm.provinceCode});arr.length>0?vm.materials=vm.materials.filter(function(item){return!item.areaCode||item.areaCode==vm.provinceCode}):vm.materials=vm.materials.filter(function(item){return!item.areaCode||"all"==item.areaCode})}vm.allRead=!1}})}}vm.materialDetail=function(ma){if(ma){var materialTypeDesc=ma.materialTypeDesc,materialType=ma.materialType,params={prdId:vm.productData.prd_id,materialType:materialType,materialTypeDesc:materialTypeDesc};GroupPolicyService.getMaterialDetailOpen(params)}},vm.tabList=["相关条款"],vm.productData.hotTip&&vm.productData.hotTip.length>0&&vm.tabList.push("特别提示"),vm.productData.exoneration&&vm.productData.exoneration.length>0&&vm.tabList.push("责任免除"),vm.submitIdx=0,vm.goRead=function(ma,index){vm.MaterialIndex=index,vm.showMaterialModal()},vm.showMaterialModal=function(){var self=$rootScope;$ionicModal.fromTemplateUrl("app/module/mall/product/product-purchase/product-purchase-info/policy-notice/popup/material.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!0}).then(function(modal){self.modal=modal,self.modal.show(),self.nowRead=vm.MaterialIndex+1,self.allNeadRead=vm.materials.length,self.activeMaterial=vm.materials[vm.MaterialIndex],self.materialUrl=vm.materials[vm.MaterialIndex].materialPath,self.hasMaterialCanvans=!1,$ionicLoading.show({template:'<ion-spinner icon="bubbles"></ion-spinner>'}),pdfjsLib.getDocument(self.materialUrl).then(function(pdf){if(console.info(65465456465),self.hasMaterialCanvans=!0,$ionicLoading.hide(),vm.pdfDoc=pdf,self.materialsPages=vm.pdfDoc.numPages,self.materialCanvans=[],self.materialsPages){for(var i=1;i<=self.materialsPages;i++)self.materialCanvans.push(i);$timeout(function(){vm.renderPage(1)},300)}},function(e){console.info(e),self.noMaterialPDF=!0,self.hasMaterialCanvans=!0,$ionicLoading.hide()}),vm.renderPage=function(num){vm.pdfDoc.getPage(num).then(function(page){var canvas=document.getElementById("the-canvas"+num),ctx=canvas.getContext("2d"),dpr=window.devicePixelRatio||1,bsr=ctx.webkitBackingStorePixelRatio||ctx.mozBackingStorePixelRatio||ctx.msBackingStorePixelRatio||ctx.oBackingStorePixelRatio||ctx.backingStorePixelRatio||1,ratio=dpr/bsr,viewport=page.getViewport(screen.availWidth/page.getViewport(1).width);canvas.width=viewport.width*ratio,canvas.height=viewport.height*ratio,canvas.style.width="100%",ctx.setTransform(ratio,0,0,ratio,0,0);var renderContext={canvasContext:ctx,viewport:viewport};page.render(renderContext),self.materialsPages>num&&vm.renderPage(num+1)})},self.readMateril=function(){vm.materials[vm.MaterialIndex].isRead=!0,vm.allRead=vm.materials.every(function(arr){return arr.isRead}),self.modal.remove(),vm.allRead||(vm.MaterialIndex++,vm.MaterialIndex>vm.materials.length-1&&(vm.MaterialIndex=0),vm.showMaterialModal())}})},vm.dataCheck=function(){return"0"!=vm.healthTag?(TipService.showMsg($rootScope.TIPS.PRODUCT.HEALTHY_INVALID),!1):!0},vm.getPolicyData=function(){var autoRnwCvInd;autoRnwCvInd="Y"==vm.productData.basicProfile.P021?vm.policyData.isBatts:"Y"==vm.productData.basicProfile.P010?"1":"0";for(var insuredLsit=[{rcgnNm:vm.policyData.PbHoldName,rcgnGndCd:vm.policyData.PbHoldSex,rcgnBrthDt:vm.policyData.PbHoldBirdy,rcgnCrdtTpCd:vm.policyData.PbHoldIdType,rcgnCrdtNo:vm.policyData.PbHoldId,rcgnExpirationType:vm.policyData.PbHoldExpireType,rcgnCrdtExpDt:vm.policyData.PbIdEndDate||"20991231",rcgnNatCd:vm.policyData.PbNationality,rcgnCommAdr:vm.policyData.PbHoldAddress,rcgnZipECD:vm.policyData.PbHoldZipCode,rcgnMoveTelNo:vm.policyData.PbHoldMobl,rcgnOcpCd:vm.policyData.PbHoldOccupCode,insuredSSflag:vm.policyData.PbHoldMedic,insuredAppntRela:"01",cvrNum:"1",busiList:[{cvrID:vm.insureData.plans.planCode,cvrNm:vm.productData.prd_title,mainAndAdlInsInd:"1",insCps:"1",insPremAmt:vm.insureData.plans.insuredAmount,insScmInf:vm.insureData.plans.planCode,insYrPrdCgyCd:vm.insureData.plans.insuYearFlag,insDdln:vm.insureData.plans.insuYear,autoRnwCvInd:autoRnwCvInd}]}],i=0;i<vm.policyData.LiRcgnList.length;i++)insuredLsit.push({rcgnNm:vm.policyData.LiRcgnList[i].LiRcgnName,rcgnGndCd:vm.policyData.LiRcgnList[i].LiRcgnSex,rcgnBrthDt:vm.policyData.LiRcgnList[i].LiRcgnBirdy,rcgnCrdtTpCd:vm.policyData.LiRcgnList[i].LiRcgnIdType,rcgnCrdtNo:vm.policyData.LiRcgnList[i].LiRcgnId,rcgnExpirationType:vm.policyData.LiRcgnList[i].LiRcgnExpireType,rcgnCrdtExpDt:vm.policyData.LiRcgnList[i].LiIdEndDate||"20991231",rcgnNatCd:vm.policyData.LiRcgnList[i].LiNationality,rcgnCommAdr:vm.policyData.LiRcgnList[i].LiRcgnAddress,rcgnZipECD:vm.policyData.LiRcgnList[i].LiRcgnZipCode,rcgnMoveTelNo:vm.policyData.LiRcgnList[i].LiRcgnMobl,rcgnOcpCd:vm.policyData.LiRcgnList[i].LiRcgnOccupCode,insuredSSflag:vm.policyData.LiRcgnList[i].LiRcgnMedic,insuredAppntRela:vm.policyData.LiRcgnList[i].confirmRela,cvrNum:"1",busiList:[{cvrID:vm.insureData.plans.planCode,cvrNm:vm.productData.prd_title,mainAndAdlInsInd:"1",insCps:"1",insPremAmt:vm.insureData.plans.insuredAmount,insScmInf:vm.insureData.plans.planCode,insYrPrdCgyCd:vm.insureData.plans.insuYearFlag,insDdln:vm.insureData.plans.insuYear,autoRnwCvInd:autoRnwCvInd}]});var params={realTotalPremium:vm.policyData.totalInsCvr,paymentCode:vm.productData.payment_type,payAge:vm.productData.pay_age,payAgeUnit:vm.productData.payTypeConfigs.payAgeUnit,insuredNum:vm.insureData.insuredList.length,insBlPrtNo:vm.PbApplNo[0],sellTypeDetail:CONFIG.SALE_CHANNEL,CCBInsID:vm.policyData.BkBrchNo,lv1BrNo:vm.policyData.bankCodeLV1,orderCode:vm.productData.orderCode,channelCode:CONFIG.SALE_CHANNEL,orgCode:vm.policyData.BkBrchNo,isMobileCheck:"Y"==vm.productData.basicProfile.P005?"1":"0",isCalculate:"Y"==vm.productData.basicProfile.P001?"1":"0",isRiskTest:"Y"==vm.productData.basicProfile.P007?"1":"0",isAuthentication:"Y"==vm.productData.basicProfile.P002?"1":"0",isSpecialCheck:"Y"==vm.productData.basicProfile.P004?"1":"0",prdSaleCode:vm.productData.prdSaleCode,prdId:vm.productData.prd_id,planId:vm.insureData.plans.planId,planCode:vm.insureData.plans.planCode,planName:vm.insureData.plans.planName,districtCodeP:vm.policyData.PlchdProvCd,districtCode:vm.policyData.PlchdCityCd,districtCodeD:vm.policyData.PlchdDstcCd},checkPolicyGroupApp={upgradeFlag:vm.policyData.isGhmbUpdate?"1":"0",plchdNm:vm.policyData.PbHoldName,plchdGndCd:vm.policyData.PbHoldSex,plchdBrthDt:vm.policyData.PbHoldBirdy,plchdCrdtTpCd:vm.policyData.PbHoldIdType,plchdCrdtNo:vm.policyData.PbHoldId,expirationType:vm.policyData.PbHoldExpireType,plchdCrdtExpDt:vm.policyData.PbIdEndDate||"20991231",plchdNatCd:vm.policyData.PbNationality,plchdCommAdr:vm.policyData.PbHoldAddress,plchdZipECD:vm.policyData.PbHoldZipCode,plchdMoveTelNo:vm.policyData.PbHoldMobl,plchdEmailAdr:vm.policyData.PbHoldEmail,plchdOcpCd:vm.policyData.PbHoldOccupCode,plchdYrIncmAm:vm.policyData.PbHoldAmount,rsdntTpCd:vm.policyData.PbHoldDistrict,appntSsflag:vm.policyData.PbHoldMedic,insuredNum:vm.insureData.insuredList.length,insBlPrtNo:vm.PbApplNo[0],ntfItmInd:"0",dsptPcsgMtdCd:vm.policyData.PiZyzcfs,dsptArbtrInstNm:vm.policyData.PiZcinst,cCBInsID:vm.policyData.BkBrchNo,lv1BrNo:vm.policyData.bankCodeLV1,bONm:vm.policyData.allWebsite,bOSaleStffNm:vm.policyData.angentName,bOSaleStffID:vm.policyData.agentCode,plchdProvCd:vm.policyData.districtCode,plchdCityCd:vm.policyData.liveProvince,plchdCntyAndDstcCd:vm.policyData.liveDistrict,specAuditFlag:"Y"==vm.productData.basicProfile.P004?"1":"0",insRecommendId:vm.policyData.referrerCode,insRecommendNm:vm.policyData.referrerName,insSaleId:vm.policyData.agentCode,insSaleNm:vm.policyData.angentName,insSaleGrp:vm.policyData.BkBrchNo,insuredList:insuredLsit};return"Y"==vm.productData.basicProfile.P021&&(params.accBankCode=vm.policyData.BankCode,checkPolicyGroupApp=angular.extend(checkPolicyGroupApp,{plchdAccID:vm.policyData.plchdAccBankNm,plchdAccNm:vm.policyData.BankName,insSaleChlType:vm.policyData.insSaleChlType,plchdAccNo:vm.policyData.plchdAccNo,plchdAccBankNm:vm.policyData.plchdAccBankNm})),params.checkPolicyGroupApp=checkPolicyGroupApp,vm.policyData.crsData&&(params=angular.extend(params,vm.policyData.crsData)),params},vm.checkPolicy=function(){var policyData=vm.getPolicyData();policyData&&(GroupPolicyService.setSessionData({policyData:{healthTag:vm.healthTag,agree:vm.agree}}),GroupPolicyService.control({state:$state.current.name,control:"data",data:policyData}),GroupPolicyService.control({state:$state.current.name,control:"process"}))},vm.submit=function(){var self=$rootScope;return vm.submitIdx<vm.tabList.length-1?void vm.submitIdx++:void $ionicModal.fromTemplateUrl("app/module/mall/product/health-modal/health-modal.html",{scope:$rootScope,animation:"slide-in-up",backdropClickToClose:!1}).then(function(modal){self.modal=modal,self.modal.show(),self.close=function(){self.modal.remove()},self.rightButten=function(){vm.healthTag="0","Y"!=vm.productData.basicProfile.P028?vm.process():vm.showAgree?($rootScope.showAgreeModal=!0,$ionicPopup.show({template:"<p>被保险人已同意本次投保，并已认可本次投保的保险金额</p>",buttons:[{text:"否",onTap:function(e){$rootScope.showAgreeModal=!1}},{text:"是",type:"button-positive",onTap:function(e){$rootScope.showAgreeModal=!1,vm.process()}}]})):vm.process()}})},vm.process=function(){return vm.productData.basicProfile&&"Y"==vm.productData.basicProfile.P023&&$rootScope.policyTimeout?(TipService.showMsg("已超时，请重新选择产品"),$rootScope.policyTimeout=!1,void $state.go("tab.mall")):void(vm.dataCheck()&&GroupPolicyService.createPbApplNo(vm.policyData.BkBrchNo,function(pbApplNoList){vm.PbApplNo=pbApplNoList,$rootScope.modal.remove(),vm.checkPolicy()}))}}angular.module("app").controller("GroupPolicyNoticeController",GroupPolicyNoticeController),GroupPolicyNoticeController.$inject=["$state","CONFIG","$rootScope","VALIDATION","$scope","COMMON","$filter","TipService","GroupPolicyService","CommonRequest","$ionicPopup","$timeout","$ionicLoading","$ionicModal"]}();